{"file_contents":{"client/src/contexts/auth-context.tsx":{"content":"import React, { createContext, useContext, useState, useEffect } from 'react';\nimport { User } from '@shared/schema';\n\ninterface AuthContextType {\n  user: User | null;\n  login: (username: string, password: string) => Promise<boolean>;\n  logout: () => void;\n  switchRole: (role: string) => void;\n  isAuthenticated: boolean;\n}\n\nconst AuthContext = createContext<AuthContextType | null>(null);\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [user, setUser] = useState<User | null>(null);\n  const [isAuthenticated, setIsAuthenticated] = useState(false);\n\n  useEffect(() => {\n    // Check for existing auth token on app load\n    const token = localStorage.getItem('auth_token');\n    const userData = localStorage.getItem('user_data');\n    \n    if (token && userData) {\n      try {\n        const parsedUser = JSON.parse(userData);\n        setUser(parsedUser);\n        setIsAuthenticated(true);\n      } catch (error) {\n        localStorage.removeItem('auth_token');\n        localStorage.removeItem('user_data');\n      }\n    } else {\n      // Auto-login as admin for demo\n      const demoUser: User = {\n        id: 'demo-admin',\n        username: 'admin',\n        password: 'admin123',\n        role: 'admin',\n        email: 'admin@crewtrack.com',\n        name: 'John Smith',\n        createdAt: new Date(),\n      };\n      setUser(demoUser);\n      setIsAuthenticated(true);\n      localStorage.setItem('auth_token', 'demo-token');\n      localStorage.setItem('user_data', JSON.stringify(demoUser));\n    }\n  }, []);\n\n  const login = async (username: string, password: string): Promise<boolean> => {\n    try {\n      // For demo, we'll simulate different users\n      const demoUsers = {\n        admin: { id: 'admin', username: 'admin', role: 'admin', name: 'John Smith', email: 'admin@crewtrack.com' },\n        office: { id: 'office', username: 'office', role: 'office_staff', name: 'Sarah Wilson', email: 'office@crewtrack.com' },\n      };\n\n      const userData = demoUsers[username as keyof typeof demoUsers];\n      if (userData && password === 'demo123') {\n        const fullUser: User = {\n          ...userData,\n          password: 'demo123',\n          createdAt: new Date(),\n        };\n        \n        setUser(fullUser);\n        setIsAuthenticated(true);\n        localStorage.setItem('auth_token', `demo-token-${username}`);\n        localStorage.setItem('user_data', JSON.stringify(fullUser));\n        return true;\n      }\n      \n      return false;\n    } catch (error) {\n      return false;\n    }\n  };\n\n  const logout = () => {\n    setUser(null);\n    setIsAuthenticated(false);\n    localStorage.removeItem('auth_token');\n    localStorage.removeItem('user_data');\n  };\n\n  const switchRole = (role: string) => {\n    if (user) {\n      const updatedUser = { ...user, role };\n      setUser(updatedUser);\n      localStorage.setItem('user_data', JSON.stringify(updatedUser));\n    }\n  };\n\n  return (\n    <AuthContext.Provider value={{ user, login, logout, switchRole, isAuthenticated }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":3244,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  // Import auth headers dynamically to avoid circular imports\n  const { getAuthHeaders } = await import('./auth');\n  const authHeaders = getAuthHeaders();\n  \n  const res = await fetch(url, {\n    method,\n    headers: {\n      ...(data ? { \"Content-Type\": \"application/json\" } : {}),\n      ...authHeaders,\n    },\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    // Import auth headers dynamically to avoid circular imports\n    const { getAuthHeaders } = await import('./auth');\n    const authHeaders = getAuthHeaders();\n    \n    const res = await fetch(queryKey.join(\"/\") as string, {\n      headers: authHeaders,\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: 30 * 1000, // 30 seconds - optimal balance\n      cacheTime: 5 * 60 * 1000, // 5 minutes cache retention\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1873,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"server/storage.ts":{"content":"import { \n  type User, \n  type InsertUser, \n  type Vessel, \n  type InsertVessel,\n  type CrewMember, \n  type InsertCrewMember,\n  type CrewMemberWithDetails,\n  type Contract,\n  type InsertContract,\n  type Document,\n  type InsertDocument,\n  type DocumentAlert,\n  type ContractAlert,\n  type VesselDocument,\n  type InsertVesselDocument,\n  type CrewRotation,\n  type InsertCrewRotation,\n  type EmailSettings,\n  type InsertEmailSettings,\n  type ActivityLog,\n  type InsertActivityLog,\n  type NotificationHistory,\n  type InsertNotificationHistory,\n  type WhatsappSettings,\n  type InsertWhatsappSettings,\n  users,\n  vessels,\n  crewMembers,\n  contracts,\n  documents,\n  vesselDocuments,\n  crewRotations,\n  emailSettings,\n  whatsappSettings,\n  activityLogs,\n  notificationHistory,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, gte, lte, sql, isNotNull, desc } from \"drizzle-orm\";\nimport { randomUUID } from \"crypto\";\n\nexport interface IStorage {\n  // User operations\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  getAllUsers(): Promise<User[]>;\n  \n  // Vessel operations\n  getVessels(): Promise<Vessel[]>;\n  getVessel(id: string): Promise<Vessel | undefined>;\n  createVessel(vessel: InsertVessel): Promise<Vessel>;\n  updateVessel(id: string, vessel: Partial<InsertVessel>): Promise<Vessel | undefined>;\n  deleteVessel(id: string): Promise<boolean>;\n  updateVesselOrder(vesselIds: string[]): Promise<boolean>;\n  \n  // Crew member operations\n  getCrewMembers(): Promise<CrewMemberWithDetails[]>;\n  getCrewMember(id: string): Promise<CrewMemberWithDetails | undefined>;\n  getCrewMembersByVessel(vesselId: string): Promise<CrewMemberWithDetails[]>;\n  findDuplicateCrewMember(firstName: string, lastName: string, dateOfBirth: Date): Promise<CrewMember | undefined>;\n  createCrewMember(crewMember: InsertCrewMember): Promise<CrewMember>;\n  updateCrewMember(id: string, crewMember: Partial<InsertCrewMember>): Promise<CrewMember | undefined>;\n  deleteCrewMember(id: string): Promise<boolean>;\n  \n  // Contract operations\n  getContracts(): Promise<Contract[]>;\n  getContractsByCrewMember(crewMemberId: string): Promise<Contract[]>;\n  getActiveContract(crewMemberId: string): Promise<Contract | undefined>;\n  createContract(contract: InsertContract): Promise<Contract>;\n  updateContract(id: string, contract: Partial<InsertContract>): Promise<Contract | undefined>;\n  getVesselContractStats(vesselId: string): Promise<{active: number, expiringSoon: number, expired: number}>;\n  getVesselContracts(vesselId: string, status?: string): Promise<Array<Contract & {crewMember: CrewMember}>>;\n  \n  // Document operations\n  getDocuments(): Promise<Document[]>;\n  getDocument(id: string): Promise<Document | undefined>;\n  getDocumentsByCrewMember(crewMemberId: string): Promise<Document[]>;\n  getExpiringDocuments(days: number): Promise<DocumentAlert[]>;\n  getExpiringContracts(days: number): Promise<ContractAlert[]>;\n  createDocument(document: InsertDocument): Promise<Document>;\n  updateDocument(id: string, document: Partial<InsertDocument>): Promise<Document | undefined>;\n  deleteDocument(id: string): Promise<boolean>;\n  \n  // Crew rotation operations\n  getCrewRotations(): Promise<CrewRotation[]>;\n  getCrewRotationsByVessel(vesselId: string): Promise<CrewRotation[]>;\n  createCrewRotation(rotation: InsertCrewRotation): Promise<CrewRotation>;\n  updateCrewRotation(id: string, rotation: Partial<InsertCrewRotation>): Promise<CrewRotation | undefined>;\n  deleteCrewRotation(id: string): Promise<boolean>;\n  \n  // Email settings operations\n  getEmailSettings(): Promise<EmailSettings | undefined>;\n  updateEmailSettings(settings: InsertEmailSettings): Promise<EmailSettings>;\n  \n  // WhatsApp settings operations\n  getWhatsappSettings(): Promise<WhatsappSettings | undefined>;\n  updateWhatsappSettings(settings: InsertWhatsappSettings): Promise<WhatsappSettings>;\n  \n  // Vessel document operations\n  getVesselDocuments(vesselId: string): Promise<VesselDocument[]>;\n  getVesselDocument(id: string): Promise<VesselDocument | undefined>;\n  createVesselDocument(document: InsertVesselDocument): Promise<VesselDocument>;\n  updateVesselDocument(id: string, document: Partial<InsertVesselDocument>): Promise<VesselDocument | undefined>;\n  deleteVesselDocument(id: string): Promise<boolean>;\n  \n  // Activity log operations\n  logActivity(activity: InsertActivityLog): Promise<ActivityLog>;\n  getActivityLogs(): Promise<ActivityLog[]>;\n  \n  // Notification history operations\n  logNotification(notification: InsertNotificationHistory): Promise<NotificationHistory>;\n  getNotificationHistory(eventId: string, eventType: string, daysBeforeEvent: number): Promise<NotificationHistory[]>;\n  hasNotificationBeenSent(eventId: string, eventType: string, daysBeforeEvent: number, provider: string): Promise<boolean>;\n  hasNotificationBeenSentToday(eventId: string, eventType: string, provider: string, dateStr: string): Promise<boolean>;\n  getFailedNotifications(maxRetries: number): Promise<NotificationHistory[]>;\n  updateNotificationStatus(id: string, success: boolean, errorMessage?: string, retryCount?: number): Promise<NotificationHistory | undefined>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user || undefined;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user || undefined;\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(insertUser)\n      .returning();\n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(users);\n  }\n\n  // Vessel operations\n  async getVessels(): Promise<Vessel[]> {\n    return await db.select().from(vessels).orderBy(vessels.sortOrder);\n  }\n\n  async getVessel(id: string): Promise<Vessel | undefined> {\n    const [vessel] = await db.select().from(vessels).where(eq(vessels.id, id));\n    return vessel || undefined;\n  }\n\n  async createVessel(vessel: InsertVessel): Promise<Vessel> {\n    const [newVessel] = await db\n      .insert(vessels)\n      .values(vessel)\n      .returning();\n    return newVessel;\n  }\n\n  async updateVessel(id: string, vessel: Partial<InsertVessel>): Promise<Vessel | undefined> {\n    const [updated] = await db\n      .update(vessels)\n      .set(vessel)\n      .where(eq(vessels.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteVessel(id: string): Promise<boolean> {\n    // First, unassign any crew members from this vessel\n    await db\n      .update(crewMembers)\n      .set({ currentVesselId: null })\n      .where(eq(crewMembers.currentVesselId, id));\n    \n    const result = await db.delete(vessels).where(eq(vessels.id, id));\n    return (result.rowCount || 0) > 0;\n  }\n\n  async updateVesselOrder(vesselIds: string[]): Promise<boolean> {\n    try {\n      // Update sort order for each vessel\n      for (let i = 0; i < vesselIds.length; i++) {\n        await db\n          .update(vessels)\n          .set({ sortOrder: i + 1 })\n          .where(eq(vessels.id, vesselIds[i]));\n      }\n      return true;\n    } catch (error) {\n      console.error('Error updating vessel order:', error);\n      return false;\n    }\n  }\n\n  // Crew member operations\n  async getCrewMembers(): Promise<CrewMemberWithDetails[]> {\n    const crewList = await db.select().from(crewMembers);\n    \n    const detailedCrew = await Promise.all(crewList.map(async (member) => {\n      const user = member.userId ? await this.getUser(member.userId) : undefined;\n      const currentVessel = member.currentVesselId ? await this.getVessel(member.currentVesselId) : undefined;\n      const lastVessel = member.lastVesselId ? await this.getVessel(member.lastVesselId) : undefined;\n      const memberDocuments = await this.getDocumentsByCrewMember(member.id);\n      const activeContract = await this.getActiveContract(member.id);\n      \n      return {\n        ...member,\n        user,\n        currentVessel,\n        lastVessel,\n        documents: memberDocuments,\n        activeContract,\n      };\n    }));\n\n    return detailedCrew;\n  }\n\n  async getCrewMember(id: string): Promise<CrewMemberWithDetails | undefined> {\n    const [member] = await db.select().from(crewMembers).where(eq(crewMembers.id, id));\n    if (!member) return undefined;\n\n    const user = member.userId ? await this.getUser(member.userId) : undefined;\n    const currentVessel = member.currentVesselId ? await this.getVessel(member.currentVesselId) : undefined;\n    const memberDocuments = await this.getDocumentsByCrewMember(member.id);\n    const activeContract = await this.getActiveContract(member.id);\n\n    const lastVessel = member.lastVesselId ? await this.getVessel(member.lastVesselId) : undefined;\n\n    return {\n      ...member,\n      user,\n      currentVessel,\n      lastVessel,\n      documents: memberDocuments,\n      activeContract,\n    };\n  }\n\n  async getCrewMembersByVessel(vesselId: string): Promise<CrewMemberWithDetails[]> {\n    const vesselCrew = await db.select().from(crewMembers).where(eq(crewMembers.currentVesselId, vesselId));\n    \n    const detailedCrew = await Promise.all(vesselCrew.map(async (member) => {\n      const user = member.userId ? await this.getUser(member.userId) : undefined;\n      const currentVessel = await this.getVessel(vesselId);\n      const memberDocuments = await this.getDocumentsByCrewMember(member.id);\n      const activeContract = await this.getActiveContract(member.id);\n      \n      return {\n        ...member,\n        user,\n        currentVessel,\n        documents: memberDocuments,\n        activeContract,\n      };\n    }));\n\n    return detailedCrew;\n  }\n\n  async findDuplicateCrewMember(firstName: string, lastName: string, dateOfBirth: Date): Promise<CrewMember | undefined> {\n    const results = await db.select().from(crewMembers).where(\n      and(\n        sql`LOWER(${crewMembers.firstName}) = LOWER(${firstName})`,\n        sql`LOWER(${crewMembers.lastName}) = LOWER(${lastName})`,\n        sql`DATE(${crewMembers.dateOfBirth}) = DATE(${dateOfBirth})`\n      )\n    );\n    return results[0] || undefined;\n  }\n\n  async createCrewMember(crewMember: InsertCrewMember): Promise<CrewMember> {\n    const [newCrewMember] = await db\n      .insert(crewMembers)\n      .values(crewMember)\n      .returning();\n    return newCrewMember;\n  }\n\n  async updateCrewMember(id: string, crewMember: Partial<InsertCrewMember>): Promise<CrewMember | undefined> {\n    try {\n      console.log(`Updating crew member ${id} with:`, crewMember);\n      const [updated] = await db\n        .update(crewMembers)\n        .set(crewMember)\n        .where(eq(crewMembers.id, id))\n        .returning();\n      console.log(`Update result for crew member ${id}:`, updated);\n      return updated || undefined;\n    } catch (error) {\n      console.error(`Failed to update crew member ${id}:`, error);\n      throw error;\n    }\n  }\n\n  async deleteCrewMember(id: string): Promise<boolean> {\n    try {\n      // First check if the crew member exists\n      const existing = await this.getCrewMember(id);\n      if (!existing) {\n        console.log(`Crew member ${id} not found for deletion`);\n        return false;\n      }\n      \n      // First delete related documents\n      await db.delete(documents).where(eq(documents.crewMemberId, id));\n      \n      // Delete related contracts\n      await db.delete(contracts).where(eq(contracts.crewMemberId, id));\n      \n      // Delete related crew rotations\n      await db.delete(crewRotations).where(eq(crewRotations.crewMemberId, id));\n      \n      // Finally delete the crew member\n      const result = await db.delete(crewMembers).where(eq(crewMembers.id, id)).returning();\n      \n      console.log(`Successfully deleted crew member ${id}: ${existing.firstName} ${existing.lastName}`);\n      return result.length > 0;\n    } catch (error) {\n      console.error('Error deleting crew member:', error);\n      return false;\n    }\n  }\n\n  // Contract operations\n  async getContracts(): Promise<Contract[]> {\n    return await db.select().from(contracts);\n  }\n\n  async getContractsByCrewMember(crewMemberId: string): Promise<Contract[]> {\n    return await db.select().from(contracts).where(eq(contracts.crewMemberId, crewMemberId));\n  }\n\n  async getActiveContract(crewMemberId: string): Promise<Contract | undefined> {\n    const [contract] = await db\n      .select()\n      .from(contracts)\n      .where(and(eq(contracts.crewMemberId, crewMemberId), eq(contracts.status, 'active')))\n      .orderBy(desc(contracts.createdAt));\n    return contract || undefined;\n  }\n\n  async createContract(contract: InsertContract): Promise<Contract> {\n    const [newContract] = await db\n      .insert(contracts)\n      .values(contract)\n      .returning();\n    return newContract;\n  }\n\n  async updateContract(id: string, contract: Partial<InsertContract>): Promise<Contract | undefined> {\n    const [updated] = await db\n      .update(contracts)\n      .set(contract)\n      .where(eq(contracts.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  // Document operations\n  async getDocuments(): Promise<Document[]> {\n    return await db.select().from(documents);\n  }\n\n  async getDocument(id: string): Promise<Document | undefined> {\n    const [document] = await db.select().from(documents).where(eq(documents.id, id));\n    return document || undefined;\n  }\n\n  async getDocumentsByCrewMember(crewMemberId: string): Promise<Document[]> {\n    return await db.select().from(documents).where(eq(documents.crewMemberId, crewMemberId));\n  }\n\n  async getExpiringDocuments(days: number): Promise<DocumentAlert[]> {\n    const now = new Date();\n    const futureDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));\n    \n    const expiringDocs = await db\n      .select()\n      .from(documents)\n      .where(and(\n        lte(documents.expiryDate, futureDate),\n        gte(documents.expiryDate, now)\n      ));\n\n    const alerts: DocumentAlert[] = [];\n    \n    for (const doc of expiringDocs) {\n      const member = await this.getCrewMember(doc.crewMemberId);\n      if (member) {\n        const daysUntilExpiry = Math.ceil((doc.expiryDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));\n        const severity = daysUntilExpiry <= 7 ? 'critical' : daysUntilExpiry <= 15 ? 'warning' : 'info';\n        \n        alerts.push({\n          document: doc,\n          crewMember: member,\n          daysUntilExpiry,\n          severity: severity as 'critical' | 'warning' | 'info',\n        });\n      }\n    }\n\n    return alerts;\n  }\n\n  async getExpiringContracts(days: number): Promise<ContractAlert[]> {\n    const now = new Date();\n    const futureDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));\n    \n    const allContracts = await db\n      .select()\n      .from(contracts)\n      .where(eq(contracts.status, 'active'));\n\n    const alerts: ContractAlert[] = [];\n    \n    for (const contract of allContracts) {\n      const member = await this.getCrewMember(contract.crewMemberId);\n      const vessel = await this.getVessel(contract.vesselId);\n      \n      if (member && vessel) {\n        const daysUntilExpiry = Math.ceil((contract.endDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));\n        \n        // Include expired contracts (negative days) and contracts expiring within the specified days\n        if (daysUntilExpiry <= days) {\n          let severity: 'critical' | 'warning' | 'info' | 'expired';\n          if (daysUntilExpiry <= 0) {\n            severity = 'expired';\n          } else if (daysUntilExpiry <= 7) {\n            severity = 'critical';\n          } else if (daysUntilExpiry <= 15) {\n            severity = 'warning';\n          } else {\n            severity = 'info';\n          }\n          \n          alerts.push({\n            contract,\n            crewMember: member,\n            vessel,\n            daysUntilExpiry,\n            severity,\n          });\n        }\n      }\n    }\n\n    // Sort by days until expiry (expired first, then by urgency)\n    return alerts.sort((a, b) => a.daysUntilExpiry - b.daysUntilExpiry);\n  }\n\n  async getExpiringVesselDocuments(days: number): Promise<Array<{\n    document: {\n      id: string;\n      name: string;\n      type: string;\n      expiryDate: Date;\n    };\n    vessel: {\n      id: string;\n      name: string;\n    };\n    daysUntilExpiry: number;\n    severity: 'critical' | 'warning' | 'info';\n  }>> {\n    const now = new Date();\n    const futureDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));\n    \n    const expiringVesselDocs = await db\n      .select()\n      .from(vesselDocuments)\n      .where(and(\n        lte(vesselDocuments.expiryDate, futureDate),\n        gte(vesselDocuments.expiryDate, now),\n        isNotNull(vesselDocuments.expiryDate)\n      ));\n\n    const alerts = [];\n    \n    for (const doc of expiringVesselDocs) {\n      const vessel = await this.getVessel(doc.vesselId);\n      if (vessel && doc.expiryDate) {\n        const daysUntilExpiry = Math.ceil((doc.expiryDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));\n        const severity = daysUntilExpiry <= 7 ? 'critical' : daysUntilExpiry <= 15 ? 'warning' : 'info';\n        \n        alerts.push({\n          document: {\n            id: doc.id,\n            name: doc.name,\n            type: doc.type,\n            expiryDate: doc.expiryDate,\n          },\n          vessel: {\n            id: vessel.id,\n            name: vessel.name,\n          },\n          daysUntilExpiry,\n          severity: severity as 'critical' | 'warning' | 'info',\n        });\n      }\n    }\n\n    return alerts;\n  }\n\n  async createDocument(document: InsertDocument): Promise<Document> {\n    const [newDocument] = await db\n      .insert(documents)\n      .values(document)\n      .returning();\n    return newDocument;\n  }\n\n  async updateDocument(id: string, document: Partial<InsertDocument>): Promise<Document | undefined> {\n    const [updated] = await db\n      .update(documents)\n      .set(document)\n      .where(eq(documents.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteDocument(id: string): Promise<boolean> {\n    const result = await db.delete(documents).where(eq(documents.id, id));\n    return (result.rowCount || 0) > 0;\n  }\n\n  // Crew rotation operations\n  async getCrewRotations(): Promise<CrewRotation[]> {\n    return await db.select().from(crewRotations);\n  }\n\n  async getCrewRotationsByVessel(vesselId: string): Promise<CrewRotation[]> {\n    return await db.select().from(crewRotations).where(eq(crewRotations.vesselId, vesselId));\n  }\n\n  async createCrewRotation(rotation: InsertCrewRotation): Promise<CrewRotation> {\n    const [newRotation] = await db\n      .insert(crewRotations)\n      .values(rotation)\n      .returning();\n    return newRotation;\n  }\n\n  async updateCrewRotation(id: string, rotation: Partial<InsertCrewRotation>): Promise<CrewRotation | undefined> {\n    const [updated] = await db\n      .update(crewRotations)\n      .set(rotation)\n      .where(eq(crewRotations.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteCrewRotation(id: string): Promise<boolean> {\n    const result = await db.delete(crewRotations).where(eq(crewRotations.id, id));\n    return (result.rowCount || 0) > 0;\n  }\n\n  // Email settings operations\n  async getEmailSettings(): Promise<EmailSettings | undefined> {\n    const [settings] = await db.select().from(emailSettings).limit(1);\n    return settings || undefined;\n  }\n\n  async updateEmailSettings(settings: InsertEmailSettings): Promise<EmailSettings> {\n    const existing = await this.getEmailSettings();\n    \n    if (existing) {\n      const [updated] = await db\n        .update(emailSettings)\n        .set(settings)\n        .where(eq(emailSettings.id, existing.id))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db\n        .insert(emailSettings)\n        .values(settings)\n        .returning();\n      return created;\n    }\n  }\n\n  // WhatsApp settings operations\n  async getWhatsappSettings(): Promise<WhatsappSettings | undefined> {\n    const [settings] = await db.select().from(whatsappSettings).limit(1);\n    return settings || undefined;\n  }\n\n  async updateWhatsappSettings(settings: InsertWhatsappSettings): Promise<WhatsappSettings> {\n    const existing = await this.getWhatsappSettings();\n    \n    if (existing) {\n      const [updated] = await db\n        .update(whatsappSettings)\n        .set(settings)\n        .where(eq(whatsappSettings.id, existing.id))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db\n        .insert(whatsappSettings)\n        .values(settings)\n        .returning();\n      return created;\n    }\n  }\n\n  // Activity log operations\n  async logActivity(activity: InsertActivityLog): Promise<ActivityLog> {\n    const [newActivity] = await db\n      .insert(activityLogs)\n      .values(activity)\n      .returning();\n    return newActivity;\n  }\n\n  async getActivityLogs(): Promise<ActivityLog[]> {\n    return await db.select().from(activityLogs).orderBy(activityLogs.createdAt);\n  }\n\n  // Notification history operations\n  async logNotification(notification: InsertNotificationHistory): Promise<NotificationHistory> {\n    const [newNotification] = await db\n      .insert(notificationHistory)\n      .values(notification)\n      .returning();\n    return newNotification;\n  }\n\n  async getNotificationHistory(eventId: string, eventType: string, daysBeforeEvent: number): Promise<NotificationHistory[]> {\n    return await db\n      .select()\n      .from(notificationHistory)\n      .where(and(\n        eq(notificationHistory.eventId, eventId),\n        eq(notificationHistory.eventType, eventType),\n        eq(notificationHistory.daysBeforeEvent, daysBeforeEvent)\n      ));\n  }\n\n  async hasNotificationBeenSent(eventId: string, eventType: string, daysBeforeEvent: number, provider: string): Promise<boolean> {\n    const [notification] = await db\n      .select()\n      .from(notificationHistory)\n      .where(and(\n        eq(notificationHistory.eventId, eventId),\n        eq(notificationHistory.eventType, eventType),\n        eq(notificationHistory.daysBeforeEvent, daysBeforeEvent),\n        eq(notificationHistory.provider, provider),\n        eq(notificationHistory.success, true)\n      ))\n      .limit(1);\n    \n    return !!notification;\n  }\n\n  async hasNotificationBeenSentToday(eventId: string, eventType: string, provider: string, dateStr: string): Promise<boolean> {\n    const startOfDay = new Date(dateStr);\n    const endOfDay = new Date(dateStr);\n    endOfDay.setHours(23, 59, 59, 999);\n    \n    const [notification] = await db\n      .select()\n      .from(notificationHistory)\n      .where(and(\n        eq(notificationHistory.eventId, eventId),\n        eq(notificationHistory.eventType, eventType),\n        eq(notificationHistory.provider, provider),\n        eq(notificationHistory.success, true),\n        gte(notificationHistory.notificationDate, startOfDay),\n        lte(notificationHistory.notificationDate, endOfDay)\n      ))\n      .limit(1);\n    \n    return !!notification;\n  }\n\n  async getFailedNotifications(maxRetries: number = 3): Promise<NotificationHistory[]> {\n    return await db\n      .select()\n      .from(notificationHistory)\n      .where(and(\n        eq(notificationHistory.success, false),\n        lte(notificationHistory.retryCount, maxRetries)\n      ));\n  }\n\n  async updateNotificationStatus(id: string, success: boolean, errorMessage?: string, retryCount?: number): Promise<NotificationHistory | undefined> {\n    const updateData: Partial<InsertNotificationHistory> = { success };\n    \n    if (errorMessage !== undefined) {\n      updateData.errorMessage = errorMessage;\n    }\n    \n    if (retryCount !== undefined) {\n      updateData.retryCount = retryCount;\n    }\n\n    const [updated] = await db\n      .update(notificationHistory)\n      .set(updateData)\n      .where(eq(notificationHistory.id, id))\n      .returning();\n    \n    return updated || undefined;\n  }\n\n  // Vessel document operations\n  async getVesselDocuments(vesselId: string): Promise<VesselDocument[]> {\n    return await db.select().from(vesselDocuments)\n      .where(eq(vesselDocuments.vesselId, vesselId))\n      .orderBy(vesselDocuments.uploadedAt);\n  }\n\n  async getVesselDocument(id: string): Promise<VesselDocument | undefined> {\n    const [document] = await db.select().from(vesselDocuments).where(eq(vesselDocuments.id, id));\n    return document || undefined;\n  }\n\n  async createVesselDocument(document: InsertVesselDocument): Promise<VesselDocument> {\n    const [newDocument] = await db\n      .insert(vesselDocuments)\n      .values(document)\n      .returning();\n    return newDocument;\n  }\n\n  async updateVesselDocument(id: string, document: Partial<InsertVesselDocument>): Promise<VesselDocument | undefined> {\n    const [updated] = await db\n      .update(vesselDocuments)\n      .set(document)\n      .where(eq(vesselDocuments.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteVesselDocument(id: string): Promise<boolean> {\n    const result = await db.delete(vesselDocuments).where(eq(vesselDocuments.id, id));\n    return (result.rowCount || 0) > 0;\n  }\n\n  async getVesselContractStats(vesselId: string): Promise<{active: number, expiringSoon: number, expired: number}> {\n    const now = new Date();\n    const fortyFiveDaysFromNow = new Date(now.getTime() + 45 * 24 * 60 * 60 * 1000);\n    \n    const vesselContracts = await db\n      .select()\n      .from(contracts)\n      .innerJoin(crewMembers, eq(contracts.crewMemberId, crewMembers.id))\n      .where(eq(crewMembers.currentVesselId, vesselId));\n    \n    const stats = {\n      active: 0,\n      expiringSoon: 0,\n      expired: 0\n    };\n    \n    for (const { contracts: contract } of vesselContracts) {\n      if (contract.status !== 'active') continue;\n      \n      if (contract.endDate < now) {\n        stats.expired++;\n      } else if (contract.endDate <= fortyFiveDaysFromNow) {\n        stats.expiringSoon++;\n      } else {\n        stats.active++;\n      }\n    }\n    \n    return stats;\n  }\n\n  async getVesselContracts(vesselId: string, status?: string): Promise<Array<Contract & {crewMember: CrewMember}>> {\n    const query = db\n      .select()\n      .from(contracts)\n      .innerJoin(crewMembers, eq(contracts.crewMemberId, crewMembers.id))\n      .where(eq(crewMembers.currentVesselId, vesselId));\n      \n    const results = await query;\n    \n    const contractsWithCrew = results.map(row => ({\n      ...row.contracts,\n      crewMember: row.crew_members\n    }));\n    \n    if (status) {\n      const now = new Date();\n      const fortyFiveDaysFromNow = new Date(now.getTime() + 45 * 24 * 60 * 60 * 1000);\n      \n      return contractsWithCrew.filter(contract => {\n        if (status === 'active') {\n          return contract.status === 'active' && contract.endDate > fortyFiveDaysFromNow;\n        } else if (status === 'expiring') {\n          return contract.status === 'active' && contract.endDate <= fortyFiveDaysFromNow && contract.endDate >= now;\n        } else if (status === 'expired') {\n          return contract.endDate < now;\n        }\n        return contract.status === status;\n      });\n    }\n    \n    return contractsWithCrew;\n  }\n}\n\nexport class MemStorage implements IStorage {\n  private users: Map<string, User>;\n  private vessels: Map<string, Vessel>;\n  private crewMembers: Map<string, CrewMember>;\n  private contracts: Map<string, Contract>;\n  private documents: Map<string, Document>;\n  private vesselDocuments: Map<string, VesselDocument>;\n  private crewRotations: Map<string, CrewRotation>;\n  private emailSettings: EmailSettings | undefined;\n  private whatsappSettings: WhatsappSettings | undefined;\n  private notificationHistory: Map<string, NotificationHistory>;\n\n  constructor() {\n    this.users = new Map();\n    this.vessels = new Map();\n    this.crewMembers = new Map();\n    this.contracts = new Map();\n    this.documents = new Map();\n    this.vesselDocuments = new Map();\n    this.crewRotations = new Map();\n    this.notificationHistory = new Map();\n    this.initializeData();\n  }\n\n  private initializeData() {\n    // CRITICAL: Never create demo data in production\n    const environment = process.env.NODE_ENV || 'development';\n    \n    if (environment === 'production') {\n      console.error('‚ùå DEMO DATA BLOCKED: MemStorage should not be used in production');\n      console.error('   Use DatabaseStorage with real PostgreSQL database instead');\n      return;\n    }\n    \n    console.log(`üîß Initializing demo data for ${environment} environment`);\n    \n    // Create default admin user\n    const adminUser: User = {\n      id: randomUUID(),\n      username: \"admin\",\n      password: \"admin123\", // In real app, this would be hashed\n      role: \"admin\",\n      email: \"admin@crewtrack.com\",\n      name: \"John Smith\",\n      createdAt: new Date(),\n    };\n    this.users.set(adminUser.id, adminUser);\n\n    // Create office staff user\n    const officeStaffUser: User = {\n      id: randomUUID(),\n      username: \"office\",\n      password: \"office123\",\n      role: \"office_staff\",\n      email: \"office@crewtrack.com\",\n      name: \"Sarah Wilson\",\n      createdAt: new Date(),\n    };\n    this.users.set(officeStaffUser.id, officeStaffUser);\n\n    // Create sample vessels\n    const vessel1: Vessel = {\n      id: randomUUID(),\n      name: \"MV Ocean Pioneer\",\n      type: \"Container Ship\",\n      imoNumber: \"1234567\",\n      flag: \"Panama\",\n      status: \"active\",\n      sortOrder: 1,\n      createdAt: new Date(),\n    };\n    const vessel2: Vessel = {\n      id: randomUUID(),\n      name: \"MV Maritime Explorer\",\n      type: \"Bulk Carrier\",\n      imoNumber: \"2345678\",\n      flag: \"Liberia\",\n      status: \"active\",\n      sortOrder: 2,\n      createdAt: new Date(),\n    };\n    const vessel3: Vessel = {\n      id: randomUUID(),\n      name: \"MV Deep Blue\",\n      type: \"Tanker\",\n      imoNumber: \"3456789\",\n      flag: \"Singapore\",\n      status: \"maintenance\",\n      sortOrder: 3,\n      createdAt: new Date(),\n    };\n\n    const vessel4: Vessel = {\n      id: randomUUID(),\n      name: \"MV Nordic Explorer\",\n      type: \"Ro-Ro Ferry\",\n      imoNumber: \"4567890\",\n      flag: \"Norway\",\n      status: \"active\",\n      sortOrder: 4,\n      createdAt: new Date(),\n    };\n\n    const vessel5: Vessel = {\n      id: randomUUID(),\n      name: \"MV Pacific Voyager\",\n      type: \"Container Ship\",\n      imoNumber: \"5678901\",\n      flag: \"Marshall Islands\",\n      status: \"in-port\",\n      sortOrder: 5,\n      createdAt: new Date(),\n    };\n\n    const vessel6: Vessel = {\n      id: randomUUID(),\n      name: \"MV Arctic Breeze\",\n      type: \"Oil Tanker\",\n      imoNumber: \"6789012\",\n      flag: \"Denmark\",\n      status: \"active\",\n      sortOrder: 6,\n      createdAt: new Date(),\n    };\n\n    const vessel7: Vessel = {\n      id: randomUUID(),\n      name: \"Sagar\",\n      type: \"Container Ship\",\n      imoNumber: \"IMO1234567\",\n      flag: \"India\",\n      status: \"active\",\n      sortOrder: 7,\n      createdAt: new Date(\"2025-08-13\"),\n    };\n    \n    this.vessels.set(vessel1.id, vessel1);\n    this.vessels.set(vessel2.id, vessel2);\n    this.vessels.set(vessel3.id, vessel3);\n    this.vessels.set(vessel4.id, vessel4);\n    this.vessels.set(vessel5.id, vessel5);\n    this.vessels.set(vessel6.id, vessel6);\n    this.vessels.set(vessel7.id, vessel7);\n\n\n\n    // Create sample crew members\n    const crewMember1: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Robert\",\n      lastName: \"Johnson\",\n      nationality: \"United Kingdom\",\n      dateOfBirth: new Date(\"1975-03-15\"),\n      rank: \"Captain\",\n      phoneNumber: \"+44-123-456-7890\",\n      emergencyContact: {\n        name: \"Sarah Johnson\",\n        relationship: \"Wife\",\n        phone: \"+44-123-456-7891\",\n        email: \"sarah.j@email.com\"\n      },\n      currentVesselId: vessel3.id,\n      lastVesselId: null,\n      status: \"active\",\n      signOffDate: null,\n      createdAt: new Date(),\n    };\n\n    const crewMember2: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Michael\",\n      lastName: \"Santos\",\n      nationality: \"Philippines\",\n      dateOfBirth: new Date(\"1985-07-22\"),\n      rank: \"Chief Engineer\",\n      phoneNumber: \"+63-123-456-7890\",\n      emergencyContact: {\n        name: \"Maria Santos\",\n        relationship: \"Wife\",\n        phone: \"+63-123-456-7891\",\n        email: \"maria.s@email.com\"\n      },\n      currentVesselId: vessel1.id,\n      status: \"active\",\n      signOffDate: null,\n      createdAt: new Date(),\n    };\n\n    const crewMember3: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Anna\",\n      lastName: \"Kowalski\",\n      nationality: \"Poland\",\n      dateOfBirth: new Date(\"1990-11-08\"),\n      rank: \"2nd Officer\",\n      phoneNumber: \"+48-123-456-7890\",\n      emergencyContact: {\n        name: \"Jan Kowalski\",\n        relationship: \"Father\",\n        phone: \"+48-123-456-7891\",\n        email: \"jan.k@email.com\"\n      },\n      currentVesselId: vessel2.id,\n      status: \"active\",\n      signOffDate: null,\n      createdAt: new Date(),\n    };\n\n    // Add more crew members for other vessels\n    const crewMember4: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Carlos\",\n      lastName: \"Rodriguez\",\n      nationality: \"Spain\",\n      dateOfBirth: new Date(\"1988-03-15\"),\n      rank: \"Chief Cook\",\n      phoneNumber: \"+34-123-456-7890\",\n      emergencyContact: {\n        name: \"Maria Rodriguez\",\n        relationship: \"Wife\",\n        phone: \"+34-123-456-7891\",\n        email: \"maria.r@email.com\"\n      },\n      currentVesselId: vessel4.id,\n      status: \"active\",\n      signOffDate: null,\n      createdAt: new Date(),\n    };\n\n    const crewMember5: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Erik\",\n      lastName: \"Larsen\",\n      nationality: \"Norway\",\n      dateOfBirth: new Date(\"1982-09-22\"),\n      rank: \"Bosun\",\n      phoneNumber: \"+47-123-456-7890\",\n      emergencyContact: {\n        name: \"Ingrid Larsen\",\n        relationship: \"Wife\",\n        phone: \"+47-123-456-7891\",\n        email: \"ingrid.l@email.com\"\n      },\n      currentVesselId: vessel5.id,\n      status: \"active\",\n      signOffDate: null,\n      createdAt: new Date(),\n    };\n\n    // Add unassigned crew members for testing assignment functionality\n    const crewMember6: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"David\",\n      lastName: \"Chen\",\n      nationality: \"Singapore\",\n      dateOfBirth: new Date(\"1987-06-12\"),\n      rank: \"3rd Officer\",\n      phoneNumber: \"+65-123-456-7890\",\n      emergencyContact: {\n        name: \"Lisa Chen\",\n        relationship: \"Wife\",\n        phone: \"+65-123-456-7891\",\n        email: \"lisa.c@email.com\"\n      },\n      currentVesselId: null, // Unassigned\n      status: \"active\",\n      signOffDate: null,\n      createdAt: new Date(),\n    };\n\n    const crewMember7: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Marco\",\n      lastName: \"Rossi\",\n      nationality: \"Italy\",\n      dateOfBirth: new Date(\"1984-02-28\"),\n      rank: \"Electrician\",\n      phoneNumber: \"+39-123-456-7890\",\n      emergencyContact: {\n        name: \"Sofia Rossi\",\n        relationship: \"Wife\",\n        phone: \"+39-123-456-7891\",\n        email: \"sofia.r@email.com\"\n      },\n      currentVesselId: null, // Unassigned\n      status: \"active\",\n      signOffDate: null,\n      createdAt: new Date(),\n    };\n\n    const crewMember8: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Ahmed\",\n      lastName: \"Hassan\",\n      nationality: \"Egypt\",\n      dateOfBirth: new Date(\"1991-10-15\"),\n      rank: \"Able Seaman\",\n      phoneNumber: \"+20-123-456-7890\",\n      emergencyContact: {\n        name: \"Fatima Hassan\",\n        relationship: \"Mother\",\n        phone: \"+20-123-456-7891\",\n        email: \"fatima.h@email.com\"\n      },\n      currentVesselId: null, // Unassigned\n      status: \"active\",\n      signOffDate: null,\n      createdAt: new Date(),\n    };\n\n    // Add signed-off crew members for Ex-Hand Database testing\n    const signedOffCrew1: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Satish\",\n      lastName: \"Kumar\",\n      nationality: \"India\",\n      dateOfBirth: new Date(\"1988-05-10\"),\n      rank: \"Wiper\",\n      phoneNumber: \"+91-123-456-7890\",\n      emergencyContact: {\n        name: \"Priya Kumar\",\n        relationship: \"Wife\",\n        phone: \"+91-123-456-7891\",\n        email: \"priya.k@email.com\"\n      },\n      currentVesselId: vessel1.id, // Keep vessel reference for \"Last Vessel Sailed\"\n      status: \"onShore\", // Signed off\n      signOffDate: new Date(\"2024-12-20\"),\n      createdAt: new Date(),\n    };\n\n    const signedOffCrew2: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Alexander\",\n      lastName: \"Philip\",\n      nationality: \"Philippines\",\n      dateOfBirth: new Date(\"1986-03-22\"),\n      rank: \"AB Seaman\",\n      phoneNumber: \"+63-123-456-7890\",\n      emergencyContact: {\n        name: \"Maria Philip\",\n        relationship: \"Wife\",\n        phone: \"+63-123-456-7891\",\n        email: \"maria.p@email.com\"\n      },\n      currentVesselId: vessel2.id, // Keep vessel reference for \"Last Vessel Sailed\"\n      status: \"onShore\", // Signed off\n      signOffDate: new Date(\"2024-12-18\"),\n      createdAt: new Date(),\n    };\n\n    const signedOffCrew3: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Ragarajan\",\n      lastName: \"Chandrasekaran\",\n      nationality: \"India\",\n      dateOfBirth: new Date(\"1985-08-14\"),\n      rank: \"2nd Engineer\",\n      phoneNumber: \"+91-987-654-3210\",\n      emergencyContact: {\n        name: \"Lakshmi Chandrasekaran\",\n        relationship: \"Wife\",\n        phone: \"+91-987-654-3211\",\n        email: \"lakshmi.c@email.com\"\n      },\n      currentVesselId: vessel3.id, // Keep vessel reference for \"Last Vessel Sailed\"\n      status: \"onShore\", // Signed off\n      signOffDate: new Date(\"2024-12-15\"),\n      createdAt: new Date(),\n    };\n\n    this.crewMembers.set(crewMember1.id, crewMember1);\n    this.crewMembers.set(crewMember2.id, crewMember2);\n    this.crewMembers.set(crewMember3.id, crewMember3);\n    this.crewMembers.set(crewMember4.id, crewMember4);\n    this.crewMembers.set(crewMember5.id, crewMember5);\n    this.crewMembers.set(crewMember6.id, crewMember6);\n    this.crewMembers.set(crewMember7.id, crewMember7);\n    this.crewMembers.set(crewMember8.id, crewMember8);\n    this.crewMembers.set(signedOffCrew1.id, signedOffCrew1);\n    this.crewMembers.set(signedOffCrew2.id, signedOffCrew2);\n    this.crewMembers.set(signedOffCrew3.id, signedOffCrew3);\n\n    // Create sample contracts\n    const contract1: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember1.id,\n      vesselId: vessel3.id,\n      startDate: new Date(\"2024-01-01\"),\n      endDate: new Date(\"2024-07-01\"),\n      durationDays: 182, // 6 months\n      salary: 8000,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract2: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember2.id,\n      vesselId: vessel1.id,\n      startDate: new Date(\"2023-11-01\"),\n      endDate: new Date(\"2024-05-01\"),\n      durationDays: 182, // 6 months\n      salary: 6500,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract3: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember3.id,\n      vesselId: vessel2.id,\n      startDate: new Date(\"2024-02-15\"),\n      endDate: new Date(\"2024-08-15\"),\n      durationDays: 182, // 6 months\n      salary: 5500,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    // Add contracts for additional crew members\n    const contract4: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember4.id,\n      vesselId: vessel4.id,\n      startDate: new Date(\"2024-03-01\"),\n      endDate: new Date(\"2025-03-01\"),\n      durationDays: 365, // 1 year\n      salary: 4500,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract5: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember5.id,\n      vesselId: vessel5.id,\n      startDate: new Date(\"2024-01-15\"),\n      endDate: new Date(\"2025-01-15\"),\n      durationDays: 365, // 1 year\n      salary: 5000,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    // Add more contracts with varied expiry dates for demonstration\n    const contract6: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember1.id,\n      vesselId: vessel1.id,\n      startDate: new Date(\"2024-06-01\"),\n      endDate: new Date(\"2025-08-25\"), // Expiring in ~12 days\n      durationDays: 450, // ~15 months\n      salary: 6500,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract7: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember2.id,\n      vesselId: vessel2.id,\n      startDate: new Date(\"2024-09-01\"),\n      endDate: new Date(\"2025-08-18\"), // Expiring in ~4 days\n      durationDays: 351, // ~11.5 months  \n      salary: 5800,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract8: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember3.id,\n      vesselId: vessel2.id,\n      startDate: new Date(\"2024-08-01\"),\n      endDate: new Date(\"2025-08-20\"), // Expiring within 30 days\n      durationDays: 354, // ~11.5 months\n      salary: 5200,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    this.contracts.set(contract1.id, contract1);\n    this.contracts.set(contract2.id, contract2);\n    this.contracts.set(contract3.id, contract3);\n    this.contracts.set(contract4.id, contract4);\n    this.contracts.set(contract5.id, contract5);\n    this.contracts.set(contract6.id, contract6);\n    this.contracts.set(contract7.id, contract7);\n    this.contracts.set(contract8.id, contract8);\n\n    // Create sample documents with some expiring soon\n    const documents = [\n      {\n        id: randomUUID(),\n        crewMemberId: crewMember3.id,\n        type: \"stcw\",\n        documentNumber: \"STCW-2024-001\",\n        issueDate: new Date(\"2022-01-15\"),\n        expiryDate: new Date(\"2025-01-22\"), // Expiring in 7 days from Aug 12, 2025\n        issuingAuthority: \"Polish Maritime Authority\",\n        status: \"expiring\",\n        filePath: null,\n        createdAt: new Date(),\n      },\n      {\n        id: randomUUID(),\n        crewMemberId: crewMember2.id,\n        type: \"medical\",\n        documentNumber: \"MED-2024-002\",\n        issueDate: new Date(\"2023-08-01\"),\n        expiryDate: new Date(\"2025-08-27\"), // Expiring in 15 days\n        issuingAuthority: \"Philippine Health Authority\",\n        status: \"expiring\",\n        filePath: null,\n        createdAt: new Date(),\n      },\n      {\n        id: randomUUID(),\n        crewMemberId: crewMember1.id,\n        type: \"passport\",\n        documentNumber: \"UK123456789\",\n        issueDate: new Date(\"2020-06-01\"),\n        expiryDate: new Date(\"2025-09-12\"), // Expiring in 31 days\n        issuingAuthority: \"UK Passport Office\",\n        status: \"valid\",\n        filePath: null,\n        createdAt: new Date(),\n      }\n    ];\n\n    documents.forEach(doc => this.documents.set(doc.id, doc));\n\n    // Create sample crew rotations with upcoming events\n    const rotation1: CrewRotation = {\n      id: randomUUID(),\n      crewMemberId: crewMember6.id, // David Chen - unassigned\n      vesselId: vessel1.id, // MV Ocean Pioneer\n      joinDate: new Date(\"2025-08-20\"), // 6 days from now\n      leaveDate: new Date(\"2025-12-20\"),\n      rotationType: \"rotation\",\n      status: \"scheduled\",\n      notes: \"David Chen scheduled to join as 3rd Officer\",\n      createdAt: new Date(),\n    };\n\n    const rotation2: CrewRotation = {\n      id: randomUUID(),\n      crewMemberId: crewMember1.id, // James Anderson\n      vesselId: vessel3.id, // Current vessel - Deep Blue\n      joinDate: new Date(\"2024-06-01\"), // Already joined\n      leaveDate: new Date(\"2025-08-22\"), // 8 days from now\n      rotationType: \"leave\",\n      status: \"scheduled\",\n      notes: \"End of contract rotation\",\n      createdAt: new Date(),\n    };\n\n    const rotation3: CrewRotation = {\n      id: randomUUID(),\n      crewMemberId: crewMember7.id, // Marco Rossi - unassigned\n      vesselId: vessel4.id, // MV Nordic Explorer\n      joinDate: new Date(\"2025-09-05\"), // 22 days from now\n      leaveDate: null,\n      rotationType: \"join\",\n      status: \"scheduled\",\n      notes: \"Marco Rossi joining as Electrician\",\n      createdAt: new Date(),\n    };\n\n    const rotation4: CrewRotation = {\n      id: randomUUID(),\n      crewMemberId: crewMember2.id, // Miguel Santos\n      vesselId: vessel1.id, // Current vessel\n      joinDate: new Date(\"2024-01-01\"), // Already joined\n      leaveDate: new Date(\"2025-08-17\"), // 3 days from now - urgent!\n      rotationType: \"leave\",\n      status: \"scheduled\",\n      notes: \"Contract completion - urgent replacement needed\",\n      createdAt: new Date(),\n    };\n\n    this.crewRotations.set(rotation1.id, rotation1);\n    this.crewRotations.set(rotation2.id, rotation2);\n    this.crewRotations.set(rotation3.id, rotation3);\n    this.crewRotations.set(rotation4.id, rotation4);\n\n    // Initialize email settings\n    this.emailSettings = {\n      id: randomUUID(),\n      reminderDays: [30, 15, 7],\n      enabled: true,\n      recipients: ['office_staff', 'admin'],\n      emailTemplate: \"Dear [Crew Member],\\n\\nYour [Document Type] is scheduled to expire on [Expiry Date]. Please contact your Fleet Administrator to discuss renewal arrangements.\\n\\nBest regards,\\nCrewTrack Pro Team\",\n      updatedAt: new Date(),\n    } as EmailSettings;\n  }\n\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(user => user.username === username);\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const id = randomUUID();\n    const user: User = { ...insertUser, id, createdAt: new Date() };\n    this.users.set(id, user);\n    return user;\n  }\n\n  // Vessel operations\n  async getVessels(): Promise<Vessel[]> {\n    return Array.from(this.vessels.values());\n  }\n\n  async getVessel(id: string): Promise<Vessel | undefined> {\n    return this.vessels.get(id);\n  }\n\n  async createVessel(insertVessel: InsertVessel): Promise<Vessel> {\n    const id = randomUUID();\n    const vessel: Vessel = { \n      ...insertVessel,\n      id, \n      createdAt: new Date(),\n      imoNumber: insertVessel.imoNumber || null,\n      status: insertVessel.status || 'active',\n      sortOrder: insertVessel.sortOrder || null\n    };\n    this.vessels.set(id, vessel);\n    return vessel;\n  }\n\n  async updateVessel(id: string, updates: Partial<InsertVessel>): Promise<Vessel | undefined> {\n    const vessel = this.vessels.get(id);\n    if (!vessel) return undefined;\n    \n    const updated = { ...vessel, ...updates };\n    this.vessels.set(id, updated);\n    return updated;\n  }\n\n  async deleteVessel(id: string): Promise<boolean> {\n    // First, unassign any crew members from this vessel\n    const crewMembers = Array.from(this.crewMembers.values());\n    for (const member of crewMembers) {\n      if (member.currentVesselId === id) {\n        member.currentVesselId = null;\n      }\n    }\n    \n    return this.vessels.delete(id);\n  }\n\n  async updateVesselOrder(vesselIds: string[]): Promise<boolean> {\n    try {\n      // Update sort order for each vessel\n      for (let i = 0; i < vesselIds.length; i++) {\n        const vessel = this.vessels.get(vesselIds[i]);\n        if (vessel) {\n          vessel.sortOrder = i + 1;\n          this.vessels.set(vesselIds[i], vessel);\n        }\n      }\n      return true;\n    } catch (error) {\n      console.error('Error updating vessel order:', error);\n      return false;\n    }\n  }\n\n  // Crew member methods\n  async createCrewMember(data: InsertCrewMember): Promise<CrewMember> {\n    const id = crypto.randomUUID();\n    const crewMember: CrewMember = {\n      id,\n      userId: data.userId || null,\n      firstName: data.firstName,\n      lastName: data.lastName,\n      nationality: data.nationality,\n      dateOfBirth: data.dateOfBirth,\n      rank: data.rank,\n      phoneNumber: data.phoneNumber || null,\n      emergencyContact: data.emergencyContact || null,\n      currentVesselId: data.currentVesselId || null,\n      status: data.status || 'active',\n      signOffDate: data.signOffDate || null,\n      createdAt: new Date(),\n    };\n    \n    this.crewMembers.set(id, crewMember);\n    return crewMember;\n  }\n\n  // Crew member operations\n  async getCrewMembers(): Promise<CrewMemberWithDetails[]> {\n    const crewMembers = Array.from(this.crewMembers.values());\n    return Promise.all(crewMembers.map(async (member) => {\n      const user = await this.getUser(member.userId || '');\n      const currentVessel = member.currentVesselId ? await this.getVessel(member.currentVesselId) : undefined;\n      const documents = await this.getDocumentsByCrewMember(member.id);\n      const activeContract = await this.getActiveContract(member.id);\n      \n      return {\n        ...member,\n        user,\n        currentVessel,\n        documents,\n        activeContract,\n      };\n    }));\n  }\n\n  async getCrewMember(id: string): Promise<CrewMemberWithDetails | undefined> {\n    const member = this.crewMembers.get(id);\n    if (!member) return undefined;\n\n    const user = member.userId ? await this.getUser(member.userId) : undefined;\n    const currentVessel = member.currentVesselId ? await this.getVessel(member.currentVesselId) : undefined;\n    const documents = await this.getDocumentsByCrewMember(member.id);\n    const activeContract = await this.getActiveContract(member.id);\n\n    return {\n      ...member,\n      user,\n      currentVessel,\n      documents,\n      activeContract,\n    };\n  }\n\n  async getCrewMembersByVessel(vesselId: string): Promise<CrewMemberWithDetails[]> {\n    const allCrew = await this.getCrewMembers();\n    return allCrew.filter(member => member.currentVesselId === vesselId);\n  }\n\n  async findDuplicateCrewMember(firstName: string, lastName: string, dateOfBirth: Date): Promise<CrewMember | undefined> {\n    const allMembers = Array.from(this.crewMembers.values());\n    return allMembers.find(member => \n      member.firstName.toLowerCase() === firstName.toLowerCase() &&\n      member.lastName.toLowerCase() === lastName.toLowerCase() &&\n      new Date(member.dateOfBirth).toDateString() === dateOfBirth.toDateString()\n    );\n  }\n\n  async updateCrewMember(id: string, updates: Partial<InsertCrewMember>): Promise<CrewMember | undefined> {\n    const member = this.crewMembers.get(id);\n    if (!member) return undefined;\n    \n    const updated = { ...member, ...updates };\n    this.crewMembers.set(id, updated);\n    return updated;\n  }\n\n  async deleteCrewMember(id: string): Promise<boolean> {\n    return this.crewMembers.delete(id);\n  }\n\n  // Contract operations\n  async getContracts(): Promise<Contract[]> {\n    return Array.from(this.contracts.values());\n  }\n\n  async getContractsByCrewMember(crewMemberId: string): Promise<Contract[]> {\n    return Array.from(this.contracts.values()).filter(contract => contract.crewMemberId === crewMemberId);\n  }\n\n  async getActiveContract(crewMemberId: string): Promise<Contract | undefined> {\n    const activeContracts = Array.from(this.contracts.values())\n      .filter(contract => contract.crewMemberId === crewMemberId && contract.status === 'active')\n      .sort((a, b) => (b.createdAt?.getTime() || 0) - (a.createdAt?.getTime() || 0));\n    return activeContracts[0];\n  }\n\n  async createContract(insertContract: InsertContract): Promise<Contract> {\n    const id = randomUUID();\n    const contract: Contract = { \n      ...insertContract, \n      id, \n      createdAt: new Date(),\n      status: insertContract.status || 'active',\n      salary: insertContract.salary || null,\n      currency: insertContract.currency || 'USD',\n      durationDays: insertContract.durationDays || null\n    };\n    this.contracts.set(id, contract);\n    return contract;\n  }\n\n  async updateContract(id: string, updates: Partial<InsertContract>): Promise<Contract | undefined> {\n    const contract = this.contracts.get(id);\n    if (!contract) return undefined;\n    \n    const updated = { ...contract, ...updates };\n    this.contracts.set(id, updated);\n    return updated;\n  }\n\n  // Document operations\n  async getDocuments(): Promise<Document[]> {\n    return Array.from(this.documents.values());\n  }\n\n  async getDocument(id: string): Promise<Document | undefined> {\n    return this.documents.get(id);\n  }\n\n  async getDocumentsByCrewMember(crewMemberId: string): Promise<Document[]> {\n    return Array.from(this.documents.values()).filter(doc => doc.crewMemberId === crewMemberId);\n  }\n\n  async getExpiringDocuments(days: number): Promise<DocumentAlert[]> {\n    const now = new Date();\n    const futureDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));\n    \n    const expiringDocs = Array.from(this.documents.values()).filter(doc => {\n      return doc.expiryDate <= futureDate && doc.expiryDate > now;\n    });\n\n    const alerts: DocumentAlert[] = [];\n    \n    for (const doc of expiringDocs) {\n      const member = this.crewMembers.get(doc.crewMemberId);\n      if (member) {\n        const daysUntilExpiry = Math.ceil((doc.expiryDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));\n        const severity = daysUntilExpiry <= 7 ? 'critical' : daysUntilExpiry <= 15 ? 'warning' : 'info';\n        \n        alerts.push({\n          document: doc,\n          crewMember: member,\n          daysUntilExpiry,\n          severity,\n        });\n      }\n    }\n\n    return alerts.sort((a, b) => a.daysUntilExpiry - b.daysUntilExpiry);\n  }\n\n  async getExpiringContracts(days: number): Promise<ContractAlert[]> {\n    const now = new Date();\n    \n    const activeContracts = Array.from(this.contracts.values()).filter(c => c.status === 'active');\n    const alerts: ContractAlert[] = [];\n    \n    for (const contract of activeContracts) {\n      const member = this.crewMembers.get(contract.crewMemberId);\n      const vessel = this.vessels.get(contract.vesselId);\n      \n      if (member && vessel) {\n        const daysUntilExpiry = Math.ceil((contract.endDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));\n        \n        // Include expired contracts (negative days) and contracts expiring within the specified days\n        if (daysUntilExpiry <= days) {\n          let severity: 'critical' | 'warning' | 'info' | 'expired';\n          if (daysUntilExpiry <= 0) {\n            severity = 'expired';\n          } else if (daysUntilExpiry <= 7) {\n            severity = 'critical';\n          } else if (daysUntilExpiry <= 15) {\n            severity = 'warning';\n          } else {\n            severity = 'info';\n          }\n          \n          alerts.push({\n            contract,\n            crewMember: member,\n            vessel,\n            daysUntilExpiry,\n            severity,\n          });\n        }\n      }\n    }\n\n    return alerts.sort((a, b) => a.daysUntilExpiry - b.daysUntilExpiry);\n  }\n\n  async createDocument(insertDocument: InsertDocument): Promise<Document> {\n    const id = randomUUID();\n    const document: Document = { \n      ...insertDocument, \n      id, \n      createdAt: new Date(),\n      status: insertDocument.status || 'valid',\n      filePath: insertDocument.filePath || null\n    };\n    this.documents.set(id, document);\n    return document;\n  }\n\n  async updateDocument(id: string, updates: Partial<InsertDocument>): Promise<Document | undefined> {\n    const document = this.documents.get(id);\n    if (!document) return undefined;\n    \n    const updated = { ...document, ...updates };\n    this.documents.set(id, updated);\n    return updated;\n  }\n\n  async deleteDocument(id: string): Promise<boolean> {\n    return this.documents.delete(id);\n  }\n\n  // Crew rotation operations\n  async getCrewRotations(): Promise<CrewRotation[]> {\n    return Array.from(this.crewRotations.values());\n  }\n\n  async getCrewRotationsByVessel(vesselId: string): Promise<CrewRotation[]> {\n    return Array.from(this.crewRotations.values()).filter(rotation => rotation.vesselId === vesselId);\n  }\n\n  async createCrewRotation(insertRotation: InsertCrewRotation): Promise<CrewRotation> {\n    const id = randomUUID();\n    const rotation: CrewRotation = { \n      ...insertRotation, \n      id, \n      createdAt: new Date(),\n      status: insertRotation.status || 'scheduled',\n      leaveDate: insertRotation.leaveDate || null,\n      notes: insertRotation.notes || null\n    };\n    this.crewRotations.set(id, rotation);\n    return rotation;\n  }\n\n  async updateCrewRotation(id: string, updates: Partial<InsertCrewRotation>): Promise<CrewRotation | undefined> {\n    const rotation = this.crewRotations.get(id);\n    if (!rotation) return undefined;\n    \n    const updated = { ...rotation, ...updates };\n    this.crewRotations.set(id, updated);\n    return updated;\n  }\n\n  async deleteCrewRotation(id: string): Promise<boolean> {\n    return this.crewRotations.delete(id);\n  }\n\n  async getVesselContractStats(vesselId: string): Promise<{active: number, expiringSoon: number, expired: number}> {\n    const now = new Date();\n    const fortyFiveDaysFromNow = new Date(now.getTime() + 45 * 24 * 60 * 60 * 1000);\n    \n    const stats = { active: 0, expiringSoon: 0, expired: 0 };\n    \n    for (const contract of Array.from(this.contracts.values())) {\n      const crewMember = this.crewMembers.get(contract.crewMemberId);\n      if (!crewMember || crewMember.currentVesselId !== vesselId || contract.status !== 'active') {\n        continue;\n      }\n      \n      if (contract.endDate < now) {\n        stats.expired++;\n      } else if (contract.endDate <= fortyFiveDaysFromNow) {\n        stats.expiringSoon++;\n      } else {\n        stats.active++;\n      }\n    }\n    \n    return stats;\n  }\n\n  async getVesselContracts(vesselId: string, status?: string): Promise<Array<Contract & {crewMember: CrewMember}>> {\n    const vesselContracts: Array<Contract & {crewMember: CrewMember}> = [];\n    \n    for (const contract of Array.from(this.contracts.values())) {\n      const crewMember = this.crewMembers.get(contract.crewMemberId);\n      if (!crewMember || crewMember.currentVesselId !== vesselId) {\n        continue;\n      }\n      \n      vesselContracts.push({\n        ...contract,\n        crewMember\n      });\n    }\n    \n    if (status) {\n      const now = new Date();\n      const fortyFiveDaysFromNow = new Date(now.getTime() + 45 * 24 * 60 * 60 * 1000);\n      \n      return vesselContracts.filter(contract => {\n        if (status === 'active') {\n          return contract.status === 'active' && contract.endDate > fortyFiveDaysFromNow;\n        } else if (status === 'expiring') {\n          return contract.status === 'active' && contract.endDate <= fortyFiveDaysFromNow && contract.endDate >= now;\n        } else if (status === 'expired') {\n          return contract.endDate < now;\n        }\n        return contract.status === status;\n      });\n    }\n    \n    return vesselContracts;\n  }\n\n  // Email settings operations\n  async getEmailSettings(): Promise<EmailSettings | undefined> {\n    return this.emailSettings;\n  }\n\n  async updateEmailSettings(settings: InsertEmailSettings): Promise<EmailSettings> {\n    const updated: EmailSettings = {\n      id: this.emailSettings?.id || randomUUID(),\n      reminderDays: settings.reminderDays || [30, 15, 7],\n      enabled: settings.enabled || true,\n      recipients: settings.recipients || ['office_staff', 'admin'],\n      emailTemplate: settings.emailTemplate || null,\n      updatedAt: new Date(),\n    };\n    this.emailSettings = updated;\n    return updated;\n  }\n\n  async getWhatsappSettings(): Promise<WhatsappSettings | undefined> {\n    return this.whatsappSettings;\n  }\n\n  async updateWhatsappSettings(settings: InsertWhatsappSettings): Promise<WhatsappSettings> {\n    const updated: WhatsappSettings = {\n      id: this.whatsappSettings?.id || randomUUID(),\n      enabled: settings.enabled ?? false,\n      provider: settings.provider || 'twilio',\n      apiKey: settings.apiKey || null,\n      groupId: settings.groupId || null,\n      webhookUrl: settings.webhookUrl || null,\n      notificationTypes: settings.notificationTypes || ['contract_expiry', 'document_expiry', 'crew_rotation'],\n      reminderDays: settings.reminderDays || [7, 3, 1],\n      messageTemplate: settings.messageTemplate || 'üìã *Crew Management Alert*\\n\\n{{title}}\\n{{description}}\\n\\nDate: {{date}}\\nSeverity: {{severity}}',\n      updatedAt: new Date(),\n    };\n    this.whatsappSettings = updated;\n    return updated;\n  }\n\n  // Activity log operations\n  async logActivity(activity: InsertActivityLog): Promise<ActivityLog> {\n    const id = randomUUID();\n    const log: ActivityLog = {\n      id,\n      type: activity.type,\n      action: activity.action,\n      entityType: activity.entityType,\n      entityId: activity.entityId || null,\n      userId: activity.userId || null,\n      username: activity.username,\n      userRole: activity.userRole,\n      description: activity.description,\n      severity: activity.severity || 'info',\n      metadata: activity.metadata || null,\n      createdAt: new Date(),\n    };\n    \n    // For in-memory storage, we'll just return the log without storing\n    // In a real implementation, you might want to store these in a Map\n    return log;\n  }\n\n  async getActivityLogs(): Promise<ActivityLog[]> {\n    // For in-memory storage, return empty array\n    // In a real implementation, you would retrieve from a Map\n    return [];\n  }\n\n  // Notification history operations\n  async logNotification(notification: InsertNotificationHistory): Promise<NotificationHistory> {\n    const id = randomUUID();\n    const log: NotificationHistory = {\n      id,\n      eventId: notification.eventId,\n      eventType: notification.eventType,\n      eventDate: notification.eventDate instanceof Date ? notification.eventDate : new Date(notification.eventDate),\n      notificationDate: notification.notificationDate instanceof Date ? notification.notificationDate : new Date(notification.notificationDate),\n      daysBeforeEvent: notification.daysBeforeEvent,\n      provider: notification.provider,\n      success: notification.success ?? true,\n      errorMessage: notification.errorMessage || null,\n      retryCount: notification.retryCount || 0,\n      metadata: notification.metadata || null,\n      createdAt: new Date(),\n    };\n    \n    this.notificationHistory.set(id, log);\n    return log;\n  }\n\n  async getNotificationHistory(eventId: string, eventType: string, daysBeforeEvent: number): Promise<NotificationHistory[]> {\n    return Array.from(this.notificationHistory.values()).filter(\n      notification => \n        notification.eventId === eventId &&\n        notification.eventType === eventType &&\n        notification.daysBeforeEvent === daysBeforeEvent\n    );\n  }\n\n  async hasNotificationBeenSent(eventId: string, eventType: string, daysBeforeEvent: number, provider: string): Promise<boolean> {\n    return Array.from(this.notificationHistory.values()).some(\n      notification => \n        notification.eventId === eventId &&\n        notification.eventType === eventType &&\n        notification.daysBeforeEvent === daysBeforeEvent &&\n        notification.provider === provider &&\n        notification.success === true\n    );\n  }\n\n  async hasNotificationBeenSentToday(eventId: string, eventType: string, provider: string, dateStr: string): Promise<boolean> {\n    const startOfDay = new Date(dateStr);\n    const endOfDay = new Date(dateStr);\n    endOfDay.setHours(23, 59, 59, 999);\n    \n    return Array.from(this.notificationHistory.values()).some(\n      notification => \n        notification.eventId === eventId &&\n        notification.eventType === eventType &&\n        notification.provider === provider &&\n        notification.success === true &&\n        notification.notificationDate >= startOfDay &&\n        notification.notificationDate <= endOfDay\n    );\n  }\n\n  async getFailedNotifications(maxRetries: number = 3): Promise<NotificationHistory[]> {\n    return Array.from(this.notificationHistory.values()).filter(\n      notification => \n        notification.success === false &&\n        (notification.retryCount || 0) <= maxRetries\n    );\n  }\n\n  async updateNotificationStatus(id: string, success: boolean, errorMessage?: string, retryCount?: number): Promise<NotificationHistory | undefined> {\n    const notification = this.notificationHistory.get(id);\n    if (!notification) {\n      return undefined;\n    }\n\n    const updated: NotificationHistory = {\n      ...notification,\n      success,\n      errorMessage: errorMessage !== undefined ? errorMessage : notification.errorMessage,\n      retryCount: retryCount !== undefined ? retryCount : notification.retryCount,\n    };\n\n    this.notificationHistory.set(id, updated);\n    return updated;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return Array.from(this.users.values());\n  }\n\n  // Vessel document operations\n  async getVesselDocuments(vesselId: string): Promise<VesselDocument[]> {\n    return Array.from(this.vesselDocuments.values()).filter(doc => doc.vesselId === vesselId);\n  }\n\n  async getVesselDocument(id: string): Promise<VesselDocument | undefined> {\n    return this.vesselDocuments.get(id);\n  }\n\n  async createVesselDocument(document: InsertVesselDocument): Promise<VesselDocument> {\n    const newDocument: VesselDocument = {\n      id: randomUUID(),\n      ...document,\n      uploadedAt: new Date(),\n      createdAt: new Date(),\n    };\n    this.vesselDocuments.set(newDocument.id, newDocument);\n    return newDocument;\n  }\n\n  async updateVesselDocument(id: string, document: Partial<InsertVesselDocument>): Promise<VesselDocument | undefined> {\n    const existing = this.vesselDocuments.get(id);\n    if (!existing) return undefined;\n\n    const updated: VesselDocument = {\n      ...existing,\n      ...document,\n    };\n    this.vesselDocuments.set(id, updated);\n    return updated;\n  }\n\n  async deleteVesselDocument(id: string): Promise<boolean> {\n    return this.vesselDocuments.delete(id);\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":66477,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"deployment/server/storage.ts":{"content":"import { \n  type User, \n  type InsertUser, \n  type Vessel, \n  type InsertVessel,\n  type CrewMember, \n  type InsertCrewMember,\n  type CrewMemberWithDetails,\n  type Contract,\n  type InsertContract,\n  type Document,\n  type InsertDocument,\n  type DocumentAlert,\n  type CrewRotation,\n  type InsertCrewRotation,\n  type EmailSettings,\n  type InsertEmailSettings,\n  type ActivityLog,\n  type InsertActivityLog,\n  users,\n  vessels,\n  crewMembers,\n  contracts,\n  documents,\n  crewRotations,\n  emailSettings,\n  activityLogs,\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, and, gte, lte, sql } from \"drizzle-orm\";\nimport { randomUUID } from \"crypto\";\n\nexport interface IStorage {\n  // User operations\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  getAllUsers(): Promise<User[]>;\n  \n  // Vessel operations\n  getVessels(): Promise<Vessel[]>;\n  getVessel(id: string): Promise<Vessel | undefined>;\n  createVessel(vessel: InsertVessel): Promise<Vessel>;\n  updateVessel(id: string, vessel: Partial<InsertVessel>): Promise<Vessel | undefined>;\n  deleteVessel(id: string): Promise<boolean>;\n  \n  // Crew member operations\n  getCrewMembers(): Promise<CrewMemberWithDetails[]>;\n  getCrewMember(id: string): Promise<CrewMemberWithDetails | undefined>;\n  getCrewMembersByVessel(vesselId: string): Promise<CrewMemberWithDetails[]>;\n  createCrewMember(crewMember: InsertCrewMember): Promise<CrewMember>;\n  updateCrewMember(id: string, crewMember: Partial<InsertCrewMember>): Promise<CrewMember | undefined>;\n  deleteCrewMember(id: string): Promise<boolean>;\n  \n  // Contract operations\n  getContracts(): Promise<Contract[]>;\n  getContractsByCrewMember(crewMemberId: string): Promise<Contract[]>;\n  getActiveContract(crewMemberId: string): Promise<Contract | undefined>;\n  createContract(contract: InsertContract): Promise<Contract>;\n  updateContract(id: string, contract: Partial<InsertContract>): Promise<Contract | undefined>;\n  getVesselContractStats(vesselId: string): Promise<{active: number, expiringSoon: number, expired: number}>;\n  getVesselContracts(vesselId: string, status?: string): Promise<Array<Contract & {crewMember: CrewMember}>>;\n  \n  // Document operations\n  getDocuments(): Promise<Document[]>;\n  getDocumentsByCrewMember(crewMemberId: string): Promise<Document[]>;\n  getExpiringDocuments(days: number): Promise<DocumentAlert[]>;\n  createDocument(document: InsertDocument): Promise<Document>;\n  updateDocument(id: string, document: Partial<InsertDocument>): Promise<Document | undefined>;\n  deleteDocument(id: string): Promise<boolean>;\n  \n  // Crew rotation operations\n  getCrewRotations(): Promise<CrewRotation[]>;\n  getCrewRotationsByVessel(vesselId: string): Promise<CrewRotation[]>;\n  createCrewRotation(rotation: InsertCrewRotation): Promise<CrewRotation>;\n  updateCrewRotation(id: string, rotation: Partial<InsertCrewRotation>): Promise<CrewRotation | undefined>;\n  deleteCrewRotation(id: string): Promise<boolean>;\n  \n  // Email settings operations\n  getEmailSettings(): Promise<EmailSettings | undefined>;\n  updateEmailSettings(settings: InsertEmailSettings): Promise<EmailSettings>;\n  \n  // Activity log operations\n  logActivity(activity: InsertActivityLog): Promise<ActivityLog>;\n  getActivityLogs(): Promise<ActivityLog[]>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user || undefined;\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.username, username));\n    return user || undefined;\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(insertUser)\n      .returning();\n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(users);\n  }\n\n  // Vessel operations\n  async getVessels(): Promise<Vessel[]> {\n    return await db.select().from(vessels);\n  }\n\n  async getVessel(id: string): Promise<Vessel | undefined> {\n    const [vessel] = await db.select().from(vessels).where(eq(vessels.id, id));\n    return vessel || undefined;\n  }\n\n  async createVessel(vessel: InsertVessel): Promise<Vessel> {\n    const [newVessel] = await db\n      .insert(vessels)\n      .values(vessel)\n      .returning();\n    return newVessel;\n  }\n\n  async updateVessel(id: string, vessel: Partial<InsertVessel>): Promise<Vessel | undefined> {\n    const [updated] = await db\n      .update(vessels)\n      .set(vessel)\n      .where(eq(vessels.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteVessel(id: string): Promise<boolean> {\n    // First, unassign any crew members from this vessel\n    await db\n      .update(crewMembers)\n      .set({ currentVesselId: null })\n      .where(eq(crewMembers.currentVesselId, id));\n    \n    const result = await db.delete(vessels).where(eq(vessels.id, id));\n    return (result.rowCount || 0) > 0;\n  }\n\n  // Crew member operations\n  async getCrewMembers(): Promise<CrewMemberWithDetails[]> {\n    const crewList = await db.select().from(crewMembers);\n    \n    const detailedCrew = await Promise.all(crewList.map(async (member) => {\n      const user = member.userId ? await this.getUser(member.userId) : undefined;\n      const currentVessel = member.currentVesselId ? await this.getVessel(member.currentVesselId) : undefined;\n      const memberDocuments = await this.getDocumentsByCrewMember(member.id);\n      const activeContract = await this.getActiveContract(member.id);\n      \n      return {\n        ...member,\n        user,\n        currentVessel,\n        documents: memberDocuments,\n        activeContract,\n      };\n    }));\n\n    return detailedCrew;\n  }\n\n  async getCrewMember(id: string): Promise<CrewMemberWithDetails | undefined> {\n    const [member] = await db.select().from(crewMembers).where(eq(crewMembers.id, id));\n    if (!member) return undefined;\n\n    const user = member.userId ? await this.getUser(member.userId) : undefined;\n    const currentVessel = member.currentVesselId ? await this.getVessel(member.currentVesselId) : undefined;\n    const memberDocuments = await this.getDocumentsByCrewMember(member.id);\n    const activeContract = await this.getActiveContract(member.id);\n\n    return {\n      ...member,\n      user,\n      currentVessel,\n      documents: memberDocuments,\n      activeContract,\n    };\n  }\n\n  async getCrewMembersByVessel(vesselId: string): Promise<CrewMemberWithDetails[]> {\n    const vesselCrew = await db.select().from(crewMembers).where(eq(crewMembers.currentVesselId, vesselId));\n    \n    const detailedCrew = await Promise.all(vesselCrew.map(async (member) => {\n      const user = member.userId ? await this.getUser(member.userId) : undefined;\n      const currentVessel = await this.getVessel(vesselId);\n      const memberDocuments = await this.getDocumentsByCrewMember(member.id);\n      const activeContract = await this.getActiveContract(member.id);\n      \n      return {\n        ...member,\n        user,\n        currentVessel,\n        documents: memberDocuments,\n        activeContract,\n      };\n    }));\n\n    return detailedCrew;\n  }\n\n  async createCrewMember(crewMember: InsertCrewMember): Promise<CrewMember> {\n    const [newCrewMember] = await db\n      .insert(crewMembers)\n      .values(crewMember)\n      .returning();\n    return newCrewMember;\n  }\n\n  async updateCrewMember(id: string, crewMember: Partial<InsertCrewMember>): Promise<CrewMember | undefined> {\n    const [updated] = await db\n      .update(crewMembers)\n      .set(crewMember)\n      .where(eq(crewMembers.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteCrewMember(id: string): Promise<boolean> {\n    try {\n      // First delete related documents\n      await db.delete(documents).where(eq(documents.crewMemberId, id));\n      \n      // Delete related contracts\n      await db.delete(contracts).where(eq(contracts.crewMemberId, id));\n      \n      // Delete related crew rotations\n      await db.delete(crewRotations).where(eq(crewRotations.crewMemberId, id));\n      \n      // Finally delete the crew member\n      const result = await db.delete(crewMembers).where(eq(crewMembers.id, id));\n      \n      return true;\n    } catch (error) {\n      console.error('Error deleting crew member:', error);\n      return false;\n    }\n  }\n\n  // Contract operations\n  async getContracts(): Promise<Contract[]> {\n    return await db.select().from(contracts);\n  }\n\n  async getContractsByCrewMember(crewMemberId: string): Promise<Contract[]> {\n    return await db.select().from(contracts).where(eq(contracts.crewMemberId, crewMemberId));\n  }\n\n  async getActiveContract(crewMemberId: string): Promise<Contract | undefined> {\n    const [contract] = await db\n      .select()\n      .from(contracts)\n      .where(and(eq(contracts.crewMemberId, crewMemberId), eq(contracts.status, 'active')));\n    return contract || undefined;\n  }\n\n  async createContract(contract: InsertContract): Promise<Contract> {\n    const [newContract] = await db\n      .insert(contracts)\n      .values(contract)\n      .returning();\n    return newContract;\n  }\n\n  async updateContract(id: string, contract: Partial<InsertContract>): Promise<Contract | undefined> {\n    const [updated] = await db\n      .update(contracts)\n      .set(contract)\n      .where(eq(contracts.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  // Document operations\n  async getDocuments(): Promise<Document[]> {\n    return await db.select().from(documents);\n  }\n\n  async getDocumentsByCrewMember(crewMemberId: string): Promise<Document[]> {\n    return await db.select().from(documents).where(eq(documents.crewMemberId, crewMemberId));\n  }\n\n  async getExpiringDocuments(days: number): Promise<DocumentAlert[]> {\n    const now = new Date();\n    const futureDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));\n    \n    const expiringDocs = await db\n      .select()\n      .from(documents)\n      .where(and(\n        lte(documents.expiryDate, futureDate),\n        gte(documents.expiryDate, now)\n      ));\n\n    const alerts: DocumentAlert[] = [];\n    \n    for (const doc of expiringDocs) {\n      const member = await this.getCrewMember(doc.crewMemberId);\n      if (member) {\n        const daysUntilExpiry = Math.ceil((doc.expiryDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));\n        const severity = daysUntilExpiry <= 7 ? 'critical' : daysUntilExpiry <= 15 ? 'warning' : 'info';\n        \n        alerts.push({\n          document: doc,\n          crewMember: member,\n          daysUntilExpiry,\n          severity: severity as 'critical' | 'warning' | 'info',\n        });\n      }\n    }\n\n    return alerts;\n  }\n\n  async createDocument(document: InsertDocument): Promise<Document> {\n    const [newDocument] = await db\n      .insert(documents)\n      .values(document)\n      .returning();\n    return newDocument;\n  }\n\n  async updateDocument(id: string, document: Partial<InsertDocument>): Promise<Document | undefined> {\n    const [updated] = await db\n      .update(documents)\n      .set(document)\n      .where(eq(documents.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteDocument(id: string): Promise<boolean> {\n    const result = await db.delete(documents).where(eq(documents.id, id));\n    return (result.rowCount || 0) > 0;\n  }\n\n  // Crew rotation operations\n  async getCrewRotations(): Promise<CrewRotation[]> {\n    return await db.select().from(crewRotations);\n  }\n\n  async getCrewRotationsByVessel(vesselId: string): Promise<CrewRotation[]> {\n    return await db.select().from(crewRotations).where(eq(crewRotations.vesselId, vesselId));\n  }\n\n  async createCrewRotation(rotation: InsertCrewRotation): Promise<CrewRotation> {\n    const [newRotation] = await db\n      .insert(crewRotations)\n      .values(rotation)\n      .returning();\n    return newRotation;\n  }\n\n  async updateCrewRotation(id: string, rotation: Partial<InsertCrewRotation>): Promise<CrewRotation | undefined> {\n    const [updated] = await db\n      .update(crewRotations)\n      .set(rotation)\n      .where(eq(crewRotations.id, id))\n      .returning();\n    return updated || undefined;\n  }\n\n  async deleteCrewRotation(id: string): Promise<boolean> {\n    const result = await db.delete(crewRotations).where(eq(crewRotations.id, id));\n    return (result.rowCount || 0) > 0;\n  }\n\n  // Email settings operations\n  async getEmailSettings(): Promise<EmailSettings | undefined> {\n    const [settings] = await db.select().from(emailSettings).limit(1);\n    return settings || undefined;\n  }\n\n  async updateEmailSettings(settings: InsertEmailSettings): Promise<EmailSettings> {\n    const existing = await this.getEmailSettings();\n    \n    if (existing) {\n      const [updated] = await db\n        .update(emailSettings)\n        .set(settings)\n        .where(eq(emailSettings.id, existing.id))\n        .returning();\n      return updated;\n    } else {\n      const [created] = await db\n        .insert(emailSettings)\n        .values(settings)\n        .returning();\n      return created;\n    }\n  }\n\n  async getVesselContractStats(vesselId: string): Promise<{active: number, expiringSoon: number, expired: number}> {\n    const now = new Date();\n    const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);\n    \n    const vesselContracts = await db\n      .select()\n      .from(contracts)\n      .innerJoin(crewMembers, eq(contracts.crewMemberId, crewMembers.id))\n      .where(eq(crewMembers.currentVesselId, vesselId));\n    \n    const stats = {\n      active: 0,\n      expiringSoon: 0,\n      expired: 0\n    };\n    \n    for (const { contracts: contract } of vesselContracts) {\n      if (contract.status !== 'active') continue;\n      \n      if (contract.endDate < now) {\n        stats.expired++;\n      } else if (contract.endDate <= thirtyDaysFromNow) {\n        stats.expiringSoon++;\n      } else {\n        stats.active++;\n      }\n    }\n    \n    return stats;\n  }\n\n  async getVesselContracts(vesselId: string, status?: string): Promise<Array<Contract & {crewMember: CrewMember}>> {\n    const query = db\n      .select()\n      .from(contracts)\n      .innerJoin(crewMembers, eq(contracts.crewMemberId, crewMembers.id))\n      .where(eq(crewMembers.currentVesselId, vesselId));\n      \n    const results = await query;\n    \n    const contractsWithCrew = results.map(row => ({\n      ...row.contracts,\n      crewMember: row.crew_members\n    }));\n    \n    if (status) {\n      const now = new Date();\n      const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);\n      \n      return contractsWithCrew.filter(contract => {\n        if (status === 'active') {\n          return contract.status === 'active' && contract.endDate > thirtyDaysFromNow;\n        } else if (status === 'expiring') {\n          return contract.status === 'active' && contract.endDate <= thirtyDaysFromNow && contract.endDate >= now;\n        } else if (status === 'expired') {\n          return contract.endDate < now;\n        }\n        return contract.status === status;\n      });\n    }\n    \n    return contractsWithCrew;\n  }\n}\n\nexport class MemStorage implements IStorage {\n  private users: Map<string, User>;\n  private vessels: Map<string, Vessel>;\n  private crewMembers: Map<string, CrewMember>;\n  private contracts: Map<string, Contract>;\n  private documents: Map<string, Document>;\n  private crewRotations: Map<string, CrewRotation>;\n  private emailSettings: EmailSettings | undefined;\n\n  constructor() {\n    this.users = new Map();\n    this.vessels = new Map();\n    this.crewMembers = new Map();\n    this.contracts = new Map();\n    this.documents = new Map();\n    this.crewRotations = new Map();\n    this.initializeData();\n  }\n\n  private initializeData() {\n    // Create default admin user\n    const adminUser: User = {\n      id: randomUUID(),\n      username: \"admin\",\n      password: \"admin123\", // In real app, this would be hashed\n      role: \"admin\",\n      email: \"admin@crewtrack.com\",\n      name: \"John Smith\",\n      createdAt: new Date(),\n    };\n    this.users.set(adminUser.id, adminUser);\n\n    // Create office staff user\n    const officeStaffUser: User = {\n      id: randomUUID(),\n      username: \"office\",\n      password: \"office123\",\n      role: \"office_staff\",\n      email: \"office@crewtrack.com\",\n      name: \"Sarah Wilson\",\n      createdAt: new Date(),\n    };\n    this.users.set(officeStaffUser.id, officeStaffUser);\n\n    // Create sample vessels\n    const vessel1: Vessel = {\n      id: randomUUID(),\n      name: \"MV Ocean Pioneer\",\n      type: \"Container Ship\",\n      imoNumber: \"1234567\",\n      flag: \"Panama\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n    const vessel2: Vessel = {\n      id: randomUUID(),\n      name: \"MV Maritime Explorer\",\n      type: \"Bulk Carrier\",\n      imoNumber: \"2345678\",\n      flag: \"Liberia\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n    const vessel3: Vessel = {\n      id: randomUUID(),\n      name: \"MV Deep Blue\",\n      type: \"Tanker\",\n      imoNumber: \"3456789\",\n      flag: \"Singapore\",\n      status: \"maintenance\",\n      createdAt: new Date(),\n    };\n\n    const vessel4: Vessel = {\n      id: randomUUID(),\n      name: \"MV Nordic Explorer\",\n      type: \"Ro-Ro Ferry\",\n      imoNumber: \"4567890\",\n      flag: \"Norway\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const vessel5: Vessel = {\n      id: randomUUID(),\n      name: \"MV Pacific Voyager\",\n      type: \"Container Ship\",\n      imoNumber: \"5678901\",\n      flag: \"Marshall Islands\",\n      status: \"in-port\",\n      createdAt: new Date(),\n    };\n\n    const vessel6: Vessel = {\n      id: randomUUID(),\n      name: \"MV Arctic Breeze\",\n      type: \"Oil Tanker\",\n      imoNumber: \"6789012\",\n      flag: \"Denmark\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const vessel7: Vessel = {\n      id: randomUUID(),\n      name: \"Sagar\",\n      type: \"Container Ship\",\n      imoNumber: \"IMO1234567\",\n      flag: \"India\",\n      status: \"active\",\n      createdAt: new Date(\"2025-08-13\"),\n    };\n    \n    this.vessels.set(vessel1.id, vessel1);\n    this.vessels.set(vessel2.id, vessel2);\n    this.vessels.set(vessel3.id, vessel3);\n    this.vessels.set(vessel4.id, vessel4);\n    this.vessels.set(vessel5.id, vessel5);\n    this.vessels.set(vessel6.id, vessel6);\n    this.vessels.set(vessel7.id, vessel7);\n\n\n\n    // Create sample crew members\n    const crewMember1: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Robert\",\n      lastName: \"Johnson\",\n      nationality: \"United Kingdom\",\n      dateOfBirth: new Date(\"1975-03-15\"),\n      rank: \"Captain\",\n      phoneNumber: \"+44-123-456-7890\",\n      emergencyContact: {\n        name: \"Sarah Johnson\",\n        relationship: \"Wife\",\n        phone: \"+44-123-456-7891\",\n        email: \"sarah.j@email.com\"\n      },\n      currentVesselId: vessel3.id,\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const crewMember2: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Michael\",\n      lastName: \"Santos\",\n      nationality: \"Philippines\",\n      dateOfBirth: new Date(\"1985-07-22\"),\n      rank: \"Chief Engineer\",\n      phoneNumber: \"+63-123-456-7890\",\n      emergencyContact: {\n        name: \"Maria Santos\",\n        relationship: \"Wife\",\n        phone: \"+63-123-456-7891\",\n        email: \"maria.s@email.com\"\n      },\n      currentVesselId: vessel1.id,\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const crewMember3: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Anna\",\n      lastName: \"Kowalski\",\n      nationality: \"Poland\",\n      dateOfBirth: new Date(\"1990-11-08\"),\n      rank: \"2nd Officer\",\n      phoneNumber: \"+48-123-456-7890\",\n      emergencyContact: {\n        name: \"Jan Kowalski\",\n        relationship: \"Father\",\n        phone: \"+48-123-456-7891\",\n        email: \"jan.k@email.com\"\n      },\n      currentVesselId: vessel2.id,\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    // Add more crew members for other vessels\n    const crewMember4: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Carlos\",\n      lastName: \"Rodriguez\",\n      nationality: \"Spain\",\n      dateOfBirth: new Date(\"1988-03-15\"),\n      rank: \"Chief Cook\",\n      phoneNumber: \"+34-123-456-7890\",\n      emergencyContact: {\n        name: \"Maria Rodriguez\",\n        relationship: \"Wife\",\n        phone: \"+34-123-456-7891\",\n        email: \"maria.r@email.com\"\n      },\n      currentVesselId: vessel4.id,\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const crewMember5: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Erik\",\n      lastName: \"Larsen\",\n      nationality: \"Norway\",\n      dateOfBirth: new Date(\"1982-09-22\"),\n      rank: \"Bosun\",\n      phoneNumber: \"+47-123-456-7890\",\n      emergencyContact: {\n        name: \"Ingrid Larsen\",\n        relationship: \"Wife\",\n        phone: \"+47-123-456-7891\",\n        email: \"ingrid.l@email.com\"\n      },\n      currentVesselId: vessel5.id,\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    // Add unassigned crew members for testing assignment functionality\n    const crewMember6: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"David\",\n      lastName: \"Chen\",\n      nationality: \"Singapore\",\n      dateOfBirth: new Date(\"1987-06-12\"),\n      rank: \"3rd Officer\",\n      phoneNumber: \"+65-123-456-7890\",\n      emergencyContact: {\n        name: \"Lisa Chen\",\n        relationship: \"Wife\",\n        phone: \"+65-123-456-7891\",\n        email: \"lisa.c@email.com\"\n      },\n      currentVesselId: null, // Unassigned\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const crewMember7: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Marco\",\n      lastName: \"Rossi\",\n      nationality: \"Italy\",\n      dateOfBirth: new Date(\"1984-02-28\"),\n      rank: \"Electrician\",\n      phoneNumber: \"+39-123-456-7890\",\n      emergencyContact: {\n        name: \"Sofia Rossi\",\n        relationship: \"Wife\",\n        phone: \"+39-123-456-7891\",\n        email: \"sofia.r@email.com\"\n      },\n      currentVesselId: null, // Unassigned\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const crewMember8: CrewMember = {\n      id: randomUUID(),\n      userId: null,\n      firstName: \"Ahmed\",\n      lastName: \"Hassan\",\n      nationality: \"Egypt\",\n      dateOfBirth: new Date(\"1991-10-15\"),\n      rank: \"Able Seaman\",\n      phoneNumber: \"+20-123-456-7890\",\n      emergencyContact: {\n        name: \"Fatima Hassan\",\n        relationship: \"Mother\",\n        phone: \"+20-123-456-7891\",\n        email: \"fatima.h@email.com\"\n      },\n      currentVesselId: null, // Unassigned\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    this.crewMembers.set(crewMember1.id, crewMember1);\n    this.crewMembers.set(crewMember2.id, crewMember2);\n    this.crewMembers.set(crewMember3.id, crewMember3);\n    this.crewMembers.set(crewMember4.id, crewMember4);\n    this.crewMembers.set(crewMember5.id, crewMember5);\n    this.crewMembers.set(crewMember6.id, crewMember6);\n    this.crewMembers.set(crewMember7.id, crewMember7);\n    this.crewMembers.set(crewMember8.id, crewMember8);\n\n    // Create sample contracts\n    const contract1: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember1.id,\n      vesselId: vessel3.id,\n      startDate: new Date(\"2024-01-01\"),\n      endDate: new Date(\"2024-07-01\"),\n      durationDays: 182, // 6 months\n      salary: 8000,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract2: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember2.id,\n      vesselId: vessel1.id,\n      startDate: new Date(\"2023-11-01\"),\n      endDate: new Date(\"2024-05-01\"),\n      durationDays: 182, // 6 months\n      salary: 6500,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract3: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember3.id,\n      vesselId: vessel2.id,\n      startDate: new Date(\"2024-02-15\"),\n      endDate: new Date(\"2024-08-15\"),\n      durationDays: 182, // 6 months\n      salary: 5500,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    // Add contracts for additional crew members\n    const contract4: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember4.id,\n      vesselId: vessel4.id,\n      startDate: new Date(\"2024-03-01\"),\n      endDate: new Date(\"2025-03-01\"),\n      durationDays: 365, // 1 year\n      salary: 4500,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract5: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember5.id,\n      vesselId: vessel5.id,\n      startDate: new Date(\"2024-01-15\"),\n      endDate: new Date(\"2025-01-15\"),\n      durationDays: 365, // 1 year\n      salary: 5000,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    // Add more contracts with varied expiry dates for demonstration\n    const contract6: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember1.id,\n      vesselId: vessel1.id,\n      startDate: new Date(\"2024-06-01\"),\n      endDate: new Date(\"2025-08-25\"), // Expiring in ~12 days\n      durationDays: 450, // ~15 months\n      salary: 6500,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract7: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember2.id,\n      vesselId: vessel2.id,\n      startDate: new Date(\"2024-09-01\"),\n      endDate: new Date(\"2025-08-18\"), // Expiring in ~4 days\n      durationDays: 351, // ~11.5 months  \n      salary: 5800,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    const contract8: Contract = {\n      id: randomUUID(),\n      crewMemberId: crewMember3.id,\n      vesselId: vessel2.id,\n      startDate: new Date(\"2024-08-01\"),\n      endDate: new Date(\"2025-08-20\"), // Expiring within 30 days\n      durationDays: 354, // ~11.5 months\n      salary: 5200,\n      currency: \"USD\",\n      status: \"active\",\n      createdAt: new Date(),\n    };\n\n    this.contracts.set(contract1.id, contract1);\n    this.contracts.set(contract2.id, contract2);\n    this.contracts.set(contract3.id, contract3);\n    this.contracts.set(contract4.id, contract4);\n    this.contracts.set(contract5.id, contract5);\n    this.contracts.set(contract6.id, contract6);\n    this.contracts.set(contract7.id, contract7);\n    this.contracts.set(contract8.id, contract8);\n\n    // Create sample documents with some expiring soon\n    const documents = [\n      {\n        id: randomUUID(),\n        crewMemberId: crewMember3.id,\n        type: \"stcw\",\n        documentNumber: \"STCW-2024-001\",\n        issueDate: new Date(\"2022-01-15\"),\n        expiryDate: new Date(\"2025-01-22\"), // Expiring in 7 days from Aug 12, 2025\n        issuingAuthority: \"Polish Maritime Authority\",\n        status: \"expiring\",\n        filePath: null,\n        createdAt: new Date(),\n      },\n      {\n        id: randomUUID(),\n        crewMemberId: crewMember2.id,\n        type: \"medical\",\n        documentNumber: \"MED-2024-002\",\n        issueDate: new Date(\"2023-08-01\"),\n        expiryDate: new Date(\"2025-08-27\"), // Expiring in 15 days\n        issuingAuthority: \"Philippine Health Authority\",\n        status: \"expiring\",\n        filePath: null,\n        createdAt: new Date(),\n      },\n      {\n        id: randomUUID(),\n        crewMemberId: crewMember1.id,\n        type: \"passport\",\n        documentNumber: \"UK123456789\",\n        issueDate: new Date(\"2020-06-01\"),\n        expiryDate: new Date(\"2025-09-12\"), // Expiring in 31 days\n        issuingAuthority: \"UK Passport Office\",\n        status: \"valid\",\n        filePath: null,\n        createdAt: new Date(),\n      }\n    ];\n\n    documents.forEach(doc => this.documents.set(doc.id, doc));\n\n    // Create sample crew rotations with upcoming events\n    const rotation1: CrewRotation = {\n      id: randomUUID(),\n      crewMemberId: crewMember6.id, // David Chen - unassigned\n      vesselId: vessel1.id, // MV Ocean Pioneer\n      joinDate: new Date(\"2025-08-20\"), // 6 days from now\n      leaveDate: new Date(\"2025-12-20\"),\n      rotationType: \"rotation\",\n      status: \"scheduled\",\n      notes: \"David Chen scheduled to join as 3rd Officer\",\n      createdAt: new Date(),\n    };\n\n    const rotation2: CrewRotation = {\n      id: randomUUID(),\n      crewMemberId: crewMember1.id, // James Anderson\n      vesselId: vessel3.id, // Current vessel - Deep Blue\n      joinDate: new Date(\"2024-06-01\"), // Already joined\n      leaveDate: new Date(\"2025-08-22\"), // 8 days from now\n      rotationType: \"leave\",\n      status: \"scheduled\",\n      notes: \"End of contract rotation\",\n      createdAt: new Date(),\n    };\n\n    const rotation3: CrewRotation = {\n      id: randomUUID(),\n      crewMemberId: crewMember7.id, // Marco Rossi - unassigned\n      vesselId: vessel4.id, // MV Nordic Explorer\n      joinDate: new Date(\"2025-09-05\"), // 22 days from now\n      leaveDate: null,\n      rotationType: \"join\",\n      status: \"scheduled\",\n      notes: \"Marco Rossi joining as Electrician\",\n      createdAt: new Date(),\n    };\n\n    const rotation4: CrewRotation = {\n      id: randomUUID(),\n      crewMemberId: crewMember2.id, // Miguel Santos\n      vesselId: vessel1.id, // Current vessel\n      joinDate: new Date(\"2024-01-01\"), // Already joined\n      leaveDate: new Date(\"2025-08-17\"), // 3 days from now - urgent!\n      rotationType: \"leave\",\n      status: \"scheduled\",\n      notes: \"Contract completion - urgent replacement needed\",\n      createdAt: new Date(),\n    };\n\n    this.crewRotations.set(rotation1.id, rotation1);\n    this.crewRotations.set(rotation2.id, rotation2);\n    this.crewRotations.set(rotation3.id, rotation3);\n    this.crewRotations.set(rotation4.id, rotation4);\n\n    // Initialize email settings\n    this.emailSettings = {\n      id: randomUUID(),\n      reminderDays: [30, 15, 7],\n      enabled: true,\n      recipients: ['office_staff', 'admin'],\n      emailTemplate: \"Dear [Crew Member],\\n\\nYour [Document Type] is scheduled to expire on [Expiry Date]. Please contact your Fleet Administrator to discuss renewal arrangements.\\n\\nBest regards,\\nCrewTrack Pro Team\",\n      updatedAt: new Date(),\n    } as EmailSettings;\n  }\n\n  // User operations\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(user => user.username === username);\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const id = randomUUID();\n    const user: User = { ...insertUser, id, createdAt: new Date() };\n    this.users.set(id, user);\n    return user;\n  }\n\n  // Vessel operations\n  async getVessels(): Promise<Vessel[]> {\n    return Array.from(this.vessels.values());\n  }\n\n  async getVessel(id: string): Promise<Vessel | undefined> {\n    return this.vessels.get(id);\n  }\n\n  async createVessel(insertVessel: InsertVessel): Promise<Vessel> {\n    const id = randomUUID();\n    const vessel: Vessel = { \n      ...insertVessel,\n      id, \n      createdAt: new Date(),\n      imoNumber: insertVessel.imoNumber || null,\n      status: insertVessel.status || 'active'\n    };\n    this.vessels.set(id, vessel);\n    return vessel;\n  }\n\n  async updateVessel(id: string, updates: Partial<InsertVessel>): Promise<Vessel | undefined> {\n    const vessel = this.vessels.get(id);\n    if (!vessel) return undefined;\n    \n    const updated = { ...vessel, ...updates };\n    this.vessels.set(id, updated);\n    return updated;\n  }\n\n  async deleteVessel(id: string): Promise<boolean> {\n    // First, unassign any crew members from this vessel\n    const crewMembers = Array.from(this.crewMembers.values());\n    for (const member of crewMembers) {\n      if (member.currentVesselId === id) {\n        member.currentVesselId = null;\n      }\n    }\n    \n    return this.vessels.delete(id);\n  }\n\n  // Crew member methods\n  async createCrewMember(data: InsertCrewMember): Promise<CrewMember> {\n    const id = crypto.randomUUID();\n    const crewMember: CrewMember = {\n      id,\n      userId: data.userId || null,\n      firstName: data.firstName,\n      lastName: data.lastName,\n      nationality: data.nationality,\n      dateOfBirth: data.dateOfBirth,\n      rank: data.rank,\n      phoneNumber: data.phoneNumber || null,\n      emergencyContact: data.emergencyContact || null,\n      currentVesselId: data.currentVesselId || null,\n      status: data.status || 'active',\n      createdAt: new Date(),\n    };\n    \n    this.crewMembers.set(id, crewMember);\n    return crewMember;\n  }\n\n  // Crew member operations\n  async getCrewMembers(): Promise<CrewMemberWithDetails[]> {\n    const crewMembers = Array.from(this.crewMembers.values());\n    return Promise.all(crewMembers.map(async (member) => {\n      const user = await this.getUser(member.userId || '');\n      const currentVessel = member.currentVesselId ? await this.getVessel(member.currentVesselId) : undefined;\n      const documents = await this.getDocumentsByCrewMember(member.id);\n      const activeContract = await this.getActiveContract(member.id);\n      \n      return {\n        ...member,\n        user,\n        currentVessel,\n        documents,\n        activeContract,\n      };\n    }));\n  }\n\n  async getCrewMember(id: string): Promise<CrewMemberWithDetails | undefined> {\n    const member = this.crewMembers.get(id);\n    if (!member) return undefined;\n\n    const user = member.userId ? await this.getUser(member.userId) : undefined;\n    const currentVessel = member.currentVesselId ? await this.getVessel(member.currentVesselId) : undefined;\n    const documents = await this.getDocumentsByCrewMember(member.id);\n    const activeContract = await this.getActiveContract(member.id);\n\n    return {\n      ...member,\n      user,\n      currentVessel,\n      documents,\n      activeContract,\n    };\n  }\n\n  async getCrewMembersByVessel(vesselId: string): Promise<CrewMemberWithDetails[]> {\n    const allCrew = await this.getCrewMembers();\n    return allCrew.filter(member => member.currentVesselId === vesselId);\n  }\n\n\n\n  async updateCrewMember(id: string, updates: Partial<InsertCrewMember>): Promise<CrewMember | undefined> {\n    const member = this.crewMembers.get(id);\n    if (!member) return undefined;\n    \n    const updated = { ...member, ...updates };\n    this.crewMembers.set(id, updated);\n    return updated;\n  }\n\n  async deleteCrewMember(id: string): Promise<boolean> {\n    return this.crewMembers.delete(id);\n  }\n\n  // Contract operations\n  async getContracts(): Promise<Contract[]> {\n    return Array.from(this.contracts.values());\n  }\n\n  async getContractsByCrewMember(crewMemberId: string): Promise<Contract[]> {\n    return Array.from(this.contracts.values()).filter(contract => contract.crewMemberId === crewMemberId);\n  }\n\n  async getActiveContract(crewMemberId: string): Promise<Contract | undefined> {\n    return Array.from(this.contracts.values()).find(\n      contract => contract.crewMemberId === crewMemberId && contract.status === 'active'\n    );\n  }\n\n  async createContract(insertContract: InsertContract): Promise<Contract> {\n    const id = randomUUID();\n    const contract: Contract = { \n      ...insertContract, \n      id, \n      createdAt: new Date(),\n      status: insertContract.status || 'active',\n      salary: insertContract.salary || null,\n      currency: insertContract.currency || 'USD',\n      durationDays: insertContract.durationDays || null\n    };\n    this.contracts.set(id, contract);\n    return contract;\n  }\n\n  async updateContract(id: string, updates: Partial<InsertContract>): Promise<Contract | undefined> {\n    const contract = this.contracts.get(id);\n    if (!contract) return undefined;\n    \n    const updated = { ...contract, ...updates };\n    this.contracts.set(id, updated);\n    return updated;\n  }\n\n  // Document operations\n  async getDocuments(): Promise<Document[]> {\n    return Array.from(this.documents.values());\n  }\n\n  async getDocumentsByCrewMember(crewMemberId: string): Promise<Document[]> {\n    return Array.from(this.documents.values()).filter(doc => doc.crewMemberId === crewMemberId);\n  }\n\n  async getExpiringDocuments(days: number): Promise<DocumentAlert[]> {\n    const now = new Date();\n    const futureDate = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));\n    \n    const expiringDocs = Array.from(this.documents.values()).filter(doc => {\n      return doc.expiryDate <= futureDate && doc.expiryDate > now;\n    });\n\n    const alerts: DocumentAlert[] = [];\n    \n    for (const doc of expiringDocs) {\n      const member = this.crewMembers.get(doc.crewMemberId);\n      if (member) {\n        const daysUntilExpiry = Math.ceil((doc.expiryDate.getTime() - now.getTime()) / (24 * 60 * 60 * 1000));\n        const severity = daysUntilExpiry <= 7 ? 'critical' : daysUntilExpiry <= 15 ? 'warning' : 'info';\n        \n        alerts.push({\n          document: doc,\n          crewMember: member,\n          daysUntilExpiry,\n          severity,\n        });\n      }\n    }\n\n    return alerts.sort((a, b) => a.daysUntilExpiry - b.daysUntilExpiry);\n  }\n\n  async createDocument(insertDocument: InsertDocument): Promise<Document> {\n    const id = randomUUID();\n    const document: Document = { \n      ...insertDocument, \n      id, \n      createdAt: new Date(),\n      status: insertDocument.status || 'valid',\n      filePath: insertDocument.filePath || null\n    };\n    this.documents.set(id, document);\n    return document;\n  }\n\n  async updateDocument(id: string, updates: Partial<InsertDocument>): Promise<Document | undefined> {\n    const document = this.documents.get(id);\n    if (!document) return undefined;\n    \n    const updated = { ...document, ...updates };\n    this.documents.set(id, updated);\n    return updated;\n  }\n\n  async deleteDocument(id: string): Promise<boolean> {\n    return this.documents.delete(id);\n  }\n\n  // Crew rotation operations\n  async getCrewRotations(): Promise<CrewRotation[]> {\n    return Array.from(this.crewRotations.values());\n  }\n\n  async getCrewRotationsByVessel(vesselId: string): Promise<CrewRotation[]> {\n    return Array.from(this.crewRotations.values()).filter(rotation => rotation.vesselId === vesselId);\n  }\n\n  async createCrewRotation(insertRotation: InsertCrewRotation): Promise<CrewRotation> {\n    const id = randomUUID();\n    const rotation: CrewRotation = { \n      ...insertRotation, \n      id, \n      createdAt: new Date(),\n      status: insertRotation.status || 'scheduled',\n      leaveDate: insertRotation.leaveDate || null,\n      notes: insertRotation.notes || null\n    };\n    this.crewRotations.set(id, rotation);\n    return rotation;\n  }\n\n  async updateCrewRotation(id: string, updates: Partial<InsertCrewRotation>): Promise<CrewRotation | undefined> {\n    const rotation = this.crewRotations.get(id);\n    if (!rotation) return undefined;\n    \n    const updated = { ...rotation, ...updates };\n    this.crewRotations.set(id, updated);\n    return updated;\n  }\n\n  async deleteCrewRotation(id: string): Promise<boolean> {\n    return this.crewRotations.delete(id);\n  }\n\n  async getVesselContractStats(vesselId: string): Promise<{active: number, expiringSoon: number, expired: number}> {\n    const now = new Date();\n    const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);\n    \n    const stats = { active: 0, expiringSoon: 0, expired: 0 };\n    \n    for (const contract of Array.from(this.contracts.values())) {\n      const crewMember = this.crewMembers.get(contract.crewMemberId);\n      if (!crewMember || crewMember.currentVesselId !== vesselId || contract.status !== 'active') {\n        continue;\n      }\n      \n      if (contract.endDate < now) {\n        stats.expired++;\n      } else if (contract.endDate <= thirtyDaysFromNow) {\n        stats.expiringSoon++;\n      } else {\n        stats.active++;\n      }\n    }\n    \n    return stats;\n  }\n\n  async getVesselContracts(vesselId: string, status?: string): Promise<Array<Contract & {crewMember: CrewMember}>> {\n    const vesselContracts: Array<Contract & {crewMember: CrewMember}> = [];\n    \n    for (const contract of Array.from(this.contracts.values())) {\n      const crewMember = this.crewMembers.get(contract.crewMemberId);\n      if (!crewMember || crewMember.currentVesselId !== vesselId) {\n        continue;\n      }\n      \n      vesselContracts.push({\n        ...contract,\n        crewMember\n      });\n    }\n    \n    if (status) {\n      const now = new Date();\n      const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);\n      \n      return vesselContracts.filter(contract => {\n        if (status === 'active') {\n          return contract.status === 'active' && contract.endDate > thirtyDaysFromNow;\n        } else if (status === 'expiring') {\n          return contract.status === 'active' && contract.endDate <= thirtyDaysFromNow && contract.endDate >= now;\n        } else if (status === 'expired') {\n          return contract.endDate < now;\n        }\n        return contract.status === status;\n      });\n    }\n    \n    return vesselContracts;\n  }\n\n  // Email settings operations\n  async getEmailSettings(): Promise<EmailSettings | undefined> {\n    return this.emailSettings;\n  }\n\n  async updateEmailSettings(settings: InsertEmailSettings): Promise<EmailSettings> {\n    const updated: EmailSettings = {\n      id: this.emailSettings?.id || randomUUID(),\n      reminderDays: settings.reminderDays || [30, 15, 7],\n      enabled: settings.enabled || true,\n      recipients: settings.recipients || ['office_staff', 'admin'],\n      emailTemplate: settings.emailTemplate || null,\n      updatedAt: new Date(),\n    };\n    this.emailSettings = updated;\n    return updated;\n  }\n\n  // Activity log operations\n  async logActivity(activity: InsertActivityLog): Promise<ActivityLog> {\n    const [log] = await db\n      .insert(activityLogs)\n      .values(activity)\n      .returning();\n    return log;\n  }\n\n  async getActivityLogs(): Promise<ActivityLog[]> {\n    return await db\n      .select()\n      .from(activityLogs)\n      .orderBy(sql`${activityLogs.createdAt} DESC`);\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(users);\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":42496,"size_tokens":null},"client/src/pages/reports.tsx":{"content":"import { useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Badge } from '@/components/ui/badge';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Progress } from '@/components/ui/progress';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { \n  BarChart3, \n  Download, \n  Calendar, \n  Users, \n  Ship, \n  FileText, \n  AlertTriangle,\n  TrendingUp,\n  TrendingDown,\n  Activity\n} from 'lucide-react';\nimport { format, subDays, startOfMonth, endOfMonth } from 'date-fns';\nimport { formatDate } from '@/lib/utils';\n\ninterface VesselData {\n  name: string;\n  assigned: number;\n  capacity: number;\n  utilization: number;\n  status: string;\n}\n\nexport default function Reports() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [dateRange, setDateRange] = useState('30');\n  const [reportType, setReportType] = useState('overview');\n\n  const { data: dashboardStats, isLoading: statsLoading } = useQuery({\n    queryKey: ['/api/dashboard/stats'],\n    queryFn: async () => {\n      const response = await fetch('/api/dashboard/stats', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch stats');\n      return response.json();\n    },\n  });\n\n  const { data: expiringDocuments, isLoading: documentsLoading } = useQuery({\n    queryKey: ['/api/alerts/expiring-documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/alerts/expiring-documents?days=90', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch expiring documents');\n      return response.json();\n    },\n  });\n\n  const { data: crewMembers, isLoading: crewLoading } = useQuery({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n  });\n\n  const { data: vessels, isLoading: vesselsLoading } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  const { data: contracts, isLoading: contractsLoading } = useQuery({\n    queryKey: ['/api/contracts'],\n    queryFn: async () => {\n      const response = await fetch('/api/contracts', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch contracts');\n      return response.json();\n    },\n  });\n\n  if (user?.role !== 'admin') {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"text-center py-12\">\n          <AlertTriangle className=\"h-16 w-16 mx-auto text-gray-300 dark:text-gray-600 mb-4\" />\n          <h2 className=\"text-2xl font-semibold text-foreground mb-2\">Access Restricted</h2>\n          <p className=\"text-muted-foreground\">\n            Reports are only available to administrators.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  const isLoading = statsLoading || documentsLoading || crewLoading || vesselsLoading || contractsLoading;\n\n  const generateComplianceReport = () => {\n    if (!expiringDocuments || !crewMembers) return [];\n\n    const criticalAlerts = expiringDocuments.filter((alert: any) => alert.severity === 'critical');\n    const warningAlerts = expiringDocuments.filter((alert: any) => alert.severity === 'warning');\n    const infoAlerts = expiringDocuments.filter((alert: any) => alert.severity === 'info');\n\n    return [\n      { level: 'Critical', count: criticalAlerts.length, color: 'bg-red-500' },\n      { level: 'Warning', count: warningAlerts.length, color: 'bg-yellow-500' },\n      { level: 'Info', count: infoAlerts.length, color: 'bg-blue-500' },\n    ];\n  };\n\n  const generateCrewReport = () => {\n    if (!crewMembers) return [];\n\n    const statusCounts = crewMembers.reduce((acc: any, member: any) => {\n      acc[member.status] = (acc[member.status] || 0) + 1;\n      return acc;\n    }, {});\n\n    return Object.entries(statusCounts).map(([status, count]) => ({\n      status: status.charAt(0).toUpperCase() + status.slice(1),\n      count,\n      percentage: Math.round((count as number / crewMembers.length) * 100),\n    }));\n  };\n\n  const generateVesselUtilization = (): VesselData[] => {\n    if (!vessels || !crewMembers) return [];\n\n    return vessels.map((vessel: any) => {\n      const assignedCrew = crewMembers.filter((member: any) => member.currentVesselId === vessel.id);\n      const capacity = vessel.crewCapacity || 20; // Default capacity\n      const utilization = Math.round((assignedCrew.length / capacity) * 100);\n\n      return {\n        name: vessel.name,\n        assigned: assignedCrew.length,\n        capacity,\n        utilization,\n        status: vessel.status,\n      };\n    });\n  };\n\n  const exportToCSV = () => {\n    try {\n      let csvContent = '';\n      let filename = '';\n\n      switch (reportType) {\n        case 'overview':\n          csvContent = generateOverviewCSV();\n          filename = 'overview-report.csv';\n          break;\n        case 'compliance':\n          csvContent = generateComplianceCSV();\n          filename = 'compliance-report.csv';\n          break;\n        case 'crew':\n          csvContent = generateCrewCSV();\n          filename = 'crew-analysis-report.csv';\n          break;\n        case 'vessels':\n          csvContent = generateVesselCSV();\n          filename = 'vessel-utilization-report.csv';\n          break;\n        default:\n          csvContent = generateOverviewCSV();\n          filename = 'report.csv';\n      }\n\n      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      if (link.download !== undefined) {\n        const url = URL.createObjectURL(blob);\n        link.setAttribute('href', url);\n        link.setAttribute('download', filename);\n        link.style.visibility = 'hidden';\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n      }\n\n      toast({\n        title: 'Export Successful',\n        description: `${filename} has been downloaded`,\n      });\n    } catch (error) {\n      toast({\n        title: 'Export Failed',\n        description: 'Unable to export report. Please try again.',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  const generateOverviewCSV = () => {\n    const headers = ['Metric', 'Value', 'Trend'];\n    const rows = [\n      ['Active Crew', dashboardStats?.activeCrew || 0, '+5% vs last month'],\n      ['Active Vessels', dashboardStats?.activeVessels || 0, 'Steady'],\n      ['Pending Actions', dashboardStats?.pendingActions || 0, '-12% vs last week'],\n      ['Compliance Rate', `${dashboardStats?.complianceRate || 0}%`, 'Good'],\n    ];\n\n    return [headers, ...rows].map(row => row.join(',')).join('\\n');\n  };\n\n  const generateComplianceCSV = () => {\n    if (!expiringDocuments) return 'No compliance data available';\n\n    const headers = ['Crew Member', 'Document Type', 'Document Number', 'Expiry Date', 'Days Remaining', 'Severity'];\n    const rows = expiringDocuments.map((alert: any) => [\n      `${alert.crewMember.firstName} ${alert.crewMember.lastName}`,\n      alert.document.type.toUpperCase(),\n      alert.document.documentNumber,\n      format(new Date(alert.document.expiryDate), 'yyyy-MM-dd'),\n      alert.daysUntilExpiry,\n      alert.severity.toUpperCase(),\n    ]);\n\n    return [headers, ...rows].map(row => row.join(',')).join('\\n');\n  };\n\n  const generateCrewCSV = () => {\n    if (!crewMembers) return 'No crew data available';\n\n    const headers = ['Name', 'Rank', 'Status', 'Nationality', 'Current Vessel'];\n    const rows = crewMembers.map((member: any) => [\n      `${member.firstName} ${member.lastName}`,\n      member.rank,\n      member.status,\n      member.nationality,\n      vessels?.find((v: any) => v.id === member.currentVesselId)?.name || 'Unassigned',\n    ]);\n\n    return [headers, ...rows].map(row => row.join(',')).join('\\n');\n  };\n\n  const generateVesselCSV = () => {\n    const headers = ['Vessel Name', 'Crew Assigned', 'Capacity', 'Utilization %', 'Status'];\n    const rows = vesselData.map((vessel: VesselData) => [\n      vessel.name,\n      vessel.assigned,\n      vessel.capacity,\n      vessel.utilization,\n      vessel.status,\n    ]);\n\n    return [headers, ...rows].map(row => row.join(',')).join('\\n');\n  };\n\n  const complianceData = generateComplianceReport();\n  const crewData = generateCrewReport();\n  const vesselData = generateVesselUtilization();\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-2\"></div>\n          <div className=\"h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2\"></div>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          {Array(4).fill(0).map((_, i) => (\n            <div key={i} className=\"h-24 bg-gray-200 dark:bg-gray-700 rounded animate-pulse\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold text-foreground mb-2\" data-testid=\"reports-title\">\n            Reports & Analytics\n          </h2>\n          <p className=\"text-muted-foreground\">\n            Comprehensive insights into fleet operations and crew management\n          </p>\n        </div>\n        \n        <div className=\"flex items-center space-x-4\">\n          <Select value={reportType} onValueChange={setReportType}>\n            <SelectTrigger className=\"w-48\" data-testid=\"report-type-select\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"overview\">Overview</SelectItem>\n              <SelectItem value=\"compliance\">Compliance</SelectItem>\n              <SelectItem value=\"crew\">Crew Analysis</SelectItem>\n              <SelectItem value=\"vessels\">Vessel Utilization</SelectItem>\n            </SelectContent>\n          </Select>\n          \n          <Select value={dateRange} onValueChange={setDateRange}>\n            <SelectTrigger className=\"w-32\" data-testid=\"date-range-select\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"7\">7 Days</SelectItem>\n              <SelectItem value=\"30\">30 Days</SelectItem>\n              <SelectItem value=\"90\">90 Days</SelectItem>\n              <SelectItem value=\"365\">1 Year</SelectItem>\n            </SelectContent>\n          </Select>\n          \n          <Button \n            className=\"bg-primary hover:bg-primary/90\" \n            onClick={exportToCSV}\n            disabled={isLoading}\n            data-testid=\"export-report-button\"\n          >\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export CSV\n          </Button>\n        </div>\n      </div>\n\n      {/* Overview Stats */}\n      {reportType === 'overview' && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground flex items-center\">\n                  <Users className=\"h-4 w-4 mr-2\" />\n                  Active Crew\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-foreground\" data-testid=\"active-crew-stat\">\n                  {dashboardStats?.activeCrew || 0}\n                </div>\n                <div className=\"flex items-center mt-2\">\n                  <TrendingUp className=\"h-4 w-4 text-green-500 mr-1\" />\n                  <span className=\"text-sm text-green-600\">+5% vs last month</span>\n                </div>\n              </CardContent>\n            </Card>\n            \n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground flex items-center\">\n                  <Ship className=\"h-4 w-4 mr-2\" />\n                  Active Vessels\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-foreground\" data-testid=\"active-vessels-stat\">\n                  {dashboardStats?.activeVessels || 0}\n                </div>\n                <div className=\"flex items-center mt-2\">\n                  <Activity className=\"h-4 w-4 text-blue-500 mr-1\" />\n                  <span className=\"text-sm text-muted-foreground\">Steady</span>\n                </div>\n              </CardContent>\n            </Card>\n            \n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground flex items-center\">\n                  <AlertTriangle className=\"h-4 w-4 mr-2\" />\n                  Pending Actions\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-foreground\" data-testid=\"pending-actions-stat\">\n                  {dashboardStats?.pendingActions || 0}\n                </div>\n                <div className=\"flex items-center mt-2\">\n                  <TrendingDown className=\"h-4 w-4 text-green-500 mr-1\" />\n                  <span className=\"text-sm text-green-600\">-12% vs last week</span>\n                </div>\n              </CardContent>\n            </Card>\n            \n            <Card>\n              <CardHeader className=\"pb-3\">\n                <CardTitle className=\"text-sm font-medium text-muted-foreground flex items-center\">\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                  Compliance Rate\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold text-foreground\" data-testid=\"compliance-rate-stat\">\n                  {dashboardStats?.complianceRate || 0}%\n                </div>\n                <Progress value={dashboardStats?.complianceRate || 0} className=\"mt-2\" />\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Quick Insights */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-foreground\">Document Compliance</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {complianceData.map((item) => (\n                    <div key={item.level} className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center space-x-3\">\n                        <div className={`w-3 h-3 rounded-full ${item.color}`}></div>\n                        <span className=\"text-sm font-medium text-foreground\">{item.level}</span>\n                      </div>\n                      <Badge variant=\"outline\">{item.count} alerts</Badge>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n            \n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-foreground\">Crew Status Distribution</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {crewData.map((item) => (\n                    <div key={item.status} className=\"flex items-center justify-between\">\n                      <span className=\"text-sm font-medium text-foreground\">{item.status}</span>\n                      <div className=\"flex items-center space-x-2\">\n                        <span className=\"text-sm text-muted-foreground\">{item.count as React.ReactNode}</span>\n                        <Badge variant=\"outline\">{item.percentage}%</Badge>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </>\n      )}\n\n      {/* Vessel Utilization Report */}\n      {reportType === 'vessels' && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-foreground\">Vessel Utilization Report</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Vessel Name</TableHead>\n                  <TableHead>Crew Assigned</TableHead>\n                  <TableHead>Capacity</TableHead>\n                  <TableHead>Utilization</TableHead>\n                  <TableHead>Status</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {vesselData.map((vessel: VesselData) => (\n                  <TableRow key={vessel.name}>\n                    <TableCell className=\"font-medium\">{vessel.name}</TableCell>\n                    <TableCell>{vessel.assigned}</TableCell>\n                    <TableCell>{vessel.capacity}</TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center space-x-2\">\n                        <Progress value={vessel.utilization} className=\"w-16\" />\n                        <span className=\"text-sm\">{vessel.utilization}%</span>\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <Badge \n                        className={vessel.status === 'active' ? 'bg-green-500' : 'bg-gray-500'}\n                      >\n                        {vessel.status}\n                      </Badge>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Compliance Report */}\n      {reportType === 'compliance' && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-foreground\">Document Compliance Report</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {expiringDocuments && expiringDocuments.length > 0 ? (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Crew Member</TableHead>\n                    <TableHead>Document Type</TableHead>\n                    <TableHead>Expiry Date</TableHead>\n                    <TableHead>Days Remaining</TableHead>\n                    <TableHead>Severity</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {expiringDocuments.map((alert: any) => (\n                    <TableRow key={alert.document.id}>\n                      <TableCell className=\"font-medium\">\n                        {alert.crewMember.firstName} {alert.crewMember.lastName}\n                      </TableCell>\n                      <TableCell>{alert.document.type.toUpperCase()}</TableCell>\n                      <TableCell>\n                        {formatDate(alert.document.expiryDate)}\n                      </TableCell>\n                      <TableCell>{alert.daysUntilExpiry}</TableCell>\n                      <TableCell>\n                        <Badge \n                          className={\n                            alert.severity === 'critical' ? 'bg-red-500' :\n                            alert.severity === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'\n                          }\n                        >\n                          {alert.severity.toUpperCase()}\n                        </Badge>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            ) : (\n              <Alert>\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertDescription>\n                  No compliance issues found. All documents are up to date.\n                </AlertDescription>\n              </Alert>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Crew Analysis Report */}\n      {reportType === 'crew' && (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-foreground\">Crew Statistics</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-foreground\">Total Crew Members</span>\n                  <span className=\"font-semibold text-foreground\">{crewMembers?.length || 0}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-foreground\">Crew On Board</span>\n                  <span className=\"font-semibold text-green-600\">\n                    {crewMembers?.filter((c: any) => c.status === 'onBoard').length || 0}\n                  </span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-foreground\">Crew On Shore</span>\n                  <span className=\"font-semibold text-yellow-600\">\n                    {crewMembers?.filter((c: any) => c.status === 'onShore').length || 0}\n                  </span>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-foreground\">Contract Statistics</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-foreground\">Total Contracts</span>\n                  <span className=\"font-semibold text-foreground\">{contracts?.length || 0}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-foreground\">Active Contracts</span>\n                  <span className=\"font-semibold text-green-600\">\n                    {contracts?.filter((c: any) => c.status === 'active').length || 0}\n                  </span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-foreground\">Completed</span>\n                  <span className=\"font-semibold text-blue-600\">\n                    {contracts?.filter((c: any) => c.status === 'completed').length || 0}\n                  </span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-foreground\">Terminated</span>\n                  <span className=\"font-semibold text-red-600\">\n                    {contracts?.filter((c: any) => c.status === 'terminated').length || 0}\n                  </span>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":23543,"size_tokens":null},"HOSTINGER_DEPLOYMENT_STEPS.md":{"content":"# Step-by-Step Hostinger Deployment Guide\n\n## Phase 1: Download and Prepare Files\n\n### 1. Download Your Production Package\n- Download the `crewtrack-pro-production.tar.gz` file from this project\n- Extract it to a local folder on your computer\n\n### 2. Verify Files Structure\nAfter extraction, you should see:\n```\ncrewtrack-pro/\n‚îú‚îÄ‚îÄ deployment/\n‚îÇ   ‚îú‚îÄ‚îÄ dist/               # Frontend files\n‚îÇ   ‚îú‚îÄ‚îÄ server/             # Backend files  \n‚îÇ   ‚îú‚îÄ‚îÄ shared/             # Database schema\n‚îÇ   ‚îú‚îÄ‚îÄ package.json        # Dependencies\n‚îÇ   ‚îú‚îÄ‚îÄ .env.example        # Environment template\n‚îÇ   ‚îî‚îÄ‚îÄ eng.traineddata     # OCR data\n‚îî‚îÄ‚îÄ DEPLOYMENT_GUIDE.md     # Detailed guide\n```\n\n## Phase 2: Hostinger Account Setup\n\n### 3. Database Setup (PostgreSQL)\n1. Log into Hostinger control panel\n2. Go to **Websites** ‚Üí **Manage** ‚Üí **Databases**\n3. Click **Create Database**\n4. Choose **PostgreSQL** (recommended) or MySQL\n5. Database name: `crewtrack_pro`\n6. Username: Create strong username\n7. Password: Create strong password\n8. **Save these credentials - you'll need them!**\n\n### 4. Node.js Application Setup\n1. In Hostinger control panel: **Websites** ‚Üí **Manage**\n2. Click **Advanced** ‚Üí **Node.js**\n3. Click **Create Application**\n4. Application name: `CrewTrack Pro`\n5. Node.js version: Select **18.x** or higher\n6. Entry point: `dist/index.js`\n7. Click **Create**\n\n## Phase 3: File Upload\n\n### 5. Upload Files via File Manager\n1. In Hostinger: **Websites** ‚Üí **File Manager**\n2. Navigate to your domain folder (e.g., `public_html/yourdomain.com`)\n3. Upload the entire `deployment` folder contents\n4. Your structure should look like:\n```\npublic_html/yourdomain.com/\n‚îú‚îÄ‚îÄ dist/\n‚îú‚îÄ‚îÄ server/\n‚îú‚îÄ‚îÄ shared/\n‚îú‚îÄ‚îÄ package.json\n‚îú‚îÄ‚îÄ eng.traineddata\n‚îî‚îÄ‚îÄ (other files)\n```\n\n### 6. Set File Permissions\n1. Select all uploaded files\n2. Right-click ‚Üí **Permissions**\n3. Set directories to `755`\n4. Set files to `644`\n\n## Phase 4: Environment Configuration\n\n### 7. Create Environment File\n1. In File Manager, create new file: `.env`\n2. Copy from `.env.example` and update with your database info:\n\n```env\nDATABASE_URL=\"postgresql://your_username:your_password@localhost:5432/crewtrack_pro\"\nPGHOST=localhost\nPGPORT=5432\nPGUSER=your_database_username\nPGPASSWORD=your_database_password\nPGDATABASE=crewtrack_pro\nNODE_ENV=production\nPORT=3000\n```\n\n**Replace with your actual database credentials from Step 3!**\n\n## Phase 5: Installation and Setup\n\n### 8. Install Dependencies\n1. In Hostinger control panel: **Advanced** ‚Üí **SSH Access**\n2. Open terminal\n3. Navigate to your app folder:\n   ```bash\n   cd domains/yourdomain.com/public_html\n   ```\n4. Install dependencies:\n   ```bash\n   npm install --production\n   ```\n\n### 9. Setup Database Tables\n1. In the same terminal, run:\n   ```bash\n   npm run db:push\n   ```\n2. This creates all necessary database tables\n\n### 10. Start Application\n1. Go back to **Node.js** in control panel\n2. Find your CrewTrack Pro application\n3. Click **Start** or **Restart**\n4. Check status shows **Running**\n\n## Phase 6: Domain and SSL\n\n### 11. Configure Domain\n1. In **Websites** ‚Üí **Manage** ‚Üí **Domains**\n2. Either use main domain or create subdomain like `crew.yourdomain.com`\n3. Point domain to the Node.js application\n\n### 12. Enable SSL Certificate\n1. **Websites** ‚Üí **Manage** ‚Üí **SSL**\n2. Enable **Free SSL Certificate**\n3. Wait for activation (5-10 minutes)\n\n## Phase 7: Testing\n\n### 13. Test Your Application\n1. Visit your domain: `https://yourdomain.com`\n2. You should see the CrewTrack Pro login page\n3. Test login with demo accounts:\n   - **Admin**: username `admin`, password `admin123`\n   - **Office Staff**: username `office`, password `demo123`\n\n### 14. Test Key Features\n- [ ] Dashboard loads correctly\n- [ ] Add new crew member\n- [ ] Upload document with OCR scanning\n- [ ] View vessel management\n- [ ] Check contract tracking\n\n## Troubleshooting Common Issues\n\n### Database Connection Error\n- Verify `.env` file has correct database credentials\n- Check database is running in Hostinger panel\n- Ensure `DATABASE_URL` format is correct\n\n### Application Won't Start\n- Check Node.js version is 18+\n- Verify entry point is `dist/index.js`\n- Check error logs in Node.js application panel\n\n### 404 Errors\n- Ensure all files uploaded correctly\n- Check file permissions (755 for directories, 644 for files)\n- Verify domain points to correct directory\n\n### SSL Issues\n- Wait 10-15 minutes after enabling SSL\n- Clear browser cache\n- Try accessing with `https://` prefix\n\n## Maintenance\n\n### Regular Backups\n1. **Database**: Use Hostinger's backup feature\n2. **Files**: Download copy of your application files\n3. **Schedule**: Weekly backups recommended\n\n### Updates\n1. When updating, always backup first\n2. Test changes locally before uploading\n3. Use Hostinger's staging environment if available\n\n## Support Resources\n\n- **Hostinger Knowledge Base**: Check their Node.js documentation\n- **Database Issues**: Use Hostinger's database management tools\n- **SSL Problems**: Contact Hostinger support\n- **Application Logs**: Check in Node.js application panel\n\n---\n\n## Quick Checklist\n\n- [ ] Database created in Hostinger\n- [ ] Files uploaded to correct directory\n- [ ] Environment variables configured\n- [ ] Dependencies installed (`npm install`)\n- [ ] Database migrated (`npm run db:push`)\n- [ ] Application started in Node.js panel\n- [ ] Domain configured\n- [ ] SSL certificate enabled\n- [ ] Application tested and working\n\n**Your CrewTrack Pro maritime crew management system is now live!**\n\n---\n\n**Need Help?** \n- Check the detailed `DEPLOYMENT_GUIDE.md` for technical details\n- Review Hostinger's Node.js hosting documentation\n- Test each step carefully before proceeding to the next","path":null,"size_bytes":5802,"size_tokens":null},"client/src/components/crew/crew-profile-form.tsx":{"content":"import React from 'react';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { useMutation, useQuery } from '@tanstack/react-query';\nimport { queryClient } from '@/lib/queryClient';\nimport { apiRequest } from '@/lib/queryClient';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useToast } from '@/hooks/use-toast';\nimport { insertCrewMemberSchema } from '@shared/schema';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\nimport { Label } from '@/components/ui/label';\nimport { Textarea } from '@/components/ui/textarea';\nimport { z } from 'zod';\n\nconst crewFormSchema = insertCrewMemberSchema.extend({\n  dateOfBirth: z.string(),\n  emergencyContactName: z.string().optional(),\n  emergencyContactRelationship: z.string().optional(),\n  emergencyContactPhone: z.string().optional(),\n  emergencyContactEmail: z.string().email().optional().or(z.literal('')),\n});\n\ntype CrewFormData = z.infer<typeof crewFormSchema>;\n\ninterface CrewProfileFormProps {\n  crewMemberId?: string;\n  onSuccess?: () => void;\n}\n\nconst rankOptions = [\n  'Captain',\n  'Chief Officer',\n  'Chief Officer (NCV)',\n  '2nd Officer',\n  '3rd Officer',\n  'IV Master',\n  'Second Master (IV)',\n  'Chief Engineer',\n  'Chief Engineer (NCV)',\n  '2nd Engineer',\n  '3rd Engineer',\n  '4th Engineer',\n  'Bosun',\n  'AB Seaman',\n  'Deck Watchkeeping Rating (AB)',\n  'OS Seaman',\n  'Engine Rating',\n  'Cook',\n  '2nd Cook',\n  'Messman',\n  'Saloon Rating',\n  'Oiler',\n  'Wiper',\n  'Radio Officer',\n  'ETO',\n  'ASST ETO',\n  'Electrician',\n  'Fitter',\n  'Handler',\n  'Tube Operator',\n  'Lathe Operator',\n];\n\nexport default function CrewProfileForm({ crewMemberId, onSuccess }: CrewProfileFormProps) {\n  const { toast } = useToast();\n  const isEdit = Boolean(crewMemberId);\n\n  const form = useForm<CrewFormData>({\n    resolver: zodResolver(crewFormSchema),\n    defaultValues: {\n      firstName: '',\n      lastName: '',\n      nationality: '',\n      dateOfBirth: '',\n      rank: '',\n      phoneNumber: '',\n      status: 'active',\n      emergencyContactName: '',\n      emergencyContactRelationship: '',\n      emergencyContactPhone: '',\n      emergencyContactEmail: '',\n    },\n  });\n\n  const { data: vessels } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  const { data: existingCrew } = useQuery({\n    queryKey: ['/api/crew', crewMemberId],\n    queryFn: async () => {\n      if (!crewMemberId) return null;\n      const response = await fetch(`/api/crew/${crewMemberId}`, {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew member');\n      return response.json();\n    },\n    enabled: Boolean(crewMemberId),\n  });\n\n  // Populate form with existing data when editing\n  React.useEffect(() => {\n    if (existingCrew) {\n      const emergencyContact = existingCrew.emergencyContact || {};\n      form.reset({\n        firstName: existingCrew.firstName,\n        lastName: existingCrew.lastName,\n        nationality: existingCrew.nationality,\n        dateOfBirth: existingCrew.dateOfBirth ? new Date(existingCrew.dateOfBirth).toISOString().split('T')[0] : '',\n        rank: existingCrew.rank,\n        phoneNumber: existingCrew.phoneNumber || '',\n        currentVesselId: existingCrew.currentVesselId || undefined,\n        status: existingCrew.status,\n        emergencyContactName: emergencyContact.name || '',\n        emergencyContactRelationship: emergencyContact.relationship || '',\n        emergencyContactPhone: emergencyContact.phone || '',\n        emergencyContactEmail: emergencyContact.email || '',\n      });\n    }\n  }, [existingCrew, form]);\n\n  const createMutation = useMutation({\n    mutationFn: async (data: CrewFormData) => {\n      const { emergencyContactName, emergencyContactRelationship, emergencyContactPhone, emergencyContactEmail, dateOfBirth, ...crewData } = data;\n      \n      const payload = {\n        ...crewData,\n        dateOfBirth: new Date(dateOfBirth),\n        emergencyContact: emergencyContactName ? {\n          name: emergencyContactName,\n          relationship: emergencyContactRelationship || '',\n          phone: emergencyContactPhone || '',\n          email: emergencyContactEmail || '',\n        } : null,\n      };\n\n      if (isEdit) {\n        return apiRequest('PUT', `/api/crew/${crewMemberId}`, payload);\n      } else {\n        return apiRequest('POST', '/api/crew', payload);\n      }\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      toast({\n        title: 'Success',\n        description: `Crew member ${isEdit ? 'updated' : 'created'} successfully`,\n      });\n      onSuccess?.();\n    },\n    onError: (error) => {\n      toast({\n        title: 'Error',\n        description: `Failed to ${isEdit ? 'update' : 'create'} crew member`,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const onSubmit = (data: CrewFormData) => {\n    createMutation.mutate(data);\n  };\n\n  return (\n    <Form {...form}>\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n        {/* Personal Information */}\n        <div className=\"space-y-4 p-4 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-blue-900 dark:text-blue-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-blue-600 rounded-full mr-3\"></div>\n            Personal Information\n          </h3>\n          \n          <div className=\"grid grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"firstName\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>First Name *</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"first-name-input\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"lastName\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Last Name *</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"last-name-input\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"nationality\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Nationality *</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"nationality-input\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"dateOfBirth\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Date of Birth *</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} data-testid=\"dob-input\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n\n          <FormField\n            control={form.control}\n            name=\"phoneNumber\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Phone Number</FormLabel>\n                <FormControl>\n                  <Input {...field} value={field.value || ''} data-testid=\"phone-input\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        {/* Professional Information */}\n        <div className=\"space-y-4 p-4 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-green-900 dark:text-green-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-green-600 rounded-full mr-3\"></div>\n            Professional Information\n          </h3>\n          \n          <div className=\"grid grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"rank\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Rank *</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"rank-select\">\n                        <SelectValue placeholder=\"Select rank\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      {rankOptions.map((rank) => (\n                        <SelectItem key={rank} value={rank}>\n                          {rank}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"currentVesselId\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Current Vessel</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value || undefined}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"vessel-select\">\n                        <SelectValue placeholder=\"Select vessel\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      <SelectItem value=\"none\">No assignment</SelectItem>\n                      {vessels?.map((vessel: any) => (\n                        <SelectItem key={vessel.id} value={vessel.id}>\n                          {vessel.name} ({vessel.type})\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n\n          <FormField\n            control={form.control}\n            name=\"status\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Status</FormLabel>\n                <FormControl>\n                  <RadioGroup\n                    onValueChange={field.onChange}\n                    value={field.value}\n                    className=\"flex flex-col space-y-2\"\n                    data-testid=\"status-radio-group\"\n                  >\n                    <div className=\"flex items-center space-x-2\">\n                      <RadioGroupItem value=\"onBoard\" id=\"onBoard-profile\" />\n                      <Label htmlFor=\"onBoard-profile\" className=\"cursor-pointer\">On Board</Label>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <RadioGroupItem value=\"onShore\" id=\"onShore-profile\" />\n                      <Label htmlFor=\"onShore-profile\" className=\"cursor-pointer\">On Shore</Label>\n                    </div>\n                  </RadioGroup>\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        {/* Emergency Contact */}\n        <div className=\"space-y-4 p-4 bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-orange-900 dark:text-orange-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-orange-600 rounded-full mr-3\"></div>\n            Emergency Contact\n          </h3>\n          \n          <div className=\"grid grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"emergencyContactName\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Contact Name</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"emergency-name-input\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"emergencyContactRelationship\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Relationship</FormLabel>\n                  <FormControl>\n                    <Input {...field} placeholder=\"e.g., Spouse, Parent\" data-testid=\"emergency-relationship-input\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"emergencyContactPhone\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Contact Phone</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"emergency-phone-input\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"emergencyContactEmail\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Contact Email</FormLabel>\n                  <FormControl>\n                    <Input type=\"email\" {...field} data-testid=\"emergency-email-input\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n        </div>\n\n        {/* Form Actions */}\n        <div className=\"flex justify-end space-x-2 pt-4\">\n          <Button \n            type=\"button\" \n            variant=\"outline\" \n            onClick={onSuccess}\n            data-testid=\"cancel-crew-form-button\"\n          >\n            Cancel\n          </Button>\n          <Button \n            type=\"submit\" \n            className=\"bg-maritime-navy hover:bg-blue-800\"\n            disabled={createMutation.isPending}\n            data-testid=\"save-crew-form-button\"\n          >\n            {isEdit ? 'Update' : 'Create'} Crew Member\n          </Button>\n        </div>\n      </form>\n    </Form>\n  );\n}\n","path":null,"size_bytes":15083,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/pages/ex-hand.tsx":{"content":"import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table';\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from '@/components/ui/alert-dialog';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { Ship, User, Trash2 } from 'lucide-react';\nimport { useState } from 'react';\nimport { CrewMemberWithDetails } from '@shared/schema';\nimport { formatDate } from '@/lib/utils';\n\nexport default function ExHandDatabase() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [vesselAssignments, setVesselAssignments] = useState<{[key: string]: string}>({});\n  const [contractDialogOpen, setContractDialogOpen] = useState(false);\n  const [selectedCrewForContract, setSelectedCrewForContract] = useState<CrewMemberWithDetails | null>(null);\n  const [contractStartDate, setContractStartDate] = useState('');\n  const [contractDuration, setContractDuration] = useState('90');\n  const [contractEndDate, setContractEndDate] = useState('');\n\n  // Fetch signed-off crew members with rotation history\n  const { data: signedOffCrew = [], isLoading } = useQuery<CrewMemberWithDetails[]>({\n    queryKey: ['/api/crew/signed-off'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      const allCrew = await response.json();\n      // Filter for signed-off crew members\n      return allCrew.filter((member: CrewMemberWithDetails) => member.status === 'onShore');\n    },\n  });\n\n  // Fetch rotation history for all crew\n  const { data: rotations = [] } = useQuery({\n    queryKey: ['/api/rotations'],\n    queryFn: async () => {\n      const response = await fetch('/api/rotations', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch rotations');\n      return response.json();\n    },\n  });\n\n  // Fetch vessels for dropdown\n  const { data: vessels = [] } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      const data = await response.json();\n      console.log('Loaded vessels:', data);\n      console.log('Active vessels:', data.filter((v: any) => v.status === 'active'));\n      return data;\n    },\n  });\n\n  // Assign crew to vessel mutation\n  const assignCrewMutation = useMutation({\n    mutationFn: async ({ crewId, vesselId }: { crewId: string; vesselId: string }) => {\n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          currentVesselId: vesselId,\n          status: 'onBoard',\n          signOffDate: null, // Clear sign-off date when reassigning\n        }),\n      });\n      if (!response.ok) {\n        const errorData = await response.text();\n        console.error('Assignment failed:', response.status, errorData);\n        \n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to assign crew member');\n        } catch {\n          throw new Error(`Assignment failed (${response.status}): ${errorData}`);\n        }\n      }\n      return response.json();\n    },\n    onSuccess: (data, variables) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/crew/signed-off'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      \n      // Clear the selected vessel for this crew member\n      setVesselAssignments(prev => {\n        const updated = { ...prev };\n        delete updated[variables.crewId];\n        return updated;\n      });\n      \n      toast({\n        title: 'Success',\n        description: 'Crew member assigned to vessel successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to assign crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const getInitials = (firstName: string, lastName: string) => {\n    return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();\n  };\n\n  // Get vessel history for a crew member\n  const getVesselHistory = (crewMemberId: string) => {\n    const crewRotations = rotations.filter((r: any) => r.crewMemberId === crewMemberId && r.status === 'completed');\n    \n    // Group by vessel and get unique vessels with dates\n    const vesselMap = new Map();\n    crewRotations.forEach((rotation: any) => {\n      const vessel = vessels.find((v: any) => v.id === rotation.vesselId);\n      if (vessel && !vesselMap.has(vessel.id)) {\n        vesselMap.set(vessel.id, {\n          vessel,\n          joinDate: rotation.joinDate,\n          leaveDate: rotation.leaveDate\n        });\n      }\n    });\n    \n    return Array.from(vesselMap.values());\n  };\n\n  const handleVesselSelect = (crewId: string, vesselId: string) => {\n    console.log('Vessel selected:', vesselId, 'for crew:', crewId);\n    setVesselAssignments(prev => ({\n      ...prev,\n      [crewId]: vesselId\n    }));\n  };\n\n  // Calculate contract end date based on start date and duration\n  const calculateEndDate = (startDate: string, durationDays: string) => {\n    if (!startDate || !durationDays) return '';\n    const start = new Date(startDate);\n    const duration = parseInt(durationDays);\n    if (isNaN(duration)) return '';\n    const end = new Date(start);\n    end.setDate(end.getDate() + duration);\n    return end.toISOString().split('T')[0];\n  };\n\n  // Update end date when start date or duration changes\n  const handleContractStartDateChange = (value: string) => {\n    setContractStartDate(value);\n    const endDate = calculateEndDate(value, contractDuration);\n    setContractEndDate(endDate);\n  };\n\n  const handleContractDurationChange = (value: string) => {\n    setContractDuration(value);\n    const endDate = calculateEndDate(contractStartDate, value);\n    setContractEndDate(endDate);\n  };\n\n  const handleAssignCrew = (crewId: string) => {\n    const vesselId = vesselAssignments[crewId];\n    if (!vesselId) {\n      toast({\n        title: 'Error',\n        description: 'Please select a vessel before assigning',\n        variant: 'destructive',\n      });\n      return;\n    }\n    \n    // Find crew member details\n    const crewMember = signedOffCrew.find(c => c.id === crewId);\n    if (!crewMember) return;\n    \n    // Open contract dialog\n    setSelectedCrewForContract(crewMember);\n    setContractDialogOpen(true);\n    \n    // Set default start date to today\n    const today = new Date().toISOString().split('T')[0];\n    setContractStartDate(today);\n    const endDate = calculateEndDate(today, contractDuration);\n    setContractEndDate(endDate);\n  };\n\n  // Contract creation mutation\n  const createContractMutation = useMutation({\n    mutationFn: async (data: { crewId: string; vesselId: string; startDate: string; durationDays: number; endDate: string }) => {\n      // First, get all active contracts for this crew member and terminate them\n      const getContractsResponse = await fetch(`/api/contracts?crewMemberId=${data.crewId}`, {\n        headers: getAuthHeaders(),\n      });\n      \n      if (getContractsResponse.ok) {\n        const existingContracts = await getContractsResponse.json();\n        const activeContracts = existingContracts.filter((c: any) => c.status === 'active');\n        \n        // Terminate all active contracts\n        await Promise.all(\n          activeContracts.map((contract: any) =>\n            fetch(`/api/contracts/${contract.id}`, {\n              method: 'PUT',\n              headers: {\n                ...getAuthHeaders(),\n                'Content-Type': 'application/json',\n              },\n              body: JSON.stringify({ status: 'completed' }),\n            })\n          )\n        );\n      }\n      \n      // Now create the new contract\n      const response = await fetch('/api/contracts', {\n        method: 'POST',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          crewMemberId: data.crewId,\n          vesselId: data.vesselId,\n          startDate: new Date(data.startDate),\n          endDate: new Date(data.endDate),\n          durationDays: data.durationDays,\n          status: 'active',\n        }),\n      });\n      if (!response.ok) throw new Error('Failed to create contract');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/contracts'] });\n    },\n  });\n\n  // Handle contract confirmation\n  const handleConfirmContract = () => {\n    if (!selectedCrewForContract) return;\n    \n    const vesselId = vesselAssignments[selectedCrewForContract.id];\n    if (!vesselId) return;\n    \n    if (!contractStartDate || !contractDuration) {\n      toast({\n        title: 'Error',\n        description: 'Please fill in all contract details',\n        variant: 'destructive',\n      });\n      return;\n    }\n    \n    const durationDays = parseInt(contractDuration);\n    if (isNaN(durationDays) || durationDays <= 0) {\n      toast({\n        title: 'Error',\n        description: 'Please enter a valid duration',\n        variant: 'destructive',\n      });\n      return;\n    }\n    \n    // First assign the crew member\n    assignCrewMutation.mutate(\n      { crewId: selectedCrewForContract.id, vesselId },\n      {\n        onSuccess: () => {\n          // Then create the contract\n          createContractMutation.mutate({\n            crewId: selectedCrewForContract.id,\n            vesselId,\n            startDate: contractStartDate,\n            durationDays,\n            endDate: contractEndDate,\n          });\n          \n          // Close dialog and reset\n          setContractDialogOpen(false);\n          setSelectedCrewForContract(null);\n          setContractStartDate('');\n          setContractDuration('90');\n          setContractEndDate('');\n        },\n      }\n    );\n  };\n\n  // Delete crew member mutation\n  const deleteCrewMutation = useMutation({\n    mutationFn: async (crewId: string) => {\n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'DELETE',\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) {\n        const errorData = await response.text();\n        console.error('Delete failed:', response.status, errorData);\n        \n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to delete crew member');\n        } catch {\n          throw new Error(`Delete failed (${response.status}): ${errorData}`);\n        }\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/crew/signed-off'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      \n      toast({\n        title: 'Success',\n        description: 'Crew member deleted successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to delete crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleDeleteCrew = (crewId: string) => {\n    deleteCrewMutation.mutate(crewId);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-10 bg-muted rounded mb-4\"></div>\n          <div className=\"h-64 bg-muted rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-foreground\">Ex-Hand Database</h1>\n          <p className=\"text-muted-foreground\">\n            Historical tracking of signed-off crew members and vessel reassignment\n          </p>\n        </div>\n        <Badge variant=\"outline\" className=\"flex items-center gap-2\">\n          <User className=\"h-4 w-4\" />\n          {signedOffCrew.length} Ex-Crew Members\n        </Badge>\n      </div>\n\n      {/* Desktop Table */}\n      <div className=\"hidden lg:block\">\n        <div className=\"rounded-md border overflow-visible\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Crew Member</TableHead>\n                <TableHead>Rank</TableHead>\n                <TableHead>Last Vessel Sailed</TableHead>\n                <TableHead>Sign-Off Date</TableHead>\n                <TableHead>Actions</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {signedOffCrew.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={5} className=\"text-center py-8 text-muted-foreground\">\n                    No signed-off crew members found\n                  </TableCell>\n                </TableRow>\n              ) : (\n                signedOffCrew.map((member) => {\n                  const vesselHistory = getVesselHistory(member.id);\n                  const hasHistory = vesselHistory.length > 0;\n                  \n                  // If has history, show vessel-wise entries; otherwise show single entry\n                  if (hasHistory) {\n                    return vesselHistory.map((history: any, index: number) => (\n                      <TableRow key={`${member.id}-${history.vessel.id}`}>\n                        {index === 0 ? (\n                          <TableCell rowSpan={vesselHistory.length}>\n                            <div className=\"flex items-center space-x-3\">\n                              <Avatar className=\"h-8 w-8 bg-maritime-navy\">\n                                <AvatarFallback className=\"text-white text-xs font-medium\">\n                                  {getInitials(member.firstName, member.lastName)}\n                                </AvatarFallback>\n                              </Avatar>\n                              <div>\n                                <p className=\"font-medium text-foreground\">{member.firstName} {member.lastName}</p>\n                                <p className=\"text-sm text-muted-foreground\">{member.nationality}</p>\n                              </div>\n                            </div>\n                          </TableCell>\n                        ) : null}\n                        {index === 0 ? (\n                          <TableCell rowSpan={vesselHistory.length}>\n                            <Badge variant=\"secondary\" className=\"text-xs\">\n                              {member.rank}\n                            </Badge>\n                          </TableCell>\n                        ) : null}\n                        <TableCell>\n                          <div className=\"flex items-center space-x-2\">\n                            <Ship className=\"h-4 w-4 text-muted-foreground\" />\n                            <span className=\"text-sm\">{history.vessel.name}</span>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <span className=\"text-sm text-muted-foreground\">\n                            {history.leaveDate \n                              ? formatDate(history.leaveDate)\n                              : 'N/A'\n                            }\n                          </span>\n                        </TableCell>\n                        {index === 0 ? (\n                          <TableCell rowSpan={vesselHistory.length}>\n                            <div className=\"flex items-center space-x-2\">\n                              <Select\n                                value={vesselAssignments[member.id] || ''}\n                                onValueChange={(value) => handleVesselSelect(member.id, value)}\n                              >\n                                <SelectTrigger className=\"w-40\" data-testid={`select-vessel-${member.id}`}>\n                                  <SelectValue placeholder=\"Select vessel\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  {vessels.length === 0 ? (\n                                      <div className=\"p-2 text-sm text-muted-foreground\">No vessels available</div>\n                                    ) : (\n                                      vessels.map((vessel: any) => (\n                                          <SelectItem key={vessel.id} value={vessel.id}>\n                                            {vessel.name} ({vessel.type})\n                                          </SelectItem>\n                                        ))\n                                    )}\n                                </SelectContent>\n                              </Select>\n                              <Button\n                                size=\"sm\"\n                                onClick={() => handleAssignCrew(member.id)}\n                                disabled={!vesselAssignments[member.id] || assignCrewMutation.isPending}\n                                data-testid={`assign-crew-${member.id}`}\n                              >\n                                {assignCrewMutation.isPending ? 'Assigning...' : 'Assign'}\n                              </Button>\n                              \n                              <AlertDialog>\n                                <AlertDialogTrigger asChild>\n                                  <Button\n                                    variant=\"destructive\"\n                                    size=\"sm\"\n                                    disabled={deleteCrewMutation.isPending}\n                                    data-testid={`delete-crew-${member.id}`}\n                                  >\n                                    <Trash2 className=\"h-4 w-4\" />\n                                  </Button>\n                                </AlertDialogTrigger>\n                                <AlertDialogContent>\n                                  <AlertDialogHeader>\n                                    <AlertDialogTitle>Delete Crew Member</AlertDialogTitle>\n                                    <AlertDialogDescription>\n                                      Are you sure you want to permanently delete {member.firstName} {member.lastName}? \n                                      This action cannot be undone and will remove all their data from the system.\n                                    </AlertDialogDescription>\n                                  </AlertDialogHeader>\n                                  <AlertDialogFooter>\n                                    <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                    <AlertDialogAction\n                                      onClick={() => handleDeleteCrew(member.id)}\n                                      className=\"bg-red-600 hover:bg-red-700\"\n                                      disabled={deleteCrewMutation.isPending}\n                                    >\n                                      {deleteCrewMutation.isPending ? 'Deleting...' : 'Delete'}\n                                    </AlertDialogAction>\n                                  </AlertDialogFooter>\n                                </AlertDialogContent>\n                              </AlertDialog>\n                            </div>\n                          </TableCell>\n                        ) : null}\n                      </TableRow>\n                    ));\n                  } else {\n                    // No history - show single row with last vessel or current vessel\n                    return (\n                      <TableRow key={member.id}>\n                        <TableCell>\n                          <div className=\"flex items-center space-x-3\">\n                            <Avatar className=\"h-8 w-8 bg-maritime-navy\">\n                              <AvatarFallback className=\"text-white text-xs font-medium\">\n                                {getInitials(member.firstName, member.lastName)}\n                              </AvatarFallback>\n                            </Avatar>\n                            <div>\n                              <p className=\"font-medium text-foreground\">{member.firstName} {member.lastName}</p>\n                              <p className=\"text-sm text-muted-foreground\">{member.nationality}</p>\n                            </div>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            {member.rank}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center space-x-2\">\n                            <Ship className=\"h-4 w-4 text-muted-foreground\" />\n                            <span className=\"text-sm\">\n                              {member.lastVessel?.name || member.currentVessel?.name || 'No previous vessel'}\n                            </span>\n                          </div>\n                        </TableCell>\n                        <TableCell>\n                          <span className=\"text-sm text-muted-foreground\">\n                            {member.signOffDate \n                              ? formatDate(member.signOffDate)\n                              : 'N/A'\n                            }\n                          </span>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center space-x-2\">\n                            <Select\n                              value={vesselAssignments[member.id] || ''}\n                              onValueChange={(value) => handleVesselSelect(member.id, value)}\n                            >\n                              <SelectTrigger className=\"w-40\" data-testid={`select-vessel-${member.id}`}>\n                                <SelectValue placeholder=\"Select vessel\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {vessels.length === 0 ? (\n                                    <div className=\"p-2 text-sm text-muted-foreground\">No vessels available</div>\n                                  ) : (\n                                    vessels.map((vessel: any) => (\n                                        <SelectItem key={vessel.id} value={vessel.id}>\n                                          {vessel.name} ({vessel.type})\n                                        </SelectItem>\n                                      ))\n                                  )}\n                              </SelectContent>\n                            </Select>\n                            <Button\n                              size=\"sm\"\n                              onClick={() => handleAssignCrew(member.id)}\n                              disabled={!vesselAssignments[member.id] || assignCrewMutation.isPending}\n                              data-testid={`assign-crew-${member.id}`}\n                            >\n                              {assignCrewMutation.isPending ? 'Assigning...' : 'Assign'}\n                            </Button>\n                            \n                            <AlertDialog>\n                              <AlertDialogTrigger asChild>\n                                <Button\n                                  variant=\"destructive\"\n                                  size=\"sm\"\n                                  disabled={deleteCrewMutation.isPending}\n                                  data-testid={`delete-crew-${member.id}`}\n                                >\n                                  <Trash2 className=\"h-4 w-4\" />\n                                </Button>\n                              </AlertDialogTrigger>\n                              <AlertDialogContent>\n                                <AlertDialogHeader>\n                                  <AlertDialogTitle>Delete Crew Member</AlertDialogTitle>\n                                  <AlertDialogDescription>\n                                    Are you sure you want to permanently delete {member.firstName} {member.lastName}? \n                                    This action cannot be undone and will remove all their data from the system.\n                                  </AlertDialogDescription>\n                                </AlertDialogHeader>\n                                <AlertDialogFooter>\n                                  <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                  <AlertDialogAction\n                                    onClick={() => handleDeleteCrew(member.id)}\n                                    className=\"bg-red-600 hover:bg-red-700\"\n                                    disabled={deleteCrewMutation.isPending}\n                                  >\n                                    {deleteCrewMutation.isPending ? 'Deleting...' : 'Delete'}\n                                  </AlertDialogAction>\n                                </AlertDialogFooter>\n                              </AlertDialogContent>\n                            </AlertDialog>\n                          </div>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  }\n                })\n              )}\n            </TableBody>\n          </Table>\n        </div>\n      </div>\n\n      {/* Mobile Cards */}\n      <div className=\"lg:hidden space-y-4\">\n        {signedOffCrew.length === 0 ? (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <p>No signed-off crew members found</p>\n          </div>\n        ) : (\n          signedOffCrew.map((member) => {\n            const vesselHistory = getVesselHistory(member.id);\n            const hasHistory = vesselHistory.length > 0;\n            \n            return (\n              <div key={member.id} className=\"bg-card border rounded-lg p-4 space-y-3\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-center space-x-3\">\n                    <Avatar className=\"h-10 w-10 bg-maritime-navy\">\n                      <AvatarFallback className=\"text-white text-sm font-medium\">\n                        {getInitials(member.firstName, member.lastName)}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div>\n                      <h3 className=\"font-medium text-foreground\">{member.firstName} {member.lastName}</h3>\n                      <p className=\"text-sm text-muted-foreground\">{member.nationality}</p>\n                    </div>\n                  </div>\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {member.rank}\n                  </Badge>\n                </div>\n                \n                {/* Vessel History */}\n                {hasHistory ? (\n                  <div className=\"space-y-2\">\n                    <span className=\"text-sm font-medium text-foreground\">Vessel History:</span>\n                    {vesselHistory.map((history: any, index: number) => (\n                      <div key={index} className=\"bg-muted/30 p-2 rounded\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-sm font-medium\">{history.vessel.name}</span>\n                          <span className=\"text-xs text-muted-foreground\">\n                            {history.leaveDate \n                              ? formatDate(history.leaveDate)\n                              : 'N/A'\n                            }\n                          </span>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm text-muted-foreground\">Last Vessel:</span>\n                      <span className=\"text-sm font-medium\">\n                        {member.lastVessel?.name || member.currentVessel?.name || 'No previous vessel'}\n                      </span>\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm text-muted-foreground\">Sign-Off Date:</span>\n                      <span className=\"text-sm\">\n                        {member.signOffDate \n                          ? formatDate(member.signOffDate)\n                          : 'N/A'\n                        }\n                      </span>\n                    </div>\n                  </div>\n                )}\n\n              <div className=\"space-y-2 pt-2 border-t\">\n                <Select\n                  value={vesselAssignments[member.id] || ''}\n                  onValueChange={(value) => handleVesselSelect(member.id, value)}\n                >\n                  <SelectTrigger className=\"w-full\" data-testid={`select-vessel-mobile-${member.id}`}>\n                    <SelectValue placeholder=\"Select vessel to assign\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {vessels.length === 0 ? (\n                        <div className=\"p-2 text-sm text-muted-foreground\">No vessels available</div>\n                      ) : (\n                        vessels.map((vessel: any) => (\n                            <SelectItem key={vessel.id} value={vessel.id}>\n                              {vessel.name} ({vessel.type})\n                            </SelectItem>\n                          ))\n                      )}\n                  </SelectContent>\n                </Select>\n                <div className=\"flex space-x-2\">\n                  <Button\n                    className=\"flex-1\"\n                    onClick={() => handleAssignCrew(member.id)}\n                    disabled={!vesselAssignments[member.id] || assignCrewMutation.isPending}\n                    data-testid={`assign-crew-${member.id}`}\n                  >\n                    {assignCrewMutation.isPending ? 'Assigning...' : 'Assign to Vessel'}\n                  </Button>\n                  \n                  <AlertDialog>\n                    <AlertDialogTrigger asChild>\n                      <Button\n                        variant=\"destructive\"\n                        size=\"sm\"\n                        disabled={deleteCrewMutation.isPending}\n                        data-testid={`delete-crew-mobile-${member.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </AlertDialogTrigger>\n                    <AlertDialogContent>\n                      <AlertDialogHeader>\n                        <AlertDialogTitle>Delete Crew Member</AlertDialogTitle>\n                        <AlertDialogDescription>\n                          Are you sure you want to permanently delete {member.firstName} {member.lastName}? \n                          This action cannot be undone and will remove all their data from the system.\n                        </AlertDialogDescription>\n                      </AlertDialogHeader>\n                      <AlertDialogFooter>\n                        <AlertDialogCancel>Cancel</AlertDialogCancel>\n                        <AlertDialogAction\n                          onClick={() => handleDeleteCrew(member.id)}\n                          className=\"bg-red-600 hover:bg-red-700\"\n                          disabled={deleteCrewMutation.isPending}\n                        >\n                          {deleteCrewMutation.isPending ? 'Deleting...' : 'Delete'}\n                        </AlertDialogAction>\n                      </AlertDialogFooter>\n                    </AlertDialogContent>\n                  </AlertDialog>\n                </div>\n              </div>\n            </div>\n          );\n          })\n        )}\n      </div>\n\n      {/* Contract Information Dialog */}\n      <Dialog open={contractDialogOpen} onOpenChange={setContractDialogOpen}>\n        <DialogContent className=\"sm:max-w-[500px]\">\n          <DialogHeader>\n            <DialogTitle className=\"text-maritime-navy\">Contract Information</DialogTitle>\n            <DialogDescription>\n              Enter contract details for {selectedCrewForContract?.firstName} {selectedCrewForContract?.lastName}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"contract-start-date\">Contract Start Date</Label>\n                <Input\n                  id=\"contract-start-date\"\n                  type=\"date\"\n                  value={contractStartDate}\n                  onChange={(e) => handleContractStartDateChange(e.target.value)}\n                  data-testid=\"input-contract-start-date\"\n                />\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"contract-duration\">Duration (Days)</Label>\n                <Input\n                  id=\"contract-duration\"\n                  type=\"number\"\n                  value={contractDuration}\n                  onChange={(e) => handleContractDurationChange(e.target.value)}\n                  min=\"1\"\n                  data-testid=\"input-contract-duration\"\n                />\n              </div>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"contract-end-date\">Contract End Date (Auto-calculated)</Label>\n              <Input\n                id=\"contract-end-date\"\n                type=\"date\"\n                value={contractEndDate}\n                readOnly\n                disabled\n                className=\"bg-muted\"\n                data-testid=\"input-contract-end-date\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"flex justify-end space-x-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setContractDialogOpen(false);\n                setSelectedCrewForContract(null);\n                setContractStartDate('');\n                setContractDuration('90');\n                setContractEndDate('');\n              }}\n              data-testid=\"button-cancel-contract\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleConfirmContract}\n              disabled={assignCrewMutation.isPending || createContractMutation.isPending}\n              data-testid=\"button-confirm-contract\"\n            >\n              {assignCrewMutation.isPending || createContractMutation.isPending ? 'Processing...' : 'Confirm & Assign'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","path":null,"size_bytes":36146,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/vessels/edit-vessel-form.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useMutation, useQueryClient } from '@tanstack/react-query';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { insertVesselSchema, type Vessel } from '@shared/schema';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { Loader2, Ship } from 'lucide-react';\nimport { z } from 'zod';\n\n// Create edit schema \nconst editVesselSchema = z.object({\n  name: z.string().min(1, \"Vessel name is required\"),\n  type: z.string().min(1, \"Vessel type is required\"),\n  imoNumber: z.string().optional(),\n  flag: z.string().min(1, \"Flag state is required\"),\n  status: z.enum([\"harbour-mining\", \"coastal-mining\", \"world-wide\", \"oil-field\", \"line-up-mining\"]),\n});\ntype EditVesselData = z.infer<typeof editVesselSchema>;\n\ninterface EditVesselFormProps {\n  vessel: Vessel | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport default function EditVesselForm({ vessel, open, onOpenChange }: EditVesselFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const form = useForm<EditVesselData>({\n    resolver: zodResolver(editVesselSchema),\n    defaultValues: {\n      name: '',\n      type: '',\n      imoNumber: '',\n      flag: '',\n      status: 'harbour-mining',\n    },\n  });\n\n  // Reset form when vessel changes\n  useEffect(() => {\n    if (vessel) {\n      form.reset({\n        name: vessel.name,\n        type: vessel.type,\n        imoNumber: vessel.imoNumber || '',\n        flag: vessel.flag,\n        status: vessel.status as \"harbour-mining\" | \"coastal-mining\" | \"world-wide\" | \"oil-field\" | \"line-up-mining\",\n      });\n    }\n  }, [vessel, form]);\n\n  const editVesselMutation = useMutation({\n    mutationFn: async (data: EditVesselData) => {\n      if (!vessel) throw new Error('No vessel to edit');\n      const response = await apiRequest('PUT', `/api/vessels/${vessel.id}`, data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      toast({\n        title: 'Success',\n        description: 'Vessel updated successfully',\n      });\n      onOpenChange(false);\n      form.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to update vessel',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const onSubmit = (data: EditVesselData) => {\n    editVesselMutation.mutate(data);\n  };\n\n  const handleClose = () => {\n    form.reset();\n    onOpenChange(false);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={handleClose}>\n      <DialogContent className=\"sm:max-w-md max-h-[90vh] flex flex-col\">\n        <DialogHeader className=\"flex-shrink-0\">\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Ship className=\"h-5 w-5\" />\n            Edit Vessel\n          </DialogTitle>\n          <DialogDescription>\n            Update the vessel details below and save your changes.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"flex-1 overflow-y-auto min-h-0\">\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n            <FormField\n              control={form.control}\n              name=\"name\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Vessel Name</FormLabel>\n                  <FormControl>\n                    <Input\n                      placeholder=\"Enter vessel name\"\n                      {...field}\n                      data-testid=\"edit-vessel-name\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"type\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Vessel Type</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"edit-vessel-type\">\n                        <SelectValue placeholder=\"Select vessel type\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      <SelectItem value=\"AHT\">AHT</SelectItem>\n                      <SelectItem value=\"Bulk Carrier\">Bulk Carrier</SelectItem>\n                      <SelectItem value=\"Container Ship\">Container Ship</SelectItem>\n                      <SelectItem value=\"Tanker\">Tanker</SelectItem>\n                      <SelectItem value=\"Ferry\">Ferry</SelectItem>\n                      <SelectItem value=\"Cruise Ship\">Cruise Ship</SelectItem>\n                      <SelectItem value=\"Cargo Ship\">Cargo Ship</SelectItem>\n                      <SelectItem value=\"OSV\">OSV</SelectItem>\n                      <SelectItem value=\"Research Vessel\">Research Vessel</SelectItem>\n                      <SelectItem value=\"Naval Vessel\">Naval Vessel</SelectItem>\n                      <SelectItem value=\"Fishing Vessel\">Fishing Vessel</SelectItem>\n                      <SelectItem value=\"General Cargo\">General Cargo</SelectItem>\n                      <SelectItem value=\"Passenger Ship\">Passenger Ship</SelectItem>\n                      <SelectItem value=\"Tugboat\">Tugboat</SelectItem>\n                      <SelectItem value=\"Trailing Suction Hopper Dredger (TSHD)\">Trailing Suction Hopper Dredger (TSHD)</SelectItem>\n                      <SelectItem value=\"Other\">Other</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"imoNumber\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>IMO Number</FormLabel>\n                  <FormControl>\n                    <Input\n                      placeholder=\"Enter IMO number (optional)\"\n                      {...field}\n                      data-testid=\"edit-vessel-imo\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"flag\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Flag State</FormLabel>\n                  <FormControl>\n                    <Input\n                      placeholder=\"Enter flag state\"\n                      {...field}\n                      data-testid=\"edit-vessel-flag\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"status\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Status</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"edit-vessel-status\">\n                        <SelectValue placeholder=\"Select status\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      <SelectItem value=\"harbour-mining\">Harbour Mining</SelectItem>\n                      <SelectItem value=\"coastal-mining\">Coastal Mining</SelectItem>\n                      <SelectItem value=\"world-wide\">World Wide (Foreign Going)</SelectItem>\n                      <SelectItem value=\"oil-field\">Oil Field</SelectItem>\n                      <SelectItem value=\"line-up-mining\">Laid Up</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <div className=\"flex justify-end space-x-2 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={handleClose}\n                disabled={editVesselMutation.isPending}\n                data-testid=\"cancel-edit-vessel\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={editVesselMutation.isPending}\n                data-testid=\"save-vessel-changes\"\n              >\n                {editVesselMutation.isPending && (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                )}\n                Save Changes\n              </Button>\n            </div>\n          </form>\n        </Form>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":9408,"size_tokens":null},"deployment/server/seed.ts":{"content":"import { db } from './db';\nimport { users, vessels, crewMembers, contracts, documents, emailSettings, crewRotations } from '@shared/schema';\n\nasync function seedDatabase() {\n  console.log('üå± Seeding database...');\n\n  try {\n    // Create users\n    const [adminUser] = await db.insert(users).values([\n      {\n        username: 'admin',\n        password: 'admin123',\n        role: 'admin',\n        email: 'admin@crewtrack.com',\n        name: 'System Administrator',\n      }\n    ]).onConflictDoNothing().returning();\n\n    const [officeUser] = await db.insert(users).values([\n      {\n        username: 'office',\n        password: 'demo123',\n        role: 'office_staff',\n        email: 'office@crewtrack.com',\n        name: 'Office Staff',\n      }\n    ]).onConflictDoNothing().returning();\n\n    // Create vessels\n    const vesselData = [\n      { name: \"MV Ocean Explorer\", type: \"Container Ship\", imoNumber: \"IMO1234567\", flag: \"Panama\", status: \"active\" },\n      { name: \"MV Pacific Star\", type: \"Bulk Carrier\", imoNumber: \"IMO2345678\", flag: \"Marshall Islands\", status: \"active\" },\n      { name: \"MV Atlantic Wave\", type: \"Tanker\", imoNumber: \"IMO3456789\", flag: \"Liberia\", status: \"in-port\" },\n      { name: \"MV Nordic Breeze\", type: \"General Cargo\", imoNumber: \"IMO4567890\", flag: \"Norway\", status: \"maintenance\" },\n      { name: \"MV Mediterranean\", type: \"Container Ship\", imoNumber: \"IMO5678901\", flag: \"Malta\", status: \"active\" },\n      { name: \"MV Caribbean Dream\", type: \"Passenger\", imoNumber: \"IMO6789012\", flag: \"Bahamas\", status: \"inactive\" }\n    ];\n\n    const insertedVessels = await db.insert(vessels).values(vesselData).onConflictDoNothing().returning();\n\n    // Create crew members\n    const crewData = [\n      {\n        firstName: \"James\",\n        lastName: \"Anderson\",\n        nationality: \"United Kingdom\",\n        dateOfBirth: new Date(\"1980-05-15\"),\n        rank: \"Captain\",\n        phoneNumber: \"+44-20-1234-5678\",\n        emergencyContact: {\n          name: \"Sarah Anderson\",\n          relationship: \"Spouse\",\n          phone: \"+44-20-8765-4321\",\n          email: \"sarah.anderson@email.com\"\n        },\n        currentVesselId: insertedVessels[0]?.id || null,\n        status: \"active\"\n      },\n      {\n        firstName: \"Miguel\",\n        lastName: \"Santos\",\n        nationality: \"Philippines\",\n        dateOfBirth: new Date(\"1985-08-22\"),\n        rank: \"Chief Engineer\",\n        phoneNumber: \"+63-2-987-6543\",\n        emergencyContact: {\n          name: \"Maria Santos\",\n          relationship: \"Mother\",\n          phone: \"+63-2-123-4567\",\n          email: \"maria.santos@email.com\"\n        },\n        currentVesselId: insertedVessels[1]?.id || null,\n        status: \"active\"\n      },\n      {\n        firstName: \"Anna\",\n        lastName: \"Petrov\",\n        nationality: \"Ukraine\",\n        dateOfBirth: new Date(\"1990-03-10\"),\n        rank: \"Second Officer\",\n        phoneNumber: \"+380-44-555-0123\",\n        emergencyContact: {\n          name: \"Viktor Petrov\",\n          relationship: \"Father\",\n          phone: \"+380-44-555-0456\",\n          email: \"viktor.petrov@email.com\"\n        },\n        currentVesselId: insertedVessels[0]?.id || null,\n        status: \"active\"\n      },\n      {\n        firstName: \"Carlos\",\n        lastName: \"Rodriguez\",\n        nationality: \"Spain\",\n        dateOfBirth: new Date(\"1982-11-28\"),\n        rank: \"Bosun\",\n        phoneNumber: \"+34-91-123-4567\",\n        emergencyContact: {\n          name: \"Elena Rodriguez\",\n          relationship: \"Wife\",\n          phone: \"+34-91-765-4321\",\n          email: \"elena.rodriguez@email.com\"\n        },\n        currentVesselId: insertedVessels[2]?.id || null,\n        status: \"active\"\n      },\n      {\n        firstName: \"Sagar\",\n        lastName: \"Rana\",\n        nationality: \"India\",\n        dateOfBirth: new Date(\"1988-07-14\"),\n        rank: \"Able Seaman\",\n        phoneNumber: \"+91-22-9876-5432\",\n        emergencyContact: {\n          name: \"Priya Rana\",\n          relationship: \"Wife\",\n          phone: \"+91-22-1234-5678\",\n          email: \"priya.rana@email.com\"\n        },\n        currentVesselId: insertedVessels[0]?.id || null,\n        status: \"active\"\n      }\n    ];\n\n    const insertedCrew = await db.insert(crewMembers).values(crewData).onConflictDoNothing().returning();\n\n    // Create active contracts for crew members with upcoming expirations\n    if (insertedCrew.length > 0 && insertedVessels.length > 0) {\n      const contractData = [\n        {\n          crewMemberId: insertedCrew[0].id,\n          vesselId: insertedCrew[0].currentVesselId || insertedVessels[0].id,\n          startDate: new Date(\"2024-01-01\"),\n          endDate: new Date(\"2025-08-18\"), // Expiring in 4 days\n          salary: 5000,\n          currency: \"USD\",\n          status: \"active\" as const\n        },\n        {\n          crewMemberId: insertedCrew[1].id,\n          vesselId: insertedCrew[1].currentVesselId || insertedVessels[1].id,\n          startDate: new Date(\"2024-01-01\"),\n          endDate: new Date(\"2025-08-25\"), // Expiring in 11 days\n          salary: 5500,\n          currency: \"USD\",\n          status: \"active\" as const\n        },\n        ...insertedCrew.slice(2).map((crew, index) => ({\n          crewMemberId: crew.id,\n          vesselId: crew.currentVesselId || insertedVessels[(index + 2) % insertedVessels.length].id,\n          startDate: new Date(\"2024-01-01\"),\n          endDate: new Date(\"2025-12-31\"), // Long-term contracts\n          salary: 5000 + (index * 500),\n          currency: \"USD\",\n          status: \"active\" as const\n        }))\n      ];\n\n      await db.insert(contracts).values(contractData).onConflictDoNothing();\n    }\n\n    // Create sample documents with upcoming expirations\n    if (insertedCrew.length > 0) {\n      const documentData = [\n        {\n          crewMemberId: insertedCrew[0].id,\n          type: \"passport\",\n          documentNumber: \"UK123456789\",\n          issueDate: new Date(\"2020-01-15\"),\n          expiryDate: new Date(\"2025-08-20\"), // Expiring in 6 days\n          issuingAuthority: \"UK Passport Office\",\n          status: \"expiring\"\n        },\n        {\n          crewMemberId: insertedCrew[1].id,\n          type: \"medical\",\n          documentNumber: \"MED-2024-001\",\n          issueDate: new Date(\"2024-01-15\"),\n          expiryDate: new Date(\"2025-08-20\"), // Expiring in 6 days\n          issuingAuthority: \"Philippine Maritime Medical Center\",\n          status: \"expiring\"\n        },\n        {\n          crewMemberId: insertedCrew[2].id,\n          type: \"stcw\",\n          documentNumber: \"STCW-2024-002\",\n          issueDate: new Date(\"2022-01-15\"),\n          expiryDate: new Date(\"2025-08-16\"), // Expiring in 2 days - URGENT\n          issuingAuthority: \"Ukrainian Maritime Authority\",\n          status: \"expiring\"\n        },\n        {\n          crewMemberId: insertedCrew[3].id,\n          type: \"cdc\",\n          documentNumber: \"CDC-ESP-54321\",\n          issueDate: new Date(\"2022-03-10\"),\n          expiryDate: new Date(\"2025-09-05\"), // Expiring in 22 days\n          issuingAuthority: \"Spanish Maritime Authority\",\n          status: \"valid\"\n        },\n        {\n          crewMemberId: insertedCrew[4].id,\n          type: \"medical\",\n          documentNumber: \"MED-IND-2024\",\n          issueDate: new Date(\"2024-02-01\"),\n          expiryDate: new Date(\"2025-08-28\"), // Expiring in 14 days\n          issuingAuthority: \"Directorate General of Shipping, India\",\n          status: \"expiring\"\n        }\n      ];\n\n      await db.insert(documents).values(documentData).onConflictDoNothing();\n    }\n\n    // Create crew rotations with upcoming events\n    if (insertedCrew.length > 0 && insertedVessels.length > 0) {\n      const rotationData = [\n        {\n          crewMemberId: insertedCrew[0].id, // James Anderson\n          vesselId: insertedVessels[0].id,\n          joinDate: new Date(\"2024-01-01\"),\n          leaveDate: new Date(\"2025-08-17\"), // Leaving in 3 days - URGENT\n          rotationType: \"leave\",\n          status: \"scheduled\",\n          notes: \"End of contract - replacement needed urgently\"\n        },\n        {\n          crewMemberId: insertedCrew[2].id, // Anna Petrov\n          vesselId: insertedVessels[1].id,\n          joinDate: new Date(\"2025-08-21\"), // Joining in 7 days\n          leaveDate: new Date(\"2026-02-21\"),\n          rotationType: \"join\",\n          status: \"scheduled\",\n          notes: \"Anna joining as Second Officer\"\n        },\n        {\n          crewMemberId: insertedCrew[3].id, // Carlos Rodriguez\n          vesselId: insertedVessels[2].id,\n          joinDate: new Date(\"2024-01-01\"),\n          leaveDate: new Date(\"2025-09-10\"), // Leaving in 27 days\n          rotationType: \"leave\",\n          status: \"scheduled\",\n          notes: \"Scheduled rotation end\"\n        }\n      ];\n\n      await db.insert(crewRotations).values(rotationData).onConflictDoNothing();\n    }\n\n    // Create email settings\n    await db.insert(emailSettings).values([{\n      reminderDays: [30, 15, 7],\n      enabled: true,\n      recipients: ['office_staff', 'admin'],\n      emailTemplate: \"Dear [Crew Member],\\n\\nYour [Document Type] is scheduled to expire on [Expiry Date]. Please contact your Fleet Administrator to discuss renewal arrangements.\\n\\nBest regards,\\nCrewTrack Pro Team\"\n    }]).onConflictDoNothing();\n\n    console.log('‚úÖ Database seeded successfully!');\n    console.log(`- Created ${insertedVessels.length} vessels`);\n    console.log(`- Created ${insertedCrew.length} crew members`);\n    console.log(`- Created ${insertedCrew.length} active contracts`);\n    console.log('- Created sample documents and email settings');\n\n  } catch (error) {\n    console.error('‚ùå Error seeding database:', error);\n  }\n}\n\nexport { seedDatabase };\n\n// Run seed function if this file is executed directly\nseedDatabase();","path":null,"size_bytes":9761,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"deployment/server/static.js":{"content":"const express = require('express');\nconst path = require('path');\n\nmodule.exports = function configureStatic(app) {\n  if (process.env.NODE_ENV === 'production') {\n    // Serve static files from dist directory\n    app.use(express.static(path.join(__dirname, '../dist')));\n    \n    // Handle client-side routing\n    app.get('*', (req, res, next) => {\n      // Skip API routes\n      if (req.path.startsWith('/api/')) {\n        return next();\n      }\n      res.sendFile(path.join(__dirname, '../dist/index.html'));\n    });\n  }\n};\n","path":null,"size_bytes":526,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/components/modals/whatsapp-settings-modal.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { useMutation, useQuery } from '@tanstack/react-query';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Switch } from '@/components/ui/switch';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Badge } from '@/components/ui/badge';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { MessageCircle, Settings, Phone, Globe, Zap, AlertCircle, CheckCircle } from 'lucide-react';\n\nconst whatsappSettingsSchema = z.object({\n  enabled: z.boolean(),\n  provider: z.enum(['twilio', 'wassenger', 'whapi', 'custom']),\n  apiKey: z.string().optional(),\n  groupId: z.string().optional(),\n  webhookUrl: z.string().url().optional().or(z.literal('')),\n  notificationTypes: z.array(z.string()).default(['contract_expiry', 'document_expiry', 'crew_rotation']),\n  reminderDays: z.array(z.number()).default([7, 3, 1]),\n  messageTemplate: z.string().optional(),\n});\n\ntype WhatsAppSettingsFormData = z.infer<typeof whatsappSettingsSchema>;\n\ninterface WhatsAppSettingsModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nexport default function WhatsAppSettingsModal({ isOpen, onClose }: WhatsAppSettingsModalProps) {\n  const { toast } = useToast();\n  const [testMessageSent, setTestMessageSent] = useState(false);\n\n  // Fetch current settings\n  const { data: settings, isLoading: isLoadingSettings } = useQuery({\n    queryKey: ['/api/whatsapp-settings'],\n    queryFn: async () => {\n      const response = await fetch('/api/whatsapp-settings', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch WhatsApp settings');\n      return response.json();\n    },\n    enabled: isOpen,\n  });\n\n  const form = useForm<WhatsAppSettingsFormData>({\n    resolver: zodResolver(whatsappSettingsSchema),\n    defaultValues: {\n      enabled: false,\n      provider: 'whapi',\n      apiKey: '',\n      groupId: '',\n      webhookUrl: '',\n      notificationTypes: ['contract_expiry', 'document_expiry', 'crew_rotation'],\n      reminderDays: [7, 3, 1],\n      messageTemplate: 'üìã *Crew Management Alert*\\n\\n{{title}}\\n{{description}}\\n\\nDate: {{date}}\\nSeverity: {{severity}}',\n    },\n  });\n\n  // Update form when settings are loaded\n  useEffect(() => {\n    if (settings) {\n      const formData = {\n        enabled: settings.enabled ?? false,\n        provider: settings.provider || 'wassenger',\n        apiKey: settings.apiKey === '***REDACTED***' ? '' : settings.apiKey || '',\n        groupId: settings.groupId || '',\n        webhookUrl: settings.webhookUrl === '***REDACTED***' ? '' : settings.webhookUrl || '',\n        notificationTypes: settings.notificationTypes || ['contract_expiry', 'document_expiry', 'crew_rotation'],\n        reminderDays: settings.reminderDays || [7, 3, 1],\n        messageTemplate: settings.messageTemplate || 'üìã *Crew Management Alert*\\n\\n{{title}}\\n{{description}}\\n\\nDate: {{date}}\\nSeverity: {{severity}}',\n      };\n      form.reset(formData);\n    }\n  }, [settings, form]);\n\n  // Save settings mutation\n  const saveSettingsMutation = useMutation({\n    mutationFn: async (data: WhatsAppSettingsFormData) => {\n      const response = await apiRequest('PUT', '/api/whatsapp-settings', data);\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.message || 'Failed to save settings');\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/whatsapp-settings'] });\n      toast({\n        title: 'Success',\n        description: 'WhatsApp settings saved successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to save WhatsApp settings',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const onSubmit = (data: WhatsAppSettingsFormData) => {\n    // Filter out empty optional fields\n    const cleanData = {\n      ...data,\n      apiKey: data.apiKey || undefined,\n      groupId: data.groupId || undefined,\n      webhookUrl: data.webhookUrl || undefined,\n    };\n    saveSettingsMutation.mutate(cleanData);\n  };\n\n  const extractGroupIdFromLink = (link: string): string => {\n    // WhatsApp group links format: https://chat.whatsapp.com/GROUPID\n    const match = link.match(/https:\\/\\/chat\\.whatsapp\\.com\\/([A-Za-z0-9]+)/);\n    return match ? match[1] : link;\n  };\n\n  const handleGroupLinkChange = (link: string) => {\n    const groupId = extractGroupIdFromLink(link);\n    form.setValue('groupId', groupId);\n  };\n\n  const getProviderInfo = (provider: string) => {\n    switch (provider) {\n      case 'wassenger':\n        return {\n          name: 'Wassenger (7 Days FREE)',\n          icon: MessageCircle,\n          color: 'text-green-600',\n          description: '‚úÖ 7-day free trial - Professional group management',\n          apiKeyLabel: 'API Token',\n          groupIdLabel: 'Group ID',\n          webhookRequired: false,\n        };\n      case 'whapi':\n        return {\n          name: 'WHAPI Cloud (5 Days FREE)',\n          icon: Globe,\n          color: 'text-blue-600',\n          description: '‚úÖ 5 days completely free - No credit card required',\n          apiKeyLabel: 'API Token',\n          groupIdLabel: 'Group ID',\n          webhookRequired: false,\n        };\n      case 'twilio':\n        return {\n          name: 'Twilio (FREE Credits)',\n          icon: Phone,\n          color: 'text-red-600',\n          description: '‚úÖ Free sandbox + credits - Test WhatsApp messaging',\n          apiKeyLabel: 'Auth Token',\n          groupIdLabel: 'Phone Numbers',\n          webhookRequired: false,\n        };\n      case 'custom':\n        return {\n          name: 'Custom/Zixflow (FREE Plan)',\n          icon: Zap,\n          color: 'text-purple-600',\n          description: '‚úÖ Permanent free plans available - Custom integration',\n          apiKeyLabel: 'API Key (optional)',\n          groupIdLabel: 'Group/Chat ID',\n          webhookRequired: true,\n        };\n      default:\n        return {\n          name: 'Unknown',\n          icon: Settings,\n          color: 'text-gray-600',\n          description: '',\n          apiKeyLabel: 'API Key',\n          groupIdLabel: 'Group ID',\n          webhookRequired: false,\n        };\n    }\n  };\n\n  const selectedProvider = form.watch('provider');\n  const providerInfo = getProviderInfo(selectedProvider);\n  const ProviderIcon = providerInfo.icon;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2 text-xl\">\n            <MessageCircle className=\"h-6 w-6 text-green-600\" />\n            WhatsApp Group Notifications\n          </DialogTitle>\n        </DialogHeader>\n\n        <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n          {/* Enable/Disable Toggle */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-sm\">Notification Status</CardTitle>\n            </CardHeader>\n            <CardContent className=\"flex items-center justify-between\">\n              <div className=\"space-y-1\">\n                <Label className=\"text-base font-medium\">Enable WhatsApp Notifications</Label>\n                <p className=\"text-sm text-muted-foreground\">\n                  Automatically send contract and document alerts to your office WhatsApp group\n                </p>\n              </div>\n              <Switch\n                checked={form.watch('enabled')}\n                onCheckedChange={(checked) => form.setValue('enabled', checked)}\n                data-testid=\"whatsapp-enabled-switch\"\n              />\n            </CardContent>\n          </Card>\n\n          {/* Provider Selection */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-sm\">WhatsApp Provider</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label>Select Provider</Label>\n                <Select\n                  value={selectedProvider}\n                  onValueChange={(value) => form.setValue('provider', value as any)}\n                  data-testid=\"provider-select\"\n                >\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"whapi\">\n                      <div className=\"flex items-center gap-2\">\n                        <Globe className=\"h-4 w-4 text-blue-600\" />\n                        <span>WHAPI Cloud (5 Days FREE)</span>\n                        <Badge variant=\"secondary\" className=\"ml-1 text-xs\">FREE</Badge>\n                      </div>\n                    </SelectItem>\n                    <SelectItem value=\"wassenger\">\n                      <div className=\"flex items-center gap-2\">\n                        <MessageCircle className=\"h-4 w-4 text-green-600\" />\n                        <span>Wassenger (7 Days FREE)</span>\n                        <Badge variant=\"secondary\" className=\"ml-1 text-xs\">TRIAL</Badge>\n                      </div>\n                    </SelectItem>\n                    <SelectItem value=\"twilio\">\n                      <div className=\"flex items-center gap-2\">\n                        <Phone className=\"h-4 w-4 text-red-600\" />\n                        <span>Twilio (FREE Credits)</span>\n                        <Badge variant=\"secondary\" className=\"ml-1 text-xs\">FREE</Badge>\n                      </div>\n                    </SelectItem>\n                    <SelectItem value=\"custom\">\n                      <div className=\"flex items-center gap-2\">\n                        <Zap className=\"h-4 w-4 text-purple-600\" />\n                        <span>Custom/Zixflow (FREE Plan)</span>\n                        <Badge variant=\"secondary\" className=\"ml-1 text-xs\">FREE</Badge>\n                      </div>\n                    </SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className={`flex items-center gap-3 p-3 rounded-lg border bg-muted/50`}>\n                <ProviderIcon className={`h-5 w-5 ${providerInfo.color}`} />\n                <div>\n                  <div className=\"font-medium\">{providerInfo.name}</div>\n                  <div className=\"text-sm text-muted-foreground\">{providerInfo.description}</div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* WhatsApp Group Configuration */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-sm\">Group Configuration</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label>WhatsApp Group Link</Label>\n                <div className=\"space-y-2\">\n                  <Input\n                    placeholder=\"https://chat.whatsapp.com/YOUR_GROUP_ID\"\n                    onChange={(e) => handleGroupLinkChange(e.target.value)}\n                    data-testid=\"group-link-input\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Paste your WhatsApp group invite link here. We'll automatically extract the group ID.\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>{providerInfo.groupIdLabel}</Label>\n                <Input\n                  {...form.register('groupId')}\n                  placeholder={selectedProvider === 'twilio' ? '+1234567890,+1234567891' : 'Group ID will appear here'}\n                  data-testid=\"group-id-input\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  {selectedProvider === 'twilio' \n                    ? 'Comma-separated phone numbers (with country code)' \n                    : 'The unique identifier for your WhatsApp group'\n                  }\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* API Configuration */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-sm\">API Configuration</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label>{providerInfo.apiKeyLabel}</Label>\n                <Input\n                  type=\"password\"\n                  {...form.register('apiKey')}\n                  placeholder={`Enter your ${providerInfo.name} ${providerInfo.apiKeyLabel.toLowerCase()}`}\n                  data-testid=\"api-key-input\"\n                />\n              </div>\n\n              {providerInfo.webhookRequired && (\n                <div className=\"space-y-2\">\n                  <Label>Webhook URL</Label>\n                  <Input\n                    {...form.register('webhookUrl')}\n                    placeholder=\"https://your-service.com/webhook\"\n                    data-testid=\"webhook-url-input\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">\n                    Your custom webhook endpoint for receiving notifications\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Notification Settings */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-sm\">Notification Settings</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label>Reminder Days</Label>\n                <div className=\"flex gap-2\">\n                  {[1, 3, 7, 15, 30].map(day => (\n                    <Badge\n                      key={day}\n                      variant={form.watch('reminderDays').includes(day) ? 'default' : 'outline'}\n                      className=\"cursor-pointer\"\n                      onClick={() => {\n                        const current = form.watch('reminderDays');\n                        const updated = current.includes(day)\n                          ? current.filter(d => d !== day)\n                          : [...current, day].sort((a, b) => b - a);\n                        form.setValue('reminderDays', updated);\n                      }}\n                      data-testid={`reminder-day-${day}`}\n                    >\n                      {day} day{day !== 1 ? 's' : ''}\n                    </Badge>\n                  ))}\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Send notifications X days before contract/document expiry\n                </p>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Message Template</Label>\n                <Textarea\n                  {...form.register('messageTemplate')}\n                  rows={4}\n                  placeholder=\"üìã *Crew Management Alert*\\n\\n{{title}}\\n{{description}}\\n\\nDate: {{date}}\\nSeverity: {{severity}}\"\n                  data-testid=\"message-template-input\"\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Use {'{{title}}'}, {'{{description}}'}, {'{{date}}'}, {'{{severity}}'} as placeholders\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Action Buttons */}\n          <div className=\"flex items-center justify-between pt-4 border-t\">\n            <div className=\"flex items-center gap-2\">\n              {form.watch('enabled') && (\n                <div className=\"flex items-center gap-1 text-sm\">\n                  <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                  <span className=\"text-green-600\">Notifications Active</span>\n                </div>\n              )}\n            </div>\n            \n            <div className=\"flex gap-3\">\n              <Button type=\"button\" variant=\"outline\" onClick={onClose}>\n                Cancel\n              </Button>\n              <Button \n                type=\"submit\" \n                disabled={saveSettingsMutation.isPending}\n                data-testid=\"save-settings-button\"\n              >\n                {saveSettingsMutation.isPending ? 'Saving...' : 'Save Settings'}\n              </Button>\n            </div>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":17030,"size_tokens":null},"client/src/components/dashboard/upcoming-events.tsx":{"content":"import { useQuery } from '@tanstack/react-query';\nimport { Link } from 'wouter';\nimport { useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Calendar, User, Ship, GraduationCap, FileText, Wrench, UserPlus, UserMinus, AlertTriangle, ExternalLink, Mail } from 'lucide-react';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface UpcomingEvent {\n  id: string;\n  type: 'contract_expiry' | 'document_expiry' | 'crew_join' | 'crew_leave' | 'maintenance_completion';\n  title: string;\n  description: string;\n  date: string;\n  severity: 'success' | 'info' | 'warning' | 'high';\n  crewMemberId?: string;\n  vesselId?: string;\n  contractId?: string;\n  documentId?: string;\n  documentType?: string;\n  rotationId?: string;\n}\n\nconst severityColors = {\n  success: 'bg-compliance-green',\n  info: 'bg-ocean-blue', \n  warning: 'bg-warning-amber',\n  high: 'bg-alert-red',\n};\n\nconst eventIcons = {\n  contract_expiry: User,\n  document_expiry: FileText,\n  crew_join: UserPlus,\n  crew_leave: UserMinus,\n  maintenance_completion: Wrench,\n};\n\nexport default function UpcomingEvents() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [sendingEmail, setSendingEmail] = useState(false);\n  \n  const { data: events = [], isLoading } = useQuery<UpcomingEvent[]>({\n    queryKey: ['/api/upcoming-events'],\n    queryFn: async () => {\n      const response = await fetch('/api/upcoming-events?days=30&limit=8', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch upcoming events');\n      return response.json();\n    },\n    refetchInterval: 5 * 60 * 1000, // Refresh every 5 minutes\n  });\n\n  const handleSendEmail = async () => {\n    setSendingEmail(true);\n    try {\n      const response = await fetch('/api/email/send-upcoming-events', {\n        method: 'POST',\n        headers: getAuthHeaders(),\n      });\n      \n      if (!response.ok) throw new Error('Failed to send email');\n      \n      const result = await response.json();\n      toast({\n        title: \"Email Sent Successfully\",\n        description: result.message,\n      });\n    } catch (error) {\n      let errorMessage = \"An error occurred\";\n      \n      // Try to parse server response for better error messages\n      if (error instanceof Response) {\n        try {\n          const errorData = await error.json();\n          errorMessage = errorData.message || errorMessage;\n        } catch {\n          errorMessage = error.statusText || errorMessage;\n        }\n      } else if (error instanceof Error) {\n        errorMessage = error.message;\n      }\n      \n      toast({\n        title: \"Failed to Send Email\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    } finally {\n      setSendingEmail(false);\n    }\n  };\n\n  const getEventLink = (event: UpcomingEvent): string => {\n    switch (event.type) {\n      case 'contract_expiry':\n        // Navigate to crew management with specific crew member highlighted\n        return event.crewMemberId ? `/crew?highlight=${event.crewMemberId}` : '/crew';\n      case 'document_expiry':\n        // Navigate to dashboard crew overview with specific crew member highlighted\n        return event.crewMemberId ? `/dashboard?highlight=${event.crewMemberId}` : '/dashboard';\n      case 'crew_join':\n      case 'crew_leave':\n        // Navigate to scheduling page with specific rotation highlighted\n        return event.rotationId ? `/scheduling?highlight=${event.rotationId}` : '/scheduling';\n      case 'maintenance_completion':\n        // Navigate to vessels page with specific vessel highlighted  \n        return event.vesselId ? `/dashboard?vessel=${event.vesselId}` : '/dashboard';\n      default:\n        return '/dashboard';\n    }\n  };\n\n  return (\n    <Card data-testid=\"upcoming-events-card\">\n      <CardHeader className=\"pb-4\">\n        <CardTitle className=\"text-lg font-semibold text-foreground flex items-center justify-between\">\n          <div className=\"flex items-center\">\n            <Calendar className=\"h-5 w-5 mr-2\" />\n            Upcoming Events\n          </div>\n          {!isLoading && events.length > 0 && (\n            <Badge variant=\"outline\" className=\"text-xs\">\n              {events.length} events\n            </Badge>\n          )}\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {isLoading ? (\n          <div className=\"space-y-3\">\n            {Array(3).fill(0).map((_, i) => (\n              <div key={i} className=\"flex items-start space-x-3 p-3\">\n                <div className=\"w-2 h-2 bg-muted rounded-full mt-2 animate-pulse\" />\n                <div className=\"flex-1 space-y-2\">\n                  <div className=\"h-4 bg-muted rounded animate-pulse\" />\n                  <div className=\"h-3 bg-muted rounded w-2/3 animate-pulse\" />\n                </div>\n              </div>\n            ))}\n          </div>\n        ) : events.length === 0 ? (\n          <div className=\"text-center py-6\">\n            <div className=\"mx-auto w-12 h-12 bg-muted rounded-full flex items-center justify-center mb-3\">\n              <Calendar className=\"h-6 w-6 text-muted-foreground\" />\n            </div>\n            <p className=\"text-sm text-muted-foreground\">No upcoming events in the next 30 days</p>\n          </div>\n        ) : (\n          events.map((event) => {\n            const Icon = eventIcons[event.type] || AlertTriangle;\n            const linkTo = getEventLink(event);\n            return (\n              <Link\n                key={event.id}\n                href={linkTo}\n                className=\"block\"\n                data-testid={`event-link-${event.id}`}\n              >\n                <div\n                  className=\"flex items-start space-x-3 p-3 rounded-lg hover:bg-accent transition-colors cursor-pointer group\"\n                  data-testid={`event-${event.id}`}\n                  title={`Click to ${event.type === 'contract_expiry' ? 'renew contract' : event.type === 'document_expiry' ? 'renew document' : event.type.includes('crew') ? 'manage rotation' : 'manage'}: ${event.description}`}\n                >\n                  <div className={`w-2 h-2 ${severityColors[event.severity]} rounded-full mt-2 flex-shrink-0`} />\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center space-x-2\">\n                      <Icon className=\"h-4 w-4 text-secondary-foreground flex-shrink-0\" />\n                      <p className=\"text-sm font-medium text-foreground truncate group-hover:text-primary transition-colors\" data-testid=\"event-title\">\n                        {event.title}\n                      </p>\n                      {event.severity === 'high' && (\n                        <Badge variant=\"destructive\" className=\"text-xs px-1 py-0.5\">\n                          Urgent\n                        </Badge>\n                      )}\n                      <Badge variant=\"secondary\" className=\"text-xs px-1 py-0.5 opacity-0 group-hover:opacity-100 transition-opacity\">\n                        Click to manage\n                      </Badge>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground mt-1 group-hover:text-secondary-foreground transition-colors\" data-testid=\"event-description\">\n                      {event.description}\n                    </p>\n                  </div>\n                  <ExternalLink className=\"h-3 w-3 text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity mt-2 flex-shrink-0\" />\n                </div>\n              </Link>\n            );\n          })\n        )}\n        {events.length > 0 && (\n          <div className=\"pt-2 border-t\">\n            <div className=\"flex items-center justify-between\">\n              <p className=\"text-xs text-muted-foreground\">\n                Auto-refreshes every 5 minutes ‚Ä¢ Showing next 30 days\n              </p>\n              {user?.role === 'admin' && (\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  onClick={handleSendEmail}\n                  disabled={sendingEmail}\n                  data-testid=\"send-events-email-btn\"\n                  className=\"h-6 px-2 text-xs\"\n                >\n                  <Mail className=\"h-3 w-3 mr-1\" />\n                  {sendingEmail ? 'Sending...' : 'Send Email'}\n                </Button>\n              )}\n            </div>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":8669,"size_tokens":null},"client/src/pages/scheduling.tsx":{"content":"import { useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Calendar, Ship, Printer, AlertTriangle, Clock, User, Mail, Loader2 } from 'lucide-react';\nimport { useMutation } from '@tanstack/react-query';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { format, isSameDay, isSameMonth, startOfMonth, endOfMonth, eachDayOfInterval, addMonths, subMonths, addDays, differenceInDays } from 'date-fns';\nimport { cn } from '@/lib/utils';\n\ninterface ContractEvent {\n  id: string;\n  type: 'contract_due' | 'contract_expired';\n  date: Date;\n  crewMemberId: string;\n  crewMemberName: string;\n  vesselId: string;\n  vesselName: string;\n  contractId: string;\n  contractEndDate: Date;\n  daysUntilExpiry: number;\n}\n\nexport default function Scheduling() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [currentDate, setCurrentDate] = useState(new Date());\n  const [selectedDate, setSelectedDate] = useState<Date | null>(null);\n  const [selectedEvents, setSelectedEvents] = useState<ContractEvent[]>([]);\n  const [emailDialogOpen, setEmailDialogOpen] = useState(false);\n  const [sendToAdditional, setSendToAdditional] = useState(false);\n  const [additionalEmail, setAdditionalEmail] = useState('');\n\n  const sendCalendarEmailMutation = useMutation({\n    mutationFn: async (data: { month: string; events: ContractEvent[]; additionalEmail?: string }) => {\n      const response = await apiRequest('POST', '/api/email/send-calendar-summary', data);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setEmailDialogOpen(false);\n      setAdditionalEmail('');\n      setSendToAdditional(false);\n      toast({\n        title: \"Email Sent\",\n        description: data.message || \"Calendar summary sent successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Email Failed\",\n        description: error.message || \"Failed to send calendar summary.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSendEmail = () => {\n    const monthStr = format(currentDate, 'MMMM yyyy');\n    sendCalendarEmailMutation.mutate({ \n      month: monthStr, \n      events: monthEvents.map(e => ({\n        ...e,\n        date: e.date.toISOString(),\n        contractEndDate: e.contractEndDate.toISOString(),\n      })) as any,\n      additionalEmail: sendToAdditional && additionalEmail ? additionalEmail : undefined\n    });\n  };\n\n  const { data: contracts, isLoading: contractsLoading } = useQuery({\n    queryKey: ['/api/contracts'],\n    queryFn: async () => {\n      const response = await fetch('/api/contracts', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch contracts');\n      return response.json();\n    },\n  });\n\n  const { data: crewMembers } = useQuery({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n  });\n\n  const { data: vessels } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  if (user?.role === 'crew') {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"text-center py-12\">\n          <Calendar className=\"h-16 w-16 mx-auto text-gray-300 mb-4\" />\n          <h2 className=\"text-2xl font-semibold text-foreground mb-2\">Access Restricted</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            Crew members can view their schedule information on the dashboard.\n          </p>\n          <Button\n            onClick={() => window.location.href = '/dashboard'}\n            className=\"bg-primary hover:bg-primary/90\"\n          >\n            Go to Dashboard\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  const getCrewMemberName = (crewMemberId: string) => {\n    const member = crewMembers?.find((m: any) => m.id === crewMemberId);\n    return member ? `${member.firstName} ${member.lastName}` : 'Unknown';\n  };\n\n  const getVesselName = (vesselId: string) => {\n    const vessel = vessels?.find((v: any) => v.id === vesselId);\n    return vessel ? vessel.name : 'Unknown';\n  };\n\n  // Generate contract events from contracts data\n  // Contract Due = 45 days before end date\n  // Contract Expired = end date\n  const contractEvents: ContractEvent[] = (contracts || []).flatMap((contract: any) => {\n    const events: ContractEvent[] = [];\n    const endDate = new Date(contract.endDate);\n    const today = new Date();\n    const daysUntilExpiry = differenceInDays(endDate, today);\n    \n    // Contract Due date (45 days before end date)\n    const dueDate = addDays(endDate, -45);\n    \n    // Add Contract Due event for all contracts\n    events.push({\n      id: `${contract.id}-due`,\n      type: 'contract_due',\n      date: dueDate,\n      crewMemberId: contract.crewMemberId,\n      crewMemberName: getCrewMemberName(contract.crewMemberId),\n      vesselId: contract.vesselId,\n      vesselName: getVesselName(contract.vesselId),\n      contractId: contract.id,\n      contractEndDate: endDate,\n      daysUntilExpiry: daysUntilExpiry,\n    });\n    \n    // Add Contract Expired event for all contracts\n    events.push({\n      id: `${contract.id}-expired`,\n      type: 'contract_expired',\n      date: endDate,\n      crewMemberId: contract.crewMemberId,\n      crewMemberName: getCrewMemberName(contract.crewMemberId),\n      vesselId: contract.vesselId,\n      vesselName: getVesselName(contract.vesselId),\n      contractId: contract.id,\n      contractEndDate: endDate,\n      daysUntilExpiry: daysUntilExpiry,\n    });\n    \n    return events;\n  });\n\n  const monthStart = startOfMonth(currentDate);\n  const monthEnd = endOfMonth(currentDate);\n  const calendarDays = eachDayOfInterval({ start: monthStart, end: monthEnd });\n  const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n\n  const getEventsForDate = (date: Date) => {\n    return contractEvents.filter(event => isSameDay(event.date, date));\n  };\n\n  const getEventColor = (type: string) => {\n    switch (type) {\n      case 'contract_due': return 'bg-warning-amber';\n      case 'contract_expired': return 'bg-red-500';\n      default: return 'bg-gray-500';\n    }\n  };\n\n  const handleDateClick = (date: Date) => {\n    const dayEvents = getEventsForDate(date);\n    if (dayEvents.length > 0) {\n      setSelectedDate(date);\n      setSelectedEvents(dayEvents);\n    }\n  };\n\n  const previousMonth = () => {\n    setCurrentDate(prev => subMonths(prev, 1));\n  };\n\n  const nextMonth = () => {\n    setCurrentDate(prev => addMonths(prev, 1));\n  };\n\n  // Get events for current month\n  const monthEvents = contractEvents.filter(event => isSameMonth(event.date, currentDate));\n\n  // Count stats for current month view\n  const monthDueCount = monthEvents.filter(e => e.type === 'contract_due').length;\n  const monthExpiredCount = monthEvents.filter(e => e.type === 'contract_expired').length;\n  const thisMonthCount = monthEvents.length;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n        <div>\n          <h2 className=\"text-3xl font-bold text-foreground mb-2\" data-testid=\"scheduling-title\">\n            Contract Calendar\n          </h2>\n          <p className=\"text-muted-foreground\">\n            View upcoming contract due dates and expirations\n          </p>\n        </div>\n        \n        <div className=\"flex gap-2 print:hidden\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => setEmailDialogOpen(true)}\n            className=\"h-8\"\n            data-testid=\"mail-calendar-button\"\n          >\n            <Mail className=\"h-4 w-4 mr-2\" />\n            Mail\n          </Button>\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => window.print()}\n            className=\"h-8\"\n            data-testid=\"print-calendar-button\"\n          >\n            <Printer className=\"h-4 w-4 mr-2\" />\n            Print\n          </Button>\n        </div>\n      </div>\n\n      {/* Quick Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Contracts Due Soon</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <Clock className=\"h-5 w-5 text-warning-amber\" />\n              <span className=\"text-2xl font-bold text-foreground\" data-testid=\"contracts-due-count\">\n                {monthDueCount}\n              </span>\n              <span className=\"text-sm text-muted-foreground\">this month</span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Contracts Expired</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <AlertTriangle className=\"h-5 w-5 text-red-500\" />\n              <span className=\"text-2xl font-bold text-foreground\" data-testid=\"contracts-expired-count\">\n                {monthExpiredCount}\n              </span>\n              <span className=\"text-sm text-muted-foreground\">this month</span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total Events</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <Calendar className=\"h-5 w-5 text-primary\" />\n              <span className=\"text-2xl font-bold text-foreground\" data-testid=\"month-events-count\">\n                {thisMonthCount}\n              </span>\n              <span className=\"text-sm text-muted-foreground\">this month</span>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Legend */}\n      <div className=\"flex flex-wrap items-center gap-4 text-sm\">\n        <div className=\"flex items-center space-x-2\">\n          <div className=\"w-3 h-3 bg-warning-amber rounded-full\"></div>\n          <span className=\"text-muted-foreground\">Contract Due (45 days before expiry)</span>\n        </div>\n        <div className=\"flex items-center space-x-2\">\n          <div className=\"w-3 h-3 bg-red-500 rounded-full\"></div>\n          <span className=\"text-muted-foreground\">Contract Expired</span>\n        </div>\n      </div>\n\n      {/* Content */}\n      <Card className=\"print:border-0 print:shadow-none\">\n        <CardHeader className=\"flex flex-row items-center justify-between print:hidden\">\n          <CardTitle className=\"text-foreground\">Contract Calendar</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {contractsLoading ? (\n            <div className=\"h-96 bg-muted rounded-lg animate-pulse flex items-center justify-center\">\n              <p className=\"text-muted-foreground\">Loading...</p>\n            </div>\n          ) : (\n            <div className=\"space-y-4 print-calendar-container\">\n              {/* Print Styles */}\n              <style>{`\n                @media print {\n                  @page {\n                    margin: 0.5in;\n                    size: portrait;\n                  }\n                  body {\n                    -webkit-print-color-adjust: exact;\n                    print-color-adjust: exact;\n                  }\n                  /* Hide sidebar and navigation */\n                  aside, nav, header, .sidebar, [class*=\"sidebar\"], [class*=\"nav-\"] {\n                    display: none !important;\n                  }\n                  /* Reset main layout to full width centered */\n                  main, .main-content, [class*=\"main\"] {\n                    margin-left: 0 !important;\n                    padding-left: 0 !important;\n                    width: 100% !important;\n                  }\n                  body > div {\n                    display: block !important;\n                  }\n                  .print-calendar-container {\n                    position: absolute !important;\n                    left: 0 !important;\n                    right: 0 !important;\n                    top: 0 !important;\n                    width: 100% !important;\n                    max-width: 100% !important;\n                    margin: 0 auto !important;\n                    padding: 0 !important;\n                  }\n                  .print-hide-btn {\n                    display: none !important;\n                  }\n                  .print-report {\n                    display: block !important;\n                    margin-top: 200px;\n                    padding-top: 100px;\n                    clear: both;\n                    position: relative;\n                  }\n                  .print-report .print-table {\n                    page-break-inside: auto;\n                  }\n                  .print-report .print-table tr {\n                    page-break-inside: avoid;\n                    page-break-after: auto;\n                  }\n                  .print-report .print-section-title {\n                    font-size: 16px;\n                    font-weight: 600;\n                    color: #1a365d;\n                    margin-bottom: 16px;\n                    padding-bottom: 8px;\n                    border-bottom: 1px solid #e2e8f0;\n                    background: white;\n                  }\n                  .print-report .print-table {\n                    width: 100%;\n                    border-collapse: collapse;\n                    font-size: 11px;\n                  }\n                  .print-report .print-table th {\n                    background-color: #f7fafc;\n                    font-weight: 600;\n                    text-align: left;\n                    padding: 8px 12px;\n                    border: 1px solid #e2e8f0;\n                    color: #1a365d;\n                  }\n                  .print-report .print-table td {\n                    padding: 6px 12px;\n                    border: 1px solid #e2e8f0;\n                    color: #2d3748;\n                  }\n                  .print-report .print-table tr:nth-child(even) td {\n                    background-color: #f7fafc;\n                  }\n                  .print-report .event-badge {\n                    display: inline-block;\n                    padding: 2px 6px;\n                    border-radius: 3px;\n                    font-size: 10px;\n                    font-weight: 500;\n                  }\n                  .print-report .event-badge.due {\n                    background-color: #fef3c7;\n                    color: #92400e;\n                  }\n                  .print-report .event-badge.expired {\n                    background-color: #fee2e2;\n                    color: #991b1b;\n                  }\n                  .print-footer {\n                    margin-top: 20px;\n                    padding-top: 8px;\n                    border-top: 1px solid #e2e8f0;\n                    font-size: 9px;\n                    color: #718096;\n                    text-align: center;\n                  }\n                  .print-no-events {\n                    text-align: center;\n                    padding: 20px;\n                    color: #718096;\n                    font-style: italic;\n                    font-size: 12px;\n                  }\n                }\n              `}</style>\n\n              {/* Calendar Header */}\n              <div className=\"flex items-center justify-between mb-4\">\n                <div className=\"flex items-center space-x-4\">\n                  <Button variant=\"outline\" size=\"sm\" onClick={previousMonth} data-testid=\"prev-month-button\" className=\"print-hide-btn\">\n                    <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" /></svg>\n                  </Button>\n                  <h3 className=\"text-xl font-semibold text-foreground\" data-testid=\"current-month\">\n                    {format(currentDate, 'MMMM yyyy')}\n                  </h3>\n                  <Button variant=\"outline\" size=\"sm\" onClick={nextMonth} data-testid=\"next-month-button\" className=\"print-hide-btn\">\n                    <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" /></svg>\n                  </Button>\n                </div>\n              </div>\n\n              {/* Calendar Grid */}\n              <div className=\"bg-card rounded-lg border border-border\">\n                {/* Week Headers */}\n                <div className=\"grid grid-cols-7 border-b border-border\">\n                  {weekDays.map((day) => (\n                    <div\n                      key={day}\n                      className=\"p-3 text-center text-sm font-medium text-muted-foreground bg-muted\"\n                    >\n                      {day}\n                    </div>\n                  ))}\n                </div>\n\n                {/* Calendar Days */}\n                <div className=\"grid grid-cols-7\">\n                  {calendarDays.map((day) => {\n                    const dayEvents = getEventsForDate(day);\n                    const isCurrentMonth = isSameMonth(day, currentDate);\n                    const isToday = isSameDay(day, new Date());\n                    \n                    return (\n                      <div\n                        key={day.toString()}\n                        className={cn(\n                          'min-h-24 p-2 border-r border-b border-border hover:bg-muted cursor-pointer transition-colors',\n                          !isCurrentMonth && 'bg-muted text-muted-foreground',\n                          isToday && 'bg-primary/10 text-primary'\n                        )}\n                        onClick={() => handleDateClick(day)}\n                        data-testid={`calendar-day-${format(day, 'yyyy-MM-dd')}`}\n                      >\n                        <div className={cn(\n                          'text-sm font-medium mb-1 text-foreground',\n                          isToday && 'font-bold',\n                          !isCurrentMonth && 'text-muted-foreground'\n                        )}>\n                          {format(day, 'd')}\n                        </div>\n                        \n                        {/* Event Indicators */}\n                        <div className=\"space-y-1\">\n                          {dayEvents.slice(0, 3).map((event) => (\n                            <div\n                              key={event.id}\n                              className={cn(\n                                'w-full h-1.5 rounded-full',\n                                getEventColor(event.type)\n                              )}\n                              title={event.type === 'contract_due' ? 'Contract Due' : 'Contract Expired'}\n                              data-testid={`event-indicator-${event.id}`}\n                            />\n                          ))}\n                          {dayEvents.length > 3 && (\n                            <div className=\"text-xs text-muted-foreground\">\n                              +{dayEvents.length - 3} more\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n\n              {/* Crew Details for Print - Only shows when there are events */}\n              {monthEvents.length > 0 && (\n                <div className=\"hidden print:block print-report\">\n                  <h4 className=\"print-section-title\">\n                    Crew Contract Events - {format(currentDate, 'MMMM yyyy')}\n                  </h4>\n                  \n                  <table className=\"print-table\">\n                    <thead>\n                      <tr>\n                        <th>Crew Member</th>\n                        <th>Vessel</th>\n                        <th>Status</th>\n                        <th>Date</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {monthEvents.map((event) => (\n                        <tr key={event.id}>\n                          <td>{event.crewMemberName}</td>\n                          <td>{event.vesselName}</td>\n                          <td>\n                            <span className={`event-badge ${event.type === 'contract_due' ? 'due' : 'expired'}`}>\n                              {event.type === 'contract_due' ? 'Due Soon' : 'Expired'}\n                            </span>\n                          </td>\n                          <td>{format(event.date, 'MMM d, yyyy')}</td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                  \n                  <div className=\"print-footer\">\n                    Generated on {format(new Date(), 'MMMM d, yyyy')} | Total Events: {monthEvents.length}\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Event Details Modal */}\n      <Dialog open={!!selectedDate} onOpenChange={() => setSelectedDate(null)}>\n        <DialogContent className=\"max-w-md max-h-[80vh] overflow-y-auto print:hidden\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center space-x-2\">\n              <Calendar className=\"h-5 w-5 text-primary\" />\n              <span>\n                Events for {selectedDate && format(selectedDate, 'MMMM d, yyyy')}\n              </span>\n            </DialogTitle>\n          </DialogHeader>\n          \n          <div className=\"space-y-3 max-h-[60vh] overflow-y-auto pr-2\">\n            {selectedEvents.length === 0 ? (\n              <p className=\"text-muted-foreground text-center py-4\">No events on this date</p>\n            ) : (\n              selectedEvents.map((event) => (\n                <div\n                  key={event.id}\n                  className={cn(\n                    \"p-3 border rounded-lg\",\n                    event.type === 'contract_expired' \n                      ? \"border-red-200 bg-red-50 dark:bg-red-950/20 dark:border-red-800\"\n                      : \"border-amber-200 bg-amber-50 dark:bg-amber-950/20 dark:border-amber-800\"\n                  )}\n                  data-testid={`modal-event-${event.id}`}\n                >\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <h4 className=\"font-medium text-foreground\">\n                      {event.type === 'contract_due' ? 'Contract Due' : 'Contract Expired'}\n                    </h4>\n                    <Badge className={cn(\n                      \"text-white\",\n                      event.type === 'contract_expired' ? \"bg-red-500\" : \"bg-warning-amber\"\n                    )}>\n                      {event.type === 'contract_due' ? 'DUE' : 'EXPIRED'}\n                    </Badge>\n                  </div>\n                  \n                  <div className=\"space-y-1 text-sm text-muted-foreground\">\n                    <div className=\"flex items-center space-x-2\">\n                      <User className=\"h-3 w-3 shrink-0\" />\n                      <span className=\"break-words\">Crew Member: {event.crewMemberName}</span>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Ship className=\"h-3 w-3 shrink-0\" />\n                      <span className=\"break-words\">Vessel: {event.vesselName}</span>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Calendar className=\"h-3 w-3 shrink-0\" />\n                      <span>Contract End: {format(event.contractEndDate, 'MMM dd, yyyy')}</span>\n                    </div>\n                  </div>\n                </div>\n              ))\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Email Send Dialog */}\n      <Dialog open={emailDialogOpen} onOpenChange={setEmailDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Mail className=\"h-5 w-5\" />\n              Send Calendar Summary\n            </DialogTitle>\n            <DialogDescription>\n              Send the contract calendar summary for {format(currentDate, 'MMMM yyyy')} via email.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"flex items-center space-x-2\">\n              <Checkbox \n                id=\"send-additional\"\n                checked={sendToAdditional}\n                onCheckedChange={(checked) => setSendToAdditional(checked === true)}\n                data-testid=\"checkbox-additional-email\"\n              />\n              <Label htmlFor=\"send-additional\" className=\"text-sm font-medium cursor-pointer\">\n                Also send to an additional email address\n              </Label>\n            </div>\n            \n            {sendToAdditional && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"additional-email\">Additional Email Addresses</Label>\n                <Input\n                  id=\"additional-email\"\n                  type=\"text\"\n                  placeholder=\"Enter email addresses (separate with commas)\"\n                  value={additionalEmail}\n                  onChange={(e) => setAdditionalEmail(e.target.value)}\n                  data-testid=\"input-additional-email\"\n                />\n                <p className=\"text-xs text-muted-foreground\">You can add multiple emails separated by commas</p>\n              </div>\n            )}\n          </div>\n          \n          <DialogFooter className=\"gap-2\">\n            <Button \n              variant=\"outline\" \n              onClick={() => {\n                setEmailDialogOpen(false);\n                setAdditionalEmail('');\n                setSendToAdditional(false);\n              }}\n              data-testid=\"button-cancel-email\"\n            >\n              Cancel\n            </Button>\n            <Button \n              onClick={handleSendEmail}\n              disabled={sendCalendarEmailMutation.isPending || (sendToAdditional && !additionalEmail)}\n              data-testid=\"button-send-email\"\n            >\n              {sendCalendarEmailMutation.isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Sending...\n                </>\n              ) : (\n                <>\n                  <Mail className=\"h-4 w-4 mr-2\" />\n                  Send Email\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":27874,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":23567,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"server/services/sendgrid-service.ts":{"content":"import { MailService } from '@sendgrid/mail';\n\nif (!process.env.SENDGRID_API_KEY) {\n  throw new Error(\"SENDGRID_API_KEY environment variable must be set\");\n}\n\nconst mailService = new MailService();\nmailService.setApiKey(process.env.SENDGRID_API_KEY);\n\ninterface EmailParams {\n  to: string;\n  from: string;\n  subject: string;\n  text?: string;\n  html?: string;\n}\n\nexport interface CrewNotificationData {\n  crewName: string;\n  vesselName?: string;\n  contractEndDate?: Date;\n  documentType?: string;\n  documentExpiryDate?: Date;\n  alertType: 'contract_expiry' | 'document_expiry' | 'crew_rotation';\n  daysUntilExpiry: number;\n}\n\nexport async function sendEmail(params: EmailParams): Promise<boolean> {\n  try {\n    await mailService.send({\n      to: params.to,\n      from: params.from,\n      subject: params.subject,\n      text: params.text,\n      html: params.html,\n    });\n    console.log(`‚úÖ Email sent successfully to ${params.to}`);\n    return true;\n  } catch (error) {\n    console.error('‚ùå SendGrid email error:', error);\n    return false;\n  }\n}\n\nexport function generateContractExpiryEmail(data: CrewNotificationData): { subject: string; html: string; text: string } {\n  const subject = `üö® Contract Expiry Alert - ${data.crewName} (${data.daysUntilExpiry} days)`;\n  \n  const html = `\n    <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n      <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n        <div style=\"text-align: center; margin-bottom: 30px;\">\n          <h1 style=\"color: #dc3545; margin: 0; font-size: 24px;\">‚ö†Ô∏è Contract Expiry Alert</h1>\n          <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Crew Management System Notification</p>\n        </div>\n        \n        <div style=\"background: #fff5f5; border-left: 4px solid #dc3545; padding: 20px; margin: 20px 0;\">\n          <h3 style=\"margin: 0 0 15px 0; color: #dc3545;\">Contract Expiring Soon</h3>\n          <table style=\"width: 100%; border-collapse: collapse;\">\n            <tr>\n              <td style=\"padding: 8px 0; font-weight: bold; color: #495057;\">Crew Member:</td>\n              <td style=\"padding: 8px 0; color: #212529;\">${data.crewName}</td>\n            </tr>\n            ${data.vesselName ? `\n            <tr>\n              <td style=\"padding: 8px 0; font-weight: bold; color: #495057;\">Vessel:</td>\n              <td style=\"padding: 8px 0; color: #212529;\">${data.vesselName}</td>\n            </tr>` : ''}\n            ${data.contractEndDate ? `\n            <tr>\n              <td style=\"padding: 8px 0; font-weight: bold; color: #495057;\">Contract End Date:</td>\n              <td style=\"padding: 8px 0; color: #dc3545; font-weight: bold;\">${data.contractEndDate.toLocaleDateString()}</td>\n            </tr>` : ''}\n            <tr>\n              <td style=\"padding: 8px 0; font-weight: bold; color: #495057;\">Days Remaining:</td>\n              <td style=\"padding: 8px 0; color: #dc3545; font-weight: bold; font-size: 18px;\">${data.daysUntilExpiry} days</td>\n            </tr>\n          </table>\n        </div>\n        \n        <div style=\"background: #e7f3ff; border: 1px solid #b3d7ff; padding: 15px; border-radius: 4px; margin: 20px 0;\">\n          <p style=\"margin: 0; color: #0066cc;\">\n            <strong>Action Required:</strong> Please review and renew the contract before it expires to avoid service disruption.\n          </p>\n        </div>\n        \n        <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;\">\n          <p style=\"color: #6c757d; font-size: 14px; margin: 0;\">\n            This is an automated notification from your Crew Management System\n          </p>\n        </div>\n      </div>\n    </div>\n  `;\n  \n  const text = `\nüö® CONTRACT EXPIRY ALERT\n\nCrew Member: ${data.crewName}\n${data.vesselName ? `Vessel: ${data.vesselName}` : ''}\n${data.contractEndDate ? `Contract End Date: ${data.contractEndDate.toLocaleDateString()}` : ''}\nDays Remaining: ${data.daysUntilExpiry} days\n\nACTION REQUIRED: Please review and renew the contract before it expires.\n\nThis is an automated notification from your Crew Management System.\n  `;\n  \n  return { subject, html, text };\n}\n\nexport function generateDocumentExpiryEmail(data: CrewNotificationData): { subject: string; html: string; text: string } {\n  const subject = `üìÑ Document Expiry Alert - ${data.crewName} ${data.documentType} (${data.daysUntilExpiry} days)`;\n  \n  const html = `\n    <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n      <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n        <div style=\"text-align: center; margin-bottom: 30px;\">\n          <h1 style=\"color: #ffc107; margin: 0; font-size: 24px;\">üìÑ Document Expiry Alert</h1>\n          <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Crew Management System Notification</p>\n        </div>\n        \n        <div style=\"background: #fffbf0; border-left: 4px solid #ffc107; padding: 20px; margin: 20px 0;\">\n          <h3 style=\"margin: 0 0 15px 0; color: #856404;\">Document Expiring Soon</h3>\n          <table style=\"width: 100%; border-collapse: collapse;\">\n            <tr>\n              <td style=\"padding: 8px 0; font-weight: bold; color: #495057;\">Crew Member:</td>\n              <td style=\"padding: 8px 0; color: #212529;\">${data.crewName}</td>\n            </tr>\n            ${data.documentType ? `\n            <tr>\n              <td style=\"padding: 8px 0; font-weight: bold; color: #495057;\">Document Type:</td>\n              <td style=\"padding: 8px 0; color: #212529;\">${data.documentType}</td>\n            </tr>` : ''}\n            ${data.documentExpiryDate ? `\n            <tr>\n              <td style=\"padding: 8px 0; font-weight: bold; color: #495057;\">Expiry Date:</td>\n              <td style=\"padding: 8px 0; color: #ffc107; font-weight: bold;\">${data.documentExpiryDate.toLocaleDateString()}</td>\n            </tr>` : ''}\n            <tr>\n              <td style=\"padding: 8px 0; font-weight: bold; color: #495057;\">Days Remaining:</td>\n              <td style=\"padding: 8px 0; color: #ffc107; font-weight: bold; font-size: 18px;\">${data.daysUntilExpiry} days</td>\n            </tr>\n          </table>\n        </div>\n        \n        <div style=\"background: #e7f3ff; border: 1px solid #b3d7ff; padding: 15px; border-radius: 4px; margin: 20px 0;\">\n          <p style=\"margin: 0; color: #0066cc;\">\n            <strong>Action Required:</strong> Please renew or update this document before it expires to maintain compliance.\n          </p>\n        </div>\n        \n        <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;\">\n          <p style=\"color: #6c757d; font-size: 14px; margin: 0;\">\n            This is an automated notification from your Crew Management System\n          </p>\n        </div>\n      </div>\n    </div>\n  `;\n  \n  const text = `\nüìÑ DOCUMENT EXPIRY ALERT\n\nCrew Member: ${data.crewName}\n${data.documentType ? `Document Type: ${data.documentType}` : ''}\n${data.documentExpiryDate ? `Expiry Date: ${data.documentExpiryDate.toLocaleDateString()}` : ''}\nDays Remaining: ${data.daysUntilExpiry} days\n\nACTION REQUIRED: Please renew or update this document before it expires.\n\nThis is an automated notification from your Crew Management System.\n  `;\n  \n  return { subject, html, text };\n}","path":null,"size_bytes":7491,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { AuthProvider } from \"./contexts/auth-context\";\nimport { ThemeProvider } from \"./contexts/theme-context\";\nimport { ExtractedRecordsProvider } from \"./contexts/extracted-records-context\";\nimport NotFound from \"@/pages/not-found\";\nimport Dashboard from \"@/pages/dashboard\";\nimport CrewManagement from \"@/pages/crew-management\";\nimport FleetManagement from \"@/pages/fleet-management\";\nimport Scheduling from \"@/pages/scheduling\";\nimport Documents from \"@/pages/documents\";\nimport StatusHistory from \"@/pages/status-history\";\nimport Settings from \"@/pages/settings\";\nimport Notifications from \"@/pages/notifications\";\nimport AppLayout from \"@/components/layout/app-layout\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Dashboard} />\n      <Route path=\"/dashboard\" component={Dashboard} />\n      <Route path=\"/crew\" component={CrewManagement} />\n      <Route path=\"/fleet\" component={FleetManagement} />\n      <Route path=\"/scheduling\" component={Scheduling} />\n      <Route path=\"/documents\" component={Documents} />\n      <Route path=\"/status-history\" component={StatusHistory} />\n      <Route path=\"/settings\" component={Settings} />\n      <Route path=\"/notifications\" component={Notifications} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider>\n        <TooltipProvider>\n          <AuthProvider>\n            <ExtractedRecordsProvider>\n              <AppLayout>\n                <Toaster />\n                <Router />\n              </AppLayout>\n            </ExtractedRecordsProvider>\n          </AuthProvider>\n        </TooltipProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":2022,"size_tokens":null},"client/src/pages/dashboard.tsx":{"content":"import { useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Link } from 'wouter';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { format } from 'date-fns';\nimport * as XLSX from 'xlsx';\nimport StatsCard from '@/components/dashboard/stats-card';\nimport UpcomingEvents from '@/components/dashboard/upcoming-events';\nimport CrewTable from '@/components/crew/crew-table';\nimport VesselCards from '@/components/vessels/vessel-cards';\nimport ExpiryAlertCard from '@/components/alerts/expiry-alert-card';\nimport AddContractForm from '@/components/crew/add-contract-form';\nimport { Button } from '@/components/ui/button';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { AlertTriangle, FileText, Download, Calendar, Plus } from 'lucide-react';\nimport { DashboardStats } from '@/types';\n\nexport default function Dashboard() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [showAddContractForm, setShowAddContractForm] = useState(false);\n\n\n  const { data: stats, isLoading: statsLoading } = useQuery<DashboardStats>({\n    queryKey: ['/api/dashboard/stats'],\n    queryFn: async () => {\n      const response = await fetch('/api/dashboard/stats', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch stats');\n      return response.json();\n    },\n    refetchInterval: 10000, // Auto-refresh every 10 seconds\n  });\n\n  const { data: expiringDocuments, isLoading: alertsLoading } = useQuery({\n    queryKey: ['/api/alerts/expiring-documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/alerts/expiring-documents?days=30', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch alerts');\n      return response.json();\n    },\n    refetchInterval: 30000, // Refresh every 30 seconds\n  });\n\n  // Fetch crew data for export\n  const { data: crewMembers } = useQuery({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n    refetchInterval: 10000, // Auto-refresh every 10 seconds\n  });\n\n  // Fetch vessels data for export\n  const { data: vessels } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n    refetchInterval: 10000, // Auto-refresh every 10 seconds\n  });\n\n  // Fetch contracts data for export\n  const { data: contracts } = useQuery({\n    queryKey: ['/api/contracts'],\n    queryFn: async () => {\n      const response = await fetch('/api/contracts', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch contracts');\n      return response.json();\n    },\n    refetchInterval: 10000, // Auto-refresh every 10 seconds\n  });\n\n  // Fetch documents data for export\n  const { data: documents } = useQuery({\n    queryKey: ['/api/documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/documents', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch documents');\n      return response.json();\n    },\n    refetchInterval: 10000, // Auto-refresh every 10 seconds\n  });\n\n  // Fetch rotations data for export\n  const { data: rotations } = useQuery({\n    queryKey: ['/api/rotations'],\n    queryFn: async () => {\n      const response = await fetch('/api/rotations', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch rotations');\n      return response.json();\n    },\n    refetchInterval: 10000, // Auto-refresh every 10 seconds\n  });\n\n  const exportCrewByVessel = () => {\n    try {\n      if (!crewMembers || crewMembers.length === 0) {\n        toast({\n          title: 'No Data',\n          description: 'No crew members found to export',\n          variant: 'destructive',\n        });\n        return;\n      }\n\n      if (!vessels || vessels.length === 0) {\n        toast({\n          title: 'No Data',\n          description: 'No vessels found to export',\n          variant: 'destructive',\n        });\n        return;\n      }\n\n      // Group crew by vessel\n      const vesselGroups: { [key: string]: any[] } = {};\n      const unassignedCrew: any[] = [];\n\n      // Initialize vessel groups\n      vessels.forEach((vessel: any) => {\n        vesselGroups[vessel.id] = [];\n      });\n\n      // Group crew members by their current vessel\n      crewMembers.forEach((member: any) => {\n        if (member.currentVesselId && vesselGroups[member.currentVesselId]) {\n          vesselGroups[member.currentVesselId].push(member);\n        } else {\n          unassignedCrew.push(member);\n        }\n      });\n\n      // Create a new workbook\n      const workbook = XLSX.utils.book_new();\n\n      // Helper function to get document number by type for a crew member\n      const getDocumentNumber = (crewMemberId: string, docType: string) => {\n        if (!documents) return '---';\n        const doc = documents.find((d: any) => d.crewMemberId === crewMemberId && d.type?.toLowerCase() === docType.toLowerCase());\n        return doc?.documentNumber || '---';\n      };\n\n      // Helper function to process crew member data\n      const processCrewMember = (member: any) => {\n        // Get active contract for this crew member\n        const activeContract = member.activeContract;\n        let contractEndDate = '---';\n        let daysToContractEnd = '---';\n        \n        if (activeContract?.endDate) {\n          contractEndDate = format(new Date(activeContract.endDate), 'yyyy-MM-dd');\n          const today = new Date();\n          const endDate = new Date(activeContract.endDate);\n          const diffTime = endDate.getTime() - today.getTime();\n          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n          daysToContractEnd = diffDays.toString();\n        }\n\n        // Handle phone number with multiple possible field names and clean formatting\n        let phoneNumber = '---';\n        if (member.phoneNumber) {\n          phoneNumber = String(member.phoneNumber).replace(/^=/, '').trim();\n        } else if (member.phone) {\n          phoneNumber = String(member.phone).replace(/^=/, '').trim();\n        }\n        \n        // Format Next of Kin (emergency contact)\n        let nextOfKin = '---';\n        if (member.emergencyContact?.name) {\n          const relationship = member.emergencyContact.relationship ? ` (${member.emergencyContact.relationship})` : '';\n          const phone = member.emergencyContact.phone ? ` - ${member.emergencyContact.phone}` : '';\n          nextOfKin = `${member.emergencyContact.name}${relationship}${phone}`;\n        }\n\n        // Get document numbers\n        const passportNo = getDocumentNumber(member.id, 'passport');\n        const cdcNo = getDocumentNumber(member.id, 'cdc');\n        const cocNo = getDocumentNumber(member.id, 'stcw');\n        const medicalCertNo = getDocumentNumber(member.id, 'medical');\n\n        return {\n          'Full Name': `${member.firstName} ${member.lastName}`,\n          'Rank/Position': member.rank || '---',\n          'Nationality': member.nationality || '---',\n          'Date of Birth': member.dateOfBirth ? format(new Date(member.dateOfBirth), 'yyyy-MM-dd') : '---',\n          'Phone Number': phoneNumber,\n          'Email': member.email || '---',\n          'Passport No': passportNo,\n          'CDC No': cdcNo,\n          'COC No': cocNo,\n          'Medical Cert No': medicalCertNo,\n          'Next of Kin': nextOfKin,\n          'Employment Status': member.status || '---',\n          'Join Date': member.createdAt ? format(new Date(member.createdAt), 'yyyy-MM-dd') : '---',\n          'Contract End Date': contractEndDate,\n          'Days to Contract End': daysToContractEnd\n        };\n      };\n\n      // Create a sheet for each vessel\n      vessels.forEach((vessel: any) => {\n        const vesselCrew = vesselGroups[vessel.id] || [];\n        \n        // Prepare worksheet data\n        const worksheetData: any[] = [];\n        \n        // Create empty row template with all columns\n        const emptyRow = {\n          'Full Name': '', 'Rank/Position': '', 'Nationality': '', 'Date of Birth': '',\n          'Phone Number': '', 'Email': '', 'Passport No': '', 'CDC No': '', 'COC No': '',\n          'Medical Cert No': '', 'Next of Kin': '', 'Employment Status': '', 'Join Date': '',\n          'Contract End Date': '', 'Days to Contract End': ''\n        };\n\n        // Add vessel information header\n        worksheetData.push({\n          ...emptyRow,\n          'Full Name': `VESSEL: ${vessel.name}`,\n        });\n        \n        worksheetData.push({\n          ...emptyRow,\n          'Full Name': `Type: ${vessel.type || '---'}`,\n          'Rank/Position': `IMO: ${vessel.imoNumber || '---'}`,\n          'Nationality': `Flag: ${vessel.flag || '---'}`,\n          'Date of Birth': `Status: ${vessel.status || '---'}`,\n          'Phone Number': `Crew On Board: ${vesselCrew.filter((crew: any) => crew.status === 'onBoard').length}`,\n        });\n        \n        // Add empty row\n        worksheetData.push({ ...emptyRow });\n\n        if (vesselCrew.length === 0) {\n          worksheetData.push({\n            ...emptyRow,\n            'Full Name': 'No crew members assigned to this vessel',\n          });\n        } else {\n          // Add crew data\n          vesselCrew.forEach((member: any) => {\n            worksheetData.push(processCrewMember(member));\n          });\n          \n          // Add vessel summary\n          worksheetData.push({ ...emptyRow });\n          \n          worksheetData.push({\n            ...emptyRow,\n            'Full Name': `VESSEL SUMMARY`,\n            'Rank/Position': `Total: ${vesselCrew.length}`,\n            'Nationality': `On Board: ${vesselCrew.filter((crew: any) => crew.status === 'onBoard').length}`,\n            'Date of Birth': `On Shore: ${vesselCrew.filter((crew: any) => crew.status === 'onShore').length}`,\n          });\n        }\n\n        // Create worksheet for this vessel\n        const worksheet = XLSX.utils.json_to_sheet(worksheetData);\n        \n        // Set column widths for better readability (15 columns now)\n        const colWidths = [\n          { wch: 22 }, // Full Name\n          { wch: 18 }, // Rank/Position\n          { wch: 12 }, // Nationality\n          { wch: 12 }, // Date of Birth\n          { wch: 15 }, // Phone Number\n          { wch: 22 }, // Email\n          { wch: 15 }, // Passport No\n          { wch: 15 }, // CDC No\n          { wch: 15 }, // COC No\n          { wch: 15 }, // Medical Cert No\n          { wch: 30 }, // Next of Kin\n          { wch: 15 }, // Employment Status\n          { wch: 12 }, // Join Date\n          { wch: 15 }, // Contract End Date\n          { wch: 18 }  // Days to Contract End\n        ];\n        worksheet['!cols'] = colWidths;\n\n        // Use vessel name as sheet name (sanitize for Excel)\n        const sheetName = vessel.name.replace(/[\\\\\\/\\?\\*\\[\\]]/g, '_').substring(0, 31);\n        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);\n      });\n\n      // Add unassigned crew sheet if any\n      if (unassignedCrew.length > 0) {\n        const unassignedData: any[] = [];\n        \n        // Empty row template for unassigned sheet\n        const unassignedEmptyRow = {\n          'Full Name': '', 'Rank/Position': '', 'Nationality': '', 'Date of Birth': '',\n          'Phone Number': '', 'Email': '', 'Passport No': '', 'CDC No': '', 'COC No': '',\n          'Medical Cert No': '', 'Next of Kin': '', 'Employment Status': '', 'Join Date': '',\n          'Contract End Date': '', 'Days to Contract End': ''\n        };\n        \n        // Add header\n        unassignedData.push({\n          ...unassignedEmptyRow,\n          'Full Name': 'UNASSIGNED CREW MEMBERS',\n        });\n        \n        unassignedData.push({\n          ...unassignedEmptyRow,\n          'Full Name': `Total: ${unassignedCrew.length}`,\n        });\n        \n        // Add empty row\n        unassignedData.push({ ...unassignedEmptyRow });\n\n        // Add unassigned crew data\n        unassignedCrew.forEach((member: any) => {\n          unassignedData.push(processCrewMember(member));\n        });\n\n        const unassignedWorksheet = XLSX.utils.json_to_sheet(unassignedData);\n        const unassignedColWidths = [\n          { wch: 22 }, { wch: 18 }, { wch: 12 }, { wch: 12 }, { wch: 15 },\n          { wch: 22 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 },\n          { wch: 30 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 18 }\n        ];\n        unassignedWorksheet['!cols'] = unassignedColWidths;\n        XLSX.utils.book_append_sheet(workbook, unassignedWorksheet, 'Unassigned Crew');\n      }\n\n      // Add Contracts Sheet\n      if (contracts && contracts.length > 0) {\n        const contractsData = contracts.map((contract: any) => {\n          const crewMember = crewMembers.find((c: any) => c.id === contract.crewMemberId);\n          const vessel = vessels.find((v: any) => v.id === contract.vesselId);\n          return {\n            'Crew Member': crewMember ? `${crewMember.firstName} ${crewMember.lastName}` : '---',\n            'Vessel': vessel?.name || '---',\n            'Start Date': contract.startDate ? format(new Date(contract.startDate), 'yyyy-MM-dd') : '---',\n            'End Date': contract.endDate ? format(new Date(contract.endDate), 'yyyy-MM-dd') : '---',\n            'Duration (Days)': contract.durationDays || '---',\n            'Salary': contract.salary || '---',\n            'Currency': contract.currency || 'USD',\n            'Status': contract.status || '---',\n          };\n        });\n        const contractsWorksheet = XLSX.utils.json_to_sheet(contractsData);\n        contractsWorksheet['!cols'] = [\n          { wch: 25 }, { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 10 }, { wch: 12 }\n        ];\n        XLSX.utils.book_append_sheet(workbook, contractsWorksheet, 'All Contracts');\n      }\n\n      // Add Documents Sheet\n      if (documents && documents.length > 0) {\n        const documentsData = documents.map((doc: any) => {\n          const crewMember = crewMembers.find((c: any) => c.id === doc.crewMemberId);\n          return {\n            'Crew Member': crewMember ? `${crewMember.firstName} ${crewMember.lastName}` : '---',\n            'Document Type': doc.type || '---',\n            'Document Number': doc.documentNumber || '---',\n            'Issue Date': doc.issueDate ? format(new Date(doc.issueDate), 'yyyy-MM-dd') : '---',\n            'Expiry Date': doc.expiryDate ? format(new Date(doc.expiryDate), 'yyyy-MM-dd') : '---',\n            'Issuing Authority': doc.issuingAuthority || '---',\n            'Status': doc.status || '---',\n          };\n        });\n        const documentsWorksheet = XLSX.utils.json_to_sheet(documentsData);\n        documentsWorksheet['!cols'] = [\n          { wch: 25 }, { wch: 15 }, { wch: 18 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 12 }\n        ];\n        XLSX.utils.book_append_sheet(workbook, documentsWorksheet, 'All Documents');\n      }\n\n      // Add Crew Rotations Sheet\n      if (rotations && rotations.length > 0) {\n        const rotationsData = rotations.map((rotation: any) => {\n          const crewMember = crewMembers.find((c: any) => c.id === rotation.crewMemberId);\n          const vessel = vessels.find((v: any) => v.id === rotation.vesselId);\n          return {\n            'Crew Member': crewMember ? `${crewMember.firstName} ${crewMember.lastName}` : '---',\n            'Vessel': vessel?.name || '---',\n            'Join Date': rotation.joinDate ? format(new Date(rotation.joinDate), 'yyyy-MM-dd') : '---',\n            'Leave Date': rotation.leaveDate ? format(new Date(rotation.leaveDate), 'yyyy-MM-dd') : '---',\n            'Rotation Type': rotation.rotationType || '---',\n            'Status': rotation.status || '---',\n            'Notes': rotation.notes || '---',\n          };\n        });\n        const rotationsWorksheet = XLSX.utils.json_to_sheet(rotationsData);\n        rotationsWorksheet['!cols'] = [\n          { wch: 25 }, { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 30 }\n        ];\n        XLSX.utils.book_append_sheet(workbook, rotationsWorksheet, 'Crew Rotations');\n      }\n\n      // Add Vessels Details Sheet\n      if (vessels && vessels.length > 0) {\n        const vesselsData = vessels.map((vessel: any) => {\n          const vesselCrew = vesselGroups[vessel.id] || [];\n          return {\n            'Vessel Name': vessel.name || '---',\n            'Type': vessel.type || '---',\n            'IMO Number': vessel.imoNumber || '---',\n            'Flag': vessel.flag || '---',\n            'Status': vessel.status || '---',\n            'Total Crew': vesselCrew.length,\n            'Crew On Board': vesselCrew.filter((c: any) => c.status === 'onBoard').length,\n            'Crew On Shore': vesselCrew.filter((c: any) => c.status === 'onShore').length,\n          };\n        });\n        const vesselsWorksheet = XLSX.utils.json_to_sheet(vesselsData);\n        vesselsWorksheet['!cols'] = [\n          { wch: 25 }, { wch: 18 }, { wch: 15 }, { wch: 15 }, { wch: 18 }, { wch: 12 }, { wch: 15 }, { wch: 15 }\n        ];\n        XLSX.utils.book_append_sheet(workbook, vesselsWorksheet, 'Vessel Details');\n      }\n\n      // Create summary sheet\n      const summaryData = [\n        { Field: 'COMPREHENSIVE DATA EXPORT REPORT', Value: '' },\n        { Field: 'Generated on', Value: format(new Date(), 'MMMM dd, yyyy at HH:mm') },\n        { Field: '', Value: '' },\n        { Field: 'FLEET SUMMARY STATISTICS', Value: '' },\n        { Field: 'Total Crew Members', Value: crewMembers.length },\n        { Field: 'Total Vessels', Value: vessels.length },\n        { Field: 'Total Contracts', Value: contracts?.length || 0 },\n        { Field: 'Total Documents', Value: documents?.length || 0 },\n        { Field: 'Total Rotations', Value: rotations?.length || 0 },\n        { Field: 'Crew On Board', Value: crewMembers.filter((member: any) => member.status === 'onBoard').length },\n        { Field: 'Crew On Shore', Value: crewMembers.filter((member: any) => member.status === 'onShore').length },\n        { Field: 'Unassigned Crew', Value: unassignedCrew.length },\n        { Field: '', Value: '' },\n        { Field: 'VESSEL BREAKDOWN', Value: '' }\n      ];\n\n      // Add vessel breakdown\n      vessels.forEach((vessel: any) => {\n        const vesselCrew = vesselGroups[vessel.id] || [];\n        summaryData.push({\n          Field: vessel.name,\n          Value: `${vesselCrew.length} crew (${vesselCrew.filter((crew: any) => crew.status === 'onBoard').length} on board)`\n        });\n      });\n\n      const summaryWorksheet = XLSX.utils.json_to_sheet(summaryData);\n      summaryWorksheet['!cols'] = [{ wch: 30 }, { wch: 40 }];\n      \n      // Insert summary sheet at the beginning by appending it first\n      const tempWorkbook = XLSX.utils.book_new();\n      XLSX.utils.book_append_sheet(tempWorkbook, summaryWorksheet, 'Summary');\n      \n      // Copy all vessel sheets to the new workbook\n      workbook.SheetNames.forEach(sheetName => {\n        XLSX.utils.book_append_sheet(tempWorkbook, workbook.Sheets[sheetName], sheetName);\n      });\n      \n      // Replace the workbook with the reordered one\n      Object.assign(workbook, tempWorkbook);\n\n      // Generate Excel file\n      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });\n      const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });\n      \n      const link = document.createElement('a');\n      if (link.download !== undefined) {\n        const url = URL.createObjectURL(blob);\n        link.setAttribute('href', url);\n        link.setAttribute('download', `Crew-Management-Complete-Export-${format(new Date(), 'yyyy-MM-dd-HHmm')}.xlsx`);\n        link.style.visibility = 'hidden';\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n      }\n\n      toast({\n        title: 'Export Successful',\n        description: `Complete data exported: ${crewMembers.length} crew, ${vessels.length} vessels, ${contracts?.length || 0} contracts, ${documents?.length || 0} documents`,\n      });\n    } catch (error) {\n      console.error('Export error:', error);\n      toast({\n        title: 'Export Failed',\n        description: 'Unable to export crew data. Please try again.',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  if (statsLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-muted rounded w-1/3 mb-2\"></div>\n          <div className=\"h-4 bg-muted rounded w-1/2\"></div>\n        </div>\n        <div className=\"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6\">\n          {Array(4).fill(0).map((_, i) => (\n            <div key={i} className=\"h-24 sm:h-28 lg:h-32 bg-muted rounded-xl animate-pulse\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4 sm:space-y-6\">\n      {/* Dashboard Header */}\n      <div className=\"mb-6 sm:mb-8\">\n        <h2 className=\"text-2xl sm:text-3xl font-bold text-foreground mb-2\" data-testid=\"dashboard-title\">\n          {user?.role === 'admin' ? 'Fleet Dashboard' : 'Operations Dashboard'}\n        </h2>\n        <p className=\"text-sm sm:text-base text-secondary-foreground\">\n          {user?.role === 'admin' ? 'Overview of your maritime operations and crew status' :\n           'Manage crew data entry and monitor document compliance'}\n        </p>\n      </div>\n\n      {/* KPI Cards */}\n      {stats && (\n        <div className=\"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8\">\n          <StatsCard\n            title=\"Crew On Board\"\n            value={stats.activeCrew}\n            icon=\"users\"\n            trend={{ value: 5.2, isPositive: true }}\n            color=\"ocean-blue\"\n          />\n          <StatsCard\n            title=\"Crew On Shore\"\n            value={stats.crewOnShore}\n            icon=\"users\"\n            description=\"Available crew members\"\n            color=\"compliance-green\"\n          />\n          <StatsCard\n            title=\"Managed Vessel\"\n            value={stats.activeVessels}\n            icon=\"ship\"\n            description=\"All vessels operational\"\n            color=\"maritime-navy\"\n          />\n          <StatsCard\n            title=\"Crew Document Status\"\n            value={stats.pendingActions}\n            icon=\"clock\"\n            description=\"Document renewals & approvals\"\n            color=\"warning-amber\"\n          />\n        </div>\n      )}\n\n      {/* Vessel Overview Section */}\n      {(user?.role === 'admin' || user?.role === 'office_staff') && (\n        <div className=\"mb-8\">\n          <div className=\"bg-card border border-border rounded-xl shadow-sm\">\n            <div className=\"p-6\">\n              <VesselCards showUploadButton={false} />\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Main Content Grid */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n        {/* Crew Overview */}\n        <div className=\"lg:col-span-2\">\n          <div className=\"bg-card rounded-xl shadow-sm border border-border h-full min-h-[800px]\">\n            <div className=\"p-6 border-b border-border\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-lg font-semibold text-foreground\">\n                  Crew Overview\n                </h3>\n                {(user?.role === 'admin' || user?.role === 'office_staff') && (\n                  <div className=\"flex space-x-2\">\n                    <Button \n                      variant=\"outline\"\n                      className=\"bg-purple-50 hover:bg-purple-100 text-purple-700 border-purple-300 dark:bg-purple-950 dark:hover:bg-purple-900 dark:text-purple-300 dark:border-purple-700\" \n                      size=\"sm\"\n                      onClick={() => setShowAddContractForm(true)}\n                      data-testid=\"add-contract-button\"\n                    >\n                      <FileText className=\"h-4 w-4 mr-2\" />\n                      Add Contract\n                    </Button>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      onClick={exportCrewByVessel}\n                      disabled={!crewMembers || crewMembers.length === 0}\n                      data-testid=\"export-crew-button\"\n                    >\n                      <Download className=\"h-4 w-4 mr-2\" />\n                      Export\n                    </Button>\n                  </div>\n                )}\n              </div>\n            </div>\n            <div className=\"p-6 flex-1\">\n              <CrewTable />\n            </div>\n          </div>\n        </div>\n\n        {/* Right Sidebar */}\n        <div className=\"space-y-6\">\n          <UpcomingEvents />\n          \n          {!alertsLoading && <ExpiryAlertCard alerts={expiringDocuments || []} />}\n\n          {/* Quick Actions */}\n          <div className=\"bg-card rounded-xl shadow-sm border border-border\">\n            <div className=\"p-6 border-b border-border\">\n              <h3 className=\"text-lg font-semibold text-foreground\">Quick Actions</h3>\n            </div>\n            <div className=\"p-6\">\n              <div className=\"flex flex-col items-start\">\n                <Link href=\"/scheduling\" className=\"mb-6\">\n                  <Button\n                    variant=\"outline\"\n                    className=\"justify-start hover:bg-accent\"\n                    data-testid=\"quick-action-schedule\"\n                  >\n                    <Calendar className=\"h-4 w-4 mr-3 ocean-blue\" />\n                    <span className=\"text-sm font-medium\">Schedule Crew Change</span>\n                  </Button>\n                </Link>\n                <Link href=\"/documents\" className=\"mb-6\">\n                  <Button\n                    variant=\"outline\"\n                    className=\"justify-start hover:bg-accent\"\n                    data-testid=\"quick-action-upload\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-3 compliance-green\" />\n                    <span className=\"text-sm font-medium\">Upload Documents</span>\n                  </Button>\n                </Link>\n                <Link href=\"/crew\">\n                  <Button\n                    variant=\"outline\"\n                    className=\"justify-start hover:bg-accent\"\n                    data-testid=\"quick-action-reports\"\n                  >\n                    <Download className=\"h-4 w-4 mr-3 warning-amber\" />\n                    <span className=\"text-sm font-medium\">Crew Reports</span>\n                  </Button>\n                </Link>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Add Contract Form Dialog */}\n      <AddContractForm \n        open={showAddContractForm} \n        onOpenChange={setShowAddContractForm} \n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":27369,"size_tokens":null},"client/src/lib/auth.ts":{"content":"export function getAuthHeaders(): Record<string, string> {\n  const token = localStorage.getItem('auth_token');\n  const userData = localStorage.getItem('user_data');\n  \n  if (!token || !userData) {\n    return {};\n  }\n\n  try {\n    const user = JSON.parse(userData);\n    return {\n      'Authorization': `Bearer ${token}`,\n      'X-User-Id': user.id,\n      'X-User-Role': user.role,\n      'X-Username': user.username,\n    };\n  } catch {\n    return {};\n  }\n}\n","path":null,"size_bytes":454,"size_tokens":null},"client/src/components/alerts/expiry-alert-card.tsx":{"content":"import { Link } from 'wouter';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { AlertTriangle, Clock, ExternalLink } from 'lucide-react';\nimport { DocumentAlert } from '@shared/schema';\n\ninterface ExpiryAlertCardProps {\n  alerts: DocumentAlert[];\n}\n\nconst severityConfig = {\n  critical: {\n    color: 'bg-red-50 border-l-red-500',\n    icon: AlertTriangle,\n    iconColor: 'text-red-500',\n    textColor: 'text-red-700',\n  },\n  warning: {\n    color: 'bg-yellow-50 border-l-yellow-500',\n    icon: Clock,\n    iconColor: 'text-yellow-500',\n    textColor: 'text-yellow-700',\n  },\n  info: {\n    color: 'bg-blue-50 border-l-blue-500',\n    icon: Clock,\n    iconColor: 'text-blue-500',\n    textColor: 'text-blue-700',\n  },\n};\n\nexport default function ExpiryAlertCard({ alerts }: ExpiryAlertCardProps) {\n  const criticalAlerts = alerts.filter(alert => alert.severity === 'critical');\n  const warningAlerts = alerts.filter(alert => alert.severity === 'warning');\n  const infoAlerts = alerts.filter(alert => alert.severity === 'info');\n\n  const displayAlerts = [...criticalAlerts, ...warningAlerts, ...infoAlerts].slice(0, 3);\n\n  return (\n    <Card data-testid=\"expiry-alerts-card\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-lg font-semibold maritime-navy\">Crew Documents</CardTitle>\n          {alerts.length > 0 && (\n            <Badge variant=\"destructive\" data-testid=\"alerts-count\">\n              {alerts.length}\n            </Badge>\n          )}\n        </div>\n      </CardHeader>\n      <CardContent>\n        {alerts.length === 0 ? (\n          <div className=\"text-center py-6 text-gray-500\">\n            <Clock className=\"h-8 w-8 mx-auto mb-2 text-gray-300\" />\n            <p className=\"text-sm\">No expiring documents</p>\n          </div>\n        ) : (\n          <div className=\"space-y-4\">\n            {displayAlerts.map((alert) => {\n              const config = severityConfig[alert.severity];\n              const Icon = config.icon;\n              \n              return (\n                <Link\n                  key={alert.document.id}\n                  href={`/documents?highlight=${alert.crewMember.id}`}\n                  className=\"block\"\n                  data-testid={`alert-link-${alert.document.id}`}\n                >\n                  <div\n                    className={`flex items-center justify-between p-3 border-l-4 rounded-r ${config.color} hover:bg-opacity-80 transition-colors cursor-pointer group`}\n                    data-testid={`alert-${alert.document.id}`}\n                    title={`Click to renew ${alert.document.type.toUpperCase()} certificate for ${alert.crewMember.firstName} ${alert.crewMember.lastName}`}\n                  >\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Icon className={`h-4 w-4 ${config.iconColor}`} />\n                        <p className={`text-sm font-medium ${config.textColor} group-hover:underline`} data-testid=\"alert-document-type\">\n                          {alert.document.type.toUpperCase()} Certificate\n                        </p>\n                        <Badge variant=\"secondary\" className=\"text-xs px-1 py-0.5 opacity-0 group-hover:opacity-100 transition-opacity\">\n                          Click to renew\n                        </Badge>\n                      </div>\n                      <p className=\"text-xs text-gray-500 mt-1\" data-testid=\"alert-crew-info\">\n                        {alert.crewMember.firstName} {alert.crewMember.lastName} - {alert.daysUntilExpiry} days\n                      </p>\n                    </div>\n                    <ExternalLink className={`h-3 w-3 ${config.iconColor} opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0`} />\n                  </div>\n                </Link>\n              );\n            })}\n            \n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":4118,"size_tokens":null},"deployment/server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\napp.use(express.json({ limit: '100mb' })); // Increased limit for OCR image uploads\napp.use(express.urlencoded({ extended: false, limit: '100mb' }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"‚Ä¶\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","path":null,"size_bytes":2141,"size_tokens":null},"client/src/components/vessels/add-vessel-form.tsx":{"content":"import { useState } from 'react';\nimport { useMutation, useQueryClient } from '@tanstack/react-query';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest } from '@/lib/queryClient';\n\nconst addVesselSchema = z.object({\n  name: z.string().min(1, 'Vessel name is required'),\n  type: z.string().min(1, 'Vessel type is required'),\n  imoNumber: z.string().optional(),\n  flag: z.string().min(1, 'Flag state is required'),\n  status: z.enum(['harbour-mining', 'coastal-mining', 'world-wide', 'oil-field', 'line-up-mining']),\n});\n\ntype AddVesselFormData = z.infer<typeof addVesselSchema>;\n\ninterface AddVesselFormProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nconst vesselTypes = [\n  'AHT',\n  'Bulk Carrier',\n  'Container Ship',\n  'Tanker',\n  'Ferry',\n  'Cruise Ship',\n  'Cargo Ship',\n  'OSV',\n  'Research Vessel',\n  'Naval Vessel',\n  'Fishing Vessel',\n  'General Cargo',\n  'Passenger Ship',\n  'Tugboat',\n  'Trailing Suction Hopper Dredger (TSHD)',\n  'Other'\n];\n\nconst flagStates = [\n  'Marshall Islands',\n  'Liberia',\n  'Panama',\n  'Singapore',\n  'Malta',\n  'Bahamas',\n  'Cyprus',\n  'India',\n  'Norway',\n  'United Kingdom',\n  'Greece',\n  'Netherlands',\n  'Germany',\n  'United States',\n  'St. Kitts & Nevis',\n  'Other'\n];\n\nexport default function AddVesselForm({ open, onOpenChange }: AddVesselFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const form = useForm<AddVesselFormData>({\n    resolver: zodResolver(addVesselSchema),\n    defaultValues: {\n      name: '',\n      type: '',\n      imoNumber: '',\n      flag: '',\n      status: 'harbour-mining',\n    },\n  });\n\n  const addVesselMutation = useMutation({\n    mutationFn: async (data: AddVesselFormData) => {\n      const response = await fetch('/api/vessels', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': 'Bearer mock-token',\n          'X-User-Id': 'admin-id',\n          'X-User-Role': 'admin',\n        },\n        body: JSON.stringify(data),\n      });\n      \n      if (!response.ok) {\n        throw new Error('Failed to add vessel');\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      toast({\n        title: 'Success',\n        description: 'Vessel added successfully',\n      });\n      form.reset();\n      onOpenChange(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to add vessel',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const onSubmit = (data: AddVesselFormData) => {\n    addVesselMutation.mutate(data);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md max-h-[90vh] flex flex-col\">\n        <DialogHeader className=\"flex-shrink-0\">\n          <DialogTitle className=\"text-foreground\">Add New Vessel</DialogTitle>\n          <DialogDescription className=\"text-muted-foreground\">\n            Enter the details for the new vessel to add it to your fleet.\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"flex-1 overflow-y-auto min-h-0\">\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n            <FormField\n              control={form.control}\n              name=\"name\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel className=\"text-foreground\">Vessel Name</FormLabel>\n                  <FormControl>\n                    <Input\n                      placeholder=\"e.g., MV Ocean Pioneer\"\n                      {...field}\n                      data-testid=\"vessel-name-input\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"type\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel className=\"text-foreground\">Vessel Type</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"vessel-type-select\">\n                        <SelectValue placeholder=\"Select vessel type\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      {vesselTypes.map((type) => (\n                        <SelectItem key={type} value={type}>\n                          {type}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"imoNumber\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel className=\"text-foreground\">IMO Number (Optional)</FormLabel>\n                  <FormControl>\n                    <Input\n                      placeholder=\"e.g., IMO1234567\"\n                      {...field}\n                      data-testid=\"imo-number-input\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"flag\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel className=\"text-foreground\">Flag State</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"flag-state-select\">\n                        <SelectValue placeholder=\"Select flag state\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      {flagStates.map((flag) => (\n                        <SelectItem key={flag} value={flag}>\n                          {flag}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"status\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel className=\"text-foreground\">Status</FormLabel>\n                  <Select onValueChange={field.onChange} value={field.value}>\n                    <FormControl>\n                      <SelectTrigger data-testid=\"vessel-status-select\">\n                        <SelectValue placeholder=\"Select status\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      <SelectItem value=\"harbour-mining\">Harbour Mining</SelectItem>\n                      <SelectItem value=\"coastal-mining\">Coastal Mining</SelectItem>\n                      <SelectItem value=\"world-wide\">World Wide (Foreign Going)</SelectItem>\n                      <SelectItem value=\"oil-field\">Oil Field</SelectItem>\n                      <SelectItem value=\"line-up-mining\">Laid Up</SelectItem>\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <div className=\"flex justify-end space-x-2 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"cancel-button\"\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={addVesselMutation.isPending}\n                data-testid=\"add-vessel-submit\"\n                className=\"bg-primary hover:bg-primary/90\"\n              >\n                {addVesselMutation.isPending ? 'Adding...' : 'Add Vessel'}\n              </Button>\n            </div>\n          </form>\n        </Form>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":8976,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/vessels/crew-management-dialog.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';\n\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Badge } from '@/components/ui/badge';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Users, Search, Plus, Eye, UserMinus, Edit, LogOut, LogIn, Trash2 } from 'lucide-react';\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from '@/components/ui/alert-dialog';\nimport { OCRDocumentScanner } from '@/components/crew/OCRDocumentScanner';\nimport { format } from 'date-fns';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\nimport { Label } from '@/components/ui/label';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { CrewMemberWithDetails } from '@shared/schema';\nimport type { VesselWithDetails } from './vessel-cards';\nimport { formatDate } from '@/lib/utils';\n\n// Add crew form schema\nconst addCrewSchema = z.object({\n  firstName: z.string().min(1, 'First name is required'),\n  lastName: z.string().min(1, 'Last name is required'),\n  nationality: z.string().min(1, 'Nationality is required'),\n  dateOfBirth: z.string().min(1, 'Date of birth is required'),\n  rank: z.string().min(1, 'Rank is required'),\n  phoneNumber: z.string().optional(),\n  status: z.enum(['onBoard', 'onShore']).default('onBoard'),\n  emergencyContactName: z.string().optional(),\n  emergencyContactRelationship: z.string().optional(),\n  emergencyContactPhone: z.string().optional(),\n  emergencyContactEmail: z.string().optional(),\n  emergencyContactPostalAddress: z.string().optional(),\n  contractStartDate: z.string().optional(),\n  contractDurationDays: z.number().optional(),\n  contractEndDate: z.string().optional(),\n  passportNumber: z.string().optional(),\n  passportPlaceOfIssue: z.string().optional(),\n  passportIssueDate: z.string().optional(),\n  passportExpiryDate: z.string().optional(),\n  cdcNumber: z.string().optional(),\n  cdcPlaceOfIssue: z.string().optional(),\n  cdcIssueDate: z.string().optional(),\n  cdcExpiryDate: z.string().optional(),\n  cocGradeNo: z.string().optional(),\n  cocPlaceOfIssue: z.string().optional(),\n  cocIssueDate: z.string().optional(),\n  cocExpiryDate: z.string().optional(),\n  medicalIssuingAuthority: z.string().optional(),\n  medicalApprovalNo: z.string().optional(),\n  medicalIssueDate: z.string().optional(),\n  medicalExpiryDate: z.string().optional(),\n});\n\ntype AddCrewFormData = z.infer<typeof addCrewSchema>;\n\ninterface CrewManagementDialogProps {\n  vessel: VesselWithDetails | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport default function CrewManagementDialog({ vessel, open, onOpenChange }: CrewManagementDialogProps) {\n  const [searchTerm, setSearchTerm] = useState('');\n  const [showAssignDialog, setShowAssignDialog] = useState(false);\n  const [selectedCrewForView, setSelectedCrewForView] = useState<CrewMemberWithDetails | null>(null);\n  const [showAddCrewDialog, setShowAddCrewDialog] = useState(false);\n  const [selectedCrewForEdit, setSelectedCrewForEdit] = useState<CrewMemberWithDetails | null>(null);\n  const [showEditCrewDialog, setShowEditCrewDialog] = useState(false);\n  const [contractDialogOpen, setContractDialogOpen] = useState(false);\n  const [selectedCrewForContract, setSelectedCrewForContract] = useState<CrewMemberWithDetails | null>(null);\n  const [contractStartDate, setContractStartDate] = useState('');\n  const [contractDuration, setContractDuration] = useState('90');\n  const [contractEndDate, setContractEndDate] = useState('');\n  const [statusChangeReason, setStatusChangeReason] = useState('');\n  const [originalStatus, setOriginalStatus] = useState<string>('');\n  const [signOffDialogOpen, setSignOffDialogOpen] = useState(false);\n  const [selectedCrewForSignOff, setSelectedCrewForSignOff] = useState<CrewMemberWithDetails | null>(null);\n  const [signOffReason, setSignOffReason] = useState('');\n  const [signOnDialogOpen, setSignOnDialogOpen] = useState(false);\n  const [selectedCrewForSignOn, setSelectedCrewForSignOn] = useState<CrewMemberWithDetails | null>(null);\n  const [signOnReason, setSignOnReason] = useState('');\n  const [deleteCrewDialogOpen, setDeleteCrewDialogOpen] = useState(false);\n  const [selectedCrewForDeletion, setSelectedCrewForDeletion] = useState<CrewMemberWithDetails | null>(null);\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Add crew form\n  const addCrewForm = useForm<AddCrewFormData>({\n    resolver: zodResolver(addCrewSchema),\n    defaultValues: {\n      firstName: '',\n      lastName: '',\n      nationality: '',\n      dateOfBirth: '',\n      rank: '',\n      phoneNumber: '',\n      status: 'onBoard',\n      emergencyContactName: '',\n      emergencyContactRelationship: '',\n      emergencyContactPhone: '',\n      emergencyContactEmail: '',\n      emergencyContactPostalAddress: '',\n      passportNumber: '',\n      passportPlaceOfIssue: '',\n      passportIssueDate: '',\n      passportExpiryDate: '',\n      cdcNumber: '',\n      cdcPlaceOfIssue: '',\n      cdcIssueDate: '',\n      cdcExpiryDate: '',\n      cocGradeNo: '',\n      cocPlaceOfIssue: '',\n      cocIssueDate: '',\n      cocExpiryDate: '',\n      medicalIssuingAuthority: '',\n      medicalApprovalNo: '',\n      medicalIssueDate: '',\n      medicalExpiryDate: '',\n    },\n  });\n\n  // Edit crew form\n  const editCrewForm = useForm<AddCrewFormData>({\n    resolver: zodResolver(addCrewSchema),\n    defaultValues: {\n      firstName: '',\n      lastName: '',\n      nationality: '',\n      dateOfBirth: '',\n      rank: '',\n      phoneNumber: '',\n      status: 'onBoard',\n      emergencyContactName: '',\n      emergencyContactRelationship: '',\n      emergencyContactPhone: '',\n      emergencyContactEmail: '',\n      emergencyContactPostalAddress: '',\n      passportNumber: '',\n      passportPlaceOfIssue: '',\n      passportIssueDate: '',\n      passportExpiryDate: '',\n      cdcNumber: '',\n      cdcPlaceOfIssue: '',\n      cdcIssueDate: '',\n      cdcExpiryDate: '',\n      cocGradeNo: '',\n      cocPlaceOfIssue: '',\n      cocIssueDate: '',\n      cocExpiryDate: '',\n      medicalIssuingAuthority: '',\n      medicalApprovalNo: '',\n      medicalIssueDate: '',\n      medicalExpiryDate: '',\n    },\n  });\n\n  // Reset edit form when selected crew member changes to populate fields\n  useEffect(() => {\n    if (selectedCrewForEdit) {\n      const passport = selectedCrewForEdit.documents?.find(d => d.type === 'passport');\n      const cdc = selectedCrewForEdit.documents?.find(d => d.type === 'cdc');\n      const coc = selectedCrewForEdit.documents?.find(d => d.type === 'stcw');\n      const medical = selectedCrewForEdit.documents?.find(d => d.type === 'medical');\n      \n      editCrewForm.reset({\n        firstName: selectedCrewForEdit.firstName,\n        lastName: selectedCrewForEdit.lastName,\n        nationality: selectedCrewForEdit.nationality,\n        dateOfBirth: typeof selectedCrewForEdit.dateOfBirth === 'string' \n          ? selectedCrewForEdit.dateOfBirth \n          : new Date(selectedCrewForEdit.dateOfBirth).toISOString().split('T')[0],\n        rank: selectedCrewForEdit.rank,\n        phoneNumber: selectedCrewForEdit.phoneNumber || '',\n        status: selectedCrewForEdit.status as 'onBoard' | 'onShore',\n        emergencyContactName: (selectedCrewForEdit.emergencyContact as any)?.name || '',\n        emergencyContactRelationship: (selectedCrewForEdit.emergencyContact as any)?.relationship || '',\n        emergencyContactPhone: (selectedCrewForEdit.emergencyContact as any)?.phone || '',\n        emergencyContactEmail: (selectedCrewForEdit.emergencyContact as any)?.email || '',\n        emergencyContactPostalAddress: (selectedCrewForEdit.emergencyContact as any)?.postalAddress || '',\n        passportNumber: passport?.documentNumber || '',\n        passportPlaceOfIssue: passport?.issuingAuthority || '',\n        passportIssueDate: passport?.issueDate ? new Date(passport.issueDate).toISOString().split('T')[0] : '',\n        passportExpiryDate: passport?.expiryDate ? new Date(passport.expiryDate).toISOString().split('T')[0] : '',\n        cdcNumber: cdc?.documentNumber || '',\n        cdcPlaceOfIssue: cdc?.issuingAuthority || '',\n        cdcIssueDate: cdc?.issueDate ? new Date(cdc.issueDate).toISOString().split('T')[0] : '',\n        cdcExpiryDate: cdc?.expiryDate ? new Date(cdc.expiryDate).toISOString().split('T')[0] : '',\n        cocGradeNo: coc?.documentNumber || '',\n        cocPlaceOfIssue: coc?.issuingAuthority || '',\n        cocIssueDate: coc?.issueDate ? new Date(coc.issueDate).toISOString().split('T')[0] : '',\n        cocExpiryDate: coc?.expiryDate ? new Date(coc.expiryDate).toISOString().split('T')[0] : '',\n        medicalIssuingAuthority: medical?.issuingAuthority || '',\n        medicalApprovalNo: medical?.documentNumber || '',\n        medicalIssueDate: medical?.issueDate ? new Date(medical.issueDate).toISOString().split('T')[0] : '',\n        medicalExpiryDate: medical?.expiryDate ? new Date(medical.expiryDate).toISOString().split('T')[0] : '',\n      });\n      setOriginalStatus(selectedCrewForEdit.status);\n    }\n  }, [selectedCrewForEdit, editCrewForm]);\n\n  const { data: crewMembers = [], isLoading } = useQuery<CrewMemberWithDetails[]>({\n    queryKey: ['/api/crew', { vesselId: vessel?.id }],\n    queryFn: async () => {\n      if (!vessel) return [];\n      const response = await fetch(`/api/crew?vesselId=${vessel.id}`, {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n    enabled: !!vessel && open,\n  });\n\n  const { data: allCrew = [] } = useQuery<CrewMemberWithDetails[]>({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch all crew');\n      return response.json();\n    },\n    enabled: open,\n  });\n\n  // Fetch all vessels for assignment dropdown\n  const { data: vessels = [] } = useQuery<VesselWithDetails[]>({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n    enabled: open,\n  });\n\n  const availableCrew = allCrew.filter(member => !member.currentVesselId);\n\n  // Remove debug logging since functionality is working\n  // Debug available crew silently\n  if (availableCrew.length > 0) {\n    console.log(`${availableCrew.length} crew members signed off and available for assignment to ${vessel?.name}`);\n  }\n\n  const filteredCrew = crewMembers.filter(member =>\n    `${member.firstName} ${member.lastName}`.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    member.rank.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    member.nationality.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const getInitials = (firstName: string, lastName: string) => {\n    return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();\n  };\n\n  const getStatusColor = (contractStatus?: string) => {\n    if (contractStatus === 'active') return 'bg-compliance-green text-white';\n    return 'bg-gray-500 text-white';\n  };\n\n  // Calculate contract end date based on start date and duration\n  const calculateEndDate = (startDate: string, durationDays: string) => {\n    if (!startDate || !durationDays) return '';\n    const start = new Date(startDate);\n    const duration = parseInt(durationDays);\n    if (isNaN(duration)) return '';\n    const end = new Date(start);\n    end.setDate(end.getDate() + duration);\n    return end.toISOString().split('T')[0];\n  };\n\n  // Update end date when start date or duration changes\n  const handleContractStartDateChange = (value: string) => {\n    setContractStartDate(value);\n    const endDate = calculateEndDate(value, contractDuration);\n    setContractEndDate(endDate);\n  };\n\n  const handleContractDurationChange = (value: string) => {\n    setContractDuration(value);\n    const endDate = calculateEndDate(contractStartDate, value);\n    setContractEndDate(endDate);\n  };\n\n  // Helper to convert date formats from OCR (DD-MMM-YYYY) to ISO (YYYY-MM-DD)\n  const convertDateToISO = (dateStr: string): string => {\n    if (!dateStr) return '';\n    // If already in ISO format\n    if (/^\\d{4}-\\d{2}-\\d{2}$/.test(dateStr)) return dateStr;\n    // Convert DD-MMM-YYYY to ISO\n    const months: { [key: string]: string } = {\n      'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04',\n      'MAY': '05', 'JUN': '06', 'JUL': '07', 'AUG': '08',\n      'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'\n    };\n    const match = dateStr.match(/(\\d{2})-([A-Z]{3})-(\\d{4})/i);\n    if (match) {\n      const [, day, month, year] = match;\n      const monthNum = months[month.toUpperCase()];\n      if (monthNum) return `${year}-${monthNum}-${day}`;\n    }\n    return dateStr;\n  };\n\n  // Handle OCR data extraction to populate Add Crew form\n  const handleOCRDataExtracted = (extractedData: any) => {\n    console.log('OCR data received in handleOCRDataExtracted:', extractedData);\n    const setValueOptions = { shouldDirty: true, shouldTouch: true, shouldValidate: false };\n    \n    // Parse name into first and last name\n    if (extractedData.seafarerName || extractedData.name) {\n      const fullName = extractedData.seafarerName || extractedData.name || '';\n      const nameParts = fullName.trim().split(/\\s+/);\n      if (nameParts.length >= 2) {\n        addCrewForm.setValue('firstName', nameParts.slice(0, -1).join(' '), setValueOptions);\n        addCrewForm.setValue('lastName', nameParts[nameParts.length - 1], setValueOptions);\n      } else if (nameParts.length === 1) {\n        addCrewForm.setValue('firstName', nameParts[0], setValueOptions);\n      }\n    }\n\n    // Nationality\n    if (extractedData.seafarerNationality) {\n      addCrewForm.setValue('nationality', extractedData.seafarerNationality, setValueOptions);\n    }\n\n    // Date of birth - extract from combined field\n    if (extractedData.seafarerDatePlaceOfBirth) {\n      const dobMatch = extractedData.seafarerDatePlaceOfBirth.match(/(\\d{2}-[A-Z]{3}-\\d{4})/i);\n      if (dobMatch) {\n        addCrewForm.setValue('dateOfBirth', convertDateToISO(dobMatch[1]), setValueOptions);\n      }\n    }\n\n    // Phone/Mobile\n    if (extractedData.seafarerMobile) {\n      addCrewForm.setValue('phoneNumber', extractedData.seafarerMobile, setValueOptions);\n    }\n\n    // Passport details\n    if (extractedData.passportNumber) {\n      console.log('Setting passport number:', extractedData.passportNumber);\n      addCrewForm.setValue('passportNumber', extractedData.passportNumber, setValueOptions);\n    }\n    if (extractedData.passportPlaceOfIssue) {\n      addCrewForm.setValue('passportPlaceOfIssue', extractedData.passportPlaceOfIssue, setValueOptions);\n    }\n    if (extractedData.passportIssueDate) {\n      addCrewForm.setValue('passportIssueDate', convertDateToISO(extractedData.passportIssueDate), setValueOptions);\n    }\n    if (extractedData.passportExpiryDate) {\n      addCrewForm.setValue('passportExpiryDate', convertDateToISO(extractedData.passportExpiryDate), setValueOptions);\n    }\n\n    // CDC details\n    if (extractedData.cdcNumber) {\n      console.log('Setting CDC number:', extractedData.cdcNumber);\n      addCrewForm.setValue('cdcNumber', extractedData.cdcNumber, setValueOptions);\n    }\n    if (extractedData.cdcPlaceOfIssue) {\n      addCrewForm.setValue('cdcPlaceOfIssue', extractedData.cdcPlaceOfIssue, setValueOptions);\n    }\n    if (extractedData.cdcIssueDate) {\n      addCrewForm.setValue('cdcIssueDate', convertDateToISO(extractedData.cdcIssueDate), setValueOptions);\n    }\n    if (extractedData.cdcExpiryDate) {\n      addCrewForm.setValue('cdcExpiryDate', convertDateToISO(extractedData.cdcExpiryDate), setValueOptions);\n    }\n\n    // COC details\n    if (extractedData.cocGradeNo) {\n      console.log('Setting COC grade/no:', extractedData.cocGradeNo);\n      addCrewForm.setValue('cocGradeNo', extractedData.cocGradeNo, setValueOptions);\n    }\n    if (extractedData.cocPlaceOfIssue) {\n      addCrewForm.setValue('cocPlaceOfIssue', extractedData.cocPlaceOfIssue, setValueOptions);\n    }\n    if (extractedData.cocIssueDate) {\n      addCrewForm.setValue('cocIssueDate', convertDateToISO(extractedData.cocIssueDate), setValueOptions);\n    }\n    if (extractedData.cocExpiryDate) {\n      addCrewForm.setValue('cocExpiryDate', convertDateToISO(extractedData.cocExpiryDate), setValueOptions);\n    }\n\n    // Medical certificate details\n    if (extractedData.medicalIssuingAuthority) {\n      addCrewForm.setValue('medicalIssuingAuthority', extractedData.medicalIssuingAuthority, setValueOptions);\n    }\n    if (extractedData.medicalApprovalNo) {\n      console.log('Setting medical approval no:', extractedData.medicalApprovalNo);\n      addCrewForm.setValue('medicalApprovalNo', extractedData.medicalApprovalNo, setValueOptions);\n    }\n    if (extractedData.medicalIssueDate) {\n      addCrewForm.setValue('medicalIssueDate', convertDateToISO(extractedData.medicalIssueDate), setValueOptions);\n    }\n    if (extractedData.medicalExpiryDate) {\n      addCrewForm.setValue('medicalExpiryDate', convertDateToISO(extractedData.medicalExpiryDate), setValueOptions);\n    }\n\n    // Emergency contact / NOK details\n    if (extractedData.nokName) {\n      addCrewForm.setValue('emergencyContactName', extractedData.nokName, setValueOptions);\n    }\n    if (extractedData.nokRelationship) {\n      addCrewForm.setValue('emergencyContactRelationship', extractedData.nokRelationship, setValueOptions);\n    }\n    if (extractedData.nokTelephone) {\n      addCrewForm.setValue('emergencyContactPhone', extractedData.nokTelephone, setValueOptions);\n    }\n    if (extractedData.nokEmail) {\n      addCrewForm.setValue('emergencyContactEmail', extractedData.nokEmail, setValueOptions);\n    }\n    if (extractedData.nokPostalAddress) {\n      addCrewForm.setValue('emergencyContactPostalAddress', extractedData.nokPostalAddress, setValueOptions);\n    }\n\n    // Contract dates\n    if (extractedData.contractStartDate) {\n      const startDate = convertDateToISO(extractedData.contractStartDate);\n      addCrewForm.setValue('contractStartDate', startDate, setValueOptions);\n    }\n    if (extractedData.engagementPeriodMonths) {\n      const durationDays = extractedData.engagementPeriodMonths * 30;\n      addCrewForm.setValue('contractDurationDays', durationDays, setValueOptions);\n      // Calculate end date\n      const startDate = addCrewForm.getValues('contractStartDate');\n      if (startDate) {\n        const start = new Date(startDate);\n        const end = new Date(start);\n        end.setDate(start.getDate() + durationDays);\n        addCrewForm.setValue('contractEndDate', end.toISOString().split('T')[0], setValueOptions);\n      }\n    }\n    \n    // Log the final form values after setting\n    console.log('Form values after OCR extraction:', addCrewForm.getValues());\n  };\n\n  // Assign crew member mutation with flexible vessel assignment\n  const assignCrewMutation = useMutation({\n    mutationFn: async ({ crewId, vesselId }: { crewId: string; vesselId: string }) => {\n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ \n          currentVesselId: vesselId,\n          status: 'onBoard',\n          signOffDate: null,\n        }),\n      });\n      if (!response.ok) {\n        throw new Error('Failed to assign crew member');\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      toast({\n        title: 'Success',\n        description: 'Crew member assigned successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to assign crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Contract creation mutation\n  const createContractMutation = useMutation({\n    mutationFn: async (data: { crewId: string; vesselId: string; startDate: string; durationDays: number; endDate: string }) => {\n      // First, get all active contracts for this crew member and terminate them\n      const getContractsResponse = await fetch(`/api/contracts?crewMemberId=${data.crewId}`, {\n        headers: getAuthHeaders(),\n      });\n      \n      if (getContractsResponse.ok) {\n        const existingContracts = await getContractsResponse.json();\n        const activeContracts = existingContracts.filter((c: any) => c.status === 'active');\n        \n        // Terminate all active contracts\n        await Promise.all(\n          activeContracts.map((contract: any) =>\n            fetch(`/api/contracts/${contract.id}`, {\n              method: 'PUT',\n              headers: {\n                ...getAuthHeaders(),\n                'Content-Type': 'application/json',\n              },\n              body: JSON.stringify({ status: 'completed' }),\n            })\n          )\n        );\n      }\n      \n      // Now create the new contract\n      const response = await fetch('/api/contracts', {\n        method: 'POST',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          crewMemberId: data.crewId,\n          vesselId: data.vesselId,\n          startDate: new Date(data.startDate),\n          endDate: new Date(data.endDate),\n          durationDays: data.durationDays,\n          status: 'active',\n        }),\n      });\n      if (!response.ok) throw new Error('Failed to create contract');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/contracts'] });\n      toast({\n        title: 'Success',\n        description: 'Contract created successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to create contract',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Add new crew member mutation\n  const addCrewMutation = useMutation({\n    mutationFn: async (data: AddCrewFormData) => {\n      console.log('Add crew form data received:', JSON.stringify(data, null, 2));\n      console.log('Document fields:', {\n        passportNumber: data.passportNumber,\n        passportExpiryDate: data.passportExpiryDate,\n        cdcNumber: data.cdcNumber,\n        cdcExpiryDate: data.cdcExpiryDate,\n        cocGradeNo: data.cocGradeNo,\n        cocExpiryDate: data.cocExpiryDate,\n        medicalApprovalNo: data.medicalApprovalNo,\n        medicalExpiryDate: data.medicalExpiryDate,\n      });\n      const crewData = {\n        firstName: data.firstName,\n        lastName: data.lastName,\n        nationality: data.nationality,\n        dateOfBirth: data.dateOfBirth,\n        rank: data.rank,\n        phoneNumber: data.phoneNumber || null,\n        status: data.status,\n        currentVesselId: vessel?.id || null,\n        emergencyContact: data.emergencyContactName ? {\n          name: data.emergencyContactName,\n          relationship: data.emergencyContactRelationship || '',\n          phone: data.emergencyContactPhone || '',\n          email: data.emergencyContactEmail || '',\n          postalAddress: data.emergencyContactPostalAddress || '',\n        } : null,\n      };\n      \n      const response = await fetch('/api/crew', {\n        method: 'POST',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(crewData),\n      });\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        if (errorData.error === 'DUPLICATE_CREW_MEMBER') {\n          throw new Error(errorData.message || 'This crew member already exists on the same vessel.');\n        }\n        throw new Error(errorData.message || 'Failed to create crew member');\n      }\n      const newCrewMember = await response.json();\n      \n      // Create documents for the new crew member\n      const documentsToCreate = [];\n      \n      if (data.passportNumber || data.passportExpiryDate) {\n        documentsToCreate.push({\n          crewMemberId: newCrewMember.id,\n          type: 'passport',\n          documentNumber: data.passportNumber || 'N/A',\n          issuingAuthority: data.passportPlaceOfIssue || 'Unknown',\n          issueDate: data.passportIssueDate || new Date().toISOString().split('T')[0],\n          expiryDate: data.passportExpiryDate || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],\n        });\n      }\n      \n      if (data.cdcNumber || data.cdcExpiryDate) {\n        documentsToCreate.push({\n          crewMemberId: newCrewMember.id,\n          type: 'cdc',\n          documentNumber: data.cdcNumber || 'N/A',\n          issuingAuthority: data.cdcPlaceOfIssue || 'Unknown',\n          issueDate: data.cdcIssueDate || new Date().toISOString().split('T')[0],\n          expiryDate: data.cdcExpiryDate || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],\n        });\n      }\n      \n      if (data.cocGradeNo || data.cocExpiryDate) {\n        documentsToCreate.push({\n          crewMemberId: newCrewMember.id,\n          type: 'stcw',\n          documentNumber: data.cocGradeNo || 'N/A',\n          issuingAuthority: data.cocPlaceOfIssue || 'Unknown',\n          issueDate: data.cocIssueDate || new Date().toISOString().split('T')[0],\n          expiryDate: data.cocExpiryDate || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],\n        });\n      }\n      \n      if (data.medicalApprovalNo || data.medicalExpiryDate) {\n        documentsToCreate.push({\n          crewMemberId: newCrewMember.id,\n          type: 'medical',\n          documentNumber: data.medicalApprovalNo || 'N/A',\n          issuingAuthority: data.medicalIssuingAuthority || 'Unknown',\n          issueDate: data.medicalIssueDate || new Date().toISOString().split('T')[0],\n          expiryDate: data.medicalExpiryDate || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],\n        });\n      }\n      \n      // Create all documents\n      console.log('Creating documents:', documentsToCreate);\n      for (const doc of documentsToCreate) {\n        try {\n          const docResponse = await fetch('/api/documents', {\n            method: 'POST',\n            headers: {\n              ...getAuthHeaders(),\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(doc),\n          });\n          if (!docResponse.ok) {\n            const errorData = await docResponse.json().catch(() => ({}));\n            console.error('Failed to create document:', doc.type, errorData);\n          } else {\n            console.log('Document created successfully:', doc.type);\n          }\n        } catch (docError) {\n          console.error('Error creating document:', doc.type, docError);\n        }\n      }\n      \n      // Create contract if contract dates are provided\n      if (data.contractStartDate && data.contractEndDate && vessel?.id) {\n        await fetch('/api/contracts', {\n          method: 'POST',\n          headers: {\n            ...getAuthHeaders(),\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            crewMemberId: newCrewMember.id,\n            vesselId: vessel.id,\n            startDate: new Date(data.contractStartDate),\n            endDate: new Date(data.contractEndDate),\n            durationDays: data.contractDurationDays || 90,\n            status: 'active',\n          }),\n        });\n      }\n      \n      return newCrewMember;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/contracts'] });\n      toast({\n        title: 'Success',\n        description: 'New crew member added successfully',\n      });\n      setShowAddCrewDialog(false);\n      addCrewForm.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to add crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Remove crew member from vessel mutation\n  const removeCrewMutation = useMutation({\n    mutationFn: async (crewId: string) => {\n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ currentVesselId: null }),\n      });\n      if (!response.ok) {\n        throw new Error('Failed to remove crew member from vessel');\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      toast({\n        title: 'Success',\n        description: 'Crew member removed from vessel successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to remove crew member from vessel',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Sign off crew member mutation\n  const signOffCrewMutation = useMutation({\n    mutationFn: async ({ crewId, reason }: { crewId: string; reason: string }) => {\n      const crewMember = crewMembers?.find((member: CrewMemberWithDetails) => member.id === crewId);\n      const lastVesselId = crewMember?.currentVesselId || null;\n      \n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          currentVesselId: null,\n          lastVesselId: lastVesselId,\n          status: 'onShore',\n          signOffDate: new Date().toISOString(),\n          statusChangeReason: reason,\n        }),\n      });\n      if (!response.ok) {\n        const errorData = await response.text();\n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to sign off crew member');\n        } catch {\n          throw new Error(`Sign-off failed (${response.status}): ${errorData}`);\n        }\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      setSignOffDialogOpen(false);\n      setSelectedCrewForSignOff(null);\n      setSignOffReason('');\n      toast({\n        title: 'Success',\n        description: 'Crew member signed off successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to sign off crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Handle sign off with reason dialog\n  const handleSignOffClick = (member: CrewMemberWithDetails) => {\n    setSelectedCrewForSignOff(member);\n    setSignOffReason('');\n    setSignOffDialogOpen(true);\n  };\n\n  const handleSignOffConfirm = () => {\n    if (!selectedCrewForSignOff) return;\n    if (!signOffReason.trim()) {\n      toast({\n        title: 'Reason Required',\n        description: 'Please provide a reason for this status change',\n        variant: 'destructive',\n      });\n      return;\n    }\n    signOffCrewMutation.mutate({ crewId: selectedCrewForSignOff.id, reason: signOffReason.trim() });\n  };\n\n  // Sign on crew member mutation\n  const signOnCrewMutation = useMutation({\n    mutationFn: async ({ crewId, reason }: { crewId: string; reason: string }) => {\n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          status: 'onBoard',\n          statusChangeReason: reason,\n        }),\n      });\n      if (!response.ok) {\n        const errorData = await response.text();\n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to sign on crew member');\n        } catch {\n          throw new Error(`Sign-on failed (${response.status}): ${errorData}`);\n        }\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      setSignOnDialogOpen(false);\n      setSelectedCrewForSignOn(null);\n      setSignOnReason('');\n      toast({\n        title: 'Success',\n        description: 'Crew member signed on successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to sign on crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Handle sign on with reason dialog\n  const handleSignOnClick = (member: CrewMemberWithDetails) => {\n    setSelectedCrewForSignOn(member);\n    setSignOnReason('');\n    setSignOnDialogOpen(true);\n  };\n\n  const handleSignOnConfirm = () => {\n    if (!selectedCrewForSignOn) return;\n    if (!signOnReason.trim()) {\n      toast({\n        title: 'Reason Required',\n        description: 'Please provide a reason for this status change',\n        variant: 'destructive',\n      });\n      return;\n    }\n    signOnCrewMutation.mutate({ crewId: selectedCrewForSignOn.id, reason: signOnReason.trim() });\n  };\n\n  // Delete crew member mutation\n  const deleteCrewMutation = useMutation({\n    mutationFn: async (crewId: string) => {\n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'DELETE',\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) {\n        const errorData = await response.text();\n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to delete crew member');\n        } catch {\n          throw new Error(`Delete failed (${response.status}): ${errorData}`);\n        }\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      setDeleteCrewDialogOpen(false);\n      setSelectedCrewForDeletion(null);\n      toast({\n        title: 'Success',\n        description: 'Crew member deleted successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to delete crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Handle delete crew member\n  const handleDeleteClick = (member: CrewMemberWithDetails) => {\n    setSelectedCrewForDeletion(member);\n    setDeleteCrewDialogOpen(true);\n  };\n\n  const handleDeleteConfirm = () => {\n    if (!selectedCrewForDeletion) return;\n    deleteCrewMutation.mutate(selectedCrewForDeletion.id);\n  };\n\n  // Edit crew member mutation\n  const editCrewMutation = useMutation({\n    mutationFn: async (data: AddCrewFormData & { id: string; statusChangeReason?: string }) => {\n      const crewData: any = {\n        firstName: data.firstName,\n        lastName: data.lastName,\n        nationality: data.nationality,\n        dateOfBirth: data.dateOfBirth,\n        rank: data.rank,\n        phoneNumber: data.phoneNumber || null,\n        status: data.status,\n        emergencyContact: data.emergencyContactName ? {\n          name: data.emergencyContactName,\n          relationship: data.emergencyContactRelationship || '',\n          phone: data.emergencyContactPhone || '',\n          email: data.emergencyContactEmail || '',\n          postalAddress: data.emergencyContactPostalAddress || '',\n        } : null,\n      };\n      \n      if (data.statusChangeReason) {\n        crewData.statusChangeReason = data.statusChangeReason;\n      }\n      \n      const response = await fetch(`/api/crew/${data.id}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(crewData),\n      });\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.message || 'Failed to update crew member');\n      }\n      const updatedCrew = await response.json();\n      \n      // Get existing documents to update or create new ones\n      const existingDocs = selectedCrewForEdit?.documents || [];\n      \n      // Helper to update or create document\n      const saveDocument = async (type: string, docData: { documentNumber: string; issuingAuthority: string; issueDate: string; expiryDate: string }) => {\n        const existing = existingDocs.find(d => d.type === type);\n        try {\n          if (existing) {\n            console.log('Updating document:', type, existing.id);\n            const resp = await fetch(`/api/documents/${existing.id}`, {\n              method: 'PUT',\n              headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },\n              body: JSON.stringify(docData),\n            });\n            if (!resp.ok) {\n              const errData = await resp.json().catch(() => ({}));\n              console.error('Failed to update document:', type, errData);\n            }\n          } else if (docData.documentNumber || docData.expiryDate) {\n            console.log('Creating new document:', type, docData);\n            const resp = await fetch('/api/documents', {\n              method: 'POST',\n              headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },\n              body: JSON.stringify({ crewMemberId: data.id, type, ...docData }),\n            });\n            if (!resp.ok) {\n              const errData = await resp.json().catch(() => ({}));\n              console.error('Failed to create document:', type, errData);\n            } else {\n              console.log('Document created successfully:', type);\n            }\n          }\n        } catch (err) {\n          console.error('Error saving document:', type, err);\n        }\n      };\n      \n      // Save passport document\n      if (data.passportNumber || data.passportExpiryDate || existingDocs.find(d => d.type === 'passport')) {\n        await saveDocument('passport', {\n          documentNumber: data.passportNumber || 'N/A',\n          issuingAuthority: data.passportPlaceOfIssue || 'Unknown',\n          issueDate: data.passportIssueDate || new Date().toISOString().split('T')[0],\n          expiryDate: data.passportExpiryDate || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],\n        });\n      }\n      \n      // Save CDC document\n      if (data.cdcNumber || data.cdcExpiryDate || existingDocs.find(d => d.type === 'cdc')) {\n        await saveDocument('cdc', {\n          documentNumber: data.cdcNumber || 'N/A',\n          issuingAuthority: data.cdcPlaceOfIssue || 'Unknown',\n          issueDate: data.cdcIssueDate || new Date().toISOString().split('T')[0],\n          expiryDate: data.cdcExpiryDate || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],\n        });\n      }\n      \n      // Save COC document\n      if (data.cocGradeNo || data.cocExpiryDate || existingDocs.find(d => d.type === 'stcw')) {\n        await saveDocument('stcw', {\n          documentNumber: data.cocGradeNo || 'N/A',\n          issuingAuthority: data.cocPlaceOfIssue || 'Unknown',\n          issueDate: data.cocIssueDate || new Date().toISOString().split('T')[0],\n          expiryDate: data.cocExpiryDate || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],\n        });\n      }\n      \n      // Save Medical document\n      if (data.medicalApprovalNo || data.medicalExpiryDate || existingDocs.find(d => d.type === 'medical')) {\n        await saveDocument('medical', {\n          documentNumber: data.medicalApprovalNo || 'N/A',\n          issuingAuthority: data.medicalIssuingAuthority || 'Unknown',\n          issueDate: data.medicalIssueDate || new Date().toISOString().split('T')[0],\n          expiryDate: data.medicalExpiryDate || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],\n        });\n      }\n      \n      return updatedCrew;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n      toast({\n        title: 'Success',\n        description: 'Crew member updated successfully',\n      });\n      setShowEditCrewDialog(false);\n      setSelectedCrewForEdit(null);\n      setStatusChangeReason('');\n      setOriginalStatus('');\n      editCrewForm.reset();\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to update crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n\n\n  if (!vessel) return null;\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-4xl h-[80vh] max-h-[80vh] flex flex-col p-0\">\n          {/* Clean Header */}\n          <div className=\"flex-shrink-0 p-6 border-b bg-white dark:bg-gray-900\">\n            <DialogHeader>\n              <DialogTitle className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n                <Users className=\"h-5 w-5\" />\n                View Crew - {vessel.name}\n              </DialogTitle>\n              <DialogDescription className=\"text-sm text-muted-foreground mt-2\">\n                Manage crew members assigned to this vessel, view their contracts, and assign new crew members.\n              </DialogDescription>\n            </DialogHeader>\n          </div>\n          \n          {/* Content Area */}\n          <div className=\"flex-1 overflow-y-auto p-6 min-h-0\">\n            {/* Search and Action Buttons */}\n            <div className=\"flex items-center justify-between mb-6\">\n              <div className=\"flex-1 max-w-md relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search crew members...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10\"\n                  data-testid=\"crew-search-input\"\n                />\n              </div>\n              <div className=\"flex gap-3\">\n                <Button\n                  variant=\"outline\"\n                  className=\"border-blue-600 text-blue-600 hover:bg-blue-50 px-4 py-2\"\n                  onClick={() => {\n                    console.log('Add New Crew button clicked');\n                    setShowAddCrewDialog(true);\n                  }}\n                  data-testid=\"add-new-crew-button\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Add New Crew\n                </Button>\n              </div>\n            </div>\n\n            {/* Current Crew Section */}\n            <div className=\"mb-4\">\n              <h3 className=\"text-lg font-semibold text-foreground mb-4\">\n                Current Crew ({crewMembers.length})\n              </h3>\n            \n              {isLoading ? (\n                <div className=\"text-center py-8 text-muted-foreground\">Loading crew...</div>\n              ) : (\n                <div className=\"rounded-lg border border-gray-200\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow className=\"bg-gray-50 border-b\">\n                        <TableHead className=\"text-gray-700 font-medium\">Crew Member</TableHead>\n                        <TableHead className=\"text-gray-700 font-medium\">Rank</TableHead>\n                        <TableHead className=\"text-gray-700 font-medium\">Contract Status</TableHead>\n                        <TableHead className=\"text-gray-700 font-medium\">Actions</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {filteredCrew.length === 0 ? (\n                        <TableRow>\n                          <TableCell colSpan={4} className=\"text-center py-8 text-muted-foreground\">\n                            {searchTerm ? 'No crew members match your search' : 'No crew assigned to this vessel'}\n                          </TableCell>\n                        </TableRow>\n                      ) : (\n                        filteredCrew.map((member) => (\n                          <TableRow key={member.id} className=\"hover:bg-gray-50 border-b border-gray-100\" data-testid={`crew-row-${member.id}`}>\n                            <TableCell className=\"py-4\">\n                              <div className=\"flex items-center space-x-3\">\n                                <Avatar className=\"w-10 h-10 bg-gray-200\">\n                                  <AvatarFallback className=\"text-gray-600 font-medium text-sm\">\n                                    {getInitials(member.firstName, member.lastName)}\n                                  </AvatarFallback>\n                                </Avatar>\n                                <div>\n                                  <p className=\"font-medium text-gray-900 text-sm\">\n                                    {member.firstName.toUpperCase()} {member.lastName.toUpperCase()}\n                                  </p>\n                                  <p className=\"text-xs text-gray-500\">{member.nationality}</p>\n                                </div>\n                              </div>\n                            </TableCell>\n                            <TableCell className=\"text-gray-700 text-sm\">{member.rank}</TableCell>\n                            <TableCell>\n                              <Badge className=\"bg-green-100 text-green-800 border-green-200 text-xs px-2 py-1\">\n                                Active Contract\n                              </Badge>\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex space-x-1\">\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  className=\"h-8 w-8 p-0 hover:bg-gray-100\"\n                                  onClick={() => {\n                                    console.log('Viewing crew member:', member.firstName, member.lastName);\n                                    setSelectedCrewForView(member);\n                                  }}\n                                  data-testid={`view-crew-${member.id}`}\n                                >\n                                  <Eye className=\"h-4 w-4 text-gray-500\" />\n                                </Button>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  className=\"h-8 w-8 p-0 hover:bg-gray-100\"\n                                  onClick={() => {\n                                    console.log('Editing crew member:', member.firstName, member.lastName);\n                                    setSelectedCrewForEdit(member);\n                                    // Pre-populate the edit form with current crew data\n                                    editCrewForm.reset({\n                                      firstName: member.firstName,\n                                      lastName: member.lastName,\n                                      nationality: member.nationality,\n                                      dateOfBirth: typeof member.dateOfBirth === 'string' ? member.dateOfBirth : new Date(member.dateOfBirth).toISOString().split('T')[0],\n                                      rank: member.rank,\n                                      phoneNumber: member.phoneNumber || '',\n                                      status: member.status as 'onBoard' | 'onShore',\n                                      emergencyContactName: (member.emergencyContact as any)?.name || '',\n                                      emergencyContactRelationship: (member.emergencyContact as any)?.relationship || '',\n                                      emergencyContactPhone: (member.emergencyContact as any)?.phone || '',\n                                      emergencyContactEmail: (member.emergencyContact as any)?.email || '',\n                                    });\n                                    setOriginalStatus(member.status);\n                                    setStatusChangeReason('');\n                                    setShowEditCrewDialog(true);\n                                  }}\n                                  data-testid={`edit-crew-${member.id}`}\n                                >\n                                  <Edit className=\"h-4 w-4 text-gray-500\" />\n                                </Button>\n                                {member.status === 'onShore' ? (\n                                  <>\n                                    <Button\n                                      variant=\"ghost\"\n                                      size=\"sm\"\n                                      className=\"h-8 w-8 p-0 hover:bg-green-100\"\n                                      onClick={() => handleSignOnClick(member)}\n                                      disabled={signOnCrewMutation.isPending}\n                                      data-testid={`signon-crew-${member.id}`}\n                                      title=\"Sign On\"\n                                    >\n                                      <LogIn className=\"h-4 w-4 text-green-600\" />\n                                    </Button>\n                                    <Button\n                                      variant=\"ghost\"\n                                      size=\"sm\"\n                                      className=\"h-8 w-8 p-0 hover:bg-red-100\"\n                                      onClick={() => handleDeleteClick(member)}\n                                      disabled={deleteCrewMutation.isPending}\n                                      data-testid={`delete-crew-${member.id}`}\n                                      title=\"Delete\"\n                                    >\n                                      <Trash2 className=\"h-4 w-4 text-red-500\" />\n                                    </Button>\n                                  </>\n                                ) : (\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    className=\"h-8 w-8 p-0 hover:bg-orange-100\"\n                                    onClick={() => handleSignOffClick(member)}\n                                    disabled={signOffCrewMutation.isPending}\n                                    data-testid={`signoff-crew-${member.id}`}\n                                    title=\"Sign Off\"\n                                  >\n                                    <LogOut className=\"h-4 w-4 text-orange-600\" />\n                                  </Button>\n                                )}\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      ))\n                    )}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </div>\n\n\n          </div>\n\n          {/* Clean Footer */}\n          <div className=\"flex-shrink-0 border-t p-6 bg-white dark:bg-gray-900\">\n            <div className=\"flex justify-end\">\n              <Button\n                variant=\"outline\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"close-crew-management\"\n                className=\"px-6\"\n              >\n                Close\n              </Button>\n            </div>\n          </div>\n      </DialogContent>\n\n      {/* Crew Details Dialog */}\n      {selectedCrewForView && (\n        <Dialog open={!!selectedCrewForView} onOpenChange={() => setSelectedCrewForView(null)}>\n          <DialogContent className=\"sm:max-w-4xl max-h-[90vh] flex flex-col overflow-hidden\">\n            <DialogHeader className=\"flex-shrink-0\">\n              <DialogTitle className=\"text-foreground flex items-center gap-2\">\n                <Eye className=\"h-5 w-5\" />\n                Crew Member Details - {selectedCrewForView.firstName} {selectedCrewForView.lastName}\n              </DialogTitle>\n              <DialogDescription>\n                Complete profile information including personal details, contract status, and documents.\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"flex-1 overflow-y-auto space-y-4 pr-2\">\n              {/* 1. Seafarer Details */}\n              <div className=\"p-4 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg\">\n                <h4 className=\"font-medium text-blue-900 dark:text-blue-100 flex items-center mb-3\">\n                  <div className=\"w-2 h-2 bg-blue-600 rounded-full mr-3\"></div>\n                  Seafarer Details\n                </h4>\n                <div className=\"text-sm space-y-2\">\n                  <p><span className=\"font-medium\">Full Name:</span> {selectedCrewForView.firstName} {selectedCrewForView.lastName}</p>\n                  <p><span className=\"font-medium\">Nationality:</span> {selectedCrewForView.nationality}</p>\n                  <p><span className=\"font-medium\">Rank:</span> {selectedCrewForView.rank}</p>\n                  <p><span className=\"font-medium\">Date of Birth:</span> {selectedCrewForView.dateOfBirth ? formatDate(selectedCrewForView.dateOfBirth) : 'Not provided'}</p>\n                  <p><span className=\"font-medium\">Phone:</span> {selectedCrewForView.phoneNumber || 'Not provided'}</p>\n                  <p><span className=\"font-medium\">Status:</span> <Badge className={selectedCrewForView.status === 'active' ? 'bg-green-500' : 'bg-gray-500'}>{selectedCrewForView.status}</Badge></p>\n                </div>\n              </div>\n\n              {/* 2. CDC No */}\n              {(() => {\n                const cdc = selectedCrewForView.documents?.find(d => d.type === 'cdc');\n                return (\n                  <div className=\"p-4 bg-teal-50 dark:bg-teal-950/20 border border-teal-200 dark:border-teal-800 rounded-lg\">\n                    <h4 className=\"font-medium text-teal-900 dark:text-teal-100 flex items-center mb-3\">\n                      <div className=\"w-2 h-2 bg-teal-600 rounded-full mr-3\"></div>\n                      CDC No\n                    </h4>\n                    <div className=\"text-sm space-y-2\">\n                      <p><span className=\"font-medium\">CDC Number:</span> {cdc?.documentNumber || 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Place of Issue:</span> {cdc?.issuingAuthority || 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Issue Date:</span> {cdc?.issueDate ? formatDate(cdc.issueDate) : 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Expiry Date:</span> {cdc?.expiryDate ? formatDate(cdc.expiryDate) : 'Not provided'}</p>\n                    </div>\n                  </div>\n                );\n              })()}\n\n              {/* 3. Passport Details */}\n              {(() => {\n                const passport = selectedCrewForView.documents?.find(d => d.type === 'passport');\n                return (\n                  <div className=\"p-4 bg-indigo-50 dark:bg-indigo-950/20 border border-indigo-200 dark:border-indigo-800 rounded-lg\">\n                    <h4 className=\"font-medium text-indigo-900 dark:text-indigo-100 flex items-center mb-3\">\n                      <div className=\"w-2 h-2 bg-indigo-600 rounded-full mr-3\"></div>\n                      Passport Details\n                    </h4>\n                    <div className=\"text-sm space-y-2\">\n                      <p><span className=\"font-medium\">Passport Number:</span> {passport?.documentNumber || 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Place of Issue:</span> {passport?.issuingAuthority || 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Issue Date:</span> {passport?.issueDate ? formatDate(passport.issueDate) : 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Expiry Date:</span> {passport?.expiryDate ? formatDate(passport.expiryDate) : 'Not provided'}</p>\n                    </div>\n                  </div>\n                );\n              })()}\n\n              {/* 4. Next of Kin (NOK) */}\n              <div className=\"p-4 bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-800 rounded-lg\">\n                <h4 className=\"font-medium text-orange-900 dark:text-orange-100 flex items-center mb-3\">\n                  <div className=\"w-2 h-2 bg-orange-600 rounded-full mr-3\"></div>\n                  Next of Kin (NOK)\n                </h4>\n                <div className=\"text-sm space-y-2\">\n                  <p><span className=\"font-medium\">Name:</span> {(selectedCrewForView.emergencyContact as any)?.name || 'Not provided'}</p>\n                  <p><span className=\"font-medium\">Relationship:</span> {(selectedCrewForView.emergencyContact as any)?.relationship || 'Not provided'}</p>\n                  <p><span className=\"font-medium\">Phone:</span> {(selectedCrewForView.emergencyContact as any)?.phone || 'Not provided'}</p>\n                  <p>\n                    <span className=\"font-medium\">Email:</span>{' '}\n                    {(selectedCrewForView.emergencyContact as any)?.email ? (\n                      <a \n                        href={`mailto:${(selectedCrewForView.emergencyContact as any).email}`}\n                        className=\"text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline\"\n                      >\n                        {(selectedCrewForView.emergencyContact as any).email}\n                      </a>\n                    ) : (\n                      'Not provided'\n                    )}\n                  </p>\n                  <p><span className=\"font-medium\">Postal Address:</span> {(selectedCrewForView.emergencyContact as any)?.postalAddress || 'Not provided'}</p>\n                </div>\n              </div>\n\n              {/* 5. Details of Competency Certificates */}\n              {(() => {\n                const coc = selectedCrewForView.documents?.find(d => d.type === 'stcw');\n                return (\n                  <div className=\"p-4 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg\">\n                    <h4 className=\"font-medium text-amber-900 dark:text-amber-100 flex items-center mb-3\">\n                      <div className=\"w-2 h-2 bg-amber-600 rounded-full mr-3\"></div>\n                      Details of Competency Certificates\n                    </h4>\n                    <div className=\"text-sm space-y-2\">\n                      <p><span className=\"font-medium\">COC Grade/Number:</span> {coc?.documentNumber || 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Place of Issue:</span> {coc?.issuingAuthority || 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Issue Date:</span> {coc?.issueDate ? formatDate(coc.issueDate) : 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Expiry Date:</span> {coc?.expiryDate ? formatDate(coc.expiryDate) : 'Not provided'}</p>\n                    </div>\n                  </div>\n                );\n              })()}\n\n              {/* 6. Details of Medical Certificate */}\n              {(() => {\n                const medical = selectedCrewForView.documents?.find(d => d.type === 'medical');\n                return (\n                  <div className=\"p-4 bg-rose-50 dark:bg-rose-950/20 border border-rose-200 dark:border-rose-800 rounded-lg\">\n                    <h4 className=\"font-medium text-rose-900 dark:text-rose-100 flex items-center mb-3\">\n                      <div className=\"w-2 h-2 bg-rose-600 rounded-full mr-3\"></div>\n                      Details of Medical Certificate\n                    </h4>\n                    <div className=\"text-sm space-y-2\">\n                      <p><span className=\"font-medium\">Issuing Authority:</span> {medical?.issuingAuthority || 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Approval Number:</span> {medical?.documentNumber || 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Issue Date:</span> {medical?.issueDate ? formatDate(medical.issueDate) : 'Not provided'}</p>\n                      <p><span className=\"font-medium\">Expiry Date:</span> {medical?.expiryDate ? formatDate(medical.expiryDate) : 'Not provided'}</p>\n                    </div>\n                  </div>\n                );\n              })()}\n\n              {/* 7. Details of Ship */}\n              <div className=\"p-4 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg\">\n                <h4 className=\"font-medium text-green-900 dark:text-green-100 flex items-center mb-3\">\n                  <div className=\"w-2 h-2 bg-green-600 rounded-full mr-3\"></div>\n                  Details of Ship\n                </h4>\n                <div className=\"text-sm space-y-2\">\n                  <p><span className=\"font-medium\">Vessel Name:</span> {selectedCrewForView.currentVessel?.name || 'Not assigned'}</p>\n                  <p><span className=\"font-medium\">Vessel Type:</span> {selectedCrewForView.currentVessel?.type || 'Not provided'}</p>\n                  <p><span className=\"font-medium\">IMO Number:</span> {selectedCrewForView.currentVessel?.imoNumber || 'Not provided'}</p>\n                  <p><span className=\"font-medium\">Flag:</span> {selectedCrewForView.currentVessel?.flag || 'Not provided'}</p>\n                </div>\n              </div>\n\n              {/* 8. Contract Information */}\n              <div className=\"p-4 bg-purple-50 dark:bg-purple-950/20 border border-purple-200 dark:border-purple-800 rounded-lg\">\n                <h4 className=\"font-medium text-purple-900 dark:text-purple-100 flex items-center mb-3\">\n                  <div className=\"w-2 h-2 bg-purple-600 rounded-full mr-3\"></div>\n                  Contract Information\n                </h4>\n                <div className=\"text-sm space-y-2\">\n                  <p><span className=\"font-medium\">Start Date:</span> {selectedCrewForView.activeContract?.startDate ? formatDate(selectedCrewForView.activeContract.startDate) : 'Not provided'}</p>\n                  <p><span className=\"font-medium\">End Date:</span> {selectedCrewForView.activeContract?.endDate ? formatDate(selectedCrewForView.activeContract.endDate) : 'Not provided'}</p>\n                  <p><span className=\"font-medium\">Status:</span> {selectedCrewForView.activeContract ? <Badge className={getStatusColor(selectedCrewForView.activeContract.status)}>{selectedCrewForView.activeContract.status}</Badge> : 'No active contract'}</p>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-2 pt-4 border-t flex-shrink-0\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setSelectedCrewForView(null)}\n                data-testid=\"close-crew-details\"\n              >\n                Close\n              </Button>\n            </div>\n          </DialogContent>\n        </Dialog>\n      )}\n\n      {/* Add New Crew Dialog */}\n      {showAddCrewDialog && (\n        <Dialog open={showAddCrewDialog} onOpenChange={setShowAddCrewDialog}>\n          <DialogContent className=\"sm:max-w-3xl max-h-[95vh] overflow-hidden\">\n            <DialogHeader className=\"px-6 pt-6 pb-2\">\n              <DialogTitle className=\"text-foreground flex items-center gap-2\">\n                <Plus className=\"h-5 w-5\" />\n                Add New Crew Member\n              </DialogTitle>\n              <DialogDescription>\n                Create a new crew member profile with personal and emergency contact information. They will be automatically assigned to {vessel?.name}.\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"px-6 pb-6 overflow-y-auto max-h-[calc(95vh-120px)]\">\n              {/* OCR Document Scanner */}\n              <div className=\"mb-4\">\n                <OCRDocumentScanner \n                  onDataExtracted={handleOCRDataExtracted}\n                  className=\"w-full\"\n                  mode=\"seafarer\"\n                />\n              </div>\n              \n              <Form {...addCrewForm}>\n                <form onSubmit={addCrewForm.handleSubmit((data) => addCrewMutation.mutate(data))} className=\"space-y-4\">\n                {/* Personal Information */}\n                <div className=\"space-y-3 p-4 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-blue-900 dark:text-blue-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-blue-600 rounded-full mr-3\"></div>\n                    Personal Information\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"firstName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>First Name</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter first name\" {...field} data-testid=\"input-firstName\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"lastName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Last Name</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter last name\" {...field} data-testid=\"input-lastName\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"nationality\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Nationality</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter nationality\" {...field} data-testid=\"input-nationality\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"dateOfBirth\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Date of Birth</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"input-dateOfBirth\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                  \n                  <FormField\n                    control={addCrewForm.control}\n                    name=\"phoneNumber\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Phone Number (Optional)</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"Enter phone number\" {...field} data-testid=\"input-phoneNumber\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                {/* Professional Information */}\n                <div className=\"space-y-3 p-4 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-green-900 dark:text-green-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-green-600 rounded-full mr-3\"></div>\n                    Professional Information\n                  </h3>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"rank\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Rank</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-rank\">\n                                <SelectValue placeholder=\"Select rank\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"Captain\">Captain</SelectItem>\n                              <SelectItem value=\"Master (NCV)\">Master (NCV)</SelectItem>\n                              <SelectItem value=\"Chief Engineer\">Chief Engineer</SelectItem>\n                              <SelectItem value=\"Chief Engineer (NCV)\">Chief Engineer (NCV)</SelectItem>\n                              <SelectItem value=\"2nd Engineer\">2nd Engineer</SelectItem>\n                              <SelectItem value=\"3rd Engineer\">3rd Engineer</SelectItem>\n                              <SelectItem value=\"4th Engineer\">4th Engineer</SelectItem>\n                              <SelectItem value=\"Chief Officer\">Chief Officer</SelectItem>\n                              <SelectItem value=\"Chief Officer (NCV)\">Chief Officer (NCV)</SelectItem>\n                              <SelectItem value=\"Second Officer\">Second Officer</SelectItem>\n                              <SelectItem value=\"Third Officer\">Third Officer</SelectItem>\n                              <SelectItem value=\"IV Master\">IV Master</SelectItem>\n                              <SelectItem value=\"Second Master (IV)\">Second Master (IV)</SelectItem>\n                              <SelectItem value=\"Bosun\">Bosun</SelectItem>\n                              <SelectItem value=\"AB Seaman\">AB Seaman</SelectItem>\n                              <SelectItem value=\"Deck Watchkeeping Rating (AB)\">Deck Watchkeeping Rating (AB)</SelectItem>\n                              <SelectItem value=\"Engine Rating\">Engine Rating</SelectItem>\n                              <SelectItem value=\"Cook\">Cook</SelectItem>\n                              <SelectItem value=\"2nd Cook\">2nd Cook</SelectItem>\n                              <SelectItem value=\"Saloon Rating\">Saloon Rating</SelectItem>\n                              <SelectItem value=\"Oiler\">Oiler</SelectItem>\n                              <SelectItem value=\"Wiper\">Wiper</SelectItem>\n                              <SelectItem value=\"Fitter\">Fitter</SelectItem>\n                              <SelectItem value=\"Handler\">Handler</SelectItem>\n                              <SelectItem value=\"Tube Operator\">Tube Operator</SelectItem>\n                              <SelectItem value=\"Lathe Operator\">Lathe Operator</SelectItem>\n                              <SelectItem value=\"Radio Officer\">Radio Officer</SelectItem>\n                              <SelectItem value=\"ETO\">ETO</SelectItem>\n                              <SelectItem value=\"ASST ETO\">ASST ETO</SelectItem>\n                              <SelectItem value=\"GMDSS OPERATOR\">GMDSS OPERATOR</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    \n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"status\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Status</FormLabel>\n                          <FormControl>\n                            <RadioGroup\n                              onValueChange={field.onChange}\n                              value={field.value || 'onBoard'}\n                              className=\"flex flex-col space-y-2\"\n                              data-testid=\"status-radio-group-crew-mgmt\"\n                            >\n                              <div className=\"flex items-center space-x-2\">\n                                <RadioGroupItem value=\"onBoard\" id=\"onBoard-crew-mgmt\" />\n                                <Label htmlFor=\"onBoard-crew-mgmt\" className=\"cursor-pointer\">On Board</Label>\n                              </div>\n                              <div className=\"flex items-center space-x-2\">\n                                <RadioGroupItem value=\"onShore\" id=\"onShore-crew-mgmt\" />\n                                <Label htmlFor=\"onShore-crew-mgmt\" className=\"cursor-pointer\">On Shore</Label>\n                              </div>\n                            </RadioGroup>\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Emergency Contact */}\n                <div className=\"space-y-3 p-4 bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-orange-900 dark:text-orange-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-orange-600 rounded-full mr-3\"></div>\n                    Emergency Contact (Optional)\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"emergencyContactName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Contact Name</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter contact name\" {...field} data-testid=\"input-emergencyContactName\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"emergencyContactRelationship\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Relationship</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"input-emergencyContactRelationship\">\n                                <SelectValue placeholder=\"Select relationship\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"Spouse\">Spouse</SelectItem>\n                              <SelectItem value=\"Wife\">Wife</SelectItem>\n                              <SelectItem value=\"Parent\">Parent</SelectItem>\n                              <SelectItem value=\"Child\">Child</SelectItem>\n                              <SelectItem value=\"Sibling\">Sibling</SelectItem>\n                              <SelectItem value=\"Friend\">Friend</SelectItem>\n                              <SelectItem value=\"Other\">Other</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"emergencyContactPhone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Contact Phone</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter contact phone\" {...field} data-testid=\"input-emergencyContactPhone\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"emergencyContactEmail\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Contact Email</FormLabel>\n                          <FormControl>\n                            <Input type=\"email\" placeholder=\"Enter contact email\" {...field} data-testid=\"input-emergencyContactEmail\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                  <FormField\n                    control={addCrewForm.control}\n                    name=\"emergencyContactPostalAddress\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Postal Address</FormLabel>\n                        <FormControl>\n                          <Textarea placeholder=\"Enter postal address\" {...field} data-testid=\"input-emergencyContactPostalAddress\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                {/* Passport Details */}\n                <div className=\"space-y-3 p-4 bg-purple-50 dark:bg-purple-950/20 border border-purple-200 dark:border-purple-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-purple-900 dark:text-purple-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-purple-600 rounded-full mr-3\"></div>\n                    Passport Details\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"passportNumber\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Passport Number</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter passport number\" {...field} data-testid=\"input-passportNumber\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"passportPlaceOfIssue\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Place of Issue</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter place of issue\" {...field} data-testid=\"input-passportPlaceOfIssue\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"passportIssueDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issue Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"input-passportIssueDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"passportExpiryDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Expiry Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"input-passportExpiryDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* CDC Details */}\n                <div className=\"space-y-3 p-4 bg-teal-50 dark:bg-teal-950/20 border border-teal-200 dark:border-teal-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-teal-900 dark:text-teal-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-teal-600 rounded-full mr-3\"></div>\n                    CDC Details\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"cdcNumber\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>CDC Number</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter CDC number\" {...field} data-testid=\"input-cdcNumber\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"cdcPlaceOfIssue\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Place of Issue</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter place of issue\" {...field} data-testid=\"input-cdcPlaceOfIssue\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"cdcIssueDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issue Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"input-cdcIssueDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"cdcExpiryDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Expiry Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"input-cdcExpiryDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* COC Details */}\n                <div className=\"space-y-3 p-4 bg-indigo-50 dark:bg-indigo-950/20 border border-indigo-200 dark:border-indigo-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-indigo-900 dark:text-indigo-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-indigo-600 rounded-full mr-3\"></div>\n                    COC Details\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"cocGradeNo\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Grade / Certificate Number</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter COC grade/number\" {...field} data-testid=\"input-cocGradeNo\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"cocPlaceOfIssue\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Place of Issue</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter place of issue\" {...field} data-testid=\"input-cocPlaceOfIssue\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"cocIssueDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issue Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"input-cocIssueDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"cocExpiryDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Expiry Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"input-cocExpiryDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Medical Certificate Details */}\n                <div className=\"space-y-3 p-4 bg-rose-50 dark:bg-rose-950/20 border border-rose-200 dark:border-rose-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-rose-900 dark:text-rose-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-rose-600 rounded-full mr-3\"></div>\n                    Medical Certificate Details\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"medicalIssuingAuthority\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issuing Authority</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter issuing authority\" {...field} data-testid=\"input-medicalIssuingAuthority\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"medicalApprovalNo\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Approval Number</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter approval number\" {...field} data-testid=\"input-medicalApprovalNo\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"medicalIssueDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issue Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"input-medicalIssueDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"medicalExpiryDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Expiry Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"input-medicalExpiryDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Contract Information */}\n                <div className=\"space-y-3 p-4 bg-purple-50 dark:bg-purple-950/20 border border-purple-200 dark:border-purple-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-purple-900 dark:text-purple-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-purple-600 rounded-full mr-3\"></div>\n                    Contract Information\n                  </h3>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"contractStartDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Contract Start Date</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"date\" \n                              {...field} \n                              data-testid=\"input-contractStartDate\"\n                              onChange={(e) => {\n                                field.onChange(e);\n                                // Calculate end date when start date changes\n                                const startDate = e.target.value;\n                                const duration = addCrewForm.getValues('contractDurationDays');\n                                if (startDate && duration) {\n                                  const start = new Date(startDate);\n                                  const end = new Date(start);\n                                  end.setDate(start.getDate() + duration);\n                                  addCrewForm.setValue('contractEndDate', end.toISOString().split('T')[0]);\n                                }\n                              }}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    \n                    <FormField\n                      control={addCrewForm.control}\n                      name=\"contractDurationDays\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Duration (Days)</FormLabel>\n                          <FormControl>\n                            <Input \n                              type=\"number\" \n                              min=\"1\"\n                              placeholder=\"e.g., 90\"\n                              {...field}\n                              value={field.value || 90}\n                              data-testid=\"input-contractDurationDays\"\n                              onChange={(e) => {\n                                const duration = parseInt(e.target.value) || 0;\n                                field.onChange(duration);\n                                // Calculate end date when duration changes\n                                const startDate = addCrewForm.getValues('contractStartDate');\n                                if (startDate && duration > 0) {\n                                  const start = new Date(startDate);\n                                  const end = new Date(start);\n                                  end.setDate(start.getDate() + duration);\n                                  addCrewForm.setValue('contractEndDate', end.toISOString().split('T')[0]);\n                                }\n                              }}\n                            />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                  \n                  <FormField\n                    control={addCrewForm.control}\n                    name=\"contractEndDate\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Contract End Date (Auto-calculated)</FormLabel>\n                        <FormControl>\n                          <Input \n                            type=\"date\" \n                            {...field} \n                            data-testid=\"input-contractEndDate\"\n                            readOnly\n                            className=\"bg-gray-50 dark:bg-gray-800 cursor-not-allowed\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                <div className=\"flex justify-end gap-2 pt-4\">\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      onClick={() => setShowAddCrewDialog(false)}\n                      data-testid=\"cancel-add-crew\"\n                    >\n                      Cancel\n                    </Button>\n                    <Button\n                      type=\"submit\"\n                      className=\"bg-maritime-navy hover:bg-blue-800\"\n                      disabled={addCrewMutation.isPending}\n                      data-testid=\"submit-add-crew\"\n                    >\n                      {addCrewMutation.isPending ? 'Adding...' : 'Add Crew Member'}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </div>\n          </DialogContent>\n        </Dialog>\n      )}\n\n      {/* Edit Crew Dialog */}\n      {selectedCrewForEdit && (\n        <Dialog open={showEditCrewDialog} onOpenChange={setShowEditCrewDialog}>\n          <DialogContent className=\"sm:max-w-2xl max-h-[95vh] overflow-hidden flex flex-col\">\n            <DialogHeader>\n              <DialogTitle className=\"text-foreground flex items-center gap-2\">\n                <Edit className=\"h-5 w-5\" />\n                Edit Crew Member - {selectedCrewForEdit.firstName} {selectedCrewForEdit.lastName}\n              </DialogTitle>\n              <DialogDescription>\n                Update crew member information and emergency contact details.\n              </DialogDescription>\n            </DialogHeader>\n            \n            <div className=\"px-6 pb-6 overflow-y-auto max-h-[calc(95vh-120px)]\">\n              <Form {...editCrewForm}>\n                <form onSubmit={editCrewForm.handleSubmit((data) => {\n                    const isStatusChanged = originalStatus && data.status !== originalStatus;\n                    if (isStatusChanged && !statusChangeReason.trim()) {\n                      toast({\n                        title: 'Reason Required',\n                        description: 'Please provide a reason for changing the crew status.',\n                        variant: 'destructive',\n                      });\n                      return;\n                    }\n                    editCrewMutation.mutate({ \n                      ...data, \n                      id: selectedCrewForEdit.id,\n                      statusChangeReason: isStatusChanged ? statusChangeReason : undefined\n                    });\n                  })} className=\"space-y-4\">\n                {/* Personal Information */}\n                <div className=\"space-y-3 p-4 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-blue-900 dark:text-blue-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-blue-600 rounded-full mr-3\"></div>\n                    Personal Information\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"firstName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>First Name</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter first name\" {...field} data-testid=\"edit-input-firstName\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"lastName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Last Name</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter last name\" {...field} data-testid=\"edit-input-lastName\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"nationality\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Nationality</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter nationality\" {...field} data-testid=\"edit-input-nationality\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"dateOfBirth\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Date of Birth</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"edit-input-dateOfBirth\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                  \n                  <FormField\n                    control={editCrewForm.control}\n                    name=\"phoneNumber\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Phone Number (Optional)</FormLabel>\n                        <FormControl>\n                          <Input placeholder=\"Enter phone number\" {...field} data-testid=\"edit-input-phoneNumber\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                {/* Professional Information */}\n                <div className=\"space-y-3 p-4 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-green-900 dark:text-green-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-green-600 rounded-full mr-3\"></div>\n                    Professional Information\n                  </h3>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"rank\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Rank</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"edit-select-rank\">\n                                <SelectValue placeholder=\"Select rank\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"Captain\">Captain</SelectItem>\n                              <SelectItem value=\"Master (NCV)\">Master (NCV)</SelectItem>\n                              <SelectItem value=\"Chief Engineer\">Chief Engineer</SelectItem>\n                              <SelectItem value=\"Chief Engineer (NCV)\">Chief Engineer (NCV)</SelectItem>\n                              <SelectItem value=\"2nd Engineer\">2nd Engineer</SelectItem>\n                              <SelectItem value=\"3rd Engineer\">3rd Engineer</SelectItem>\n                              <SelectItem value=\"4th Engineer\">4th Engineer</SelectItem>\n                              <SelectItem value=\"Chief Officer\">Chief Officer</SelectItem>\n                              <SelectItem value=\"Chief Officer (NCV)\">Chief Officer (NCV)</SelectItem>\n                              <SelectItem value=\"Second Officer\">Second Officer</SelectItem>\n                              <SelectItem value=\"Third Officer\">Third Officer</SelectItem>\n                              <SelectItem value=\"IV Master\">IV Master</SelectItem>\n                              <SelectItem value=\"Second Master (IV)\">Second Master (IV)</SelectItem>\n                              <SelectItem value=\"Bosun\">Bosun</SelectItem>\n                              <SelectItem value=\"AB Seaman\">AB Seaman</SelectItem>\n                              <SelectItem value=\"Deck Watchkeeping Rating (AB)\">Deck Watchkeeping Rating (AB)</SelectItem>\n                              <SelectItem value=\"Engine Rating\">Engine Rating</SelectItem>\n                              <SelectItem value=\"Cook\">Cook</SelectItem>\n                              <SelectItem value=\"2nd Cook\">2nd Cook</SelectItem>\n                              <SelectItem value=\"Saloon Rating\">Saloon Rating</SelectItem>\n                              <SelectItem value=\"Oiler\">Oiler</SelectItem>\n                              <SelectItem value=\"Wiper\">Wiper</SelectItem>\n                              <SelectItem value=\"Fitter\">Fitter</SelectItem>\n                              <SelectItem value=\"Handler\">Handler</SelectItem>\n                              <SelectItem value=\"Tube Operator\">Tube Operator</SelectItem>\n                              <SelectItem value=\"Lathe Operator\">Lathe Operator</SelectItem>\n                              <SelectItem value=\"Radio Officer\">Radio Officer</SelectItem>\n                              <SelectItem value=\"ETO\">ETO</SelectItem>\n                              <SelectItem value=\"ASST ETO\">ASST ETO</SelectItem>\n                              <SelectItem value=\"GMDSS OPERATOR\">GMDSS OPERATOR</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    \n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"status\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Status</FormLabel>\n                          <FormControl>\n                            <RadioGroup\n                              onValueChange={field.onChange}\n                              value={field.value}\n                              className=\"flex flex-row space-x-4\"\n                              data-testid=\"edit-radio-status\"\n                            >\n                              <div className=\"flex items-center space-x-2\">\n                                <RadioGroupItem value=\"onBoard\" id=\"edit-onBoard\" />\n                                <Label htmlFor=\"edit-onBoard\">On Board</Label>\n                              </div>\n                              <div className=\"flex items-center space-x-2\">\n                                <RadioGroupItem value=\"onShore\" id=\"edit-onShore\" />\n                                <Label htmlFor=\"edit-onShore\">On Shore</Label>\n                              </div>\n                            </RadioGroup>\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                  \n                  {/* Status Change Reason - shows when status is being changed */}\n                  {originalStatus && editCrewForm.watch('status') !== originalStatus && (\n                    <div className=\"mt-4 p-3 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg\">\n                      <Label className=\"text-amber-900 dark:text-amber-100 font-medium\">\n                        Reason for Status Change <span className=\"text-red-500\">*</span>\n                      </Label>\n                      <p className=\"text-xs text-amber-700 dark:text-amber-300 mb-2\">\n                        Changing status from {originalStatus === 'onBoard' ? 'On Board' : 'On Shore'} to {editCrewForm.watch('status') === 'onBoard' ? 'On Board' : 'On Shore'}\n                      </p>\n                      <Textarea\n                        placeholder=\"Please provide a reason for this status change...\"\n                        value={statusChangeReason}\n                        onChange={(e) => setStatusChangeReason(e.target.value)}\n                        className=\"min-h-[80px]\"\n                        data-testid=\"edit-input-statusChangeReason\"\n                      />\n                    </div>\n                  )}\n                </div>\n\n                {/* Emergency Contact Information */}\n                <div className=\"space-y-3 p-4 bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-orange-900 dark:text-orange-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-orange-600 rounded-full mr-3\"></div>\n                    Emergency Contact Information\n                  </h3>\n                  \n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"emergencyContactName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Contact Name</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter contact name\" {...field} data-testid=\"edit-input-emergencyContactName\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"emergencyContactRelationship\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Relationship</FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"edit-input-emergencyContactRelationship\">\n                                <SelectValue placeholder=\"Select relationship\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"Spouse\">Spouse</SelectItem>\n                              <SelectItem value=\"Wife\">Wife</SelectItem>\n                              <SelectItem value=\"Parent\">Parent</SelectItem>\n                              <SelectItem value=\"Child\">Child</SelectItem>\n                              <SelectItem value=\"Sibling\">Sibling</SelectItem>\n                              <SelectItem value=\"Friend\">Friend</SelectItem>\n                              <SelectItem value=\"Other\">Other</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"emergencyContactPhone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Contact Phone</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter contact phone\" {...field} data-testid=\"edit-input-emergencyContactPhone\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"emergencyContactEmail\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Contact Email</FormLabel>\n                          <FormControl>\n                            <Input type=\"email\" placeholder=\"Enter contact email\" {...field} data-testid=\"edit-input-emergencyContactEmail\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                  <FormField\n                    control={editCrewForm.control}\n                    name=\"emergencyContactPostalAddress\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Postal Address</FormLabel>\n                        <FormControl>\n                          <Textarea placeholder=\"Enter postal address\" {...field} data-testid=\"edit-input-emergencyContactPostalAddress\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                {/* Passport Details */}\n                <div className=\"space-y-3 p-4 bg-purple-50 dark:bg-purple-950/20 border border-purple-200 dark:border-purple-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-purple-900 dark:text-purple-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-purple-600 rounded-full mr-3\"></div>\n                    Passport Details\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"passportNumber\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Passport Number</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter passport number\" {...field} data-testid=\"edit-input-passportNumber\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"passportPlaceOfIssue\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Place of Issue</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter place of issue\" {...field} data-testid=\"edit-input-passportPlaceOfIssue\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"passportIssueDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issue Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"edit-input-passportIssueDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"passportExpiryDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Expiry Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"edit-input-passportExpiryDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* CDC Details */}\n                <div className=\"space-y-3 p-4 bg-teal-50 dark:bg-teal-950/20 border border-teal-200 dark:border-teal-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-teal-900 dark:text-teal-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-teal-600 rounded-full mr-3\"></div>\n                    CDC Details\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"cdcNumber\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>CDC Number</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter CDC number\" {...field} data-testid=\"edit-input-cdcNumber\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"cdcPlaceOfIssue\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Place of Issue</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter place of issue\" {...field} data-testid=\"edit-input-cdcPlaceOfIssue\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"cdcIssueDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issue Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"edit-input-cdcIssueDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"cdcExpiryDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Expiry Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"edit-input-cdcExpiryDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* COC Details */}\n                <div className=\"space-y-3 p-4 bg-indigo-50 dark:bg-indigo-950/20 border border-indigo-200 dark:border-indigo-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-indigo-900 dark:text-indigo-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-indigo-600 rounded-full mr-3\"></div>\n                    COC Details\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"cocGradeNo\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Grade / Certificate Number</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter COC grade/number\" {...field} data-testid=\"edit-input-cocGradeNo\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"cocPlaceOfIssue\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Place of Issue</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter place of issue\" {...field} data-testid=\"edit-input-cocPlaceOfIssue\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"cocIssueDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issue Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"edit-input-cocIssueDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"cocExpiryDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Expiry Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"edit-input-cocExpiryDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                {/* Medical Certificate Details */}\n                <div className=\"space-y-3 p-4 bg-rose-50 dark:bg-rose-950/20 border border-rose-200 dark:border-rose-800 rounded-lg\">\n                  <h3 className=\"text-lg font-semibold text-rose-900 dark:text-rose-100 flex items-center\">\n                    <div className=\"w-2 h-2 bg-rose-600 rounded-full mr-3\"></div>\n                    Medical Certificate Details\n                  </h3>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"medicalIssuingAuthority\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issuing Authority</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter issuing authority\" {...field} data-testid=\"edit-input-medicalIssuingAuthority\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"medicalApprovalNo\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Approval Number</FormLabel>\n                          <FormControl>\n                            <Input placeholder=\"Enter approval number\" {...field} data-testid=\"edit-input-medicalApprovalNo\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"medicalIssueDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Issue Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"edit-input-medicalIssueDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                    <FormField\n                      control={editCrewForm.control}\n                      name=\"medicalExpiryDate\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Expiry Date</FormLabel>\n                          <FormControl>\n                            <Input type=\"date\" {...field} data-testid=\"edit-input-medicalExpiryDate\" />\n                          </FormControl>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n                  </div>\n                </div>\n\n                <div className=\"flex justify-end gap-2 pt-4\">\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      onClick={() => {\n                        setShowEditCrewDialog(false);\n                        setSelectedCrewForEdit(null);\n                        setStatusChangeReason('');\n                        setOriginalStatus('');\n                        editCrewForm.reset();\n                      }}\n                      data-testid=\"cancel-edit-crew\"\n                    >\n                      Cancel\n                    </Button>\n                    <Button\n                      type=\"submit\"\n                      className=\"bg-maritime-navy hover:bg-blue-800\"\n                      disabled={editCrewMutation.isPending}\n                      data-testid=\"submit-edit-crew\"\n                    >\n                      {editCrewMutation.isPending ? 'Updating...' : 'Update Crew Member'}\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </div>\n          </DialogContent>\n        </Dialog>\n      )}\n\n      {/* Contract Creation Dialog */}\n      <Dialog open={contractDialogOpen} onOpenChange={setContractDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Create Contract</DialogTitle>\n            <DialogDescription>\n              Set contract details for {selectedCrewForContract?.firstName} {selectedCrewForContract?.lastName}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"contract-start-date\">Start Date</Label>\n              <Input\n                id=\"contract-start-date\"\n                type=\"date\"\n                value={contractStartDate}\n                onChange={(e) => handleContractStartDateChange(e.target.value)}\n                data-testid=\"input-contract-start-date\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"contract-duration\">Duration (Days)</Label>\n              <Input\n                id=\"contract-duration\"\n                type=\"number\"\n                value={contractDuration}\n                onChange={(e) => handleContractDurationChange(e.target.value)}\n                placeholder=\"90\"\n                data-testid=\"input-contract-duration\"\n              />\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"contract-end-date\">End Date (Auto-calculated)</Label>\n              <Input\n                id=\"contract-end-date\"\n                type=\"date\"\n                value={contractEndDate}\n                readOnly\n                disabled\n                className=\"bg-muted\"\n                data-testid=\"input-contract-end-date\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"flex justify-end gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setContractDialogOpen(false);\n                setSelectedCrewForContract(null);\n                setContractStartDate('');\n                setContractDuration('90');\n                setContractEndDate('');\n              }}\n              data-testid=\"cancel-contract\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={() => {\n                if (!selectedCrewForContract || !vessel) return;\n                \n                if (!contractStartDate || !contractDuration) {\n                  toast({\n                    title: 'Error',\n                    description: 'Please fill in all contract details',\n                    variant: 'destructive',\n                  });\n                  return;\n                }\n                \n                const durationDays = parseInt(contractDuration);\n                if (isNaN(durationDays) || durationDays <= 0) {\n                  toast({\n                    title: 'Error',\n                    description: 'Please enter a valid duration',\n                    variant: 'destructive',\n                  });\n                  return;\n                }\n                \n                // First assign the crew member\n                assignCrewMutation.mutate(\n                  { crewId: selectedCrewForContract.id, vesselId: vessel.id },\n                  {\n                    onSuccess: () => {\n                      // Then create the contract\n                      createContractMutation.mutate({\n                        crewId: selectedCrewForContract.id,\n                        vesselId: vessel.id,\n                        startDate: contractStartDate,\n                        durationDays,\n                        endDate: contractEndDate,\n                      });\n                      \n                      // Close dialog and reset\n                      setContractDialogOpen(false);\n                      setSelectedCrewForContract(null);\n                      setContractStartDate('');\n                      setContractDuration('90');\n                      setContractEndDate('');\n                    },\n                  }\n                );\n              }}\n              disabled={assignCrewMutation.isPending || createContractMutation.isPending}\n              className=\"bg-maritime-navy hover:bg-blue-800\"\n              data-testid=\"confirm-contract\"\n            >\n              {assignCrewMutation.isPending || createContractMutation.isPending ? 'Creating...' : 'Create Contract'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Sign Off Reason Dialog */}\n      <Dialog open={signOffDialogOpen} onOpenChange={setSignOffDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Sign Off Crew Member</DialogTitle>\n            <DialogDescription>\n              {selectedCrewForSignOff && (\n                <>\n                  You are signing off {selectedCrewForSignOff.firstName} {selectedCrewForSignOff.lastName} from {vessel?.name || 'their current vessel'}.\n                  Please provide a reason for this status change.\n                </>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signoff-reason\">Reason for Status Change <span className=\"text-red-500\">*</span></Label>\n              <textarea\n                id=\"signoff-reason\"\n                className=\"w-full min-h-[100px] p-3 border rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-orange-600\"\n                placeholder=\"Enter the reason for signing off this crew member (required)\"\n                value={signOffReason}\n                onChange={(e) => setSignOffReason(e.target.value)}\n                data-testid=\"input-signoff-reason\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"flex justify-end space-x-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setSignOffDialogOpen(false);\n                setSelectedCrewForSignOff(null);\n                setSignOffReason('');\n              }}\n              data-testid=\"button-cancel-signoff\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSignOffConfirm}\n              disabled={signOffCrewMutation.isPending || !signOffReason.trim()}\n              data-testid=\"button-confirm-signoff\"\n              className=\"bg-orange-600 hover:bg-orange-700\"\n            >\n              {signOffCrewMutation.isPending ? 'Signing Off...' : 'Confirm Sign Off'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Sign On Reason Dialog */}\n      <Dialog open={signOnDialogOpen} onOpenChange={setSignOnDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Sign On Crew Member</DialogTitle>\n            <DialogDescription>\n              {selectedCrewForSignOn && (\n                <>\n                  You are signing on {selectedCrewForSignOn.firstName} {selectedCrewForSignOn.lastName}.\n                  Please provide a reason for this status change.\n                </>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signon-reason\">Reason for Status Change <span className=\"text-red-500\">*</span></Label>\n              <textarea\n                id=\"signon-reason\"\n                className=\"w-full min-h-[100px] p-3 border rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-green-600\"\n                placeholder=\"Enter the reason for signing on this crew member (required)\"\n                value={signOnReason}\n                onChange={(e) => setSignOnReason(e.target.value)}\n                data-testid=\"input-signon-reason\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"flex justify-end space-x-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setSignOnDialogOpen(false);\n                setSelectedCrewForSignOn(null);\n                setSignOnReason('');\n              }}\n              data-testid=\"button-cancel-signon\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSignOnConfirm}\n              disabled={signOnCrewMutation.isPending || !signOnReason.trim()}\n              data-testid=\"button-confirm-signon\"\n              className=\"bg-green-600 hover:bg-green-700\"\n            >\n              {signOnCrewMutation.isPending ? 'Signing On...' : 'Confirm Sign On'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Crew Member Confirmation Dialog */}\n      <AlertDialog open={deleteCrewDialogOpen} onOpenChange={setDeleteCrewDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Crew Member</AlertDialogTitle>\n            <AlertDialogDescription>\n              {selectedCrewForDeletion && (\n                <>\n                  Are you sure you want to delete {selectedCrewForDeletion.firstName} {selectedCrewForDeletion.lastName}? \n                  This action cannot be undone and will permanently remove all associated data including contracts and documents.\n                </>\n              )}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel\n              onClick={() => {\n                setDeleteCrewDialogOpen(false);\n                setSelectedCrewForDeletion(null);\n              }}\n              data-testid=\"button-cancel-delete-crew\"\n            >\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={handleDeleteConfirm}\n              disabled={deleteCrewMutation.isPending}\n              data-testid=\"button-confirm-delete-crew\"\n              className=\"bg-red-600 hover:bg-red-700\"\n            >\n              {deleteCrewMutation.isPending ? 'Deleting...' : 'Delete'}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </Dialog>\n  );\n}","path":null,"size_bytes":136871,"size_tokens":null},"deployment/server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","path":null,"size_bytes":483,"size_tokens":null},"server/ocrService.ts":{"content":"import OpenAI from \"openai\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\nexport interface ExtractedCrewData {\n  name?: string;\n  position?: string;\n  nationality?: string;\n  dateOfBirth?: string;\n  passportNumber?: string;\n  seamansBookNumber?: string;\n  cdcNumber?: string;\n  phoneNumber?: string;\n  email?: string;\n  emergencyContact?: string;\n  emergencyPhone?: string;\n  contractStartDate?: string;\n  contractEndDate?: string;\n  joinDate?: string;\n  leaveDate?: string;\n  vessel?: string;\n  salary?: string;\n  // Ship Owner Details\n  shipOwnerName?: string;\n  shipOwnerContactPerson?: string;\n  shipOwnerPostalAddress?: string;\n}\n\nexport class OCRService {\n  async extractCrewDataFromDocument(base64Image: string): Promise<ExtractedCrewData> {\n    try {\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o\", // the newest OpenAI model is \"gpt-4o\" which was released May 13, 2024. do not change this unless explicitly requested by the user\n        messages: [\n          {\n            role: \"system\",\n            content: `You are an expert at extracting crew member information from maritime documents and contracts. \n            Analyze the document image and extract all relevant crew member information. \n            Focus on finding: name, position/rank, nationality, dates of birth, passport numbers, seaman's book numbers, CDC numbers, contact information, contract dates, vessel information, and salary details.\n            \n            IMPORTANT: Also extract Ship Owner Details from Section II \"Details of Ship Owner\" including:\n            - shipOwnerName: The ship owner company name (e.g., \"GLOBAL CAMBAY MARINE SERVICES PVT. LTD\")\n            - shipOwnerContactPerson: The contact person name (e.g., \"MR. ZOHAR AMALAMPATTIWALA\")\n            - shipOwnerPostalAddress: The full postal address and email if available\n            \n            Return the data in JSON format with the exact field names specified. If a field is not found or unclear, omit it from the response.\n            Be very careful with dates - format them as YYYY-MM-DD if possible.`\n          },\n          {\n            role: \"user\",\n            content: [\n              {\n                type: \"text\",\n                text: \"Extract all crew member information from this maritime document. Return only valid JSON with the available data.\"\n              },\n              {\n                type: \"image_url\",\n                image_url: {\n                  url: `data:image/jpeg;base64,${base64Image}`\n                }\n              }\n            ],\n          },\n        ],\n        response_format: { type: \"json_object\" },\n        max_tokens: 1000,\n      });\n\n      const extractedData = JSON.parse(response.choices[0].message.content || \"{}\");\n      \n      // Clean and validate the extracted data\n      const cleanedData: ExtractedCrewData = {};\n      \n      if (extractedData.name) cleanedData.name = String(extractedData.name).trim();\n      if (extractedData.position) cleanedData.position = String(extractedData.position).trim();\n      if (extractedData.nationality) cleanedData.nationality = String(extractedData.nationality).trim();\n      if (extractedData.dateOfBirth) cleanedData.dateOfBirth = String(extractedData.dateOfBirth).trim();\n      if (extractedData.passportNumber) cleanedData.passportNumber = String(extractedData.passportNumber).trim();\n      if (extractedData.seamansBookNumber) cleanedData.seamansBookNumber = String(extractedData.seamansBookNumber).trim();\n      if (extractedData.cdcNumber) cleanedData.cdcNumber = String(extractedData.cdcNumber).trim();\n      if (extractedData.phoneNumber) cleanedData.phoneNumber = String(extractedData.phoneNumber).trim();\n      if (extractedData.email) cleanedData.email = String(extractedData.email).trim();\n      if (extractedData.emergencyContact) cleanedData.emergencyContact = String(extractedData.emergencyContact).trim();\n      if (extractedData.emergencyPhone) cleanedData.emergencyPhone = String(extractedData.emergencyPhone).trim();\n      if (extractedData.contractStartDate) cleanedData.contractStartDate = String(extractedData.contractStartDate).trim();\n      if (extractedData.contractEndDate) cleanedData.contractEndDate = String(extractedData.contractEndDate).trim();\n      if (extractedData.joinDate) cleanedData.joinDate = String(extractedData.joinDate).trim();\n      if (extractedData.leaveDate) cleanedData.leaveDate = String(extractedData.leaveDate).trim();\n      if (extractedData.vessel) cleanedData.vessel = String(extractedData.vessel).trim();\n      if (extractedData.salary) cleanedData.salary = String(extractedData.salary).trim();\n      // Ship Owner Details\n      if (extractedData.shipOwnerName) cleanedData.shipOwnerName = String(extractedData.shipOwnerName).trim();\n      if (extractedData.shipOwnerContactPerson) cleanedData.shipOwnerContactPerson = String(extractedData.shipOwnerContactPerson).trim();\n      if (extractedData.shipOwnerPostalAddress) cleanedData.shipOwnerPostalAddress = String(extractedData.shipOwnerPostalAddress).trim();\n\n      return cleanedData;\n    } catch (error) {\n      console.error(\"OCR extraction error:\", error);\n      throw new Error(\"Failed to extract data from document. Please try again or enter the information manually.\");\n    }\n  }\n}\n\nexport const ocrService = new OCRService();","path":null,"size_bytes":5354,"size_tokens":null},"server/services/whatsapp-notification.ts":{"content":"import { whatsappSettings } from '@shared/schema';\n\ntype WhatsappSettings = typeof whatsappSettings.$inferSelect;\n\nexport interface WhatsAppMessage {\n  title: string;\n  description: string;\n  date: string;\n  severity: string;\n  eventType: string;\n  crewMemberName?: string;\n  vesselName?: string;\n}\n\nexport interface WhatsAppProvider {\n  sendGroupMessage(groupId: string, message: string): Promise<boolean>;\n  formatMessage(template: string, data: WhatsAppMessage): string;\n}\n\n// Twilio WhatsApp implementation\nexport class TwilioWhatsAppProvider implements WhatsAppProvider {\n  constructor(\n    private accountSid: string,\n    private authToken: string,\n    private fromNumber: string\n  ) {}\n\n  async sendGroupMessage(groupId: string, message: string): Promise<boolean> {\n    try {\n      // Note: Twilio doesn't support direct group messaging\n      // This would send to individual numbers in the group\n      const response = await fetch(`https://api.twilio.com/2010-04-01/Accounts/${this.accountSid}/Messages.json`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Basic ${Buffer.from(`${this.accountSid}:${this.authToken}`).toString('base64')}`,\n          'Content-Type': 'application/x-www-form-urlencoded',\n        },\n        body: new URLSearchParams({\n          From: `whatsapp:${this.fromNumber}`,\n          To: `whatsapp:${groupId}`, // This would be individual numbers\n          Body: message,\n        }),\n      });\n      \n      return response.ok;\n    } catch (error) {\n      console.error('Twilio WhatsApp error:', error);\n      return false;\n    }\n  }\n\n  formatMessage(template: string, data: WhatsAppMessage): string {\n    return template\n      .replace('{{title}}', data.title)\n      .replace('{{description}}', data.description)\n      .replace('{{date}}', data.date)\n      .replace('{{severity}}', data.severity);\n  }\n}\n\n// Wassenger API implementation\nexport class WassenterWhatsAppProvider implements WhatsAppProvider {\n  constructor(private apiKey: string, private apiUrl: string = 'https://api.wassenger.com/v1') {}\n\n  async sendGroupMessage(groupId: string, message: string): Promise<boolean> {\n    try {\n      const response = await fetch(`${this.apiUrl}/messages`, {\n        method: 'POST',\n        headers: {\n          'Token': this.apiKey,\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          group: groupId,\n          message: message,\n          type: 'text',\n        }),\n      });\n      \n      return response.ok;\n    } catch (error) {\n      console.error('Wassenger WhatsApp error:', error);\n      return false;\n    }\n  }\n\n  formatMessage(template: string, data: WhatsAppMessage): string {\n    return template\n      .replace('{{title}}', data.title)\n      .replace('{{description}}', data.description)\n      .replace('{{date}}', data.date)\n      .replace('{{severity}}', this.getSeverityEmoji(data.severity));\n  }\n\n  private getSeverityEmoji(severity: string): string {\n    switch (severity.toLowerCase()) {\n      case 'high': return 'üö® HIGH';\n      case 'warning': return '‚ö†Ô∏è WARNING';\n      case 'info': return '‚ÑπÔ∏è INFO';\n      default: return 'üìã ' + severity.toUpperCase();\n    }\n  }\n}\n\n// Generic webhook provider for custom integrations\nexport class WebhookWhatsAppProvider implements WhatsAppProvider {\n  constructor(private webhookUrl: string, private apiKey?: string) {}\n\n  async sendGroupMessage(groupId: string, message: string): Promise<boolean> {\n    try {\n      const headers: Record<string, string> = {\n        'Content-Type': 'application/json',\n      };\n      \n      if (this.apiKey) {\n        headers['Authorization'] = `Bearer ${this.apiKey}`;\n      }\n\n      const response = await fetch(this.webhookUrl, {\n        method: 'POST',\n        headers,\n        body: JSON.stringify({\n          groupId,\n          message,\n          timestamp: new Date().toISOString(),\n          source: 'crew-management-system',\n        }),\n      });\n      \n      return response.ok;\n    } catch (error) {\n      console.error('Webhook WhatsApp error:', error);\n      return false;\n    }\n  }\n\n  formatMessage(template: string, data: WhatsAppMessage): string {\n    return template\n      .replace('{{title}}', data.title)\n      .replace('{{description}}', data.description)\n      .replace('{{date}}', data.date)\n      .replace('{{severity}}', data.severity);\n  }\n}\n\nexport class WhatsAppNotificationService {\n  private provider: WhatsAppProvider | null = null;\n\n  constructor(private settings: WhatsappSettings) {\n    if (!settings.enabled || !settings.apiKey || !settings.groupId) {\n      return;\n    }\n\n    switch (settings.provider) {\n      case 'twilio':\n        // For Twilio, we need the account SID, auth token, and from number\n        // We'll parse these from the settings or use environment variables\n        const accountSid = process.env.TWILIO_ACCOUNT_SID || settings.apiKey?.split(':')[0];\n        const authToken = process.env.TWILIO_AUTH_TOKEN || settings.apiKey?.split(':')[1];\n        const fromNumber = process.env.TWILIO_FROM_NUMBER || settings.groupId;\n        \n        if (accountSid && authToken && fromNumber) {\n          this.provider = new TwilioWhatsAppProvider(accountSid, authToken, fromNumber);\n        } else {\n          console.error('Twilio provider requires account SID, auth token, and from number');\n        }\n        break;\n      case 'wassenger':\n        this.provider = new WassenterWhatsAppProvider(settings.apiKey);\n        break;\n      case 'whapi':\n      case 'custom':\n        if (settings.webhookUrl) {\n          this.provider = new WebhookWhatsAppProvider(settings.webhookUrl, settings.apiKey);\n        } else {\n          console.error('Custom/WHAPI provider requires webhook URL');\n        }\n        break;\n      default:\n        console.error(`Unsupported WhatsApp provider: ${settings.provider}`);\n        break;\n    }\n  }\n\n  async sendEventNotification(event: WhatsAppMessage): Promise<boolean> {\n    if (!this.provider || !this.settings.enabled) {\n      console.log('WhatsApp notifications disabled or not configured');\n      return false;\n    }\n\n    if (!this.shouldSendNotification(event.eventType)) {\n      return false;\n    }\n\n    const message = this.provider.formatMessage(\n      this.settings.messageTemplate || 'üìã *Crew Management Alert*\\n\\n{{title}}\\n{{description}}\\n\\nDate: {{date}}\\nSeverity: {{severity}}',\n      event\n    );\n\n    return await this.provider.sendGroupMessage(this.settings.groupId!, message);\n  }\n\n  private shouldSendNotification(eventType: string): boolean {\n    const notificationTypes = this.settings.notificationTypes as string[];\n    return notificationTypes.includes(eventType);\n  }\n\n  isConfigured(): boolean {\n    return this.provider !== null && (this.settings.enabled ?? false);\n  }\n}","path":null,"size_bytes":6783,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/vessels/vessel-details-dialog.tsx":{"content":"import { useState } from 'react';\nimport { useQueryClient } from '@tanstack/react-query';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Ship, Users, Flag, Hash, Edit } from 'lucide-react';\nimport { VesselWithDetails } from './vessel-cards';\nimport EditVesselForm from './edit-vessel-form';\nimport { formatDate } from '@/lib/utils';\n\ninterface VesselDetailsDialogProps {\n  vessel: VesselWithDetails | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onManageCrew?: (vessel: VesselWithDetails) => void;\n}\n\nexport default function VesselDetailsDialog({ vessel, open, onOpenChange, onManageCrew }: VesselDetailsDialogProps) {\n  const [showEditForm, setShowEditForm] = useState(false);\n  const queryClient = useQueryClient();\n\n  if (!vessel) return null;\n\n  const getStatusColor = (status: string) => {\n    switch (status.toLowerCase()) {\n      case 'harbour-mining': return 'bg-gray-600 text-white';\n      case 'coastal-mining': return 'bg-blue-600 text-white';\n      case 'world-wide': return 'bg-purple-600 text-white';\n      case 'oil-field': return 'bg-yellow-600 text-white';\n      case 'line-up-mining': return 'bg-gray-500 text-white';\n      case 'active': return 'bg-green-600 text-white';\n      default: return 'bg-gray-500 text-white';\n    }\n  };\n\n  const formatStatus = (status: string) => {\n    switch (status.toLowerCase()) {\n      case 'harbour-mining': return 'Harbour-Mining';\n      case 'coastal-mining': return 'Coastal-Mining';\n      case 'world-wide': return 'World-Wide';\n      case 'oil-field': return 'Oil-Field';\n      case 'line-up-mining': return 'Laid Up';\n      case 'active': return 'Active';\n      default: return status.split('-').map(word => \n        word.charAt(0).toUpperCase() + word.slice(1)\n      ).join('-');\n    }\n  };\n\n  const formatDateDisplay = (dateString?: string) => {\n    if (!dateString) return 'Not scheduled';\n    return formatDate(dateString);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto p-0 bg-white\" aria-describedby=\"vessel-overview-description\">\n        {/* Header */}\n        <DialogHeader className=\"p-6 pb-4 border-b\">\n          <DialogTitle className=\"text-xl font-semibold text-gray-900 flex items-center gap-2\">\n            <Ship className=\"h-5 w-5\" />\n            {vessel.name}\n            <Badge className={`${getStatusColor(vessel.status)} px-3 py-1 text-sm font-medium ml-4`}>\n              {formatStatus(vessel.status)}\n            </Badge>\n          </DialogTitle>\n        </DialogHeader>\n\n        {/* Content - Overview Only */}\n        <div className=\"px-6 pb-6 space-y-6\" id=\"vessel-overview-description\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            {/* Vessel Information */}\n            <div className=\"bg-gray-50 dark:bg-gray-800 rounded-lg p-4\">\n              <h3 className=\"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center\">\n                <Ship className=\"h-4 w-4 mr-2\" />\n                Vessel Information\n              </h3>\n              <div className=\"space-y-3\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600 dark:text-gray-400\">Type:</span>\n                  <span className=\"font-medium text-gray-900 dark:text-gray-100\">{vessel.type}</span>\n                </div>\n                {vessel.imoNumber && (\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-600 dark:text-gray-400\">IMO Number:</span>\n                    <span className=\"font-medium text-gray-900 dark:text-gray-100 flex items-center\">\n                      <Hash className=\"h-3 w-3 mr-1\" />\n                      {vessel.imoNumber}\n                    </span>\n                  </div>\n                )}\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600 dark:text-gray-400\">Flag State:</span>\n                  <span className=\"font-medium text-gray-900 dark:text-gray-100 flex items-center\">\n                    <Flag className=\"h-3 w-3 mr-1\" />\n                    {vessel.flag}\n                  </span>\n                </div>\n              </div>\n            </div>\n\n            {/* Crew Information */}\n            <div className=\"bg-gray-50 dark:bg-gray-800 rounded-lg p-4\">\n              <h3 className=\"font-semibold text-gray-900 dark:text-gray-100 mb-4 flex items-center\">\n                <Users className=\"h-4 w-4 mr-2\" />\n                Crew Information\n              </h3>\n              <div className=\"space-y-3\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-gray-600 dark:text-gray-400\">Current Crew:</span>\n                  <span className=\"font-medium text-gray-900 dark:text-gray-100\">\n                    {vessel.crewCount || 0} members\n                  </span>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Footer Actions */}\n          <div className=\"flex items-center justify-between pt-4 border-t border-gray-100\">\n            <div className=\"flex gap-3\">\n              <Button\n                variant=\"outline\"\n                className=\"border-gray-300 text-gray-700 hover:bg-gray-50\"\n                onClick={() => setShowEditForm(true)}\n                data-testid=\"edit-vessel-button\"\n              >\n                <Edit className=\"h-4 w-4 mr-2\" />\n                Edit Vessel\n              </Button>\n              <Button\n                variant=\"outline\"\n                className=\"text-gray-600 hover:bg-gray-50\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"close-vessel-button\"\n              >\n                Close\n              </Button>\n            </div>\n          </div>\n        </div>\n      </DialogContent>\n      \n      {/* Edit Vessel Form */}\n      <EditVesselForm\n        vessel={vessel}\n        open={showEditForm}\n        onOpenChange={(open) => {\n          setShowEditForm(open);\n          if (!open) {\n            // Refresh the vessel data when edit form closes\n            queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n            queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n            // Close the details dialog to force fresh data on reopening\n            onOpenChange(false);\n          }\n        }}\n      />\n    </Dialog>\n  );\n}","path":null,"size_bytes":6594,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"deployment/server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { z } from \"zod\";\nimport { \n  insertCrewMemberSchema,\n  insertVesselSchema,\n  insertDocumentSchema,\n  insertContractSchema,\n  insertCrewRotationSchema,\n  insertEmailSettingsSchema,\n  activityLogs\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { sql } from \"drizzle-orm\";\nimport { localOcrService } from \"./localOcrService\";\nimport { randomUUID } from \"crypto\";\n\n// Extend Express Request type to include user\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: { id: string; role: string; username?: string };\n    }\n  }\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  \n  // Authentication middleware (simplified for demo)\n  const authenticate = (req: any, res: any, next: any) => {\n    // In a real app, you'd verify JWT tokens here\n    // For demo, we'll just check for a basic auth header\n    const authHeader = req.headers.authorization;\n    if (!authHeader) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n    \n    // Mock authentication - in real app, decode JWT and get user\n    const mockUserId = req.headers['x-user-id'] || 'admin-id';\n    const mockRole = req.headers['x-user-role'] || 'admin';\n    const mockUsername = req.headers['x-username'] || 'admin';\n    req.user = { id: mockUserId, role: mockRole, username: mockUsername };\n    next();\n  };\n\n  // Auth routes\n  app.post(\"/api/auth/login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      const user = await storage.getUserByUsername(username);\n      \n      if (!user || user.password !== password) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      // In a real app, generate JWT token here\n      const token = `mock-token-${user.id}`;\n      \n      // Log login activity\n      try {\n        await db.insert(activityLogs).values({\n          type: 'System',\n          action: 'login',\n          entityType: 'user',\n          entityId: user.id,\n          userId: null,\n          username: user.username,\n          userRole: user.role,\n          description: `${user.role === 'admin' ? 'Admin' : 'Office Staff'} user ${user.username} logged into system`,\n          severity: 'info',\n          metadata: {\n            userRole: user.role,\n            userName: user.name\n          }\n        });\n        console.log('Login activity logged successfully');\n      } catch (logError) {\n        console.error('Failed to log login activity:', logError);\n      }\n      \n      res.json({ \n        user: { id: user.id, username: user.username, role: user.role, name: user.name, email: user.email },\n        token \n      });\n    } catch (error) {\n      res.status(500).json({ message: \"Login failed\" });\n    }\n  });\n\n  // Vessel routes\n  app.get(\"/api/vessels\", authenticate, async (req, res) => {\n    try {\n      const vessels = await storage.getVessels();\n      const crewMembers = await storage.getCrewMembers();\n      const contracts = await storage.getContracts();\n      \n      // Enhance vessel data with crew count and next crew change\n      const enhancedVessels = vessels.map(vessel => {\n        const assignedCrew = crewMembers.filter(member => member.currentVesselId === vessel.id);\n        const crewCount = assignedCrew.length;\n        \n        // Find next crew change from active contracts ending soon\n        const activeContracts = contracts.filter(contract => \n          assignedCrew.some(crew => crew.id === contract.crewMemberId) && \n          contract.status === 'active'\n        );\n        \n        // Get the earliest contract end date as next crew change\n        const nextCrewChange = activeContracts.length > 0 ? \n          Math.min(...activeContracts.map(c => c.endDate.getTime())) : null;\n        \n        return {\n          ...vessel,\n          crewCount,\n          nextCrewChange: nextCrewChange ? new Date(nextCrewChange).toISOString() : undefined\n        };\n      });\n      \n      res.json(enhancedVessels);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch vessels\" });\n    }\n  });\n\n  app.post(\"/api/vessels\", authenticate, async (req, res) => {\n    try {\n      const vesselData = insertVesselSchema.parse(req.body);\n      const vessel = await storage.createVessel(vesselData);\n      \n      // Log vessel creation activity\n      try {\n        await db.insert(activityLogs).values({\n          type: 'Fleet Management',\n          action: 'create',\n          entityType: 'vessel',\n          entityId: vessel.id,\n          userId: null,\n          username: req.user?.username || 'System',\n          userRole: req.user?.role || 'admin',\n          description: `Vessel ${vessel.name} (${vessel.type}) added to fleet - IMO: ${vessel.imoNumber} - Flag: ${vessel.flag}`,\n          severity: 'success',\n          metadata: JSON.stringify({\n            vesselName: vessel.name,\n            vesselType: vessel.type,\n            imoNumber: vessel.imoNumber,\n            flag: vessel.flag\n          })\n        });\n        console.log('Vessel creation activity logged successfully');\n      } catch (logError) {\n        console.error('Failed to log vessel creation activity:', logError);\n      }\n      \n      res.json(vessel);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid vessel data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create vessel\" });\n      }\n    }\n  });\n\n  app.put(\"/api/vessels/:id\", authenticate, async (req, res) => {\n    try {\n      const updateVesselSchema = insertVesselSchema.omit({ id: true });\n      const vesselData = updateVesselSchema.parse(req.body);\n      \n      // Get original vessel for comparison\n      const originalVessel = await storage.getVessel(req.params.id);\n      if (!originalVessel) {\n        return res.status(404).json({ message: \"Vessel not found\" });\n      }\n      \n      const updatedVessel = await storage.updateVessel(req.params.id, vesselData);\n      \n      if (updatedVessel) {\n        try {\n          // Log the update activity\n          await db.insert(activityLogs).values({\n            type: 'Fleet Management',\n            action: 'update',\n            entityType: 'vessel',\n            entityId: req.params.id,\n            userId: null,\n            username: req.user?.username || 'unknown',\n            userRole: req.user?.role || 'unknown',\n            description: `Vessel ${updatedVessel.name} (${updatedVessel.type}) updated - IMO: ${updatedVessel.imoNumber} - Flag: ${updatedVessel.flag}`,\n            severity: 'info',\n            metadata: JSON.stringify({\n              vesselName: updatedVessel.name,\n              vesselType: updatedVessel.type,\n              imoNumber: updatedVessel.imoNumber,\n              flag: updatedVessel.flag,\n              originalName: originalVessel.name,\n              changes: Object.keys(vesselData).filter(key => {\n                const originalValue = originalVessel[key as keyof typeof originalVessel];\n                const newValue = vesselData[key as keyof typeof vesselData];\n                return originalValue !== newValue;\n              })\n            })\n          });\n        } catch (logError) {\n          console.error('Failed to log vessel update activity:', logError);\n        }\n        \n        res.json(updatedVessel);\n      } else {\n        res.status(404).json({ message: \"Vessel not found\" });\n      }\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid vessel data\", errors: error.errors });\n      } else {\n        console.error('Error updating vessel:', error);\n        res.status(500).json({ message: \"Failed to update vessel\" });\n      }\n    }\n  });\n\n  app.delete(\"/api/vessels/:id\", authenticate, async (req, res) => {\n    try {\n      console.log('Attempting to delete vessel:', req.params.id);\n      \n      // Get vessel details before deletion for logging\n      const vessel = await storage.getVessel(req.params.id);\n      console.log('Found vessel:', vessel);\n      \n      if (!vessel) {\n        return res.status(404).json({ message: \"Vessel not found\" });\n      }\n      \n      const success = await storage.deleteVessel(req.params.id);\n      console.log('Deletion success:', success);\n      \n      if (success) {\n        try {\n          // Log the deletion activity directly to database\n          await db.insert(activityLogs).values({\n            type: 'Fleet Management',\n            action: 'delete',\n            entityType: 'vessel',\n            entityId: req.params.id,\n            userId: null, // Set to null due to foreign key constraint\n            username: req.user?.username || 'unknown',\n            userRole: req.user?.role || 'unknown',\n            description: `Vessel ${vessel.name} (${vessel.type}) deleted - IMO: ${vessel.imoNumber} - Flag: ${vessel.flag}`,\n            severity: 'warning',\n            metadata: JSON.stringify({\n              vesselName: vessel.name,\n              vesselType: vessel.type,\n              imoNumber: vessel.imoNumber,\n              flag: vessel.flag\n            })\n          });\n          console.log('Activity logged successfully');\n        } catch (logError) {\n          console.error('Failed to log activity:', logError);\n          // Don't fail the whole operation if logging fails\n        }\n        \n        res.json({ message: \"Vessel deleted successfully\" });\n      } else {\n        res.status(404).json({ message: \"Vessel not found\" });\n      }\n    } catch (error) {\n      console.error('Error deleting vessel:', error);\n      res.status(500).json({ message: \"Failed to delete vessel\", error: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  app.get(\"/api/vessels/:id/contract-stats\", authenticate, async (req, res) => {\n    try {\n      const vesselId = req.params.id;\n      const stats = await storage.getVesselContractStats(vesselId);\n      res.json(stats);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch contract statistics\" });\n    }\n  });\n\n  app.get(\"/api/vessels/:id/contracts\", authenticate, async (req, res) => {\n    try {\n      const vesselId = req.params.id;\n      const { status } = req.query;\n      const contracts = await storage.getVesselContracts(vesselId, status as string);\n      res.json(contracts);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch vessel contracts\" });\n    }\n  });\n\n  // Crew member routes\n  app.get(\"/api/crew\", authenticate, async (req, res) => {\n    try {\n      const { vesselId } = req.query;\n      let crewMembers;\n      \n      if (vesselId) {\n        crewMembers = await storage.getCrewMembersByVessel(vesselId as string);\n      } else {\n        crewMembers = await storage.getCrewMembers();\n      }\n      \n      res.json(crewMembers);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch crew members\" });\n    }\n  });\n\n  app.get(\"/api/crew/:id\", authenticate, async (req, res) => {\n    try {\n      const crewMember = await storage.getCrewMember(req.params.id);\n      if (!crewMember) {\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n      res.json(crewMember);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch crew member\" });\n    }\n  });\n\n  app.post(\"/api/crew\", authenticate, async (req, res) => {\n    try {\n      // Convert dateOfBirth string to Date object before validation\n      const requestBody = {\n        ...req.body,\n        dateOfBirth: new Date(req.body.dateOfBirth)\n      };\n      \n      const crewData = insertCrewMemberSchema.parse(requestBody);\n      const crewMember = await storage.createCrewMember(crewData);\n      \n      // Log crew creation activity\n      try {\n        await db.insert(activityLogs).values({\n          type: 'Crew Management',\n          action: 'create',\n          entityType: 'crew',\n          entityId: crewMember.id,\n          userId: null,\n          username: req.user?.username || 'System',\n          userRole: req.user?.role || 'admin',\n          description: `Crew member ${crewMember.firstName} ${crewMember.lastName} (${crewMember.rank}) added to system`,\n          severity: 'success',\n          metadata: {\n            crewName: `${crewMember.firstName} ${crewMember.lastName}`,\n            position: crewMember.rank,\n            nationality: crewMember.nationality\n          }\n        });\n        console.log('Crew creation activity logged successfully');\n      } catch (logError) {\n        console.error('Failed to log crew creation activity:', logError);\n      }\n      \n      res.json(crewMember);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid crew data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create crew member\" });\n      }\n    }\n  });\n\n  app.put(\"/api/crew/:id\", authenticate, async (req, res) => {\n    try {\n      const updates = insertCrewMemberSchema.partial().parse(req.body);\n      const crewMember = await storage.updateCrewMember(req.params.id, updates);\n      \n      if (!crewMember) {\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n      \n      res.json(crewMember);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid update data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to update crew member\" });\n      }\n    }\n  });\n\n  app.delete(\"/api/crew/:id\", authenticate, async (req, res) => {\n    try {\n      // Get crew member details before deletion for logging\n      const crewMember = await storage.getCrewMember(req.params.id);\n      \n      const deleted = await storage.deleteCrewMember(req.params.id);\n      \n      if (!deleted) {\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n      \n      // Log crew deletion activity\n      if (crewMember) {\n        try {\n          await db.insert(activityLogs).values({\n            type: 'Crew Management',\n            action: 'delete',\n            entityType: 'crew',\n            entityId: req.params.id,\n            userId: null,\n            username: req.user?.username || 'System',\n            userRole: req.user?.role || 'admin',\n            description: `Crew member ${crewMember.firstName} ${crewMember.lastName} (${crewMember.rank}) removed from system`,\n            severity: 'warning',\n            metadata: {\n              crewName: `${crewMember.firstName} ${crewMember.lastName}`,\n              position: crewMember.rank,\n              nationality: crewMember.nationality\n            }\n          });\n          console.log('Crew deletion activity logged successfully');\n        } catch (logError) {\n          console.error('Failed to log crew deletion activity:', logError);\n        }\n      }\n      \n      res.json({ message: \"Crew member deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete crew member\" });\n    }\n  });\n\n  // Document routes\n  app.get(\"/api/documents\", authenticate, async (req, res) => {\n    try {\n      const { crewMemberId } = req.query;\n      let documents;\n      \n      if (crewMemberId) {\n        documents = await storage.getDocumentsByCrewMember(crewMemberId as string);\n      } else {\n        documents = await storage.getDocuments();\n      }\n      \n      res.json(documents);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch documents\" });\n    }\n  });\n\n  app.post(\"/api/documents\", authenticate, async (req, res) => {\n    try {\n      const documentData = insertDocumentSchema.parse(req.body);\n      const document = await storage.createDocument(documentData);\n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid document data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create document\" });\n      }\n    }\n  });\n\n  app.put(\"/api/documents/:id\", authenticate, async (req, res) => {\n    try {\n      const updates = insertDocumentSchema.partial().parse(req.body);\n      const document = await storage.updateDocument(req.params.id, updates);\n      \n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid update data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to update document\" });\n      }\n    }\n  });\n\n  app.delete(\"/api/documents/:id\", authenticate, async (req, res) => {\n    try {\n      const success = await storage.deleteDocument(req.params.id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      res.json({ message: \"Document deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete document\" });\n    }\n  });\n\n  // Contract routes\n  app.get(\"/api/contracts\", authenticate, async (req, res) => {\n    try {\n      const { crewMemberId } = req.query;\n      let contracts;\n      \n      if (crewMemberId) {\n        contracts = await storage.getContractsByCrewMember(crewMemberId as string);\n      } else {\n        contracts = await storage.getContracts();\n      }\n      \n      res.json(contracts);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch contracts\" });\n    }\n  });\n\n  app.post(\"/api/contracts\", authenticate, async (req, res) => {\n    try {\n      const contractData = insertContractSchema.parse(req.body);\n      const contract = await storage.createContract(contractData);\n      res.json(contract);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid contract data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create contract\" });\n      }\n    }\n  });\n\n  // Crew rotation routes\n  app.get(\"/api/rotations\", authenticate, async (req, res) => {\n    try {\n      const { vesselId } = req.query;\n      let rotations;\n      \n      if (vesselId) {\n        rotations = await storage.getCrewRotationsByVessel(vesselId as string);\n      } else {\n        rotations = await storage.getCrewRotations();\n      }\n      \n      res.json(rotations);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch rotations\" });\n    }\n  });\n\n  app.post(\"/api/rotations\", authenticate, async (req, res) => {\n    try {\n      // Transform date strings to Date objects before validation\n      const transformedData = {\n        ...req.body,\n        joinDate: req.body.joinDate ? new Date(req.body.joinDate) : undefined,\n        leaveDate: req.body.leaveDate ? new Date(req.body.leaveDate) : undefined,\n      };\n      \n      const rotationData = insertCrewRotationSchema.parse(transformedData);\n      const rotation = await storage.createCrewRotation(rotationData);\n      res.json(rotation);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid rotation data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create rotation\" });\n      }\n    }\n  });\n\n  app.patch(\"/api/rotations/:id\", authenticate, async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      console.log('Updating rotation:', id, req.body);\n      \n      // Extract only the fields that can be updated, excluding id and createdAt\n      const { id: _, createdAt, ...updateFields } = req.body;\n      \n      // Transform date strings to Date objects before validation\n      const transformedData = {\n        ...updateFields,\n        joinDate: updateFields.joinDate ? new Date(updateFields.joinDate) : undefined,\n        leaveDate: updateFields.leaveDate ? new Date(updateFields.leaveDate) : undefined,\n      };\n\n      console.log('Transformed data:', transformedData);\n\n      const rotation = await storage.updateCrewRotation(id, transformedData);\n      if (!rotation) {\n        return res.status(404).json({ message: \"Rotation not found\" });\n      }\n      res.json(rotation);\n    } catch (error) {\n      console.error('Error updating rotation:', error);\n      res.status(500).json({ message: \"Failed to update rotation\", error: String(error) });\n    }\n  });\n\n  app.delete(\"/api/rotations/:id\", authenticate, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const success = await storage.deleteCrewRotation(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Rotation not found\" });\n      }\n      res.json({ message: \"Rotation deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete rotation\" });\n    }\n  });\n\n  // Alerts routes\n  app.get(\"/api/alerts/expiring-documents\", authenticate, async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 30;\n      const alerts = await storage.getExpiringDocuments(days);\n      res.json(alerts);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch expiring documents\" });\n    }\n  });\n\n  // Dashboard stats\n  app.get(\"/api/dashboard/stats\", authenticate, async (req, res) => {\n    try {\n      const crewMembers = await storage.getCrewMembers();\n      const vessels = await storage.getVessels();\n      const expiringAlerts = await storage.getExpiringDocuments(30);\n      const contracts = await storage.getContracts();\n      \n      const activeCrew = crewMembers.filter(member => member.status === 'active').length;\n      const activeVessels = vessels.filter(vessel => vessel.status === 'active').length;\n      const pendingActions = expiringAlerts.length;\n      \n      // Calculate compliance rate (documents not expiring soon)\n      const allDocuments = await storage.getDocuments();\n      const validDocuments = allDocuments.filter(doc => doc.status === 'valid').length;\n      const complianceRate = allDocuments.length > 0 ? (validDocuments / allDocuments.length) * 100 : 100;\n      \n      res.json({\n        activeCrew,\n        activeVessels,\n        pendingActions,\n        complianceRate: Math.round(complianceRate * 10) / 10,\n        totalContracts: contracts.length,\n        totalDocuments: allDocuments.length\n      });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch dashboard stats\" });\n    }\n  });\n\n  // Upcoming events endpoint\n  app.get(\"/api/upcoming-events\", authenticate, async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 30;\n      const limit = parseInt(req.query.limit as string) || 10;\n      const currentDate = new Date();\n      const futureDate = new Date();\n      futureDate.setDate(currentDate.getDate() + days);\n\n      const events: Array<{\n        id: string;\n        type: string;\n        title: string;\n        description: string;\n        date: Date;\n        severity: 'success' | 'info' | 'warning' | 'high';\n        crewMemberId?: string;\n        vesselId?: string;\n        contractId?: string;\n        documentId?: string;\n        documentType?: string;\n        rotationId?: string;\n      }> = [];\n      \n      const [vessels, crewMembers, contracts, documents, crewRotations] = await Promise.all([\n        storage.getVessels(),\n        storage.getCrewMembers(),\n        storage.getContracts(),\n        storage.getDocuments(),\n        storage.getCrewRotations()\n      ]);\n\n      // Contract renewals/expirations\n      contracts.forEach(contract => {\n        if (contract.status === 'active' && contract.endDate >= currentDate && contract.endDate <= futureDate) {\n          const crewMember = crewMembers.find(c => c.id === contract.crewMemberId);\n          const vessel = vessels.find(v => v.id === contract.vesselId);\n          \n          const daysUntil = Math.ceil((contract.endDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n          \n          events.push({\n            id: `contract-${contract.id}`,\n            type: 'contract_expiry',\n            title: 'Contract Expiring',\n            description: `${crewMember?.firstName} ${crewMember?.lastName} - ${vessel?.name} (${daysUntil} days)`,\n            date: contract.endDate,\n            severity: daysUntil <= 7 ? 'high' : daysUntil <= 15 ? 'warning' : 'info',\n            crewMemberId: contract.crewMemberId,\n            vesselId: contract.vesselId,\n            contractId: contract.id\n          });\n        }\n      });\n\n      // Document expirations\n      documents.forEach(document => {\n        if ((document.status === 'valid' || document.status === 'expiring') && document.expiryDate >= currentDate && document.expiryDate <= futureDate) {\n          const crewMember = crewMembers.find(c => c.id === document.crewMemberId);\n          \n          const daysUntil = Math.ceil((document.expiryDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n          \n          events.push({\n            id: `document-${document.id}`,\n            type: 'document_expiry',\n            title: 'Document Expiring',\n            description: `${crewMember?.firstName} ${crewMember?.lastName} - ${document.type.toUpperCase()} (${daysUntil} days)`,\n            date: document.expiryDate,\n            severity: daysUntil <= 7 ? 'high' : daysUntil <= 15 ? 'warning' : 'info',\n            crewMemberId: document.crewMemberId,\n            documentId: document.id,\n            documentType: document.type\n          });\n        }\n      });\n\n      // Crew rotations (joins and leaves)\n      crewRotations.forEach(rotation => {\n        if (rotation.status === 'scheduled') {\n          const crewMember = crewMembers.find(c => c.id === rotation.crewMemberId);\n          const vessel = vessels.find(v => v.id === rotation.vesselId);\n          \n          // Join events\n          if (rotation.joinDate >= currentDate && rotation.joinDate <= futureDate) {\n            const daysUntil = Math.ceil((rotation.joinDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n            \n            events.push({\n              id: `join-${rotation.id}`,\n              type: 'crew_join',\n              title: 'Crew Joining',\n              description: `${crewMember?.firstName} ${crewMember?.lastName} joins ${vessel?.name} (${daysUntil} days)`,\n              date: rotation.joinDate,\n              severity: daysUntil <= 3 ? 'warning' : 'info',\n              crewMemberId: rotation.crewMemberId,\n              vesselId: rotation.vesselId,\n              rotationId: rotation.id\n            });\n          }\n          \n          // Leave events\n          if (rotation.leaveDate && rotation.leaveDate >= currentDate && rotation.leaveDate <= futureDate) {\n            const daysUntil = Math.ceil((rotation.leaveDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n            \n            events.push({\n              id: `leave-${rotation.id}`,\n              type: 'crew_leave',\n              title: 'Crew Leaving',\n              description: `${crewMember?.firstName} ${crewMember?.lastName} leaves ${vessel?.name} (${daysUntil} days)`,\n              date: rotation.leaveDate,\n              severity: daysUntil <= 3 ? 'warning' : 'info',\n              crewMemberId: rotation.crewMemberId,\n              vesselId: rotation.vesselId,\n              rotationId: rotation.id\n            });\n          }\n        }\n      });\n\n      // Maintenance schedules (vessel status changes)\n      vessels.forEach(vessel => {\n        if (vessel.status === 'maintenance') {\n          // For demonstration, add maintenance completion events\n          const maintenanceCompletion = new Date();\n          maintenanceCompletion.setDate(currentDate.getDate() + Math.floor(Math.random() * 14) + 1);\n          \n          if (maintenanceCompletion <= futureDate) {\n            const daysUntil = Math.ceil((maintenanceCompletion.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n            \n            events.push({\n              id: `maintenance-${vessel.id}`,\n              type: 'maintenance_completion',\n              title: 'Maintenance Completion',\n              description: `${vessel.name} maintenance scheduled to complete (${daysUntil} days)`,\n              date: maintenanceCompletion,\n              severity: 'info',\n              vesselId: vessel.id\n            });\n          }\n        }\n      });\n\n      // Sort events by date and limit results\n      const sortedEvents = events\n        .sort((a, b) => a.date.getTime() - b.date.getTime())\n        .slice(0, limit);\n\n      res.json(sortedEvents);\n    } catch (error) {\n      console.error('Failed to fetch upcoming events:', error);\n      res.status(500).json({ message: \"Failed to fetch upcoming events\" });\n    }\n  });\n\n  // Email settings routes\n  app.get(\"/api/email-settings\", authenticate, async (req, res) => {\n    try {\n      const settings = await storage.getEmailSettings();\n      res.json(settings);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch email settings\" });\n    }\n  });\n\n  app.put(\"/api/email-settings\", authenticate, async (req, res) => {\n    try {\n      const settingsData = insertEmailSettingsSchema.parse(req.body);\n      const settings = await storage.updateEmailSettings(settingsData);\n      res.json(settings);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid settings data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to update email settings\" });\n      }\n    }\n  });\n\n  // Mock email sending endpoint\n  app.post(\"/api/email/send-test\", authenticate, async (req, res) => {\n    try {\n      // In a real app, this would integrate with SendGrid, AWS SES, etc.\n      console.log(\"Sending test email...\");\n      \n      // Simulate email sending delay\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      \n      res.json({ message: \"Test email sent successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to send test email\" });\n    }\n  });\n\n  // Contact crew member endpoint\n  app.post(\"/api/crew/contact\", authenticate, async (req, res) => {\n    try {\n      const { crewMemberId, subject, message } = req.body;\n      \n      if (!crewMemberId || !subject || !message) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n      \n      // Get crew member details\n      const crewMember = await storage.getCrewMember(crewMemberId);\n      if (!crewMember) {\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n      \n      // In a real app, this would send an actual email\n      console.log(`Sending message to crew member ${crewMember.firstName} ${crewMember.lastName}:`);\n      console.log(`Subject: ${subject}`);\n      console.log(`Message: ${message}`);\n      \n      // Simulate email sending delay\n      await new Promise(resolve => setTimeout(resolve, 800));\n      \n      res.json({ \n        message: \"Message sent successfully\",\n        recipient: `${crewMember.firstName} ${crewMember.lastName}`,\n        subject,\n        sentAt: new Date().toISOString()\n      });\n    } catch (error) {\n      console.error('Error sending crew contact message:', error);\n      res.status(500).json({ message: \"Failed to send message\" });\n    }\n  });\n\n  // System activity report endpoint\n  app.get('/api/system/activity-report', authenticate, async (req, res) => {\n    try {\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: 'Admin access required' });\n      }\n\n      // Get activity logs directly from database\n      const activities = await db\n        .select()\n        .from(activityLogs)\n        .orderBy(sql`${activityLogs.createdAt} DESC`);\n\n      res.json(activities);\n    } catch (error) {\n      console.error('Error generating activity report:', error);\n      res.status(500).json({ message: 'Failed to generate activity report', error: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  // OCR route for extracting crew data from documents\n  app.post(\"/api/ocr/extract-crew-data\", authenticate, async (req, res) => {\n    try {\n      console.log('OCR request received from user:', req.user?.username);\n      const { image, filename } = req.body;\n      \n      if (!image) {\n        console.log('No image data provided in request');\n        return res.status(400).json({ message: \"Image data is required\" });\n      }\n\n      console.log('Processing OCR request for file:', filename);\n      const extractedData = await localOcrService.extractCrewDataFromDocument(image, filename);\n      \n      // Log the OCR activity\n      try {\n        await db.insert(activityLogs).values({\n          type: \"Document Processing\",\n          action: \"ocr_document_scan\",\n          entityType: \"document\",\n          description: `Scanned crew document: ${filename || 'Unknown file'}`,\n          severity: \"info\",\n          username: req.user?.username || \"unknown\",  \n          userRole: req.user?.role || \"unknown\",\n          metadata: JSON.stringify({ filename, extractedFields: Object.keys(extractedData).length })\n        });\n      } catch (logError) {\n        console.error(\"Failed to log OCR activity:\", logError);\n      }\n\n      res.json(extractedData);\n    } catch (error) {\n      console.error(\"OCR extraction error:\", error);\n      res.status(500).json({ \n        message: error instanceof Error ? error.message : \"Failed to extract data from document\" \n      });\n    }\n  });\n\n  // File upload simulation\n  app.post(\"/api/upload\", authenticate, async (req, res) => {\n    try {\n      // In a real app, this would handle file uploads to AWS S3, etc.\n      const { filename, fileType } = req.body;\n      \n      // Simulate file processing delay\n      await new Promise(resolve => setTimeout(resolve, 500));\n      \n      const mockFilePath = `/uploads/${Date.now()}-${filename}`;\n      \n      res.json({ \n        message: \"File uploaded successfully\",\n        filePath: mockFilePath \n      });\n    } catch (error) {\n      res.status(500).json({ message: \"File upload failed\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","path":null,"size_bytes":34391,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/dashboard/stats-card.tsx":{"content":"import { Link } from 'wouter';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { TrendingUp, TrendingDown, Users, Ship, Clock, CheckCircle } from 'lucide-react';\nimport { cn } from '@/lib/utils';\n\ninterface StatsCardProps {\n  title: string;\n  value: string | number;\n  icon: 'users' | 'ship' | 'clock' | 'check';\n  trend?: {\n    value: number;\n    isPositive: boolean;\n  };\n  description?: string;\n  color: 'ocean-blue' | 'maritime-navy' | 'warning-amber' | 'compliance-green';\n  href?: string; // Optional navigation link\n}\n\nconst iconMap = {\n  users: Users,\n  ship: Ship,\n  clock: Clock,\n  check: CheckCircle,\n};\n\nconst colorClasses = {\n  'ocean-blue': 'bg-blue-100 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400',\n  'maritime-navy': 'bg-blue-900/10 dark:bg-blue-900/20 text-blue-900 dark:text-blue-300',\n  'warning-amber': 'bg-amber-100 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400',\n  'compliance-green': 'bg-green-100 dark:bg-green-900/20 text-green-600 dark:text-green-400',\n};\n\nexport default function StatsCard({ title, value, icon, trend, description, color, href }: StatsCardProps) {\n  const Icon = iconMap[icon];\n\n  const cardContent = (\n    <CardContent className=\"p-3 sm:p-4 lg:p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"min-w-0 flex-1\">\n          <p className=\"text-xs sm:text-sm font-medium muted-text truncate\" data-testid=\"stats-title\">{title}</p>\n          <p className=\"text-lg sm:text-2xl lg:text-3xl font-bold heading-text mt-1 sm:mt-2\" data-testid=\"stats-value\">\n            {typeof value === 'string' && value.length > 8 ? \n              <span className=\"text-base sm:text-xl lg:text-2xl\">{value}</span> : value\n            }\n          </p>\n        </div>\n        <div className={cn('w-8 h-8 sm:w-10 sm:h-10 lg:w-12 lg:h-12 rounded-lg flex items-center justify-center shrink-0', colorClasses[color])}>\n          <Icon className=\"h-4 w-4 sm:h-5 sm:w-5 lg:h-6 lg:w-6\" />\n        </div>\n      </div>\n      \n      <div className=\"mt-2 sm:mt-4\">\n        {trend && (\n          <div className=\"flex items-center text-xs sm:text-sm flex-wrap\">\n            {trend.isPositive ? (\n              <TrendingUp className=\"h-3 w-3 sm:h-4 sm:w-4 compliance-green mr-1\" />\n            ) : (\n              <TrendingDown className=\"h-3 w-3 sm:h-4 sm:w-4 alert-red mr-1\" />\n            )}\n            <span className={cn(\n              'font-medium',\n              trend.isPositive ? 'compliance-green' : 'alert-red'\n            )}>\n              {trend.isPositive ? '+' : '-'}{Math.abs(trend.value)}%\n            </span>\n            <span className=\"muted-text ml-2 hidden sm:inline\">from last month</span>\n          </div>\n        )}\n        \n        {description && !trend && (\n          <span className=\"muted-text text-xs sm:text-sm line-clamp-2\">{description}</span>\n        )}\n      </div>\n    </CardContent>\n  );\n\n  if (href) {\n    return (\n      <Link href={href}>\n        <Card className={cn(\"maritime-card transition-colors hover:bg-accent cursor-pointer\")} data-testid={`stats-card-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n          {cardContent}\n        </Card>\n      </Link>\n    );\n  }\n\n  return (\n    <Card className=\"maritime-card\" data-testid={`stats-card-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n      {cardContent}\n    </Card>\n  );\n}\n","path":null,"size_bytes":3346,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"client/src/pages/alerts.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Link } from 'wouter';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { queryClient } from '@/lib/queryClient';\nimport EmailSettingsModal from '@/components/modals/email-settings-modal';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogTrigger, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Badge } from '@/components/ui/badge';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { AlertTriangle, Clock, Settings, Mail, FileText, Users, ExternalLink, Edit, Send, RefreshCw, Briefcase, XCircle } from 'lucide-react';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { DocumentAlert, ContractAlert } from '@shared/schema';\nimport { format } from 'date-fns';\nimport { formatDate } from '@/lib/utils';\n\nexport default function Alerts() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [isEmailSettingsOpen, setIsEmailSettingsOpen] = useState(false);\n  const [severityFilter, setSeverityFilter] = useState('all');\n  const [contractSeverityFilter, setContractSeverityFilter] = useState('all');\n  const [selectedAlert, setSelectedAlert] = useState<DocumentAlert | null>(null);\n  const [isContactModalOpen, setIsContactModalOpen] = useState(false);\n  const [emailSubject, setEmailSubject] = useState('');\n  const [emailMessage, setEmailMessage] = useState('');\n  const [activeTab, setActiveTab] = useState('documents');\n\n  const { data: expiringDocuments, isLoading } = useQuery<DocumentAlert[]>({\n    queryKey: ['/api/alerts/expiring-documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/alerts/expiring-documents?days=90', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch alerts');\n      return response.json();\n    },\n    refetchInterval: 5 * 60 * 1000, // Refresh every 5 minutes\n  });\n\n  const { data: emailSettings } = useQuery({\n    queryKey: ['/api/email-settings'],\n    queryFn: async () => {\n      const response = await fetch('/api/email-settings', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch email settings');\n      return response.json();\n    },\n  });\n\n  const { data: expiringContracts = [], isLoading: isLoadingContracts } = useQuery<ContractAlert[]>({\n    queryKey: ['/api/alerts/expiring-contracts'],\n    queryFn: async () => {\n      const response = await fetch('/api/alerts/expiring-contracts?days=90', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch contract alerts');\n      return response.json();\n    },\n    refetchInterval: 5 * 60 * 1000,\n  });\n\n  const filteredAlerts = expiringDocuments?.filter(alert => {\n    if (severityFilter === 'all') return true;\n    return alert.severity === severityFilter;\n  }) || [];\n\n  const criticalAlerts = expiringDocuments?.filter(alert => alert.severity === 'critical') || [];\n  const warningAlerts = expiringDocuments?.filter(alert => alert.severity === 'warning') || [];\n  const infoAlerts = expiringDocuments?.filter(alert => alert.severity === 'info') || [];\n\n  const filteredContractAlerts = expiringContracts.filter(alert => {\n    if (contractSeverityFilter === 'all') return true;\n    return alert.severity === contractSeverityFilter;\n  });\n\n  const expiredContracts = expiringContracts.filter(alert => alert.severity === 'expired');\n  const criticalContracts = expiringContracts.filter(alert => alert.severity === 'critical');\n  const warningContracts = expiringContracts.filter(alert => alert.severity === 'warning');\n  const infoContracts = expiringContracts.filter(alert => alert.severity === 'info');\n\n  const getSeverityConfig = (severity: string) => {\n    switch (severity) {\n      case 'expired':\n        return {\n          color: 'bg-purple-50 dark:bg-purple-950/20 border-l-purple-600 dark:border-l-purple-400',\n          badge: 'bg-purple-600 text-white',\n          icon: XCircle,\n          iconColor: 'text-purple-600 dark:text-purple-400',\n          textColor: 'text-purple-700 dark:text-purple-300',\n        };\n      case 'critical':\n        return {\n          color: 'bg-red-50 dark:bg-red-950/20 border-l-red-500 dark:border-l-red-400',\n          badge: 'bg-alert-red text-white',\n          icon: AlertTriangle,\n          iconColor: 'text-red-500 dark:text-red-400',\n          textColor: 'text-red-700 dark:text-red-300',\n        };\n      case 'warning':\n        return {\n          color: 'bg-yellow-50 dark:bg-yellow-950/20 border-l-yellow-500 dark:border-l-yellow-400',\n          badge: 'bg-warning-amber text-white',\n          icon: Clock,\n          iconColor: 'text-yellow-500 dark:text-yellow-400',\n          textColor: 'text-yellow-700 dark:text-yellow-300',\n        };\n      case 'info':\n        return {\n          color: 'bg-blue-50 dark:bg-blue-950/20 border-l-blue-500 dark:border-l-blue-400',\n          badge: 'bg-ocean-blue text-white',\n          icon: Clock,\n          iconColor: 'text-blue-500 dark:text-blue-400',\n          textColor: 'text-blue-700 dark:text-blue-300',\n        };\n      default:\n        return {\n          color: 'bg-gray-50 dark:bg-gray-950/20 border-l-gray-500 dark:border-l-gray-400',\n          badge: 'bg-gray-500 text-white',\n          icon: Clock,\n          iconColor: 'text-gray-500 dark:text-gray-400',\n          textColor: 'text-gray-700 dark:text-gray-300',\n        };\n    }\n  };\n\n  const getInitials = (firstName: string, lastName: string) => {\n    return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();\n  };\n\n  // Contact crew member mutation\n  const contactCrewMutation = useMutation({\n    mutationFn: async (data: { crewMemberId: string; subject: string; message: string }) => {\n      const response = await fetch('/api/crew/contact', {\n        method: 'POST',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error('Failed to send message');\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Success',\n        description: 'Message sent successfully to crew member',\n      });\n      setIsContactModalOpen(false);\n      setSelectedAlert(null);\n      setEmailSubject('');\n      setEmailMessage('');\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to send message',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Refresh alerts mutation\n  const refreshAlertsMutation = useMutation({\n    mutationFn: async () => {\n      await queryClient.invalidateQueries({ queryKey: ['/api/alerts/expiring-documents'] });\n      await queryClient.invalidateQueries({ queryKey: ['/api/alerts/expiring-contracts'] });\n      await queryClient.refetchQueries({ queryKey: ['/api/alerts/expiring-documents'] });\n      await queryClient.refetchQueries({ queryKey: ['/api/alerts/expiring-contracts'] });\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Success',\n        description: 'Alerts refreshed successfully',\n      });\n    },\n    onError: () => {\n      toast({\n        title: 'Error',\n        description: 'Failed to refresh alerts',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleContactCrew = (alert: DocumentAlert) => {\n    setSelectedAlert(alert);\n    setEmailSubject(`Document Expiry Alert - ${alert.document.type.toUpperCase()}`);\n    setEmailMessage(`Dear ${alert.crewMember.firstName},\n\nYour ${alert.document.type.toUpperCase()} certificate (${alert.document.documentNumber}) is due to expire on ${formatDate(alert.document.expiryDate)} - ${alert.daysUntilExpiry} days from now.\n\nPlease arrange for renewal at your earliest convenience to maintain compliance.\n\nBest regards,\nMaritime Operations Team`);\n    setIsContactModalOpen(true);\n  };\n\n  const handleSendMessage = () => {\n    if (!selectedAlert) return;\n    \n    contactCrewMutation.mutate({\n      crewMemberId: selectedAlert.crewMember.id,\n      subject: emailSubject,\n      message: emailMessage,\n    });\n  };\n\n  if (user?.role === 'crew') {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"text-center py-12\">\n          <AlertTriangle className=\"h-16 w-16 mx-auto text-gray-300 dark:text-gray-600 mb-4\" />\n          <h2 className=\"text-2xl font-semibold text-maritime-navy dark:text-white mb-2\">Access Restricted</h2>\n          <p className=\"text-gray-600 dark:text-gray-300 mb-6\">\n            Crew members can view their document alerts on the dashboard.\n          </p>\n          <Link href=\"/dashboard\">\n            <Button\n              className=\"bg-maritime-navy hover:bg-blue-800 dark:bg-blue-600 dark:hover:bg-blue-700\"\n            >\n              Go to Dashboard\n            </Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  if (isLoading || isLoadingContracts) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-2\"></div>\n          <div className=\"h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2\"></div>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n          {Array(3).fill(0).map((_, i) => (\n            <div key={i} className=\"h-24 bg-gray-200 dark:bg-gray-700 rounded animate-pulse\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold text-maritime-navy dark:text-white mb-2\" data-testid=\"alerts-title\">\n            Expiry Alerts & Notifications\n          </h2>\n          <p className=\"text-gray-600 dark:text-gray-300\">\n            Monitor document expiry dates and configure notification settings\n          </p>\n        </div>\n        \n        <div className=\"flex space-x-2\">\n          <Button \n            variant=\"outline\" \n            onClick={() => refreshAlertsMutation.mutate()}\n            disabled={refreshAlertsMutation.isPending}\n            data-testid=\"refresh-alerts-button\"\n          >\n            <RefreshCw className={`h-4 w-4 mr-2 ${refreshAlertsMutation.isPending ? 'animate-spin' : ''}`} />\n            Refresh\n          </Button>\n          \n          <Dialog open={isEmailSettingsOpen} onOpenChange={setIsEmailSettingsOpen}>\n            <DialogTrigger asChild>\n              <Button className=\"bg-maritime-navy hover:bg-blue-800\" data-testid=\"email-settings-button\">\n                <Settings className=\"h-4 w-4 mr-2\" />\n                Email Settings\n              </Button>\n            </DialogTrigger>\n            <EmailSettingsModal \n              settings={emailSettings}\n              onClose={() => setIsEmailSettingsOpen(false)}\n            />\n          </Dialog>\n        </div>\n      </div>\n\n      {/* Alert Summary */}\n      {((expiringDocuments && expiringDocuments.length > 0) || expiringContracts.length > 0) && (\n        <Alert className=\"border-warning-amber bg-yellow-50 dark:bg-yellow-950/20 dark:border-yellow-600\">\n          <AlertTriangle className=\"h-4 w-4 text-warning-amber dark:text-yellow-400\" />\n          <AlertDescription className=\"text-gray-700 dark:text-gray-300\">\n            <span className=\"font-medium text-warning-amber dark:text-yellow-400\">Active Alerts:</span>{' '}\n            {expiringDocuments?.length || 0} document{(expiringDocuments?.length || 0) !== 1 ? 's' : ''} and {expiringContracts.length} contract{expiringContracts.length !== 1 ? 's' : ''} require attention.\n            {(criticalAlerts.length > 0 || expiredContracts.length > 0 || criticalContracts.length > 0) && \n              ` ${criticalAlerts.length + expiredContracts.length + criticalContracts.length} critical/expired alerts need immediate action.`}\n          </AlertDescription>\n        </Alert>\n      )}\n\n      {/* Alert Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">Total Alerts</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <AlertTriangle className=\"h-5 w-5 text-ocean-blue dark:text-blue-400\" />\n              <span className=\"text-2xl font-bold text-maritime-navy dark:text-white\" data-testid=\"total-alerts-count\">\n                {expiringDocuments?.length || 0}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">Critical (‚â§7 days)</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-2 h-2 bg-alert-red rounded-full\"></div>\n              <span className=\"text-2xl font-bold text-maritime-navy dark:text-white\" data-testid=\"critical-alerts-count\">\n                {criticalAlerts.length}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">Warning (‚â§15 days)</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-2 h-2 bg-warning-amber rounded-full\"></div>\n              <span className=\"text-2xl font-bold text-maritime-navy dark:text-white\" data-testid=\"warning-alerts-count\">\n                {warningAlerts.length}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500 dark:text-gray-400\">Info (‚â§30 days)</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-2 h-2 bg-ocean-blue rounded-full\"></div>\n              <span className=\"text-2xl font-bold text-maritime-navy dark:text-white\" data-testid=\"info-alerts-count\">\n                {infoAlerts.length}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Alerts Tabs */}\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-2 mb-4\">\n          <TabsTrigger value=\"documents\" className=\"flex items-center gap-2\" data-testid=\"documents-tab\">\n            <FileText className=\"h-4 w-4\" />\n            Documents ({expiringDocuments?.length || 0})\n          </TabsTrigger>\n          <TabsTrigger value=\"contracts\" className=\"flex items-center gap-2\" data-testid=\"contracts-tab\">\n            <Briefcase className=\"h-4 w-4\" />\n            Contracts ({expiringContracts.length})\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Document Expiry Alerts Tab */}\n        <TabsContent value=\"documents\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"text-maritime-navy dark:text-white\">Document Expiry Alerts</CardTitle>\n                \n                <div className=\"flex items-center space-x-4\">\n                  <Select value={severityFilter} onValueChange={setSeverityFilter}>\n                    <SelectTrigger className=\"w-32\" data-testid=\"severity-filter\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Severity</SelectItem>\n                      <SelectItem value=\"critical\">Critical</SelectItem>\n                      <SelectItem value=\"warning\">Warning</SelectItem>\n                      <SelectItem value=\"info\">Info</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {filteredAlerts.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <FileText className=\"h-16 w-16 mx-auto text-gray-300 dark:text-gray-600 mb-4\" />\n                  <h3 className=\"text-lg font-semibold text-gray-500 dark:text-gray-400 mb-2\">No Alerts</h3>\n                  <p className=\"text-gray-400 dark:text-gray-500\">All documents are up to date</p>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {filteredAlerts.map((alert) => {\n                    const config = getSeverityConfig(alert.severity);\n                    const Icon = config.icon;\n                    \n                    return (\n                      <div\n                        key={alert.document.id}\n                        className={`p-4 border-l-4 rounded-r ${config.color}`}\n                        data-testid={`alert-item-${alert.document.id}`}\n                      >\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex items-start space-x-4\">\n                            <Avatar className=\"bg-maritime-navy mt-1\">\n                              <AvatarFallback className=\"text-white font-medium\">\n                                {getInitials(alert.crewMember.firstName, alert.crewMember.lastName)}\n                              </AvatarFallback>\n                            </Avatar>\n                            \n                            <div className=\"flex-1\">\n                              <div className=\"flex items-center space-x-3 mb-2\">\n                                <h4 className={`font-semibold ${config.textColor}`} data-testid=\"alert-crew-name\">\n                                  {alert.crewMember.firstName} {alert.crewMember.lastName}\n                                </h4>\n                                <Badge className={config.badge} data-testid=\"alert-severity\">\n                                  {alert.severity.toUpperCase()}\n                                </Badge>\n                              </div>\n                              \n                              <div className=\"space-y-1\">\n                                <p className=\"text-gray-900 dark:text-gray-100 font-medium\" data-testid=\"alert-document-info\">\n                                  {alert.document.type.toUpperCase()} Certificate - {alert.document.documentNumber}\n                                </p>\n                                <p className=\"text-sm text-gray-600 dark:text-gray-300\" data-testid=\"alert-expiry-info\">\n                                  Expires: {formatDate(alert.document.expiryDate)} \n                                  ({alert.daysUntilExpiry} days remaining)\n                                </p>\n                                <p className=\"text-sm text-gray-500 dark:text-gray-400\">\n                                  Issued by: {alert.document.issuingAuthority}\n                                </p>\n                              </div>\n                            </div>\n                          </div>\n                          \n                          <div className=\"flex items-center space-x-2\">\n                            <Icon className={`h-5 w-5 ${config.iconColor}`} />\n                            <div className=\"flex space-x-2\">\n                              <Link href={`/documents?highlight=${alert.crewMember.id}`}>\n                                <Button \n                                  variant=\"outline\" \n                                  size=\"sm\"\n                                  className=\"hover:bg-primary hover:text-primary-foreground\"\n                                  data-testid={`renew-document-${alert.document.id}`}\n                                >\n                                  <Edit className=\"h-4 w-4 mr-1\" />\n                                  Renew\n                                </Button>\n                              </Link>\n                              <Button \n                                variant=\"outline\" \n                                size=\"sm\"\n                                onClick={() => handleContactCrew(alert)}\n                                data-testid={`contact-crew-${alert.document.id}`}\n                              >\n                                <Mail className=\"h-4 w-4 mr-1\" />\n                                Contact\n                              </Button>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        {/* Contract Expiry Alerts Tab */}\n        <TabsContent value=\"contracts\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"text-maritime-navy dark:text-white\">Contract Expiry Alerts</CardTitle>\n                \n                <div className=\"flex items-center space-x-4\">\n                  <Select value={contractSeverityFilter} onValueChange={setContractSeverityFilter}>\n                    <SelectTrigger className=\"w-32\" data-testid=\"contract-severity-filter\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Severity</SelectItem>\n                      <SelectItem value=\"expired\">Expired</SelectItem>\n                      <SelectItem value=\"critical\">Critical</SelectItem>\n                      <SelectItem value=\"warning\">Warning</SelectItem>\n                      <SelectItem value=\"info\">Info</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {filteredContractAlerts.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <Briefcase className=\"h-16 w-16 mx-auto text-gray-300 dark:text-gray-600 mb-4\" />\n                  <h3 className=\"text-lg font-semibold text-gray-500 dark:text-gray-400 mb-2\">No Contract Alerts</h3>\n                  <p className=\"text-gray-400 dark:text-gray-500\">All contracts are up to date</p>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {filteredContractAlerts.map((alert) => {\n                    const config = getSeverityConfig(alert.severity);\n                    const Icon = config.icon;\n                    \n                    return (\n                      <div\n                        key={alert.contract.id}\n                        className={`p-4 border-l-4 rounded-r ${config.color}`}\n                        data-testid={`contract-alert-item-${alert.contract.id}`}\n                      >\n                        <div className=\"flex items-start justify-between\">\n                          <div className=\"flex items-start space-x-4\">\n                            <Avatar className=\"bg-maritime-navy mt-1\">\n                              <AvatarFallback className=\"text-white font-medium\">\n                                {getInitials(alert.crewMember.firstName, alert.crewMember.lastName)}\n                              </AvatarFallback>\n                            </Avatar>\n                            \n                            <div className=\"flex-1\">\n                              <div className=\"flex items-center space-x-3 mb-2\">\n                                <h4 className={`font-semibold ${config.textColor}`} data-testid=\"contract-alert-crew-name\">\n                                  {alert.crewMember.firstName} {alert.crewMember.lastName}\n                                </h4>\n                                <Badge className={config.badge} data-testid=\"contract-alert-severity\">\n                                  {alert.severity.toUpperCase()}\n                                </Badge>\n                              </div>\n                              \n                              <div className=\"space-y-1\">\n                                <p className=\"text-gray-900 dark:text-gray-100 font-medium\" data-testid=\"contract-alert-info\">\n                                  {alert.crewMember.rank} on {alert.vessel.name}\n                                </p>\n                                <p className=\"text-sm text-gray-600 dark:text-gray-300\" data-testid=\"contract-alert-expiry-info\">\n                                  {alert.severity === 'expired' ? 'Expired' : 'Expires'}: {formatDate(alert.contract.endDate)} \n                                  ({alert.daysUntilExpiry <= 0 ? `${Math.abs(alert.daysUntilExpiry)} days ago` : `${alert.daysUntilExpiry} days remaining`})\n                                </p>\n                                <p className=\"text-sm text-gray-500 dark:text-gray-400\">\n                                  Contract started: {formatDate(alert.contract.startDate)}\n                                </p>\n                              </div>\n                            </div>\n                          </div>\n                          \n                          <div className=\"flex items-center space-x-2\">\n                            <Icon className={`h-5 w-5 ${config.iconColor}`} />\n                            <div className=\"flex space-x-2\">\n                              <Link href={`/crew?highlight=${alert.crewMember.id}`}>\n                                <Button \n                                  variant=\"outline\" \n                                  size=\"sm\"\n                                  className=\"hover:bg-primary hover:text-primary-foreground\"\n                                  data-testid={`view-crew-${alert.contract.id}`}\n                                >\n                                  <Users className=\"h-4 w-4 mr-1\" />\n                                  View Crew\n                                </Button>\n                              </Link>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      {/* Email Notification Status */}\n      {emailSettings && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-maritime-navy dark:text-white flex items-center\">\n              <Mail className=\"h-5 w-5 mr-2\" />\n              Notification Settings\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-sm font-medium text-gray-900 dark:text-gray-100\">Email Notifications</span>\n                <Badge className={emailSettings.enabled ? 'bg-compliance-green text-white' : 'bg-gray-500 text-white'}>\n                  {emailSettings.enabled ? 'Enabled' : 'Disabled'}\n                </Badge>\n              </div>\n              \n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-sm font-medium text-gray-900 dark:text-gray-100\">Reminder Schedule</span>\n                <span className=\"text-sm text-gray-600 dark:text-gray-300\">\n                  {emailSettings.reminderDays?.join(', ')} days before expiry\n                </span>\n              </div>\n              \n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-sm font-medium text-gray-900 dark:text-gray-100\">Recipients</span>\n                <span className=\"text-sm text-gray-600 dark:text-gray-300\">\n                  {emailSettings.recipients?.join(', ')}\n                </span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Contact Crew Modal */}\n      <Dialog open={isContactModalOpen} onOpenChange={setIsContactModalOpen}>\n        <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center space-x-2\">\n              <Mail className=\"h-5 w-5 text-primary\" />\n              <span>Contact Crew Member</span>\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedAlert && (\n            <div className=\"space-y-4\">\n              <div className=\"p-3 bg-gray-50 rounded\">\n                <div className=\"flex items-center space-x-3\">\n                  <Avatar className=\"bg-maritime-navy\">\n                    <AvatarFallback className=\"text-white font-medium\">\n                      {getInitials(selectedAlert.crewMember.firstName, selectedAlert.crewMember.lastName)}\n                    </AvatarFallback>\n                  </Avatar>\n                  <div>\n                    <p className=\"font-medium\">{selectedAlert.crewMember.firstName} {selectedAlert.crewMember.lastName}</p>\n                    <p className=\"text-sm text-gray-600\">{selectedAlert.crewMember.phoneNumber || 'No contact info'}</p>\n                  </div>\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email-subject\">Subject</Label>\n                <Input\n                  id=\"email-subject\"\n                  value={emailSubject}\n                  onChange={(e) => setEmailSubject(e.target.value)}\n                  placeholder=\"Email subject\"\n                  data-testid=\"contact-subject-input\"\n                />\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email-message\">Message</Label>\n                <Textarea\n                  id=\"email-message\"\n                  value={emailMessage}\n                  onChange={(e) => setEmailMessage(e.target.value)}\n                  placeholder=\"Your message to the crew member...\"\n                  rows={6}\n                  data-testid=\"contact-message-input\"\n                />\n              </div>\n              \n              <div className=\"flex justify-end space-x-2\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => setIsContactModalOpen(false)}\n                >\n                  Cancel\n                </Button>\n                <Button \n                  onClick={handleSendMessage}\n                  disabled={contactCrewMutation.isPending || !emailSubject || !emailMessage}\n                  data-testid=\"send-contact-message-button\"\n                >\n                  <Send className=\"h-4 w-4 mr-2\" />\n                  {contactCrewMutation.isPending ? 'Sending...' : 'Send Message'}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":31726,"size_tokens":null},"client/src/components/crew/edit-crew-form.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useMutation, useQueryClient, useQuery } from '@tanstack/react-query';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from '@/components/ui/form';\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\nimport { Textarea } from '@/components/ui/textarea';\nimport { useToast } from '@/hooks/use-toast';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { CrewMemberWithDetails, Vessel } from '@shared/schema';\n\nconst editCrewSchema = z.object({\n  firstName: z.string().min(1, 'First name is required'),\n  lastName: z.string().min(1, 'Last name is required'),\n  nationality: z.string().min(1, 'Nationality is required'),\n  dateOfBirth: z.string().min(1, 'Date of birth is required'),\n  rank: z.string().min(1, 'Rank is required'),\n  phoneNumber: z.string().optional(),\n  email: z.string().email('Invalid email format').optional().or(z.literal('')),\n  postalAddress: z.string().optional(),\n  status: z.enum(['onBoard', 'onShore']),\n  currentVesselId: z.string().optional().nullable(),\n  emergencyContactName: z.string().optional(),\n  emergencyContactRelationship: z.string().optional(),\n  emergencyContactPhone: z.string().optional(),\n  emergencyContactEmail: z.string().optional(),\n  emergencyContactPostalAddress: z.string().optional(),\n  contractStartDate: z.string().optional(),\n  contractDurationDays: z.number().optional(),\n  contractEndDate: z.string().optional(),\n  passportNumber: z.string().optional(),\n  passportPlaceOfIssue: z.string().optional(),\n  passportIssueDate: z.string().optional(),\n  passportExpiryDate: z.string().optional(),\n  cdcNumber: z.string().optional(),\n  cdcPlaceOfIssue: z.string().optional(),\n  cdcIssueDate: z.string().optional(),\n  cdcExpiryDate: z.string().optional(),\n  cocGradeNo: z.string().optional(),\n  cocPlaceOfIssue: z.string().optional(),\n  cocIssueDate: z.string().optional(),\n  cocExpiryDate: z.string().optional(),\n  medicalIssuingAuthority: z.string().optional(),\n  medicalApprovalNo: z.string().optional(),\n  medicalIssueDate: z.string().optional(),\n  medicalExpiryDate: z.string().optional(),\n});\n\ntype EditCrewFormData = z.infer<typeof editCrewSchema>;\n\ninterface EditCrewFormProps {\n  crewMember: CrewMemberWithDetails;\n  onSuccess: () => void;\n}\n\nexport default function EditCrewForm({ crewMember, onSuccess }: EditCrewFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [statusChangeReason, setStatusChangeReason] = useState('');\n  const originalStatus = crewMember.status;\n\n  const { data: vessels = [] } = useQuery<Vessel[]>({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  const passport = crewMember.documents?.find(d => d.type === 'passport');\n  const cdc = crewMember.documents?.find(d => d.type === 'cdc');\n  const coc = crewMember.documents?.find(d => d.type === 'stcw');\n  const medical = crewMember.documents?.find(d => d.type === 'medical');\n\n  const form = useForm<EditCrewFormData>({\n    resolver: zodResolver(editCrewSchema),\n    defaultValues: {\n      firstName: crewMember.firstName,\n      lastName: crewMember.lastName,\n      nationality: crewMember.nationality,\n      dateOfBirth: new Date(crewMember.dateOfBirth).toISOString().split('T')[0],\n      rank: crewMember.rank,\n      phoneNumber: crewMember.phoneNumber || '',\n      email: (crewMember as any).email || '',\n      postalAddress: (crewMember as any).postalAddress || '',\n      status: crewMember.status as 'onBoard' | 'onShore',\n      currentVesselId: crewMember.currentVesselId || undefined,\n      emergencyContactName: (crewMember.emergencyContact as any)?.name || '',\n      emergencyContactRelationship: (crewMember.emergencyContact as any)?.relationship || '',\n      emergencyContactPhone: (crewMember.emergencyContact as any)?.phone || '',\n      emergencyContactEmail: (crewMember.emergencyContact as any)?.email || '',\n      emergencyContactPostalAddress: (crewMember.emergencyContact as any)?.postalAddress || '',\n      contractStartDate: crewMember.activeContract?.startDate \n        ? new Date(crewMember.activeContract.startDate).toISOString().split('T')[0] \n        : '',\n      contractDurationDays: crewMember.activeContract?.startDate && crewMember.activeContract?.endDate\n        ? Math.ceil((new Date(crewMember.activeContract.endDate).getTime() - new Date(crewMember.activeContract.startDate).getTime()) / (1000 * 60 * 60 * 24))\n        : 90,\n      contractEndDate: crewMember.activeContract?.endDate \n        ? new Date(crewMember.activeContract.endDate).toISOString().split('T')[0] \n        : '',\n      passportNumber: passport?.documentNumber || '',\n      passportPlaceOfIssue: passport?.issuingAuthority || '',\n      passportIssueDate: passport?.issueDate ? new Date(passport.issueDate).toISOString().split('T')[0] : '',\n      passportExpiryDate: passport?.expiryDate ? new Date(passport.expiryDate).toISOString().split('T')[0] : '',\n      cdcNumber: cdc?.documentNumber || '',\n      cdcPlaceOfIssue: cdc?.issuingAuthority || '',\n      cdcIssueDate: cdc?.issueDate ? new Date(cdc.issueDate).toISOString().split('T')[0] : '',\n      cdcExpiryDate: cdc?.expiryDate ? new Date(cdc.expiryDate).toISOString().split('T')[0] : '',\n      cocGradeNo: coc?.documentNumber || '',\n      cocPlaceOfIssue: coc?.issuingAuthority || '',\n      cocIssueDate: coc?.issueDate ? new Date(coc.issueDate).toISOString().split('T')[0] : '',\n      cocExpiryDate: coc?.expiryDate ? new Date(coc.expiryDate).toISOString().split('T')[0] : '',\n      medicalIssuingAuthority: medical?.issuingAuthority || '',\n      medicalApprovalNo: medical?.documentNumber || '',\n      medicalIssueDate: medical?.issueDate ? new Date(medical.issueDate).toISOString().split('T')[0] : '',\n      medicalExpiryDate: medical?.expiryDate ? new Date(medical.expiryDate).toISOString().split('T')[0] : '',\n    },\n  });\n\n  // Reset form when crewMember changes to populate fields with new data\n  useEffect(() => {\n    const passport = crewMember.documents?.find(d => d.type === 'passport');\n    const cdc = crewMember.documents?.find(d => d.type === 'cdc');\n    const coc = crewMember.documents?.find(d => d.type === 'stcw');\n    const medical = crewMember.documents?.find(d => d.type === 'medical');\n    \n    form.reset({\n      firstName: crewMember.firstName,\n      lastName: crewMember.lastName,\n      nationality: crewMember.nationality,\n      dateOfBirth: new Date(crewMember.dateOfBirth).toISOString().split('T')[0],\n      rank: crewMember.rank,\n      phoneNumber: crewMember.phoneNumber || '',\n      email: (crewMember as any).email || '',\n      postalAddress: (crewMember as any).postalAddress || '',\n      status: crewMember.status as 'onBoard' | 'onShore',\n      currentVesselId: crewMember.currentVesselId || undefined,\n      emergencyContactName: (crewMember.emergencyContact as any)?.name || '',\n      emergencyContactRelationship: (crewMember.emergencyContact as any)?.relationship || '',\n      emergencyContactPhone: (crewMember.emergencyContact as any)?.phone || '',\n      emergencyContactEmail: (crewMember.emergencyContact as any)?.email || '',\n      emergencyContactPostalAddress: (crewMember.emergencyContact as any)?.postalAddress || '',\n      contractStartDate: crewMember.activeContract?.startDate \n        ? new Date(crewMember.activeContract.startDate).toISOString().split('T')[0] \n        : '',\n      contractDurationDays: crewMember.activeContract?.startDate && crewMember.activeContract?.endDate\n        ? Math.ceil((new Date(crewMember.activeContract.endDate).getTime() - new Date(crewMember.activeContract.startDate).getTime()) / (1000 * 60 * 60 * 24))\n        : 90,\n      contractEndDate: crewMember.activeContract?.endDate \n        ? new Date(crewMember.activeContract.endDate).toISOString().split('T')[0] \n        : '',\n      passportNumber: passport?.documentNumber || '',\n      passportPlaceOfIssue: passport?.issuingAuthority || '',\n      passportIssueDate: passport?.issueDate ? new Date(passport.issueDate).toISOString().split('T')[0] : '',\n      passportExpiryDate: passport?.expiryDate ? new Date(passport.expiryDate).toISOString().split('T')[0] : '',\n      cdcNumber: cdc?.documentNumber || '',\n      cdcPlaceOfIssue: cdc?.issuingAuthority || '',\n      cdcIssueDate: cdc?.issueDate ? new Date(cdc.issueDate).toISOString().split('T')[0] : '',\n      cdcExpiryDate: cdc?.expiryDate ? new Date(cdc.expiryDate).toISOString().split('T')[0] : '',\n      cocGradeNo: coc?.documentNumber || '',\n      cocPlaceOfIssue: coc?.issuingAuthority || '',\n      cocIssueDate: coc?.issueDate ? new Date(coc.issueDate).toISOString().split('T')[0] : '',\n      cocExpiryDate: coc?.expiryDate ? new Date(coc.expiryDate).toISOString().split('T')[0] : '',\n      medicalIssuingAuthority: medical?.issuingAuthority || '',\n      medicalApprovalNo: medical?.documentNumber || '',\n      medicalIssueDate: medical?.issueDate ? new Date(medical.issueDate).toISOString().split('T')[0] : '',\n      medicalExpiryDate: medical?.expiryDate ? new Date(medical.expiryDate).toISOString().split('T')[0] : '',\n    });\n  }, [crewMember, form]);\n\n  const updateCrewMutation = useMutation({\n    mutationFn: async (data: EditCrewFormData & { statusChangeReason?: string }) => {\n      console.log('Updating crew member:', crewMember.id, 'with data:', data);\n      \n      const updateData: any = {\n        firstName: data.firstName,\n        lastName: data.lastName,\n        nationality: data.nationality,\n        dateOfBirth: data.dateOfBirth, // Send as string, server will handle conversion\n        rank: data.rank,\n        phoneNumber: data.phoneNumber || null,\n        email: data.email || null,\n        status: data.status,\n        currentVesselId: data.currentVesselId === \"none\" ? null : data.currentVesselId || null,\n        emergencyContact: data.emergencyContactName ? {\n          name: data.emergencyContactName,\n          relationship: data.emergencyContactRelationship || '',\n          phone: data.emergencyContactPhone || '',\n          email: data.emergencyContactEmail || '',\n          postalAddress: data.emergencyContactPostalAddress || '',\n        } : null,\n        postalAddress: data.postalAddress || null,\n      };\n      \n      // Include status change reason if status changed\n      if (data.statusChangeReason) {\n        updateData.statusChangeReason = data.statusChangeReason;\n      }\n\n      // Handle contract update separately if contract dates are provided\n      if (data.contractStartDate && data.contractEndDate && crewMember.activeContract) {\n        const contractUpdateData = {\n          startDate: new Date(data.contractStartDate + 'T00:00:00.000Z'),\n          endDate: new Date(data.contractEndDate + 'T00:00:00.000Z'),\n        };\n\n        console.log('Updating contract:', crewMember.activeContract.id, 'with data:', contractUpdateData);\n        \n        const contractResponse = await fetch(`/api/contracts/${crewMember.activeContract.id}`, {\n          method: 'PUT',\n          headers: {\n            ...getAuthHeaders(),\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify(contractUpdateData),\n        });\n\n        if (!contractResponse.ok) {\n          const errorText = await contractResponse.text();\n          console.error('Failed to update contract:', contractResponse.status, errorText);\n          throw new Error(`Failed to update contract: ${contractResponse.status} - ${errorText}`);\n        } else {\n          const updatedContract = await contractResponse.json();\n          console.log('Contract updated successfully:', updatedContract);\n        }\n      }\n\n      // Helper function to update or create a document\n      const updateOrCreateDocument = async (\n        type: string, \n        documentNumber: string | undefined, \n        issuingAuthority: string | undefined, \n        issueDate: string | undefined, \n        expiryDate: string | undefined,\n        existingDoc: any\n      ) => {\n        const hasData = documentNumber || issueDate || expiryDate;\n        \n        // If no data and no existing doc, nothing to do\n        if (!hasData && !existingDoc) return;\n\n        if (existingDoc) {\n          // Update existing document with form values directly (allows clearing)\n          const docData = {\n            crewMemberId: crewMember.id,\n            type,\n            documentNumber: documentNumber || '',\n            issuingAuthority: issuingAuthority || '',\n            issueDate: issueDate ? new Date(issueDate + 'T00:00:00.000Z') : null,\n            expiryDate: expiryDate ? new Date(expiryDate + 'T00:00:00.000Z') : null,\n          };\n          \n          const response = await fetch(`/api/documents/${existingDoc.id}`, {\n            method: 'PUT',\n            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },\n            body: JSON.stringify(docData),\n          });\n          if (!response.ok) console.error(`Failed to update ${type} document`);\n        } else if (documentNumber && issueDate && expiryDate) {\n          // Only create new document if all required fields are provided\n          const docData = {\n            crewMemberId: crewMember.id,\n            type,\n            documentNumber: documentNumber,\n            issuingAuthority: issuingAuthority || '',\n            issueDate: new Date(issueDate + 'T00:00:00.000Z'),\n            expiryDate: new Date(expiryDate + 'T00:00:00.000Z'),\n          };\n          \n          const response = await fetch('/api/documents', {\n            method: 'POST',\n            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },\n            body: JSON.stringify(docData),\n          });\n          if (!response.ok) console.error(`Failed to create ${type} document`);\n        }\n      };\n\n      // Update documents\n      await updateOrCreateDocument('passport', data.passportNumber, data.passportPlaceOfIssue, data.passportIssueDate, data.passportExpiryDate, passport);\n      await updateOrCreateDocument('cdc', data.cdcNumber, data.cdcPlaceOfIssue, data.cdcIssueDate, data.cdcExpiryDate, cdc);\n      await updateOrCreateDocument('stcw', data.cocGradeNo, data.cocPlaceOfIssue, data.cocIssueDate, data.cocExpiryDate, coc);\n      await updateOrCreateDocument('medical', data.medicalApprovalNo, data.medicalIssuingAuthority, data.medicalIssueDate, data.medicalExpiryDate, medical);\n\n      console.log('Sending update data:', updateData);\n\n      const response = await fetch(`/api/crew/${crewMember.id}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(updateData),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error('Update failed:', response.status, errorText);\n        console.error('Update data that failed:', updateData);\n        throw new Error(`Failed to update crew member: ${response.status} - ${errorText}`);\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      // Force immediate cache refresh for all related queries\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/contracts'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/upcoming-events'] });\n      // Force refetch to happen immediately\n      queryClient.refetchQueries({ queryKey: ['/api/crew'] });\n      queryClient.refetchQueries({ queryKey: ['/api/contracts'] });\n      queryClient.refetchQueries({ queryKey: ['/api/documents'] });\n      toast({\n        title: 'Success',\n        description: 'Crew member updated successfully',\n      });\n      onSuccess();\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to update crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const onSubmit = (data: EditCrewFormData) => {\n    console.log('Form data:', data);\n    const isStatusChanged = data.status !== originalStatus;\n    \n    // Validate status change reason if status changed\n    if (isStatusChanged && !statusChangeReason.trim()) {\n      toast({\n        title: 'Reason Required',\n        description: 'Please provide a reason for changing the crew status.',\n        variant: 'destructive',\n      });\n      return;\n    }\n    \n    updateCrewMutation.mutate({\n      ...data,\n      statusChangeReason: isStatusChanged ? statusChangeReason : undefined,\n    });\n  };\n\n  return (\n    <Form {...form}>\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4 max-h-[70vh] overflow-y-auto\">\n        {/* Personal Information */}\n        <div className=\"space-y-3 p-4 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-blue-900 dark:text-blue-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-blue-600 rounded-full mr-3\"></div>\n            Personal Information\n          </h3>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <FormField\n            control={form.control}\n            name=\"firstName\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>First Name</FormLabel>\n                <FormControl>\n                  <Input {...field} data-testid=\"edit-firstName\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"lastName\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Last Name</FormLabel>\n                <FormControl>\n                  <Input {...field} data-testid=\"edit-lastName\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n          </div>\n        </div>\n\n        {/* Professional Information */}\n        <div className=\"space-y-3 p-4 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-green-900 dark:text-green-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-green-600 rounded-full mr-3\"></div>\n            Professional Information\n          </h3>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <FormField\n            control={form.control}\n            name=\"nationality\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Nationality</FormLabel>\n                <FormControl>\n                  <Input {...field} data-testid=\"edit-nationality\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"dateOfBirth\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Date of Birth</FormLabel>\n                <FormControl>\n                  <Input type=\"date\" {...field} data-testid=\"edit-dateOfBirth\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <FormField\n            control={form.control}\n            name=\"rank\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Rank</FormLabel>\n                <FormControl>\n                  <>\n                    <Input \n                      {...field} \n                      list=\"rank-options\"\n                      placeholder=\"Enter or select rank\"\n                      data-testid=\"edit-rank\" \n                    />\n                    <datalist id=\"rank-options\">\n                      <option value=\"Captain\" />\n                      <option value=\"Master (NCV)\" />\n                      <option value=\"Chief Officer\" />\n                      <option value=\"Chief Officer (NCV)\" />\n                      <option value=\"Second Officer\" />\n                      <option value=\"Third Officer\" />\n                      <option value=\"IV Master\" />\n                      <option value=\"Second Master (IV)\" />\n                      <option value=\"Chief Engineer\" />\n                      <option value=\"Chief Engineer (NCV)\" />\n                      <option value=\"Second Engineer\" />\n                      <option value=\"Third Engineer\" />\n                      <option value=\"Fourth Engineer\" />\n                      <option value=\"Bosun\" />\n                      <option value=\"Able Seaman\" />\n                      <option value=\"Deck Watchkeeping Rating (AB)\" />\n                      <option value=\"Ordinary Seaman\" />\n                      <option value=\"Engine Rating\" />\n                      <option value=\"Cook\" />\n                      <option value=\"2nd Cook\" />\n                      <option value=\"Steward\" />\n                      <option value=\"Saloon Rating\" />\n                      <option value=\"Fitter\" />\n                      <option value=\"Handler\" />\n                      <option value=\"Tube Operator\" />\n                      <option value=\"Lathe Operator\" />\n                      <option value=\"Radio Officer\" />\n                      <option value=\"ETO\" />\n                      <option value=\"ASST ETO\" />\n                      <option value=\"GMDSS OPERATOR\" />\n                    </datalist>\n                  </>\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"phoneNumber\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Phone Number</FormLabel>\n                <FormControl>\n                  <Input {...field} data-testid=\"edit-phoneNumber\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"email\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Email</FormLabel>\n                <FormControl>\n                  <Input type=\"email\" placeholder=\"Enter email address\" {...field} value={field.value || ''} data-testid=\"edit-email\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        <FormField\n          control={form.control}\n          name=\"status\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Status</FormLabel>\n              <FormControl>\n                <RadioGroup\n                  value={field.value}\n                  onValueChange={field.onChange}\n                  className=\"flex space-x-6\"\n                  data-testid=\"edit-status\"\n                >\n                  <div className=\"flex items-center space-x-2\">\n                    <RadioGroupItem value=\"onBoard\" id=\"edit-onBoard\" />\n                    <Label htmlFor=\"edit-onBoard\">On Board</Label>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <RadioGroupItem value=\"onShore\" id=\"edit-onShore\" />\n                    <Label htmlFor=\"edit-onShore\">On Shore</Label>\n                  </div>\n                </RadioGroup>\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        {/* Status Change Reason - shows when status is being changed */}\n        {form.watch('status') !== originalStatus && (\n          <div className=\"p-3 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg\">\n            <Label className=\"text-amber-900 dark:text-amber-100 font-medium\">\n              Reason for Status Change <span className=\"text-red-500\">*</span>\n            </Label>\n            <p className=\"text-xs text-amber-700 dark:text-amber-300 mb-2\">\n              Changing status from {originalStatus === 'onBoard' ? 'On Board' : 'On Shore'} to {form.watch('status') === 'onBoard' ? 'On Board' : 'On Shore'}\n            </p>\n            <Textarea\n              placeholder=\"Please provide a reason for this status change...\"\n              value={statusChangeReason}\n              onChange={(e) => setStatusChangeReason(e.target.value)}\n              className=\"mt-2\"\n              data-testid=\"edit-status-change-reason\"\n            />\n          </div>\n        )}\n\n        <FormField\n          control={form.control}\n          name=\"currentVesselId\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Current Vessel</FormLabel>\n              <FormControl>\n                <Select value={field.value || undefined} onValueChange={(value) => field.onChange(value === \"none\" ? null : value)}>\n                  <SelectTrigger data-testid=\"edit-currentVesselId\">\n                    <SelectValue placeholder=\"Select vessel\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"none\">No vessel assigned</SelectItem>\n                    {vessels.map((vessel) => (\n                      <SelectItem key={vessel.id} value={vessel.id}>\n                        {vessel.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n        </div>\n\n        {/* Next of Kin (NOK) Section */}\n        <div className=\"space-y-3 p-4 bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-orange-900 dark:text-orange-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-orange-600 rounded-full mr-3\"></div>\n            Next of Kin (NOK)\n          </h3>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"emergencyContactName\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Name</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-emergencyContactName\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"emergencyContactRelationship\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Relationship</FormLabel>\n                  <FormControl>\n                    <>\n                      <Input \n                        {...field} \n                        list=\"relationship-options\"\n                        placeholder=\"Enter or select relationship\"\n                        data-testid=\"edit-emergencyContactRelationship\" \n                      />\n                      <datalist id=\"relationship-options\">\n                        <option value=\"Spouse\" />\n                        <option value=\"Wife\" />\n                        <option value=\"Husband\" />\n                        <option value=\"Parent\" />\n                        <option value=\"Father\" />\n                        <option value=\"Mother\" />\n                        <option value=\"Child\" />\n                        <option value=\"Son\" />\n                        <option value=\"Daughter\" />\n                        <option value=\"Sibling\" />\n                        <option value=\"Brother\" />\n                        <option value=\"Sister\" />\n                        <option value=\"Friend\" />\n                        <option value=\"Other\" />\n                      </datalist>\n                    </>\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"emergencyContactPhone\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Phone</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-emergencyContactPhone\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"emergencyContactEmail\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Email</FormLabel>\n                  <FormControl>\n                    <Input type=\"email\" {...field} data-testid=\"edit-emergencyContactEmail\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n\n          <FormField\n            control={form.control}\n            name=\"emergencyContactPostalAddress\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Postal Address</FormLabel>\n                <FormControl>\n                  <Input {...field} data-testid=\"edit-emergencyContactPostalAddress\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        {/* Passport Details Section */}\n        <div className=\"space-y-3 p-4 bg-indigo-50 dark:bg-indigo-950/20 border border-indigo-200 dark:border-indigo-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-indigo-900 dark:text-indigo-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-indigo-600 rounded-full mr-3\"></div>\n            Passport Details\n          </h3>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"passportNumber\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Passport Number</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-passportNumber\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"passportPlaceOfIssue\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Place of Issue</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-passportPlaceOfIssue\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"passportIssueDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Issue Date</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} data-testid=\"edit-passportIssueDate\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"passportExpiryDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Expiry Date</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} data-testid=\"edit-passportExpiryDate\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n        </div>\n\n        {/* CDC Details Section */}\n        <div className=\"space-y-3 p-4 bg-teal-50 dark:bg-teal-950/20 border border-teal-200 dark:border-teal-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-teal-900 dark:text-teal-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-teal-600 rounded-full mr-3\"></div>\n            CDC Details\n          </h3>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"cdcNumber\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>CDC Number</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-cdcNumber\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"cdcPlaceOfIssue\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Place of Issue</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-cdcPlaceOfIssue\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"cdcIssueDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Issue Date</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} data-testid=\"edit-cdcIssueDate\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"cdcExpiryDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Expiry Date</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} data-testid=\"edit-cdcExpiryDate\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n        </div>\n\n        {/* COC Details Section */}\n        <div className=\"space-y-3 p-4 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-amber-900 dark:text-amber-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-amber-600 rounded-full mr-3\"></div>\n            COC Details\n          </h3>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"cocGradeNo\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>COC Grade/Number</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-cocGradeNo\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"cocPlaceOfIssue\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Place of Issue</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-cocPlaceOfIssue\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"cocIssueDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Issue Date</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} data-testid=\"edit-cocIssueDate\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"cocExpiryDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Expiry Date</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} data-testid=\"edit-cocExpiryDate\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n        </div>\n\n        {/* Medical Certificate Details Section */}\n        <div className=\"space-y-3 p-4 bg-rose-50 dark:bg-rose-950/20 border border-rose-200 dark:border-rose-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-rose-900 dark:text-rose-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-rose-600 rounded-full mr-3\"></div>\n            Medical Certificate Details\n          </h3>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"medicalIssuingAuthority\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Issuing Authority</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-medicalIssuingAuthority\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"medicalApprovalNo\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Approval Number</FormLabel>\n                  <FormControl>\n                    <Input {...field} data-testid=\"edit-medicalApprovalNo\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"medicalIssueDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Issue Date</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} data-testid=\"edit-medicalIssueDate\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"medicalExpiryDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Expiry Date</FormLabel>\n                  <FormControl>\n                    <Input type=\"date\" {...field} data-testid=\"edit-medicalExpiryDate\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n        </div>\n\n        {/* Contract Information */}\n        <div className=\"space-y-3 p-4 bg-purple-50 dark:bg-purple-950/20 border border-purple-200 dark:border-purple-800 rounded-lg\">\n          <h3 className=\"text-lg font-semibold text-purple-900 dark:text-purple-100 flex items-center\">\n            <div className=\"w-2 h-2 bg-purple-600 rounded-full mr-3\"></div>\n            Contract Information\n          </h3>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <FormField\n              control={form.control}\n              name=\"contractStartDate\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Contract Start Date</FormLabel>\n                  <FormControl>\n                    <Input \n                      type=\"date\" \n                      {...field} \n                      data-testid=\"edit-contractStartDate\"\n                      onChange={(e) => {\n                        field.onChange(e);\n                        // Calculate end date when start date changes\n                        const startDate = e.target.value;\n                        const duration = form.getValues('contractDurationDays');\n                        if (startDate && duration) {\n                          const start = new Date(startDate);\n                          const end = new Date(start);\n                          end.setDate(start.getDate() + duration);\n                          form.setValue('contractEndDate', end.toISOString().split('T')[0]);\n                        }\n                      }}\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"contractDurationDays\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Duration (Days)</FormLabel>\n                  <FormControl>\n                    <Input \n                      type=\"number\" \n                      min=\"1\"\n                      placeholder=\"e.g., 90\"\n                      {...field}\n                      value={field.value || 90}\n                      data-testid=\"edit-contractDurationDays\"\n                      onChange={(e) => {\n                        const duration = parseInt(e.target.value) || 0;\n                        field.onChange(duration);\n                        // Calculate end date when duration changes\n                        const startDate = form.getValues('contractStartDate');\n                        if (startDate && duration > 0) {\n                          const start = new Date(startDate);\n                          const end = new Date(start);\n                          end.setDate(start.getDate() + duration);\n                          form.setValue('contractEndDate', end.toISOString().split('T')[0]);\n                        }\n                      }}\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n          </div>\n          \n          <FormField\n            control={form.control}\n            name=\"contractEndDate\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Contract End Date (Auto-calculated)</FormLabel>\n                <FormControl>\n                  <Input \n                    type=\"date\" \n                    {...field} \n                    data-testid=\"edit-contractEndDate\"\n                    readOnly\n                    className=\"bg-gray-50 dark:bg-gray-800 cursor-not-allowed\"\n                  />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        <div className=\"flex justify-end gap-2 pt-4\">\n          <Button type=\"button\" variant=\"outline\" onClick={onSuccess}>\n            Cancel\n          </Button>\n          <Button \n            type=\"submit\" \n            disabled={updateCrewMutation.isPending}\n            className=\"bg-maritime-navy hover:bg-blue-800\"\n            data-testid=\"submit-edit-crew\"\n          >\n            {updateCrewMutation.isPending ? 'Updating...' : 'Update Crew Member'}\n          </Button>\n        </div>\n      </form>\n    </Form>\n  );\n}","path":null,"size_bytes":44021,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"server/seed.ts":{"content":"import { db } from './db';\nimport { users, vessels, crewMembers, contracts, documents, emailSettings, crewRotations } from '@shared/schema';\n\nasync function seedDatabase() {\n  // CRITICAL: Never run seeding in production\n  const environment = process.env.NODE_ENV || 'development';\n  \n  if (environment === 'production') {\n    console.error('‚ùå SEEDING BLOCKED: Cannot seed database in production environment');\n    console.error('   This prevents contaminating real data with demo data');\n    process.exit(1);\n  }\n  \n  if (environment !== 'development') {\n    console.warn('‚ö†Ô∏è  WARNING: Seeding database in non-development environment:', environment);\n    console.warn('   Are you sure this is correct?');\n  }\n  \n  console.log(`üå± Seeding database in ${environment} environment...`);\n\n  try {\n    // Create users with demo prefix for identification\n    const [adminUser] = await db.insert(users).values([\n      {\n        username: 'admin',\n        password: 'admin123',\n        role: 'admin',\n        email: 'admin@crewtrack.com',\n        name: '[DEMO] System Administrator',\n      }\n    ]).onConflictDoNothing().returning();\n\n    const [officeUser] = await db.insert(users).values([\n      {\n        username: 'office',\n        password: 'demo123',\n        role: 'office_staff',\n        email: 'office@crewtrack.com',\n        name: '[DEMO] Office Staff',\n      }\n    ]).onConflictDoNothing().returning();\n\n    // Create vessels with demo prefix for identification\n    const vesselData = [\n      { name: \"[DEMO] MV Ocean Explorer\", type: \"Container Ship\", imoNumber: \"IMO1234567\", flag: \"Panama\", status: \"active\" },\n      { name: \"[DEMO] MV Pacific Star\", type: \"Bulk Carrier\", imoNumber: \"IMO2345678\", flag: \"Marshall Islands\", status: \"active\" },\n      { name: \"[DEMO] MV Atlantic Wave\", type: \"Tanker\", imoNumber: \"IMO3456789\", flag: \"Liberia\", status: \"in-port\" },\n      { name: \"[DEMO] MV Nordic Breeze\", type: \"General Cargo\", imoNumber: \"IMO4567890\", flag: \"Norway\", status: \"maintenance\" },\n      { name: \"[DEMO] MV Mediterranean\", type: \"Container Ship\", imoNumber: \"IMO5678901\", flag: \"Malta\", status: \"active\" },\n      { name: \"[DEMO] MV Caribbean Dream\", type: \"Passenger\", imoNumber: \"IMO6789012\", flag: \"Bahamas\", status: \"inactive\" }\n    ];\n\n    const insertedVessels = await db.insert(vessels).values(vesselData).onConflictDoNothing().returning();\n\n    // Create crew members with demo prefix for identification\n    const crewData = [\n      {\n        firstName: \"[DEMO] James\",\n        lastName: \"Anderson\",\n        nationality: \"United Kingdom\",\n        dateOfBirth: new Date(\"1980-05-15\"),\n        rank: \"Captain\",\n        phoneNumber: \"+44-20-1234-5678\",\n        emergencyContact: {\n          name: \"Sarah Anderson\",\n          relationship: \"Spouse\",\n          phone: \"+44-20-8765-4321\",\n          email: \"sarah.anderson@email.com\"\n        },\n        currentVesselId: insertedVessels[0]?.id || null,\n        status: \"onBoard\"\n      },\n      {\n        firstName: \"[DEMO] Miguel\",\n        lastName: \"Santos\",\n        nationality: \"Philippines\",\n        dateOfBirth: new Date(\"1985-08-22\"),\n        rank: \"Chief Engineer\",\n        phoneNumber: \"+63-2-987-6543\",\n        emergencyContact: {\n          name: \"Maria Santos\",\n          relationship: \"Mother\",\n          phone: \"+63-2-123-4567\",\n          email: \"maria.santos@email.com\"\n        },\n        currentVesselId: insertedVessels[1]?.id || null,\n        status: \"onBoard\"\n      },\n      {\n        firstName: \"[DEMO] Anna\",\n        lastName: \"Petrov\",\n        nationality: \"Ukraine\",\n        dateOfBirth: new Date(\"1990-03-10\"),\n        rank: \"Second Officer\",\n        phoneNumber: \"+380-44-555-0123\",\n        emergencyContact: {\n          name: \"Viktor Petrov\",\n          relationship: \"Father\",\n          phone: \"+380-44-555-0456\",\n          email: \"viktor.petrov@email.com\"\n        },\n        currentVesselId: insertedVessels[0]?.id || null,\n        status: \"onBoard\"\n      },\n      {\n        firstName: \"[DEMO] Carlos\",\n        lastName: \"Rodriguez\",\n        nationality: \"Spain\",\n        dateOfBirth: new Date(\"1982-11-28\"),\n        rank: \"Bosun\",\n        phoneNumber: \"+34-91-123-4567\",\n        emergencyContact: {\n          name: \"Elena Rodriguez\",\n          relationship: \"Wife\",\n          phone: \"+34-91-765-4321\",\n          email: \"elena.rodriguez@email.com\"\n        },\n        currentVesselId: insertedVessels[2]?.id || null,\n        status: \"onBoard\"\n      },\n    ];\n\n    const insertedCrew = await db.insert(crewMembers).values(crewData).onConflictDoNothing().returning();\n\n    // Create active contracts for crew members with upcoming expirations\n    if (insertedCrew.length > 0 && insertedVessels.length > 0) {\n      const contractData = [\n        {\n          crewMemberId: insertedCrew[0].id,\n          vesselId: insertedCrew[0].currentVesselId || insertedVessels[0].id,\n          startDate: new Date(\"2024-01-01\"),\n          endDate: new Date(\"2025-08-18\"), // Expiring in 4 days\n          salary: 5000,\n          currency: \"USD\",\n          status: \"onBoard\" as const\n        },\n        {\n          crewMemberId: insertedCrew[1].id,\n          vesselId: insertedCrew[1].currentVesselId || insertedVessels[1].id,\n          startDate: new Date(\"2024-01-01\"),\n          endDate: new Date(\"2025-08-25\"), // Expiring in 11 days\n          salary: 5500,\n          currency: \"USD\",\n          status: \"onBoard\" as const\n        },\n        ...insertedCrew.slice(2).map((crew, index) => ({\n          crewMemberId: crew.id,\n          vesselId: crew.currentVesselId || insertedVessels[(index + 2) % insertedVessels.length].id,\n          startDate: new Date(\"2024-01-01\"),\n          endDate: new Date(\"2025-12-31\"), // Long-term contracts\n          salary: 5000 + (index * 500),\n          currency: \"USD\",\n          status: \"onBoard\" as const\n        }))\n      ];\n\n      await db.insert(contracts).values(contractData).onConflictDoNothing();\n    }\n\n    // Create sample documents with upcoming expirations\n    if (insertedCrew.length > 0) {\n      const documentData = [\n        {\n          crewMemberId: insertedCrew[0].id,\n          type: \"passport\",\n          documentNumber: \"UK123456789\",\n          issueDate: new Date(\"2020-01-15\"),\n          expiryDate: new Date(\"2025-08-20\"), // Expiring in 6 days\n          issuingAuthority: \"UK Passport Office\",\n          status: \"expiring\"\n        },\n        {\n          crewMemberId: insertedCrew[1].id,\n          type: \"medical\",\n          documentNumber: \"MED-2024-001\",\n          issueDate: new Date(\"2024-01-15\"),\n          expiryDate: new Date(\"2025-08-20\"), // Expiring in 6 days\n          issuingAuthority: \"Philippine Maritime Medical Center\",\n          status: \"expiring\"\n        },\n        {\n          crewMemberId: insertedCrew[2].id,\n          type: \"stcw\",\n          documentNumber: \"STCW-2024-002\",\n          issueDate: new Date(\"2022-01-15\"),\n          expiryDate: new Date(\"2025-08-16\"), // Expiring in 2 days - URGENT\n          issuingAuthority: \"Ukrainian Maritime Authority\",\n          status: \"expiring\"\n        },\n        {\n          crewMemberId: insertedCrew[3].id,\n          type: \"cdc\",\n          documentNumber: \"CDC-ESP-54321\",\n          issueDate: new Date(\"2022-03-10\"),\n          expiryDate: new Date(\"2025-09-05\"), // Expiring in 22 days\n          issuingAuthority: \"Spanish Maritime Authority\",\n          status: \"valid\"\n        },\n        {\n          crewMemberId: insertedCrew[4].id,\n          type: \"medical\",\n          documentNumber: \"MED-IND-2024\",\n          issueDate: new Date(\"2024-02-01\"),\n          expiryDate: new Date(\"2025-08-28\"), // Expiring in 14 days\n          issuingAuthority: \"Directorate General of Shipping, India\",\n          status: \"expiring\"\n        }\n      ];\n\n      await db.insert(documents).values(documentData).onConflictDoNothing();\n    }\n\n    // Create crew rotations with upcoming events\n    if (insertedCrew.length > 0 && insertedVessels.length > 0) {\n      const rotationData = [\n        {\n          crewMemberId: insertedCrew[0].id, // James Anderson\n          vesselId: insertedVessels[0].id,\n          joinDate: new Date(\"2024-01-01\"),\n          leaveDate: new Date(\"2025-08-17\"), // Leaving in 3 days - URGENT\n          rotationType: \"leave\",\n          status: \"scheduled\",\n          notes: \"End of contract - replacement needed urgently\"\n        },\n        {\n          crewMemberId: insertedCrew[2].id, // Anna Petrov\n          vesselId: insertedVessels[1].id,\n          joinDate: new Date(\"2025-08-21\"), // Joining in 7 days\n          leaveDate: new Date(\"2026-02-21\"),\n          rotationType: \"join\",\n          status: \"scheduled\",\n          notes: \"Anna joining as Second Officer\"\n        },\n        {\n          crewMemberId: insertedCrew[3].id, // Carlos Rodriguez\n          vesselId: insertedVessels[2].id,\n          joinDate: new Date(\"2024-01-01\"),\n          leaveDate: new Date(\"2025-09-10\"), // Leaving in 27 days\n          rotationType: \"leave\",\n          status: \"scheduled\",\n          notes: \"Scheduled rotation end\"\n        }\n      ];\n\n      await db.insert(crewRotations).values(rotationData).onConflictDoNothing();\n    }\n\n    // Create email settings\n    await db.insert(emailSettings).values([{\n      reminderDays: [30, 15, 7],\n      enabled: true,\n      recipients: ['office_staff', 'admin'],\n      emailTemplate: \"Dear [Crew Member],\\n\\nYour [Document Type] is scheduled to expire on [Expiry Date]. Please contact your Fleet Administrator to discuss renewal arrangements.\\n\\nBest regards,\\nCrewTrack Pro Team\"\n    }]).onConflictDoNothing();\n\n    console.log('‚úÖ Database seeded successfully!');\n    console.log(`- Created ${insertedVessels.length} vessels`);\n    console.log(`- Created ${insertedCrew.length} crew members`);\n    console.log(`- Created ${insertedCrew.length} active contracts`);\n    console.log('- Created sample documents and email settings');\n\n  } catch (error) {\n    console.error('‚ùå Error seeding database:', error);\n  }\n}\n\nexport { seedDatabase };\n\n// Run seed function if this file is executed directly\nseedDatabase();","path":null,"size_bytes":10060,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"deployment/server/ocrService.ts":{"content":"import OpenAI from \"openai\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\nexport interface ExtractedCrewData {\n  name?: string;\n  position?: string;\n  nationality?: string;\n  dateOfBirth?: string;\n  passportNumber?: string;\n  seamansBookNumber?: string;\n  cdcNumber?: string;\n  phoneNumber?: string;\n  email?: string;\n  emergencyContact?: string;\n  emergencyPhone?: string;\n  contractStartDate?: string;\n  contractEndDate?: string;\n  joinDate?: string;\n  leaveDate?: string;\n  vessel?: string;\n  salary?: string;\n}\n\nexport class OCRService {\n  async extractCrewDataFromDocument(base64Image: string): Promise<ExtractedCrewData> {\n    try {\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o\", // the newest OpenAI model is \"gpt-4o\" which was released May 13, 2024. do not change this unless explicitly requested by the user\n        messages: [\n          {\n            role: \"system\",\n            content: `You are an expert at extracting crew member information from maritime documents and contracts. \n            Analyze the document image and extract all relevant crew member information. \n            Focus on finding: name, position/rank, nationality, dates of birth, passport numbers, seaman's book numbers, CDC numbers, contact information, contract dates, vessel information, and salary details.\n            Return the data in JSON format with the exact field names specified. If a field is not found or unclear, omit it from the response.\n            Be very careful with dates - format them as YYYY-MM-DD if possible.`\n          },\n          {\n            role: \"user\",\n            content: [\n              {\n                type: \"text\",\n                text: \"Extract all crew member information from this maritime document. Return only valid JSON with the available data.\"\n              },\n              {\n                type: \"image_url\",\n                image_url: {\n                  url: `data:image/jpeg;base64,${base64Image}`\n                }\n              }\n            ],\n          },\n        ],\n        response_format: { type: \"json_object\" },\n        max_tokens: 1000,\n      });\n\n      const extractedData = JSON.parse(response.choices[0].message.content || \"{}\");\n      \n      // Clean and validate the extracted data\n      const cleanedData: ExtractedCrewData = {};\n      \n      if (extractedData.name) cleanedData.name = String(extractedData.name).trim();\n      if (extractedData.position) cleanedData.position = String(extractedData.position).trim();\n      if (extractedData.nationality) cleanedData.nationality = String(extractedData.nationality).trim();\n      if (extractedData.dateOfBirth) cleanedData.dateOfBirth = String(extractedData.dateOfBirth).trim();\n      if (extractedData.passportNumber) cleanedData.passportNumber = String(extractedData.passportNumber).trim();\n      if (extractedData.seamansBookNumber) cleanedData.seamansBookNumber = String(extractedData.seamansBookNumber).trim();\n      if (extractedData.cdcNumber) cleanedData.cdcNumber = String(extractedData.cdcNumber).trim();\n      if (extractedData.phoneNumber) cleanedData.phoneNumber = String(extractedData.phoneNumber).trim();\n      if (extractedData.email) cleanedData.email = String(extractedData.email).trim();\n      if (extractedData.emergencyContact) cleanedData.emergencyContact = String(extractedData.emergencyContact).trim();\n      if (extractedData.emergencyPhone) cleanedData.emergencyPhone = String(extractedData.emergencyPhone).trim();\n      if (extractedData.contractStartDate) cleanedData.contractStartDate = String(extractedData.contractStartDate).trim();\n      if (extractedData.contractEndDate) cleanedData.contractEndDate = String(extractedData.contractEndDate).trim();\n      if (extractedData.joinDate) cleanedData.joinDate = String(extractedData.joinDate).trim();\n      if (extractedData.leaveDate) cleanedData.leaveDate = String(extractedData.leaveDate).trim();\n      if (extractedData.vessel) cleanedData.vessel = String(extractedData.vessel).trim();\n      if (extractedData.salary) cleanedData.salary = String(extractedData.salary).trim();\n\n      return cleanedData;\n    } catch (error) {\n      console.error(\"OCR extraction error:\", error);\n      throw new Error(\"Failed to extract data from document. Please try again or enter the information manually.\");\n    }\n  }\n}\n\nexport const ocrService = new OCRService();","path":null,"size_bytes":4398,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/vessels/contract-status-modal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Badge } from '@/components/ui/badge';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { CheckCircle, Clock, AlertTriangle, Users, Ship } from 'lucide-react';\nimport { format } from 'date-fns';\nimport { formatDate } from '@/lib/utils';\n\ninterface CrewMember {\n  id: string;\n  firstName: string;\n  lastName: string;\n  rank: string;\n  status: string;\n  activeContract?: {\n    id: string;\n    startDate: string;\n    endDate: string;\n    status: string;\n  };\n  currentVessel?: {\n    name: string;\n  };\n}\n\ninterface ContractStatusModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  contractType: 'valid' | 'due' | 'expired';\n  crewMembers: CrewMember[];\n  vesselName: string;\n}\n\nexport default function ContractStatusModal({ \n  isOpen, \n  onClose, \n  contractType, \n  crewMembers, \n  vesselName \n}: ContractStatusModalProps) {\n  const getContractInfo = (type: 'valid' | 'due' | 'expired') => {\n    switch (type) {\n      case 'valid':\n        return {\n          title: 'Contract Valid',\n          description: 'Crew members with contracts valid for more than 45 days',\n          icon: CheckCircle,\n          color: 'text-green-600',\n          bgColor: 'bg-green-50 dark:bg-green-950/20',\n          borderColor: 'border-green-200 dark:border-green-800'\n        };\n      case 'due':\n        return {\n          title: 'Contract Due',\n          description: 'Crew members with contracts expiring within 45 days',\n          icon: Clock,\n          color: 'text-yellow-600',\n          bgColor: 'bg-yellow-50 dark:bg-yellow-950/20',\n          borderColor: 'border-yellow-200 dark:border-yellow-800'\n        };\n      case 'expired':\n        return {\n          title: 'Contracts Expired',\n          description: 'Crew members with expired contracts',\n          icon: AlertTriangle,\n          color: 'text-red-600',\n          bgColor: 'bg-red-50 dark:bg-red-950/20',\n          borderColor: 'border-red-200 dark:border-red-800'\n        };\n    }\n  };\n\n  const contractInfo = getContractInfo(contractType);\n  const Icon = contractInfo.icon;\n\n  const getInitials = (firstName: string, lastName: string) => {\n    return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();\n  };\n\n  const getContractDaysRemaining = (member: CrewMember) => {\n    if (!member.activeContract || member.activeContract.status !== 'active') return 0;\n    \n    const now = new Date();\n    const endDate = new Date(member.activeContract.endDate);\n    const daysDiff = Math.ceil((endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    \n    // Return days remaining (can be negative if expired, positive if future)\n    return daysDiff;\n  };\n\n  const getContractEndDate = (member: CrewMember) => {\n    if (!member.activeContract) return new Date();\n    return new Date(member.activeContract.endDate);\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center space-x-2\">\n            <Icon className={`h-5 w-5 ${contractInfo.color}`} />\n            <span>{contractInfo.title} - {vesselName}</span>\n          </DialogTitle>\n          <DialogDescription className=\"text-sm text-muted-foreground\">\n            {contractInfo.description}\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          {crewMembers.length === 0 ? (\n            <div className={`text-center py-8 ${contractInfo.bgColor} border ${contractInfo.borderColor} rounded-lg`}>\n              <Users className=\"h-12 w-12 mx-auto text-muted-foreground mb-3\" />\n              <h3 className=\"font-medium text-foreground mb-1\">No Crew Members</h3>\n              <p className=\"text-sm text-muted-foreground\">\n                No crew members found with {contractType} contracts for this vessel.\n              </p>\n            </div>\n          ) : (\n            <>\n              <div className=\"flex items-center justify-between mb-4\">\n                <div className=\"flex items-center space-x-2\">\n                  <Ship className=\"h-4 w-4 text-muted-foreground\" />\n                  <span className=\"font-medium\">{crewMembers.length} crew members</span>\n                </div>\n                <Badge variant=\"outline\" className={contractInfo.color}>\n                  {contractInfo.title}\n                </Badge>\n              </div>\n              \n              <div className=\"space-y-3\">\n                {crewMembers.map((member) => {\n                  const contractEndDate = getContractEndDate(member);\n                  const daysRemaining = getContractDaysRemaining(member);\n                  \n                  return (\n                    <div\n                      key={member.id}\n                      className={`p-4 border rounded-lg ${contractInfo.bgColor} ${contractInfo.borderColor}`}\n                      data-testid={`contract-crew-${member.id}`}\n                    >\n                      <div className=\"flex items-start justify-between\">\n                        <div className=\"flex items-start space-x-3\">\n                          <Avatar className=\"bg-maritime-navy\">\n                            <AvatarFallback className=\"text-white font-medium text-sm\">\n                              {getInitials(member.firstName, member.lastName)}\n                            </AvatarFallback>\n                          </Avatar>\n                          \n                          <div className=\"flex-1\">\n                            <h4 className=\"font-medium text-foreground\" data-testid=\"crew-name\">\n                              {member.firstName} {member.lastName}\n                            </h4>\n                            <p className=\"text-sm text-muted-foreground mb-2\">{member.rank}</p>\n                            \n                            <div className=\"space-y-1\">\n                              <div className=\"flex items-center space-x-2 text-sm\">\n                                <span className=\"text-muted-foreground\">Contract End:</span>\n                                <span className=\"font-medium text-foreground\" data-testid=\"contract-end-date\">\n                                  {member.activeContract ? formatDate(contractEndDate) : 'No Contract'}\n                                </span>\n                              </div>\n                              <div className=\"flex items-center space-x-2 text-sm\">\n                                <span className=\"text-muted-foreground\">Status:</span>\n                                <Badge \n                                  variant=\"outline\" \n                                  className={`text-xs ${\n                                    !member.activeContract \n                                      ? 'text-gray-600 border-gray-200'\n                                      : daysRemaining <= 0 \n                                        ? 'text-red-600 border-red-200' \n                                        : daysRemaining <= 45 \n                                          ? 'text-yellow-600 border-yellow-200' \n                                          : 'text-green-600 border-green-200'\n                                  }`}\n                                  data-testid=\"contract-status\"\n                                >\n                                  {!member.activeContract \n                                    ? 'No Active Contract'\n                                    : daysRemaining <= 0 \n                                      ? `Expired ${Math.abs(daysRemaining)} days ago`\n                                      : `${daysRemaining} days remaining`\n                                  }\n                                </Badge>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center\">\n                          <Icon className={`h-4 w-4 ${contractInfo.color}`} />\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            </>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":8342,"size_tokens":null},"client/src/components/vessel-documents/vessel-document-upload-modal.tsx":{"content":"import { useState } from 'react';\nimport { useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Upload, X, FileText, AlertCircle } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { getAuthHeaders } from '@/lib/auth';\n\ninterface VesselDocumentUploadModalProps {\n  vesselId: string;\n  vesselName: string;\n  open: boolean;\n  onClose: () => void;\n}\n\nconst DOCUMENT_TYPES = [\n  { value: 'certificate', label: 'Certificate' },\n  { value: 'insurance', label: 'Insurance' },\n  { value: 'inspection', label: 'Inspection' },\n  { value: 'safety', label: 'Safety' },\n  { value: 'customs', label: 'Customs' },\n  { value: 'other', label: 'Other' }\n];\n\nexport function VesselDocumentUploadModal({ vesselId, vesselName, open, onClose }: VesselDocumentUploadModalProps) {\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [documentName, setDocumentName] = useState('');\n  const [documentType, setDocumentType] = useState('');\n  const [description, setDescription] = useState('');\n  const [expiryDate, setExpiryDate] = useState('');\n  const [isPublic, setIsPublic] = useState(false);\n  const [isUploading, setIsUploading] = useState(false);\n\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const uploadMutation = useMutation({\n    mutationFn: async (formData: any) => {\n      setIsUploading(true);\n      \n      try {\n        // Step 1: Get upload URL\n        const uploadUrlResponse = await fetch(`/api/vessels/${vesselId}/documents/upload-url`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            ...getAuthHeaders(),\n          },\n          body: JSON.stringify({ fileName: selectedFile!.name }),\n        });\n\n        if (!uploadUrlResponse.ok) {\n          throw new Error('Failed to get upload URL');\n        }\n\n        const { uploadURL } = await uploadUrlResponse.json();\n\n        // Step 2: Upload file to object storage\n        const uploadResponse = await fetch(uploadURL, {\n          method: 'PUT',\n          body: selectedFile,\n          headers: {\n            'Content-Type': selectedFile!.type,\n          },\n        });\n\n        if (!uploadResponse.ok) {\n          throw new Error('Failed to upload file');\n        }\n\n        // Step 3: Create document record\n        const documentData = {\n          name: documentName,\n          type: documentType,\n          description: description || null,\n          fileName: selectedFile!.name,\n          filePath: uploadURL.split('?')[0], // Remove query parameters\n          fileSize: selectedFile!.size,\n          mimeType: selectedFile!.type,\n          expiryDate: expiryDate ? new Date(expiryDate).toISOString() : null,\n          isPublic: isPublic,\n        };\n\n        const response = await fetch(`/api/vessels/${vesselId}/documents`, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            ...getAuthHeaders(),\n          },\n          body: JSON.stringify(documentData),\n        });\n\n        if (!response.ok) {\n          const errorData = await response.json();\n          throw new Error(errorData.message || 'Failed to create document record');\n        }\n\n        return response.json();\n      } finally {\n        setIsUploading(false);\n      }\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Document uploaded',\n        description: 'The vessel document has been uploaded successfully.',\n      });\n      \n      // Reset form\n      setSelectedFile(null);\n      setDocumentName('');\n      setDocumentType('');\n      setDescription('');\n      setExpiryDate('');\n      setIsPublic(false);\n      \n      // Refresh documents list\n      queryClient.invalidateQueries({ queryKey: [`/api/vessels/${vesselId}/documents`] });\n      \n      onClose();\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Upload failed',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      setSelectedFile(file);\n      if (!documentName) {\n        // Auto-fill document name from file name\n        const nameWithoutExtension = file.name.replace(/\\.[^/.]+$/, '');\n        setDocumentName(nameWithoutExtension);\n      }\n    }\n  };\n\n  const handleUpload = () => {\n    if (!selectedFile || !documentName || !documentType) {\n      toast({\n        title: 'Missing information',\n        description: 'Please select a file, enter a document name, and choose a document type.',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    uploadMutation.mutate({});\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-md max-h-[90vh] flex flex-col\" aria-describedby=\"upload-document-description\">\n        <DialogHeader className=\"flex-shrink-0 pb-4\">\n          <DialogTitle className=\"flex items-center space-x-2\">\n            <FileText className=\"h-5 w-5\" />\n            <span>Upload Document</span>\n          </DialogTitle>\n          <p id=\"upload-document-description\" className=\"text-sm text-muted-foreground\">\n            Upload a new document for {vesselName}\n          </p>\n        </DialogHeader>\n\n        <div className=\"space-y-4 overflow-y-auto flex-1 pr-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100\"\n             style={{ maxHeight: 'calc(90vh - 160px)' }}>\n          {/* File Upload */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"file-upload\">Select File</Label>\n            <div className=\"border-2 border-dashed border-gray-200 rounded-lg p-6 text-center hover:border-gray-300 transition-colors\">\n              {selectedFile ? (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-center space-x-2\">\n                    <FileText className=\"h-8 w-8 text-blue-500\" />\n                    <div className=\"text-left\">\n                      <p className=\"text-sm font-medium\">{selectedFile.name}</p>\n                      <p className=\"text-xs text-gray-500\">{formatFileSize(selectedFile.size)}</p>\n                    </div>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => setSelectedFile(null)}\n                      className=\"ml-2\"\n                      data-testid=\"remove-file-button\"\n                    >\n                      <X className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </div>\n              ) : (\n                <div>\n                  <Upload className=\"h-8 w-8 text-gray-400 mx-auto mb-2\" />\n                  <p className=\"text-sm text-gray-600 mb-2\">Click to select a file or drag and drop</p>\n                  <input\n                    id=\"file-upload\"\n                    type=\"file\"\n                    onChange={handleFileChange}\n                    className=\"hidden\"\n                    accept=\".pdf,.doc,.docx,.jpg,.jpeg,.png,.xls,.xlsx\"\n                    data-testid=\"file-input\"\n                  />\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => document.getElementById('file-upload')?.click()}\n                    data-testid=\"select-file-button\"\n                  >\n                    Select File\n                  </Button>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Document Details */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"document-name\">Document Name *</Label>\n            <Input\n              id=\"document-name\"\n              value={documentName}\n              onChange={(e) => setDocumentName(e.target.value)}\n              placeholder=\"Enter document name\"\n              data-testid=\"input-document-name\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"document-type\">Document Type *</Label>\n            <Select value={documentType} onValueChange={setDocumentType}>\n              <SelectTrigger data-testid=\"select-document-type\">\n                <SelectValue placeholder=\"Select document type\" />\n              </SelectTrigger>\n              <SelectContent>\n                {DOCUMENT_TYPES.map((type) => (\n                  <SelectItem key={type.value} value={type.value}>\n                    {type.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"description\">Description</Label>\n            <Textarea\n              id=\"description\"\n              value={description}\n              onChange={(e) => setDescription(e.target.value)}\n              placeholder=\"Optional description\"\n              rows={2}\n              data-testid=\"textarea-description\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"expiry-date\">Expiry Date</Label>\n            <Input\n              id=\"expiry-date\"\n              type=\"date\"\n              value={expiryDate}\n              onChange={(e) => setExpiryDate(e.target.value)}\n              data-testid=\"input-expiry-date\"\n            />\n          </div>\n\n          <div className=\"flex items-center space-x-2\">\n            <Checkbox\n              id=\"is-public\"\n              checked={isPublic}\n              onCheckedChange={(checked) => setIsPublic(checked === true)}\n              data-testid=\"checkbox-public\"\n            />\n            <Label htmlFor=\"is-public\" className=\"text-sm\">\n              Make document publicly accessible\n            </Label>\n          </div>\n\n        </div>\n\n        {/* Footer - Always visible */}\n        <div className=\"flex-shrink-0 flex justify-end space-x-2 pt-4 border-t border-border bg-background mt-4\">\n          <Button variant=\"outline\" onClick={onClose} disabled={isUploading} data-testid=\"button-cancel\">\n            Cancel\n          </Button>\n          <Button \n            onClick={handleUpload} \n            disabled={!selectedFile || !documentName || !documentType || isUploading}\n            data-testid=\"button-upload\"\n            className=\"bg-blue-600 hover:bg-blue-700\"\n          >\n            {isUploading ? (\n              <>\n                <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\n                Uploading...\n              </>\n            ) : (\n              <>\n                <Upload className=\"h-4 w-4 mr-2\" />\n                Upload Document\n              </>\n            )}\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":11472,"size_tokens":null},"client/src/components/layout/app-layout.tsx":{"content":"import { useState } from 'react';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useLocation } from 'wouter';\nimport { useQuery } from '@tanstack/react-query';\nimport Sidebar from './sidebar-new';\nimport { Button } from '@/components/ui/button';\nimport { ThemeToggle } from '@/components/ui/theme-toggle';\nimport { Bell, User, Menu, X, Ship } from 'lucide-react';\nimport { Badge } from '@/components/ui/badge';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from '@/components/ui/popover';\nimport { useIsMobile } from '@/hooks/use-mobile';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { formatDate } from '@/lib/utils';\n\ninterface AppLayoutProps {\n  children: React.ReactNode;\n}\n\nexport default function AppLayout({ children }: AppLayoutProps) {\n  const { user, switchRole } = useAuth();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [notificationPopoverOpen, setNotificationPopoverOpen] = useState(false);\n  const isMobile = useIsMobile();\n  const [, setLocation] = useLocation();\n\n  // Get notification count from expiring documents\n  const { data: expiringDocuments } = useQuery({\n    queryKey: ['/api/alerts/expiring-documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/alerts/expiring-documents', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch alerts');\n      return response.json();\n    },\n    refetchInterval: 30000, // Refresh every 30 seconds\n  });\n\n  const notificationCount = expiringDocuments?.length || 0;\n\n  const handleRoleChange = (newRole: string) => {\n    switchRole(newRole);\n  };\n\n  const handleNotificationsClick = () => {\n    if (notificationCount > 0) {\n      // If there are notifications, show popover first\n      setNotificationPopoverOpen(!notificationPopoverOpen);\n    } else {\n      // If no notifications, go directly to notifications page\n      setLocation('/notifications');\n    }\n  };\n\n  const handleViewAllNotifications = () => {\n    setNotificationPopoverOpen(false);\n    setLocation('/documents');\n  };\n\n  const handleDocumentClick = (crewMemberId: string, documentType: string) => {\n    setNotificationPopoverOpen(false);\n    setLocation(`/documents?crew=${crewMemberId}&type=${documentType}`);\n  };\n\n  if (!user) {\n    return <div>Loading...</div>;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <header className=\"bg-card border-b border-border shadow-sm fixed w-full top-0 z-50\">\n        <div className=\"flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4\">\n          <div className=\"flex items-center space-x-2 sm:space-x-4 min-w-0 flex-1\">\n            {isMobile && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setSidebarOpen(!sidebarOpen)}\n                data-testid=\"mobile-menu-toggle\"\n                className=\"shrink-0\"\n              >\n                {sidebarOpen ? <X className=\"h-5 w-5\" /> : <Menu className=\"h-5 w-5\" />}\n              </Button>\n            )}\n            <div className=\"flex items-center space-x-2 min-w-0\">\n              <div className=\"w-6 h-6 sm:w-8 sm:h-8 bg-maritime-navy rounded-lg flex items-center justify-center wave-animation shrink-0\">\n                <span className=\"text-white text-xs sm:text-sm\">‚öì</span>\n              </div>\n              <h1 className=\"text-lg sm:text-xl font-semibold text-foreground truncate\">\n                <span className=\"hidden sm:inline\">CrewTrack Pro</span>\n                <span className=\"sm:hidden\">CrewTrack</span>\n              </h1>\n            </div>\n          </div>\n          \n          <div className=\"flex items-center space-x-2 sm:space-x-4 shrink-0\">\n            {/* Theme Toggle */}\n            <ThemeToggle />\n            \n            {/* Role Switcher for Demo */}\n            <Select value={user.role} onValueChange={handleRoleChange}>\n              <SelectTrigger className=\"w-32 sm:w-48 text-xs sm:text-sm\" data-testid=\"role-selector\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"admin\">\n                  <span className=\"hidden sm:inline\">Admin (Head Office)</span>\n                  <span className=\"sm:hidden\">Admin</span>\n                </SelectItem>\n                <SelectItem value=\"office_staff\">\n                  <span className=\"hidden sm:inline\">Office Staff</span>\n                  <span className=\"sm:hidden\">Staff</span>\n                </SelectItem>\n              </SelectContent>\n            </Select>\n            \n            <Popover open={notificationPopoverOpen} onOpenChange={setNotificationPopoverOpen}>\n              <PopoverTrigger asChild>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\" \n                  className=\"relative\" \n                  data-testid=\"notifications-button\"\n                  onClick={handleNotificationsClick}\n                >\n                  <Bell className=\"h-5 w-5\" />\n                  {notificationCount > 0 && (\n                    <Badge variant=\"destructive\" className=\"absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center text-xs\">\n                      {notificationCount}\n                    </Badge>\n                  )}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent side=\"bottom\" align=\"end\" className=\"w-80\">\n                <div className=\"space-y-3\">\n                  {notificationCount > 0 ? (\n                    <>\n                      <div className=\"flex items-center justify-between\">\n                        <h4 className=\"font-semibold text-sm\">Documents Expiring Soon</h4>\n                        <Badge variant=\"secondary\" className=\"text-xs\">{notificationCount}</Badge>\n                      </div>\n                      <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n                        {expiringDocuments?.slice(0, 8).map((alert: any, index: number) => (\n                          <div \n                            key={index} \n                            className=\"p-2 rounded border bg-card hover:bg-accent cursor-pointer transition-colors\"\n                            onClick={() => handleDocumentClick(alert.crewMember?.id, alert.document.documentType)}\n                            data-testid={`notification-item-${index}`}\n                          >\n                            <div className=\"flex items-start justify-between\">\n                              <div className=\"flex-1\">\n                                <p className=\"font-medium text-sm\">{alert.crewMember?.firstName} {alert.crewMember?.lastName}</p>\n                                <p className=\"text-xs text-muted-foreground\">{alert.document.documentType}</p>\n                                <p className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">Click to manage ‚Üí</p>\n                              </div>\n                              <div className=\"text-right\">\n                                <p className=\"text-xs font-medium text-destructive\">\n                                  Expires {formatDate(alert.document.expiryDate)}\n                                </p>\n                              </div>\n                            </div>\n                          </div>\n                        ))}\n                        {notificationCount > 8 && (\n                          <p className=\"text-xs text-muted-foreground text-center py-2\">\n                            ...and {notificationCount - 8} more documents\n                          </p>\n                        )}\n                      </div>\n                      <div className=\"flex gap-2 pt-2 border-t\">\n                        <Button \n                          variant=\"outline\" \n                          size=\"sm\" \n                          className=\"flex-1\"\n                          onClick={() => setNotificationPopoverOpen(false)}\n                        >\n                          Close\n                        </Button>\n                        <Button \n                          size=\"sm\" \n                          className=\"flex-1\"\n                          onClick={handleViewAllNotifications}\n                          data-testid=\"view-all-notifications\"\n                        >\n                          View Documents\n                        </Button>\n                      </div>\n                    </>\n                  ) : (\n                    <div className=\"text-center py-4\">\n                      <Bell className=\"h-8 w-8 mx-auto mb-2 text-muted-foreground\" />\n                      <p className=\"text-sm font-medium\">No notifications</p>\n                      <p className=\"text-xs text-muted-foreground\">All documents are up to date</p>\n                    </div>\n                  )}\n                </div>\n              </PopoverContent>\n            </Popover>\n            \n            <div className=\"flex items-center space-x-2 bg-muted rounded-lg px-2 sm:px-3 py-2\">\n              <div className=\"w-6 h-6 sm:w-8 sm:h-8 bg-maritime-navy rounded-full flex items-center justify-center shrink-0\">\n                <User className=\"h-3 w-3 sm:h-4 sm:w-4 text-white dark:text-white\" />\n              </div>\n              <div className=\"hidden sm:block min-w-0\">\n                <p className=\"text-sm font-medium text-foreground truncate\" data-testid=\"user-name\">{user.name}</p>\n                <p className=\"text-xs text-muted-foreground\" data-testid=\"user-role\">\n                  {user.role === 'admin' ? 'Fleet Administrator' : 'Operations Staff'}\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      {/* Layout */}\n      <div className=\"flex pt-20\">\n        {/* Sidebar */}\n        <Sidebar \n          isOpen={sidebarOpen} \n          onClose={() => setSidebarOpen(false)}\n          isMobile={isMobile}\n        />\n        \n        {/* Main Content */}\n        <main className={`flex-1 transition-all duration-200 ${\n          isMobile ? 'ml-0' : 'ml-64'\n        } p-3 sm:p-4 lg:p-6 xl:p-8 max-w-full overflow-x-hidden`}>\n          <div className=\"max-w-full w-full min-w-0 overflow-x-hidden\">\n            {children}\n          </div>\n        </main>\n      </div>\n\n      {/* Mobile overlay */}\n      {isMobile && sidebarOpen && (\n        <div \n          className=\"fixed inset-0 bg-black bg-opacity-50 z-30 xl:hidden\" \n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":10630,"size_tokens":null},"server/services/background-scheduler.ts":{"content":"import { notificationService } from './notification-service';\nimport { storage } from '../storage';\nimport { SMTPEmailService } from './smtp-email-service';\nimport { pdfGeneratorService } from './pdf-generator';\n\ninterface ContractEvent {\n  id: string;\n  type: 'contract_due' | 'contract_expired';\n  date: Date;\n  crewMemberId: string;\n  crewMemberName: string;\n  vesselId: string;\n  vesselName: string;\n  contractId: string;\n  contractEndDate: Date;\n  daysUntilExpiry: number;\n}\n\nexport class BackgroundScheduler {\n  private intervalId: NodeJS.Timeout | null = null;\n  private isRunning = false;\n  private readonly HOUR_IN_MS = 60 * 60 * 1000; // 1 hour in milliseconds\n  private lastMonthlyEmailSent: string | null = null; // Track last monthly email sent (YYYY-MM format)\n\n  constructor() {\n    console.log('üïê Background scheduler initialized');\n  }\n\n  /**\n   * Start the background scheduler to run every hour\n   */\n  start(): void {\n    if (this.isRunning) {\n      console.log('‚ö†Ô∏è  Background scheduler is already running');\n      return;\n    }\n\n    console.log('üöÄ Starting background notification scheduler...');\n    \n    // Run immediately on startup\n    this.runNotificationCheck().catch(error => {\n      console.error('‚ùå Error in initial notification check:', error);\n    });\n\n    // Then schedule to run every hour\n    this.intervalId = setInterval(() => {\n      this.runNotificationCheck().catch(error => {\n        console.error('‚ùå Error in scheduled notification check:', error);\n      });\n    }, this.HOUR_IN_MS);\n\n    this.isRunning = true;\n    console.log('‚úÖ Background scheduler started - will check for notifications every hour');\n  }\n\n  /**\n   * Stop the background scheduler\n   */\n  stop(): void {\n    if (!this.isRunning) {\n      console.log('‚ö†Ô∏è  Background scheduler is not running');\n      return;\n    }\n\n    if (this.intervalId) {\n      clearInterval(this.intervalId);\n      this.intervalId = null;\n    }\n\n    this.isRunning = false;\n    console.log('üõë Background scheduler stopped');\n  }\n\n  /**\n   * Check if the scheduler is currently running\n   */\n  isSchedulerRunning(): boolean {\n    return this.isRunning;\n  }\n\n  /**\n   * Run the notification check process\n   */\n  private async runNotificationCheck(): Promise<void> {\n    const startTime = Date.now();\n    console.log('üîç Running scheduled notification check...');\n\n    try {\n      // Initialize the notification service to pick up any settings changes\n      await notificationService.initialize();\n\n      // Check and send notifications for upcoming events\n      await notificationService.checkAndNotifyUpcomingEvents();\n\n      // Check if monthly calendar email should be sent (1st of month)\n      await this.checkAndSendMonthlyCalendarEmail();\n\n      const endTime = Date.now();\n      const duration = endTime - startTime;\n      console.log(`‚úÖ Notification check completed successfully in ${duration}ms`);\n    } catch (error) {\n      const endTime = Date.now();\n      const duration = endTime - startTime;\n      console.error(`‚ùå Notification check failed after ${duration}ms:`, error);\n      \n      // Log additional error details for debugging\n      if (error instanceof Error) {\n        console.error('Error details:', {\n          message: error.message,\n          stack: error.stack,\n          name: error.name,\n        });\n      }\n    }\n  }\n\n  /**\n   * Check if it's the 1st of the month and send the monthly calendar summary email\n   */\n  private async checkAndSendMonthlyCalendarEmail(): Promise<void> {\n    const now = new Date();\n    const dayOfMonth = now.getDate();\n    const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;\n\n    // Only send on the 1st of the month\n    if (dayOfMonth !== 1) {\n      return;\n    }\n\n    // Check if we already sent the email for this month\n    if (this.lastMonthlyEmailSent === currentMonthKey) {\n      console.log(`üìÖ Monthly calendar email already sent for ${currentMonthKey}`);\n      return;\n    }\n\n    console.log(`üìÖ First of the month detected - preparing monthly calendar email...`);\n\n    try {\n      // Get email settings\n      const settings = await storage.getEmailSettings();\n      if (!settings?.enabled || !settings?.recipientEmail) {\n        console.log('üìß Email not configured or disabled - skipping monthly calendar email');\n        return;\n      }\n\n      // Generate contract events for the current month\n      const monthEvents = await this.generateMonthlyContractEvents();\n\n      // Format month string\n      const monthStr = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });\n\n      // Always send the email on the 1st, even if there are no events\n      await this.sendMonthlyCalendarEmail(monthStr, monthEvents, settings.recipientEmail);\n\n      this.lastMonthlyEmailSent = currentMonthKey;\n      console.log(`‚úÖ Monthly calendar email sent successfully for ${monthStr}`);\n\n    } catch (error) {\n      console.error('‚ùå Failed to send monthly calendar email:', error);\n    }\n  }\n\n  /**\n   * Generate contract events for the current month\n   */\n  private async generateMonthlyContractEvents(): Promise<ContractEvent[]> {\n    const now = new Date();\n    const currentMonth = now.getMonth();\n    const currentYear = now.getFullYear();\n\n    const contracts = await storage.getContracts();\n    const crewMembers = await storage.getCrewMembers();\n    const vessels = await storage.getVessels();\n\n    // Create lookup maps\n    const crewMap = new Map(crewMembers.map(c => [c.id, c]));\n    const vesselMap = new Map(vessels.map(v => [v.id, v]));\n\n    const events: ContractEvent[] = [];\n\n    for (const contract of contracts) {\n      if (!contract.endDate) continue;\n\n      const endDate = new Date(contract.endDate);\n      const today = new Date();\n      const daysUntilExpiry = Math.ceil((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n\n      // Contract Due date (45 days before end date)\n      const dueDate = new Date(endDate);\n      dueDate.setDate(dueDate.getDate() - 45);\n\n      const crewMember = crewMap.get(contract.crewMemberId);\n      // Use contract's vesselId to match the manual email behavior\n      const vessel = contract.vesselId ? vesselMap.get(contract.vesselId) : undefined;\n\n      const crewMemberName = crewMember \n        ? `${crewMember.firstName} ${crewMember.lastName}`\n        : 'Unknown';\n      const vesselName = vessel?.name || 'Unassigned';\n\n      // Check if due date falls in current month\n      if (dueDate.getMonth() === currentMonth && dueDate.getFullYear() === currentYear) {\n        events.push({\n          id: `${contract.id}-due`,\n          type: 'contract_due',\n          date: dueDate,\n          crewMemberId: contract.crewMemberId,\n          crewMemberName,\n          vesselId: contract.vesselId || '',\n          vesselName,\n          contractId: contract.id,\n          contractEndDate: endDate,\n          daysUntilExpiry,\n        });\n      }\n\n      // Check if expiry date falls in current month\n      if (endDate.getMonth() === currentMonth && endDate.getFullYear() === currentYear) {\n        events.push({\n          id: `${contract.id}-expired`,\n          type: 'contract_expired',\n          date: endDate,\n          crewMemberId: contract.crewMemberId,\n          crewMemberName,\n          vesselId: contract.vesselId || '',\n          vesselName,\n          contractId: contract.id,\n          contractEndDate: endDate,\n          daysUntilExpiry,\n        });\n      }\n    }\n\n    // Sort by date\n    events.sort((a, b) => a.date.getTime() - b.date.getTime());\n\n    return events;\n  }\n\n  /**\n   * Send the monthly calendar summary email\n   */\n  private async sendMonthlyCalendarEmail(\n    month: string, \n    events: ContractEvent[], \n    recipientEmail: string\n  ): Promise<void> {\n    const smtpService = new SMTPEmailService();\n\n    if (!smtpService.isReady()) {\n      console.log('‚ö†Ô∏è SMTP service not ready - cannot send monthly calendar email');\n      return;\n    }\n\n    // Group events by type\n    const dueEvents = events.filter(e => e.type === 'contract_due');\n    const expiredEvents = events.filter(e => e.type === 'contract_expired');\n\n    const formatEventRow = (event: ContractEvent, type: string) => {\n      const eventDate = event.date;\n      const dateStr = eventDate.toLocaleDateString('en-US', { \n        weekday: 'short', \n        month: 'short', \n        day: 'numeric',\n        year: 'numeric'\n      });\n      const bgColor = type === 'expired' ? '#fee2e2' : '#fef3c7';\n      const textColor = type === 'expired' ? '#dc2626' : '#d97706';\n      \n      return `\n        <tr style=\"border-bottom: 1px solid #e5e7eb;\">\n          <td style=\"padding: 12px; font-weight: 500;\">${event.crewMemberName}</td>\n          <td style=\"padding: 12px;\">${event.vesselName}</td>\n          <td style=\"padding: 12px;\">${dateStr}</td>\n          <td style=\"padding: 12px;\">\n            <span style=\"background: ${bgColor}; color: ${textColor}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;\">\n              ${event.daysUntilExpiry} days\n            </span>\n          </td>\n        </tr>\n      `;\n    };\n\n    const html = `\n      <div style=\"font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n        <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n          <div style=\"text-align: center; margin-bottom: 30px; border-bottom: 2px solid #0066cc; padding-bottom: 20px;\">\n            <h1 style=\"color: #0066cc; margin: 0; font-size: 24px;\">üìÖ Monthly Contract Calendar Summary</h1>\n            <p style=\"color: #6c757d; margin: 10px 0 0 0;\">${month}</p>\n            <p style=\"color: #28a745; margin: 5px 0 0 0; font-size: 12px;\">ü§ñ Automatically generated on the 1st of the month</p>\n          </div>\n\n          <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;\">\n            <div style=\"background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;\">\n              <div style=\"font-size: 28px; font-weight: bold; color: #d97706;\">${dueEvents.length}</div>\n              <div style=\"font-size: 12px; color: #92400e;\">Contracts Due</div>\n            </div>\n            <div style=\"background: #fee2e2; padding: 15px; border-radius: 8px; text-align: center;\">\n              <div style=\"font-size: 28px; font-weight: bold; color: #dc2626;\">${expiredEvents.length}</div>\n              <div style=\"font-size: 12px; color: #991b1b;\">Contracts Expiring</div>\n            </div>\n            <div style=\"background: #dbeafe; padding: 15px; border-radius: 8px; text-align: center;\">\n              <div style=\"font-size: 28px; font-weight: bold; color: #2563eb;\">${events.length}</div>\n              <div style=\"font-size: 12px; color: #1e40af;\">Total Events</div>\n            </div>\n          </div>\n\n          ${dueEvents.length > 0 ? `\n          <div style=\"margin-bottom: 25px;\">\n            <h2 style=\"color: #d97706; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;\">\n              ‚è∞ Contracts Due Soon (${dueEvents.length})\n            </h2>\n            <table style=\"width: 100%; border-collapse: collapse; background: white; border: 1px solid #e5e7eb; border-radius: 8px;\">\n              <thead>\n                <tr style=\"background: #f9fafb; border-bottom: 2px solid #e5e7eb;\">\n                  <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Crew Member</th>\n                  <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Vessel</th>\n                  <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Due Date</th>\n                  <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Days Left</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${dueEvents.map(e => formatEventRow(e, 'due')).join('')}\n              </tbody>\n            </table>\n          </div>\n          ` : ''}\n\n          ${expiredEvents.length > 0 ? `\n          <div style=\"margin-bottom: 25px;\">\n            <h2 style=\"color: #dc2626; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;\">\n              ‚ö†Ô∏è Contracts Expiring (${expiredEvents.length})\n            </h2>\n            <table style=\"width: 100%; border-collapse: collapse; background: white; border: 1px solid #e5e7eb; border-radius: 8px;\">\n              <thead>\n                <tr style=\"background: #f9fafb; border-bottom: 2px solid #e5e7eb;\">\n                  <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Crew Member</th>\n                  <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Vessel</th>\n                  <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Expiry Date</th>\n                  <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Days Left</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${expiredEvents.map(e => formatEventRow(e, 'expired')).join('')}\n              </tbody>\n            </table>\n          </div>\n          ` : ''}\n\n          ${events.length === 0 ? `\n          <div style=\"background: #f0fdf4; padding: 25px; border-radius: 8px; text-align: center; margin-bottom: 25px;\">\n            <div style=\"font-size: 48px; margin-bottom: 10px;\">‚úÖ</div>\n            <h3 style=\"color: #166534; margin: 0 0 10px 0;\">No Contract Events This Month</h3>\n            <p style=\"color: #15803d; margin: 0; font-size: 14px;\">\n              There are no contracts due or expiring during ${month}. The crew schedule is clear for this month.\n            </p>\n          </div>\n          ` : ''}\n\n          <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center;\">\n            <p style=\"color: #6c757d; font-size: 12px; margin: 0;\">\n              This is an automated monthly report sent on the 1st of each month to help the crew department plan their schedule.\n            </p>\n          </div>\n        </div>\n      </div>\n    `;\n\n    // Generate PDF attachment\n    let pdfBuffer: Buffer | null = null;\n    try {\n      pdfBuffer = await pdfGeneratorService.generateCalendarPDF(month, events);\n      console.log(`üìÑ PDF generated successfully (${pdfBuffer.length} bytes)`);\n    } catch (pdfError) {\n      console.error('‚ö†Ô∏è Failed to generate PDF, sending email without attachment:', pdfError);\n    }\n\n    // Send email with or without attachment\n    if (pdfBuffer) {\n      await smtpService.sendEmailWithAttachment({\n        to: recipientEmail,\n        subject: `üìÖ Monthly Contract Calendar - ${month}`,\n        html,\n        attachments: [{\n          filename: `Contract-Calendar-${month.replace(/\\s+/g, '-')}.pdf`,\n          content: pdfBuffer,\n          contentType: 'application/pdf',\n        }],\n      });\n      console.log(`üìß Monthly calendar email with PDF attachment sent to ${recipientEmail}`);\n    } else {\n      await smtpService.sendEmail({\n        to: recipientEmail,\n        subject: `üìÖ Monthly Contract Calendar - ${month}`,\n        html,\n      });\n      console.log(`üìß Monthly calendar email sent to ${recipientEmail} (without PDF attachment)`);\n    }\n  }\n\n  /**\n   * Manually trigger a notification check (for testing/debugging)\n   */\n  async triggerManualCheck(): Promise<void> {\n    console.log('üîç Manual notification check triggered...');\n    await this.runNotificationCheck();\n  }\n\n  /**\n   * Get scheduler status information\n   */\n  getStatus(): {\n    isRunning: boolean;\n    lastCheck: Date | null;\n    nextCheck: Date | null;\n  } {\n    const now = new Date();\n    return {\n      isRunning: this.isRunning,\n      lastCheck: this.isRunning ? now : null,\n      nextCheck: this.isRunning ? new Date(now.getTime() + this.HOUR_IN_MS) : null,\n    };\n  }\n}\n\n// Export a singleton instance\nexport const backgroundScheduler = new BackgroundScheduler();","path":null,"size_bytes":16050,"size_tokens":null},"client/src/components/crew/add-crew-form.tsx":{"content":"import { useState } from 'react';\nimport { useMutation, useQueryClient, useQuery } from '@tanstack/react-query';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';\nimport { Label } from '@/components/ui/label';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { useToast } from '@/hooks/use-toast';\nimport { getAuthHeaders } from '@/lib/auth';\n\nconst addCrewSchema = z.object({\n  firstName: z.string().optional(),\n  lastName: z.string().optional(),\n  nationality: z.string().optional(),\n  dateOfBirth: z.string().optional(),\n  rank: z.string().optional(),\n  phoneNumber: z.string().optional(),\n  email: z.string().email('Invalid email format').optional().or(z.literal('')),\n  status: z.enum(['onBoard', 'onShore']),\n  contractStartDate: z.string().optional(),\n  contractDurationDays: z.number().optional(),\n  contractEndDate: z.string().optional(),\n  emergencyContact: z.object({\n    name: z.string().optional(),\n    relationship: z.string().optional(),\n    phone: z.string().optional(),\n    email: z.string().optional(),\n  }),\n  currentVesselId: z.string().optional().nullable(),\n});\n\ntype AddCrewFormData = z.infer<typeof addCrewSchema>;\n\ninterface AddCrewFormProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nconst crewRanks = [\n  'Captain',\n  'Chief Officer',\n  'Chief Officer (NCV)',\n  '2nd Officer', \n  '3rd Officer',\n  'IV Master',\n  'Second Master (IV)',\n  'Chief Engineer',\n  'Chief Engineer (NCV)',\n  '2nd Engineer',\n  '3rd Engineer',\n  '4th Engineer',\n  'Bosun',\n  'AB Seaman',\n  'Deck Watchkeeping Rating (AB)',\n  'OS Seaman',\n  'Engine Rating',\n  'Cook',\n  '2nd Cook',\n  'Messman',\n  'Saloon Rating',\n  'Oiler',\n  'Wiper',\n  'Fitter',\n  'Handler',\n  'Tube Operator',\n  'Lathe Operator',\n  'Radio Officer',\n  'ETO',\n  'ASST ETO',\n  'GMDSS OPERATOR'\n];\n\nconst relationships = [\n  'Spouse',\n  'Wife',\n  'Parent',\n  'Child',\n  'Sibling',\n  'Friend',\n  'Other'\n];\n\nexport default function AddCrewForm({ open, onOpenChange }: AddCrewFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: vessels } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  const form = useForm<AddCrewFormData>({\n    resolver: zodResolver(addCrewSchema),\n    defaultValues: {\n      firstName: '',\n      lastName: '',\n      nationality: '',\n      dateOfBirth: '',\n      rank: '',\n      phoneNumber: '',\n      email: '',\n      status: 'onBoard',\n      contractStartDate: '',\n      contractDurationDays: 90, // Default 3 months\n      contractEndDate: '',\n      emergencyContact: {\n        name: '',\n        relationship: '',\n        phone: '',\n        email: '',\n      },\n      currentVesselId: undefined,\n    },\n  });\n\n  const addCrewMutation = useMutation({\n    mutationFn: async (data: AddCrewFormData) => {\n      const crewData = {\n        userId: undefined,\n        firstName: data.firstName,\n        lastName: data.lastName,\n        nationality: data.nationality,\n        dateOfBirth: data.dateOfBirth,\n        rank: data.rank,\n        phoneNumber: data.phoneNumber || undefined,\n        email: data.email || undefined,\n        emergencyContact: data.emergencyContact,\n        currentVesselId: data.currentVesselId && data.currentVesselId !== 'none' ? data.currentVesselId : undefined,\n        status: data.status,\n        contractStartDate: data.contractStartDate,\n        contractEndDate: data.contractEndDate,\n        contractDurationDays: data.contractDurationDays,\n      };\n\n      const crewResponse = await fetch('/api/crew', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...getAuthHeaders(),\n        },\n        body: JSON.stringify(crewData),\n      });\n      \n      if (!crewResponse.ok) {\n        const errorData = await crewResponse.json().catch(() => ({}));\n        if (errorData.error === 'DUPLICATE_CREW_MEMBER') {\n          throw new Error(errorData.message || 'This crew member already exists on the same vessel.');\n        }\n        throw new Error(errorData.message || 'Failed to add crew member');\n      }\n      \n      const newCrewMember = await crewResponse.json();\n\n      return newCrewMember;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      toast({\n        title: 'Success',\n        description: 'Crew member added successfully',\n      });\n      form.reset();\n      onOpenChange(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to add crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const onSubmit = (data: AddCrewFormData) => {\n    addCrewMutation.mutate(data);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"w-[95vw] max-w-[95vw] sm:max-w-3xl max-h-[95vh] overflow-hidden m-2 sm:m-6\">\n        <DialogHeader className=\"px-3 sm:px-6 pt-4 sm:pt-6 pb-2\">\n          <DialogTitle className=\"text-lg sm:text-xl\">Add New Crew Member</DialogTitle>\n          <DialogDescription className=\"text-sm sm:text-base\">\n            Enter the crew member's details to add them to the system.\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"px-3 sm:px-6 pb-4 sm:pb-6 overflow-y-auto max-h-[calc(95vh-120px)]\">\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-3 sm:space-y-4\">\n            \n            {/* Personal Information */}\n            <div className=\"space-y-3 p-3 sm:p-4 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg\">\n              <h3 className=\"text-base sm:text-lg font-semibold text-blue-900 dark:text-blue-100 flex items-center\">\n                <div className=\"w-2 h-2 bg-blue-600 rounded-full mr-2 sm:mr-3\"></div>\n                Personal Information\n              </h3>\n              \n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"firstName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>First Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} data-testid=\"first-name-input\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"lastName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Last Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} data-testid=\"last-name-input\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"nationality\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Nationality</FormLabel>\n                      <FormControl>\n                        <Input {...field} data-testid=\"nationality-input\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"dateOfBirth\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Date of Birth</FormLabel>\n                      <FormControl>\n                        <Input type=\"date\" {...field} data-testid=\"dob-input\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"phoneNumber\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Phone Number</FormLabel>\n                      <FormControl>\n                        <Input {...field} value={field.value || ''} data-testid=\"phone-input\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email</FormLabel>\n                      <FormControl>\n                        <Input type=\"email\" placeholder=\"Enter email address\" {...field} value={field.value || ''} data-testid=\"input-email\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            {/* Professional Information */}\n            <div className=\"space-y-3 p-4 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg\">\n              <h3 className=\"text-lg font-semibold text-green-900 dark:text-green-100 flex items-center\">\n                <div className=\"w-2 h-2 bg-green-600 rounded-full mr-3\"></div>\n                Professional Information\n              </h3>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"rank\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Rank</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value || undefined}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"rank-select\">\n                            <SelectValue placeholder=\"Select rank\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {crewRanks.map((rank) => (\n                            <SelectItem key={rank} value={rank}>\n                              {rank}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"currentVesselId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Current Vessel</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value || undefined}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"vessel-select\">\n                            <SelectValue placeholder=\"Select vessel\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"none\">No assignment</SelectItem>\n                          {vessels?.map((vessel: any) => (\n                            <SelectItem key={vessel.id} value={vessel.id}>\n                              {vessel.name} ({vessel.type})\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"status\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Status</FormLabel>\n                    <FormControl>\n                      <RadioGroup\n                        onValueChange={field.onChange}\n                        value={field.value}\n                        className=\"flex flex-col space-y-2\"\n                        data-testid=\"status-radio-group\"\n                      >\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"onBoard\" id=\"onBoard\" />\n                          <Label htmlFor=\"onBoard\" className=\"cursor-pointer\">On Board</Label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"onShore\" id=\"onShore\" />\n                          <Label htmlFor=\"onShore\" className=\"cursor-pointer\">On Shore</Label>\n                        </div>\n                      </RadioGroup>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            {/* Emergency Contact */}\n            <div className=\"space-y-3 p-4 bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-800 rounded-lg\">\n              <h3 className=\"text-lg font-semibold text-orange-900 dark:text-orange-100 flex items-center\">\n                <div className=\"w-2 h-2 bg-orange-600 rounded-full mr-3\"></div>\n                Emergency Contact\n              </h3>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"emergencyContact.name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Contact Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} data-testid=\"emergency-name-input\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"emergencyContact.relationship\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Relationship</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value || undefined}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"relationship-select\">\n                            <SelectValue placeholder=\"Select relationship\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {relationships.map((rel) => (\n                            <SelectItem key={rel} value={rel}>\n                              {rel}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"emergencyContact.phone\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Contact Phone</FormLabel>\n                      <FormControl>\n                        <Input {...field} data-testid=\"emergency-phone-input\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"emergencyContact.email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Contact Email</FormLabel>\n                      <FormControl>\n                        <Input type=\"email\" {...field} data-testid=\"emergency-email-input\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n              <div className=\"flex justify-end space-x-2 pt-6 border-t mt-6\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => onOpenChange(false)}\n                  data-testid=\"cancel-add-crew\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={addCrewMutation.isPending}\n                  data-testid=\"add-crew-submit\"\n                >\n                  {addCrewMutation.isPending ? 'Adding...' : 'Add Crew Member'}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":18065,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":791,"size_tokens":null},"server/db.ts":{"content":"import { Pool, neonConfig } from '@neondatabase/serverless';\nimport { drizzle } from 'drizzle-orm/neon-serverless';\nimport ws from \"ws\";\nimport * as schema from \"@shared/schema\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool, schema });\n","path":null,"size_bytes":483,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"client/src/components/documents/document-upload.tsx":{"content":"import { useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { useMutation, useQuery } from '@tanstack/react-query';\nimport { queryClient } from '@/lib/queryClient';\nimport { apiRequest } from '@/lib/queryClient';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { insertDocumentSchema } from '@shared/schema';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Progress } from '@/components/ui/progress';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Upload, FileText, AlertCircle } from 'lucide-react';\nimport { z } from 'zod';\nimport { format } from 'date-fns';\n\nconst documentFormSchema = insertDocumentSchema.extend({\n  issueDate: z.string(),\n  expiryDate: z.string(),\n  file: z.any().optional(),\n});\n\ntype DocumentFormData = z.infer<typeof documentFormSchema>;\n\ninterface DocumentUploadProps {\n  crewMemberId?: string;\n  document?: any; // For editing existing documents\n  preselectedType?: string; // Preselected document type\n  onSuccess?: () => void;\n}\n\nconst documentTypes = [\n  { value: 'passport', label: 'Passport' },\n  { value: 'cdc', label: 'CDC (Continuous Discharge Certificate)' },\n  { value: 'coc', label: 'COC (Certificate of Competency)' },\n  { value: 'stcw', label: 'STCW Certificate' },\n  { value: 'medical', label: 'Medical Certificate' },\n  { value: 'visa', label: 'Visa' },\n];\n\nexport default function DocumentUpload({ crewMemberId, document, preselectedType, onSuccess }: DocumentUploadProps) {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [uploadProgress, setUploadProgress] = useState(0);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n\n  const form = useForm<DocumentFormData>({\n    resolver: zodResolver(documentFormSchema),\n    defaultValues: {\n      type: document?.type || preselectedType || '',\n      documentNumber: document?.documentNumber || '',\n      issueDate: document?.issueDate ? format(new Date(document.issueDate), 'yyyy-MM-dd') : '',\n      expiryDate: document?.expiryDate ? format(new Date(document.expiryDate), 'yyyy-MM-dd') : '',\n      issuingAuthority: document?.issuingAuthority || '',\n      status: document?.status || 'valid',\n      crewMemberId: crewMemberId || '',\n    },\n  });\n\n  const { data: crewMembers } = useQuery({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n    enabled: !crewMemberId && user?.role !== 'crew',\n  });\n\n  // For crew users, auto-select their profile\n  const getCurrentCrewMemberId = () => {\n    // Always prioritize the crewMemberId prop if provided\n    if (crewMemberId) {\n      return crewMemberId;\n    }\n    \n    if (user?.role === 'crew') {\n      const currentMember = crewMembers?.find((member: any) => member.user?.id === user.id);\n      return currentMember?.id;\n    }\n    \n    // For admin/office_staff, get the selected crew member from the form\n    const formValue = form.getValues('crewMemberId');\n    return formValue || '';\n  };\n\n  const uploadMutation = useMutation({\n    mutationFn: async (data: DocumentFormData) => {\n      // First, upload actual file if selected\n      let filePath = null;\n      if (selectedFile) {\n        setUploadProgress(25);\n        // Create FormData for actual file upload\n        const formData = new FormData();\n        formData.append('file', selectedFile);\n        \n        const uploadResponse = await fetch('/api/upload', {\n          method: 'POST',\n          headers: getAuthHeaders(),\n          body: formData, // Send actual file as FormData\n        });\n        \n        if (!uploadResponse.ok) {\n          throw new Error('Failed to upload file');\n        }\n        \n        setUploadProgress(75);\n        const uploadData = await uploadResponse.json();\n        filePath = uploadData.filePath;\n      }\n\n      setUploadProgress(90);\n\n      // Get and validate crew member ID\n      const selectedCrewId = getCurrentCrewMemberId();\n      \n      if (!selectedCrewId) {\n        throw new Error('No crew member selected. Please select a crew member before uploading the document.');\n      }\n\n      // Create or update document record\n      const payload = {\n        ...data,\n        crewMemberId: selectedCrewId,\n        issueDate: new Date(data.issueDate),\n        expiryDate: new Date(data.expiryDate),\n        filePath,\n      };\n\n      const isEditing = !!document;\n      const response = isEditing \n        ? await apiRequest('PATCH', `/api/documents/${document.id}`, payload)\n        : await apiRequest('POST', '/api/documents', payload);\n      setUploadProgress(100);\n      return response;\n    },\n    onSuccess: () => {\n      // Invalidate all document-related queries\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/alerts/expiring-documents'] });\n      \n      // Force refetch of documents immediately\n      queryClient.refetchQueries({ queryKey: ['/api/documents'] });\n      \n      toast({\n        title: 'Success',\n        description: document ? 'Document updated successfully' : 'Document uploaded successfully',\n      });\n      form.reset();\n      setSelectedFile(null);\n      setUploadProgress(0);\n      onSuccess?.();\n    },\n    onError: (error) => {\n      setUploadProgress(0);\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to upload document',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const onSubmit = (data: DocumentFormData) => {\n    const selectedCrewId = getCurrentCrewMemberId();\n    if (!selectedCrewId) {\n      toast({\n        title: 'Error',\n        description: 'Please select a crew member',\n        variant: 'destructive',\n      });\n      return;\n    }\n    \n    uploadMutation.mutate(data);\n  };\n\n  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      // Validate file size (max 5MB)\n      if (file.size > 5 * 1024 * 1024) {\n        toast({\n          title: 'Error',\n          description: 'File size must be less than 5MB',\n          variant: 'destructive',\n        });\n        return;\n      }\n\n      // Validate file type\n      const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];\n      if (!allowedTypes.includes(file.type)) {\n        toast({\n          title: 'Error',\n          description: 'Only PDF, JPEG, and PNG files are allowed',\n          variant: 'destructive',\n        });\n        return;\n      }\n\n      setSelectedFile(file);\n    }\n  };\n\n  return (\n    <Form {...form}>\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n        {/* Crew Member Selection (for admins/captains) */}\n        {!crewMemberId && user?.role !== 'crew' && (\n          <FormField\n            control={form.control}\n            name=\"crewMemberId\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Crew Member *</FormLabel>\n                <Select \n                  onValueChange={field.onChange} \n                  value={field.value}\n                >\n                  <FormControl>\n                    <SelectTrigger data-testid=\"crew-member-select\">\n                      <SelectValue placeholder=\"Select crew member\" />\n                    </SelectTrigger>\n                  </FormControl>\n                  <SelectContent>\n                    {crewMembers?.map((member: any) => (\n                      <SelectItem key={member.id} value={member.id}>\n                        {member.firstName} {member.lastName} - {member.rank}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        )}\n\n        {/* Document Type */}\n        <FormField\n          control={form.control}\n          name=\"type\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Document Type *</FormLabel>\n              <Select onValueChange={field.onChange} value={field.value}>\n                <FormControl>\n                  <SelectTrigger data-testid=\"document-type-select\">\n                    <SelectValue placeholder=\"Select document type\" />\n                  </SelectTrigger>\n                </FormControl>\n                <SelectContent>\n                  {documentTypes.map((type) => (\n                    <SelectItem key={type.value} value={type.value}>\n                      {type.label}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        {/* Document Number */}\n        <FormField\n          control={form.control}\n          name=\"documentNumber\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Document Number *</FormLabel>\n              <FormControl>\n                <Input {...field} placeholder=\"Enter document number\" data-testid=\"document-number-input\" />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        {/* Issue and Expiry Dates */}\n        <div className=\"grid grid-cols-2 gap-4\">\n          <FormField\n            control={form.control}\n            name=\"issueDate\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Issue Date *</FormLabel>\n                <FormControl>\n                  <Input type=\"date\" {...field} data-testid=\"issue-date-input\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"expiryDate\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Expiry Date *</FormLabel>\n                <FormControl>\n                  <Input type=\"date\" {...field} data-testid=\"expiry-date-input\" />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        {/* Issuing Authority */}\n        <FormField\n          control={form.control}\n          name=\"issuingAuthority\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Issuing Authority *</FormLabel>\n              <FormControl>\n                <Input {...field} placeholder=\"e.g., Maritime Authority\" data-testid=\"issuing-authority-input\" />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        {/* File Upload */}\n        <div className=\"space-y-2\">\n          <label className=\"text-sm font-medium\">Document File</label>\n          <div className=\"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors\">\n            <input\n              type=\"file\"\n              onChange={handleFileChange}\n              accept=\".pdf,.jpg,.jpeg,.png\"\n              className=\"hidden\"\n              id=\"file-upload\"\n              data-testid=\"file-upload-input\"\n            />\n            <label\n              htmlFor=\"file-upload\"\n              className=\"cursor-pointer flex flex-col items-center space-y-2\"\n            >\n              <Upload className=\"h-8 w-8 text-gray-400\" />\n              <div className=\"text-sm text-gray-600\">\n                {selectedFile ? (\n                  <div className=\"flex items-center space-x-2\">\n                    <FileText className=\"h-4 w-4\" />\n                    <span>{selectedFile.name}</span>\n                  </div>\n                ) : (\n                  <>\n                    <span className=\"font-medium text-maritime-navy\">Click to upload</span>\n                    <span className=\"block\">or drag and drop</span>\n                    <span className=\"block text-xs\">PDF, JPG, PNG up to 5MB</span>\n                  </>\n                )}\n              </div>\n            </label>\n          </div>\n        </div>\n\n        {/* Upload Progress */}\n        {uploadProgress > 0 && uploadProgress < 100 && (\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <span>Uploading...</span>\n              <span>{uploadProgress}%</span>\n            </div>\n            <Progress value={uploadProgress} data-testid=\"upload-progress\" />\n          </div>\n        )}\n\n        {/* Warning for expiry date */}\n        {form.watch('expiryDate') && (\n          <Alert>\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertDescription>\n              Please ensure the expiry date is correct. The system will automatically track and alert for renewals.\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {/* Form Actions */}\n        <div className=\"flex justify-end space-x-2 pt-4\">\n          <Button \n            type=\"button\" \n            variant=\"outline\" \n            onClick={onSuccess}\n            data-testid=\"cancel-upload-button\"\n          >\n            Cancel\n          </Button>\n          <Button \n            type=\"submit\" \n            className=\"bg-maritime-navy hover:bg-blue-800\"\n            disabled={uploadMutation.isPending}\n            data-testid=\"upload-document-submit-button\"\n          >\n            Upload Document\n          </Button>\n        </div>\n      </form>\n    </Form>\n  );\n}\n","path":null,"size_bytes":14012,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1128,"size_tokens":null},"deployment/README.md":{"content":"# CrewTrack Pro - Production Deployment\n\nThis directory contains the production-ready version of CrewTrack Pro.\n\n## Quick Start\n\n1. Upload all files to your hosting server\n2. Copy .env.example to .env and configure your database\n3. Run: npm install --production\n4. Run: npm run db:push\n5. Start: npm start\n\n## Files Included\n\n- server/ - Backend Node.js application\n- dist/ - Frontend React application (built)\n- shared/ - Shared schema and types\n- package.json - Production dependencies only\n- .env.example - Environment configuration template\n\n## Database Setup\n\nThis application requires PostgreSQL. Update your .env file with your database credentials.\n\n## For detailed deployment instructions, see DEPLOYMENT_GUIDE.md\n","path":null,"size_bytes":723,"size_tokens":null},"deployment/server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2263,"size_tokens":null},"client/src/components/vessels/vessel-cards.tsx":{"content":"import { useState, useMemo } from 'react';\nimport AddVesselForm from './add-vessel-form';\nimport CrewManagementDialog from './crew-management-dialog';\nimport VesselDetailsDialog from './vessel-details-dialog';\nimport SimpleVesselDetailsDialog from './simple-vessel-details-dialog';\nimport { VesselDocumentUploadModal } from '../vessel-documents/vessel-document-upload-modal';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Badge } from '@/components/ui/badge';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { ContractStatusBadges } from './contract-status-badges';\nimport CrewStatsBadges from './crew-stats-badges';\nimport { Ship, Users, Calendar, Flag, Hash, Plus, Download, Search, GripVertical, FileText } from 'lucide-react';\nimport { format } from 'date-fns';\nimport { Vessel } from '@shared/schema';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport * as XLSX from 'xlsx';\n\nimport {\n  DndContext,\n  closestCenter,\n  KeyboardSensor,\n  PointerSensor,\n  useSensor,\n  useSensors,\n  DragEndEvent,\n} from '@dnd-kit/core';\nimport {\n  arrayMove,\n  SortableContext,\n  sortableKeyboardCoordinates,\n  rectSortingStrategy,\n} from '@dnd-kit/sortable';\nimport {\n  useSortable,\n} from '@dnd-kit/sortable';\nimport { CSS } from '@dnd-kit/utilities';\n\nexport interface VesselWithDetails extends Vessel {\n  crewCount?: number;\n  nextCrewChange?: string;\n}\n\n// Sortable Vessel Card Component\nfunction SortableVesselCard({ vessel, onViewDetails, onManageCrew, onUploadDocument, isAdmin, showUploadButton = true }: {\n  vessel: VesselWithDetails;\n  onViewDetails: (vessel: VesselWithDetails) => void;\n  onManageCrew: (vessel: VesselWithDetails) => void;\n  onUploadDocument: (vessel: VesselWithDetails) => void;\n  isAdmin: boolean;\n  showUploadButton?: boolean;\n}) {\n  const {\n    attributes,\n    listeners,\n    setNodeRef,\n    transform,\n    transition,\n    isDragging,\n  } = useSortable({ id: vessel.id });\n\n  const style = {\n    transform: CSS.Transform.toString(transform),\n    transition,\n    opacity: isDragging ? 0.5 : 1,\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status.toLowerCase()) {\n      case 'harbour-mining':\n        return 'bg-compliance-green text-white';\n      case 'coastal-mining':\n        return 'bg-ocean-blue text-white';\n      case 'world-wide':\n        return 'bg-maritime-navy text-white';\n      case 'oil-field':\n        return 'bg-warning-amber text-white';\n      case 'line-up-mining':\n        return 'bg-gray-500 text-white';\n      default:\n        return 'bg-gray-500 text-white';\n    }\n  };\n\n  const getVesselIcon = (type: string) => {\n    return <Ship className=\"h-8 w-8 text-primary\" />;\n  };\n\n  const formatStatus = (status: string) => {\n    switch (status.toLowerCase()) {\n      case 'harbour-mining': return 'Harbour-Mining';\n      case 'coastal-mining': return 'Coastal-Mining';\n      case 'world-wide': return 'World-Wide';\n      case 'oil-field': return 'Oil-Field';\n      case 'line-up-mining': return 'Laid Up';\n      case 'active': return 'Active';\n      default: return status.charAt(0).toUpperCase() + status.slice(1);\n    }\n  };\n\n  return (\n    <Card \n      ref={setNodeRef} \n      style={style}\n      className={`bg-card dark:bg-card border-border hover:shadow-md transition-shadow duration-200 cursor-pointer group ${\n        isDragging ? 'shadow-2xl ring-2 ring-maritime-navy ring-opacity-50' : ''\n      }`}\n      data-testid={`vessel-card-${vessel.id}`}\n    >\n      <CardContent className=\"p-6\">\n        {/* Drag Handle - Only visible for admins */}\n        {isAdmin && (\n          <div \n            className=\"flex justify-end mb-2 cursor-grab active:cursor-grabbing\"\n            {...attributes}\n            {...listeners}\n          >\n            <GripVertical className=\"h-4 w-4 text-muted-foreground hover:text-foreground transition-colors\" />\n          </div>\n        )}\n        \n        {/* Vessel Header */}\n        <div className=\"flex items-start justify-between mb-4\">\n          <div className=\"flex items-center space-x-3\">\n            <div className=\"p-2 bg-muted rounded-lg group-hover:bg-accent transition-colors\">\n              {getVesselIcon(vessel.type)}\n            </div>\n            <div>\n              <h4 className=\"font-semibold text-foreground mb-1\" data-testid={`vessel-name-${vessel.id}`}>\n                {vessel.name}\n              </h4>\n              <p className=\"text-sm text-muted-foreground\">{vessel.type}</p>\n            </div>\n          </div>\n          <Badge className={getStatusColor(vessel.status)}>\n            {formatStatus(vessel.status)}\n          </Badge>\n        </div>\n\n        {/* Vessel Details */}\n        <div className=\"space-y-3\">\n          {/* Flag and IMO */}\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-2 text-sm text-secondary-foreground\">\n              <Flag className=\"h-3 w-3\" />\n              <span>{vessel.flag}</span>\n            </div>\n            {vessel.imoNumber && (\n              <div className=\"flex items-center space-x-2 text-sm text-secondary-foreground\">\n                <Hash className=\"h-3 w-3\" />\n                <span className=\"font-mono text-xs\">{vessel.imoNumber}</span>\n              </div>\n            )}\n          </div>\n\n          {/* Crew Count */}\n          <div className=\"flex items-center space-x-2 text-sm text-secondary-foreground\">\n            <Users className=\"h-3 w-3\" />\n            <span>\n              {vessel.crewCount || 0} Crew On Board\n            </span>\n          </div>\n\n          {/* Status Badges - Contract status for Fleet Management, Crew stats for Dashboard */}\n          {showUploadButton ? (\n            <ContractStatusBadges vesselId={vessel.id} />\n          ) : (\n            <CrewStatsBadges vesselId={vessel.id} />\n          )}\n\n          {/* Action Buttons */}\n          <div className=\"pt-3 border-t border-border\">\n            <div className={`grid ${showUploadButton ? 'grid-cols-3' : 'grid-cols-2'} gap-2`}>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                className=\"text-xs\"\n                onClick={() => onViewDetails(vessel)}\n                data-testid={`view-vessel-${vessel.id}`}\n              >\n                <Ship className=\"h-3 w-3 mr-1\" />\n                {showUploadButton ? 'Details' : 'View Details'}\n              </Button>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                className=\"text-xs\"\n                onClick={() => onManageCrew(vessel)}\n                data-testid={`manage-crew-${vessel.id}`}\n              >\n                <Users className=\"h-3 w-3 mr-1\" />\n                {showUploadButton ? 'Crew' : 'View Crew'}\n              </Button>\n              {showUploadButton && (\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  className=\"text-xs\"\n                  onClick={() => onUploadDocument(vessel)}\n                  data-testid={`upload-document-${vessel.id}`}\n                >\n                  <FileText className=\"h-3 w-3 mr-1\" />\n                  Upload\n                </Button>\n              )}\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default function VesselCards({ showUploadButton = true }: { showUploadButton?: boolean }) {\n  const { user } = useAuth();\n  const [statusFilter, setStatusFilter] = useState<string>('all');\n  const [searchQuery, setSearchQuery] = useState('');\n  const [showAddVesselForm, setShowAddVesselForm] = useState(false);\n  const [selectedVesselForDetails, setSelectedVesselForDetails] = useState<VesselWithDetails | null>(null);\n  const [selectedVesselForCrew, setSelectedVesselForCrew] = useState<VesselWithDetails | null>(null);\n  const [selectedVesselForUpload, setSelectedVesselForUpload] = useState<VesselWithDetails | null>(null);\n  const [vesselOrder, setVesselOrder] = useState<string[]>([]);\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Drag and drop sensors\n  const sensors = useSensors(\n    useSensor(PointerSensor),\n    useSensor(KeyboardSensor, {\n      coordinateGetter: sortableKeyboardCoordinates,\n    })\n  );\n\n  // Remove debug logging since it's working\n\n  const { data: vessels, isLoading } = useQuery<VesselWithDetails[]>({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  // Fetch crew data for export\n  const { data: crewMembers } = useQuery({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', { headers: getAuthHeaders() });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n  });\n\n  // Fetch contracts data for export\n  const { data: contracts } = useQuery({\n    queryKey: ['/api/contracts'],\n    queryFn: async () => {\n      const response = await fetch('/api/contracts', { headers: getAuthHeaders() });\n      if (!response.ok) throw new Error('Failed to fetch contracts');\n      return response.json();\n    },\n  });\n\n  // Fetch documents data for export\n  const { data: documents } = useQuery({\n    queryKey: ['/api/documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/documents', { headers: getAuthHeaders() });\n      if (!response.ok) throw new Error('Failed to fetch documents');\n      return response.json();\n    },\n  });\n\n  // Fetch rotations data for export\n  const { data: rotations } = useQuery({\n    queryKey: ['/api/rotations'],\n    queryFn: async () => {\n      const response = await fetch('/api/rotations', { headers: getAuthHeaders() });\n      if (!response.ok) throw new Error('Failed to fetch rotations');\n      return response.json();\n    },\n  });\n\n  // Update vessel order mutation\n  const updateOrderMutation = useMutation({\n    mutationFn: async (vesselIds: string[]) => {\n      const response = await apiRequest('PUT', '/api/vessels/order', {\n        vesselIds\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      toast({\n        title: 'Success',\n        description: 'Vessel order updated successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to update vessel order',\n        variant: 'destructive',\n      });\n      // Reset to original order on error\n      if (vessels) {\n        setVesselOrder(vessels.map(v => v.id));\n      }\n    },\n  });\n\n  // Handle drag end\n  const handleDragEnd = (event: DragEndEvent) => {\n    const { active, over } = event;\n\n    if (active.id !== over?.id) {\n      const oldIndex = vesselOrder.indexOf(active.id as string);\n      const newIndex = vesselOrder.indexOf(over?.id as string);\n\n      const newOrder = arrayMove(vesselOrder, oldIndex, newIndex);\n      setVesselOrder(newOrder);\n      \n      // Only admin can reorder\n      if (user?.role === 'admin') {\n        updateOrderMutation.mutate(newOrder);\n      }\n    }\n  };\n\n  // Initialize and maintain vessel order\n  const orderedVessels = useMemo(() => {\n    if (!vessels) return [];\n\n    // Initialize vessel order if not set\n    if (vesselOrder.length === 0) {\n      const initialOrder = vessels.map(v => v.id);\n      setVesselOrder(initialOrder);\n      return vessels;\n    }\n\n    // Sort vessels according to the current order\n    return vesselOrder\n      .map(id => vessels.find(v => v.id === id))\n      .filter(Boolean) as VesselWithDetails[];\n  }, [vessels, vesselOrder]);\n\n  // Filter and search vessels\n  const filteredVessels = useMemo(() => {\n    if (!orderedVessels) return [];\n    \n    return orderedVessels.filter(vessel => {\n      const matchesStatus = statusFilter === 'all' || vessel.status === statusFilter;\n      const matchesSearch = !searchQuery || \n        vessel.name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        vessel.imoNumber?.toLowerCase().includes(searchQuery.toLowerCase());\n      \n      return matchesStatus && matchesSearch;\n    });\n  }, [orderedVessels, statusFilter, searchQuery]);\n\n  const getStatusBadge = (status: string) => {\n    const statusConfig = {\n      'harbour-mining': { color: 'bg-compliance-green', label: 'Harbour Mining' },\n      'coastal-mining': { color: 'bg-ocean-blue', label: 'Coastal Mining' },\n      'world-wide': { color: 'bg-maritime-navy', label: 'World Wide (Foreign Going)' },\n      'oil-field': { color: 'bg-warning-amber', label: 'Oil Field' },\n      'line-up-mining': { color: 'bg-gray-500', label: 'Laid Up' },\n    };\n    \n    const config = statusConfig[status as keyof typeof statusConfig] || statusConfig['harbour-mining'];\n    return (\n      <Badge className={`${config.color} text-white`}>\n        {config.label}\n      </Badge>\n    );\n  };\n\n  const getVesselIcon = (type: string) => {\n    // Return ship icon for all types for now\n    return <Ship className=\"h-8 w-8 text-primary\" />;\n  };\n\n  const handleExportVessels = () => {\n    try {\n      if (!vessels || vessels.length === 0) {\n        toast({ title: 'No Data', description: 'No vessels found to export', variant: 'destructive' });\n        return;\n      }\n\n      const workbook = XLSX.utils.book_new();\n\n      // Group crew by vessel\n      const vesselGroups: { [key: string]: any[] } = {};\n      const unassignedCrew: any[] = [];\n      vessels.forEach((vessel: any) => { vesselGroups[vessel.id] = []; });\n      (crewMembers || []).forEach((member: any) => {\n        if (member.currentVesselId && vesselGroups[member.currentVesselId]) {\n          vesselGroups[member.currentVesselId].push(member);\n        } else {\n          unassignedCrew.push(member);\n        }\n      });\n\n      // Helper to get document number\n      const getDocumentNumber = (crewMemberId: string, docType: string) => {\n        if (!documents) return '---';\n        const doc = (documents as any[]).find((d: any) => d.crewMemberId === crewMemberId && d.type?.toLowerCase() === docType.toLowerCase());\n        return doc?.documentNumber || '---';\n      };\n\n      // Process crew member with all details\n      const processCrewMember = (member: any) => {\n        const activeContract = member.activeContract;\n        let contractEndDate = '---', daysToContractEnd = '---';\n        if (activeContract?.endDate) {\n          contractEndDate = format(new Date(activeContract.endDate), 'yyyy-MM-dd');\n          const diffDays = Math.ceil((new Date(activeContract.endDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));\n          daysToContractEnd = diffDays.toString();\n        }\n        let phoneNumber = member.phoneNumber || member.phone || '---';\n        let nextOfKin = '---';\n        if (member.emergencyContact?.name) {\n          const rel = member.emergencyContact.relationship ? ` (${member.emergencyContact.relationship})` : '';\n          const ph = member.emergencyContact.phone ? ` - ${member.emergencyContact.phone}` : '';\n          nextOfKin = `${member.emergencyContact.name}${rel}${ph}`;\n        }\n        return {\n          'Full Name': `${member.firstName} ${member.lastName}`, 'Rank/Position': member.rank || '---',\n          'Nationality': member.nationality || '---', 'Date of Birth': member.dateOfBirth ? format(new Date(member.dateOfBirth), 'yyyy-MM-dd') : '---',\n          'Phone Number': phoneNumber, 'Email': member.email || '---',\n          'Passport No': getDocumentNumber(member.id, 'passport'), 'CDC No': getDocumentNumber(member.id, 'cdc'),\n          'COC No': getDocumentNumber(member.id, 'stcw'), 'Medical Cert No': getDocumentNumber(member.id, 'medical'),\n          'Next of Kin': nextOfKin, 'Employment Status': member.status || '---',\n          'Join Date': member.createdAt ? format(new Date(member.createdAt), 'yyyy-MM-dd') : '---',\n          'Contract End Date': contractEndDate, 'Days to Contract End': daysToContractEnd\n        };\n      };\n\n      const emptyRow = { 'Full Name': '', 'Rank/Position': '', 'Nationality': '', 'Date of Birth': '', 'Phone Number': '', 'Email': '', 'Passport No': '', 'CDC No': '', 'COC No': '', 'Medical Cert No': '', 'Next of Kin': '', 'Employment Status': '', 'Join Date': '', 'Contract End Date': '', 'Days to Contract End': '' };\n      const colWidths = [{ wch: 22 }, { wch: 18 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 22 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 18 }];\n\n      // Create vessel sheets\n      vessels.forEach((vessel: any) => {\n        const vesselCrew = vesselGroups[vessel.id] || [];\n        const worksheetData: any[] = [\n          { ...emptyRow, 'Full Name': `VESSEL: ${vessel.name}` },\n          { ...emptyRow, 'Full Name': `Type: ${vessel.type || '---'}`, 'Rank/Position': `IMO: ${vessel.imoNumber || '---'}`, 'Nationality': `Flag: ${vessel.flag || '---'}`, 'Date of Birth': `Status: ${vessel.status || '---'}` },\n          { ...emptyRow }\n        ];\n        if (vesselCrew.length === 0) {\n          worksheetData.push({ ...emptyRow, 'Full Name': 'No crew members assigned' });\n        } else {\n          vesselCrew.forEach((member: any) => worksheetData.push(processCrewMember(member)));\n          worksheetData.push({ ...emptyRow }, { ...emptyRow, 'Full Name': 'VESSEL SUMMARY', 'Rank/Position': `Total: ${vesselCrew.length}` });\n        }\n        const ws = XLSX.utils.json_to_sheet(worksheetData);\n        ws['!cols'] = colWidths;\n        XLSX.utils.book_append_sheet(workbook, ws, vessel.name.replace(/[\\\\\\/\\?\\*\\[\\]]/g, '_').substring(0, 31));\n      });\n\n      // Unassigned crew sheet\n      if (unassignedCrew.length > 0) {\n        const unassignedData = [{ ...emptyRow, 'Full Name': 'UNASSIGNED CREW MEMBERS' }, { ...emptyRow, 'Full Name': `Total: ${unassignedCrew.length}` }, { ...emptyRow }];\n        unassignedCrew.forEach((m: any) => unassignedData.push(processCrewMember(m)));\n        const uws = XLSX.utils.json_to_sheet(unassignedData);\n        uws['!cols'] = colWidths;\n        XLSX.utils.book_append_sheet(workbook, uws, 'Unassigned Crew');\n      }\n\n      // Contracts sheet\n      if (contracts && (contracts as any[]).length > 0) {\n        const contractsData = (contracts as any[]).map((c: any) => {\n          const crew = (crewMembers as any[])?.find((m: any) => m.id === c.crewMemberId);\n          const vessel = vessels.find((v: any) => v.id === c.vesselId);\n          return { 'Crew Member': crew ? `${crew.firstName} ${crew.lastName}` : '---', 'Vessel': vessel?.name || '---', 'Start Date': c.startDate ? format(new Date(c.startDate), 'yyyy-MM-dd') : '---', 'End Date': c.endDate ? format(new Date(c.endDate), 'yyyy-MM-dd') : '---', 'Duration (Days)': c.durationDays || '---', 'Salary': c.salary || '---', 'Currency': c.currency || 'USD', 'Status': c.status || '---' };\n        });\n        const cws = XLSX.utils.json_to_sheet(contractsData);\n        cws['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 10 }, { wch: 12 }];\n        XLSX.utils.book_append_sheet(workbook, cws, 'All Contracts');\n      }\n\n      // Documents sheet\n      if (documents && (documents as any[]).length > 0) {\n        const docsData = (documents as any[]).map((d: any) => {\n          const crew = (crewMembers as any[])?.find((m: any) => m.id === d.crewMemberId);\n          return { 'Crew Member': crew ? `${crew.firstName} ${crew.lastName}` : '---', 'Document Type': d.type || '---', 'Document Number': d.documentNumber || '---', 'Issue Date': d.issueDate ? format(new Date(d.issueDate), 'yyyy-MM-dd') : '---', 'Expiry Date': d.expiryDate ? format(new Date(d.expiryDate), 'yyyy-MM-dd') : '---', 'Issuing Authority': d.issuingAuthority || '---', 'Status': d.status || '---' };\n        });\n        const dws = XLSX.utils.json_to_sheet(docsData);\n        dws['!cols'] = [{ wch: 25 }, { wch: 15 }, { wch: 18 }, { wch: 12 }, { wch: 12 }, { wch: 20 }, { wch: 12 }];\n        XLSX.utils.book_append_sheet(workbook, dws, 'All Documents');\n      }\n\n      // Rotations sheet\n      if (rotations && (rotations as any[]).length > 0) {\n        const rotData = (rotations as any[]).map((r: any) => {\n          const crew = (crewMembers as any[])?.find((m: any) => m.id === r.crewMemberId);\n          const vessel = vessels.find((v: any) => v.id === r.vesselId);\n          return { 'Crew Member': crew ? `${crew.firstName} ${crew.lastName}` : '---', 'Vessel': vessel?.name || '---', 'Join Date': r.joinDate ? format(new Date(r.joinDate), 'yyyy-MM-dd') : '---', 'Leave Date': r.leaveDate ? format(new Date(r.leaveDate), 'yyyy-MM-dd') : '---', 'Rotation Type': r.rotationType || '---', 'Status': r.status || '---', 'Notes': r.notes || '---' };\n        });\n        const rws = XLSX.utils.json_to_sheet(rotData);\n        rws['!cols'] = [{ wch: 25 }, { wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 30 }];\n        XLSX.utils.book_append_sheet(workbook, rws, 'Crew Rotations');\n      }\n\n      // Vessel Details sheet\n      const vesselsData = vessels.map((v: any) => {\n        const vc = vesselGroups[v.id] || [];\n        return { 'Vessel Name': v.name, 'Type': v.type || '---', 'IMO Number': v.imoNumber || '---', 'Flag': v.flag || '---', 'Status': v.status || '---', 'Total Crew': vc.length, 'On Board': vc.filter((c: any) => c.status === 'onBoard').length, 'On Shore': vc.filter((c: any) => c.status === 'onShore').length };\n      });\n      const vws = XLSX.utils.json_to_sheet(vesselsData);\n      vws['!cols'] = [{ wch: 25 }, { wch: 18 }, { wch: 15 }, { wch: 15 }, { wch: 18 }, { wch: 12 }, { wch: 12 }, { wch: 12 }];\n      XLSX.utils.book_append_sheet(workbook, vws, 'Vessel Details');\n\n      // Summary sheet\n      const summaryData = [\n        { Field: 'COMPREHENSIVE DATA EXPORT REPORT', Value: '' },\n        { Field: 'Generated on', Value: format(new Date(), 'MMMM dd, yyyy at HH:mm') },\n        { Field: '', Value: '' },\n        { Field: 'Total Crew Members', Value: crewMembers?.length || 0 },\n        { Field: 'Total Vessels', Value: vessels.length },\n        { Field: 'Total Contracts', Value: (contracts as any[])?.length || 0 },\n        { Field: 'Total Documents', Value: (documents as any[])?.length || 0 },\n        { Field: 'Total Rotations', Value: (rotations as any[])?.length || 0 },\n      ];\n      const sws = XLSX.utils.json_to_sheet(summaryData);\n      sws['!cols'] = [{ wch: 30 }, { wch: 40 }];\n\n      // Reorder with summary first\n      const tempWb = XLSX.utils.book_new();\n      XLSX.utils.book_append_sheet(tempWb, sws, 'Summary');\n      workbook.SheetNames.forEach(name => XLSX.utils.book_append_sheet(tempWb, workbook.Sheets[name], name));\n      Object.assign(workbook, tempWb);\n\n      const buffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });\n      const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `Crew-Management-Complete-Export-${format(new Date(), 'yyyy-MM-dd-HHmm')}.xlsx`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n\n      toast({ title: 'Export Successful', description: `Complete data exported: ${crewMembers?.length || 0} crew, ${vessels.length} vessels` });\n    } catch (error) {\n      console.error('Export error:', error);\n      toast({ title: 'Export Failed', description: 'Unable to export data. Please try again.', variant: 'destructive' });\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"h-6 bg-muted rounded w-48 animate-pulse\"></div>\n          <div className=\"flex space-x-2\">\n            <div className=\"h-9 bg-muted rounded w-32 animate-pulse\"></div>\n            <div className=\"h-9 bg-muted rounded w-24 animate-pulse\"></div>\n          </div>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          {Array(6).fill(0).map((_, i) => (\n            <div key={i} className=\"h-48 bg-muted rounded-lg animate-pulse\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Section Header */}\n      <div className=\"flex items-center justify-between\">\n        <h3 className=\"text-lg font-semibold text-foreground\">Vessel Overview</h3>\n        <div className=\"flex items-center space-x-2\">\n          {user?.role === 'admin' && (\n            <Button \n              className=\"bg-maritime-navy hover:bg-blue-800\" \n              size=\"sm\"\n              onClick={() => setShowAddVesselForm(true)}\n              data-testid=\"add-vessel-button\"\n            >\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add Vessel\n            </Button>\n          )}\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            onClick={handleExportVessels}\n            data-testid=\"export-vessels-button\"\n          >\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export\n          </Button>\n        </div>\n      </div>\n\n      {/* Filters and Search */}\n      <div className=\"flex flex-col sm:flex-row gap-4\">\n        <div className=\"relative flex-1 max-w-sm\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search vessels by name or IMO...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-10\"\n            data-testid=\"vessel-search-input\"\n          />\n        </div>\n        <Select value={statusFilter} onValueChange={setStatusFilter}>\n          <SelectTrigger className=\"w-48\" data-testid=\"vessel-status-filter\">\n            <SelectValue placeholder=\"Filter by status\" />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">All Status</SelectItem>\n            <SelectItem value=\"harbour-mining\">Harbour Mining</SelectItem>\n            <SelectItem value=\"coastal-mining\">Coastal Mining</SelectItem>\n            <SelectItem value=\"world-wide\">World Wide (Foreign Going)</SelectItem>\n            <SelectItem value=\"oil-field\">Oil Field</SelectItem>\n            <SelectItem value=\"line-up-mining\">Laid Up</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Vessel Cards Grid with Drag and Drop */}\n      <DndContext\n        sensors={sensors}\n        collisionDetection={closestCenter}\n        onDragEnd={handleDragEnd}\n      >\n        <SortableContext items={filteredVessels.map(v => v.id)} strategy={rectSortingStrategy}>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {filteredVessels.map((vessel) => (\n              <SortableVesselCard\n                key={vessel.id}\n                vessel={vessel}\n                onViewDetails={setSelectedVesselForDetails}\n                onManageCrew={setSelectedVesselForCrew}\n                onUploadDocument={setSelectedVesselForUpload}\n                isAdmin={user?.role === 'admin'}\n                showUploadButton={showUploadButton}\n              />\n            ))}\n          </div>\n        </SortableContext>\n      </DndContext>\n\n      {/* Empty State */}\n      {filteredVessels && filteredVessels.length === 0 && (\n        <div className=\"text-center py-12\">\n          <Ship className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n          <h3 className=\"text-lg font-medium text-foreground mb-2\">No vessels found</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            {searchQuery || statusFilter !== 'all' \n              ? 'Try adjusting your search or filter criteria.'\n              : 'No vessels have been added to the system yet.'\n            }\n          </p>\n          {user?.role === 'admin' && !searchQuery && statusFilter === 'all' && (\n            <Button className=\"bg-maritime-navy hover:bg-blue-800\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Add First Vessel\n            </Button>\n          )}\n        </div>\n      )}\n\n      {/* Add Vessel Form Dialog */}\n      <AddVesselForm \n        open={showAddVesselForm} \n        onOpenChange={setShowAddVesselForm} \n      />\n\n      {/* Vessel Details Dialog - Use simple dialog for dashboard */}\n      {showUploadButton ? (\n        <VesselDetailsDialog\n          vessel={selectedVesselForDetails}\n          open={!!selectedVesselForDetails}\n          onOpenChange={(open) => !open && setSelectedVesselForDetails(null)}\n          onManageCrew={(vessel) => {\n            setSelectedVesselForDetails(null);\n            setSelectedVesselForCrew(vessel);\n          }}\n        />\n      ) : (\n        <SimpleVesselDetailsDialog\n          vessel={selectedVesselForDetails}\n          open={!!selectedVesselForDetails}\n          onOpenChange={(open) => !open && setSelectedVesselForDetails(null)}\n          onManageCrew={(vessel) => {\n            setSelectedVesselForDetails(null);\n            setSelectedVesselForCrew(vessel);\n          }}\n        />\n      )}\n\n      {/* Crew Management Dialog */}\n      <CrewManagementDialog\n        vessel={selectedVesselForCrew}\n        open={!!selectedVesselForCrew}\n        onOpenChange={(open) => !open && setSelectedVesselForCrew(null)}\n      />\n\n      {/* Document Upload Modal */}\n      {selectedVesselForUpload && (\n        <VesselDocumentUploadModal\n          vesselId={selectedVesselForUpload.id}\n          vesselName={selectedVesselForUpload.name}\n          open={!!selectedVesselForUpload}\n          onClose={() => setSelectedVesselForUpload(null)}\n        />\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":30210,"size_tokens":null},"server/services/sendgrid-email-service.ts":{"content":"import { MailService } from '@sendgrid/mail';\n\n// Type definitions for notification data\nexport interface CrewNotificationData {\n  crewName: string;\n  vesselName?: string;\n  alertType: 'contract_expiry' | 'document_expiry' | 'crew_rotation';\n  daysUntilExpiry: number;\n  contractEndDate?: Date;\n  documentType?: string;\n  documentExpiryDate?: Date;\n}\n\n// SendGrid Email Service - Using your API key for real email delivery\nexport class SendGridEmailService {\n  private mailService: MailService;\n\n  constructor() {\n    this.mailService = new MailService();\n    \n    // Use the SendGrid API key from environment (stored in your app secrets)  \n    const apiKey = process.env.SendGrid || process.env.SENDGRID_API_KEY;\n    if (!apiKey) {\n      console.error(\"‚ùå Missing SendGrid API key in environment\");\n      throw new Error(\"SendGrid API key not found in environment variables\");\n    }\n    \n    this.mailService.setApiKey(apiKey);\n    console.log('üîë SendGrid API key configured successfully');\n    console.log('‚úÖ SendGrid email service ready for real email delivery');\n  }\n\n  async sendEmail(emailData: {\n    to: string;\n    subject: string;\n    html: string;\n    text?: string;\n  }): Promise<{ success: boolean; error?: string }> {\n    try {\n      console.log(`üìß Sending real email via SendGrid to: ${emailData.to}`);\n      console.log(`üìß Subject: ${emailData.subject}`);\n      \n      const fromEmail = process.env.SENDGRID_FROM_EMAIL || 'admin@offing.biz';\n      \n      const result = await this.mailService.send({\n        to: emailData.to,\n        from: fromEmail, // Using configurable verified sender\n        subject: emailData.subject,\n        html: emailData.html,\n        text: emailData.text || emailData.html.replace(/<[^>]*>/g, '') // Strip HTML for text version\n      });\n      \n      console.log('‚úÖ Real email sent successfully via SendGrid!');\n      console.log('üìß Message ID:', result[0]?.headers?.['x-message-id']);\n      console.log('üéØ Email delivered to actual inbox:', emailData.to);\n      \n      return { success: true };\n    } catch (error) {\n      console.error('‚ùå Failed to send email via SendGrid:', error);\n      let errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      if (error instanceof Error && 'response' in error) {\n        const sgError = error as any;\n        if (sgError.response?.body) {\n          console.error('SendGrid error details:', sgError.response.body);\n          errorMessage = sgError.response.body?.errors?.[0]?.message || errorMessage;\n        }\n      }\n      return { success: false, error: errorMessage };\n    }\n  }\n\n  async sendTestEmail(recipientEmail: string): Promise<{ success: boolean; error?: string }> {\n    const testEmailHtml = `\n      <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n        <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n          <div style=\"text-align: center; margin-bottom: 30px;\">\n            <h1 style=\"color: #28a745; margin: 0; font-size: 24px;\">üöÄ SendGrid Email Working!</h1>\n            <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Crew Management System - Real Email Delivery</p>\n          </div>\n          \n          <div style=\"background: #e8f5e8; border-left: 4px solid #28a745; padding: 20px; margin: 20px 0;\">\n            <h3 style=\"margin: 0 0 15px 0; color: #155724;\">‚úÖ Real Email System Active</h3>\n            <p style=\"margin: 0; color: #155724;\">\n              Your crew management system is now sending <strong>real emails</strong> via SendGrid to:\n            </p>\n            <ul style=\"margin: 10px 0 0 20px; color: #155724;\">\n              <li>‚úâÔ∏è Contract renewals and expirations</li>\n              <li>üìã Document expiry reminders</li>\n              <li>üö¢ Crew rotation schedules</li>\n              <li>‚ö†Ô∏è System alerts and notifications</li>\n            </ul>\n          </div>\n          \n          <div style=\"background: #f8f9fa; padding: 20px; border-radius: 6px; margin: 20px 0;\">\n            <h3 style=\"margin: 0 0 10px 0; color: #495057;\">üìã System Status</h3>\n            <p style=\"margin: 0; color: #6c757d; font-size: 14px;\">\n              ‚úÖ Email service: <strong>SendGrid (Real Delivery)</strong><br>\n              ‚úÖ Recipient: <strong>${recipientEmail}</strong><br>\n              ‚úÖ Templates: <strong>Professional HTML + Text</strong><br>\n              ‚úÖ Scheduler: <strong>Running every hour</strong><br>\n              ‚úÖ API Key: <strong>Active & Configured</strong>\n            </p>\n          </div>\n          \n          <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;\">\n            <p style=\"color: #6c757d; font-size: 14px; margin: 0;\">\n              Real email sent via SendGrid at: ${new Date().toLocaleString()}\n            </p>\n            <p style=\"color: #6c757d; font-size: 12px; margin: 5px 0 0 0;\">\n              Check your actual inbox at ${recipientEmail}\n            </p>\n          </div>\n        </div>\n      </div>\n    `;\n\n    return await this.sendEmail({\n      to: recipientEmail,\n      subject: 'üöÄ SendGrid Test - Real Email Delivered!',\n      html: testEmailHtml\n    });\n  }\n\n\n  async sendUpcomingEventsReport(recipientEmail: string, upcomingEvents: any[]): Promise<{ success: boolean; error?: string }> {\n    // Group events by type\n    const contractEvents = upcomingEvents.filter(event => event.type === 'contract');\n    const documentEvents = upcomingEvents.filter(event => event.type === 'document');\n    const vesselDocumentEvents = upcomingEvents.filter(event => event.type === 'vessel_document');\n\n    const formatEventsList = (events: any[]) => {\n      if (events.length === 0) return '<p style=\"color: #6c757d; font-style: italic;\">No upcoming events</p>';\n      \n      return events.map(event => {\n        const urgencyClass = event.daysUntil <= 7 ? 'urgent' : event.daysUntil <= 15 ? 'warning' : 'normal';\n        const urgencyColor = urgencyClass === 'urgent' ? '#dc3545' : urgencyClass === 'warning' ? '#fd7e14' : '#28a745';\n        const urgencyIcon = urgencyClass === 'urgent' ? 'üö®' : urgencyClass === 'warning' ? '‚ö†Ô∏è' : 'üìÖ';\n        \n        return `\n          <div style=\"border-left: 4px solid ${urgencyColor}; padding: 15px; margin: 10px 0; background: ${urgencyClass === 'urgent' ? '#fff5f5' : urgencyClass === 'warning' ? '#fffaf0' : '#f8fff9'};\">\n            <div style=\"font-weight: bold; color: ${urgencyColor};\">\n              ${urgencyIcon} ${event.title}\n            </div>\n            <div style=\"color: #495057; font-size: 14px; margin-top: 5px;\">\n              ${event.description}\n            </div>\n            <div style=\"color: #6c757d; font-size: 12px; margin-top: 8px;\">\n              Due: ${event.date} (${event.daysUntil} days from now)\n            </div>\n          </div>\n        `;\n      }).join('');\n    };\n\n    const emailHtml = `\n      <div style=\"font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n        <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n          <div style=\"text-align: center; margin-bottom: 30px;\">\n            <h1 style=\"color: #007bff; margin: 0; font-size: 24px;\">üìã Upcoming Events Report</h1>\n            <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Crew Management System - ${new Date().toLocaleDateString()}</p>\n          </div>\n          \n          <div style=\"background: #e3f2fd; border-left: 4px solid #007bff; padding: 20px; margin: 20px 0;\">\n            <h3 style=\"margin: 0 0 10px 0; color: #0d47a1;\">üìä Summary</h3>\n            <p style=\"margin: 0; color: #0d47a1;\">\n              Total upcoming events: <strong>${upcomingEvents.length}</strong><br>\n              Contract renewals: <strong>${contractEvents.length}</strong><br>\n              Document expirations: <strong>${documentEvents.length}</strong><br>\n              Vessel document expirations: <strong>${vesselDocumentEvents.length}</strong>\n            </p>\n          </div>\n          \n          <!-- Contract Events -->\n          <div style=\"margin: 30px 0;\">\n            <h3 style=\"color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 10px;\">\n              üìù Contract Renewals (${contractEvents.length})\n            </h3>\n            ${formatEventsList(contractEvents)}\n          </div>\n          \n          <!-- Document Events -->\n          <div style=\"margin: 30px 0;\">\n            <h3 style=\"color: #495057; border-bottom: 2px solid #fd7e14; padding-bottom: 10px;\">\n              üìÑ Document Expirations (${documentEvents.length})\n            </h3>\n            ${formatEventsList(documentEvents)}\n          </div>\n          \n          <!-- Vessel Document Events -->\n          <div style=\"margin: 30px 0;\">\n            <h3 style=\"color: #495057; border-bottom: 2px solid #28a745; padding-bottom: 10px;\">\n              üö¢ Vessel Document Expirations (${vesselDocumentEvents.length})\n            </h3>\n            ${formatEventsList(vesselDocumentEvents)}\n          </div>\n          \n          <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;\">\n            <p style=\"color: #6c757d; font-size: 14px; margin: 0;\">\n              Report generated: ${new Date().toLocaleString()}\n            </p>\n            <p style=\"color: #6c757d; font-size: 12px; margin: 5px 0 0 0;\">\n              Crew Management Pro - Automated Notification System\n            </p>\n          </div>\n        </div>\n      </div>\n    `;\n\n    return await this.sendEmail({\n      to: recipientEmail,\n      subject: `üìã Upcoming Events Report - ${upcomingEvents.length} Events (${new Date().toLocaleDateString()})`,\n      html: emailHtml\n    });\n  }\n}\n\n// Create singleton instance\nexport const sendGridEmailService = new SendGridEmailService();\n\n// Export the send function for backward compatibility with notification service\nexport async function sendEmail(emailParams: {\n  to: string;\n  from?: string;\n  subject: string;\n  html: string;\n  text?: string;\n}): Promise<{ success: boolean; error?: string }> {\n  return await sendGridEmailService.sendEmail({\n    to: emailParams.to,\n    subject: emailParams.subject,\n    html: emailParams.html,\n    text: emailParams.text\n  });\n}\n\n// Export simple function for direct use\nexport async function sendNotificationEmail(recipientEmail: string, subject: string, htmlContent: string): Promise<{ success: boolean; error?: string }> {\n  return await sendGridEmailService.sendEmail({\n    to: recipientEmail,\n    subject: subject,\n    html: htmlContent\n  });\n}\n\n// Email template generators\nexport function generateContractExpiryEmail(data: CrewNotificationData): { subject: string; html: string; text: string } {\n  const urgencyColor = data.daysUntilExpiry <= 7 ? '#dc3545' : data.daysUntilExpiry <= 15 ? '#fd7e14' : '#28a745';\n  const urgencyIcon = data.daysUntilExpiry <= 7 ? 'üö®' : data.daysUntilExpiry <= 15 ? '‚ö†Ô∏è' : 'üìÖ';\n  const urgencyText = data.daysUntilExpiry <= 7 ? 'URGENT' : data.daysUntilExpiry <= 15 ? 'WARNING' : 'NOTICE';\n\n  const subject = `${urgencyIcon} Contract Expiry ${urgencyText} - ${data.crewName} (${data.daysUntilExpiry} days)`;\n\n  const html = `\n    <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n      <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n        <div style=\"text-align: center; margin-bottom: 30px;\">\n          <h1 style=\"color: ${urgencyColor}; margin: 0; font-size: 24px;\">${urgencyIcon} Contract Expiry Alert</h1>\n          <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Crew Management System - ${urgencyText}</p>\n        </div>\n        \n        <div style=\"background: ${data.daysUntilExpiry <= 7 ? '#fff5f5' : data.daysUntilExpiry <= 15 ? '#fffaf0' : '#f8fff9'}; border-left: 4px solid ${urgencyColor}; padding: 20px; margin: 20px 0;\">\n          <h3 style=\"margin: 0 0 15px 0; color: ${urgencyColor};\">${urgencyIcon} Contract Renewal Required</h3>\n          <p style=\"margin: 0; color: #495057;\">\n            <strong>Crew Member:</strong> ${data.crewName}<br>\n            ${data.vesselName ? `<strong>Vessel:</strong> ${data.vesselName}<br>` : ''}\n            <strong>Contract End Date:</strong> ${data.contractEndDate?.toLocaleDateString()}<br>\n            <strong>Days Remaining:</strong> ${data.daysUntilExpiry} days\n          </p>\n        </div>\n        \n        <div style=\"background: #e3f2fd; padding: 20px; border-radius: 6px; margin: 20px 0;\">\n          <h3 style=\"margin: 0 0 10px 0; color: #0d47a1;\">üìã Action Required</h3>\n          <p style=\"margin: 0; color: #0d47a1;\">\n            Please review and renew this contract before expiry to ensure continued crew assignment.\n          </p>\n        </div>\n        \n        <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;\">\n          <p style=\"color: #6c757d; font-size: 14px; margin: 0;\">\n            This is an automated notification from your Crew Management System\n          </p>\n          <p style=\"color: #6c757d; font-size: 12px; margin: 5px 0 0 0;\">\n            Sent: ${new Date().toLocaleString()}\n          </p>\n        </div>\n      </div>\n    </div>\n  `;\n\n  const text = `\nCONTRACT EXPIRY ALERT - ${urgencyText}\n\nCrew Member: ${data.crewName}\n${data.vesselName ? `Vessel: ${data.vesselName}\\n` : ''}Contract End Date: ${data.contractEndDate?.toLocaleDateString()}\nDays Remaining: ${data.daysUntilExpiry} days\n\nACTION REQUIRED: Please review and renew this contract before expiry to ensure continued crew assignment.\n\nThis is an automated notification from your Crew Management System.\nSent: ${new Date().toLocaleString()}\n  `;\n\n  return { subject, html, text };\n}\n\nexport function generateDocumentExpiryEmail(data: CrewNotificationData): { subject: string; html: string; text: string } {\n  const urgencyColor = data.daysUntilExpiry <= 7 ? '#dc3545' : data.daysUntilExpiry <= 15 ? '#fd7e14' : '#28a745';\n  const urgencyIcon = data.daysUntilExpiry <= 7 ? 'üö®' : data.daysUntilExpiry <= 15 ? '‚ö†Ô∏è' : 'üìÖ';\n  const urgencyText = data.daysUntilExpiry <= 7 ? 'URGENT' : data.daysUntilExpiry <= 15 ? 'WARNING' : 'NOTICE';\n\n  const subject = `${urgencyIcon} Document Expiry ${urgencyText} - ${data.crewName} ${data.documentType} (${data.daysUntilExpiry} days)`;\n\n  const html = `\n    <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n      <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n        <div style=\"text-align: center; margin-bottom: 30px;\">\n          <h1 style=\"color: ${urgencyColor}; margin: 0; font-size: 24px;\">${urgencyIcon} Document Expiry Alert</h1>\n          <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Crew Management System - ${urgencyText}</p>\n        </div>\n        \n        <div style=\"background: ${data.daysUntilExpiry <= 7 ? '#fff5f5' : data.daysUntilExpiry <= 15 ? '#fffaf0' : '#f8fff9'}; border-left: 4px solid ${urgencyColor}; padding: 20px; margin: 20px 0;\">\n          <h3 style=\"margin: 0 0 15px 0; color: ${urgencyColor};\">${urgencyIcon} Document Renewal Required</h3>\n          <p style=\"margin: 0; color: #495057;\">\n            <strong>Crew Member:</strong> ${data.crewName}<br>\n            <strong>Document Type:</strong> ${data.documentType?.toUpperCase()}<br>\n            <strong>Expiry Date:</strong> ${data.documentExpiryDate?.toLocaleDateString()}<br>\n            <strong>Days Remaining:</strong> ${data.daysUntilExpiry} days\n          </p>\n        </div>\n        \n        <div style=\"background: #e3f2fd; padding: 20px; border-radius: 6px; margin: 20px 0;\">\n          <h3 style=\"margin: 0 0 10px 0; color: #0d47a1;\">üìã Action Required</h3>\n          <p style=\"margin: 0; color: #0d47a1;\">\n            Please renew this document before expiry to maintain crew compliance and certification.\n          </p>\n        </div>\n        \n        <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;\">\n          <p style=\"color: #6c757d; font-size: 14px; margin: 0;\">\n            This is an automated notification from your Crew Management System\n          </p>\n          <p style=\"color: #6c757d; font-size: 12px; margin: 5px 0 0 0;\">\n            Sent: ${new Date().toLocaleString()}\n          </p>\n        </div>\n      </div>\n    </div>\n  `;\n\n  const text = `\nDOCUMENT EXPIRY ALERT - ${urgencyText}\n\nCrew Member: ${data.crewName}\nDocument Type: ${data.documentType?.toUpperCase()}\nExpiry Date: ${data.documentExpiryDate?.toLocaleDateString()}\nDays Remaining: ${data.daysUntilExpiry} days\n\nACTION REQUIRED: Please renew this document before expiry to maintain crew compliance and certification.\n\nThis is an automated notification from your Crew Management System.\nSent: ${new Date().toLocaleString()}\n  `;\n\n  return { subject, html, text };\n}","path":null,"size_bytes":17110,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { backgroundScheduler } from \"./services/background-scheduler\";\n\nconst app = express();\napp.use(express.json({ limit: '100mb' })); // Increased limit for OCR image uploads\napp.use(express.urlencoded({ extended: false, limit: '100mb' }));\n\n// Serve uploaded files from the uploads directory\napp.use('/uploads', express.static('uploads'));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"‚Ä¶\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n    \n    // Start the background notification scheduler\n    try {\n      backgroundScheduler.start();\n      log('Background notification scheduler started successfully');\n    } catch (error) {\n      console.error('Failed to start background scheduler:', error);\n    }\n  });\n})();\n","path":null,"size_bytes":2579,"size_tokens":null},"deployment/drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/vessel-documents/vessel-documents-list.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { formatDate } from '@/lib/utils';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { \n  FileText, \n  Download, \n  Trash2, \n  Calendar, \n  User, \n  Globe, \n  Lock,\n  AlertTriangle,\n  Archive\n} from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { VesselDocumentUploadModal } from './vessel-document-upload-modal';\nimport { \n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from '@/components/ui/alert-dialog';\n\ninterface VesselDocument {\n  id: string;\n  vesselId: string;\n  name: string;\n  type: string;\n  description?: string;\n  fileName: string;\n  filePath: string;\n  fileSize?: number;\n  mimeType?: string;\n  uploadedBy: string;\n  uploadedAt: string;\n  expiryDate?: string;\n  isPublic: boolean;\n}\n\ninterface VesselDocumentsListProps {\n  vesselId: string;\n  vesselName: string;\n}\n\nexport function VesselDocumentsList({ vesselId, vesselName }: VesselDocumentsListProps) {\n  const [showUploadModal, setShowUploadModal] = useState(false);\n  const [deleteDocumentId, setDeleteDocumentId] = useState<string | null>(null);\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Fetch vessel documents\n  const { data: documents = [], isLoading } = useQuery({\n    queryKey: [`/api/vessels/${vesselId}/documents`],\n    queryFn: async () => {\n      const response = await fetch(`/api/vessels/${vesselId}/documents`, {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch documents');\n      return response.json();\n    },\n  });\n\n  // Delete document mutation\n  const deleteDocumentMutation = useMutation({\n    mutationFn: async (documentId: string) => {\n      const response = await fetch(`/api/vessel-documents/${documentId}`, {\n        method: 'DELETE',\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.message || 'Failed to delete document');\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Document deleted',\n        description: 'The document has been deleted successfully.',\n      });\n      queryClient.invalidateQueries({ queryKey: [`/api/vessels/${vesselId}/documents`] });\n      setDeleteDocumentId(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Delete failed',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Bulk download mutation\n  const bulkDownloadMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(`/api/vessels/${vesselId}/documents/download-all`, {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to prepare bulk download');\n      return response.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: 'Bulk download prepared',\n        description: `${data.count} documents ready for download.`,\n      });\n      // In a real implementation, this would trigger an actual ZIP download\n    },\n    onError: (error: Error) => {\n      toast({\n        title: 'Bulk download failed',\n        description: error.message,\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleDownload = (documentId: string, fileName: string) => {\n    const link = document.createElement('a');\n    link.href = `/api/vessel-documents/${documentId}/download`;\n    link.download = fileName;\n    link.click();\n  };\n\n  const getDocumentTypeColor = (type: string) => {\n    const colors = {\n      certificate: 'bg-green-100 text-green-800',\n      insurance: 'bg-blue-100 text-blue-800',\n      inspection: 'bg-yellow-100 text-yellow-800',\n      safety: 'bg-red-100 text-red-800',\n      customs: 'bg-purple-100 text-purple-800',\n      other: 'bg-gray-100 text-gray-800',\n    };\n    return colors[type as keyof typeof colors] || colors.other;\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n\n  const isExpiringSoon = (expiryDate: string) => {\n    const expiry = new Date(expiryDate);\n    const now = new Date();\n    const diffTime = expiry.getTime() - now.getTime();\n    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n    return diffDays <= 30 && diffDays > 0;\n  };\n\n  const isExpired = (expiryDate: string) => {\n    return new Date(expiryDate) < new Date();\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center space-x-2\">\n            <FileText className=\"h-5 w-5\" />\n            <span>Documents</span>\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            {[...Array(3)].map((_, i) => (\n              <div key={i} className=\"animate-pulse\">\n                <div className=\"h-20 bg-gray-200 dark:bg-gray-700 rounded\"></div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <>\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"flex items-center space-x-2\">\n              <FileText className=\"h-5 w-5\" />\n              <span>Documents ({documents.length})</span>\n            </CardTitle>\n            <div className=\"flex items-center space-x-2\">\n              {documents.length > 0 && (\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => bulkDownloadMutation.mutate()}\n                  disabled={bulkDownloadMutation.isPending}\n                  data-testid=\"button-bulk-download\"\n                >\n                  <Archive className=\"h-4 w-4 mr-2\" />\n                  Bulk Download\n                </Button>\n              )}\n              <Button\n                onClick={() => setShowUploadModal(true)}\n                size=\"sm\"\n                data-testid=\"button-upload-document\"\n              >\n                <FileText className=\"h-4 w-4 mr-2\" />\n                Upload Document\n              </Button>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {documents.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <FileText className=\"h-16 w-16 text-gray-300 dark:text-gray-600 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium text-gray-900 dark:text-gray-100 mb-2\">\n                No documents uploaded\n              </h3>\n              <p className=\"text-gray-500 dark:text-gray-400 mb-4\">\n                Upload documents for {vesselName} to get started.\n              </p>\n              <Button\n                onClick={() => setShowUploadModal(true)}\n                data-testid=\"button-upload-first-document\"\n              >\n                <FileText className=\"h-4 w-4 mr-2\" />\n                Upload First Document\n              </Button>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {documents.map((document: VesselDocument) => (\n                <div\n                  key={document.id}\n                  className=\"border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors\"\n                >\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center space-x-3 mb-2\">\n                        <h4 className=\"text-sm font-medium text-gray-900 dark:text-gray-100 truncate\">\n                          {document.name}\n                        </h4>\n                        <Badge className={getDocumentTypeColor(document.type)}>\n                          {document.type}\n                        </Badge>\n                        {document.isPublic ? (\n                          <Badge variant=\"outline\" className=\"flex items-center space-x-1\">\n                            <Globe className=\"h-3 w-3\" />\n                            <span>Public</span>\n                          </Badge>\n                        ) : (\n                          <Badge variant=\"outline\" className=\"flex items-center space-x-1\">\n                            <Lock className=\"h-3 w-3\" />\n                            <span>Private</span>\n                          </Badge>\n                        )}\n                      </div>\n\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-xs text-gray-500 dark:text-gray-400 mb-2\">\n                        <div>\n                          <span className=\"font-medium\">File: </span>\n                          {document.fileName}\n                        </div>\n                        {document.fileSize && (\n                          <div>\n                            <span className=\"font-medium\">Size: </span>\n                            {formatFileSize(document.fileSize)}\n                          </div>\n                        )}\n                        <div>\n                          <span className=\"font-medium\">Uploaded: </span>\n                          {formatDate(document.uploadedAt)}\n                        </div>\n                        {document.expiryDate && (\n                          <div className={`flex items-center space-x-1 ${\n                            isExpired(document.expiryDate) ? 'text-red-600' :\n                            isExpiringSoon(document.expiryDate) ? 'text-yellow-600' : ''\n                          }`}>\n                            {(isExpired(document.expiryDate) || isExpiringSoon(document.expiryDate)) && (\n                              <AlertTriangle className=\"h-3 w-3\" />\n                            )}\n                            <span className=\"font-medium\">Expires: </span>\n                            {formatDate(document.expiryDate)}\n                          </div>\n                        )}\n                      </div>\n\n                      {document.description && (\n                        <p className=\"text-xs text-gray-600 dark:text-gray-300 mb-2 line-clamp-2\">\n                          {document.description}\n                        </p>\n                      )}\n                    </div>\n\n                    <div className=\"flex items-center space-x-2 ml-4\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => handleDownload(document.id, document.fileName)}\n                        data-testid={`button-download-${document.id}`}\n                      >\n                        <Download className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setDeleteDocumentId(document.id)}\n                        data-testid={`button-delete-${document.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Upload Modal */}\n      <VesselDocumentUploadModal\n        vesselId={vesselId}\n        vesselName={vesselName}\n        open={showUploadModal}\n        onClose={() => setShowUploadModal(false)}\n      />\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={!!deleteDocumentId} onOpenChange={() => setDeleteDocumentId(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Document</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete this document? This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => deleteDocumentId && deleteDocumentMutation.mutate(deleteDocumentId)}\n              className=\"bg-red-600 hover:bg-red-700\"\n            >\n              Delete\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </>\n  );\n}","path":null,"size_bytes":12856,"size_tokens":null},"client/src/components/vessels/simple-vessel-details-dialog.tsx":{"content":"import { useState } from 'react';\nimport { useQueryClient } from '@tanstack/react-query';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Ship, Users, Flag, Hash, X } from 'lucide-react';\nimport { VesselWithDetails } from './vessel-cards';\nimport EditVesselForm from './edit-vessel-form';\n\ninterface SimpleVesselDetailsDialogProps {\n  vessel: VesselWithDetails | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onManageCrew?: (vessel: VesselWithDetails) => void;\n}\n\nexport default function SimpleVesselDetailsDialog({ \n  vessel, \n  open, \n  onOpenChange, \n  onManageCrew \n}: SimpleVesselDetailsDialogProps) {\n  const [showEditForm, setShowEditForm] = useState(false);\n  const queryClient = useQueryClient();\n\n  if (!vessel) return null;\n\n  const getStatusColor = (status: string) => {\n    switch (status.toLowerCase()) {\n      case 'harbour-mining': return 'bg-gray-600 text-white';\n      case 'coastal-mining': return 'bg-blue-600 text-white';\n      case 'world-wide': return 'bg-purple-600 text-white';\n      case 'oil-field': return 'bg-yellow-600 text-white';\n      case 'line-up-mining': return 'bg-gray-500 text-white';\n      case 'active': return 'bg-green-600 text-white';\n      default: return 'bg-gray-500 text-white';\n    }\n  };\n\n  const formatStatus = (status: string) => {\n    switch (status.toLowerCase()) {\n      case 'harbour-mining': return 'Harbour-Mining';\n      case 'coastal-mining': return 'Coastal-Mining';\n      case 'world-wide': return 'World-Wide';\n      case 'oil-field': return 'Oil-Field';\n      case 'line-up-mining': return 'Laid Up';\n      case 'active': return 'Active';\n      default: return status.charAt(0).toUpperCase() + status.slice(1);\n    }\n  };\n\n  return (\n    <>\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent className=\"sm:max-w-md p-0 bg-white\" aria-describedby=\"vessel-details-description\">\n          {/* Header */}\n          <DialogHeader className=\"p-6 pb-4\">\n            <DialogTitle className=\"text-xl font-semibold text-gray-900 flex items-center gap-3\">\n              <Ship className=\"h-5 w-5\" />\n              {vessel.name}\n            </DialogTitle>\n          </DialogHeader>\n\n          {/* Content */}\n          <div className=\"px-6 pb-6 space-y-6\" id=\"vessel-details-description\">\n            {/* Vessel Type */}\n            <div>\n              <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Vessel Type</h3>\n              <p className=\"text-base text-gray-900\">{vessel.type}</p>\n            </div>\n\n            {/* IMO Number */}\n            {vessel.imoNumber && (\n              <div>\n                <h3 className=\"text-sm font-medium text-gray-500 mb-2\">IMO Number</h3>\n                <div className=\"flex items-center gap-2\">\n                  <Hash className=\"h-4 w-4 text-gray-400\" />\n                  <p className=\"text-base text-gray-900\">{vessel.imoNumber}</p>\n                </div>\n              </div>\n            )}\n\n            {/* Flag State */}\n            <div>\n              <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Flag State</h3>\n              <div className=\"flex items-center gap-2\">\n                <Flag className=\"h-4 w-4 text-gray-400\" />\n                <p className=\"text-base text-gray-900\">{vessel.flag}</p>\n              </div>\n            </div>\n\n            {/* Status */}\n            <div>\n              <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Status</h3>\n              <Badge className={`${getStatusColor(vessel.status)} px-3 py-1 text-sm font-medium rounded-full`}>\n                {formatStatus(vessel.status)}\n              </Badge>\n            </div>\n\n            {/* Current Crew */}\n            <div>\n              <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Current Crew</h3>\n              <div className=\"flex items-center gap-2\">\n                <Users className=\"h-4 w-4 text-gray-400\" />\n                <p className=\"text-base text-gray-900\">\n                  {vessel.crewCount || 0} members\n                </p>\n              </div>\n            </div>\n          </div>\n\n          {/* Footer */}\n          <div className=\"flex items-center justify-between p-6 pt-0 border-t border-gray-100\">\n            <div className=\"flex gap-3\">\n              <Button\n                variant=\"outline\"\n                className=\"border-gray-300 text-gray-700 hover:bg-gray-50\"\n                onClick={() => setShowEditForm(true)}\n                data-testid=\"edit-vessel-button\"\n              >\n                Edit Vessel\n              </Button>\n              <Button\n                variant=\"outline\"\n                className=\"text-gray-600 hover:bg-gray-50\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"close-vessel-button\"\n              >\n                Close\n              </Button>\n            </div>\n            <Button\n              className=\"bg-blue-600 hover:bg-blue-700 text-white\"\n              onClick={() => {\n                if (onManageCrew) {\n                  onManageCrew(vessel);\n                  onOpenChange(false);\n                }\n              }}\n              data-testid=\"manage-crew-button\"\n            >\n              <Users className=\"h-4 w-4 mr-2\" />\n              View Crew\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n      \n      {/* Edit Vessel Form */}\n      <EditVesselForm\n        vessel={vessel}\n        open={showEditForm}\n        onOpenChange={(open) => {\n          setShowEditForm(open);\n          if (!open) {\n            // Refresh the vessel data when edit form closes\n            queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n            queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n            // Close the details dialog to force fresh data on reopening\n            onOpenChange(false);\n          }\n        }}\n      />\n    </>\n  );\n}","path":null,"size_bytes":6040,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/components/calendar/crew-calendar.tsx":{"content":"import { useState } from 'react';\nimport { format, startOfMonth, endOfMonth, eachDayOfInterval, isSameMonth, isSameDay, addMonths, subMonths } from 'date-fns';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Textarea } from '@/components/ui/textarea';\nimport { ChevronLeft, ChevronRight, Calendar, Users, Ship, Edit, Trash2 } from 'lucide-react';\nimport { CrewRotation } from '@shared/schema';\nimport { cn } from '@/lib/utils';\nimport { useMutation, useQueryClient, useQuery } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface CrewCalendarProps {\n  rotations: CrewRotation[];\n}\n\ninterface CalendarEvent {\n  id: string;\n  title: string;\n  type: 'join' | 'leave' | 'rotation';\n  date: Date;\n  crewMemberId: string;\n  vesselId: string;\n  rotationId: string;\n}\n\nexport default function CrewCalendar({ rotations }: CrewCalendarProps) {\n  const [currentDate, setCurrentDate] = useState(new Date());\n  const [selectedDate, setSelectedDate] = useState<Date | null>(null);\n  const [selectedEvents, setSelectedEvents] = useState<CalendarEvent[]>([]);\n  const [editingRotation, setEditingRotation] = useState<CrewRotation | null>(null);\n  const [isEditModalOpen, setIsEditModalOpen] = useState(false);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  // Fetch crew members\n  const { data: crewMembers } = useQuery({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n  });\n\n  // Fetch vessels\n  const { data: vessels } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  // Helper functions to get names from IDs\n  const getCrewMemberName = (crewMemberId: string) => {\n    const member = crewMembers?.find((m: any) => m.id === crewMemberId);\n    return member ? `${member.firstName} ${member.lastName}` : 'Unknown';\n  };\n\n  const getVesselName = (vesselId: string) => {\n    const vessel = vessels?.find((v: any) => v.id === vesselId);\n    return vessel ? vessel.name : 'Unknown';\n  };\n\n  // Convert rotations to calendar events\n  const events: CalendarEvent[] = rotations.flatMap((rotation) => {\n    const events = [];\n    \n    if (rotation.joinDate) {\n      events.push({\n        id: `${rotation.id}-join`,\n        title: 'Crew Join',\n        type: 'join' as const,\n        date: new Date(rotation.joinDate),\n        crewMemberId: rotation.crewMemberId,\n        vesselId: rotation.vesselId,\n        rotationId: rotation.id,\n      });\n    }\n    \n    if (rotation.leaveDate) {\n      events.push({\n        id: `${rotation.id}-leave`,\n        title: 'Crew Leave',\n        type: 'leave' as const,\n        date: new Date(rotation.leaveDate),\n        crewMemberId: rotation.crewMemberId,\n        vesselId: rotation.vesselId,\n        rotationId: rotation.id,\n      });\n    }\n    \n    return events;\n  });\n\n  const monthStart = startOfMonth(currentDate);\n  const monthEnd = endOfMonth(currentDate);\n  const calendarDays = eachDayOfInterval({ start: monthStart, end: monthEnd });\n\n  const getEventsForDate = (date: Date) => {\n    return events.filter(event => isSameDay(event.date, date));\n  };\n\n  const getEventColor = (type: string) => {\n    switch (type) {\n      case 'join': return 'bg-ocean-blue';\n      case 'leave': return 'bg-warning-amber';\n      case 'rotation': return 'bg-compliance-green';\n      default: return 'bg-gray-500';\n    }\n  };\n\n  const handleDateClick = (date: Date) => {\n    const dayEvents = getEventsForDate(date);\n    if (dayEvents.length > 0) {\n      setSelectedDate(date);\n      setSelectedEvents(dayEvents);\n    }\n  };\n\n  const previousMonth = () => {\n    setCurrentDate(prev => subMonths(prev, 1));\n  };\n\n  const nextMonth = () => {\n    setCurrentDate(prev => addMonths(prev, 1));\n  };\n\n  // Delete rotation mutation\n  const deleteRotationMutation = useMutation({\n    mutationFn: async (rotationId: string) => {\n      const response = await fetch(`/api/rotations/${rotationId}`, {\n        method: 'DELETE',\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to delete rotation');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rotations'] });\n      toast({\n        title: 'Success',\n        description: 'Rotation deleted successfully',\n      });\n      setSelectedDate(null);\n      setSelectedEvents([]);\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to delete rotation',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleDeleteRotation = (rotationId: string) => {\n    if (confirm('Are you sure you want to delete this rotation? This action cannot be undone.')) {\n      deleteRotationMutation.mutate(rotationId);\n    }\n  };\n\n  const handleEditRotation = (rotationId: string) => {\n    const rotation = rotations.find(r => r.id === rotationId);\n    if (rotation) {\n      setEditingRotation(rotation);\n      setIsEditModalOpen(true);\n      setSelectedDate(null);\n    }\n  };\n\n  // Update rotation mutation\n  const updateRotationMutation = useMutation({\n    mutationFn: async (data: { id: string; updates: Partial<CrewRotation> }) => {\n      // Only send the fields that should be updated, format dates as strings\n      const { id: _, createdAt, ...updateFields } = data.updates;\n      const payload = {\n        ...updateFields,\n        joinDate: updateFields.joinDate ? format(new Date(updateFields.joinDate), 'yyyy-MM-dd') : undefined,\n        leaveDate: updateFields.leaveDate ? format(new Date(updateFields.leaveDate), 'yyyy-MM-dd') : undefined,\n      };\n\n      const response = await fetch(`/api/rotations/${data.id}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          ...getAuthHeaders(),\n        },\n        body: JSON.stringify(payload),\n      });\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.message || 'Failed to update rotation');\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rotations'] });\n      toast({\n        title: 'Success',\n        description: 'Rotation updated successfully',\n      });\n      setIsEditModalOpen(false);\n      setEditingRotation(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to update rotation',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleUpdateRotation = (updates: Partial<CrewRotation>) => {\n    if (editingRotation) {\n      updateRotationMutation.mutate({ id: editingRotation.id, updates });\n    }\n  };\n\n  const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];\n\n  // Get events for current month - show all join/leave activities\n  const monthEvents = events.filter(event => isSameMonth(event.date, currentDate));\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Print Styles */}\n      <style>{`\n        @media print {\n          body * {\n            visibility: hidden;\n          }\n          .print-calendar-container,\n          .print-calendar-container * {\n            visibility: visible;\n          }\n          .print-calendar-container {\n            position: absolute;\n            left: 0;\n            top: 0;\n            width: 100%;\n          }\n          .print-hide {\n            display: none !important;\n          }\n          .print-show {\n            display: block !important;\n          }\n          .print-calendar-container .hover\\\\:bg-muted {\n            cursor: default !important;\n          }\n        }\n        .print-show {\n          display: none;\n        }\n      `}</style>\n\n      <div className=\"print-calendar-container\">\n        {/* Calendar Header */}\n        <div className=\"flex items-center justify-between mb-4\">\n          <div className=\"flex items-center space-x-4\">\n            <Button variant=\"outline\" size=\"sm\" onClick={previousMonth} data-testid=\"prev-month-button\" className=\"print-hide\">\n              <ChevronLeft className=\"h-4 w-4\" />\n            </Button>\n            <h3 className=\"text-xl font-semibold text-foreground\" data-testid=\"current-month\">\n              {format(currentDate, 'MMMM yyyy')}\n            </h3>\n            <Button variant=\"outline\" size=\"sm\" onClick={nextMonth} data-testid=\"next-month-button\" className=\"print-hide\">\n              <ChevronRight className=\"h-4 w-4\" />\n            </Button>\n          </div>\n          \n          <div className=\"flex items-center space-x-4 text-sm print-hide\">\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-3 h-3 bg-ocean-blue rounded-full\"></div>\n              <span className=\"text-muted-foreground\">Crew Join</span>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-3 h-3 bg-warning-amber rounded-full\"></div>\n              <span className=\"text-muted-foreground\">Crew Leave</span>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-3 h-3 bg-compliance-green rounded-full\"></div>\n              <span className=\"text-muted-foreground\">Training</span>\n            </div>\n          </div>\n        </div>\n\n      {/* Calendar Grid */}\n      <div className=\"bg-card rounded-lg border border-border\">\n        {/* Week Headers */}\n        <div className=\"grid grid-cols-7 border-b border-border\">\n          {weekDays.map((day) => (\n            <div\n              key={day}\n              className=\"p-3 text-center text-sm font-medium text-muted-foreground bg-muted\"\n            >\n              {day}\n            </div>\n          ))}\n        </div>\n\n        {/* Calendar Days */}\n        <div className=\"grid grid-cols-7\">\n          {calendarDays.map((day) => {\n            const dayEvents = getEventsForDate(day);\n            const isCurrentMonth = isSameMonth(day, currentDate);\n            const isToday = isSameDay(day, new Date());\n            \n            return (\n              <div\n                key={day.toString()}\n                className={cn(\n                  'min-h-24 p-2 border-r border-b border-border hover:bg-muted cursor-pointer transition-colors',\n                  !isCurrentMonth && 'bg-muted text-muted-foreground',\n                  isToday && 'bg-primary/10 text-primary'\n                )}\n                onClick={() => handleDateClick(day)}\n                data-testid={`calendar-day-${format(day, 'yyyy-MM-dd')}`}\n              >\n                <div className={cn(\n                  'text-sm font-medium mb-1 text-foreground',\n                  isToday && 'font-bold',\n                  !isCurrentMonth && 'text-muted-foreground'\n                )}>\n                  {format(day, 'd')}\n                </div>\n                \n                {/* Event Indicators */}\n                <div className=\"space-y-1\">\n                  {dayEvents.slice(0, 3).map((event) => (\n                    <div\n                      key={event.id}\n                      className={cn(\n                        'w-full h-1.5 rounded-full',\n                        getEventColor(event.type)\n                      )}\n                      title={event.title}\n                      data-testid={`event-indicator-${event.id}`}\n                    />\n                  ))}\n                  {dayEvents.length > 3 && (\n                    <div className=\"text-xs text-muted-foreground\">\n                      +{dayEvents.length - 3} more\n                    </div>\n                  )}\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n\n      {/* Event Details Modal */}\n      <Dialog open={!!selectedDate} onOpenChange={() => setSelectedDate(null)}>\n        <DialogContent className=\"max-w-md max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center space-x-2\">\n              <Calendar className=\"h-5 w-5 text-primary\" />\n              <span>\n                Events for {selectedDate && format(selectedDate, 'MMMM d, yyyy')}\n              </span>\n            </DialogTitle>\n          </DialogHeader>\n          \n          <div className=\"space-y-3 max-h-[60vh] overflow-y-auto pr-2\">\n            {selectedEvents.length === 0 ? (\n              <p className=\"text-muted-foreground text-center py-4\">No events scheduled</p>\n            ) : (\n              selectedEvents.map((event) => {\n                const rotation = rotations.find(r => r.id === event.rotationId);\n                const crewName = getCrewMemberName(event.crewMemberId);\n                const vesselName = getVesselName(event.vesselId);\n                \n                return (\n                  <div\n                    key={event.id}\n                    className=\"p-3 border border-border rounded-lg hover:bg-muted transition-colors\"\n                    data-testid={`modal-event-${event.id}`}\n                  >\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <h4 className=\"font-medium text-foreground\">{event.title}</h4>\n                      <div className=\"flex items-center space-x-2\">\n                        <Badge className={`${getEventColor(event.type)} text-white`}>\n                          {event.type.toUpperCase()}\n                        </Badge>\n                      </div>\n                    </div>\n                    \n                    <div className=\"space-y-1 text-sm text-muted-foreground mb-3\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Users className=\"h-3 w-3 shrink-0\" />\n                        <span className=\"break-words\">Crew Member: {crewName}</span>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <Ship className=\"h-3 w-3 shrink-0\" />\n                        <span className=\"break-words\">Vessel: {vesselName}</span>\n                      </div>\n                    </div>\n\n                    <div className=\"flex justify-end space-x-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => handleEditRotation(event.rotationId)}\n                        className=\"text-primary hover:bg-accent\"\n                        data-testid={`edit-rotation-${event.rotationId}`}\n                      >\n                        <Edit className=\"h-3 w-3 mr-1\" />\n                        Edit\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => handleDeleteRotation(event.rotationId)}\n                        className=\"text-destructive hover:bg-destructive/10\"\n                        disabled={deleteRotationMutation.isPending}\n                        data-testid={`delete-rotation-${event.rotationId}`}\n                      >\n                        <Trash2 className=\"h-3 w-3 mr-1\" />\n                        {deleteRotationMutation.isPending ? 'Deleting...' : 'Delete'}\n                      </Button>\n                    </div>\n                  </div>\n                );\n              })\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n\n        {/* Events List for Print - Only shows when printing */}\n        <div className=\"print-show mt-8 break-before-page\">\n          <h4 className=\"text-lg font-semibold text-foreground mb-4 border-b pb-2\">\n            Scheduled Activities for {format(currentDate, 'MMMM yyyy')}\n          </h4>\n          {monthEvents.length === 0 ? (\n            <p className=\"text-muted-foreground text-center py-4\">No activities scheduled for this month</p>\n          ) : (\n            <table className=\"w-full border-collapse border border-border\">\n              <thead>\n                <tr className=\"bg-muted\">\n                  <th className=\"border border-border p-2 text-left\">Crew Member</th>\n                  <th className=\"border border-border p-2 text-left\">Vessel</th>\n                  <th className=\"border border-border p-2 text-left\">Activity</th>\n                  <th className=\"border border-border p-2 text-left\">Date</th>\n                  <th className=\"border border-border p-2 text-left\">Status</th>\n                </tr>\n              </thead>\n              <tbody>\n                {monthEvents.map((event) => {\n                  const rotation = rotations.find(r => r.id === event.rotationId);\n                  return (\n                    <tr key={event.id}>\n                      <td className=\"border border-border p-2\">{getCrewMemberName(event.crewMemberId)}</td>\n                      <td className=\"border border-border p-2\">{getVesselName(event.vesselId)}</td>\n                      <td className=\"border border-border p-2 capitalize\">{event.type}</td>\n                      <td className=\"border border-border p-2\">\n                        {format(event.date, 'MMM dd, yyyy')}\n                      </td>\n                      <td className=\"border border-border p-2 capitalize\">{rotation?.status || 'Scheduled'}</td>\n                    </tr>\n                  );\n                })}\n              </tbody>\n            </table>\n          )}\n        </div>\n      </div>\n\n      {/* Event Details Modal */}\n      <Dialog open={!!selectedDate} onOpenChange={() => setSelectedDate(null)}>\n        <DialogContent className=\"max-w-md max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center space-x-2\">\n              <Calendar className=\"h-5 w-5 text-primary\" />\n              <span>\n                Events for {selectedDate && format(selectedDate, 'MMMM d, yyyy')}\n              </span>\n            </DialogTitle>\n          </DialogHeader>\n          \n          <div className=\"space-y-3 max-h-[60vh] overflow-y-auto pr-2\">\n            {selectedEvents.length === 0 ? (\n              <p className=\"text-muted-foreground text-center py-4\">No events scheduled</p>\n            ) : (\n              selectedEvents.map((event) => {\n                const rotation = rotations.find(r => r.id === event.rotationId);\n                const crewName = getCrewMemberName(event.crewMemberId);\n                const vesselName = getVesselName(event.vesselId);\n                \n                return (\n                  <div\n                    key={event.id}\n                    className=\"p-3 border border-border rounded-lg hover:bg-muted transition-colors\"\n                    data-testid={`modal-event-${event.id}`}\n                  >\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <h4 className=\"font-medium text-foreground\">{event.title}</h4>\n                      <div className=\"flex items-center space-x-2\">\n                        <Badge className={`${getEventColor(event.type)} text-white`}>\n                          {event.type.toUpperCase()}\n                        </Badge>\n                      </div>\n                    </div>\n                    \n                    <div className=\"space-y-1 text-sm text-muted-foreground mb-3\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Users className=\"h-3 w-3 shrink-0\" />\n                        <span className=\"break-words\">Crew Member: {crewName}</span>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <Ship className=\"h-3 w-3 shrink-0\" />\n                        <span className=\"break-words\">Vessel: {vesselName}</span>\n                      </div>\n                    </div>\n\n                    <div className=\"flex justify-end space-x-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => handleEditRotation(event.rotationId)}\n                        className=\"text-primary hover:bg-accent\"\n                        data-testid={`edit-rotation-${event.rotationId}`}\n                      >\n                        <Edit className=\"h-3 w-3 mr-1\" />\n                        Edit\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => handleDeleteRotation(event.rotationId)}\n                        className=\"text-destructive hover:bg-destructive/10\"\n                        disabled={deleteRotationMutation.isPending}\n                        data-testid={`delete-rotation-${event.rotationId}`}\n                      >\n                        <Trash2 className=\"h-3 w-3 mr-1\" />\n                        {deleteRotationMutation.isPending ? 'Deleting...' : 'Delete'}\n                      </Button>\n                    </div>\n                  </div>\n                );\n              })\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Rotation Modal */}\n      <Dialog open={isEditModalOpen} onOpenChange={setIsEditModalOpen}>\n        <DialogContent className=\"max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center space-x-2\">\n              <Edit className=\"h-5 w-5 text-primary\" />\n              <span>Edit Rotation</span>\n            </DialogTitle>\n          </DialogHeader>\n          \n          {editingRotation && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"edit-join-date\">Join Date</Label>\n                  <Input\n                    id=\"edit-join-date\"\n                    type=\"date\"\n                    defaultValue={editingRotation.joinDate ? format(new Date(editingRotation.joinDate), 'yyyy-MM-dd') : ''}\n                    onChange={(e) => setEditingRotation({...editingRotation, joinDate: new Date(e.target.value)})}\n                    data-testid=\"edit-join-date\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"edit-leave-date\">Leave Date</Label>\n                  <Input\n                    id=\"edit-leave-date\"\n                    type=\"date\"\n                    defaultValue={editingRotation.leaveDate ? format(new Date(editingRotation.leaveDate), 'yyyy-MM-dd') : ''}\n                    onChange={(e) => setEditingRotation({...editingRotation, leaveDate: e.target.value ? new Date(e.target.value) : null})}\n                    data-testid=\"edit-leave-date\"\n                  />\n                </div>\n              </div>\n\n              <div>\n                <Label htmlFor=\"edit-rotation-type\">Rotation Type</Label>\n                <Select \n                  defaultValue={editingRotation.rotationType}\n                  onValueChange={(value) => setEditingRotation({...editingRotation, rotationType: value})}\n                >\n                  <SelectTrigger data-testid=\"edit-rotation-type\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"join\">Join</SelectItem>\n                    <SelectItem value=\"leave\">Leave</SelectItem>\n                    <SelectItem value=\"rotation\">Rotation</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <Label htmlFor=\"edit-status\">Status</Label>\n                <Select \n                  defaultValue={editingRotation.status}\n                  onValueChange={(value) => setEditingRotation({...editingRotation, status: value})}\n                >\n                  <SelectTrigger data-testid=\"edit-status\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"scheduled\">Scheduled</SelectItem>\n                    <SelectItem value=\"completed\">Completed</SelectItem>\n                    <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <Label htmlFor=\"edit-notes\">Notes</Label>\n                <Textarea\n                  id=\"edit-notes\"\n                  defaultValue={editingRotation.notes || ''}\n                  onChange={(e) => setEditingRotation({...editingRotation, notes: e.target.value})}\n                  placeholder=\"Additional notes...\"\n                  data-testid=\"edit-notes\"\n                />\n              </div>\n\n              <div className=\"flex justify-end space-x-2 pt-4\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setIsEditModalOpen(false)}\n                  data-testid=\"cancel-edit\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  onClick={() => handleUpdateRotation(editingRotation)}\n                  disabled={updateRotationMutation.isPending}\n                  data-testid=\"save-edit\"\n                >\n                  {updateRotationMutation.isPending ? 'Saving...' : 'Save Changes'}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":26058,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/pages/fleet-management.tsx":{"content":"import { useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { format } from 'date-fns';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport VesselDetailsDialog from '@/components/vessels/vessel-details-dialog';\nimport CrewManagementDialog from '@/components/vessels/crew-management-dialog';\nimport { VesselDocumentUploadModal } from '@/components/vessel-documents/vessel-document-upload-modal';\nimport { \n  Ship, \n  Activity, \n  Anchor, \n  Globe,\n  Wrench,\n  Pause,\n  Download,\n  Users,\n  Flag,\n  Hash,\n  Calendar,\n  FileText\n} from 'lucide-react';\n\nexport default function FleetManagement() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [selectedVesselForDetails, setSelectedVesselForDetails] = useState<any>(null);\n  const [selectedVesselForCrew, setSelectedVesselForCrew] = useState<any>(null);\n  const [selectedVesselForUpload, setSelectedVesselForUpload] = useState<any>(null);\n  const [statusFilter, setStatusFilter] = useState<string>('all');\n\n  // Fetch vessels data\n  const { data: vessels, isLoading } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  // Fetch crew data for vessel crew counts\n  const { data: crewMembers } = useQuery({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n  });\n\n  if (user?.role !== 'admin') {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"text-center py-12\">\n          <Ship className=\"h-16 w-16 mx-auto text-gray-300 dark:text-gray-600 mb-4\" />\n          <h2 className=\"text-2xl font-semibold text-foreground mb-2\">Access Restricted</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            Fleet management is only accessible to administrators.\n          </p>\n          <Button\n            onClick={() => window.location.href = '/dashboard'}\n            className=\"bg-primary hover:bg-primary/90\"\n          >\n            Go to Dashboard\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-2\"></div>\n          <div className=\"h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2\"></div>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          {Array(6).fill(0).map((_, i) => (\n            <div key={i} className=\"h-24 bg-gray-200 dark:bg-gray-700 rounded animate-pulse\"></div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  // Calculate counts for each category\n  const totalVessels = vessels?.length || 0;\n  const harbourMining = vessels?.filter((v: any) => v.status === 'harbour-mining').length || 0;\n  const coastalMining = vessels?.filter((v: any) => v.status === 'coastal-mining').length || 0;\n  const worldWide = vessels?.filter((v: any) => v.status === 'world-wide').length || 0;\n  const oilField = vessels?.filter((v: any) => v.status === 'oil-field').length || 0;\n  const lineUpMining = vessels?.filter((v: any) => v.status === 'line-up-mining').length || 0;\n\n  // Filter vessels based on selected status\n  const filteredVessels = statusFilter === 'all' \n    ? vessels \n    : vessels?.filter((v: any) => v.status === statusFilter) || [];\n\n  const exportVesselList = () => {\n    try {\n      if (!vessels || vessels.length === 0) {\n        toast({\n          title: 'No Data',\n          description: 'No vessels found to export',\n          variant: 'destructive',\n        });\n        return;\n      }\n\n      const headers = [\n        'Vessel Name',\n        'Type', \n        'IMO Number',\n        'Flag',\n        'Operational Status',\n        'Crew On Board',\n        'Sort Order',\n        'Date Added'\n      ];\n\n      const rows = vessels.map((vessel: any) => {\n        // Calculate crew count for this vessel\n        const vesselCrewCount = crewMembers?.filter((member: any) => \n          member.currentVesselId === vessel.id && member.status === 'onBoard'\n        ).length || 0;\n\n        // Format status for better readability\n        const formatStatus = (status: string) => {\n          switch (status) {\n            case 'harbour-mining': return 'Harbour Mining';\n            case 'coastal-mining': return 'Coastal Mining';\n            case 'world-wide': return 'World Wide';\n            case 'oil-field': return 'Oil Field';\n            case 'line-up-mining': return 'Laid Up';\n            default: return status || 'Unknown';\n          }\n        };\n        \n        return [\n          vessel.name || 'N/A',\n          vessel.type || 'N/A',\n          vessel.imoNumber || 'N/A',\n          vessel.flag || 'N/A',\n          formatStatus(vessel.status),\n          vesselCrewCount.toString(),\n          vessel.sortOrder?.toString() || '0',\n          vessel.createdAt ? format(new Date(vessel.createdAt), 'yyyy-MM-dd') : 'N/A'\n        ];\n      });\n\n      // Create CSV with proper formatting\n      const csvRows = [];\n      \n      // Add title row\n      csvRows.push('\"FLEET MANAGEMENT EXPORT REPORT\"');\n      csvRows.push(`\"Generated on: ${format(new Date(), 'MMMM dd, yyyy at HH:mm')}\"`);\n      csvRows.push(`\"Total Vessels: ${vessels.length}\"`);\n      csvRows.push(`\"Filter Applied: ${statusFilter === 'all' ? 'All Vessels' : statusFilter}\"`);\n      csvRows.push(''); // Empty row for spacing\n      \n      // Add headers\n      csvRows.push(headers.map(header => `\"${header}\"`).join(','));\n      \n      // Add data rows with proper formatting\n      rows.forEach(row => {\n        const formattedRow = row.map((cell: any) => {\n          let cellValue = String(cell || '');\n          // Clean any equals signs that might cause Excel formula issues\n          cellValue = cellValue.replace(/^=+/, '');\n          \n          // Replace N/A with dashes for better readability\n          if (cellValue === 'N/A') {\n            cellValue = '---';\n          }\n          \n          return `\"${cellValue}\"`;\n        });\n        csvRows.push(formattedRow.join(','));\n      });\n      \n      // Add summary footer\n      csvRows.push(''); // Empty row\n      csvRows.push('\"FLEET SUMMARY STATISTICS\"');\n      csvRows.push(`\"Harbour Mining Vessels: ${vessels.filter((v: any) => v.status === 'harbour-mining').length}\"`);\n      csvRows.push(`\"Coastal Mining Vessels: ${vessels.filter((v: any) => v.status === 'coastal-mining').length}\"`);\n      csvRows.push(`\"World Wide Vessels: ${vessels.filter((v: any) => v.status === 'world-wide').length}\"`);\n      csvRows.push(`\"Oil Field Vessels: ${vessels.filter((v: any) => v.status === 'oil-field').length}\"`);\n      csvRows.push(`\"Laid-Up Vessels: ${vessels.filter((v: any) => v.status === 'line-up-mining').length}\"`);\n      csvRows.push(`\"Total Crew Members Deployed: ${crewMembers?.filter((member: any) => member.status === 'onBoard').length || 0}\"`);\n      \n      const csvContent = csvRows.join('\\n');\n\n      // Add BOM for proper Excel UTF-8 handling\n      const BOM = '\\uFEFF';\n      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      if (link.download !== undefined) {\n        const url = URL.createObjectURL(blob);\n        link.setAttribute('href', url);\n        link.setAttribute('download', `Fleet-Management-Export-${format(new Date(), 'yyyy-MM-dd-HHmm')}.csv`);\n        link.style.visibility = 'hidden';\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n      }\n\n      toast({\n        title: 'Export Successful',\n        description: `Fleet data exported with ${vessels.length} vessels`,\n      });\n    } catch (error) {\n      toast({\n        title: 'Export Failed',\n        description: 'Unable to export fleet data. Please try again.',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold text-foreground mb-2\" data-testid=\"fleet-management-title\">\n            Fleet Management\n          </h2>\n          <p className=\"text-muted-foreground\">\n            Manage vessels, crew assignments, and fleet operations\n          </p>\n        </div>\n        \n        <div className=\"flex items-center space-x-4\">\n          <Select value={statusFilter} onValueChange={setStatusFilter}>\n            <SelectTrigger className=\"w-40\">\n              <SelectValue placeholder=\"All Vessels\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Vessels</SelectItem>\n              <SelectItem value=\"harbour-mining\">Harbour Mining</SelectItem>\n              <SelectItem value=\"coastal-mining\">Coastal Mining</SelectItem>\n              <SelectItem value=\"world-wide\">World Wide</SelectItem>\n              <SelectItem value=\"oil-field\">Oil Field</SelectItem>\n              <SelectItem value=\"line-up-mining\">Laid Up</SelectItem>\n            </SelectContent>\n          </Select>\n          \n          <Button\n            onClick={exportVesselList}\n            disabled={!vessels || vessels.length === 0}\n            className=\"bg-blue-600 hover:bg-blue-700 text-white\"\n            data-testid=\"export-fleet-button\"\n          >\n            <Download className=\"h-4 w-4 mr-2\" />\n            Export CSV\n          </Button>\n        </div>\n      </div>\n\n      {/* Fleet Overview Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card className=\"bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 shadow-sm hover:shadow-md transition-shadow\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-blue-700 flex items-center\">\n              <Ship className=\"h-4 w-4 mr-2 text-blue-600\" />\n              Total Vessels\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-blue-900\">\n              {totalVessels}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-green-50 to-green-100 border border-green-200 shadow-sm hover:shadow-md transition-shadow\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-green-700 flex items-center\">\n              <Activity className=\"h-4 w-4 mr-2 text-green-600\" />\n              Harbour Mining\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-green-900\">\n              {harbourMining}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-cyan-50 to-cyan-100 border border-cyan-200 shadow-sm hover:shadow-md transition-shadow\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-cyan-700 flex items-center\">\n              <Anchor className=\"h-4 w-4 mr-2 text-cyan-600\" />\n              Coastal Mining\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-cyan-900\">\n              {coastalMining}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 shadow-sm hover:shadow-md transition-shadow\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-purple-700 flex items-center\">\n              <Globe className=\"h-4 w-4 mr-2 text-purple-600\" />\n              World Wide (Foreign Going)\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-purple-900\">\n              {worldWide}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 shadow-sm hover:shadow-md transition-shadow\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-orange-700 flex items-center\">\n              <Wrench className=\"h-4 w-4 mr-2 text-orange-600\" />\n              Oil Field\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-orange-900\">\n              {oilField}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-200 shadow-sm hover:shadow-md transition-shadow\">\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-700 flex items-center\">\n              <Pause className=\"h-4 w-4 mr-2 text-gray-600\" />\n              Laid-Up\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold text-gray-900\">\n              {lineUpMining}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Vessel Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {filteredVessels?.length === 0 ? (\n          <div className=\"col-span-full text-center py-12\">\n            <Ship className=\"h-16 w-16 mx-auto text-gray-300 mb-4\" />\n            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No vessels found</h3>\n            <p className=\"text-gray-500\">\n              {statusFilter === 'all' \n                ? 'No vessels have been added to the system yet.'\n                : `No vessels found with status: ${statusFilter.replace('-', ' ')}`\n              }\n            </p>\n          </div>\n        ) : (\n          filteredVessels?.map((vessel: any) => {\n          const getStatusColor = (status: string) => {\n            switch (status.toLowerCase()) {\n              case 'harbour-mining':\n                return 'bg-green-500 text-white px-3 py-1 rounded-full text-xs font-medium';\n              case 'coastal-mining':\n                return 'bg-blue-500 text-white px-3 py-1 rounded-full text-xs font-medium';\n              case 'world-wide':\n                return 'bg-purple-500 text-white px-3 py-1 rounded-full text-xs font-medium';\n              case 'oil-field':\n                return 'bg-yellow-500 text-white px-3 py-1 rounded-full text-xs font-medium';\n              case 'line-up-mining':\n                return 'bg-gray-500 text-white px-3 py-1 rounded-full text-xs font-medium';\n              default:\n                return 'bg-gray-500 text-white px-3 py-1 rounded-full text-xs font-medium';\n            }\n          };\n\n          const formatStatus = (status: string) => {\n            switch (status.toLowerCase()) {\n              case 'harbour-mining':\n                return 'Harbour-Mining';\n              case 'coastal-mining':\n                return 'Coastal-Mining';\n              case 'world-wide':\n                return 'World-Wide';\n              case 'oil-field':\n                return 'Oil-Field';\n              case 'line-up-mining':\n                return 'Lined-Up';\n              default:\n                return status;\n            }\n          };\n\n          return (\n            <Card key={vessel.id} className=\"bg-gradient-to-br from-white to-gray-50 border border-gray-200 shadow-sm hover:shadow-lg transition-all duration-200 hover:border-blue-300\">\n              <CardHeader className=\"pb-4\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-center space-x-3\">\n                    <Ship className=\"h-5 w-5 text-blue-600\" />\n                    <h3 className=\"font-semibold text-gray-900 text-lg\">\n                      {vessel.name}\n                    </h3>\n                  </div>\n                  <div className={getStatusColor(vessel.status)}>\n                    {formatStatus(vessel.status)}\n                  </div>\n                </div>\n              </CardHeader>\n              \n              <CardContent className=\"space-y-3\">\n                <div className=\"grid grid-cols-1 gap-3 text-sm\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-500\">Type:</span>\n                    <span className=\"text-gray-900 font-medium\">{vessel.type}</span>\n                  </div>\n                  \n                  {vessel.imoNumber && (\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-gray-500\">IMO:</span>\n                      <span className=\"text-gray-900 font-medium\">{vessel.imoNumber}</span>\n                    </div>\n                  )}\n                  \n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-500\">Flag:</span>\n                    <span className=\"text-gray-900 font-medium\">{vessel.flag}</span>\n                  </div>\n                  \n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-500\">Crew:</span>\n                    <span className=\"text-gray-900 font-medium\">\n                      {vessel.crewCount || 0} members\n                    </span>\n                  </div>\n                  \n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-500\">Next Rotation:</span>\n                    <span className=\"text-gray-900 font-medium\">\n                      {vessel.nextCrewChange ? \n                        new Date(vessel.nextCrewChange).toLocaleDateString('en-US', { \n                          year: 'numeric', \n                          month: 'short', \n                          day: '2-digit' \n                        }) : \n                        'Not scheduled'\n                      }\n                    </span>\n                  </div>\n                </div>\n\n                {/* Action Buttons */}\n                <div className=\"pt-4 border-t border-gray-200\">\n                  <div className=\"grid grid-cols-3 gap-2\">\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      className=\"text-xs\"\n                      onClick={() => setSelectedVesselForDetails(vessel)}\n                      data-testid={`view-vessel-${vessel.id}`}\n                    >\n                      <Ship className=\"h-3 w-3 mr-1\" />\n                      Details\n                    </Button>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      className=\"text-xs\"\n                      onClick={() => setSelectedVesselForCrew(vessel)}\n                      data-testid={`manage-crew-${vessel.id}`}\n                    >\n                      <Users className=\"h-3 w-3 mr-1\" />\n                      Crew\n                    </Button>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      className=\"text-xs\"\n                      onClick={() => setSelectedVesselForUpload(vessel)}\n                      data-testid={`upload-document-${vessel.id}`}\n                    >\n                      <FileText className=\"h-3 w-3 mr-1\" />\n                      Upload\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          );\n        }))}\n      </div>\n\n      {/* Vessel Details Dialog */}\n      <VesselDetailsDialog\n        vessel={selectedVesselForDetails}\n        open={!!selectedVesselForDetails}\n        onOpenChange={(open) => !open && setSelectedVesselForDetails(null)}\n        onManageCrew={(vessel) => {\n          setSelectedVesselForDetails(null);\n          setSelectedVesselForCrew(vessel);\n        }}\n      />\n\n      {/* Crew Management Dialog */}\n      <CrewManagementDialog\n        vessel={selectedVesselForCrew}\n        open={!!selectedVesselForCrew}\n        onOpenChange={(open) => !open && setSelectedVesselForCrew(null)}\n      />\n\n      {/* Document Upload Modal */}\n      {selectedVesselForUpload && (\n        <VesselDocumentUploadModal\n          vesselId={selectedVesselForUpload.id}\n          vesselName={selectedVesselForUpload.name}\n          open={!!selectedVesselForUpload}\n          onClose={() => setSelectedVesselForUpload(null)}\n        />\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":21038,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* Custom scrollbar styles for better visibility */\n.custom-scrollbar {\n  scrollbar-width: auto !important;\n  scrollbar-color: #4B5563 #E5E7EB !important;\n}\n\n.custom-scrollbar::-webkit-scrollbar {\n  width: 12px !important;\n  height: 12px !important;\n}\n\n.custom-scrollbar::-webkit-scrollbar-track {\n  background: #E5E7EB !important;\n  border-radius: 6px !important;\n}\n\n.custom-scrollbar::-webkit-scrollbar-thumb {\n  background: #4B5563 !important;\n  border-radius: 6px !important;\n  border: 2px solid #E5E7EB !important;\n}\n\n.custom-scrollbar::-webkit-scrollbar-thumb:hover {\n  background: #374151 !important;\n}\n\n.custom-scrollbar::-webkit-scrollbar-corner {\n  background: #E5E7EB !important;\n}\n\n/* Additional thin scrollbar styles for upload modal */\n.scrollbar-thin {\n  scrollbar-width: thin;\n}\n\n.scrollbar-thin::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n\n.scrollbar-thin::-webkit-scrollbar-thumb {\n  background-color: rgb(209, 213, 219);\n  border-radius: 4px;\n}\n\n.scrollbar-thin::-webkit-scrollbar-thumb:hover {\n  background-color: rgb(156, 163, 175);\n}\n\n.scrollbar-thin::-webkit-scrollbar-track {\n  background-color: rgb(243, 244, 246);\n  border-radius: 4px;\n}\n\n:root {\n  /* Light Theme - Based on user specifications */\n  --background: hsl(0, 0%, 98%); /* #F9FAFB */\n  --foreground: hsl(220, 13%, 9%); /* #111827 */\n  --card: hsl(0, 0%, 100%); /* White */\n  --card-foreground: hsl(220, 13%, 9%);\n  --popover: hsl(0, 0%, 100%);\n  --popover-foreground: hsl(220, 13%, 9%);\n  --primary: hsl(224, 76%, 48%); /* #1D4ED8 Navy Blue */\n  --primary-foreground: hsl(0, 0%, 100%);\n  --secondary: hsl(220, 14%, 96%); /* Light gray */\n  --secondary-foreground: hsl(220, 9%, 46%); /* #4B5563 */\n  --muted: hsl(220, 14%, 96%);\n  --muted-foreground: hsl(220, 9%, 46%);\n  --accent: hsl(220, 14%, 96%);\n  --accent-foreground: hsl(220, 13%, 9%);\n  --destructive: hsl(0, 72%, 58%);\n  --destructive-foreground: hsl(0, 0%, 100%);\n  --border: hsl(220, 13%, 91%); /* #E5E7EB */\n  --input: hsl(220, 13%, 91%);\n  --ring: hsl(224, 76%, 48%);\n  --chart-1: hsl(224, 76%, 48%);\n  --chart-2: hsl(199, 58%, 62%);\n  --chart-3: hsl(42, 92%, 56%);\n  --chart-4: hsl(147, 79%, 42%);\n  --chart-5: hsl(341, 75%, 51%);\n  --sidebar: hsl(0, 0%, 100%);\n  --sidebar-foreground: hsl(220, 13%, 9%);\n  --sidebar-primary: hsl(224, 76%, 48%);\n  --sidebar-primary-foreground: hsl(0, 0%, 100%);\n  --sidebar-accent: hsl(220, 14%, 96%);\n  --sidebar-accent-foreground: hsl(220, 13%, 9%);\n  --sidebar-border: hsl(220, 13%, 91%);\n  --sidebar-ring: hsl(224, 76%, 48%);\n  --font-sans: 'Inter', 'Open Sans', system-ui, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: Menlo, monospace;\n  --radius: 0.75rem;\n  /* Maritime Colors - Light Theme */\n  --maritime-navy: hsl(224, 76%, 48%); /* #1D4ED8 */\n  --ocean-blue: hsl(199, 58%, 62%); /* #5DADE2 */\n  --warning-amber: hsl(42, 92%, 56%); /* #F39C12 */\n  --compliance-green: hsl(147, 79%, 42%); /* #27AE60 */\n  --text-navy: hsl(220, 13%, 9%); /* #111827 */\n  --alert-red: hsl(0, 72%, 58%); /* #E74C3C */\n  --light-bg: hsl(0, 0%, 98%);\n}\n\n.dark {\n  /* Dark Theme - Optimized for text visibility and eye comfort */\n  --background: hsl(220, 47%, 11%); /* #111827 - Very dark gray main background */\n  --foreground: hsl(0, 0%, 100%); /* #FFFFFF - Pure white for headings */\n  --card: hsl(215, 28%, 17%); /* #1F2937 - Cards in lighter gray */\n  --card-foreground: hsl(210, 20%, 98%); /* #F9FAFB - Off-white for card content */\n  --popover: hsl(215, 28%, 17%); /* #1F2937 */\n  --popover-foreground: hsl(210, 20%, 98%); /* #F9FAFB */\n  --primary: hsl(213, 94%, 68%); /* #3B82F6 - Light blue for primary buttons */\n  --primary-foreground: hsl(0, 0%, 100%); /* #FFFFFF - White text on buttons */\n  --secondary: hsl(215, 25%, 27%); /* #374151 - Input fields dark gray */\n  --secondary-foreground: hsl(220, 38%, 90%); /* #E5E7EB - Light gray body text */\n  --muted: hsl(215, 25%, 27%); /* #374151 */\n  --muted-foreground: hsl(220, 13%, 69%); /* #9CA3AF - Medium gray for secondary text */\n  --accent: hsl(215, 25%, 27%); /* #374151 */\n  --accent-foreground: hsl(210, 20%, 98%); /* #F9FAFB */\n  --destructive: hsl(0, 84%, 60%); /* #EF4444 - Bright red for errors */\n  --destructive-foreground: hsl(0, 0%, 100%); /* #FFFFFF */\n  --border: hsl(215, 14%, 34%); /* #4B5563 - Gray borders for visibility */\n  --input: hsl(215, 25%, 27%); /* #374151 - Dark gray input fields */\n  --ring: hsl(213, 94%, 68%); /* #3B82F6 - Focus rings */\n  --chart-1: hsl(213, 94%, 68%); /* Light blue */\n  --chart-2: hsl(142, 76%, 73%); /* Light green */\n  --chart-3: hsl(38, 92%, 69%); /* Light yellow */\n  --chart-4: hsl(271, 91%, 74%); /* Light purple */\n  --chart-5: hsl(349, 89%, 74%); /* Light pink */\n  --sidebar: hsl(215, 28%, 17%); /* #1F2937 */\n  --sidebar-foreground: hsl(0, 0%, 100%); /* #FFFFFF - Pure white for nav items */\n  --sidebar-primary: hsl(213, 94%, 68%); /* #3B82F6 - Maritime blue for active items */\n  --sidebar-primary-foreground: hsl(0, 0%, 100%); /* #FFFFFF */\n  --sidebar-accent: hsl(215, 25%, 27%); /* #374151 - Hover background */\n  --sidebar-accent-foreground: hsl(0, 0%, 100%); /* #FFFFFF */\n  --sidebar-border: hsl(215, 14%, 34%); /* #4B5563 */\n  --sidebar-ring: hsl(213, 94%, 68%); /* #3B82F6 */\n  /* Maritime Colors - Dark Theme */\n  --maritime-navy: hsl(213, 94%, 68%); /* #3B82F6 */\n  --ocean-blue: hsl(213, 94%, 76%); /* #60A5FA - Light blue for links */\n  --warning-amber: hsl(42, 92%, 70%); /* #FBBF24 */\n  --compliance-green: hsl(147, 64%, 60%); /* #34D399 */\n  --text-navy: hsl(0, 0%, 100%); /* #FFFFFF - Pure white for headings */\n  --alert-red: hsl(0, 84%, 60%); /* #EF4444 - Bright red for visibility */\n  --light-bg: hsl(220, 47%, 11%); /* #111827 - Very dark background */\n}\n\n/* Enhanced tablet responsiveness fixes */\n@media (min-width: 768px) and (max-width: 1023px) {\n  /* Ensure proper table layout on tablets */\n  .crew-table-container {\n    overflow-x: auto;\n    -webkit-overflow-scrolling: touch;\n  }\n  \n  .crew-table-container table {\n    min-width: 800px;\n  }\n}\n\n/* Desktop status badge - keep single line */\n@media (min-width: 1024px) {\n  .mobile-status-text {\n    white-space: nowrap !important;\n    word-break: normal !important;\n    overflow-wrap: normal !important;\n  }\n}\n\n/* Table layout improvements for desktop and laptop */\n@media (min-width: 1024px) {\n  .crew-table-container {\n    overflow: visible;\n    margin: 0;\n    padding: 0;\n  }\n\n  /* Ensure table fits without scrolling with proper spacing */\n  .crew-table-container table {\n    table-layout: fixed;\n    width: 100%;\n    border-spacing: 0;\n  }\n\n  .crew-table-container thead th {\n    border-bottom: 1px solid hsl(var(--border));\n    background-color: hsl(var(--muted));\n  }\n\n  .crew-table-container tbody tr {\n    border-bottom: 1px solid hsl(var(--border));\n  }\n\n  .crew-table-container tbody tr:hover {\n    background-color: hsl(var(--accent) / 0.5);\n  }\n\n  /* Text overflow handling with tooltips */\n  .crew-table-container td span[title],\n  .crew-table-container td p[title] {\n    cursor: help;\n  }\n  \n  /* Better spacing for tablets */\n  .tablet-spacing {\n    padding: 1rem;\n  }\n  \n  /* Compact buttons for tablet view */\n  .tablet-btn {\n    height: 1.75rem;\n    width: 1.75rem;\n    padding: 0;\n  }\n}\n\n/* Prevent horizontal scroll issues */\n.responsive-container {\n  max-width: 100%;\n  overflow-x: hidden;\n}\n\n/* Better mobile card layout */\n@media (max-width: 1023px) {\n  .crew-card {\n    border: 1px solid hsl(var(--border));\n    border-radius: 0.5rem;\n    padding: 0.75rem;\n    background: hsl(var(--card));\n    width: 100%;\n    max-width: 100%;\n    overflow: hidden;\n    box-sizing: border-box;\n    margin: 0 auto;\n  }\n  \n  .crew-card:hover {\n    background: hsl(var(--accent) / 0.1);\n  }\n\n  /* Strict container constraints */\n  .crew-card,\n  .crew-card * {\n    max-width: 100%;\n    box-sizing: border-box;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n  }\n\n  /* Enhanced text overflow handling */\n  .crew-card .truncate {\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n    max-width: 100%;\n  }\n\n  /* Ensure grid items don't overflow */\n  .crew-card .grid > div {\n    min-width: 0;\n    overflow: hidden;\n  }\n\n  /* Mobile status badge with line wrapping - for both crew status and contract status */\n  .mobile-status-badge,\n  .crew-card .mobile-status-badge {\n    font-size: 9px !important;\n    line-height: 11px !important;\n    padding: 3px 5px !important;\n    max-width: 70px !important;\n    width: auto !important;\n    min-width: 55px !important;\n    min-height: 22px !important;\n    max-height: 28px !important;\n    overflow: visible !important;\n    display: inline-flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n    box-sizing: border-box !important;\n    border: none !important;\n    font-weight: 500 !important;\n    text-align: center !important;\n    border-radius: 4px !important;\n  }\n\n  /* Force text wrapping on mobile with explicit line breaks - for both crew and contract status */\n  .mobile-status-text,\n  .crew-card .mobile-status-text {\n    white-space: nowrap !important;\n    word-break: normal !important;\n    overflow-wrap: normal !important;\n    hyphens: none !important;\n    max-width: 100% !important;\n    display: inline-block !important;\n    text-align: center !important;\n    line-height: 11px !important;\n    font-size: 9px !important;\n  }\n\n  /* Container constraints for mobile badge */\n  .crew-card > div:first-child > div:last-child {\n    max-width: 48px !important;\n    width: 48px !important;\n    min-width: 48px !important;\n    flex-shrink: 0 !important;\n    flex-grow: 0 !important;\n  }\n\n  /* Button constraints */\n  .crew-card button {\n    font-size: 0.75rem;\n    white-space: nowrap;\n  }\n\n  /* Overall mobile container */\n  .lg\\\\:hidden {\n    max-width: 100vw;\n    overflow-x: hidden;\n  }\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n\n  /* Custom maritime-themed utility classes */\n  .maritime-navy {\n    color: var(--maritime-navy);\n  }\n  \n  .bg-maritime-navy {\n    background-color: var(--maritime-navy);\n  }\n  \n  .ocean-blue {\n    color: var(--ocean-blue);\n  }\n  \n  .bg-ocean-blue {\n    background-color: var(--ocean-blue);\n  }\n  \n  .warning-amber {\n    color: var(--warning-amber);\n  }\n  \n  /* Text visibility utility classes for dark/light theme */\n  .heading-text {\n    color: hsl(var(--foreground));\n  }\n  \n  .body-text {\n    color: hsl(var(--secondary-foreground));\n  }\n  \n  .muted-text {\n    color: hsl(var(--muted-foreground));\n  }\n  \n  .bg-warning-amber {\n    background-color: var(--warning-amber);\n  }\n  \n  .compliance-green {\n    color: var(--compliance-green);\n  }\n  \n  .bg-compliance-green {\n    background-color: var(--compliance-green);\n  }\n  \n  .text-navy {\n    color: var(--text-navy);\n  }\n  \n  .alert-red {\n    color: var(--alert-red);\n  }\n\n  /* Enhanced text visibility classes for dark theme */\n  .heading-text {\n    @apply text-foreground font-semibold;\n  }\n  \n  .body-text {\n    @apply text-secondary-foreground;\n  }\n  \n  .muted-text {\n    @apply text-muted-foreground;\n  }\n  \n  .link-text {\n    color: var(--ocean-blue);\n    @apply hover:underline;\n  }\n  \n  .error-text {\n    @apply text-destructive font-medium;\n  }\n\n  /* Icon visibility in dark mode */\n  .dark .icon-light {\n    @apply text-white;\n  }\n  \n  .dark .icon-accent {\n    color: var(--ocean-blue);\n  }\n  \n  .bg-alert-red {\n    background-color: var(--alert-red);\n  }\n  \n  .bg-light {\n    background-color: var(--light-bg);\n  }\n\n  /* Maritime-inspired animations */\n  .wave-animation {\n    animation: wave 2s ease-in-out infinite;\n  }\n  \n  @keyframes wave {\n    0%, 100% { transform: rotate(0deg); }\n    25% { transform: rotate(3deg); }\n    75% { transform: rotate(-3deg); }\n  }\n  \n  /* Card hover effects */\n  .maritime-card {\n    @apply transition-all duration-200 hover:shadow-lg hover:scale-[1.02];\n  }\n  \n  /* Status indicators */\n  .status-active {\n    @apply bg-compliance-green text-white;\n  }\n  \n  .status-expiring {\n    @apply bg-warning-amber text-white;\n  }\n  \n  .status-expired {\n    @apply bg-alert-red text-white;\n  }\n  \n  .status-warning {\n    @apply bg-orange-500 text-white;\n  }\n}\n\n/* Custom scrollbar */\n::-webkit-scrollbar {\n  width: 8px;\n}\n\n::-webkit-scrollbar-track {\n  background: hsl(var(--muted));\n}\n\n::-webkit-scrollbar-thumb {\n  background: hsl(var(--maritime-navy));\n  border-radius: 4px;\n}\n\n::-webkit-scrollbar-thumb:hover {\n  background: hsl(var(--ocean-blue));\n}\n\n/* Mobile responsive utilities and optimizations */\n@media (max-width: 768px) {\n  /* Prevent horizontal scrolling */\n  html, body {\n    overflow-x: hidden !important;\n    max-width: 100vw !important;\n    width: 100vw !important;\n  }\n  \n  * {\n    max-width: 100vw !important;\n    box-sizing: border-box !important;\n  }\n  \n  /* Mobile dialog optimizations */\n  [data-radix-dialog-content] {\n    margin: 0.5rem !important;\n    width: calc(100vw - 1rem) !important;\n    max-width: calc(100vw - 1rem) !important;\n    max-height: calc(100vh - 2rem) !important;\n  }\n  \n  /* Mobile form improvements */\n  .form-grid {\n    grid-template-columns: 1fr !important;\n    gap: 0.75rem !important;\n  }\n  \n  /* Mobile table improvements */\n  .data-table {\n    font-size: 0.875rem !important;\n  }\n  \n  .data-table th,\n  .data-table td {\n    padding: 0.5rem !important;\n  }\n  \n  /* Mobile button improvements */\n  .btn-mobile {\n    font-size: 0.875rem !important;\n    padding: 0.5rem 1rem !important;\n  }\n  \n  /* Mobile card layouts */\n  .mobile-card {\n    max-width: 100% !important;\n    word-wrap: break-word !important;\n    overflow-wrap: break-word !important;\n    box-sizing: border-box !important;\n  }\n  \n  /* Text wrapping and responsive typography */\n  h1 {\n    font-size: 1.5rem !important;\n    line-height: 1.4 !important;\n    word-wrap: break-word !important;\n    overflow-wrap: break-word !important;\n    hyphens: auto !important;\n  }\n  \n  h2 {\n    font-size: 1.25rem !important;\n    line-height: 1.4 !important;\n    word-wrap: break-word !important;\n    overflow-wrap: break-word !important;\n    hyphens: auto !important;\n  }\n  \n  h3 {\n    font-size: 1.125rem !important;\n    line-height: 1.4 !important;\n    word-wrap: break-word !important;\n    overflow-wrap: break-word !important;\n    hyphens: auto !important;\n  }\n  \n  p, span, div {\n    font-size: 0.875rem !important;\n    line-height: 1.5 !important;\n    word-wrap: break-word !important;\n    overflow-wrap: break-word !important;\n    hyphens: auto !important;\n  }\n  \n  /* Force container widths to respect viewport */\n  .container, .max-w-7xl, .max-w-6xl, .max-w-5xl, .max-w-4xl, .max-w-3xl, .max-w-2xl, .max-w-xl,\n  [data-radix-dialog-content], .card, [data-radix-card], .badge {\n    max-width: calc(100vw - 2rem) !important;\n    margin-left: auto !important;\n    margin-right: auto !important;\n    padding-left: 0.5rem !important;\n    padding-right: 0.5rem !important;\n    word-wrap: break-word !important;\n    overflow-wrap: break-word !important;\n    hyphens: auto !important;\n  }\n  \n  /* Specific fixes for badges and text elements */\n  .badge, [data-radix-badge] {\n    font-size: 0.625rem !important;\n    padding: 0.125rem 0.25rem !important;\n    max-width: fit-content !important;\n    white-space: nowrap !important;\n    overflow: hidden !important;\n    text-overflow: ellipsis !important;\n  }\n  \n  /* Card and component responsive adjustments */\n  .card, [data-radix-card] {\n    margin: 0.25rem !important;\n    padding: 0.5rem !important;\n    word-wrap: break-word !important;\n    overflow-wrap: break-word !important;\n    max-width: calc(100vw - 1rem) !important;\n    box-sizing: border-box !important;\n  }\n  \n  /* Remove complex table rules for mobile - using card layout instead */\n  \n  /* Force table cells to wrap text */\n  .table-cell-wrapper {\n    max-width: 100% !important;\n    overflow: hidden !important;\n    text-overflow: ellipsis !important;\n    white-space: nowrap !important;\n  }\n  \n  .table-cell-wrapper.wrap {\n    white-space: normal !important;\n    word-break: break-word !important;\n    overflow-wrap: break-word !important;\n  }\n  \n  /* Button and badge mobile adjustments */\n  .mobile-btn {\n    padding: 0.25rem !important;\n    font-size: 0.75rem !important;\n    min-width: 2rem !important;\n    height: 2rem !important;\n  }\n  \n  .mobile-badge {\n    font-size: 0.625rem !important;\n    padding: 0.125rem 0.25rem !important;\n  }\n}\n\n/* Tablet specific optimizations */\n@media (min-width: 768px) and (max-width: 1024px) {\n  .grid-responsive {\n    grid-template-columns: repeat(2, 1fr) !important;\n  }\n}\n\n/* Text truncation utilities */\n.line-clamp-2 {\n  display: -webkit-box;\n  -webkit-line-clamp: 2;\n  -webkit-box-orient: vertical;\n  overflow: hidden;\n}\n\n/* Print Styles for Calendar */\n@media print {\n  /* Hide everything except the calendar */\n  body * {\n    visibility: hidden !important;\n  }\n  \n  /* Show only the calendar card and its contents */\n  .space-y-6,\n  .space-y-6 *,\n  .space-y-6 > div:last-child,\n  .space-y-6 > div:last-child * {\n    visibility: visible !important;\n  }\n  \n  /* Hide specific unwanted elements */\n  .space-y-6 > div:first-child,\n  .space-y-6 > div:nth-child(2),\n  .print\\\\:hidden,\n  button,\n  .bg-muted,\n  .dialog-content,\n  .toast-container,\n  .hidden-print {\n    visibility: hidden !important;\n    display: none !important;\n  }\n\n  /* Show only essential content */\n  body {\n    font-family: 'Times New Roman', serif !important;\n    font-size: 12pt !important;\n    color: #000 !important;\n    background: white !important;\n    margin: 0;\n    padding: 20px;\n  }\n\n  /* Page settings */\n  @page {\n    margin: 0.5in;\n    size: letter landscape;\n  }\n\n  /* Calendar container styling */\n  .space-y-6 > div:first-child {\n    margin-bottom: 20px;\n    border-bottom: 2px solid #000;\n    padding-bottom: 10px;\n  }\n\n  /* Stats cards - hide in print */\n  .grid.grid-cols-1.md\\\\:grid-cols-3 {\n    display: none !important;\n  }\n\n  /* Calendar card */\n  .space-y-6 > div:last-child {\n    box-shadow: none !important;\n    border: 1px solid #000;\n  }\n\n  /* Calendar header */\n  h2 {\n    font-size: 18pt !important;\n    font-weight: bold !important;\n    color: #000 !important;\n    margin-bottom: 10px !important;\n  }\n\n  /* Calendar grid */\n  .calendar-grid {\n    width: 100% !important;\n    border-collapse: collapse !important;\n  }\n\n  /* Calendar cells */\n  .calendar-day,\n  .calendar-cell {\n    border: 1px solid #000 !important;\n    padding: 8px 4px !important;\n    height: 80px !important;\n    vertical-align: top !important;\n    background: white !important;\n    color: #000 !important;\n    font-size: 10pt !important;\n    page-break-inside: avoid;\n  }\n\n  /* Calendar day numbers */\n  .calendar-day-number,\n  .day-number {\n    font-weight: bold !important;\n    font-size: 12pt !important;\n    color: #000 !important;\n    margin-bottom: 2px !important;\n  }\n\n  /* Calendar events */\n  .calendar-event,\n  .rotation-event {\n    background: none !important;\n    border: 1px solid #000 !important;\n    color: #000 !important;\n    font-size: 8pt !important;\n    padding: 1px 2px !important;\n    margin: 1px 0 !important;\n    border-radius: 0 !important;\n    display: block !important;\n    word-wrap: break-word;\n  }\n\n  /* Month navigation - hide */\n  .calendar-nav,\n  .month-nav {\n    display: none !important;\n  }\n\n  /* Table styles for list view */\n  table {\n    width: 100% !important;\n    border-collapse: collapse !important;\n    font-size: 10pt !important;\n  }\n\n  th, td {\n    border: 1px solid #000 !important;\n    padding: 4px 6px !important;\n    text-align: left !important;\n    color: #000 !important;\n    background: white !important;\n  }\n\n  th {\n    font-weight: bold !important;\n    background: #f0f0f0 !important;\n  }\n\n  /* Badge styles */\n  .badge {\n    border: 1px solid #000 !important;\n    background: white !important;\n    color: #000 !important;\n    padding: 1px 4px !important;\n    font-size: 8pt !important;\n  }\n\n  /* Add print timestamp */\n  .space-y-6::after {\n    content: \"Printed on: \" date() \" - Crew Management System\";\n    display: block;\n    margin-top: 20px;\n    font-size: 9pt;\n    color: #666;\n    text-align: right;\n    border-top: 1px solid #ccc;\n    padding-top: 10px;\n  }\n\n  /* Ensure colors are preserved */\n  * {\n    -webkit-print-color-adjust: exact !important;\n    print-color-adjust: exact !important;\n  }\n\n  /* Page break controls */\n  .page-break-before {\n    page-break-before: always;\n  }\n\n  .page-break-after {\n    page-break-after: always;\n  }\n\n  /* Hide slider, scroll, input, and progress elements in print */\n  input,\n  [role=\"slider\"],\n  [role=\"progressbar\"],\n  [data-radix-scroll-area-scrollbar],\n  [data-radix-scroll-area-thumb],\n  [data-radix-progress-indicator],\n  .scrollbar,\n  ::-webkit-scrollbar,\n  ::-webkit-scrollbar-thumb,\n  ::-webkit-scrollbar-track,\n  progress,\n  .progress,\n  [class*=\"progress\"],\n  [class*=\"Progress\"] {\n    display: none !important;\n    visibility: hidden !important;\n  }\n\n  /* Hide dialog overlays in print */\n  [data-radix-dialog-overlay],\n  [data-radix-dialog-content],\n  [role=\"dialog\"] {\n    display: none !important;\n    visibility: hidden !important;\n  }\n\n  .no-page-break {\n    page-break-inside: avoid;\n  }\n}\n","path":null,"size_bytes":21249,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"deploy.sh":{"content":"#!/bin/bash\n\n# CrewTrack Pro - Production Deployment Script\n# This script prepares the application for production deployment\n\necho \"üö¢ Preparing CrewTrack Pro for production deployment...\"\n\n# Create deployment directory\nmkdir -p deployment\ncd deployment\n\n# Copy essential files\necho \"üìÅ Copying application files...\"\n\n# Copy backend files\ncp -r ../server ./\ncp -r ../shared ./\ncp ../package.json ./\ncp ../package-lock.json ./\ncp ../drizzle.config.ts ./\ncp ../tsconfig.json ./\ncp ../eng.traineddata ./\n\n# Copy frontend build\nif [ -d \"../dist\" ]; then\n    cp -r ../dist ./\n    echo \"‚úÖ Frontend build files copied\"\nelse\n    echo \"‚ùå Frontend build not found. Run 'npm run build' first\"\n    exit 1\nfi\n\n# Create environment template\necho \"üìÑ Creating environment template...\"\ncat > .env.example << EOF\n# Database Configuration\nDATABASE_URL=\"postgresql://username:password@host:port/database_name\"\nPGHOST=your_host\nPGPORT=5432\nPGUSER=your_username\nPGPASSWORD=your_password\nPGDATABASE=your_database_name\n\n# Node Environment\nNODE_ENV=production\nPORT=3000\n\n# Optional: OpenAI API Key\nOPENAI_API_KEY=your_openai_key_if_needed\nEOF\n\n# Create production package.json with only production dependencies\necho \"üì¶ Creating production package.json...\"\nnode -e \"\nconst pkg = require('../package.json');\nconst prodPkg = {\n  name: pkg.name,\n  version: pkg.version,\n  description: pkg.description,\n  main: 'server/index.js',\n  scripts: {\n    start: 'node server/index.js',\n    'db:push': 'drizzle-kit push'\n  },\n  dependencies: {\n    '@neondatabase/serverless': pkg.dependencies['@neondatabase/serverless'],\n    'drizzle-orm': pkg.dependencies['drizzle-orm'],\n    'drizzle-kit': pkg.dependencies['drizzle-kit'],\n    'express': pkg.dependencies['express'],\n    'express-session': pkg.dependencies['express-session'],\n    'tsx': pkg.dependencies['tsx'],\n    'typescript': pkg.dependencies['typescript'],\n    'tesseract.js': pkg.dependencies['tesseract.js'],\n    'sharp': pkg.dependencies['sharp'],\n    'zod': pkg.dependencies['zod'],\n    'ws': pkg.dependencies['ws']\n  }\n};\nconsole.log(JSON.stringify(prodPkg, null, 2));\n\" > package.json\n\n# Create start script\necho \"üöÄ Creating start script...\"\ncat > start.js << EOF\nconst express = require('express');\nconst path = require('path');\n\n// Import your server\nrequire('./server/index.js');\n\nconsole.log('CrewTrack Pro started successfully!');\nconsole.log('Environment:', process.env.NODE_ENV);\nconsole.log('Port:', process.env.PORT || 3000);\nEOF\n\n# Update server to serve static files in production\necho \"üîß Configuring production server...\"\ncat > server/static.js << EOF\nconst express = require('express');\nconst path = require('path');\n\nmodule.exports = function configureStatic(app) {\n  if (process.env.NODE_ENV === 'production') {\n    // Serve static files from dist directory\n    app.use(express.static(path.join(__dirname, '../dist')));\n    \n    // Handle client-side routing\n    app.get('*', (req, res, next) => {\n      // Skip API routes\n      if (req.path.startsWith('/api/')) {\n        return next();\n      }\n      res.sendFile(path.join(__dirname, '../dist/index.html'));\n    });\n  }\n};\nEOF\n\n# Create README for deployment\necho \"üìñ Creating deployment README...\"\ncat > README.md << EOF\n# CrewTrack Pro - Production Deployment\n\nThis directory contains the production-ready version of CrewTrack Pro.\n\n## Quick Start\n\n1. Upload all files to your hosting server\n2. Copy .env.example to .env and configure your database\n3. Run: npm install --production\n4. Run: npm run db:push\n5. Start: npm start\n\n## Files Included\n\n- server/ - Backend Node.js application\n- dist/ - Frontend React application (built)\n- shared/ - Shared schema and types\n- package.json - Production dependencies only\n- .env.example - Environment configuration template\n\n## Database Setup\n\nThis application requires PostgreSQL. Update your .env file with your database credentials.\n\n## For detailed deployment instructions, see DEPLOYMENT_GUIDE.md\nEOF\n\n# Create zip file for easy download\necho \"üì¶ Creating deployment package...\"\ncd ..\nzip -r crewtrack-pro-production.zip deployment/ -x \"*.DS_Store\" \"*/node_modules/*\"\n\necho \"\"\necho \"‚úÖ Production deployment package created successfully!\"\necho \"\"\necho \"üìÅ Files ready in: ./deployment/\"\necho \"üì¶ Download package: ./crewtrack-pro-production.zip\"\necho \"\"\necho \"Next steps:\"\necho \"1. Download the zip file\"\necho \"2. Upload to your Hostinger hosting\"\necho \"3. Follow the DEPLOYMENT_GUIDE.md instructions\"\necho \"\"\necho \"üö¢ Ready to sail with CrewTrack Pro!\"","path":null,"size_bytes":4525,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"server/services/notification-service.ts":{"content":"import { WhatsAppNotificationService, type WhatsAppMessage } from './whatsapp-notification';\nimport { smtpEmailService, sendCDCExpiryAlert, sendPassportExpiryAlert, sendCOCExpiryAlert, sendMedicalExpiryAlert, type CDCExpiryAlertData, type PassportExpiryAlertData, type COCExpiryAlertData, type MedicalExpiryAlertData } from './smtp-email-service';\nimport { storage } from '../storage';\nimport { whatsappSettings } from '@shared/schema';\n\n// Document expiry alert schedule (in days before expiry)\n// Alerts are sent at 60, 30, 15, and 7 days before expiry\n// After 15 days, daily reminders are sent until the document is updated\nconst DOCUMENT_REMINDER_DAYS = [60, 30, 15, 7];\nconst DAILY_REMINDER_THRESHOLD = 15; // Start daily reminders when <= 15 days remaining\n\ntype WhatsappSettings = typeof whatsappSettings.$inferSelect;\n\nexport interface UpcomingEvent {\n  id: string;\n  type: 'contract_expiry' | 'document_expiry' | 'crew_join' | 'crew_leave' | 'maintenance_completion';\n  title: string;\n  description: string;\n  date: Date;\n  severity: 'success' | 'info' | 'warning' | 'high';\n  crewMemberId?: string;\n  vesselId?: string;\n  contractId?: string;\n  documentId?: string;\n  documentType?: string;\n  documentNumber?: string;\n  issuingAuthority?: string;\n  rotationId?: string;\n  crewMemberName?: string;\n  crewMemberRank?: string;\n  crewMemberNationality?: string;\n  vesselName?: string;\n}\n\nexport class NotificationService {\n  private whatsappService: WhatsAppNotificationService | null = null;\n  private readonly maxRetries = 3;\n  private readonly retryDelayMs = 5000; // 5 seconds\n  private defaultFromEmail = 'noreply@crewtrack.com'; // You can customize this\n  \n  async initialize() {\n    try {\n      console.log('üîÑ Initializing notification service...');\n      const settings = await storage.getWhatsappSettings();\n      \n      if (settings) {\n        this.whatsappService = new WhatsAppNotificationService(settings);\n        \n        if (this.whatsappService.isConfigured()) {\n          console.log(`‚úÖ WhatsApp notification service initialized with provider: ${settings.provider}`);\n        } else {\n          console.log('‚ö†Ô∏è  WhatsApp service initialized but not properly configured');\n        }\n      } else {\n        console.log('‚ÑπÔ∏è  No WhatsApp settings found - notifications disabled');\n        this.whatsappService = null;\n      }\n    } catch (error) {\n      console.error('‚ùå Failed to initialize notification service:', error);\n      this.whatsappService = null;\n      \n      // Log the initialization error\n      try {\n        await storage.logNotification({\n          eventId: 'system-init',\n          eventType: 'system_error',\n          eventDate: new Date(),\n          notificationDate: new Date(),\n          daysBeforeEvent: 0,\n          provider: 'system',\n          success: false,\n          errorMessage: error instanceof Error ? error.message : 'Unknown initialization error',\n          retryCount: 0,\n          metadata: {\n            action: 'service_initialization',\n            error: error instanceof Error ? error.stack : String(error),\n          }\n        });\n      } catch (logError) {\n        console.error('‚ùå Failed to log initialization error:', logError);\n      }\n    }\n  }\n\n  async sendEventNotifications(events: UpcomingEvent[]): Promise<void> {\n    const [whatsappSettings, emailSettings] = await Promise.all([\n      storage.getWhatsappSettings(),\n      storage.getEmailSettings()\n    ]);\n\n    const now = new Date();\n\n    // Determine which notification methods are available\n    const whatsappEnabled = whatsappSettings?.enabled && this.whatsappService?.isConfigured();\n    // Use Gmail SMTP instead of SendGrid\n    const emailEnabled = emailSettings?.enabled && smtpEmailService.isReady();\n\n    if (!whatsappEnabled && !emailEnabled) {\n      console.log('No notification methods configured (WhatsApp and Email both disabled)');\n      return;\n    }\n\n    console.log(`üìß Notification methods available: WhatsApp: ${whatsappEnabled ? '‚úÖ' : '‚ùå'}, Email: ${emailEnabled ? '‚úÖ' : '‚ùå'}`);\n\n    // Default reminder days for general events\n    const defaultReminderDays = (emailSettings?.reminderDays || whatsappSettings?.reminderDays || [7, 15, 30]) as number[];\n\n    for (const event of events) {\n      // Check if this event should trigger a notification\n      const daysUntilEvent = Math.ceil((event.date.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n      \n      // Check if this is a document or contract expiry that needs special handling\n      const isCDC = event.type === 'document_expiry' && event.documentType?.toLowerCase() === 'cdc';\n      const isPassport = event.type === 'document_expiry' && event.documentType?.toLowerCase() === 'passport';\n      const isCOC = event.type === 'document_expiry' && (event.documentType?.toLowerCase() === 'coc' || event.documentType?.toLowerCase() === 'stcw');\n      const docTypeLower = event.documentType?.toLowerCase() || '';\n      const isMedical = event.type === 'document_expiry' && (docTypeLower === 'medical' || docTypeLower === 'medical certificate' || docTypeLower.includes('medical'));\n      const isContract = event.type === 'contract_expiry';\n      const isImportantDocument = isCDC || isPassport || isCOC || isMedical || isContract;\n      \n      const reminderDays = isImportantDocument ? DOCUMENT_REMINDER_DAYS : defaultReminderDays;\n      \n      // Check if we should send a notification\n      let shouldSendNotification = false;\n      let notificationType = 'standard'; // 'standard' or 'daily_reminder'\n      \n      if (reminderDays.includes(daysUntilEvent)) {\n        // Standard milestone notification (60, 30, 15, or 7 days)\n        shouldSendNotification = true;\n        notificationType = 'standard';\n        console.log(`üìã Processing milestone notification for ${event.crewMemberName} - ${daysUntilEvent} days`);\n      } else if (isImportantDocument && daysUntilEvent <= DAILY_REMINDER_THRESHOLD && daysUntilEvent > 0) {\n        // Daily reminder for documents/contracts with <= 15 days remaining\n        // Check if we already sent a daily reminder today\n        const todayStr = now.toISOString().split('T')[0]; // YYYY-MM-DD format\n        const alreadySentToday = await storage.hasNotificationBeenSentToday(\n          event.id,\n          event.type,\n          'email',\n          todayStr\n        );\n        \n        if (!alreadySentToday) {\n          shouldSendNotification = true;\n          notificationType = 'daily_reminder';\n          console.log(`üìã Processing daily reminder for ${event.crewMemberName} - ${daysUntilEvent} days remaining`);\n        } else {\n          console.log(`üîÑ Skipping daily reminder for ${event.crewMemberName} - already sent today`);\n        }\n      }\n      \n      if (shouldSendNotification) {\n        // Send WhatsApp notification if enabled\n        if (whatsappEnabled) {\n          await this.sendWhatsAppNotification(event, daysUntilEvent, now);\n        }\n\n        // Send Email notification if enabled\n        if (emailEnabled && emailSettings) {\n          await this.sendEmailNotification(event, daysUntilEvent, now, emailSettings);\n        }\n      }\n    }\n  }\n\n  private async sendWhatsAppNotification(event: UpcomingEvent, daysUntilEvent: number, now: Date): Promise<void> {\n    const provider = 'whatsapp';\n    \n    // Check if notification has already been sent for this event and reminder period\n    const alreadySent = await storage.hasNotificationBeenSent(\n      event.id,\n      event.type,\n      daysUntilEvent,\n      provider\n    );\n\n    if (alreadySent) {\n      console.log(`üîÑ Skipping duplicate WhatsApp notification for event: ${event.title} (${daysUntilEvent} days before)`);\n      return;\n    }\n\n    const message: WhatsAppMessage = {\n      title: event.title,\n      description: event.description,\n      date: event.date.toLocaleDateString(),\n      severity: event.severity,\n      eventType: event.type,\n      crewMemberName: event.crewMemberName,\n      vesselName: event.vesselName,\n    };\n\n    let notificationId: string | null = null;\n    \n    try {\n      // Log the notification attempt before sending\n      const notificationRecord = await storage.logNotification({\n        eventId: event.id,\n        eventType: event.type,\n        eventDate: event.date,\n        notificationDate: now,\n        daysBeforeEvent: daysUntilEvent,\n        provider: provider,\n        success: false, // Will update to true if successful\n        retryCount: 0,\n        metadata: {\n          eventTitle: event.title,\n          crewMemberName: event.crewMemberName,\n          vesselName: event.vesselName,\n          severity: event.severity,\n        }\n      });\n      \n      notificationId = notificationRecord.id;\n\n      // Attempt to send the notification\n      const success = await this.whatsappService!.sendEventNotification(message);\n      \n      if (success) {\n        // Update notification record as successful\n        await storage.updateNotificationStatus(notificationId, true);\n        console.log(`‚úÖ WhatsApp notification sent for event: ${event.title} (${daysUntilEvent} days before)`);\n      } else {\n        // Update notification record with failure\n        await storage.updateNotificationStatus(\n          notificationId, \n          false, \n          'Failed to send notification - provider returned false',\n          1\n        );\n        console.error(`‚ùå Failed to send WhatsApp notification for event: ${event.title}`);\n      }\n    } catch (error) {\n      console.error(`‚ùå Error sending WhatsApp notification for event: ${event.title}:`, error);\n      \n      // Update notification record with error\n      if (notificationId) {\n        const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';\n        await storage.updateNotificationStatus(\n          notificationId, \n          false, \n          errorMessage,\n          1\n        );\n      }\n    }\n  }\n\n  private async sendEmailNotification(event: UpcomingEvent, daysUntilEvent: number, now: Date, emailSettings: any): Promise<void> {\n    const provider = 'email';\n    \n    // Check if notification has already been sent for this event and reminder period\n    const alreadySent = await storage.hasNotificationBeenSent(\n      event.id,\n      event.type,\n      daysUntilEvent,\n      provider\n    );\n\n    if (alreadySent) {\n      console.log(`üîÑ Skipping duplicate email notification for event: ${event.title} (${daysUntilEvent} days before)`);\n      return;\n    }\n\n    let notificationId: string | null = null;\n    \n    try {\n      // Log the notification attempt before sending\n      const notificationRecord = await storage.logNotification({\n        eventId: event.id,\n        eventType: event.type,\n        eventDate: event.date,\n        notificationDate: now,\n        daysBeforeEvent: daysUntilEvent,\n        provider: provider,\n        success: false, // Will update to true if successful\n        retryCount: 0,\n        metadata: {\n          eventTitle: event.title,\n          crewMemberName: event.crewMemberName,\n          vesselName: event.vesselName,\n          severity: event.severity,\n          documentType: event.documentType,\n        }\n      });\n      \n      notificationId = notificationRecord.id;\n\n      let success = false;\n      const recipientEmail = emailSettings.recipientEmail || 'admin@offing.biz';\n\n      // Handle CDC document expiry with special template\n      if (event.type === 'document_expiry' && event.documentType?.toLowerCase() === 'cdc') {\n        // Use CDC-specific email template\n        const cdcData: CDCExpiryAlertData = {\n          crewMemberName: event.crewMemberName || 'Unknown',\n          vesselName: event.vesselName,\n          cdcNumber: event.documentNumber || 'N/A',\n          issuingAuthority: event.issuingAuthority || 'N/A',\n          expiryDate: event.date,\n          daysUntilExpiry: daysUntilEvent,\n          crewMemberRank: event.crewMemberRank,\n          crewMemberNationality: event.crewMemberNationality,\n        };\n        success = await sendCDCExpiryAlert(recipientEmail, cdcData);\n      } else if (event.type === 'document_expiry' && event.documentType?.toLowerCase() === 'passport') {\n        // Use Passport-specific email template\n        const passportData: PassportExpiryAlertData = {\n          crewMemberName: event.crewMemberName || 'Unknown',\n          vesselName: event.vesselName,\n          passportNumber: event.documentNumber || 'N/A',\n          issuingAuthority: event.issuingAuthority || 'N/A',\n          expiryDate: event.date,\n          daysUntilExpiry: daysUntilEvent,\n          crewMemberRank: event.crewMemberRank,\n          crewMemberNationality: event.crewMemberNationality,\n        };\n        success = await sendPassportExpiryAlert(recipientEmail, passportData);\n      } else if (event.type === 'document_expiry' && (event.documentType?.toLowerCase() === 'coc' || event.documentType?.toLowerCase() === 'stcw')) {\n        // Use COC-specific email template\n        const cocData: COCExpiryAlertData = {\n          crewMemberName: event.crewMemberName || 'Unknown',\n          vesselName: event.vesselName,\n          cocNumber: event.documentNumber || 'N/A',\n          issuingAuthority: event.issuingAuthority || 'N/A',\n          expiryDate: event.date,\n          daysUntilExpiry: daysUntilEvent,\n          crewMemberRank: event.crewMemberRank,\n          crewMemberNationality: event.crewMemberNationality,\n        };\n        success = await sendCOCExpiryAlert(recipientEmail, cocData);\n      } else if (event.type === 'document_expiry' && (event.documentType?.toLowerCase() === 'medical' || event.documentType?.toLowerCase() === 'medical certificate' || event.documentType?.toLowerCase().includes('medical'))) {\n        // Use Medical Certificate-specific email template\n        const medicalData: MedicalExpiryAlertData = {\n          crewMemberName: event.crewMemberName || 'Unknown',\n          vesselName: event.vesselName,\n          medicalNumber: event.documentNumber || 'N/A',\n          issuingAuthority: event.issuingAuthority || 'N/A',\n          expiryDate: event.date,\n          daysUntilExpiry: daysUntilEvent,\n          crewMemberRank: event.crewMemberRank,\n          crewMemberNationality: event.crewMemberNationality,\n        };\n        success = await sendMedicalExpiryAlert(recipientEmail, medicalData);\n      } else {\n        // Generic email template for other event types\n        const emailContent = {\n          subject: `üîî ${event.title} - ${daysUntilEvent} days`,\n          html: `\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n              <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n                <h2 style=\"color: #1e3a5f; margin: 0 0 20px 0;\">${event.title}</h2>\n                <p style=\"color: #374151; line-height: 1.6;\"><strong>Description:</strong> ${event.description}</p>\n                <p style=\"color: #374151; line-height: 1.6;\"><strong>Date:</strong> ${event.date.toLocaleDateString()}</p>\n                <p style=\"color: #374151; line-height: 1.6;\"><strong>Days Remaining:</strong> ${daysUntilEvent} days</p>\n                <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;\">\n                <p style=\"color: #6b7280; font-size: 12px;\">This is an automated notification from your Crew Management System</p>\n              </div>\n            </div>\n          `,\n        };\n        success = await smtpEmailService.sendEmail({\n          to: recipientEmail,\n          subject: emailContent.subject,\n          html: emailContent.html,\n        });\n      }\n      \n      if (success) {\n        // Update notification record as successful\n        await storage.updateNotificationStatus(notificationId, true);\n        console.log(`‚úÖ Email notification sent for event: ${event.title} (${daysUntilEvent} days before)`);\n      } else {\n        // Update notification record with failure\n        await storage.updateNotificationStatus(\n          notificationId, \n          false, \n          'Failed to send email notification via Gmail SMTP',\n          1\n        );\n        console.error(`‚ùå Failed to send email notification for event: ${event.title}`);\n      }\n    } catch (error) {\n      console.error(`‚ùå Error sending email notification for event: ${event.title}:`, error);\n      \n      // Update notification record with error\n      if (notificationId) {\n        const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';\n        await storage.updateNotificationStatus(\n          notificationId, \n          false, \n          errorMessage,\n          1\n        );\n      }\n    }\n  }\n\n  /**\n   * Send immediate document expiry alert when a document is created/updated with expiry within 30 days\n   * This bypasses the standard scheduler for urgent notifications\n   */\n  async sendImmediateDocumentAlert(\n    document: { id: string; type: string; expiryDate: Date | null; documentNumber?: string | null; issuingAuthority?: string | null },\n    crewMember: { id: string; name: string; rank?: string | null; nationality?: string | null },\n    vesselName?: string\n  ): Promise<boolean> {\n    try {\n      if (!document.expiryDate) return false;\n\n      const now = new Date();\n      const daysUntilExpiry = Math.ceil((new Date(document.expiryDate).getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n\n      // Only send immediate alert if expiry is within 30 days but not expired\n      if (daysUntilExpiry > 30 || daysUntilExpiry <= 0) {\n        return false;\n      }\n\n      console.log(`üö® Immediate alert triggered: ${crewMember.name}'s ${document.type} expires in ${daysUntilExpiry} days`);\n\n      const emailSettings = await storage.getEmailSettings();\n      if (!emailSettings?.enabled || !smtpEmailService.isReady()) {\n        console.log('‚ö†Ô∏è Email notifications not enabled - skipping immediate document alert');\n        return false;\n      }\n\n      const recipientEmail = emailSettings.recipientEmail || 'admin@offing.biz';\n      const docType = document.type.toLowerCase();\n      let success = false;\n\n      if (docType === 'cdc') {\n        const cdcData: CDCExpiryAlertData = {\n          crewMemberName: crewMember.name,\n          vesselName,\n          cdcNumber: document.documentNumber || 'N/A',\n          issuingAuthority: document.issuingAuthority || 'N/A',\n          expiryDate: document.expiryDate,\n          daysUntilExpiry,\n          crewMemberRank: crewMember.rank || undefined,\n          crewMemberNationality: crewMember.nationality || undefined,\n        };\n        const result = await sendCDCExpiryAlert(recipientEmail, cdcData);\n        success = result.success;\n      } else if (docType === 'passport') {\n        const passportData: PassportExpiryAlertData = {\n          crewMemberName: crewMember.name,\n          vesselName,\n          passportNumber: document.documentNumber || 'N/A',\n          issuingAuthority: document.issuingAuthority || 'N/A',\n          expiryDate: document.expiryDate,\n          daysUntilExpiry,\n          crewMemberRank: crewMember.rank || undefined,\n          crewMemberNationality: crewMember.nationality || undefined,\n        };\n        const result = await sendPassportExpiryAlert(recipientEmail, passportData);\n        success = result.success;\n      } else if (docType === 'coc' || docType === 'stcw') {\n        const cocData: COCExpiryAlertData = {\n          crewMemberName: crewMember.name,\n          vesselName,\n          cocNumber: document.documentNumber || 'N/A',\n          issuingAuthority: document.issuingAuthority || 'N/A',\n          expiryDate: document.expiryDate,\n          daysUntilExpiry,\n          crewMemberRank: crewMember.rank || undefined,\n          crewMemberNationality: crewMember.nationality || undefined,\n        };\n        const result = await sendCOCExpiryAlert(recipientEmail, cocData);\n        success = result.success;\n      } else if (docType === 'medical' || docType === 'medical certificate' || docType.includes('medical')) {\n        const medicalData: MedicalExpiryAlertData = {\n          crewMemberName: crewMember.name,\n          vesselName,\n          medicalNumber: document.documentNumber || 'N/A',\n          issuingAuthority: document.issuingAuthority || 'N/A',\n          expiryDate: document.expiryDate,\n          daysUntilExpiry,\n          crewMemberRank: crewMember.rank || undefined,\n          crewMemberNationality: crewMember.nationality || undefined,\n        };\n        const result = await sendMedicalExpiryAlert(recipientEmail, medicalData);\n        success = result.success;\n      } else {\n        // Generic document alert\n        const emailContent = {\n          subject: `üö® URGENT: ${crewMember.name}'s ${document.type} expires in ${daysUntilExpiry} days`,\n          html: `\n            <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n              <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n                <h2 style=\"color: #dc2626; margin: 0 0 20px 0;\">üö® Urgent Document Expiry Alert</h2>\n                <p style=\"color: #374151; line-height: 1.6;\"><strong>Crew Member:</strong> ${crewMember.name}</p>\n                <p style=\"color: #374151; line-height: 1.6;\"><strong>Document Type:</strong> ${document.type}</p>\n                <p style=\"color: #374151; line-height: 1.6;\"><strong>Document Number:</strong> ${document.documentNumber || 'N/A'}</p>\n                <p style=\"color: #374151; line-height: 1.6;\"><strong>Expiry Date:</strong> ${document.expiryDate.toLocaleDateString()}</p>\n                <p style=\"color: #dc2626; line-height: 1.6; font-weight: bold;\"><strong>Days Remaining:</strong> ${daysUntilExpiry} days</p>\n                <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;\">\n                <p style=\"color: #6b7280; font-size: 12px;\">This document was just uploaded/updated and requires immediate attention.</p>\n              </div>\n            </div>\n          `,\n        };\n        const result = await smtpEmailService.sendEmail({\n          to: recipientEmail,\n          subject: emailContent.subject,\n          html: emailContent.html,\n        });\n        success = result.success;\n      }\n\n      // Log the immediate notification\n      await storage.logNotification({\n        eventId: `immediate-doc-${document.id}`,\n        eventType: 'document_expiry',\n        eventDate: document.expiryDate,\n        notificationDate: now,\n        daysBeforeEvent: daysUntilExpiry,\n        provider: 'email',\n        success,\n        errorMessage: success ? undefined : 'Failed to send immediate document alert',\n        retryCount: 0,\n        metadata: {\n          documentType: document.type,\n          crewMemberName: crewMember.name,\n          vesselName,\n          immediate: true,\n        }\n      });\n\n      if (success) {\n        console.log(`‚úÖ Immediate document alert sent for ${crewMember.name}'s ${document.type}`);\n      } else {\n        console.error(`‚ùå Failed to send immediate document alert for ${crewMember.name}'s ${document.type}`);\n      }\n\n      return success;\n    } catch (error) {\n      console.error('‚ùå Error sending immediate document alert:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Send immediate contract expiry alert when a contract is created/updated with end date within 30 days\n   * This bypasses the standard scheduler for urgent notifications\n   */\n  async sendImmediateContractAlert(\n    contract: { id: string; endDate: Date | null; status?: string | null },\n    crewMember: { id: string; name: string; rank?: string | null; nationality?: string | null },\n    vesselName?: string\n  ): Promise<boolean> {\n    try {\n      if (!contract.endDate) return false;\n\n      const now = new Date();\n      const daysUntilExpiry = Math.ceil((new Date(contract.endDate).getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n\n      // Only send immediate alert if expiry is within 30 days but not expired\n      if (daysUntilExpiry > 30 || daysUntilExpiry <= 0) {\n        return false;\n      }\n\n      console.log(`üö® Immediate alert triggered: ${crewMember.name}'s contract expires in ${daysUntilExpiry} days`);\n\n      const emailSettings = await storage.getEmailSettings();\n      if (!emailSettings?.enabled || !smtpEmailService.isReady()) {\n        console.log('‚ö†Ô∏è Email notifications not enabled - skipping immediate contract alert');\n        return false;\n      }\n\n      const recipientEmail = emailSettings.recipientEmail || 'admin@offing.biz';\n\n      const emailContent = {\n        subject: `üö® URGENT: ${crewMember.name}'s Contract expires in ${daysUntilExpiry} days`,\n        html: `\n          <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n            <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n              <h2 style=\"color: #dc2626; margin: 0 0 20px 0;\">üö® Urgent Contract Due Alert</h2>\n              <p style=\"color: #374151; line-height: 1.6;\"><strong>Crew Member:</strong> ${crewMember.name}</p>\n              ${crewMember.rank ? `<p style=\"color: #374151; line-height: 1.6;\"><strong>Rank:</strong> ${crewMember.rank}</p>` : ''}\n              ${vesselName ? `<p style=\"color: #374151; line-height: 1.6;\"><strong>Vessel:</strong> ${vesselName}</p>` : ''}\n              <p style=\"color: #374151; line-height: 1.6;\"><strong>Contract Status:</strong> ${contract.status || 'Active'}</p>\n              <p style=\"color: #374151; line-height: 1.6;\"><strong>Contract End Date:</strong> ${contract.endDate.toLocaleDateString()}</p>\n              <p style=\"color: #dc2626; line-height: 1.6; font-weight: bold;\"><strong>Days Remaining:</strong> ${daysUntilExpiry} days</p>\n              <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 20px 0;\">\n              <p style=\"color: #6b7280; font-size: 12px;\">This contract was just created/updated and requires immediate attention for renewal planning.</p>\n            </div>\n          </div>\n        `,\n      };\n\n      const result = await smtpEmailService.sendEmail({\n        to: recipientEmail,\n        subject: emailContent.subject,\n        html: emailContent.html,\n      });\n      const success = result.success;\n\n      // Log the immediate notification\n      await storage.logNotification({\n        eventId: `immediate-contract-${contract.id}`,\n        eventType: 'contract_expiry',\n        eventDate: contract.endDate,\n        notificationDate: now,\n        daysBeforeEvent: daysUntilExpiry,\n        provider: 'email',\n        success,\n        errorMessage: success ? undefined : 'Failed to send immediate contract alert',\n        retryCount: 0,\n        metadata: {\n          crewMemberName: crewMember.name,\n          vesselName,\n          immediate: true,\n        }\n      });\n\n      if (success) {\n        console.log(`‚úÖ Immediate contract alert sent for ${crewMember.name}'s contract`);\n      } else {\n        console.error(`‚ùå Failed to send immediate contract alert for ${crewMember.name}'s contract`);\n      }\n\n      return success;\n    } catch (error) {\n      console.error('‚ùå Error sending immediate contract alert:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Retry failed notifications with exponential backoff\n   */\n  async retryFailedNotifications(): Promise<void> {\n    try {\n      console.log('üîÑ Checking for failed notifications to retry...');\n      const failedNotifications = await storage.getFailedNotifications(this.maxRetries);\n      \n      if (failedNotifications.length === 0) {\n        console.log('‚úÖ No failed notifications to retry');\n        return;\n      }\n\n      console.log(`üìã Found ${failedNotifications.length} failed notifications to retry`);\n\n      for (const notification of failedNotifications) {\n        try {\n          // Wait before retrying (simple exponential backoff)\n          const retryDelay = this.retryDelayMs * Math.pow(2, notification.retryCount || 0);\n          await new Promise(resolve => setTimeout(resolve, Math.min(retryDelay, 30000))); // Max 30 seconds\n\n          // Reconstruct the event message\n          const metadata = notification.metadata as any;\n          const message: WhatsAppMessage = {\n            title: metadata?.eventTitle || 'Event Notification',\n            description: `Retry notification for ${notification.eventType}`,\n            date: notification.eventDate.toLocaleDateString(),\n            severity: metadata?.severity || 'info',\n            eventType: notification.eventType,\n            crewMemberName: metadata?.crewMemberName,\n            vesselName: metadata?.vesselName,\n          };\n\n          if (this.whatsappService && this.whatsappService.isConfigured()) {\n            const success = await this.whatsappService.sendEventNotification(message);\n            \n            if (success) {\n              await storage.updateNotificationStatus(notification.id, true);\n              console.log(`‚úÖ Retry successful for notification: ${notification.eventId}`);\n            } else {\n              const newRetryCount = (notification.retryCount || 0) + 1;\n              await storage.updateNotificationStatus(\n                notification.id, \n                false, \n                `Retry ${newRetryCount} failed - provider returned false`,\n                newRetryCount\n              );\n              console.log(`‚ùå Retry ${newRetryCount} failed for notification: ${notification.eventId}`);\n            }\n          }\n        } catch (error) {\n          const newRetryCount = (notification.retryCount || 0) + 1;\n          const errorMessage = error instanceof Error ? error.message : 'Unknown error during retry';\n          \n          await storage.updateNotificationStatus(\n            notification.id, \n            false, \n            errorMessage,\n            newRetryCount\n          );\n          \n          console.error(`‚ùå Error during retry ${newRetryCount} for notification ${notification.eventId}:`, error);\n        }\n      }\n    } catch (error) {\n      console.error('‚ùå Failed to process notification retries:', error);\n    }\n  }\n\n  async checkAndNotifyUpcomingEvents(): Promise<void> {\n    const startTime = Date.now();\n    let eventsProcessed = 0;\n    let notificationsSent = 0;\n    let notificationsFailed = 0;\n    let duplicatesSkipped = 0;\n\n    try {\n      console.log('üîç Starting notification check for upcoming events...');\n      \n      // Re-initialize to pick up any settings changes\n      await this.initialize();\n\n      // Retry any failed notifications first\n      await this.retryFailedNotifications();\n\n      const [whatsappSettings, emailSettings] = await Promise.all([\n        storage.getWhatsappSettings(),\n        storage.getEmailSettings()\n      ]);\n      \n      const whatsappEnabled = whatsappSettings?.enabled && this.whatsappService?.isConfigured();\n      const emailEnabled = emailSettings?.enabled && smtpEmailService.isReady();\n      \n      if (!whatsappEnabled && !emailEnabled) {\n        console.log('‚ö†Ô∏è  Both WhatsApp and Email notifications are disabled');\n        return;\n      }\n      \n      console.log(`üìß Email notifications: ${emailEnabled ? 'ENABLED' : 'disabled'}`);\n      console.log(`üì± WhatsApp notifications: ${whatsappEnabled ? 'ENABLED' : 'disabled'}`);\n\n      // Use email reminder days if available, otherwise whatsapp, otherwise default\n      const reminderDays = (emailSettings?.reminderDays || whatsappSettings?.reminderDays || [7, 15, 30, 60]) as number[];\n      const maxDays = Math.max(...reminderDays);\n      const currentDate = new Date();\n      const futureDate = new Date();\n      futureDate.setDate(currentDate.getDate() + maxDays);\n\n      console.log(`üìÖ Checking for events between ${currentDate.toLocaleDateString()} and ${futureDate.toLocaleDateString()}`);\n\n      const events: UpcomingEvent[] = [];\n      \n      const [vessels, crewMembers, contracts, documents, crewRotations] = await Promise.all([\n        storage.getVessels(),\n        storage.getCrewMembers(),\n        storage.getContracts(),\n        storage.getDocuments(),\n        storage.getCrewRotations()\n      ]);\n\n      // Contract renewals/expirations\n      contracts.forEach(contract => {\n        if (contract.status === 'active' && contract.endDate >= currentDate && contract.endDate <= futureDate) {\n          const crewMember = crewMembers.find(c => c.id === contract.crewMemberId);\n          const vessel = vessels.find(v => v.id === contract.vesselId);\n          \n          const daysUntil = Math.ceil((contract.endDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n          let severity: 'success' | 'info' | 'warning' | 'high' = 'info';\n          \n          if (daysUntil <= 3) severity = 'high';\n          else if (daysUntil <= 7) severity = 'warning';\n\n          events.push({\n            id: `contract-${contract.id}`,\n            type: 'contract_expiry',\n            title: `Contract Renewal Required`,\n            description: `Contract for ${crewMember?.firstName} ${crewMember?.lastName} on vessel ${vessel?.name} expires soon`,\n            date: contract.endDate,\n            severity,\n            crewMemberId: contract.crewMemberId,\n            vesselId: contract.vesselId,\n            contractId: contract.id,\n            crewMemberName: crewMember ? `${crewMember.firstName} ${crewMember.lastName}` : undefined,\n            vesselName: vessel?.name,\n          });\n        }\n      });\n\n      // Document expirations (with special handling for CDC documents)\n      documents.forEach(document => {\n        if (document.expiryDate >= currentDate && document.expiryDate <= futureDate) {\n          const crewMember = crewMembers.find(c => c.id === document.crewMemberId);\n          \n          // Find the crew member's current vessel via active contract\n          const activeContract = contracts.find(c => c.crewMemberId === document.crewMemberId && c.status === 'active');\n          const vessel = activeContract ? vessels.find(v => v.id === activeContract.vesselId) : undefined;\n          \n          const daysUntil = Math.ceil((document.expiryDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n          \n          // For CDC, Passport, COC, and Medical documents, use specific severity based on document reminder days\n          const docType = document.type.toLowerCase();\n          const isCDC = docType === 'cdc';\n          const isPassport = docType === 'passport';\n          const isCOC = docType === 'coc';\n          const isMedical = docType === 'medical' || docType === 'medical certificate' || docType.includes('medical');\n          let severity: 'success' | 'info' | 'warning' | 'high' = 'info';\n          \n          if (isCDC || isPassport || isCOC || isMedical) {\n            // Document-specific severity: 10 days = high, 30 days = warning, 45/60 = info\n            if (daysUntil <= 10) severity = 'high';\n            else if (daysUntil <= 30) severity = 'warning';\n          } else {\n            // Standard severity for other documents\n            if (daysUntil <= 3) severity = 'high';\n            else if (daysUntil <= 7) severity = 'warning';\n          }\n\n          events.push({\n            id: `document-${document.id}`,\n            type: 'document_expiry',\n            title: isCDC ? 'CDC Renewal Required' : 'Document Renewal Required',\n            description: `${document.type.toUpperCase()} (${document.documentNumber}) for ${crewMember?.firstName} ${crewMember?.lastName} expires soon`,\n            date: document.expiryDate,\n            severity,\n            crewMemberId: document.crewMemberId,\n            documentId: document.id,\n            documentType: document.type,\n            documentNumber: document.documentNumber,\n            issuingAuthority: document.issuingAuthority,\n            crewMemberName: crewMember ? `${crewMember.firstName} ${crewMember.lastName}` : undefined,\n            crewMemberRank: crewMember?.rank,\n            crewMemberNationality: crewMember?.nationality,\n            vesselName: vessel?.name,\n          });\n        }\n      });\n\n      // Crew rotations\n      crewRotations.forEach(rotation => {\n        if (rotation.joinDate && rotation.joinDate >= currentDate && rotation.joinDate <= futureDate) {\n          const crewMember = crewMembers.find(c => c.id === rotation.crewMemberId);\n          const vessel = vessels.find(v => v.id === rotation.vesselId);\n\n          events.push({\n            id: `rotation-join-${rotation.id}`,\n            type: 'crew_join',\n            title: `Crew Join Scheduled`,\n            description: `${crewMember?.firstName} ${crewMember?.lastName} scheduled to join ${vessel?.name}`,\n            date: rotation.joinDate,\n            severity: 'info',\n            crewMemberId: rotation.crewMemberId,\n            vesselId: rotation.vesselId,\n            rotationId: rotation.id,\n            crewMemberName: crewMember ? `${crewMember.firstName} ${crewMember.lastName}` : undefined,\n            vesselName: vessel?.name,\n          });\n        }\n\n        if (rotation.leaveDate && rotation.leaveDate >= currentDate && rotation.leaveDate <= futureDate) {\n          const crewMember = crewMembers.find(c => c.id === rotation.crewMemberId);\n          const vessel = vessels.find(v => v.id === rotation.vesselId);\n\n          events.push({\n            id: `rotation-leave-${rotation.id}`,\n            type: 'crew_leave',\n            title: `Crew Leave Scheduled`,\n            description: `${crewMember?.firstName} ${crewMember?.lastName} scheduled to leave ${vessel?.name}`,\n            date: rotation.leaveDate,\n            severity: 'warning',\n            crewMemberId: rotation.crewMemberId,\n            vesselId: rotation.vesselId,\n            rotationId: rotation.id,\n            crewMemberName: crewMember ? `${crewMember.firstName} ${crewMember.lastName}` : undefined,\n            vesselName: vessel?.name,\n          });\n        }\n      });\n\n      // Sort events by date\n      events.sort((a, b) => a.date.getTime() - b.date.getTime());\n      eventsProcessed = events.length;\n\n      console.log(`üìã Found ${eventsProcessed} upcoming events to process`);\n\n      // Track notification results during sending\n      const originalSendMethod = this.sendEventNotifications.bind(this);\n      \n      // Send notifications and track results\n      if (eventsProcessed > 0) {\n        await this.sendEventNotifications(events);\n        \n        // We don't have direct access to the individual results here, \n        // but we can check the logs for success/failure patterns\n        console.log(`üì§ Processed ${eventsProcessed} events for notifications`);\n      } else {\n        console.log('‚úÖ No upcoming events found requiring notifications');\n      }\n\n      const endTime = Date.now();\n      const processingTime = endTime - startTime;\n\n      // Log final statistics\n      console.log(`üìä Notification check completed in ${processingTime}ms:`, {\n        eventsProcessed,\n        processingTimeMs: processingTime,\n        timestamp: new Date().toISOString(),\n      });\n\n    } catch (error) {\n      const endTime = Date.now();\n      const processingTime = endTime - startTime;\n      \n      console.error(`‚ùå Error during notification check (${processingTime}ms):`, error);\n      \n      // Log the error to notification history for monitoring\n      try {\n        await storage.logNotification({\n          eventId: 'system-check',\n          eventType: 'system_error',\n          eventDate: new Date(),\n          notificationDate: new Date(),\n          daysBeforeEvent: 0,\n          provider: 'system',\n          success: false,\n          errorMessage: error instanceof Error ? error.message : 'Unknown error during event check',\n          retryCount: 0,\n          metadata: {\n            action: 'check_upcoming_events',\n            processingTimeMs: processingTime,\n            eventsProcessed,\n            error: error instanceof Error ? error.stack : String(error),\n          }\n        });\n      } catch (logError) {\n        console.error('‚ùå Failed to log system error:', logError);\n      }\n      \n      // Re-throw the error so background scheduler can handle it appropriately\n      throw error;\n    }\n  }\n}\n\nexport const notificationService = new NotificationService();","path":null,"size_bytes":40322,"size_tokens":null},"client/src/components/vessels/crew-stats-badges.tsx":{"content":"import { useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { CheckCircle, Clock, AlertTriangle } from 'lucide-react';\nimport ContractStatusModal from './contract-status-modal';\n\ninterface CrewStatsProps {\n  vesselId: string;\n}\n\ninterface ContractStats {\n  valid: number;\n  due: number;\n  expired: number;\n}\n\nexport default function CrewStatsBadges({ vesselId }: CrewStatsProps) {\n  const [modalOpen, setModalOpen] = useState(false);\n  const [selectedContractType, setSelectedContractType] = useState<'valid' | 'due' | 'expired'>('valid');\n  \n  const { data: crewMembers } = useQuery({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n  });\n\n\n  // Helper function to get contract days remaining (same as crew table)\n  const getContractDaysRemaining = (member: any) => {\n    if (!member.activeContract || member.activeContract.status !== 'active') return 0;\n    \n    const now = new Date();\n    const endDate = new Date(member.activeContract.endDate);\n    const daysDiff = Math.ceil((endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    \n    // Return days remaining (can be negative if expired, positive if future)\n    return daysDiff;\n  };\n\n  // Calculate contract stats for this specific vessel using real contract data\n  const getContractStats = (): ContractStats => {\n    if (!crewMembers) return { valid: 0, due: 0, expired: 0 };\n    \n    let valid = 0;\n    let due = 0;\n    let expired = 0;\n    \n    crewMembers.forEach((member: any) => {\n      // Only count crew members assigned to this vessel\n      if (member.currentVesselId === vesselId) {\n        const daysRemaining = getContractDaysRemaining(member);\n        \n        if (daysRemaining <= 0) {\n          expired++; // Contract has expired\n        } else if (daysRemaining <= 45) {\n          due++; // Contract expires within 45 days\n        } else {\n          valid++; // Contract is valid (>45 days)\n        }\n      }\n    });\n    \n    return { valid, due, expired };\n  };\n\n  const stats = getContractStats();\n\n  const handleContractClick = (type: 'valid' | 'due' | 'expired') => {\n    setSelectedContractType(type);\n    setModalOpen(true);\n  };\n\n  const getFilteredCrewMembers = (type: 'valid' | 'due' | 'expired') => {\n    if (!crewMembers) return [];\n    \n    return crewMembers.filter((member: any) => {\n      if (member.currentVesselId !== vesselId) return false;\n      \n      // Use same logic as getContractStats with real contract data\n      const daysRemaining = getContractDaysRemaining(member);\n      \n      if (type === 'valid') {\n        return daysRemaining > 45; // Contract is valid (>45 days)\n      } else if (type === 'due') {\n        return daysRemaining > 0 && daysRemaining <= 45; // Contract expires within 45 days\n      } else {\n        return daysRemaining <= 0; // Contract has expired\n      }\n    });\n  };\n\n  const vesselName = crewMembers?.find((member: any) => member.currentVesselId === vesselId)?.currentVessel?.name || 'Unknown Vessel';\n\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-2\">\n      {/* Contract Valid */}\n      <Button\n        variant=\"ghost\"\n        size=\"sm\"\n        className=\"h-auto p-1 text-xs\"\n        onClick={() => handleContractClick('valid')}\n        data-testid={`contract-valid-${vesselId}`}\n      >\n        <Badge \n          variant=\"secondary\" \n          className=\"bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border-green-200 dark:border-green-700 hover:bg-green-200 dark:hover:bg-green-800 transition-colors mobile-status-badge\"\n        >\n          <CheckCircle className=\"h-3 w-3 mr-1\" />\n          <span className=\"mobile-status-text\">Contract Valid: {stats.valid}</span>\n        </Badge>\n      </Button>\n\n      {/* Contract Due */}\n      <Button\n        variant=\"ghost\"\n        size=\"sm\"\n        className=\"h-auto p-1 text-xs\"\n        onClick={() => handleContractClick('due')}\n        data-testid={`contract-due-${vesselId}`}\n      >\n        <Badge \n          variant=\"secondary\" \n          className=\"bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 border-yellow-200 dark:border-yellow-700 hover:bg-yellow-200 dark:hover:bg-yellow-800 transition-colors mobile-status-badge\"\n        >\n          <Clock className=\"h-3 w-3 mr-1\" />\n          <span className=\"mobile-status-text\">Contract Due: {stats.due}</span>\n        </Badge>\n      </Button>\n\n      {/* Contracts Expired */}\n      <Button\n        variant=\"ghost\"\n        size=\"sm\"\n        className=\"h-auto p-1 text-xs\"\n        onClick={() => handleContractClick('expired')}\n        data-testid={`contract-expired-${vesselId}`}\n      >\n        <Badge \n          variant=\"secondary\" \n          className=\"bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 border-red-200 dark:border-red-700 hover:bg-red-200 dark:hover:bg-red-800 transition-colors mobile-status-badge\"\n        >\n          <AlertTriangle className=\"h-3 w-3 mr-1\" />\n          <span className=\"mobile-status-text\">Contracts Expired: {stats.expired}</span>\n        </Badge>\n      </Button>\n      \n      {/* Contract Status Modal */}\n      <ContractStatusModal\n        isOpen={modalOpen}\n        onClose={() => setModalOpen(false)}\n        contractType={selectedContractType}\n        crewMembers={getFilteredCrewMembers(selectedContractType)}\n        vesselName={vesselName}\n      />\n    </div>\n  );\n}","path":null,"size_bytes":5689,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/alerts/vessel-document-alerts.tsx":{"content":"import { Link } from 'wouter';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { AlertTriangle, Clock, ExternalLink, FileText } from 'lucide-react';\nimport { useQuery } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\n\ninterface VesselDocumentAlert {\n  document: {\n    id: string;\n    name: string;\n    type: string;\n    expiryDate: Date;\n  };\n  vessel: {\n    id: string;\n    name: string;\n  };\n  daysUntilExpiry: number;\n  severity: 'critical' | 'warning' | 'info';\n}\n\nconst severityConfig = {\n  critical: {\n    color: 'bg-red-50 border-l-red-500',\n    icon: AlertTriangle,\n    iconColor: 'text-red-500',\n    textColor: 'text-red-700',\n  },\n  warning: {\n    color: 'bg-yellow-50 border-l-yellow-500',\n    icon: Clock,\n    iconColor: 'text-yellow-500',\n    textColor: 'text-yellow-700',\n  },\n  info: {\n    color: 'bg-blue-50 border-l-blue-500',\n    icon: Clock,\n    iconColor: 'text-blue-500',\n    textColor: 'text-blue-700',\n  },\n};\n\nexport default function VesselDocumentAlerts() {\n  const { data: vesselAlerts = [], isLoading } = useQuery<VesselDocumentAlert[]>({\n    queryKey: ['/api/alerts/expiring-vessel-documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/alerts/expiring-vessel-documents?days=30', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessel document alerts');\n      return response.json();\n    },\n    refetchInterval: 5 * 60 * 1000, // Refresh every 5 minutes\n  });\n\n  const criticalAlerts = vesselAlerts.filter(alert => alert.severity === 'critical');\n  const warningAlerts = vesselAlerts.filter(alert => alert.severity === 'warning');\n  const infoAlerts = vesselAlerts.filter(alert => alert.severity === 'info');\n\n  const displayAlerts = [...criticalAlerts, ...warningAlerts, ...infoAlerts].slice(0, 3);\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"vessel-document-alerts-card\">\n        <CardHeader className=\"pb-4\">\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-lg font-semibold maritime-navy\">Vessel Documents</CardTitle>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-6 text-gray-500\">\n            <Clock className=\"h-8 w-8 mx-auto mb-2 text-gray-300 animate-spin\" />\n            <p className=\"text-sm\">Loading...</p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card data-testid=\"vessel-document-alerts-card\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-lg font-semibold maritime-navy\">Vessel Documents</CardTitle>\n          {vesselAlerts.length > 0 && (\n            <Badge variant=\"destructive\" data-testid=\"vessel-alerts-count\">\n              {vesselAlerts.length}\n            </Badge>\n          )}\n        </div>\n      </CardHeader>\n      <CardContent>\n        {vesselAlerts.length === 0 ? (\n          <div className=\"text-center py-6 text-gray-500\">\n            <FileText className=\"h-8 w-8 mx-auto mb-2 text-gray-300\" />\n            <p className=\"text-sm\">No expiring vessel documents</p>\n          </div>\n        ) : (\n          <div className=\"space-y-4\">\n            {displayAlerts.map((alert) => {\n              const config = severityConfig[alert.severity];\n              const Icon = config.icon;\n              \n              return (\n                <Link\n                  key={alert.document.id}\n                  href={`/fleet-management?highlight=${alert.vessel.id}`}\n                  className=\"block\"\n                  data-testid={`vessel-alert-link-${alert.document.id}`}\n                >\n                  <div\n                    className={`flex items-center justify-between p-3 border-l-4 rounded-r ${config.color} hover:bg-opacity-80 transition-colors cursor-pointer group`}\n                    data-testid={`vessel-alert-${alert.document.id}`}\n                    title={`Click to manage ${alert.document.type.toUpperCase()} document for ${alert.vessel.name}`}\n                  >\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Icon className={`h-4 w-4 ${config.iconColor}`} />\n                        <p className={`text-sm font-medium ${config.textColor} group-hover:underline`} data-testid=\"vessel-alert-document-type\">\n                          {alert.document.type.toUpperCase()} Document\n                        </p>\n                        <Badge variant=\"secondary\" className=\"text-xs px-1 py-0.5 opacity-0 group-hover:opacity-100 transition-opacity\">\n                          Click to manage\n                        </Badge>\n                      </div>\n                      <p className=\"text-xs text-gray-500 mt-1\" data-testid=\"vessel-alert-info\">\n                        {alert.vessel.name} - {alert.daysUntilExpiry} days\n                      </p>\n                    </div>\n                    <ExternalLink className={`h-3 w-3 ${config.iconColor} opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0`} />\n                  </div>\n                </Link>\n              );\n            })}\n            \n            <Link href=\"/fleet-management\" className=\"block\">\n              <Button \n                className=\"w-full mt-4 bg-maritime-navy hover:bg-blue-800\" \n                size=\"sm\"\n                data-testid=\"view-all-vessel-alerts-button\"\n              >\n                <ExternalLink className=\"h-4 w-4 mr-2\" />\n                Manage Fleet Documents\n              </Button>\n            </Link>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":5843,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"server/localOcrService.ts":{"content":"import { createWorker } from 'tesseract.js';\nimport sharp from 'sharp';\n\nexport interface ExtractedCrewData {\n  name?: string;\n  position?: string;\n  nationality?: string;\n  dateOfBirth?: string;\n  passportNumber?: string;\n  seamansBookNumber?: string;\n  cdcNumber?: string;\n  phoneNumber?: string;\n  email?: string;\n  emergencyContact?: string;\n  emergencyPhone?: string;\n  contractStartDate?: string;\n  contractEndDate?: string;\n  joinDate?: string;\n  leaveDate?: string;\n  vessel?: string;\n  salary?: string;\n  // Ship Owner Details\n  shipOwnerName?: string;\n  shipOwnerContactPerson?: string;\n  shipOwnerPostalAddress?: string;\n  // Seafarer Details\n  seafarerName?: string;\n  capacityRankEmployed?: string;\n  seafarerNationality?: string;\n  seafarerDatePlaceOfBirth?: string;\n  seafarerIndosNumber?: string;\n  seafarerPostalAddress?: string;\n  seafarerEmail?: string;\n  seafarerMobile?: string;\n  cdcPlaceOfIssue?: string;\n  cdcIssueDate?: string;\n  cdcExpiryDate?: string;\n  passportPlaceOfIssue?: string;\n  passportIssueDate?: string;\n  passportExpiryDate?: string;\n  nokName?: string;\n  nokRelationship?: string;\n  nokEmail?: string;\n  nokTelephone?: string;\n  nokPostalAddress?: string;\n  cocGradeNo?: string;\n  cocPlaceOfIssue?: string;\n  cocIssueDate?: string;\n  cocExpiryDate?: string;\n  // Medical Certificate Details\n  medicalIssuingAuthority?: string;\n  medicalApprovalNo?: string;\n  medicalIssueDate?: string;\n  medicalExpiryDate?: string;\n  // Ship Details\n  shipName?: string;\n  // Contract Information\n  engagementPeriodMonths?: number;\n}\n\nexport interface ExtractedCrewRecord extends ExtractedCrewData {\n  recordId: string;\n  displayName: string;\n}\n\nexport class LocalOCRService {\n  private worker: any = null;\n\n  async initializeWorker() {\n    if (!this.worker) {\n      this.worker = await createWorker('eng', undefined, {\n        logger: m => console.log('Tesseract:', m)\n      });\n      await this.worker.setParameters({\n        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 +-/:@.',\n        preserve_interword_spaces: '1'\n      });\n    }\n    return this.worker;\n  }\n\n  async extractCrewDataFromDocument(base64Data: string, filename?: string): Promise<ExtractedCrewData> {\n    try {\n      console.log('Starting OCR extraction for file:', filename);\n      console.log('Base64 data length:', base64Data?.length || 0);\n      \n      let extractedText = '';\n\n      // Validate input\n      if (!base64Data || base64Data.length === 0) {\n        throw new Error('No image data provided');\n      }\n\n      // Detect file type from base64 data\n      const isPDF = base64Data.startsWith('JVBERi') || filename?.toLowerCase().endsWith('.pdf');\n      \n      if (isPDF) {\n        // Handle PDF files - extract text directly\n        console.log('Processing PDF with pdf-parse...');\n        extractedText = await this.extractTextFromPDF(base64Data);\n      } else {\n        // Handle image\n        console.log('Processing image with Tesseract...');\n        extractedText = await this.extractTextFromImage(base64Data);\n      }\n\n      console.log('Extracted raw text:', extractedText);\n\n      // Parse the extracted text to find crew information\n      const crewData = this.parseCrewInformation(extractedText);\n      console.log('Parsed crew data:', crewData);\n      \n      return crewData;\n    } catch (error) {\n      console.error('Local OCR extraction error:', error);\n      if (error instanceof Error) {\n        throw new Error(`OCR processing failed: ${error.message}`);\n      }\n      throw new Error('Failed to extract data from document. Please try again or enter the information manually.');\n    }\n  }\n\n  private async extractTextFromPDF(base64Data: string): Promise<string> {\n    try {\n      const pdfBuffer = Buffer.from(base64Data, 'base64');\n      console.log('PDF buffer size:', pdfBuffer.length);\n      \n      // Dynamic import to avoid pdf-parse test file loading issue\n      const pdfParse = (await import('pdf-parse')).default;\n      const pdfData = await pdfParse(pdfBuffer);\n      console.log('PDF text extracted, length:', pdfData.text?.length || 0);\n      \n      return pdfData.text || '';\n    } catch (error) {\n      console.error('PDF extraction error:', error);\n      throw new Error(`Failed to extract text from PDF: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  private async extractTextFromImage(base64Data: string): Promise<string> {\n    try {\n      console.log('Initializing Tesseract worker...');\n      // Initialize Tesseract worker\n      const worker = await this.initializeWorker();\n      \n      console.log('Converting base64 to buffer...');\n      // Convert base64 to buffer and optimize image for OCR\n      const buffer = Buffer.from(base64Data, 'base64');\n      console.log('Buffer size:', buffer.length);\n      \n      console.log('Optimizing image for OCR...');\n      const optimizedBuffer = await sharp(buffer)\n        .resize({ width: 1200, height: 1600, fit: 'inside' })\n        .grayscale()\n        .normalize()\n        .sharpen()\n        .threshold(128)\n        .png()\n        .toBuffer();\n      console.log('Optimized buffer size:', optimizedBuffer.length);\n\n      console.log('Starting OCR recognition...');\n      // Perform OCR\n      const { data: { text } } = await worker.recognize(optimizedBuffer);\n      console.log('OCR completed, text length:', text?.length || 0);\n      return text || '';\n    } catch (error) {\n      console.error('Image OCR error:', error);\n      throw new Error(`Failed to extract text from image: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  private parseCrewInformation(text: string): ExtractedCrewData {\n    const result: ExtractedCrewData = {};\n    \n    // If text is empty or very short, return empty result\n    if (!text || text.trim().length < 10) {\n      console.log('Text too short or empty, no meaningful content extracted');\n      return {};\n    }\n    \n    const lines = text.split('\\n').map(line => line.trim()).filter(line => line.length > 0);\n    console.log('Parsing text with', lines.length, 'lines');\n    console.log('All lines for debugging:');\n    lines.forEach((line, index) => {\n      console.log(`${index}: \"${line}\"`);\n    });\n    \n    // Parse the specific structure of this maritime contract\n    // Look for EMPLOYEE section and extract name\n    const employeeIndex = lines.findIndex(line => line.toUpperCase().trim() === 'EMPLOYEE');\n    if (employeeIndex >= 0 && employeeIndex < lines.length - 1) {\n      console.log('Found EMPLOYEE section at index:', employeeIndex);\n      // Look for name in the lines immediately after EMPLOYEE\n      for (let i = employeeIndex + 1; i < Math.min(employeeIndex + 8, lines.length); i++) {\n        const line = lines[i].trim();\n        console.log(`Checking line ${i} for name: \"${line}\"`);\n        \n        // Look for a line that could be a name - typical format is all caps or title case\n        if (line.length > 5 && line.length < 60 && \n            !line.toUpperCase().includes('PASSPORT') && \n            !line.toUpperCase().includes('VESSEL') &&\n            !line.toUpperCase().includes('OFFICE') &&\n            !line.toUpperCase().includes('NO.') &&\n            !line.includes('IMO') &&\n            !line.includes('CH ') &&\n            !line.includes('The said') &&\n            // Check if it looks like a name (letters and spaces only, possibly with dots)\n            /^[A-Z][A-Za-z\\s.]+$/.test(line)) {\n          result.name = line;\n          console.log('Extracted name from employee section:', line);\n          break;\n        }\n      }\n    }\n\n    // Alternative method: Look for names in common patterns\n    if (!result.name) {\n      console.log('Trying alternative name extraction methods...');\n      \n      // Check if the name appears immediately in the text between EMPLOYEE and PASSPORT NO\n      const employeeToPassportMatch = text.match(/EMPLOYEE\\s*[\\r\\n]+(.*?)[\\r\\n]*PASSPORT\\s+NO/i);\n      if (employeeToPassportMatch && employeeToPassportMatch[1]) {\n        const potentialName = employeeToPassportMatch[1].trim();\n        console.log('Found potential name between EMPLOYEE and PASSPORT:', potentialName);\n        \n        // Clean and validate the name\n        if (potentialName.length > 5 && potentialName.length < 80 && \n            !potentialName.toUpperCase().includes('OFFICE') &&\n            !potentialName.toUpperCase().includes('LIMITED') &&\n            !potentialName.toUpperCase().includes('FLOOR') &&\n            /^[A-Z][A-Za-z\\s.]+$/.test(potentialName)) {\n          result.name = potentialName;\n          console.log('Extracted name using EMPLOYEE-PASSPORT pattern:', potentialName);\n        }\n      }\n      \n      // If still no name, try looking for standalone name lines\n      if (!result.name) {\n        for (let i = 0; i < lines.length; i++) {\n          const line = lines[i];\n          // Look for lines that could be names - 2-4 words, all caps or title case\n          if (line.length > 8 && line.length < 50 &&\n              /^[A-Z][A-Z\\s]+$/.test(line) &&\n              !line.includes('LIMITED') &&\n              !line.includes('PRIVATE') &&\n              !line.includes('OFFICE') &&\n              !line.includes('PASSPORT') &&\n              !line.includes('VESSEL') &&\n              !line.includes('CONTRACT') &&\n              !line.includes('EMPLOYMENT') &&\n              !line.includes('MARINE') &&\n              !line.includes('OFFSHORE') &&\n              !line.includes('BELAPUR') &&\n              !line.includes('MUMBAI') &&\n              !line.includes('OWNER') &&\n              !line.includes('EMPLOVER') &&\n              // Should be 2-4 words (typical name structure)\n              line.split(/\\s+/).length >= 2 && line.split(/\\s+/).length <= 4) {\n            result.name = line;\n            console.log('Found potential name as standalone line:', line);\n            break;\n          }\n        }\n      }\n    }\n\n    // Extract passport number - look for line with \"PASSPORT NO\" and number\n    const passportLine = lines.find(line => \n      line.toUpperCase().includes('PASSPORT') && line.toUpperCase().includes('NO')\n    );\n    if (passportLine) {\n      // Extract numbers from passport line\n      const passportMatch = passportLine.match(/(\\d{6,10})/);\n      if (passportMatch) {\n        result.passportNumber = passportMatch[1];\n        console.log('Found passport number:', passportMatch[1]);\n      }\n    }\n\n    // Extract vessel name - look for line with \"VESSEL\" and name\n    const vesselLine = lines.find(line => \n      line.toUpperCase().includes('VESSEL') && !line.toUpperCase().includes('SUCH VESSEL')\n    );\n    if (vesselLine) {\n      // Extract vessel name between VESSEL and IMO\n      const vesselMatch = vesselLine.match(/VESSEL\\s+([A-Z0-9\\s]+?)(?:\\s+IMO|$)/i);\n      if (vesselMatch) {\n        result.vessel = vesselMatch[1].trim();\n        console.log('Found vessel name:', vesselMatch[1].trim());\n      }\n    }\n\n    // Extract position/rank - look for \"rank of\" pattern\n    const rankText = text.toLowerCase();\n    const rankMatch = rankText.match(/employed.*?rank\\s+of\\s+([a-z\\s]+?)(?:\\s+on\\s+board|\\s|$)/i);\n    if (rankMatch) {\n      result.position = rankMatch[1].trim().toUpperCase();\n      console.log('Found position/rank:', rankMatch[1].trim().toUpperCase());\n    }\n\n    // Extract salary - look for \"BASIC PER MONTH\" or similar\n    const salaryLine = lines.find(line => \n      line.toUpperCase().includes('BASIC') && line.toUpperCase().includes('MONTH')\n    );\n    if (salaryLine) {\n      const salaryMatch = salaryLine.match(/(\\d+[,.]?\\d*)/);\n      if (salaryMatch) {\n        result.salary = salaryMatch[1];\n        console.log('Found salary:', salaryMatch[1]);\n      }\n    }\n\n    // Extract nationality - if available in document\n    const nationalityMatch = text.match(/nationality[:\\s]*([a-z]+)/i);\n    if (nationalityMatch) {\n      result.nationality = nationalityMatch[1];\n      console.log('Found nationality:', nationalityMatch[1]);\n    }\n\n    // Extract date of birth - look for DOB patterns\n    const dobPatterns = [\n      /date\\s+of\\s+birth[:\\s]*(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/i,\n      /dob[:\\s]*(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/i,\n      /born[:\\s]*(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/i,\n      /birth[:\\s]*(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/i\n    ];\n\n    for (const pattern of dobPatterns) {\n      const dobMatch = text.match(pattern);\n      if (dobMatch) {\n        const date = dobMatch[1];\n        const parts = date.split(/[\\/\\-]/);\n        const year = parseInt(parts[2]);\n        \n        // Validate reasonable birth year (1950-2005 for working age)\n        if (year >= 1950 && year <= 2005) {\n          result.dateOfBirth = date;\n          console.log('Found date of birth:', date);\n          break;\n        }\n      }\n    }\n\n    // Extract dates - look for realistic date patterns\n    const allDates = text.match(/(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/g) || [];\n    const validDates = allDates.filter(date => {\n      const parts = date.split(/[\\/\\-]/);\n      const year = parseInt(parts[2]);\n      const month = parseInt(parts[1]);\n      const day = parseInt(parts[0]);\n      \n      // Basic date validation\n      return year >= 2020 && year <= 2030 && \n             month >= 1 && month <= 12 && \n             day >= 1 && day <= 31;\n    });\n\n    if (validDates.length >= 1) {\n      result.contractStartDate = validDates[0];\n      console.log('Found contract start date:', validDates[0]);\n      \n      if (validDates.length >= 2) {\n        result.contractEndDate = validDates[1];\n        console.log('Found contract end date:', validDates[1]);\n      }\n    }\n\n    // Extract CDC number if mentioned\n    const seamansCdcMatch = text.match(/cdc[:\\s]*([a-z0-9]+)/i);\n    if (seamansCdcMatch) {\n      result.seamansBookNumber = seamansCdcMatch[1];\n      console.log('Found seaman CDC number:', seamansCdcMatch[1]);\n    }\n\n    // Extract Ship Owner Details - look for \"Details of Ship Owner\" section\n    // Ship Owner Name - Format: \"1. Name: GLOBAL CAMBAYMARINE SERVICES PVT. LTD\"\n    const shipOwnerNamePatterns = [\n      /1\\.?\\s*Name[:\\s]+([A-Z][A-Z\\s,.&]+(?:PVT|LTD|LIMITED|PRIVATE|COMPANY|CORP|INC|SERVICES)[A-Z\\s,.]*)/i,\n      /(?:Details\\s+of\\s+Ship\\s+Owner|Ship\\s+Owner)[\\s\\S]*?Name[:\\s]+([A-Z][A-Z\\s,.&]+(?:PVT|LTD|LIMITED|PRIVATE|COMPANY|CORP|INC|SERVICES)[A-Z\\s,.]*)/i,\n      /Ship\\s*Owner[:\\s]+([A-Z][A-Z\\s,.&]+(?:PVT|LTD|LIMITED|PRIVATE|COMPANY|CORP|INC|SERVICES)[A-Z\\s,.]*)/i\n    ];\n    for (const pattern of shipOwnerNamePatterns) {\n      const match = text.match(pattern);\n      if (match) {\n        result.shipOwnerName = match[1].replace(/\\s+/g, ' ').trim();\n        console.log('Found Ship Owner Name:', result.shipOwnerName);\n        break;\n      }\n    }\n\n    // Ship Owner Contact Person - Format: \"3. Contact Person: MR. ZOHAR A MALAMPATTIWALA\"\n    const contactPersonPatterns = [\n      /3\\.?\\s*Contact\\s*Person[:\\s]+(?:MR\\.?|MRS\\.?|MS\\.?)?\\s*([A-Z][A-Za-z\\s.]+)/i,\n      /Contact\\s*Person[:\\s]+(?:MR\\.?|MRS\\.?|MS\\.?)?\\s*([A-Z][A-Za-z\\s.]+)/i\n    ];\n    for (const pattern of contactPersonPatterns) {\n      const match = text.match(pattern);\n      if (match) {\n        result.shipOwnerContactPerson = match[1].replace(/\\s+/g, ' ').trim();\n        console.log('Found Ship Owner Contact Person:', result.shipOwnerContactPerson);\n        break;\n      }\n    }\n\n    // Ship Owner Postal Address - Format: \"4. Postal Address & e-Mail: 3/684,HUSSAINI VILLA...\"\n    const postalAddressPatterns = [\n      /4\\.?\\s*Postal\\s*Address\\s*(?:&\\s*e-?Mail)?[:\\s]+([^\\n]+(?:[\\n,][^\\n]+)*?)(?=\\n\\s*(?:\\d+\\.|II|III|IV|V\\.|$))/i,\n      /Postal\\s*Address\\s*(?:&\\s*e-?Mail)?[:\\s]+([^\\n]+(?:[\\n,][^\\n]+)*?)(?=\\n\\s*(?:\\d+\\.|II|III|IV|V\\.|$))/i,\n      /Postal\\s*Address[\\s:&eMail-]*([^\\n]+(?:[\\n,][^\\n]+)?)/i\n    ];\n    for (const pattern of postalAddressPatterns) {\n      const match = text.match(pattern);\n      if (match) {\n        result.shipOwnerPostalAddress = match[1].replace(/\\n/g, ', ').replace(/\\s+/g, ' ').trim();\n        console.log('Found Ship Owner Postal Address:', result.shipOwnerPostalAddress);\n        break;\n      }\n    }\n\n    // Extract Seafarer Details - Parse the V. Details of Seafarers section\n    // In this PDF format, labels and values are on separate lines\n    // Find the section and extract values by looking for specific patterns\n    \n    const seafarerSectionMatch = text.match(/V\\.?\\s*Details\\s+of\\s+Seafarers?\\s*:?([\\s\\S]*?)(?:VI\\.|$)/i);\n    if (seafarerSectionMatch) {\n      const seafarerSection = seafarerSectionMatch[1];\n      console.log('Found Seafarer Section:', seafarerSection.substring(0, 500));\n      \n      // Extract seafarer name - look for an all-caps name (2-4 words)\n      const nameMatch = seafarerSection.match(/\\n([A-Z][A-Z\\s]{5,40})\\n/);\n      if (nameMatch && !nameMatch[1].includes('INDIAN') && !nameMatch[1].includes('COLLAGE')) {\n        result.seafarerName = nameMatch[1].trim();\n        console.log('Found Seafarer Name:', result.seafarerName);\n      }\n      \n      // Extract nationality - look for INDIAN or similar\n      const natMatch = seafarerSection.match(/\\n(INDIAN|FILIPINO|CHINESE|INDONESIAN|AMERICAN|BRITISH|CANADIAN|AUSTRALIAN)\\n/i);\n      if (natMatch) {\n        result.seafarerNationality = natMatch[1].toUpperCase();\n        console.log('Found Seafarer Nationality:', result.seafarerNationality);\n      }\n      \n      // Extract date and place of birth - look for DD-MMM-YYYY & PLACE pattern\n      const dobMatch = seafarerSection.match(/(\\d{2}-[A-Z]{3}-\\d{4}\\s*[&]\\s*[A-Z\\-]+)/i);\n      if (dobMatch) {\n        result.seafarerDatePlaceOfBirth = dobMatch[1].replace(/\\s+/g, ' ').trim();\n        console.log('Found Seafarer Date/Place of Birth:', result.seafarerDatePlaceOfBirth);\n      }\n      \n      // Extract email from seafarer section\n      const emailMatch = seafarerSection.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/i);\n      if (emailMatch) {\n        result.seafarerEmail = emailMatch[1].toLowerCase();\n        console.log('Found Seafarer Email:', result.seafarerEmail);\n      }\n      \n      // Extract mobile - look for 10+ digit number\n      const mobileMatch = seafarerSection.match(/\\n(\\d{10,12})\\n/);\n      if (mobileMatch) {\n        result.seafarerMobile = mobileMatch[1];\n        console.log('Found Seafarer Mobile:', result.seafarerMobile);\n      }\n      \n      // Extract postal address - look for lines with FLT/FLAT/NO or address-like content\n      const addressMatch = seafarerSection.match(/((?:FLT|FLAT|NO|HOUSE|PLOT)\\.?\\s*(?:NO\\.?)?\\s*\\d+[^\\n]*(?:\\n[^\\n@0-9]{10,})*)/i);\n      if (addressMatch) {\n        result.seafarerPostalAddress = addressMatch[1].replace(/\\n/g, ' ').replace(/\\s+/g, ' ').trim();\n        console.log('Found Seafarer Postal Address:', result.seafarerPostalAddress);\n      }\n    }\n    \n    // Extract INDOS number - appears near the top or in the seafarer section\n    // Format: alphanumeric like 07NL1441\n    if (!result.seafarerIndosNumber) {\n      const indosMatch = text.match(/(?:INDoS|INDOS)\\s*(?:No\\.?|Number)?[:\\s]*([0-9]{2}[A-Z]{2}[0-9]{4})/i);\n      if (indosMatch) {\n        result.seafarerIndosNumber = indosMatch[1].toUpperCase();\n        console.log('Found Seafarer INDOS Number:', result.seafarerIndosNumber);\n      } else {\n        // Try to find standalone INDOS format number\n        const indosStandalone = text.match(/\\b([0-9]{2}[A-Z]{2}[0-9]{4})\\b/);\n        if (indosStandalone) {\n          result.seafarerIndosNumber = indosStandalone[1];\n          console.log('Found Seafarer INDOS Number (standalone):', result.seafarerIndosNumber);\n        }\n      }\n    }\n    \n    // Extract CDC (Continuous Discharge Certificate) details\n    // In the PDF text, CDC data appears BEFORE the \"6. CDC No. :\" label\n    // Format: Lines contain \"MUM 132798\", \"MUMBAI\", \"28-MAR-202527-MAR-2035\" followed later by \"6. CDC No. :\"\n    \n    // Look for CDC number pattern like \"MUM 132798\" or \"DEL 123456\" anywhere in text\n    const cdcNumberMatch = text.match(/\\n([A-Z]{2,4}\\s+\\d{5,7})\\n/);\n    if (cdcNumberMatch) {\n      result.cdcNumber = cdcNumberMatch[1].trim();\n      console.log('Found CDC Number:', result.cdcNumber);\n    }\n    \n    // Look for concatenated dates pattern: \"28-MAR-202527-MAR-2035\" anywhere in text\n    // This is common when Issue Date and Expiry Date are on same line without separator\n    const concatenatedDatesMatch = text.match(/(\\d{2}-[A-Z]{3}-\\d{4})(\\d{2}-[A-Z]{3}-\\d{4})/i);\n    if (concatenatedDatesMatch) {\n      result.cdcIssueDate = concatenatedDatesMatch[1];\n      result.cdcExpiryDate = concatenatedDatesMatch[2];\n      console.log('Found CDC Issue Date:', result.cdcIssueDate);\n      console.log('Found CDC Expiry Date:', result.cdcExpiryDate);\n    }\n    \n    // Look for Place of Issue - search near CDC number for city names\n    // The place of issue is usually a standalone city name on its own line\n    const placePatterns = [\n      /Place\\s+of\\s+Issue\\s*:?\\s*(MUMBAI|CHENNAI|KOLKATA|DELHI|COCHIN|GOA|VISAKHAPATNAM|KANDLA|PATNA|LUCKNOW|KOCHI)/i,\n      /\\n(MUMBAI|CHENNAI|KOLKATA|DELHI|COCHIN|GOA|VISAKHAPATNAM|KANDLA|PATNA|LUCKNOW|KOCHI)\\n(?=\\d{2}-[A-Z]{3}-\\d{4})/i\n    ];\n    for (const pattern of placePatterns) {\n      const placeMatch = text.match(pattern);\n      if (placeMatch) {\n        result.cdcPlaceOfIssue = placeMatch[1].toUpperCase();\n        console.log('Found CDC Place of Issue:', result.cdcPlaceOfIssue);\n        break;\n      }\n    }\n    \n    // If no place found yet, try to find it between CDC number and dates\n    if (!result.cdcPlaceOfIssue && result.cdcNumber) {\n      const cdcNumIndex = text.indexOf(result.cdcNumber);\n      if (cdcNumIndex >= 0) {\n        const afterCdcNum = text.substring(cdcNumIndex + result.cdcNumber.length, cdcNumIndex + 100);\n        const cityMatch = afterCdcNum.match(/\\n(MUMBAI|CHENNAI|KOLKATA|DELHI|COCHIN|GOA|VISAKHAPATNAM|KANDLA|PATNA|LUCKNOW|KOCHI)\\n/i);\n        if (cityMatch) {\n          result.cdcPlaceOfIssue = cityMatch[1].toUpperCase();\n          console.log('Found CDC Place of Issue (after CDC number):', result.cdcPlaceOfIssue);\n        }\n      }\n    }\n    \n    // Extract Passport details (field \"7. Passport No.\")\n    // PDF structure: labels and values are on SEPARATE lines\n    // Lines 74-76: \"7. Passport No.   :\", \"Place of Issue :\", \"Expiry Date  :\"\n    // Lines 80-82: \"R2826385\", \"PATNA\", \"04-JUL-2017\"\n    // The passport number appears AFTER the \"6. CDC No.\" line in the values section\n    \n    // Look for passport number pattern: a letter followed by 7 digits on its own line\n    // This should appear AFTER CDC data (MUM 132798, MUMBAI, dates) and BEFORE \"6. CDC No.   :\"\n    const passportNumMatch = text.match(/\\n([A-Z]\\d{7})\\n/);\n    if (passportNumMatch) {\n      result.passportNumber = passportNumMatch[1].toUpperCase();\n      console.log('Found Passport Number:', result.passportNumber);\n      \n      // Find the position of passport number in text\n      const passportNumIndex = text.indexOf(result.passportNumber);\n      if (passportNumIndex > 0) {\n        // The values after passport number should be: Place (PATNA), then Issue Date (04-JUL-2017)\n        // Look at the next 100 characters after passport number\n        const afterPassport = text.substring(passportNumIndex + result.passportNumber.length, passportNumIndex + 150);\n        console.log('After passport number:', afterPassport.substring(0, 100));\n        \n        // Find city name (Place of Issue) - should be on its own line right after passport number\n        const cityMatch = afterPassport.match(/\\n([A-Z]{3,15})\\n/);\n        if (cityMatch && !cityMatch[1].match(/^\\d/)) {\n          result.passportPlaceOfIssue = cityMatch[1].toUpperCase();\n          console.log('Found Passport Place of Issue:', result.passportPlaceOfIssue);\n        }\n        \n        // Find the issue date - DD-MMM-YYYY format after passport number\n        const issueDateMatch = afterPassport.match(/(\\d{2}-[A-Z]{3}-\\d{4})/i);\n        if (issueDateMatch) {\n          result.passportIssueDate = issueDateMatch[1].toUpperCase();\n          console.log('Found Passport Issue Date:', result.passportIssueDate);\n        }\n        \n        // The expiry date is typically 10 years after issue date\n        // In PDF format, it may appear much later in the document (e.g., in \"VI. Details of Employment\" section)\n        // Search for a date that's ~10 years after the issue date\n        if (result.passportIssueDate) {\n          const issueYear = parseInt(result.passportIssueDate.match(/\\d{4}/)?.[0] || '0');\n          const issueMonth = result.passportIssueDate.match(/-([A-Z]{3})-/i)?.[1]?.toUpperCase() || '';\n          const issueDay = result.passportIssueDate.match(/^(\\d{2})-/)?.[1] || '';\n          const expectedExpiryYear = issueYear + 10;\n          \n          // First, look for a date with same month and similar day, 10 years later\n          // This is the most reliable match (e.g., 03-DEC-2020 -> 02-DEC-2030)\n          if (issueMonth) {\n            const sameMonthPattern = new RegExp(`(\\\\d{2}-${issueMonth}-${expectedExpiryYear})`, 'i');\n            const sameMonthMatch = text.match(sameMonthPattern);\n            if (sameMonthMatch) {\n              result.passportExpiryDate = sameMonthMatch[1].toUpperCase();\n              console.log('Found Passport Expiry Date (same month):', result.passportExpiryDate);\n            }\n          }\n          \n          // If not found with same month, look for any date in expected year\n          if (!result.passportExpiryDate) {\n            const expiryPattern = new RegExp(`(\\\\d{2}-[A-Z]{3}-${expectedExpiryYear})`, 'i');\n            const allMatches = text.match(new RegExp(expiryPattern.source, 'gi')) || [];\n            \n            // Filter out dates already used for other fields\n            for (const dateStr of allMatches) {\n              if (dateStr.toUpperCase() !== result.cdcIssueDate &&\n                  dateStr.toUpperCase() !== result.cdcExpiryDate &&\n                  dateStr.toUpperCase() !== result.cocIssueDate &&\n                  dateStr.toUpperCase() !== result.cocExpiryDate) {\n                result.passportExpiryDate = dateStr.toUpperCase();\n                console.log('Found Passport Expiry Date (calculated):', result.passportExpiryDate);\n                break;\n              }\n            }\n          }\n        }\n        \n        // If still no expiry date found, set it to issue date (will need manual correction)\n        if (!result.passportExpiryDate && result.passportIssueDate) {\n          result.passportExpiryDate = result.passportIssueDate;\n          console.log('Found Passport Expiry Date (same as issue - needs correction):', result.passportExpiryDate);\n        }\n      }\n    }\n    \n    // Alternative: If passport number wasn't found, look for explicit label-value pairs\n    if (!result.passportNumber) {\n      const passportPatterns = [\n        /Passport\\s*No\\.?\\s*:?\\s*([A-Z]{1,2}\\d{6,8})/i,\n      ];\n      for (const pattern of passportPatterns) {\n        const match = text.match(pattern);\n        if (match) {\n          result.passportNumber = match[1].replace(/\\s/g, '').toUpperCase();\n          console.log('Found Passport Number (fallback):', result.passportNumber);\n          break;\n        }\n      }\n    }\n    \n    // Extract Next of Kin (NOK) details - Section 8\n    const nokMatch = text.match(/8\\.\\s*Next\\s*of\\s*Kin\\s*\\(NOK\\)\\s*:?([\\s\\S]*?)(?:9\\.|VI\\.|$)/i);\n    if (nokMatch) {\n      const nokSection = nokMatch[1];\n      console.log('Found NOK section:', nokSection.substring(0, 200));\n      \n      // NOK Name - usually appears after \"Name\" label, format like \"MRS. BINITA KUMARI\"\n      // IMPORTANT: Stop before relationship words (WIFE, HUSBAND, etc.) and address parts\n      const nokNameMatch = nokSection.match(/(?:Name[\\s:]*\\n?|^)([A-Z]{2,4}\\.\\s*[A-Z][A-Z\\s]+?)(?=\\n|WIFE|HUSBAND|FATHER|MOTHER|PARENT|BROTHER|SISTER|SON|DAUGHTER|D\\.NO|D\\.No)/im) ||\n                          nokSection.match(/\\n([A-Z]{2,4}\\.\\s*[A-Z][A-Z\\s]+?)(?=\\n(?:WIFE|HUSBAND|FATHER|MOTHER|PARENT|BROTHER|SISTER|SON|DAUGHTER|D\\.NO|D\\.No|\\d))/i);\n      if (nokNameMatch) {\n        let nokName = nokNameMatch[1].trim().toUpperCase();\n        // Remove trailing relationship words if accidentally captured\n        nokName = nokName.replace(/\\s+(WIFE|HUSBAND|FATHER|MOTHER|PARENT|BROTHER|SISTER|SON|DAUGHTER)\\s*$/i, '');\n        // Remove trailing 'D' which is start of address\n        nokName = nokName.replace(/\\s+D\\s*$/i, '');\n        result.nokName = nokName;\n        console.log('Found NOK Name:', result.nokName);\n      }\n      \n      // Relationship - words like WIFE, HUSBAND, PARENT, FATHER, MOTHER, etc.\n      const relationshipMatch = nokSection.match(/\\n(WIFE|HUSBAND|FATHER|MOTHER|PARENT|BROTHER|SISTER|SON|DAUGHTER)\\n/i);\n      if (relationshipMatch) {\n        result.nokRelationship = relationshipMatch[1].toUpperCase();\n        console.log('Found NOK Relationship:', result.nokRelationship);\n      }\n      \n      // NOK Email - look for email pattern\n      const nokEmailMatch = nokSection.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,})/);\n      if (nokEmailMatch) {\n        result.nokEmail = nokEmailMatch[1].toLowerCase();\n        console.log('Found NOK Email:', result.nokEmail);\n      }\n      \n      // NOK Telephone - look for phone number (Indian format typically 10 digits)\n      const nokTelMatch = nokSection.match(/(?:Tel\\s*No\\.?[\\s:]*)?(\\d{10,12})/i);\n      if (nokTelMatch) {\n        result.nokTelephone = nokTelMatch[1];\n        console.log('Found NOK Telephone:', result.nokTelephone);\n      }\n      \n      // NOK Postal Address - from 8a section\n      // IMPORTANT: Only extract the actual street address, not name/relationship\n      const nokAddressMatch = nokSection.match(/8\\s*a\\.?\\s*NOK['']?s?\\s*Postal\\s*Address\\s*:?\\s*([\\s\\S]*?)(?:\\d{10,}|$)/i) ||\n                             nokSection.match(/Postal\\s*Address\\s*:?\\s*([\\s\\S]*?)(?:\\d{10,}|$)/i);\n      if (nokAddressMatch) {\n        let addressText = nokAddressMatch[1];\n        \n        // Remove name patterns (MRS./MR. followed by name)\n        addressText = addressText.replace(/^[\\s,]*(?:MRS?\\.?|MISS)\\s+[A-Z][A-Z\\s]+/i, '');\n        \n        // Remove relationship words that appear on their own line\n        addressText = addressText.replace(/^[\\s,]*(WIFE|HUSBAND|FATHER|MOTHER|PARENT|BROTHER|SISTER|SON|DAUGHTER)[\\s,]*/gi, '');\n        \n        // Clean up the address - join multiple lines\n        result.nokPostalAddress = addressText\n          .replace(/\\n/g, ', ')\n          .replace(/,\\s*,/g, ',')\n          .replace(/^\\s*,\\s*/, '')\n          .replace(/,\\s*$/, '')\n          .trim()\n          .toUpperCase();\n        \n        // Additional cleanup: if address still starts with relationship word, remove it\n        result.nokPostalAddress = result.nokPostalAddress.replace(/^(WIFE|HUSBAND|FATHER|MOTHER|PARENT|BROTHER|SISTER|SON|DAUGHTER),?\\s*/i, '');\n        \n        console.log('Found NOK Postal Address:', result.nokPostalAddress);\n      }\n    }\n    \n    // Extract Competency Certificate (COC) details - Section 9\n    const cocMatch = text.match(/9\\.\\s*Details\\s*of\\s*Competency\\s*Certificates?\\s*:?([\\s\\S]*?)(?:10\\.|VI\\.|VII\\.|$)/i) ||\n                    text.match(/Competency\\s*Certificate[s]?\\s*:?([\\s\\S]*?)(?:10\\.|VI\\.|VII\\.|$)/i);\n    if (cocMatch) {\n      const cocSection = cocMatch[1];\n      console.log('Found COC section:', cocSection.substring(0, 300));\n      \n      // COC Grade / No - In PDF layout, labels and values are on separate lines\n      // Look for patterns like \"Mate of a Home-Trade Ship (NCV) / NCVON421\" anywhere in the section\n      const gradePatterns = [\n        // Pattern: \"Mate of a Home-Trade Ship (NCV)  /  NCVON421\"\n        /\\b(Mate\\s+of\\s+[^\\/\\n]+\\s*\\/\\s*[A-Z0-9]+)/i,\n        // Pattern: \"Master (F.G.) / 23-MUM-2024\"\n        /\\b(Master\\s*(?:\\([^)]+\\))?\\s*\\/\\s*[\\w\\-]+)/i,\n        // Pattern: \"Chief Officer / NCV123\"\n        /\\b(Chief\\s*(?:Officer|Engineer)\\s*(?:\\([^)]+\\))?\\s*\\/\\s*[\\w\\-]+)/i,\n        // Pattern: \"Second Officer / ABC123\"\n        /\\b((?:Second|Third)\\s*(?:Officer|Engineer)\\s*(?:\\([^)]+\\))?\\s*\\/\\s*[\\w\\-]+)/i,\n        // Generic pattern: Any text followed by / and alphanumeric ID (but exclude labels)\n        /\\n([A-Za-z][A-Za-z\\s\\(\\)\\-\\.]+\\s*\\/\\s*[A-Z0-9]+)(?:\\n|$)/i\n      ];\n      \n      for (const pattern of gradePatterns) {\n        const match = cocSection.match(pattern);\n        if (match && match[1]) {\n          const gradeValue = match[1].trim();\n          // Make sure we're not capturing labels like \"COC Grade / No\" or \"Place of Issue\"\n          if (!gradeValue.match(/^(COC\\s*)?Grade\\s*\\/?\\s*No|Place\\s*of\\s*Issue|Date\\s*of/i)) {\n            result.cocGradeNo = gradeValue.toUpperCase();\n            console.log('Found COC Grade/No:', result.cocGradeNo);\n            break;\n          }\n        }\n      }\n      \n      // COC Place of Issue\n      const cocPlaceMatch = cocSection.match(/Place\\s*of\\s*Issue\\s*:?\\s*([A-Z][A-Z\\s]+?)(?:\\n|$)/i) ||\n                           cocSection.match(/\\n([A-Z]{3,15})\\n.*(?:Issue|Date)/i);\n      if (cocPlaceMatch) {\n        result.cocPlaceOfIssue = cocPlaceMatch[1].trim().toUpperCase();\n        console.log('Found COC Place of Issue:', result.cocPlaceOfIssue);\n      }\n      \n      // COC Dates - look for DD-MMM-YYYY format\n      const cocDates = cocSection.match(/(\\d{2}-[A-Z]{3}-\\d{4})/gi);\n      if (cocDates && cocDates.length >= 1) {\n        result.cocIssueDate = cocDates[0].toUpperCase();\n        console.log('Found COC Issue Date:', result.cocIssueDate);\n        if (cocDates.length >= 2) {\n          result.cocExpiryDate = cocDates[1].toUpperCase();\n          console.log('Found COC Expiry Date:', result.cocExpiryDate);\n        }\n      }\n      \n      // Alternative date patterns\n      if (!result.cocIssueDate) {\n        const issueDateMatch = cocSection.match(/(?:Date\\s*of\\s*Issue|Issue\\s*Date)\\s*:?\\s*(\\d{2}[-\\/]\\w{3}[-\\/]\\d{4})/i);\n        if (issueDateMatch) {\n          result.cocIssueDate = issueDateMatch[1].replace(/\\//g, '-').toUpperCase();\n          console.log('Found COC Issue Date (alt):', result.cocIssueDate);\n        }\n      }\n      if (!result.cocExpiryDate) {\n        const expiryDateMatch = cocSection.match(/(?:Date\\s*of\\s*Expiry|Expiry\\s*Date|Valid\\s*Till)\\s*:?\\s*(\\d{2}[-\\/]\\w{3}[-\\/]\\d{4})/i);\n        if (expiryDateMatch) {\n          result.cocExpiryDate = expiryDateMatch[1].replace(/\\//g, '-').toUpperCase();\n          console.log('Found COC Expiry Date (alt):', result.cocExpiryDate);\n        }\n      }\n    }\n    \n    // Extract Medical Certificate details - Section 11\n    const medicalMatch = text.match(/11\\.\\s*Details\\s*of\\s*Medical\\s*Certificate\\s*:?([\\s\\S]*?)(?:12\\.|VI\\.\\s*Details|VIII\\.|IX\\.|$)/i) ||\n                        text.match(/Medical\\s*Certificate\\s*:?([\\s\\S]*?)(?:12\\.|VI\\.\\s*Details|VIII\\.|IX\\.|$)/i);\n    if (medicalMatch) {\n      const medicalSection = medicalMatch[1];\n      console.log('Found Medical Certificate section:', medicalSection.substring(0, 300));\n      \n      // First, find the Approval No pattern (e.g., MAH/NM/22/2015) - alphanumeric with slashes\n      const approvalNoMatch = medicalSection.match(/\\n([A-Z]{2,5}\\/[A-Z]{1,3}\\/\\d{1,4}\\/\\d{4})\\n/i) ||\n                              medicalSection.match(/([A-Z]{2,5}\\/[A-Z]{1,3}\\/\\d{1,4}\\/\\d{4})/i);\n      if (approvalNoMatch) {\n        result.medicalApprovalNo = approvalNoMatch[1].trim().toUpperCase();\n        console.log('Found Medical Approval No:', result.medicalApprovalNo);\n      }\n      \n      // Issuing Authority - look for DR. pattern, capture name until approval number pattern or date\n      // The text structure shows: \"DR. DIWAKAR TIWARI ( GLOBUS\\nMEDICARE)\\nMAH/NM/22/2015\"\n      const issuingAuthorityMatch = medicalSection.match(/(DR\\.?\\s+[A-Z][A-Z\\s\\.\\(\\)\\-]+?)(?:\\n[A-Z]{2,5}\\/|$)/i);\n      if (issuingAuthorityMatch) {\n        // Clean up the authority name - remove trailing newlines and join multiline text\n        let authority = issuingAuthorityMatch[1]\n          .replace(/\\n/g, ' ')\n          .replace(/\\s+/g, ' ')\n          .trim()\n          .toUpperCase();\n        result.medicalIssuingAuthority = authority;\n        console.log('Found Medical Issuing Authority:', result.medicalIssuingAuthority);\n      }\n      \n      // Medical Dates - look for Issue Date and Expiry Date patterns\n      const issueMatch = medicalSection.match(/Issue\\s*Date\\s*:?\\s*(\\d{2}-[A-Z]{3}-\\d{4})/i);\n      if (issueMatch) {\n        result.medicalIssueDate = issueMatch[1].toUpperCase();\n        console.log('Found Medical Issue Date:', result.medicalIssueDate);\n      }\n      \n      const expiryMatch = medicalSection.match(/Expiry\\s*Date\\s*:?\\s*(\\d{2}-[A-Z]{3}-\\d{4})/i);\n      if (expiryMatch) {\n        result.medicalExpiryDate = expiryMatch[1].toUpperCase();\n        console.log('Found Medical Expiry Date:', result.medicalExpiryDate);\n      }\n      \n      // If dates not found with labels, try to find DD-MMM-YYYY patterns in the section\n      if (!result.medicalIssueDate || !result.medicalExpiryDate) {\n        const medicalDates = medicalSection.match(/(\\d{2}-[A-Z]{3}-\\d{4})/gi);\n        if (medicalDates && medicalDates.length >= 1 && !result.medicalIssueDate) {\n          result.medicalIssueDate = medicalDates[0].toUpperCase();\n          console.log('Found Medical Issue Date (fallback):', result.medicalIssueDate);\n        }\n        if (medicalDates && medicalDates.length >= 2 && !result.medicalExpiryDate) {\n          result.medicalExpiryDate = medicalDates[1].toUpperCase();\n          console.log('Found Medical Expiry Date (fallback):', result.medicalExpiryDate);\n        }\n      }\n    }\n    \n    // Extract Ship Details - Section IV\n    const shipMatch = text.match(/IV\\.?\\s*Details\\s*of\\s*Ship\\s*:?\\s*\\(?(?:Place\\s*of\\s*work)?\\)?([\\s\\S]*?)(?:V\\.\\s*Details|$)/i);\n    if (shipMatch) {\n      const shipSection = shipMatch[1];\n      console.log('Found Ship section:', shipSection.substring(0, 200));\n      \n      // Ship Name - Look for \"1. Name:\" followed by value on next line(s)\n      // In the PDF, the format shows: \"1. Name  :\" then \"AQUA TOW\" on a later line\n      const shipNameMatch = shipSection.match(/1\\.?\\s*Name\\s*:?\\s*\\n([A-Z][A-Z\\s\\-0-9]+)/i) ||\n                            shipSection.match(/\\n([A-Z][A-Z\\s]{2,30})\\n(?:MUMBAI|CHENNAI|KOLKATA|DELHI)/i);\n      if (shipNameMatch) {\n        result.shipName = shipNameMatch[1].trim().toUpperCase();\n        console.log('Found Ship Name:', result.shipName);\n      } else {\n        // Alternative: Look for standalone all-caps ship name in the section\n        const lines = shipSection.split('\\n').filter(l => l.trim().length > 0);\n        for (const line of lines) {\n          const trimmed = line.trim();\n          // Ship names are typically short all-caps words like \"AQUA TOW\", \"MV OCEAN STAR\"\n          if (/^[A-Z][A-Z\\s\\-0-9]{2,30}$/.test(trimmed) && \n              !trimmed.includes('NAME') && \n              !trimmed.includes('DETAILS') &&\n              !trimmed.includes('PORT') &&\n              !trimmed.includes('REGISTRY')) {\n            result.shipName = trimmed;\n            console.log('Found Ship Name (fallback):', result.shipName);\n            break;\n          }\n        }\n      }\n    }\n    \n    // Fallback: If name not found, use the one extracted earlier\n    if (!result.seafarerName && result.name) {\n      result.seafarerName = result.name;\n      console.log('Using crew name as seafarer name:', result.seafarerName);\n    }\n\n    // Extract Capacity / Rank Employed from VI. Details of Employment section\n    const capacityRankMatch = text.match(/VI\\.?\\s*Details\\s*of\\s*Employment\\s*:?([\\s\\S]*?)(?:VII\\.|Page\\s+\\d|$)/i);\n    if (capacityRankMatch) {\n      const employmentSection = capacityRankMatch[1];\n      // Look for \"1. Capacity / Rank Employed\" followed by the rank value\n      // The rank appears after \"Capacity / Rank Employed\" label, typically on a separate line\n      const rankPatterns = [\n        /Capacity\\s*\\/?\\s*Rank\\s*Employed[:\\s]*([\\w\\s()/-]+?)(?:\\n\\d|\\n\\s*\\d|$)/i,\n        /(?:Master|Captain|Chief\\s+Officer|2nd\\s+Officer|3rd\\s+Officer|Chief\\s+Engineer|2nd\\s+Engineer|3rd\\s+Engineer|Bosun|AB|OS|Oiler|Fitter|Cook|Steward|Rating)\\s*\\([^)]+\\)/i,\n      ];\n      \n      // Try to find rank from the employment section values\n      // In the document format, values are listed separately after labels\n      const employmentLines = employmentSection.split('\\n').map(l => l.trim()).filter(l => l);\n      for (const line of employmentLines) {\n        // Match patterns like \"Master (NCV)\", \"Chief Officer (NCV)\", etc.\n        const rankMatch = line.match(/^((?:Master|Captain|Chief\\s+Officer|2nd\\s+Officer|3rd\\s+Officer|Chief\\s+Engineer|2nd\\s+Engineer|3rd\\s+Engineer|Bosun|AB|OS|Oiler|Fitter|Cook|Steward|Rating)(?:\\s*\\([^)]+\\))?)$/i);\n        if (rankMatch && !result.capacityRankEmployed) {\n          result.capacityRankEmployed = rankMatch[1].trim();\n          console.log('Found Capacity / Rank Employed:', result.capacityRankEmployed);\n          break;\n        }\n      }\n    }\n\n    // Extract Engagement Period (in months) - Format varies by document\n    // Pattern 1: \"Engagement Period : 3 Months\" (same line)\n    const engagementPatterns = [\n      /Engagement\\s*Period\\s*:?\\s*(\\d+)\\s*Month/i,\n      /Period\\s*of\\s*Engagement\\s*:?\\s*(\\d+)\\s*Month/i,\n      /Contract\\s*Period\\s*:?\\s*(\\d+)\\s*Month/i,\n      /Duration\\s*:?\\s*(\\d+)\\s*Month/i\n    ];\n    for (const pattern of engagementPatterns) {\n      const engagementMatch = text.match(pattern);\n      if (engagementMatch) {\n        result.engagementPeriodMonths = parseInt(engagementMatch[1], 10);\n        console.log('Found Engagement Period (months):', result.engagementPeriodMonths);\n        break;\n      }\n    }\n    \n    // Pattern 2: Handle VI. Details of Employment section where values are separate\n    // In this format: labels first, then values (Chief Officer, 3, 2.5, 77, etc.)\n    // The \"3\" after \"Chief Officer\" is the engagement period months\n    if (!result.engagementPeriodMonths) {\n      const employmentMatch = text.match(/VI\\.?\\s*Details\\s*of\\s*Employment\\s*:?([\\s\\S]*?)(?:VII\\.|Page\\s+\\d|$)/i);\n      if (employmentMatch) {\n        const employmentSection = employmentMatch[1];\n        console.log('Found Employment section for engagement period');\n        \n        // Look for the pattern: Rank/Capacity value followed by single digit (months)\n        // Format typically: \"Chief Officer (NCV)\" then \"3\" (months) then \"2.5\" (leave days)\n        const valuesMatch = employmentSection.match(/(?:Chief|Master|Captain|Officer|Engineer|Mate|Bosun|AB|OS|Oiler|Fitter|Cook|Steward)[^\\n]*\\n(\\d{1,2})\\n/i);\n        if (valuesMatch) {\n          const months = parseInt(valuesMatch[1], 10);\n          if (months >= 1 && months <= 24) { // Reasonable range for contract months\n            result.engagementPeriodMonths = months;\n            console.log('Found Engagement Period from employment section (months):', result.engagementPeriodMonths);\n          }\n        }\n      }\n    }\n\n    // Clean up all extracted string values\n    Object.keys(result).forEach(key => {\n      const value = result[key as keyof ExtractedCrewData];\n      if (value && typeof value === 'string') {\n        (result as any)[key] = value\n          .replace(/\\s+/g, ' ')\n          .trim();\n      }\n    });\n\n    // If no name was found, it might be missing from OCR - note this in logs\n    if (!result.name) {\n      // Note: Employee names are often not detected due to font/format limitations in maritime documents\n      // This is expected behavior and users can manually enter names when needed\n      console.log('Employee name not detected - this is normal for maritime contract documents');\n    }\n\n    console.log('Final parsed crew data:', result);\n    return result;\n  }\n\n  async cleanup() {\n    if (this.worker) {\n      await this.worker.terminate();\n      this.worker = null;\n    }\n  }\n\n  async extractCrewDataWithRecord(base64Data: string, filename?: string): Promise<ExtractedCrewRecord> {\n    const data = await this.extractCrewDataFromDocument(base64Data, filename);\n    \n    // Generate a unique record ID\n    const recordId = `crew-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    \n    // Create a display name from the extracted data\n    const displayName = data.seafarerName || data.name || 'Unknown Crew Member';\n    \n    return {\n      ...data,\n      recordId,\n      displayName,\n    };\n  }\n}\n\nexport const localOcrService = new LocalOCRService();\n","path":null,"size_bytes":44313,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"deployment/shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, timestamp, integer, boolean, jsonb } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Users table for authentication\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  role: text(\"role\").notNull(), // 'admin', 'office_staff'\n  email: text(\"email\").notNull(),\n  name: text(\"name\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Vessels table\nexport const vessels = pgTable(\"vessels\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(),\n  imoNumber: text(\"imo_number\").unique(),\n  flag: text(\"flag\").notNull(),\n  status: text(\"status\").notNull().default('active'), // 'active', 'maintenance', 'inactive'\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Crew members table\nexport const crewMembers = pgTable(\"crew_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  firstName: text(\"first_name\").notNull(),\n  lastName: text(\"last_name\").notNull(),\n  nationality: text(\"nationality\").notNull(),\n  dateOfBirth: timestamp(\"date_of_birth\").notNull(),\n  rank: text(\"rank\").notNull(),\n  phoneNumber: text(\"phone_number\"),\n  emergencyContact: jsonb(\"emergency_contact\"), // {name, relationship, phone, email}\n  currentVesselId: varchar(\"current_vessel_id\").references(() => vessels.id),\n  status: text(\"status\").notNull().default('active'), // 'active', 'onLeave', 'inactive'\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Contracts table\nexport const contracts = pgTable(\"contracts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  crewMemberId: varchar(\"crew_member_id\").notNull().references(() => crewMembers.id),\n  vesselId: varchar(\"vessel_id\").notNull().references(() => vessels.id),\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  durationDays: integer(\"duration_days\"), // Number of days for the contract\n  salary: integer(\"salary\"),\n  currency: text(\"currency\").default('USD'),\n  status: text(\"status\").notNull().default('active'), // 'active', 'completed', 'terminated'\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Documents table\nexport const documents = pgTable(\"documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  crewMemberId: varchar(\"crew_member_id\").notNull().references(() => crewMembers.id),\n  type: text(\"type\").notNull(), // 'passport', 'cdc', 'stcw', 'medical', 'visa'\n  documentNumber: text(\"document_number\").notNull(),\n  issueDate: timestamp(\"issue_date\").notNull(),\n  expiryDate: timestamp(\"expiry_date\").notNull(),\n  issuingAuthority: text(\"issuing_authority\").notNull(),\n  status: text(\"status\").notNull().default('valid'), // 'valid', 'expiring', 'expired'\n  filePath: text(\"file_path\"), // For file storage reference\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Crew rotations/scheduling\nexport const crewRotations = pgTable(\"crew_rotations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  crewMemberId: varchar(\"crew_member_id\").notNull().references(() => crewMembers.id),\n  vesselId: varchar(\"vessel_id\").notNull().references(() => vessels.id),\n  joinDate: timestamp(\"join_date\").notNull(),\n  leaveDate: timestamp(\"leave_date\"),\n  rotationType: text(\"rotation_type\").notNull(), // 'join', 'leave', 'rotation'\n  status: text(\"status\").notNull().default('scheduled'), // 'scheduled', 'completed', 'cancelled'\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Email notification settings\nexport const emailSettings = pgTable(\"email_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  reminderDays: jsonb(\"reminder_days\").default([30, 15, 7]), // Days before expiry to send reminders\n  enabled: boolean(\"enabled\").default(true),\n  recipients: jsonb(\"recipients\").default(['office_staff', 'admin']), // Who receives notifications\n  emailTemplate: text(\"email_template\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Activity log table for tracking all system activities\nexport const activityLogs = pgTable(\"activity_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  type: text(\"type\").notNull(), // 'User Registration', 'Crew Management', 'Contract Management', etc.\n  action: text(\"action\").notNull(), // 'create', 'update', 'delete'\n  entityType: text(\"entity_type\").notNull(), // 'user', 'crew', 'vessel', 'contract', etc.\n  entityId: text(\"entity_id\"), // ID of the affected entity\n  userId: varchar(\"user_id\").references(() => users.id),\n  username: text(\"username\").notNull(),\n  userRole: text(\"user_role\").notNull(),\n  description: text(\"description\").notNull(),\n  severity: text(\"severity\").notNull().default('info'), // 'info', 'success', 'warning', 'error'\n  metadata: jsonb(\"metadata\"), // Additional context data\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Create insert schemas with proper validation\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  role: z.enum([\"admin\", \"office_staff\"]),\n});\n\nexport const insertVesselSchema = createInsertSchema(vessels).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertCrewMemberSchema = createInsertSchema(crewMembers).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  dateOfBirth: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n});\n\nexport const insertContractSchema = createInsertSchema(contracts).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  startDate: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n  endDate: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n});\n\nexport const insertDocumentSchema = createInsertSchema(documents).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertCrewRotationSchema = createInsertSchema(crewRotations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertEmailSettingsSchema = createInsertSchema(emailSettings).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport const insertActivityLogSchema = createInsertSchema(activityLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Type exports\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type Vessel = typeof vessels.$inferSelect;\nexport type InsertVessel = z.infer<typeof insertVesselSchema>;\nexport type CrewMember = typeof crewMembers.$inferSelect;\nexport type InsertCrewMember = z.infer<typeof insertCrewMemberSchema>;\nexport type Contract = typeof contracts.$inferSelect;\nexport type InsertContract = z.infer<typeof insertContractSchema>;\nexport type Document = typeof documents.$inferSelect;\nexport type InsertDocument = z.infer<typeof insertDocumentSchema>;\nexport type CrewRotation = typeof crewRotations.$inferSelect;\nexport type InsertCrewRotation = z.infer<typeof insertCrewRotationSchema>;\nexport type EmailSettings = typeof emailSettings.$inferSelect;\nexport type InsertEmailSettings = z.infer<typeof insertEmailSettingsSchema>;\nexport type ActivityLog = typeof activityLogs.$inferSelect;\nexport type InsertActivityLog = z.infer<typeof insertActivityLogSchema>;\n\n// Additional types for API responses\nexport type CrewMemberWithDetails = CrewMember & {\n  user?: User;\n  currentVessel?: Vessel;\n  documents?: Document[];\n  activeContract?: Contract;\n};\n\nexport type VesselWithCrew = Vessel & {\n  crewMembers?: CrewMemberWithDetails[];\n};\n\nexport type DocumentAlert = {\n  document: Document;\n  crewMember: CrewMember;\n  daysUntilExpiry: number;\n  severity: 'critical' | 'warning' | 'info';\n};\n","path":null,"size_bytes":7929,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n        'maritime-navy': 'var(--maritime-navy)',\n        'ocean-blue': 'var(--ocean-blue)',\n        'warning-amber': 'var(--warning-amber)',\n        'compliance-green': 'var(--compliance-green)',\n        'text-navy': 'var(--text-navy)',\n        'alert-red': 'var(--alert-red)',\n        'light-bg': 'var(--light-bg)',\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n        wave: {\n          \"0%, 100%\": { transform: \"rotate(0deg)\" },\n          \"25%\": { transform: \"rotate(3deg)\" },\n          \"75%\": { transform: \"rotate(-3deg)\" },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n        wave: \"wave 2s ease-in-out infinite\",\n      },\n      spacing: {\n        '18': '4.5rem',\n        '88': '22rem',\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":3368,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"server/objectStorage.ts":{"content":"import { Storage, File } from \"@google-cloud/storage\";\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\n// The object storage client is used to interact with the object storage service.\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\n// The object storage service for vessel documents\nexport class VesselDocumentStorageService {\n  constructor() {}\n\n  // Gets the private object directory for vessel documents\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  // Gets the upload URL for a vessel document\n  async getVesselDocumentUploadURL(vesselId: string, fileName: string): Promise<string> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    if (!privateObjectDir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n\n    const objectId = randomUUID();\n    const fullPath = `${privateObjectDir}/vessels/${vesselId}/documents/${objectId}-${fileName}`;\n\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n\n    // Sign URL for PUT method with TTL\n    return signObjectURL({\n      bucketName,\n      objectName,\n      method: \"PUT\",\n      ttlSec: 900, // 15 minutes\n    });\n  }\n\n  // Gets the download URL for a vessel document\n  async getVesselDocumentDownloadURL(filePath: string): Promise<string> {\n    const { bucketName, objectName } = parseObjectPath(filePath);\n\n    return signObjectURL({\n      bucketName,\n      objectName,\n      method: \"GET\",\n      ttlSec: 3600, // 1 hour\n    });\n  }\n\n  // Gets the vessel document file from the file path\n  async getVesselDocumentFile(filePath: string): Promise<File> {\n    const { bucketName, objectName } = parseObjectPath(filePath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return objectFile;\n  }\n\n  // Downloads a vessel document to the response\n  async downloadVesselDocument(filePath: string, res: Response, cacheTtlSec: number = 3600) {\n    try {\n      const file = await this.getVesselDocumentFile(filePath);\n      \n      // Get file metadata\n      const [metadata] = await file.getMetadata();\n      \n      // Set appropriate headers\n      res.set({\n        \"Content-Type\": metadata.contentType || \"application/octet-stream\",\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `private, max-age=${cacheTtlSec}`,\n      });\n\n      // Stream the file to the response\n      const stream = file.createReadStream();\n\n      stream.on(\"error\", (err) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (error instanceof ObjectNotFoundError) {\n        if (!res.headersSent) {\n          res.status(404).json({ error: \"File not found\" });\n        }\n      } else {\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error downloading file\" });\n        }\n      }\n    }\n  }\n\n  // Deletes a vessel document from object storage\n  async deleteVesselDocument(filePath: string): Promise<boolean> {\n    try {\n      const file = await this.getVesselDocumentFile(filePath);\n      await file.delete();\n      return true;\n    } catch (error) {\n      if (error instanceof ObjectNotFoundError) {\n        return false;\n      }\n      console.error(\"Error deleting vessel document:\", error);\n      throw error;\n    }\n  }\n\n  // Normalize the file path from upload URL to storage path\n  normalizeVesselDocumentPath(uploadUrl: string): string {\n    if (!uploadUrl.startsWith(\"https://storage.googleapis.com/\")) {\n      return uploadUrl;\n    }\n\n    // Extract the path from the URL by removing query parameters and domain\n    const url = new URL(uploadUrl);\n    return url.pathname;\n  }\n}\n\nfunction parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n\n  return {\n    bucketName,\n    objectName,\n  };\n}\n\nasync function signObjectURL({\n  bucketName,\n  objectName,\n  method,\n  ttlSec,\n}: {\n  bucketName: string;\n  objectName: string;\n  method: \"GET\" | \"PUT\" | \"DELETE\" | \"HEAD\";\n  ttlSec: number;\n}): Promise<string> {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(\n      `Failed to sign object URL, errorcode: ${response.status}, ` +\n        `make sure you're running on Replit`\n    );\n  }\n\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}","path":null,"size_bytes":6246,"size_tokens":null},"client/src/components/ui/theme-toggle.tsx":{"content":"import { Moon, Sun } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { useTheme } from '@/contexts/theme-context';\n\nexport function ThemeToggle() {\n  const { theme, toggleTheme } = useTheme();\n\n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"sm\"\n      onClick={toggleTheme}\n      className=\"h-9 w-9 p-0\"\n      data-testid=\"theme-toggle\"\n      title={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}\n    >\n      <Sun className=\"h-4 w-4 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\n      <Moon className=\"absolute h-4 w-4 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\n      <span className=\"sr-only\">Toggle theme</span>\n    </Button>\n  );\n}","path":null,"size_bytes":727,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n\nexport function formatDate(date: Date | string | null | undefined): string {\n  if (!date) return '-';\n  const d = typeof date === 'string' ? new Date(date) : date;\n  if (isNaN(d.getTime())) return '-';\n  const day = d.getDate().toString().padStart(2, '0');\n  const month = (d.getMonth() + 1).toString().padStart(2, '0');\n  const year = d.getFullYear();\n  return `${day}/${month}/${year}`;\n}\n","path":null,"size_bytes":558,"size_tokens":null},"client/src/contexts/theme-context.tsx":{"content":"import React, { createContext, useContext, useEffect, useState } from 'react';\n\ntype Theme = 'light' | 'dark';\n\ninterface ThemeContextType {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n  toggleTheme: () => void;\n}\n\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\n\nexport function ThemeProvider({ children }: { children: React.ReactNode }) {\n  const [theme, setTheme] = useState<Theme>(() => {\n    // Check localStorage first, then system preference\n    const savedTheme = localStorage.getItem('theme') as Theme | null;\n    if (savedTheme) {\n      return savedTheme;\n    }\n    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';\n  });\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n    \n    // Remove previous theme classes\n    root.classList.remove('light', 'dark');\n    \n    // Add current theme class\n    root.classList.add(theme);\n    \n    // Save to localStorage\n    localStorage.setItem('theme', theme);\n  }, [theme]);\n\n  const toggleTheme = () => {\n    setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');\n  };\n\n  const value = {\n    theme,\n    setTheme,\n    toggleTheme,\n  };\n\n  return (\n    <ThemeContext.Provider value={value}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const context = useContext(ThemeContext);\n  if (context === undefined) {\n    throw new Error('useTheme must be used within a ThemeProvider');\n  }\n  return context;\n}","path":null,"size_bytes":1493,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/crew/OCRDocumentScanner.tsx":{"content":"import { useState, useRef, useCallback } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Loader2, Camera, Upload, FileText, CheckCircle, AlertCircle, Sparkles, X, Scan, Users, Trash2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { getAuthHeaders } from \"@/lib/auth\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { useExtractedRecords, ExtractedCrewRecord } from \"@/contexts/extracted-records-context\";\n\ninterface ExtractedCrewData {\n  name?: string;\n  position?: string;\n  nationality?: string;\n  dateOfBirth?: string;\n  passportNumber?: string;\n  seamansBookNumber?: string;\n  cdcNumber?: string;\n  phoneNumber?: string;\n  email?: string;\n  emergencyContact?: string;\n  emergencyPhone?: string;\n  contractStartDate?: string;\n  contractEndDate?: string;\n  joinDate?: string;\n  leaveDate?: string;\n  vessel?: string;\n  salary?: string;\n  shipOwnerName?: string;\n  shipOwnerContactPerson?: string;\n  shipOwnerPostalAddress?: string;\n  seafarerName?: string;\n  seafarerRank?: string;\n  capacityRankEmployed?: string;\n  seafarerNationality?: string;\n  seafarerDatePlaceOfBirth?: string;\n  seafarerIndosNumber?: string;\n  seafarerPostalAddress?: string;\n  seafarerEmail?: string;\n  seafarerMobile?: string;\n  cdcPlaceOfIssue?: string;\n  cdcIssueDate?: string;\n  cdcExpiryDate?: string;\n  passportPlaceOfIssue?: string;\n  passportIssueDate?: string;\n  passportExpiryDate?: string;\n  nokName?: string;\n  nokRelationship?: string;\n  nokEmail?: string;\n  nokTelephone?: string;\n  nokPostalAddress?: string;\n  cocGradeNo?: string;\n  cocPlaceOfIssue?: string;\n  cocIssueDate?: string;\n  cocExpiryDate?: string;\n  medicalIssuingAuthority?: string;\n  medicalApprovalNo?: string;\n  medicalIssueDate?: string;\n  medicalExpiryDate?: string;\n  shipName?: string;\n  engagementPeriodMonths?: number;\n  recordId?: string;\n  displayName?: string;\n}\n\ninterface OCRDocumentScannerProps {\n  onDataExtracted: (data: ExtractedCrewData) => void;\n  className?: string;\n  mode?: 'crew' | 'shipOwner' | 'seafarer';\n}\n\nexport function OCRDocumentScanner({ onDataExtracted, className, mode = 'crew' }: OCRDocumentScannerProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [extractedData, setExtractedData] = useState<ExtractedCrewData | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [isDragging, setIsDragging] = useState(false);\n  const [showRecordSelector, setShowRecordSelector] = useState(false);\n  const [selectedRecordId, setSelectedRecordId] = useState<string>('');\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const { toast } = useToast();\n  const { records, addRecord, getRecord, removeRecord, isRecordUsed, markRecordAsUsed } = useExtractedRecords();\n\n  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {\n      setError(\"Please select an image file (JPG, PNG) or PDF document.\");\n      return;\n    }\n\n    if (file.size > 10 * 1024 * 1024) {\n      setError(\"File size must be less than 10MB.\");\n      return;\n    }\n\n    await processDocument(file);\n  };\n\n  const handleDrop = useCallback(async (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n    \n    const file = e.dataTransfer.files?.[0];\n    if (!file) return;\n\n    if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {\n      setError(\"Please select an image file (JPG, PNG) or PDF document.\");\n      return;\n    }\n\n    if (file.size > 10 * 1024 * 1024) {\n      setError(\"File size must be less than 10MB.\");\n      return;\n    }\n\n    await processDocument(file);\n  }, []);\n\n  const handleDragOver = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  }, []);\n\n  const handleDragLeave = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n  }, []);\n\n  const processDocument = async (file: File) => {\n    setIsProcessing(true);\n    setError(null);\n    setExtractedData(null);\n\n    try {\n      const base64 = await fileToBase64(file);\n      \n      const response = await fetch('/api/ocr/extract-crew-data', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...getAuthHeaders(),\n        },\n        body: JSON.stringify({ \n          image: base64,\n          filename: file.name \n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to process document');\n      }\n\n      const data = await response.json();\n      const record = addRecord(data);\n      setExtractedData({ ...data, recordId: record.recordId, displayName: record.displayName });\n      \n      toast({\n        title: \"Document Processed Successfully\",\n        description: `Extracted data for ${record.displayName}. The record has been saved.`,\n      });\n\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : \"Failed to process document\";\n      setError(errorMessage);\n      toast({\n        title: \"Processing Failed\",\n        description: errorMessage,\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  const fileToBase64 = (file: File): Promise<string> => {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.readAsDataURL(file);\n      reader.onload = () => {\n        const result = reader.result as string;\n        const base64 = result.split(',')[1];\n        resolve(base64);\n      };\n      reader.onerror = reject;\n    });\n  };\n\n  const handleUseExtractedData = () => {\n    if (extractedData) {\n      if (extractedData.recordId) {\n        markRecordAsUsed(extractedData.recordId);\n      }\n      onDataExtracted(extractedData);\n      setIsOpen(false);\n      setExtractedData(null);\n      setError(null);\n      \n      toast({\n        title: \"Data Applied\",\n        description: \"Extracted information has been filled into the form.\",\n      });\n    }\n  };\n\n  const handleSelectSavedRecord = () => {\n    if (selectedRecordId) {\n      const record = getRecord(selectedRecordId);\n      if (record) {\n        markRecordAsUsed(record.recordId);\n        onDataExtracted({ ...record.data, recordId: record.recordId, displayName: record.displayName });\n        setIsOpen(false);\n        setShowRecordSelector(false);\n        setSelectedRecordId('');\n        \n        toast({\n          title: \"Data Applied\",\n          description: `Applied data for ${record.displayName}.`,\n        });\n      }\n    }\n  };\n\n  const handleRemoveRecord = (recordId: string) => {\n    removeRecord(recordId);\n    if (selectedRecordId === recordId) {\n      setSelectedRecordId('');\n    }\n    toast({\n      title: \"Record Removed\",\n      description: \"The extracted record has been removed.\",\n    });\n  };\n\n  const availableRecords = records.filter(r => !isRecordUsed(r.recordId));\n\n  const handleTakePhoto = () => {\n    fileInputRef.current?.click();\n  };\n\n  const getModeTitle = () => {\n    switch (mode) {\n      case 'shipOwner':\n        return 'Scan Ship Owner Document';\n      case 'seafarer':\n        return 'Scan Seafarer Document';\n      default:\n        return 'Scan Crew Document';\n    }\n  };\n\n  const getModeDescription = () => {\n    switch (mode) {\n      case 'shipOwner':\n        return 'ship owner';\n      case 'seafarer':\n        return 'seafarer';\n      default:\n        return 'crew';\n    }\n  };\n\n  const getDemoData = (): ExtractedCrewData => {\n    switch (mode) {\n      case 'shipOwner':\n        return {\n          shipOwnerName: \"GLOBAL CAMBAYMARINE SERVICES PVT. LTD\",\n          shipOwnerContactPerson: \"MR. ZOHAR A MALAMPATTIWALA\",\n          shipOwnerPostalAddress: \"3/684, HUSSAINI VILLA, NAVAPURAKARWA ROAD, SURAT, SURAT-395003, GUJRAT, INDIA - GCMSPL@GMAIL.COM\"\n        };\n      case 'seafarer':\n        return {\n          seafarerName: \"VINEET KUMAR\",\n          seafarerNationality: \"INDIAN\",\n          seafarerDatePlaceOfBirth: \"09-MAR-1982 & ROHTAS-BIHAR\",\n          seafarerIndosNumber: \"07NL1441\",\n          seafarerPostalAddress: \"FLT. NO. 105 MAURA ENCLAVE VIJAY VIHAR COLONY, NEAR RPS LAW COLLAGE\",\n          seafarerEmail: \"vineetkmr65@gmail.com\",\n          seafarerMobile: \"09987291454\",\n          cdcNumber: \"MUM 132798\",\n          cdcPlaceOfIssue: \"MUMBAI\",\n          cdcIssueDate: \"28-MAR-2025\",\n          cdcExpiryDate: \"27-MAR-2035\",\n          passportNumber: \"R2826385\",\n          passportPlaceOfIssue: \"PATNA\",\n          passportIssueDate: \"04-JUL-2017\",\n          passportExpiryDate: \"03-JUL-2027\",\n          nokName: \"MRS. BINITA KUMARI\",\n          nokRelationship: \"WIFE\",\n          nokTelephone: \"8538955893\",\n          nokPostalAddress: \"102, MOURA ENCLAVE, VIJAY VIHAR COLONY, NEAR RPS LAW COLLAGE PATNA, BIHAR, PIN-801503\",\n          cocGradeNo: \"MASTER (F.G.) / 23-MUM-2024\",\n          cocPlaceOfIssue: \"MUMBAI\",\n          cocIssueDate: \"15-JAN-2024\",\n          cocExpiryDate: \"14-JAN-2029\",\n          medicalIssuingAuthority: \"DR. DIWAKAR TIWARI (GLOBUS MEDICARE)\",\n          medicalApprovalNo: \"MAH/NM/22/2015\",\n          medicalIssueDate: \"15-JAN-2025\",\n          medicalExpiryDate: \"14-JAN-2027\",\n          shipName: \"AQUA TOW\"\n        };\n      default:\n        return {\n          name: \"Maria Santos\",\n          position: \"Second Officer\",\n          nationality: \"Philippines\",\n          dateOfBirth: \"12/08/1990\",\n          phoneNumber: \"+63 917 123 4567\",\n          contractStartDate: \"15/01/2024\",\n          contractEndDate: \"15/01/2025\",\n          shipOwnerName: \"Offing Marine Services Ltd\",\n          shipOwnerContactPerson: \"John Smith\",\n          shipOwnerPostalAddress: \"123 Harbor Street, Singapore 048693\"\n        };\n    }\n  };\n\n  const filterExtractedData = (data: ExtractedCrewData): { key: string; value: string }[] => {\n    const entries = Object.entries(data).filter(([key, value]) => {\n      if (!value) return false;\n      if (key === 'shipOwnerPostalAddress') return false;\n      \n      switch (mode) {\n        case 'shipOwner':\n          return key.startsWith('shipOwner');\n        case 'seafarer':\n          return key.startsWith('seafarer') || key.startsWith('cdc') || key.startsWith('passport') || key.startsWith('nok') || key.startsWith('coc') || key.startsWith('medical') || key.startsWith('ship') || key === 'capacityRankEmployed';\n        default:\n          return true;\n      }\n    });\n\n    const result = entries.map(([key, value]) => ({\n      key,\n      value: value as string\n    }));\n\n    result.sort((a, b) => {\n      // Define priority order: seafarerName first, then seafarerRank/capacityRankEmployed, then nationality\n      const priorityOrder = ['seafarerName', 'seafarerRank', 'capacityRankEmployed', 'seafarerNationality'];\n      const aIndex = priorityOrder.indexOf(a.key);\n      const bIndex = priorityOrder.indexOf(b.key);\n      \n      if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;\n      if (aIndex !== -1) return -1;\n      if (bIndex !== -1) return 1;\n      return 0;\n    });\n\n    return result;\n  };\n\n  const formatFieldLabel = (key: string): string => {\n    return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());\n  };\n\n  const resetDialog = () => {\n    setIsOpen(false);\n    setExtractedData(null);\n    setError(null);\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button \n          variant=\"outline\" \n          className={`group relative overflow-hidden border-2 border-dashed border-primary/30 hover:border-primary/60 hover:bg-primary/5 transition-all duration-300 ${className}`}\n          data-testid=\"ocr-scan-button\"\n        >\n          <motion.div\n            className=\"absolute inset-0 bg-gradient-to-r from-primary/0 via-primary/10 to-primary/0\"\n            animate={{ x: ['-100%', '100%'] }}\n            transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}\n          />\n          <Scan className=\"h-4 w-4 mr-2 group-hover:scale-110 transition-transform\" />\n          <span className=\"relative\">Scan Document</span>\n        </Button>\n      </DialogTrigger>\n      \n      <DialogContent className=\"max-w-2xl max-h-[85vh] p-0 flex flex-col bg-gradient-to-br from-background via-background to-muted/30 border-0 shadow-2xl\">\n        <div className=\"absolute inset-0 bg-grid-pattern opacity-[0.02] pointer-events-none\" />\n        \n        <DialogHeader className=\"relative px-6 pt-6 pb-4 border-b border-border/50 flex-shrink-0\">\n          <div className=\"flex items-center gap-3\">\n            <motion.div \n              className=\"p-2.5 rounded-xl bg-gradient-to-br from-primary/20 to-primary/5 border border-primary/20\"\n              initial={{ scale: 0.8, opacity: 0 }}\n              animate={{ scale: 1, opacity: 1 }}\n              transition={{ duration: 0.3 }}\n            >\n              <FileText className=\"h-5 w-5 text-primary\" />\n            </motion.div>\n            <div>\n              <DialogTitle className=\"text-xl font-semibold bg-gradient-to-r from-foreground to-foreground/70 bg-clip-text\">\n                {getModeTitle()}\n              </DialogTitle>\n              <p className=\"text-sm text-muted-foreground mt-0.5\">\n                AI-powered document extraction\n              </p>\n            </div>\n          </div>\n        </DialogHeader>\n        \n        <div className=\"px-6 py-5 space-y-5 flex-1 overflow-y-auto\">\n          {availableRecords.length > 0 && !isProcessing && !extractedData && (\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              className=\"p-4 rounded-xl bg-gradient-to-r from-blue-500/10 via-cyan-500/10 to-blue-500/10 border border-blue-500/20\"\n            >\n              <div className=\"flex items-start gap-3\">\n                <div className=\"p-2 rounded-lg bg-blue-500/20\">\n                  <Users className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />\n                </div>\n                <div className=\"flex-1\">\n                  <h4 className=\"font-medium text-sm text-blue-800 dark:text-blue-200 mb-1\">\n                    Saved Crew Records ({availableRecords.length})\n                  </h4>\n                  <p className=\"text-xs text-blue-700/80 dark:text-blue-300/80 mb-3\">\n                    Previously scanned records are available. Select one to apply or scan a new document.\n                  </p>\n                  <div className=\"space-y-2\">\n                    <Select value={selectedRecordId} onValueChange={setSelectedRecordId}>\n                      <SelectTrigger className=\"bg-background\" data-testid=\"saved-record-select\">\n                        <SelectValue placeholder=\"Choose a saved record...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {availableRecords.map((record) => (\n                          <SelectItem key={record.recordId} value={record.recordId}>\n                            {record.displayName} - {new Date(record.extractedAt).toLocaleTimeString()}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    <div className=\"flex gap-2\">\n                      <Button\n                        size=\"sm\"\n                        disabled={!selectedRecordId}\n                        onClick={handleSelectSavedRecord}\n                        className=\"flex-1\"\n                        data-testid=\"apply-saved-record-btn\"\n                      >\n                        Apply Selected Record\n                      </Button>\n                      {selectedRecordId && (\n                        <Button\n                          size=\"sm\"\n                          variant=\"destructive\"\n                          onClick={() => handleRemoveRecord(selectedRecordId)}\n                          data-testid=\"remove-saved-record-btn\"\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </motion.div>\n          )}\n          \n          <AnimatePresence mode=\"wait\">\n            {!isProcessing && !extractedData && (\n              <motion.div\n                key=\"upload\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -10 }}\n                transition={{ duration: 0.2 }}\n                className=\"space-y-4\"\n              >\n                <motion.div\n                  className={`relative rounded-2xl border-2 border-dashed transition-all duration-300 ${\n                    isDragging \n                      ? 'border-primary bg-primary/5 scale-[1.02]' \n                      : 'border-muted-foreground/25 hover:border-primary/50 hover:bg-muted/30'\n                  }`}\n                  onDrop={handleDrop}\n                  onDragOver={handleDragOver}\n                  onDragLeave={handleDragLeave}\n                >\n                  <div className=\"p-8 text-center\">\n                    <motion.div \n                      className=\"mx-auto w-16 h-16 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center mb-4 border border-primary/20\"\n                      animate={isDragging ? { scale: 1.1, rotate: 5 } : { scale: 1, rotate: 0 }}\n                      transition={{ type: 'spring', stiffness: 300 }}\n                    >\n                      <Upload className={`h-7 w-7 transition-colors ${isDragging ? 'text-primary' : 'text-primary/70'}`} />\n                    </motion.div>\n                    \n                    <h3 className=\"font-medium text-lg mb-1\">Drop your document here</h3>\n                    <p className=\"text-sm text-muted-foreground mb-4\">\n                      or click to browse files\n                    </p>\n                    \n                    <div className=\"flex items-center justify-center gap-3\">\n                      <Button\n                        variant=\"default\"\n                        className=\"bg-gradient-to-r from-primary to-primary/80 hover:from-primary/90 hover:to-primary/70 shadow-lg shadow-primary/20\"\n                        onClick={() => fileInputRef.current?.click()}\n                        data-testid=\"upload-option\"\n                      >\n                        <Upload className=\"h-4 w-4 mr-2\" />\n                        Browse Files\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        className=\"border-2\"\n                        onClick={handleTakePhoto}\n                        data-testid=\"camera-option\"\n                      >\n                        <Camera className=\"h-4 w-4 mr-2\" />\n                        Take Photo\n                      </Button>\n                    </div>\n                    \n                    <div className=\"flex items-center justify-center gap-2 mt-4 text-xs text-muted-foreground\">\n                      <span className=\"px-2 py-1 rounded-full bg-muted/50\">JPG</span>\n                      <span className=\"px-2 py-1 rounded-full bg-muted/50\">PNG</span>\n                      <span className=\"px-2 py-1 rounded-full bg-muted/50\">PDF</span>\n                      <span className=\"text-muted-foreground/50\">‚Ä¢</span>\n                      <span>Max 10MB</span>\n                    </div>\n                  </div>\n                </motion.div>\n\n                <motion.div \n                  className=\"relative p-4 rounded-xl bg-gradient-to-r from-amber-500/10 via-orange-500/10 to-amber-500/10 border border-amber-500/20\"\n                  initial={{ opacity: 0 }}\n                  animate={{ opacity: 1 }}\n                  transition={{ delay: 0.1 }}\n                >\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"p-2 rounded-lg bg-amber-500/20\">\n                      <Sparkles className=\"h-4 w-4 text-amber-600 dark:text-amber-400\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <h4 className=\"font-medium text-sm text-amber-800 dark:text-amber-200 mb-1\">\n                        Demo Mode Available\n                      </h4>\n                      <p className=\"text-xs text-amber-700/80 dark:text-amber-300/80 mb-3\">\n                        Test the AI extraction with sample {getModeDescription()} data\n                      </p>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"border-amber-500/30 hover:bg-amber-500/10 text-amber-700 dark:text-amber-300\"\n                        onClick={() => {\n                          const demoData = getDemoData();\n                          setExtractedData(demoData);\n                          toast({\n                            title: \"Demo Data Generated\",\n                            description: `Sample ${getModeDescription()} details loaded for testing.`,\n                          });\n                        }}\n                        data-testid=\"demo-mode-button\"\n                      >\n                        <Sparkles className=\"h-3.5 w-3.5 mr-1.5\" />\n                        Try Demo Mode\n                      </Button>\n                    </div>\n                  </div>\n                </motion.div>\n              </motion.div>\n            )}\n\n            {isProcessing && (\n              <motion.div\n                key=\"processing\"\n                initial={{ opacity: 0, scale: 0.95 }}\n                animate={{ opacity: 1, scale: 1 }}\n                exit={{ opacity: 0, scale: 0.95 }}\n                className=\"py-12 text-center\"\n              >\n                <div className=\"relative mx-auto w-20 h-20 mb-6\">\n                  <motion.div \n                    className=\"absolute inset-0 rounded-full border-4 border-primary/20\"\n                  />\n                  <motion.div \n                    className=\"absolute inset-0 rounded-full border-4 border-transparent border-t-primary\"\n                    animate={{ rotate: 360 }}\n                    transition={{ duration: 1, repeat: Infinity, ease: 'linear' }}\n                  />\n                  <div className=\"absolute inset-0 flex items-center justify-center\">\n                    <Scan className=\"h-8 w-8 text-primary\" />\n                  </div>\n                </div>\n                \n                <h3 className=\"font-medium text-lg mb-2\">Analyzing Document</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  AI is extracting information from your document...\n                </p>\n                \n                <motion.div \n                  className=\"mt-6 flex items-center justify-center gap-1\"\n                  initial={{ opacity: 0 }}\n                  animate={{ opacity: 1 }}\n                  transition={{ delay: 0.5 }}\n                >\n                  {[0, 1, 2].map((i) => (\n                    <motion.div\n                      key={i}\n                      className=\"w-2 h-2 rounded-full bg-primary\"\n                      animate={{ scale: [1, 1.3, 1], opacity: [0.5, 1, 0.5] }}\n                      transition={{ duration: 1, repeat: Infinity, delay: i * 0.2 }}\n                    />\n                  ))}\n                </motion.div>\n              </motion.div>\n            )}\n\n            {error && (\n              <motion.div\n                key=\"error\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                className=\"p-4 rounded-xl bg-gradient-to-r from-destructive/10 to-destructive/5 border border-destructive/20\"\n                data-testid=\"error-alert\"\n              >\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"p-2 rounded-lg bg-destructive/20\">\n                    <AlertCircle className=\"h-5 w-5 text-destructive\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <h4 className=\"font-medium text-destructive mb-1\">Processing Failed</h4>\n                    <p className=\"text-sm text-destructive/80\">{error}</p>\n                  </div>\n                </div>\n              </motion.div>\n            )}\n\n            {extractedData && (\n              <motion.div\n                key=\"results\"\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                className=\"space-y-4\"\n              >\n                <motion.div \n                  className=\"p-4 rounded-xl bg-gradient-to-r from-emerald-500/10 via-green-500/10 to-emerald-500/10 border border-emerald-500/20\"\n                  initial={{ scale: 0.95 }}\n                  animate={{ scale: 1 }}\n                  data-testid=\"success-alert\"\n                >\n                  <div className=\"flex items-center gap-3\">\n                    <motion.div \n                      className=\"p-2 rounded-lg bg-emerald-500/20\"\n                      initial={{ scale: 0 }}\n                      animate={{ scale: 1 }}\n                      transition={{ type: 'spring', stiffness: 500, delay: 0.1 }}\n                    >\n                      <CheckCircle className=\"h-5 w-5 text-emerald-600 dark:text-emerald-400\" />\n                    </motion.div>\n                    <div>\n                      <h4 className=\"font-medium text-emerald-800 dark:text-emerald-200\">\n                        Extraction Complete\n                      </h4>\n                      <p className=\"text-sm text-emerald-700/80 dark:text-emerald-300/80\">\n                        Successfully extracted {getModeDescription()} details\n                      </p>\n                    </div>\n                  </div>\n                </motion.div>\n\n                {extractedData && !extractedData.name && !extractedData.seafarerName && Object.keys(extractedData).length > 0 && mode === 'crew' && (\n                  <motion.div \n                    className=\"p-3 rounded-lg bg-amber-500/10 border border-amber-500/20 text-sm\"\n                    initial={{ opacity: 0 }}\n                    animate={{ opacity: 1 }}\n                  >\n                    <span className=\"font-medium text-amber-700 dark:text-amber-300\">Note:</span>\n                    <span className=\"text-amber-600 dark:text-amber-400 ml-1\">\n                      Employee name was not detected. You'll need to enter it manually.\n                    </span>\n                  </motion.div>\n                )}\n\n                <div className=\"rounded-xl border border-border/50 overflow-hidden bg-card/50\">\n                  <div className=\"px-4 py-3 bg-muted/30 border-b border-border/50\">\n                    <h4 className=\"font-medium text-sm flex items-center gap-2\">\n                      <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                      Extracted Information\n                    </h4>\n                  </div>\n                  \n                  <div className=\"divide-y divide-border/50\">\n                    {filterExtractedData(extractedData).map(({ key, value }, index) => (\n                      <motion.div \n                        key={key} \n                        className=\"flex items-start justify-between px-4 py-3 hover:bg-muted/20 transition-colors\"\n                        initial={{ opacity: 0, x: -10 }}\n                        animate={{ opacity: 1, x: 0 }}\n                        transition={{ delay: index * 0.05 }}\n                      >\n                        <span className=\"text-sm font-medium text-muted-foreground\">\n                          {formatFieldLabel(key)}\n                        </span>\n                        <span className=\"text-sm text-right max-w-[60%] font-medium\">\n                          {value}\n                        </span>\n                      </motion.div>\n                    ))}\n                  </div>\n                  \n                  {filterExtractedData(extractedData).length === 0 && (\n                    <div className=\"p-6 text-center text-muted-foreground\">\n                      <p className=\"text-sm\">\n                        No information could be extracted. Please try a clearer image.\n                      </p>\n                    </div>\n                  )}\n                </div>\n              </motion.div>\n            )}\n          </AnimatePresence>\n\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\"image/*,application/pdf\"\n            onChange={handleFileSelect}\n            className=\"hidden\"\n            data-testid=\"file-input\"\n          />\n        </div>\n\n        <div className=\"px-6 py-4 border-t border-border/50 bg-muted/20 flex items-center justify-end gap-3 flex-shrink-0\">\n          <AnimatePresence>\n            {extractedData && filterExtractedData(extractedData).length > 0 && (\n              <motion.div\n                initial={{ opacity: 0, scale: 0.9 }}\n                animate={{ opacity: 1, scale: 1 }}\n                exit={{ opacity: 0, scale: 0.9 }}\n              >\n                <Button \n                  onClick={handleUseExtractedData}\n                  className=\"bg-gradient-to-r from-primary to-primary/80 hover:from-primary/90 hover:to-primary/70 shadow-lg shadow-primary/20\"\n                  data-testid=\"use-extracted-data\"\n                >\n                  <CheckCircle className=\"h-4 w-4 mr-2\" />\n                  Use This Information\n                </Button>\n              </motion.div>\n            )}\n          </AnimatePresence>\n          <Button \n            variant=\"ghost\" \n            onClick={resetDialog}\n            data-testid=\"cancel-ocr\"\n          >\n            <X className=\"h-4 w-4 mr-2\" />\n            Cancel\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":30214,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { format } from 'date-fns';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Switch } from '@/components/ui/switch';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Separator } from '@/components/ui/separator';\nimport { Badge } from '@/components/ui/badge';\nimport { \n  Settings as SettingsIcon, \n  Mail, \n  Bell, \n  Users, \n  Shield, \n  Database,\n  Moon,\n  Sun,\n  Monitor,\n  Save,\n  TestTube,\n  FileText,\n  Download,\n  Activity,\n  Clock,\n  User,\n  MessageCircle,\n  Trash2,\n  AlertTriangle,\n  Loader2\n} from 'lucide-react';\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from '@/components/ui/alert-dialog';\nimport { useTheme } from '@/contexts/theme-context';\nimport { queryClient, apiRequest } from '@/lib/queryClient';\nimport WhatsAppSettingsModal from '@/components/modals/whatsapp-settings-modal';\n\nexport default function Settings() {\n  const { user } = useAuth();\n  const { theme, setTheme } = useTheme();\n  const { toast } = useToast();\n  const [activeSection, setActiveSection] = useState('general');\n  const [isWhatsAppModalOpen, setIsWhatsAppModalOpen] = useState(false);\n  const [showClearCrewDialog, setShowClearCrewDialog] = useState(false);\n  const [localRecipientEmail, setLocalRecipientEmail] = useState('');\n  const [localEmailTemplate, setLocalEmailTemplate] = useState('');\n  const [emailFieldsInitialized, setEmailFieldsInitialized] = useState(false);\n\n  // Clear Crew Data Mutation\n  const clearCrewDataMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest('DELETE', '/api/admin/clear-crew-data');\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setShowClearCrewDialog(false);\n      queryClient.invalidateQueries({ queryKey: ['/api/crew-members'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/contracts'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/status-change-history'] });\n      toast({\n        title: 'Success',\n        description: data.message || 'All crew data has been cleared successfully.',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error?.message || 'Failed to clear crew data',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Email Settings Query\n  const { data: emailSettings, isLoading: emailLoading } = useQuery({\n    queryKey: ['/api/email-settings'],\n    queryFn: async () => {\n      const response = await fetch('/api/email-settings', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch email settings');\n      return response.json();\n    },\n  });\n\n  // Initialize local email fields when settings load\n  useEffect(() => {\n    if (emailSettings && !emailFieldsInitialized) {\n      setLocalRecipientEmail(emailSettings.recipientEmail || '');\n      setLocalEmailTemplate(emailSettings.emailTemplate || '');\n      setEmailFieldsInitialized(true);\n    }\n  }, [emailSettings, emailFieldsInitialized]);\n\n  // System Stats Query\n  const { data: systemStats } = useQuery({\n    queryKey: ['/api/system/stats'],\n    queryFn: async () => {\n      const response = await fetch('/api/dashboard/stats', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch system stats');\n      return response.json();\n    },\n  });\n\n  // Activity Report Query\n  const { data: activityData, isLoading: activityLoading, refetch: refetchActivity } = useQuery({\n    queryKey: ['/api/system/activity-report'],\n    queryFn: async () => {\n      const response = await fetch('/api/system/activity-report', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch activity report');\n      return response.json();\n    },\n    enabled: true, // Available for both admin and office staff\n    staleTime: 0, // Always refetch for real-time data\n    cacheTime: 0, // Don't cache activity data\n  });\n\n  // Email Settings Mutation\n  const updateEmailSettings = useMutation({\n    mutationFn: async (settings: any) => {\n      return apiRequest('PUT', '/api/email-settings', settings);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/email-settings'] });\n      toast({\n        title: 'Success',\n        description: 'Email settings updated successfully',\n      });\n    },\n    onError: () => {\n      toast({\n        title: 'Error',\n        description: 'Failed to update email settings',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Test Email Mutation\n  const sendTestEmail = useMutation({\n    mutationFn: async ({ recipientEmail }: { recipientEmail: string }) => {\n      return apiRequest('POST', '/api/email/send-test', { recipientEmail });\n    },\n    onSuccess: () => {\n      toast({\n        title: 'Success',\n        description: 'Test email sent successfully! Check your inbox.',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error?.message || 'Failed to send test email',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Export Activity Report\n  const exportActivityReport = () => {\n    try {\n      if (!activityData || activityData.length === 0) {\n        toast({\n          title: 'No Data',\n          description: 'No activity data found to export',\n          variant: 'destructive',\n        });\n        return;\n      }\n\n      const headers = [\n        'Timestamp',\n        'User Name',\n        'User Role',\n        'Action Type',\n        'Description',\n        'Affected Resource',\n        'IP Address',\n        'Status'\n      ];\n\n      const rows = activityData.map((activity: any) => [\n        format(new Date(activity.createdAt), 'yyyy-MM-dd HH:mm:ss'),\n        activity.username,\n        activity.userRole,\n        activity.type,\n        activity.description,\n        activity.entityType || '---',\n        '---', // IP address not tracked\n        activity.severity\n      ]);\n\n      // Create CSV with proper formatting\n      const csvRows = [];\n      \n      // Add title and metadata\n      csvRows.push('\"CREWTRACK PRO - SYSTEM ACTIVITY REPORT\"');\n      csvRows.push(`\"Generated on: ${format(new Date(), 'MMMM dd, yyyy at HH:mm')}\"`);\n      csvRows.push(`\"Total Activities: ${activityData.length}\"`);\n      csvRows.push(`\"Report Period: ${format(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000), 'MMM dd')} - ${format(new Date(), 'MMM dd, yyyy')}\"`);\n      csvRows.push(''); // Empty row for spacing\n      \n      // Add headers\n      csvRows.push(headers.map(header => `\"${header}\"`).join(','));\n      \n      // Add data rows\n      rows.forEach(row => {\n        const formattedRow = row.map((cell: any) => {\n          const cellValue = String(cell || '---');\n          return `\"${cellValue}\"`;\n        });\n        csvRows.push(formattedRow.join(','));\n      });\n      \n      // Add summary\n      csvRows.push(''); // Empty row\n      csvRows.push('\"ACTIVITY SUMMARY\"');\n      csvRows.push(`\"Admin Actions: ${rows.filter(row => row[2] === 'admin').length}\"`);\n      csvRows.push(`\"Office Staff Actions: ${rows.filter(row => row[2] === 'office_staff').length}\"`);\n      csvRows.push(`\"Total Users: ${new Set(rows.map(row => row[1])).size}\"`);\n      \n      const csvContent = csvRows.join('\\n');\n      const BOM = '\\uFEFF';\n      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n      \n      const link = document.createElement('a');\n      if (link.download !== undefined) {\n        const url = URL.createObjectURL(blob);\n        link.setAttribute('href', url);\n        link.setAttribute('download', `System-Activity-Report-${format(new Date(), 'yyyy-MM-dd-HHmm')}.csv`);\n        link.style.visibility = 'hidden';\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n      }\n\n      toast({\n        title: 'Export Successful',\n        description: `Activity report exported with ${activityData.length} records`,\n      });\n    } catch (error) {\n      toast({\n        title: 'Export Failed',\n        description: 'Unable to export activity report. Please try again.',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  const handleEmailSettingsUpdate = (field: string, value: any) => {\n    const updatedSettings = {\n      ...emailSettings,\n      [field]: value,\n    };\n    updateEmailSettings.mutate(updatedSettings);\n  };\n\n  const sections = [\n    { id: 'general', label: 'General', icon: SettingsIcon },\n    { id: 'notifications', label: 'Notifications', icon: Bell },\n    { id: 'email', label: 'Email Settings', icon: Mail },\n    { id: 'whatsapp', label: 'WhatsApp Settings', icon: MessageCircle, adminOnly: true },\n    { id: 'activity', label: 'Activity Report', icon: Activity },\n    { id: 'users', label: 'User Management', icon: Users, adminOnly: true },\n    { id: 'security', label: 'Security', icon: Shield, adminOnly: true },\n    { id: 'system', label: 'System', icon: Database, adminOnly: true },\n  ];\n\n  const availableSections = sections.filter(section => \n    !section.adminOnly || user?.role === 'admin'\n  );\n\n  if (user?.role === 'crew') {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"text-center py-12\">\n          <SettingsIcon className=\"h-16 w-16 mx-auto text-gray-300 mb-4\" />\n          <h2 className=\"text-2xl font-semibold text-foreground mb-2\">Access Restricted</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            Settings are only accessible to admin and office staff members.\n          </p>\n          <Button\n            onClick={() => window.location.href = '/dashboard'}\n            className=\"bg-maritime-navy hover:bg-blue-800\"\n          >\n            Go to Dashboard\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold text-foreground mb-2\" data-testid=\"settings-title\">\n            System Settings\n          </h2>\n          <p className=\"text-muted-foreground\">\n            Manage application settings and configurations\n          </p>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-4 gap-6\">\n        {/* Sidebar Navigation */}\n        <Card className=\"lg:col-span-1\">\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Settings Categories</CardTitle>\n          </CardHeader>\n          <CardContent className=\"p-0\">\n            <nav className=\"space-y-1\">\n              {availableSections.map((section) => {\n                const Icon = section.icon;\n                return (\n                  <button\n                    key={section.id}\n                    onClick={() => setActiveSection(section.id)}\n                    className={`w-full flex items-center px-4 py-3 text-left text-sm font-medium rounded-none border-r-2 transition-colors ${\n                      activeSection === section.id\n                        ? 'bg-primary/10 border-primary text-primary'\n                        : 'hover:bg-muted border-transparent text-muted-foreground hover:text-foreground'\n                    }`}\n                    data-testid={`settings-${section.id}-tab`}\n                  >\n                    <Icon className=\"h-4 w-4 mr-3\" />\n                    {section.label}\n                    {section.adminOnly && (\n                      <Badge variant=\"secondary\" className=\"ml-auto text-xs\">\n                        Admin\n                      </Badge>\n                    )}\n                  </button>\n                );\n              })}\n            </nav>\n          </CardContent>\n        </Card>\n\n        {/* Content Area */}\n        <div className=\"lg:col-span-3\">\n          {activeSection === 'general' && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <SettingsIcon className=\"h-5 w-5 mr-2\" />\n                  General Settings\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                {/* Theme Settings */}\n                <div>\n                  <Label className=\"text-base font-medium\">Theme Preference</Label>\n                  <p className=\"text-sm text-muted-foreground mb-3\">\n                    Choose your preferred theme for the application\n                  </p>\n                  <div className=\"flex space-x-3\">\n                    <Button\n                      variant={theme === 'light' ? 'default' : 'outline'}\n                      size=\"sm\"\n                      onClick={() => setTheme('light')}\n                      className=\"flex items-center\"\n                    >\n                      <Sun className=\"h-4 w-4 mr-2\" />\n                      Light\n                    </Button>\n                    <Button\n                      variant={theme === 'dark' ? 'default' : 'outline'}\n                      size=\"sm\"\n                      onClick={() => setTheme('dark')}\n                      className=\"flex items-center\"\n                    >\n                      <Moon className=\"h-4 w-4 mr-2\" />\n                      Dark\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      disabled\n                      className=\"flex items-center opacity-50\"\n                    >\n                      <Monitor className=\"h-4 w-4 mr-2\" />\n                      System (Coming Soon)\n                    </Button>\n                  </div>\n                </div>\n\n                <Separator />\n\n                {/* Application Info */}\n                <div>\n                  <Label className=\"text-base font-medium\">Application Information</Label>\n                  <div className=\"mt-3 grid grid-cols-2 gap-4\">\n                    <div>\n                      <Label className=\"text-sm text-muted-foreground\">Version</Label>\n                      <p className=\"text-sm font-medium\">CrewTrack Pro v2.1.0</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-sm text-muted-foreground\">Build</Label>\n                      <p className=\"text-sm font-medium\">2025.08.14</p>\n                    </div>\n                    <div>\n                      <Label className=\"text-sm text-muted-foreground\">Environment</Label>\n                      <Badge variant=\"secondary\">Development</Badge>\n                    </div>\n                    <div>\n                      <Label className=\"text-sm text-muted-foreground\">Database</Label>\n                      <Badge variant=\"outline\" className=\"text-green-600\">Connected</Badge>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {activeSection === 'notifications' && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <Bell className=\"h-5 w-5 mr-2\" />\n                  Notification Settings\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-base font-medium\">Browser Notifications</Label>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Show desktop notifications for alerts\n                      </p>\n                    </div>\n                    <Switch defaultChecked />\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-base font-medium\">Document Expiry Alerts</Label>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Alert when documents are expiring\n                      </p>\n                    </div>\n                    <Switch defaultChecked />\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <Label className=\"text-base font-medium\">Contract Notifications</Label>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Notify about contract renewals\n                      </p>\n                    </div>\n                    <Switch defaultChecked />\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {activeSection === 'email' && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <Mail className=\"h-5 w-5 mr-2\" />\n                  Email Settings\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                {emailLoading ? (\n                  <div className=\"text-center py-8\">\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto\"></div>\n                  </div>\n                ) : (\n                  <>\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <Label className=\"text-base font-medium\">Email Notifications</Label>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Enable email notifications for alerts\n                        </p>\n                      </div>\n                      <Switch \n                        checked={emailSettings?.enabled ?? true}\n                        onCheckedChange={(checked) => handleEmailSettingsUpdate('enabled', checked)}\n                      />\n                    </div>\n\n                    <Separator />\n\n                    <div>\n                      <Label className=\"text-base font-medium mb-3 block\">Reminder Settings</Label>\n                      <div className=\"space-y-3\">\n                        <div className=\"flex items-center justify-between\">\n                          <Label className=\"text-sm\">30 days before expiry</Label>\n                          <Switch \n                            checked={emailSettings?.reminderDays?.includes(30) ?? true}\n                            onCheckedChange={(checked) => {\n                              const days = emailSettings?.reminderDays || [];\n                              const newDays = checked \n                                ? [...days.filter((d: number) => d !== 30), 30]\n                                : days.filter((d: number) => d !== 30);\n                              handleEmailSettingsUpdate('reminderDays', newDays);\n                            }}\n                          />\n                        </div>\n                        <div className=\"flex items-center justify-between\">\n                          <Label className=\"text-sm\">15 days before expiry</Label>\n                          <Switch \n                            checked={emailSettings?.reminderDays?.includes(15) ?? true}\n                            onCheckedChange={(checked) => {\n                              const days = emailSettings?.reminderDays || [];\n                              const newDays = checked \n                                ? [...days.filter((d: number) => d !== 15), 15]\n                                : days.filter((d: number) => d !== 15);\n                              handleEmailSettingsUpdate('reminderDays', newDays);\n                            }}\n                          />\n                        </div>\n                        <div className=\"flex items-center justify-between\">\n                          <Label className=\"text-sm\">7 days before expiry</Label>\n                          <Switch \n                            checked={emailSettings?.reminderDays?.includes(7) ?? true}\n                            onCheckedChange={(checked) => {\n                              const days = emailSettings?.reminderDays || [];\n                              const newDays = checked \n                                ? [...days.filter((d: number) => d !== 7), 7]\n                                : days.filter((d: number) => d !== 7);\n                              handleEmailSettingsUpdate('reminderDays', newDays);\n                            }}\n                          />\n                        </div>\n                      </div>\n                    </div>\n\n                    <Separator />\n\n                    <div>\n                      <Label htmlFor=\"recipient-email\" className=\"text-base font-medium\">\n                        Recipient Email Address\n                      </Label>\n                      <p className=\"text-sm text-muted-foreground mb-3\">\n                        Email address to receive all notifications and alerts\n                      </p>\n                      <Input\n                        id=\"recipient-email\"\n                        type=\"email\"\n                        placeholder=\"admin@company.com\"\n                        value={localRecipientEmail}\n                        onChange={(e) => setLocalRecipientEmail(e.target.value)}\n                        data-testid=\"input-recipient-email\"\n                      />\n                    </div>\n\n                    <Separator />\n\n                    <div>\n                      <Label htmlFor=\"email-template\" className=\"text-base font-medium\">\n                        Email Template\n                      </Label>\n                      <p className=\"text-sm text-muted-foreground mb-3\">\n                        Customize the email notification template\n                      </p>\n                      <Textarea\n                        id=\"email-template\"\n                        rows={6}\n                        placeholder=\"Enter your email template here...\"\n                        value={localEmailTemplate}\n                        onChange={(e) => setLocalEmailTemplate(e.target.value)}\n                        className=\"font-mono text-sm\"\n                      />\n                    </div>\n\n                    <div className=\"flex space-x-3\">\n                      <Button\n                        onClick={() => {\n                          const updatedSettings = {\n                            ...emailSettings,\n                            recipientEmail: localRecipientEmail,\n                            emailTemplate: localEmailTemplate,\n                          };\n                          updateEmailSettings.mutate(updatedSettings);\n                        }}\n                        disabled={updateEmailSettings.isPending}\n                        className=\"bg-maritime-navy hover:bg-blue-800\"\n                        size=\"sm\"\n                        data-testid=\"button-save-email-settings\"\n                      >\n                        {updateEmailSettings.isPending ? (\n                          <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                        ) : (\n                          <Save className=\"h-4 w-4 mr-2\" />\n                        )}\n                        Save Email Settings\n                      </Button>\n                      <Button\n                        onClick={() => sendTestEmail.mutate({ recipientEmail: localRecipientEmail || 'admin@company.com' })}\n                        disabled={sendTestEmail.isPending || !localRecipientEmail}\n                        variant=\"outline\"\n                        size=\"sm\"\n                        data-testid=\"button-test-email\"\n                      >\n                        <TestTube className=\"h-4 w-4 mr-2\" />\n                        Send Test Email\n                      </Button>\n                    </div>\n                  </>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {activeSection === 'whatsapp' && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <MessageCircle className=\"h-5 w-5 mr-2\" />\n                  WhatsApp Group Notifications\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                <div className=\"text-center py-8\">\n                  <MessageCircle className=\"h-16 w-16 mx-auto text-green-600 mb-4\" />\n                  <h3 className=\"text-lg font-semibold text-foreground mb-2\">\n                    Automated WhatsApp Alerts\n                  </h3>\n                  <p className=\"text-muted-foreground mb-6 max-w-md mx-auto\">\n                    Send automatic notifications to your office WhatsApp group when contracts are expiring, \n                    documents need renewal, or crew rotations are scheduled.\n                  </p>\n                  <Button \n                    onClick={() => setIsWhatsAppModalOpen(true)}\n                    className=\"bg-green-600 hover:bg-green-700 text-white\"\n                    data-testid=\"configure-whatsapp-button\"\n                  >\n                    <MessageCircle className=\"h-4 w-4 mr-2\" />\n                    Configure WhatsApp Notifications\n                  </Button>\n                </div>\n                \n                <div className=\"bg-muted/50 p-4 rounded-lg\">\n                  <h4 className=\"font-medium mb-3\">Supported Providers</h4>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                    <div className=\"text-center\">\n                      <MessageCircle className=\"h-6 w-6 mx-auto mb-1 text-green-600\" />\n                      <p className=\"text-xs font-medium\">Wassenger</p>\n                      <p className=\"text-xs text-muted-foreground\">Group Support</p>\n                    </div>\n                    <div className=\"text-center\">\n                      <User className=\"h-6 w-6 mx-auto mb-1 text-blue-600\" />\n                      <p className=\"text-xs font-medium\">WHAPI</p>\n                      <p className=\"text-xs text-muted-foreground\">Professional</p>\n                    </div>\n                    <div className=\"text-center\">\n                      <TestTube className=\"h-6 w-6 mx-auto mb-1 text-red-600\" />\n                      <p className=\"text-xs font-medium\">Twilio</p>\n                      <p className=\"text-xs text-muted-foreground\">Individual SMS</p>\n                    </div>\n                    <div className=\"text-center\">\n                      <Database className=\"h-6 w-6 mx-auto mb-1 text-purple-600\" />\n                      <p className=\"text-xs font-medium\">Custom</p>\n                      <p className=\"text-xs text-muted-foreground\">Webhook</p>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {activeSection === 'activity' && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center\">\n                    <Activity className=\"h-5 w-5 mr-2\" />\n                    System Activity Report\n                  </div>\n                  <div className=\"flex space-x-2\">\n                    <Button\n                      onClick={() => refetchActivity()}\n                      disabled={activityLoading}\n                      variant=\"outline\"\n                      size=\"sm\"\n                    >\n                      <Activity className=\"h-4 w-4 mr-2\" />\n                      Refresh\n                    </Button>\n                    <Button\n                      onClick={exportActivityReport}\n                      disabled={!activityData || activityData.length === 0 || activityLoading}\n                      variant=\"outline\"\n                      size=\"sm\"\n                    >\n                      <Download className=\"h-4 w-4 mr-2\" />\n                      Export Report\n                    </Button>\n                  </div>\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                {activityLoading ? (\n                  <div className=\"text-center py-8\">\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto\"></div>\n                    <p className=\"text-sm text-muted-foreground mt-2\">Loading activity data...</p>\n                  </div>\n                ) : activityData && activityData.length > 0 ? (\n                  <>\n                    {/* Summary Cards */}\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                      <div className=\"text-center p-4 border rounded-lg\">\n                        <div className=\"text-2xl font-bold text-primary\">\n                          {activityData.filter((a: any) => a.userRole === 'admin').length}\n                        </div>\n                        <div className=\"text-sm text-muted-foreground\">Admin Actions</div>\n                      </div>\n                      <div className=\"text-center p-4 border rounded-lg\">\n                        <div className=\"text-2xl font-bold text-primary\">\n                          {activityData.filter((a: any) => a.userRole === 'office_staff').length}\n                        </div>\n                        <div className=\"text-sm text-muted-foreground\">Office Staff Actions</div>\n                      </div>\n                      <div className=\"text-center p-4 border rounded-lg\">\n                        <div className=\"text-2xl font-bold text-primary\">\n                          {new Set(activityData.map((a: any) => a.username)).size}\n                        </div>\n                        <div className=\"text-sm text-muted-foreground\">Active Users</div>\n                      </div>\n                      <div className=\"text-center p-4 border rounded-lg\">\n                        <div className=\"text-2xl font-bold text-primary\">{activityData.length}</div>\n                        <div className=\"text-sm text-muted-foreground\">Total Activities</div>\n                      </div>\n                    </div>\n\n                    {/* Recent Activity Table */}\n                    <div>\n                      <h4 className=\"text-lg font-medium mb-4\">Recent System Activities</h4>\n                      <div className=\"border rounded-lg\">\n                        <div className=\"max-h-96 overflow-y-auto\">\n                          <table className=\"w-full\">\n                            <thead className=\"bg-muted sticky top-0\">\n                              <tr>\n                                <th className=\"text-left p-3 text-sm font-medium\">Time</th>\n                                <th className=\"text-left p-3 text-sm font-medium\">User</th>\n                                <th className=\"text-left p-3 text-sm font-medium\">Role</th>\n                                <th className=\"text-left p-3 text-sm font-medium\">Action</th>\n                                <th className=\"text-left p-3 text-sm font-medium\">Description</th>\n                                <th className=\"text-left p-3 text-sm font-medium\">Status</th>\n                              </tr>\n                            </thead>\n                            <tbody>\n                              {activityData.slice(0, 50).map((activity: any, index: number) => (\n                                <tr key={index} className=\"border-t hover:bg-muted/50\">\n                                  <td className=\"p-3 text-sm\">\n                                    <div className=\"flex items-center\">\n                                      <Clock className=\"h-3 w-3 mr-1 text-muted-foreground\" />\n                                      {format(new Date(activity.createdAt), 'MMM dd, HH:mm')}\n                                    </div>\n                                  </td>\n                                  <td className=\"p-3 text-sm\">\n                                    <div className=\"flex items-center\">\n                                      <User className=\"h-3 w-3 mr-1 text-muted-foreground\" />\n                                      {activity.username}\n                                    </div>\n                                  </td>\n                                  <td className=\"p-3 text-sm\">\n                                    <Badge variant={activity.userRole === 'admin' ? 'default' : 'secondary'} className=\"text-xs\">\n                                      {activity.userRole === 'admin' ? 'Admin' : 'Office Staff'}\n                                    </Badge>\n                                  </td>\n                                  <td className=\"p-3 text-sm font-medium\">{activity.type}</td>\n                                  <td className=\"p-3 text-sm text-muted-foreground\">{activity.description}</td>\n                                  <td className=\"p-3 text-sm\">\n                                    <Badge \n                                      variant={activity.severity === 'success' || activity.severity === 'info' ? 'outline' : 'destructive'} \n                                      className=\"text-xs\"\n                                    >\n                                      {activity.severity}\n                                    </Badge>\n                                  </td>\n                                </tr>\n                              ))}\n                            </tbody>\n                          </table>\n                        </div>\n                      </div>\n                      {activityData.length > 50 && (\n                        <p className=\"text-sm text-muted-foreground mt-2 text-center\">\n                          Showing 50 of {activityData.length} activities. Export for full report.\n                        </p>\n                      )}\n                    </div>\n                  </>\n                ) : (\n                  <div className=\"text-center py-12 text-muted-foreground\">\n                    <FileText className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                    <h4 className=\"text-lg font-medium mb-2\">Fresh Start - No Activity Data</h4>\n                    <p className=\"mb-2\">The system is ready to track user activities.</p>\n                    <p className=\"text-sm\">Activities will be recorded when users:</p>\n                    <ul className=\"text-sm mt-3 space-y-1 max-w-sm mx-auto text-left\">\n                      <li>‚Ä¢ Login/Logout from the system</li>\n                      <li>‚Ä¢ Create, update, or delete crew members</li>\n                      <li>‚Ä¢ Manage documents and contracts</li>\n                      <li>‚Ä¢ Export reports and data</li>\n                      <li>‚Ä¢ Send notifications and emails</li>\n                      <li>‚Ä¢ Modify system settings</li>\n                    </ul>\n                    <p className=\"text-xs mt-6 text-muted-foreground\">\n                      All user actions will be logged here for admin review and system auditing.\n                    </p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {activeSection === 'system' && user?.role === 'admin' && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <Database className=\"h-5 w-5 mr-2\" />\n                  System Information\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                {systemStats && (\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                    <div className=\"text-center p-4 border rounded-lg\">\n                      <div className=\"text-2xl font-bold text-primary\">{systemStats.activeCrew}</div>\n                      <div className=\"text-sm text-muted-foreground\">Active Crew</div>\n                    </div>\n                    <div className=\"text-center p-4 border rounded-lg\">\n                      <div className=\"text-2xl font-bold text-primary\">{systemStats.activeVessels}</div>\n                      <div className=\"text-sm text-muted-foreground\">Active Vessels</div>\n                    </div>\n                    <div className=\"text-center p-4 border rounded-lg\">\n                      <div className=\"text-2xl font-bold text-primary\">{systemStats.totalContracts}</div>\n                      <div className=\"text-sm text-muted-foreground\">Total Contracts</div>\n                    </div>\n                    <div className=\"text-center p-4 border rounded-lg\">\n                      <div className=\"text-2xl font-bold text-primary\">{systemStats.pendingActions}</div>\n                      <div className=\"text-sm text-muted-foreground\">Pending Actions</div>\n                    </div>\n                  </div>\n                )}\n                \n                <Separator />\n                \n                <div>\n                  <Label className=\"text-base font-medium\">Database Status</Label>\n                  <div className=\"mt-3 flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 bg-green-500 rounded-full\"></div>\n                    <span className=\"text-sm\">Connected and operational</span>\n                  </div>\n                </div>\n\n                <Separator />\n\n                <div>\n                  <Label className=\"text-base font-medium text-red-600\">Danger Zone</Label>\n                  <p className=\"text-sm text-muted-foreground mt-1 mb-4\">\n                    These actions are destructive and cannot be undone.\n                  </p>\n                  <div className=\"border border-red-200 rounded-lg p-4 bg-red-50 dark:bg-red-950/20\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <h4 className=\"font-medium text-red-700 dark:text-red-400\">Clear All Crew Data</h4>\n                        <p className=\"text-sm text-red-600/80 dark:text-red-400/80\">\n                          Delete all crew members, contracts, documents, and status history. Vessels will be preserved.\n                        </p>\n                      </div>\n                      <Button \n                        variant=\"destructive\" \n                        onClick={() => setShowClearCrewDialog(true)}\n                        data-testid=\"button-clear-crew-data\"\n                      >\n                        <Trash2 className=\"h-4 w-4 mr-2\" />\n                        Clear Crew Data\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          <AlertDialog open={showClearCrewDialog} onOpenChange={setShowClearCrewDialog}>\n            <AlertDialogContent>\n              <AlertDialogHeader>\n                <AlertDialogTitle className=\"flex items-center text-red-600\">\n                  <AlertTriangle className=\"h-5 w-5 mr-2\" />\n                  Clear All Crew Data\n                </AlertDialogTitle>\n                <AlertDialogDescription className=\"text-left space-y-3\">\n                  <p>This action will permanently delete:</p>\n                  <ul className=\"list-disc list-inside space-y-1 text-sm\">\n                    <li>All crew members ({systemStats?.activeCrew || 0} records)</li>\n                    <li>All contracts ({systemStats?.totalContracts || 0} records)</li>\n                    <li>All crew documents</li>\n                    <li>All status change history</li>\n                    <li>All crew rotations</li>\n                  </ul>\n                  <p className=\"font-medium text-red-600\">This action cannot be undone!</p>\n                  <p>Vessels and system settings will be preserved.</p>\n                </AlertDialogDescription>\n              </AlertDialogHeader>\n              <AlertDialogFooter>\n                <AlertDialogCancel disabled={clearCrewDataMutation.isPending}>Cancel</AlertDialogCancel>\n                <AlertDialogAction\n                  onClick={() => clearCrewDataMutation.mutate()}\n                  className=\"bg-red-600 hover:bg-red-700\"\n                  disabled={clearCrewDataMutation.isPending}\n                >\n                  {clearCrewDataMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Clearing...\n                    </>\n                  ) : (\n                    <>\n                      <Trash2 className=\"h-4 w-4 mr-2\" />\n                      Yes, Clear All Crew Data\n                    </>\n                  )}\n                </AlertDialogAction>\n              </AlertDialogFooter>\n            </AlertDialogContent>\n          </AlertDialog>\n\n          {activeSection === 'users' && user?.role === 'admin' && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <Users className=\"h-5 w-5 mr-2\" />\n                  User Management\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Users className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>User management features coming soon</p>\n                  <p className=\"text-sm\">This will include user roles, permissions, and account management.</p>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {activeSection === 'security' && user?.role === 'admin' && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <Shield className=\"h-5 w-5 mr-2\" />\n                  Security Settings\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Shield className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>Security settings coming soon</p>\n                  <p className=\"text-sm\">This will include password policies, session management, and security logs.</p>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </div>\n      \n      <WhatsAppSettingsModal\n        isOpen={isWhatsAppModalOpen}\n        onClose={() => setIsWhatsAppModalOpen(false)}\n      />\n    </div>\n  );\n}","path":null,"size_bytes":43124,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":971,"size_tokens":null},"client/src/components/documents/crew-document-matrix.tsx":{"content":"import { useState, useCallback } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useToast } from '@/hooks/use-toast';\nimport { queryClient } from '@/lib/queryClient';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { Badge } from '@/components/ui/badge';\nimport { Progress } from '@/components/ui/progress';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Upload, FileText, CheckCircle, AlertCircle, Clock, Plus, Search, Download, Eye, Trash2 } from 'lucide-react';\nimport { Document, CrewMemberWithDetails } from '@shared/schema';\nimport DocumentUpload from './document-upload';\n\ntype DocumentType = 'passport' | 'cdc' | 'stcw' | 'medical' | 'visa' | 'coc';\n\ninterface DocumentCell {\n  crewMemberId: string;\n  documentType: DocumentType;\n  document?: Document;\n  status: 'missing' | 'valid' | 'expiring' | 'expired';\n}\n\nconst DOCUMENT_TYPES: { type: DocumentType; label: string; shortLabel: string }[] = [\n  { type: 'passport', label: 'Passport', shortLabel: 'Pass' },\n  { type: 'cdc', label: 'CDC', shortLabel: 'CDC' },\n  { type: 'coc', label: 'COC', shortLabel: 'COC' },\n  { type: 'stcw', label: 'STCW', shortLabel: 'STCW' },\n  { type: 'medical', label: 'Medical Certificate', shortLabel: 'Med' },\n  { type: 'visa', label: 'Visa', shortLabel: 'Visa' },\n];\n\nexport default function CrewDocumentMatrix() {\n  const { toast } = useToast();\n  const [selectedCell, setSelectedCell] = useState<DocumentCell | null>(null);\n  const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);\n  const [searchTerm, setSearchTerm] = useState('');\n\n  const { data: crewMembers = [], isLoading: crewLoading } = useQuery<CrewMemberWithDetails[]>({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n  });\n\n  const { data: documents = [], isLoading: documentsLoading } = useQuery<Document[]>({\n    queryKey: ['/api/documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/documents', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch documents');\n      return response.json();\n    },\n  });\n\n  // Filter crew members based on search term\n  const filteredCrewMembers = crewMembers.filter(crewMember => {\n    const fullName = `${crewMember.firstName} ${crewMember.lastName}`.toLowerCase();\n    return fullName.includes(searchTerm.toLowerCase());\n  });\n\n  // Create matrix data structure with performance optimization\n  const createDocumentMatrix = useCallback(() => {\n    // Pre-index documents for O(1) lookup performance\n    const documentIndex = new Map<string, Document>();\n    documents.forEach(doc => {\n      const key = `${doc.crewMemberId}-${doc.type}`;\n      documentIndex.set(key, doc);\n    });\n\n    const matrix: DocumentCell[][] = [];\n    \n    filteredCrewMembers.forEach((crewMember) => {\n      const row: DocumentCell[] = [];\n      \n      DOCUMENT_TYPES.forEach(({ type }) => {\n        const key = `${crewMember.id}-${type}`;\n        const document = documentIndex.get(key);\n        \n        let status: DocumentCell['status'] = 'missing';\n        if (document) {\n          const now = new Date();\n          const expiryDate = new Date(document.expiryDate);\n          const daysUntilExpiry = Math.ceil((expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n          \n          if (daysUntilExpiry < 0) {\n            status = 'expired';\n          } else if (daysUntilExpiry <= 30) {\n            status = 'expiring';\n          } else {\n            status = 'valid';\n          }\n        }\n        \n        row.push({\n          crewMemberId: crewMember.id,\n          documentType: type,\n          document,\n          status,\n        });\n      });\n      \n      matrix.push(row);\n    });\n    \n    return matrix;\n  }, [filteredCrewMembers, documents]);\n\n  const documentMatrix = createDocumentMatrix();\n\n  // Calculate progress for each crew member (fixed to count distinct document types)\n  const getCrewProgress = (crewMemberId: string) => {\n    const crewDocuments = documents.filter(doc => doc.crewMemberId === crewMemberId);\n    const totalDocumentTypes = DOCUMENT_TYPES.length;\n    \n    // Count unique document types (not total documents) for accurate progress\n    const uploadedDocumentTypes = new Set(crewDocuments.map(doc => doc.type)).size;\n    const pendingDocumentTypes = totalDocumentTypes - uploadedDocumentTypes;\n    const percentage = totalDocumentTypes > 0 ? (uploadedDocumentTypes / totalDocumentTypes) * 100 : 0;\n    \n    return {\n      uploaded: uploadedDocumentTypes,\n      pending: pendingDocumentTypes,\n      percentage: Math.round(percentage),\n    };\n  };\n\n  const getStatusIcon = (status: DocumentCell['status']) => {\n    switch (status) {\n      case 'valid':\n        return <CheckCircle className=\"h-4 w-4 text-green-600\" />;\n      case 'expiring':\n        return <Clock className=\"h-4 w-4 text-yellow-600\" />;\n      case 'expired':\n        return <AlertCircle className=\"h-4 w-4 text-red-600\" />;\n      default:\n        return <Plus className=\"h-4 w-4 text-gray-400\" />;\n    }\n  };\n\n  const getStatusColor = (status: DocumentCell['status']) => {\n    switch (status) {\n      case 'valid':\n        return 'bg-green-100 border-green-200 hover:bg-green-200';\n      case 'expiring':\n        return 'bg-yellow-100 border-yellow-200 hover:bg-yellow-200';\n      case 'expired':\n        return 'bg-red-100 border-red-200 hover:bg-red-200';\n      default:\n        return 'bg-gray-50 border-gray-200 hover:bg-gray-100';\n    }\n  };\n\n  const handleCellClick = (cell: DocumentCell) => {\n    setSelectedCell(cell);\n    setIsUploadModalOpen(true);\n  };\n\n  const handleUploadSuccess = () => {\n    setIsUploadModalOpen(false);\n    setSelectedCell(null);\n    // Invalidate queries to refresh data\n    queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n    toast({\n      title: 'Success',\n      description: 'Document uploaded successfully',\n    });\n  };\n\n  const handleViewDocument = async (document: Document) => {\n    if (document.id) {\n      try {\n        // Fetch the document with proper authentication headers\n        const response = await fetch(`/api/documents/${document.id}/download`, {\n          headers: getAuthHeaders(),\n        });\n        \n        if (!response.ok) {\n          throw new Error('Failed to fetch document');\n        }\n        \n        // Create a blob from the response\n        const blob = await response.blob();\n        const blobUrl = URL.createObjectURL(blob);\n        \n        // Open the blob URL in a new tab\n        window.open(blobUrl, '_blank');\n        \n        // Clean up the blob URL after a short delay\n        setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);\n      } catch (error) {\n        console.error('Error viewing document:', error);\n        toast({\n          title: 'Error',\n          description: 'Failed to open document',\n          variant: 'destructive',\n        });\n      }\n    }\n  };\n\n  const handleDownloadDocument = async (doc: Document) => {\n    if (doc.id) {\n      try {\n        // Fetch the document with proper authentication headers\n        const response = await fetch(`/api/documents/${doc.id}/download`, {\n          headers: getAuthHeaders(),\n        });\n        \n        if (!response.ok) {\n          throw new Error('Failed to fetch document');\n        }\n        \n        // Create a blob from the response\n        const blob = await response.blob();\n        const blobUrl = URL.createObjectURL(blob);\n        \n        // Create download link\n        const link = document.createElement('a');\n        link.href = blobUrl;\n        link.download = `${doc.type}_${doc.documentNumber}.pdf`;\n        link.style.display = 'none';\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        \n        // Clean up the blob URL\n        URL.revokeObjectURL(blobUrl);\n      } catch (error) {\n        console.error('Error downloading document:', error);\n        toast({\n          title: 'Error',\n          description: 'Failed to download document',\n          variant: 'destructive',\n        });\n      }\n    }\n  };\n\n  // Delete document mutation\n  const deleteDocumentMutation = useMutation({\n    mutationFn: async (documentId: string) => {\n      const response = await fetch(`/api/documents/${documentId}`, {\n        method: 'DELETE',\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to delete document');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n      toast({\n        title: 'Success',\n        description: 'Document deleted successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to delete document',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleDeleteDocument = (doc: Document) => {\n    if (confirm(`Are you sure you want to delete this ${doc.type.toUpperCase()} document?`)) {\n      deleteDocumentMutation.mutate(doc.id);\n    }\n  };\n\n  const getCrewMemberName = (crewMemberId: string) => {\n    const member = crewMembers.find(m => m.id === crewMemberId);\n    return member ? `${member.firstName} ${member.lastName}` : 'Unknown';\n  };\n\n  const getCrewMemberInitials = (crewMemberId: string) => {\n    const member = crewMembers.find(m => m.id === crewMemberId);\n    return member ? `${member.firstName.charAt(0)}${member.lastName.charAt(0)}`.toUpperCase() : 'UK';\n  };\n\n  if (crewLoading || documentsLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/3 mb-2\"></div>\n          <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n        </div>\n        <div className=\"h-96 bg-gray-200 rounded animate-pulse\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div>\n        <h3 className=\"text-2xl font-bold maritime-navy mb-2\">\n          Crew Document Matrix\n        </h3>\n        <p className=\"text-gray-600\">\n          Upload and track documents for all crew members. Click on any cell to upload or view documents.\n        </p>\n      </div>\n\n      {/* Summary Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500\">Total Crew Members</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <FileText className=\"h-5 w-5 ocean-blue\" />\n              <span className=\"text-2xl font-bold maritime-navy\">\n                {filteredCrewMembers.length}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500\">Document Types</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <Upload className=\"h-5 w-5 ocean-blue\" />\n              <span className=\"text-2xl font-bold maritime-navy\">\n                {DOCUMENT_TYPES.length}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500\">Total Documents</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <CheckCircle className=\"h-5 w-5 text-green-600\" />\n              <span className=\"text-2xl font-bold maritime-navy\">\n                {documents.length}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Document Matrix Table */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"maritime-navy\">Document Upload Matrix</CardTitle>\n            <div className=\"flex-1 max-w-sm ml-6\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n                <Input\n                  placeholder=\"Search crew members...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10\"\n                  data-testid=\"crew-search-input\"\n                />\n              </div>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"overflow-x-auto\">\n            <Table>\n              <TableHeader>\n                <TableRow className=\"bg-gray-50\">\n                  <TableHead className=\"min-w-[200px]\">Crew Member</TableHead>\n                  <TableHead className=\"min-w-[120px]\">Progress</TableHead>\n                  {DOCUMENT_TYPES.map(({ type, shortLabel }) => (\n                    <TableHead key={type} className=\"text-center min-w-[100px]\">\n                      <div className=\"flex flex-col items-center\">\n                        <span className=\"font-medium\">{shortLabel}</span>\n                      </div>\n                    </TableHead>\n                  ))}\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {documentMatrix.length === 0 ? (\n                  <TableRow>\n                    <TableCell colSpan={DOCUMENT_TYPES.length + 2} className=\"text-center py-8 text-gray-500\">\n                      {searchTerm ? `No crew members found matching \"${searchTerm}\"` : 'No crew members found'}\n                    </TableCell>\n                  </TableRow>\n                ) : (\n                  documentMatrix.map((row, rowIndex) => {\n                    const crewMemberId = row[0]?.crewMemberId;\n                    const progress = getCrewProgress(crewMemberId);\n                    \n                    return (\n                      <TableRow key={crewMemberId} className=\"hover:bg-gray-50\">\n                        {/* Crew Member Column */}\n                        <TableCell>\n                          <div className=\"flex items-center space-x-3\">\n                            <Avatar className=\"bg-maritime-navy\">\n                              <AvatarFallback className=\"text-white font-medium\">\n                                {getCrewMemberInitials(crewMemberId)}\n                              </AvatarFallback>\n                            </Avatar>\n                            <div>\n                              <span className=\"font-medium\" data-testid={`crew-name-${crewMemberId}`}>\n                                {getCrewMemberName(crewMemberId)}\n                              </span>\n                            </div>\n                          </div>\n                        </TableCell>\n\n                        {/* Progress Column */}\n                        <TableCell>\n                          <div className=\"space-y-2\">\n                            <div className=\"flex justify-between text-sm\">\n                              <span className=\"text-gray-600\">\n                                {progress.uploaded}/{progress.uploaded + progress.pending}\n                              </span>\n                              <span className=\"text-gray-600\">{progress.percentage}%</span>\n                            </div>\n                            <Progress value={progress.percentage} className=\"h-2\" />\n                            <div className=\"flex justify-between text-xs text-gray-500\">\n                              <span>{progress.uploaded} uploaded</span>\n                              <span>{progress.pending} pending</span>\n                            </div>\n                          </div>\n                        </TableCell>\n\n                        {/* Document Columns */}\n                        {row.map((cell, cellIndex) => (\n                          <TableCell key={cellIndex} className=\"text-center\">\n                            {cell.document ? (\n                              <div className=\"space-y-2\">\n                                <div className={`p-3 border-2 rounded-lg ${getStatusColor(cell.status)}`}>\n                                  <div className=\"flex flex-col items-center space-y-2\">\n                                    {getStatusIcon(cell.status)}\n                                    <span className=\"text-xs font-medium\">\n                                      {cell.status === 'valid' ? 'Valid' :\n                                       cell.status === 'expiring' ? 'Expiring' : \n                                       cell.status === 'expired' ? 'Expired' : ''}\n                                    </span>\n                                  </div>\n                                </div>\n                                <div className=\"flex flex-col space-y-1\">\n                                  <Button\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    className=\"h-8 px-2 text-xs bg-blue-50 hover:bg-blue-100 border-blue-200\"\n                                    onClick={() => handleViewDocument(cell.document!)}\n                                    data-testid={`view-document-${crewMemberId}-${cell.documentType}`}\n                                  >\n                                    <Eye className=\"h-3 w-3 mr-1\" />\n                                    View Certificate\n                                  </Button>\n                                  <Button\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    className=\"h-8 px-2 text-xs bg-green-50 hover:bg-green-100 border-green-200\"\n                                    onClick={() => handleDownloadDocument(cell.document!)}\n                                    data-testid={`download-document-${crewMemberId}-${cell.documentType}`}\n                                  >\n                                    <Download className=\"h-3 w-3 mr-1\" />\n                                    Download\n                                  </Button>\n                                  <Button\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    className=\"h-8 px-2 text-xs bg-red-50 hover:bg-red-100 border-red-200 text-red-700 hover:text-red-800\"\n                                    onClick={() => handleDeleteDocument(cell.document!)}\n                                    disabled={deleteDocumentMutation.isPending}\n                                    data-testid={`delete-document-${crewMemberId}-${cell.documentType}`}\n                                  >\n                                    <Trash2 className=\"h-3 w-3 mr-1\" />\n                                    {deleteDocumentMutation.isPending ? 'Deleting...' : 'Delete'}\n                                  </Button>\n                                </div>\n                              </div>\n                            ) : (\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className={`w-16 h-16 p-2 border-2 rounded-lg transition-colors ${getStatusColor(cell.status)}`}\n                                onClick={() => handleCellClick(cell)}\n                                data-testid={`document-cell-${crewMemberId}-${cell.documentType}`}\n                              >\n                                <div className=\"flex flex-col items-center space-y-1\">\n                                  {getStatusIcon(cell.status)}\n                                  <span className=\"text-xs text-gray-500\">Upload</span>\n                                </div>\n                              </Button>\n                            )}\n                          </TableCell>\n                        ))}\n                      </TableRow>\n                    );\n                  })\n                )}\n              </TableBody>\n            </Table>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Upload Modal */}\n      <Dialog open={isUploadModalOpen} onOpenChange={setIsUploadModalOpen}>\n        <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center space-x-2\">\n              <Upload className=\"h-5 w-5 text-primary\" />\n              <span>\n                {selectedCell?.document ? 'Update' : 'Upload'} {' '}\n                {DOCUMENT_TYPES.find(dt => dt.type === selectedCell?.documentType)?.label}\n              </span>\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedCell && (\n            <div className=\"space-y-4\">\n              <div className=\"bg-gray-50 p-3 rounded-lg\">\n                <div className=\"text-sm text-gray-600\">Crew Member</div>\n                <div className=\"font-medium\">{getCrewMemberName(selectedCell.crewMemberId)}</div>\n              </div>\n              \n              <DocumentUpload \n                crewMemberId={selectedCell.crewMemberId}\n                document={selectedCell.document}\n                preselectedType={selectedCell.documentType}\n                onSuccess={handleUploadSuccess}\n              />\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","path":null,"size_bytes":22081,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5742,"size_tokens":null},"client/src/components/crew/crew-table.tsx":{"content":"import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Label } from '@/components/ui/label';\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from '@/components/ui/alert-dialog';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from '@/components/ui/select';\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { Search, Eye, Edit, LogOut, LogIn, X, Ship, Trash2, Mail, Loader2 } from 'lucide-react';\nimport { useState } from 'react';\nimport { CrewMemberWithDetails, Document } from '@shared/schema';\nimport EditCrewForm from './edit-crew-form';\nimport { ContractProgress } from './contract-progress';\nimport { formatDate } from '@/lib/utils';\n\n// Helper function for calculating contract days remaining\nexport const getContractDaysRemaining = (member: any) => {\n  if (!member.activeContract || member.activeContract.status !== 'active') return 0;\n  \n  const now = new Date();\n  const endDate = new Date(member.activeContract.endDate);\n  const daysDiff = Math.ceil((endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n  \n  // Return days remaining (can be negative if expired, positive if future)\n  return daysDiff > 0 ? daysDiff : 0;\n};\n\nexport default function CrewTable() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [searchTerm, setSearchTerm] = useState('');\n  const [vesselFilter, setVesselFilter] = useState('all');\n  const [statusFilter, setStatusFilter] = useState('all');\n  const [selectedCrewMember, setSelectedCrewMember] = useState<CrewMemberWithDetails | null>(null);\n  const [showViewDialog, setShowViewDialog] = useState(false);\n  const [showEditDialog, setShowEditDialog] = useState(false);\n  const [showVesselHistoryDialog, setShowVesselHistoryDialog] = useState(false);\n  const [selectedCrewForHistory, setSelectedCrewForHistory] = useState<CrewMemberWithDetails | null>(null);\n  const [contractDialogOpen, setContractDialogOpen] = useState(false);\n  const [selectedCrewForContract, setSelectedCrewForContract] = useState<CrewMemberWithDetails | null>(null);\n  const [selectedVesselForAssignment, setSelectedVesselForAssignment] = useState<any>(null);\n  const [contractStartDate, setContractStartDate] = useState('');\n  const [contractDuration, setContractDuration] = useState('90');\n  const [contractEndDate, setContractEndDate] = useState('');\n  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);\n  const [selectedHistoryForDeletion, setSelectedHistoryForDeletion] = useState<any>(null);\n  const [deletionReason, setDeletionReason] = useState('');\n  const [signOffDialogOpen, setSignOffDialogOpen] = useState(false);\n  const [selectedCrewForSignOff, setSelectedCrewForSignOff] = useState<CrewMemberWithDetails | null>(null);\n  const [signOffReason, setSignOffReason] = useState('');\n  const [signOnDialogOpen, setSignOnDialogOpen] = useState(false);\n  const [selectedCrewForSignOn, setSelectedCrewForSignOn] = useState<CrewMemberWithDetails | null>(null);\n  const [signOnReason, setSignOnReason] = useState('');\n  const [signOnVesselId, setSignOnVesselId] = useState('');\n  const [signOnContractStartDate, setSignOnContractStartDate] = useState('');\n  const [signOnContractDuration, setSignOnContractDuration] = useState('90');\n  const [signOnContractEndDate, setSignOnContractEndDate] = useState('');\n  const [deleteCrewDialogOpen, setDeleteCrewDialogOpen] = useState(false);\n  const [selectedCrewForDeletion, setSelectedCrewForDeletion] = useState<CrewMemberWithDetails | null>(null);\n  const [emailDialogOpen, setEmailDialogOpen] = useState(false);\n  const [selectedCrewForEmail, setSelectedCrewForEmail] = useState<CrewMemberWithDetails | null>(null);\n  const [sendToAdditional, setSendToAdditional] = useState(false);\n  const [additionalEmail, setAdditionalEmail] = useState('');\n\n  const { data: crewMembers = [], isLoading, refetch } = useQuery<CrewMemberWithDetails[]>({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      console.log('Fetching crew data...');\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      const data = await response.json();\n      console.log('Received crew data:', data);\n      return data;\n    },\n  });\n\n  const { data: vessels } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  const { data: rotations = [] } = useQuery({\n    queryKey: ['/api/rotations'],\n    queryFn: async () => {\n      const response = await fetch('/api/rotations', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch rotations');\n      return response.json();\n    },\n  });\n\n  // Documents query for expiry tracking\n  const { data: documents = [] } = useQuery<Document[]>({\n    queryKey: ['/api/documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/documents', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch documents');\n      return response.json();\n    },\n  });\n\n  // Document types to track in crew overview\n  const TRACKED_DOC_TYPES = ['passport', 'cdc', 'coc', 'medical'] as const;\n\n  // Get document expiry status for a crew member\n  const getCrewDocumentExpiry = (crewMemberId: string) => {\n    const crewDocs = documents.filter(doc => doc.crewMemberId === crewMemberId);\n    const now = new Date();\n    \n    return TRACKED_DOC_TYPES.map(type => {\n      // For COC, also check for 'stcw' type since they're used interchangeably\n      const doc = crewDocs.find(d => {\n        const docType = d.type.toLowerCase();\n        const searchType = type.toLowerCase();\n        if (searchType === 'coc') {\n          return docType === 'coc' || docType === 'stcw';\n        }\n        return docType === searchType;\n      });\n      if (!doc) {\n        return { type, status: 'missing' as const, expiryDate: null, daysUntil: null };\n      }\n      \n      // Handle missing or invalid expiry dates\n      if (!doc.expiryDate) {\n        return { type, status: 'missing' as const, expiryDate: null, daysUntil: null };\n      }\n      \n      const expiryDate = new Date(doc.expiryDate);\n      \n      // Check if date is valid\n      if (isNaN(expiryDate.getTime())) {\n        return { type, status: 'missing' as const, expiryDate: null, daysUntil: null };\n      }\n      \n      const daysUntil = Math.ceil((expiryDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n      \n      let status: 'valid' | 'expiring' | 'expired' | 'missing' = 'valid';\n      if (daysUntil < 0) {\n        status = 'expired';\n      } else if (daysUntil <= 30) {\n        status = 'expiring';\n      }\n      \n      return { type, status, expiryDate, daysUntil };\n    });\n  };\n\n  // Get document type label\n  const getDocTypeLabel = (type: string) => {\n    const labels: Record<string, string> = {\n      passport: 'Pass',\n      cdc: 'CDC',\n      coc: 'COC',\n      medical: 'Med'\n    };\n    return labels[type] || type.toUpperCase();\n  };\n\n  // Get document status color\n  const getDocStatusColor = (status: string) => {\n    switch (status) {\n      case 'valid': return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400';\n      case 'expiring': return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400';\n      case 'expired': return 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400';\n      default: return 'bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400';\n    }\n  };\n\n  // Get vessel history for a crew member\n  const getVesselHistory = (crewMemberId: string) => {\n    const crewRotations = rotations.filter((r: any) => r.crewMemberId === crewMemberId && r.status === 'completed');\n    \n    // Group by vessel and get unique vessels with dates\n    const vesselMap = new Map();\n    crewRotations.forEach((rotation: any) => {\n      const vessel = vessels?.find((v: any) => v.id === rotation.vesselId);\n      if (vessel && !vesselMap.has(vessel.id)) {\n        vesselMap.set(vessel.id, {\n          vessel,\n          joinDate: rotation.joinDate,\n          leaveDate: rotation.leaveDate\n        });\n      }\n    });\n    \n    return Array.from(vesselMap.values());\n  };\n\n  const filteredCrew = crewMembers.filter(member => {\n    const matchesSearch = `${member.firstName} ${member.lastName}`.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         member.nationality.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         member.rank.toLowerCase().includes(searchTerm.toLowerCase());\n    \n    const matchesVessel = vesselFilter === 'all' || member.currentVesselId === vesselFilter;\n    \n    const matchesStatus = statusFilter === 'all' || member.status === statusFilter;\n    \n    return matchesSearch && matchesVessel && matchesStatus;\n  }) || [];\n\n  const getStatusColor = (status: string | undefined, contractStatus?: string) => {\n    // Prioritize crew member status over contract status\n    if (status === 'onBoard') return 'bg-compliance-green text-white';\n    if (status === 'onShore') return 'bg-ocean-blue text-white';\n    \n    // Legacy status support (if any old data exists)\n    if (status === 'active') return 'bg-compliance-green text-white';\n    if (status === 'onLeave') return 'bg-warning-amber text-white';\n    if (status === 'inactive') return 'bg-gray-500 text-white';\n    \n    // Fallback to contract status if crew status is missing\n    if (contractStatus === 'active') return 'bg-compliance-green text-white';\n    if (contractStatus === 'completed' || contractStatus === 'terminated') return 'bg-gray-500 text-white';\n    \n    return 'bg-gray-500 text-white';\n  };\n\n  const getStatusDisplayText = (status: string | undefined) => {\n    if (status === 'onBoard') return 'On Board';\n    if (status === 'onShore') return 'On Shore';\n    \n    // Legacy status support (if any old data exists)\n    if (status === 'active') return 'On Board';\n    if (status === 'onLeave') return 'On Leave';\n    if (status === 'inactive') return 'Inactive';\n    \n    return 'Unknown';\n  };\n\n  const getStatusDisplayTextMobile = (status: string | undefined) => {\n    if (status === 'onBoard') return 'On\\nBoard';\n    if (status === 'onShore') return 'On\\nShore';\n    \n    // Legacy status support (if any old data exists)\n    if (status === 'active') return 'Act\\nive';\n    if (status === 'onLeave') return 'On\\nLeave';\n    if (status === 'inactive') return 'Inact\\nive';\n    \n    return 'Unk\\nnown';\n  };\n\n  const getInitials = (firstName: string, lastName: string) => {\n    return `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();\n  };\n\n  const getContractDaysRemaining = (member: CrewMemberWithDetails) => {\n    if (!member.activeContract || member.activeContract.status !== 'active') return 0;\n    \n    const now = new Date();\n    const endDate = new Date(member.activeContract.endDate);\n    const daysDiff = Math.ceil((endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    \n    // Return days remaining (can be negative if expired, positive if future)\n    return daysDiff > 0 ? daysDiff : 0;\n  };\n\n  // Export the function so it can be used in other components like dashboard\n  const exportedUtils = {\n    getContractDaysRemaining,\n    getStatusColor,\n    getStatusDisplayText,\n    getStatusDisplayTextMobile,\n    getInitials\n  };\n\n  // Calculate contract end date based on start date and duration\n  const calculateEndDate = (startDate: string, durationDays: string) => {\n    if (!startDate || !durationDays) return '';\n    const start = new Date(startDate);\n    const duration = parseInt(durationDays);\n    if (isNaN(duration)) return '';\n    const end = new Date(start);\n    end.setDate(end.getDate() + duration);\n    return end.toISOString().split('T')[0];\n  };\n\n  // Update end date when start date or duration changes\n  const handleContractStartDateChange = (value: string) => {\n    setContractStartDate(value);\n    const endDate = calculateEndDate(value, contractDuration);\n    setContractEndDate(endDate);\n  };\n\n  const handleContractDurationChange = (value: string) => {\n    setContractDuration(value);\n    const endDate = calculateEndDate(contractStartDate, value);\n    setContractEndDate(endDate);\n  };\n\n  // Handle assign button click\n  const handleAssignToVessel = (crewMember: CrewMemberWithDetails, vessel: any, history: any) => {\n    setSelectedCrewForContract(crewMember);\n    setSelectedVesselForAssignment(vessel);\n    setContractDialogOpen(true);\n    \n    // Set default start date to today\n    const today = new Date().toISOString().split('T')[0];\n    setContractStartDate(today);\n    const endDate = calculateEndDate(today, contractDuration);\n    setContractEndDate(endDate);\n  };\n\n  // Assign crew to vessel mutation\n  const assignCrewMutation = useMutation({\n    mutationFn: async ({ crewId, vesselId }: { crewId: string; vesselId: string }) => {\n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          currentVesselId: vesselId,\n          status: 'onBoard',\n          signOffDate: null,\n        }),\n      });\n      if (!response.ok) {\n        const errorData = await response.text();\n        console.error('Assignment failed:', response.status, errorData);\n        \n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to assign crew member');\n        } catch {\n          throw new Error(`Assignment failed (${response.status}): ${errorData}`);\n        }\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      \n      toast({\n        title: 'Success',\n        description: 'Crew member assigned to vessel successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to assign crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Contract creation mutation\n  const createContractMutation = useMutation({\n    mutationFn: async (data: { crewId: string; vesselId: string; startDate: string; durationDays: number; endDate: string }) => {\n      // First, get all active contracts for this crew member and terminate them\n      const getContractsResponse = await fetch(`/api/contracts?crewMemberId=${data.crewId}`, {\n        headers: getAuthHeaders(),\n      });\n      \n      if (getContractsResponse.ok) {\n        const existingContracts = await getContractsResponse.json();\n        const activeContracts = existingContracts.filter((c: any) => c.status === 'active');\n        \n        // Terminate all active contracts\n        await Promise.all(\n          activeContracts.map((contract: any) =>\n            fetch(`/api/contracts/${contract.id}`, {\n              method: 'PUT',\n              headers: {\n                ...getAuthHeaders(),\n                'Content-Type': 'application/json',\n              },\n              body: JSON.stringify({\n                status: 'terminated',\n              }),\n            })\n          )\n        );\n      }\n\n      // Create the new contract\n      const response = await fetch('/api/contracts', {\n        method: 'POST',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          crewMemberId: data.crewId,\n          vesselId: data.vesselId,\n          startDate: data.startDate,\n          endDate: data.endDate,\n          durationDays: data.durationDays,\n          status: 'active',\n        }),\n      });\n\n      if (!response.ok) {\n        const error = await response.text();\n        throw new Error(error || 'Failed to create contract');\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/contracts'] });\n      \n      toast({\n        title: 'Success',\n        description: 'Contract created successfully',\n      });\n\n      // Close all dialogs\n      setContractDialogOpen(false);\n      setShowVesselHistoryDialog(false);\n      setSelectedCrewForContract(null);\n      setSelectedVesselForAssignment(null);\n      setContractStartDate('');\n      setContractDuration('90');\n      setContractEndDate('');\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to create contract',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Delete rotation history mutation\n  const deleteRotationMutation = useMutation({\n    mutationFn: async ({ rotationId, reason, deletedBy }: { rotationId: string; reason: string; deletedBy: string }) => {\n      const response = await fetch(`/api/rotations/${rotationId}`, {\n        method: 'DELETE',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          reason,\n          deletedBy,\n        }),\n      });\n      \n      if (!response.ok) {\n        const errorData = await response.text();\n        console.error('Delete failed:', response.status, errorData);\n        \n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to delete rotation history');\n        } catch {\n          throw new Error(`Delete failed (${response.status}): ${errorData}`);\n        }\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rotations'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      \n      toast({\n        title: 'Success',\n        description: 'Vessel history record deleted successfully',\n      });\n\n      // Close dialogs and reset state\n      setDeleteDialogOpen(false);\n      setSelectedHistoryForDeletion(null);\n      setDeletionReason('');\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to delete rotation history',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Handle delete button click\n  const handleDeleteHistory = (history: any, crewMember: CrewMemberWithDetails) => {\n    setSelectedHistoryForDeletion({ ...history, crewMember });\n    setDeleteDialogOpen(true);\n    setDeletionReason('');\n  };\n\n  // Handle deletion confirmation\n  const handleConfirmDeletion = async () => {\n    if (!selectedHistoryForDeletion || !deletionReason.trim()) {\n      toast({\n        title: 'Error',\n        description: 'Please provide a reason for deletion',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    // Find the rotation record to delete\n    const rotationToDelete = rotations.find((r: any) => \n      r.crewMemberId === selectedHistoryForDeletion.crewMember.id && \n      r.vesselId === selectedHistoryForDeletion.vessel.id &&\n      r.status === 'completed'\n    );\n\n    if (!rotationToDelete) {\n      toast({\n        title: 'Error',\n        description: 'Rotation record not found',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    // Get current user's name\n    const deletedBy = user?.username || 'Unknown User';\n\n    deleteRotationMutation.mutate({\n      rotationId: rotationToDelete.id,\n      reason: deletionReason,\n      deletedBy: deletedBy,\n    });\n  };\n\n  // Handle contract confirmation\n  const handleConfirmContract = () => {\n    if (!selectedCrewForContract || !selectedVesselForAssignment) return;\n    \n    if (!contractStartDate || !contractDuration) {\n      toast({\n        title: 'Error',\n        description: 'Please fill in all contract details',\n        variant: 'destructive',\n      });\n      return;\n    }\n    \n    const durationDays = parseInt(contractDuration);\n    if (isNaN(durationDays) || durationDays <= 0) {\n      toast({\n        title: 'Error',\n        description: 'Please enter a valid duration',\n        variant: 'destructive',\n      });\n      return;\n    }\n    \n    // First assign the crew member\n    assignCrewMutation.mutate(\n      { crewId: selectedCrewForContract.id, vesselId: selectedVesselForAssignment.id },\n      {\n        onSuccess: () => {\n          // Then create the contract\n          createContractMutation.mutate({\n            crewId: selectedCrewForContract.id,\n            vesselId: selectedVesselForAssignment.id,\n            startDate: contractStartDate,\n            durationDays: durationDays,\n            endDate: contractEndDate,\n          });\n        },\n      }\n    );\n  };\n\n  // Sign off crew member mutation\n  const signOffCrewMutation = useMutation({\n    mutationFn: async ({ crewId, reason }: { crewId: string; reason: string }) => {\n      // First, get the crew member's current vessel to preserve it as lastVessel\n      const crewMember = crewMembers?.find((member: CrewMemberWithDetails) => member.id === crewId);\n      const lastVesselId = crewMember?.currentVesselId || null;\n      \n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          currentVesselId: null,\n          lastVesselId: lastVesselId,\n          status: 'onShore',\n          signOffDate: new Date().toISOString(),\n          statusChangeReason: reason,\n        }),\n      });\n      if (!response.ok) {\n        const errorData = await response.text();\n        console.error('Sign-off failed:', response.status, errorData);\n        \n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to sign off crew member');\n        } catch {\n          throw new Error(`Sign-off failed (${response.status}): ${errorData}`);\n        }\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      setSignOffDialogOpen(false);\n      setSelectedCrewForSignOff(null);\n      setSignOffReason('');\n      toast({\n        title: 'Success',\n        description: 'Crew member signed off successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to sign off crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Handle sign off with reason dialog\n  const handleSignOffClick = (member: CrewMemberWithDetails) => {\n    setSelectedCrewForSignOff(member);\n    setSignOffReason('');\n    setSignOffDialogOpen(true);\n  };\n\n  const handleSignOffConfirm = () => {\n    if (!selectedCrewForSignOff) return;\n    if (!signOffReason.trim()) {\n      toast({\n        title: 'Reason Required',\n        description: 'Please provide a reason for this status change',\n        variant: 'destructive',\n      });\n      return;\n    }\n    signOffCrewMutation.mutate({ crewId: selectedCrewForSignOff.id, reason: signOffReason.trim() });\n  };\n\n  // Sign on crew member mutation (for crew members currently on shore)\n  const signOnCrewMutation = useMutation({\n    mutationFn: async ({ crewId, reason, vesselId, contractStartDate, contractEndDate }: { \n      crewId: string; \n      reason: string; \n      vesselId: string;\n      contractStartDate: string;\n      contractEndDate: string;\n    }) => {\n      // First update crew member status and vessel assignment\n      const crewResponse = await fetch(`/api/crew/${crewId}`, {\n        method: 'PUT',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          status: 'onBoard',\n          currentVesselId: vesselId,\n          statusChangeReason: reason,\n        }),\n      });\n      if (!crewResponse.ok) {\n        const errorData = await crewResponse.text();\n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to sign on crew member');\n        } catch {\n          throw new Error(`Sign-on failed (${crewResponse.status}): ${errorData}`);\n        }\n      }\n      \n      // Create contract for the crew member\n      const durationDays = Math.ceil((new Date(contractEndDate).getTime() - new Date(contractStartDate).getTime()) / (1000 * 60 * 60 * 24));\n      const contractResponse = await fetch('/api/contracts', {\n        method: 'POST',\n        headers: {\n          ...getAuthHeaders(),\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          crewMemberId: crewId,\n          vesselId: vesselId,\n          startDate: contractStartDate,\n          endDate: contractEndDate,\n          durationDays: durationDays,\n          status: 'active',\n        }),\n      });\n      if (!contractResponse.ok) {\n        const errorData = await contractResponse.text();\n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to create contract');\n        } catch {\n          throw new Error(`Contract creation failed (${contractResponse.status}): ${errorData}`);\n        }\n      }\n      \n      return crewResponse.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/contracts'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      setSignOnDialogOpen(false);\n      setSelectedCrewForSignOn(null);\n      setSignOnReason('');\n      setSignOnVesselId('');\n      setSignOnContractStartDate('');\n      setSignOnContractDuration('90');\n      setSignOnContractEndDate('');\n      toast({\n        title: 'Success',\n        description: 'Crew member signed on successfully with contract created',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to sign on crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Handle sign on with reason dialog\n  const handleSignOnClick = (member: CrewMemberWithDetails) => {\n    setSelectedCrewForSignOn(member);\n    setSignOnReason('');\n    setSignOnVesselId('');\n    const today = new Date().toISOString().split('T')[0];\n    setSignOnContractStartDate(today);\n    setSignOnContractDuration('90');\n    // Calculate end date (90 days from today by default)\n    const endDate = new Date();\n    endDate.setDate(endDate.getDate() + 90);\n    setSignOnContractEndDate(endDate.toISOString().split('T')[0]);\n    setSignOnDialogOpen(true);\n  };\n\n  const handleSignOnConfirm = () => {\n    if (!selectedCrewForSignOn) return;\n    if (!signOnReason.trim()) {\n      toast({\n        title: 'Reason Required',\n        description: 'Please provide a reason for this status change',\n        variant: 'destructive',\n      });\n      return;\n    }\n    if (!signOnVesselId) {\n      toast({\n        title: 'Vessel Required',\n        description: 'Please select a vessel for assignment',\n        variant: 'destructive',\n      });\n      return;\n    }\n    if (!signOnContractStartDate || !signOnContractEndDate) {\n      toast({\n        title: 'Contract Dates Required',\n        description: 'Please provide contract start and end dates',\n        variant: 'destructive',\n      });\n      return;\n    }\n    signOnCrewMutation.mutate({ \n      crewId: selectedCrewForSignOn.id, \n      reason: signOnReason.trim(),\n      vesselId: signOnVesselId,\n      contractStartDate: signOnContractStartDate,\n      contractEndDate: signOnContractEndDate,\n    });\n  };\n  \n  // Calculate sign-on contract end date when start date or duration changes\n  const calculateSignOnEndDate = (startDate: string, duration: string) => {\n    if (!startDate) return '';\n    const start = new Date(startDate);\n    start.setDate(start.getDate() + parseInt(duration));\n    return start.toISOString().split('T')[0];\n  };\n\n  // Delete crew member mutation\n  const deleteCrewMutation = useMutation({\n    mutationFn: async (crewId: string) => {\n      const response = await fetch(`/api/crew/${crewId}`, {\n        method: 'DELETE',\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) {\n        const errorData = await response.text();\n        try {\n          const errorJson = JSON.parse(errorData);\n          throw new Error(errorJson.message || errorJson.error || 'Failed to delete crew member');\n        } catch {\n          throw new Error(`Delete failed (${response.status}): ${errorData}`);\n        }\n      }\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/vessels'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/dashboard/stats'] });\n      setDeleteCrewDialogOpen(false);\n      setSelectedCrewForDeletion(null);\n      toast({\n        title: 'Success',\n        description: 'Crew member deleted successfully',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to delete crew member',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Handle delete crew member\n  const handleDeleteClick = (member: CrewMemberWithDetails) => {\n    setSelectedCrewForDeletion(member);\n    setDeleteCrewDialogOpen(true);\n  };\n\n  // Send crew details email mutation\n  const sendCrewEmailMutation = useMutation({\n    mutationFn: async (data: { crewMemberId: string; additionalEmail?: string }) => {\n      const response = await fetch('/api/email/send-crew-details', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...getAuthHeaders(),\n        },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.message || 'Failed to send email');\n      }\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setEmailDialogOpen(false);\n      setSelectedCrewForEmail(null);\n      setAdditionalEmail('');\n      setSendToAdditional(false);\n      toast({\n        title: 'Email Sent',\n        description: data.message || 'Crew details sent successfully via email',\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to send email',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleSendEmailClick = (member: CrewMemberWithDetails) => {\n    setSelectedCrewForEmail(member);\n    setEmailDialogOpen(true);\n  };\n\n  const handleSendEmailConfirm = () => {\n    if (!selectedCrewForEmail) return;\n    sendCrewEmailMutation.mutate({\n      crewMemberId: selectedCrewForEmail.id,\n      additionalEmail: sendToAdditional && additionalEmail ? additionalEmail : undefined\n    });\n  };\n\n  const handleDeleteConfirm = () => {\n    if (!selectedCrewForDeletion) return;\n    deleteCrewMutation.mutate(selectedCrewForDeletion.id);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-10 bg-muted rounded mb-4\"></div>\n          <div className=\"h-64 bg-muted rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  // For crew members, show only their own profile\n  if (user?.role === 'crew') {\n    const currentMember = crewMembers?.find(member => member.user?.id === user.id);\n    if (!currentMember) {\n      return <div className=\"text-center py-8 text-muted-foreground\">Profile not found</div>;\n    }\n\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"bg-muted rounded-lg p-6\">\n          <div className=\"flex items-center space-x-4\">\n            <Avatar className=\"h-16 w-16 bg-maritime-navy\">\n              <AvatarFallback className=\"text-white text-lg font-semibold\">\n                {getInitials(currentMember.firstName, currentMember.lastName)}\n              </AvatarFallback>\n            </Avatar>\n            <div>\n              <h3 className=\"text-xl font-semibold text-foreground\">\n                {currentMember.firstName} {currentMember.lastName}\n              </h3>\n              <p className=\"text-secondary-foreground\">{currentMember.rank}</p>\n              <p className=\"text-sm text-muted-foreground\">{currentMember.nationality}</p>\n            </div>\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mt-6\">\n            <div>\n              <p className=\"text-sm font-medium text-muted-foreground\">Current Vessel</p>\n              <p className=\"mt-1 text-foreground\">{currentMember.currentVessel?.name || 'Not assigned'}</p>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-muted-foreground\">Contract Status</p>\n              <Badge className={getStatusColor(currentMember.status, currentMember.activeContract?.status)} data-testid=\"crew-status\">\n                {getStatusDisplayText(currentMember.status)}\n              </Badge>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-muted-foreground\">Phone</p>\n              <p className=\"mt-1 text-foreground\">{currentMember.phoneNumber || 'Not provided'}</p>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-muted-foreground\">Email</p>\n              <p className=\"mt-1 text-foreground\">{(currentMember as any).email || 'Not provided'}</p>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-muted-foreground\">Documents</p>\n              <p className=\"mt-1 text-foreground\">{currentMember.documents?.length || 0} documents on file</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-full flex flex-col responsive-container\">\n      {/* Search and Filter - Sticky Header */}\n      <div className=\"sticky top-0 z-10 bg-background border-b border-border shrink-0\">\n        <div className=\"flex flex-col sm:flex-row items-stretch sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 p-3 sm:p-4 lg:p-6 pb-4\">\n          <div className=\"flex-1 relative\">\n            <Search className=\"absolute left-3 top-3 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search crew members...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-10 pr-10 text-sm\"\n              data-testid=\"crew-search-input\"\n            />\n            {searchTerm && (\n              <button\n                onClick={() => setSearchTerm('')}\n                className=\"absolute right-3 top-3 h-4 w-4 text-muted-foreground hover:text-foreground transition-colors\"\n                data-testid=\"clear-search-button\"\n                type=\"button\"\n              >\n                <X className=\"h-4 w-4\" />\n              </button>\n            )}\n          </div>\n          <Select value={vesselFilter} onValueChange={setVesselFilter}>\n            <SelectTrigger className=\"w-full sm:w-40 lg:w-48 text-sm\" data-testid=\"vessel-filter-select\">\n              <SelectValue placeholder=\"All Vessels\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Vessels</SelectItem>\n              {vessels?.map((vessel: any) => (\n                <SelectItem key={vessel.id} value={vessel.id}>\n                  {vessel.name}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Select value={statusFilter} onValueChange={setStatusFilter}>\n            <SelectTrigger className=\"w-full sm:w-40 lg:w-48 text-sm\" data-testid=\"status-filter-select\">\n              <SelectValue placeholder=\"All Status\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Status</SelectItem>\n              <SelectItem value=\"onBoard\">On Board</SelectItem>\n              <SelectItem value=\"onShore\">On Shore</SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n      </div>\n\n      {/* Crew List - Desktop and Large Tablets */}\n      <div className=\"flex-1 min-h-0 hidden lg:block\">\n        <div className=\"h-full w-full overflow-y-auto\">\n          {filteredCrew.length === 0 ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              No crew members found\n            </div>\n          ) : (\n            <div className=\"flex flex-col\">\n              {filteredCrew.map((member) => {\n                const startDate = member.activeContract?.startDate ? new Date(member.activeContract.startDate) : null;\n                const endDate = member.activeContract?.endDate ? new Date(member.activeContract.endDate) : null;\n                const now = new Date();\n                \n                let remainingDays = 0;\n                let totalDays = 0;\n                let progressPercent = 0;\n                \n                if (startDate && endDate && member.activeContract?.status === 'active') {\n                  totalDays = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));\n                  const elapsedDays = Math.max(0, Math.ceil((now.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)));\n                  remainingDays = Math.max(0, Math.ceil((endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));\n                  progressPercent = totalDays > 0 ? Math.min(100, (elapsedDays / totalDays) * 100) : 0;\n                }\n                \n                const formatShortDate = (date: Date | null) => {\n                  if (!date) return '';\n                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });\n                };\n\n                return (\n                  <div \n                    key={member.id} \n                    className=\"p-4 border-b border-border hover:bg-accent/50 transition-colors\"\n                    data-testid={`crew-row-desktop-${member.id}`}\n                  >\n                    {/* Header: Name, Nationality, Status Badge */}\n                    <div className=\"flex items-start justify-between mb-3\">\n                      <div>\n                        <h3 className=\"font-semibold text-foreground text-base\" data-testid=\"crew-name\">\n                          {member.firstName} {member.lastName}\n                        </h3>\n                        <p className=\"text-sm text-muted-foreground uppercase\">{member.nationality}</p>\n                      </div>\n                      <Badge \n                        className={`${getStatusColor(member.status, member.activeContract?.status)} text-xs px-3 py-1`}\n                        data-testid=\"crew-status\"\n                      >\n                        {getStatusDisplayText(member.status)}\n                      </Badge>\n                    </div>\n\n                    {/* Contract Progress Bar */}\n                    <div className=\"mb-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex justify-between text-xs text-muted-foreground mb-1\">\n                            <span>{startDate ? formatShortDate(startDate) : 'N/A'}</span>\n                            <span className=\"font-medium text-primary\">{remainingDays > 0 ? `${remainingDays} days` : ''}</span>\n                            <span>{endDate ? formatShortDate(endDate) : 'N/A'}</span>\n                          </div>\n                          <div className=\"relative h-2 bg-muted rounded-full overflow-hidden\">\n                            <div \n                              className=\"absolute inset-y-0 left-0 bg-gradient-to-r from-primary to-primary/70 rounded-full transition-all duration-1000 ease-out animate-pulse\"\n                              style={{ width: `${progressPercent}%` }}\n                            />\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Rank and Vessel */}\n                    <div className=\"grid grid-cols-2 gap-4 mb-4\">\n                      <div>\n                        <span className=\"text-xs text-muted-foreground\">Rank:</span>\n                        <p className=\"font-medium text-foreground text-sm\" data-testid=\"crew-rank\">{member.rank}</p>\n                      </div>\n                      <div>\n                        <span className=\"text-xs text-muted-foreground\">Vessel:</span>\n                        <p className=\"font-medium text-foreground text-sm\" data-testid=\"crew-vessel\">\n                          {member.currentVessel?.name || 'Not assigned'}\n                        </p>\n                      </div>\n                    </div>\n\n                    {/* Document Expiry Status */}\n                    <div className=\"mb-4\">\n                      <span className=\"text-xs text-muted-foreground block mb-2\">Document Status:</span>\n                      <div className=\"flex flex-wrap gap-2\" data-testid={`doc-status-${member.id}`}>\n                        {getCrewDocumentExpiry(member.id).map((doc) => (\n                          <div\n                            key={doc.type}\n                            className={`px-2 py-1 rounded text-xs font-medium ${getDocStatusColor(doc.status)}`}\n                            title={doc.expiryDate ? `Expires: ${formatDate(doc.expiryDate)}${doc.daysUntil !== null ? ` (${doc.daysUntil} days)` : ''}` : 'Not uploaded'}\n                          >\n                            {getDocTypeLabel(doc.type)}\n                            {doc.status === 'expiring' && doc.daysUntil !== null && (\n                              <span className=\"ml-1\">({doc.daysUntil}d)</span>\n                            )}\n                            {doc.status === 'expired' && <span className=\"ml-1\">!</span>}\n                            {doc.status === 'missing' && <span className=\"ml-1\">-</span>}\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n\n                    {/* Action Buttons */}\n                    <div className=\"flex items-center justify-between pt-3 border-t border-border\">\n                      <div className=\"flex items-center gap-4\">\n                        <button\n                          className=\"flex items-center gap-1.5 text-sm text-muted-foreground hover:text-primary transition-colors\"\n                          data-testid={`view-crew-${member.id}`}\n                          onClick={() => {\n                            setSelectedCrewMember(member);\n                            setShowViewDialog(true);\n                          }}\n                        >\n                          <Eye className=\"h-4 w-4\" />\n                          <span>View</span>\n                        </button>\n                        <button\n                          className=\"flex items-center gap-1.5 text-sm text-muted-foreground hover:text-primary transition-colors\"\n                          data-testid={`edit-crew-${member.id}`}\n                          onClick={() => {\n                            setSelectedCrewMember(member);\n                            setShowEditDialog(true);\n                          }}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                          <span>Edit</span>\n                        </button>\n                        <button\n                          className=\"flex items-center gap-1.5 text-sm text-muted-foreground hover:text-ocean-blue transition-colors\"\n                          data-testid={`vessel-history-${member.id}`}\n                          onClick={() => {\n                            setSelectedCrewForHistory(member);\n                            setShowVesselHistoryDialog(true);\n                          }}\n                        >\n                          <Ship className=\"h-4 w-4\" />\n                          <span>History</span>\n                        </button>\n                        <button\n                          className=\"flex items-center gap-1.5 text-sm text-muted-foreground hover:text-blue-600 transition-colors\"\n                          data-testid={`send-mail-${member.id}`}\n                          onClick={() => handleSendEmailClick(member)}\n                          disabled={sendCrewEmailMutation.isPending}\n                        >\n                          <Mail className=\"h-4 w-4\" />\n                          <span>{sendCrewEmailMutation.isPending ? 'Sending...' : 'Send Mail'}</span>\n                        </button>\n                      </div>\n                      <div className=\"flex items-center gap-3\">\n                        {member.status === 'onShore' ? (\n                          <>\n                            <button\n                              className=\"flex items-center gap-1.5 text-sm text-green-600 hover:text-green-700 transition-colors\"\n                              data-testid={`signon-crew-${member.id}`}\n                              onClick={() => handleSignOnClick(member)}\n                            >\n                              <LogIn className=\"h-4 w-4\" />\n                              <span>Sign On</span>\n                            </button>\n                            <button\n                              className=\"flex items-center gap-1.5 text-sm text-red-600 hover:text-red-700 transition-colors\"\n                              data-testid={`delete-crew-${member.id}`}\n                              onClick={() => handleDeleteClick(member)}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                              <span>Delete</span>\n                            </button>\n                          </>\n                        ) : (\n                          <button\n                            className=\"flex items-center gap-1.5 text-sm text-orange-600 hover:text-orange-700 transition-colors\"\n                            data-testid={`signoff-crew-${member.id}`}\n                            onClick={() => handleSignOffClick(member)}\n                          >\n                            <LogOut className=\"h-4 w-4\" />\n                            <span>Sign Off</span>\n                          </button>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Mobile and Tablet Crew Cards */}\n      <div className=\"flex-1 min-h-0 lg:hidden\">\n        <div className=\"h-full overflow-y-auto space-y-3 pt-4 px-3 max-w-full w-full\">\n          {filteredCrew.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <p>No crew members found</p>\n            </div>\n          ) : (\n            filteredCrew.map((member) => (\n              <div key={member.id} className=\"crew-card w-full max-w-full overflow-hidden box-border\" data-testid={`crew-card-${member.id}`}>\n              <div className=\"flex items-start justify-between mb-3 gap-2\">\n                <div className=\"flex-1 min-w-0\" style={{maxWidth: 'calc(100% - 56px)'}}>\n                  <div className=\"flex items-center space-x-2 mb-2\">\n                    <div className=\"min-w-0 flex-1\">\n                      <h3 className=\"font-medium text-foreground text-sm truncate\" data-testid=\"crew-name\">\n                        {member.firstName} {member.lastName}\n                      </h3>\n                      <p className=\"text-xs text-muted-foreground truncate\">{member.nationality}</p>\n                    </div>\n                  </div>\n                  <div className=\"w-full\">\n                    <ContractProgress\n                      startDate={member.activeContract?.startDate || ''}\n                      endDate={member.activeContract?.endDate || ''}\n                      status={member.activeContract?.status || ''}\n                      memberId={member.id}\n                      compact={true}\n                    />\n                  </div>\n                </div>\n                <div className=\"shrink-0 w-12 max-w-12 flex justify-center\">\n                  <Badge \n                    className={`${getStatusColor(member.status, member.activeContract?.status)} px-0 py-0 w-12 max-w-12 text-center border-0 mobile-status-badge`}\n                    data-testid=\"crew-status\"\n                    style={{fontSize: '8px', lineHeight: '9px', minHeight: '24px'}}\n                  >\n                    <span className=\"mobile-status-text\">\n                      {getStatusDisplayTextMobile(member.status)}\n                    </span>\n                  </Badge>\n                </div>\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-2 mb-3 text-xs\">\n                <div className=\"min-w-0 overflow-hidden\">\n                  <span className=\"text-muted-foreground block\">Rank:</span>\n                  <p className=\"font-medium text-foreground truncate break-words\" data-testid=\"crew-rank\" title={member.rank}>\n                    {member.rank}\n                  </p>\n                </div>\n                <div className=\"min-w-0 overflow-hidden\">\n                  <span className=\"text-muted-foreground block\">Vessel:</span>\n                  <p className=\"font-medium text-foreground truncate break-words\" data-testid=\"crew-vessel\" title={member.currentVessel?.name || 'Not assigned'}>\n                    {member.currentVessel?.name || 'Not assigned'}\n                  </p>\n                </div>\n              </div>\n              \n              {/* Document Expiry Status - Mobile */}\n              <div className=\"mb-3\">\n                <span className=\"text-xs text-muted-foreground block mb-1\">Docs:</span>\n                <div className=\"flex flex-wrap gap-1\" data-testid={`doc-status-mobile-${member.id}`}>\n                  {getCrewDocumentExpiry(member.id).map((doc) => (\n                    <div\n                      key={doc.type}\n                      className={`px-1.5 py-0.5 rounded text-[10px] font-medium ${getDocStatusColor(doc.status)}`}\n                      title={doc.expiryDate ? `Expires: ${formatDate(doc.expiryDate)}` : 'Not uploaded'}\n                    >\n                      {getDocTypeLabel(doc.type)}\n                      {doc.status === 'expiring' && doc.daysUntil !== null && (\n                        <span className=\"ml-0.5\">({doc.daysUntil}d)</span>\n                      )}\n                      {doc.status === 'expired' && <span className=\"ml-0.5\">!</span>}\n                      {doc.status === 'missing' && <span className=\"ml-0.5\">-</span>}\n                    </div>\n                  ))}\n                </div>\n              </div>\n              \n              <div className=\"flex justify-end gap-1 pt-2 border-t\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"text-primary hover:bg-accent h-7 text-xs px-2 flex-shrink-0\"\n                  data-testid={`view-crew-${member.id}`}\n                  onClick={() => {\n                    setSelectedCrewMember(member);\n                    setShowViewDialog(true);\n                  }}\n                >\n                  <Eye className=\"h-3 w-3 mr-1\" />\n                  View\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"text-muted-foreground hover:bg-accent h-7 text-xs px-2 flex-shrink-0\"\n                  data-testid={`edit-crew-${member.id}`}\n                  onClick={() => {\n                    setSelectedCrewMember(member);\n                    setShowEditDialog(true);\n                  }}\n                >\n                  <Edit className=\"h-3 w-3 mr-1\" />\n                  Edit\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"text-ocean-blue hover:bg-accent h-7 text-xs px-2 flex-shrink-0\"\n                  data-testid={`vessel-history-mobile-${member.id}`}\n                  onClick={() => {\n                    setSelectedCrewForHistory(member);\n                    setShowVesselHistoryDialog(true);\n                  }}\n                >\n                  <Ship className=\"h-3 w-3 mr-1\" />\n                  History\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"text-blue-600 hover:bg-blue-50 h-7 text-xs px-2 flex-shrink-0\"\n                  data-testid={`send-mail-mobile-${member.id}`}\n                  onClick={() => handleSendEmailClick(member)}\n                  disabled={sendCrewEmailMutation.isPending}\n                >\n                  <Mail className=\"h-3 w-3 mr-1\" />\n                  {sendCrewEmailMutation.isPending ? 'Sending...' : 'Send Mail'}\n                </Button>\n                {member.status === 'onShore' ? (\n                  <>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"text-green-600 hover:bg-green-50 h-7 text-xs px-2 flex-shrink-0\"\n                      data-testid={`signon-crew-mobile-${member.id}`}\n                      onClick={() => handleSignOnClick(member)}\n                    >\n                      <LogIn className=\"h-3 w-3 mr-1\" />\n                      Sign On\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"text-red-600 hover:bg-red-50 h-7 text-xs px-2 flex-shrink-0\"\n                      data-testid={`delete-crew-mobile-${member.id}`}\n                      onClick={() => handleDeleteClick(member)}\n                    >\n                      <Trash2 className=\"h-3 w-3 mr-1\" />\n                      Delete\n                    </Button>\n                  </>\n                ) : (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"text-orange-600 hover:bg-orange-50 h-7 text-xs px-2 flex-shrink-0\"\n                    data-testid={`signoff-crew-mobile-${member.id}`}\n                    onClick={() => handleSignOffClick(member)}\n                  >\n                    <LogOut className=\"h-3 w-3 mr-1\" />\n                    Sign Off\n                  </Button>\n                )}\n              </div>\n              </div>\n            ))\n          )}\n        </div>\n      </div>\n\n      {/* View Crew Member Dialog */}\n      <Dialog open={showViewDialog} onOpenChange={setShowViewDialog}>\n        <DialogContent className=\"sm:max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"text-foreground\">\n              Crew Member Details\n            </DialogTitle>\n          </DialogHeader>\n          {selectedCrewMember && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center space-x-4\">\n                <Avatar className=\"h-16 w-16 bg-maritime-navy\">\n                  <AvatarFallback className=\"text-white text-lg font-medium\">\n                    {getInitials(selectedCrewMember.firstName, selectedCrewMember.lastName)}\n                  </AvatarFallback>\n                </Avatar>\n                <div>\n                  <h3 className=\"text-xl font-semibold text-foreground\">\n                    {selectedCrewMember.firstName} {selectedCrewMember.lastName}\n                  </h3>\n                  <p className=\"text-muted-foreground\">{selectedCrewMember.rank}</p>\n                  <Badge className={getStatusColor(selectedCrewMember.status, selectedCrewMember.activeContract?.status)}>\n                    {selectedCrewMember.status === 'onBoard' ? 'On Board' :\n                     selectedCrewMember.status === 'onShore' ? 'On Shore' :\n                     selectedCrewMember.status === 'active' ? 'On Board' : \n                     selectedCrewMember.status === 'onLeave' ? 'On Leave' : \n                     selectedCrewMember.status === 'inactive' ? 'On Shore' : 'Unknown'}\n                  </Badge>\n                </div>\n              </div>\n              \n              <div className=\"space-y-4\">\n                {/* Personal Information */}\n                <div className=\"p-4 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg\">\n                  <h4 className=\"font-medium text-blue-900 dark:text-blue-100 flex items-center mb-3\">\n                    <div className=\"w-2 h-2 bg-blue-600 rounded-full mr-3\"></div>\n                    Personal Information\n                  </h4>\n                  <div className=\"text-sm space-y-2\">\n                    <p><span className=\"font-medium\">Nationality:</span> {selectedCrewMember.nationality}</p>\n                    <p><span className=\"font-medium\">Date of Birth:</span> {formatDate(selectedCrewMember.dateOfBirth)}</p>\n                    {selectedCrewMember.phoneNumber && (\n                      <p><span className=\"font-medium\">Phone:</span>{' '}\n                        <a \n                          href={`tel:${selectedCrewMember.phoneNumber}`}\n                          className=\"text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline\"\n                        >\n                          {selectedCrewMember.phoneNumber}\n                        </a>\n                      </p>\n                    )}\n                    {(selectedCrewMember as any).email && (\n                      <p><span className=\"font-medium\">Email:</span>{' '}\n                        <a \n                          href={`mailto:${(selectedCrewMember as any).email}`}\n                          className=\"text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline\"\n                        >\n                          {(selectedCrewMember as any).email}\n                        </a>\n                      </p>\n                    )}\n                  </div>\n                </div>\n                \n                {/* Professional Information */}\n                <div className=\"p-4 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg\">\n                  <h4 className=\"font-medium text-green-900 dark:text-green-100 flex items-center mb-3\">\n                    <div className=\"w-2 h-2 bg-green-600 rounded-full mr-3\"></div>\n                    Professional Information\n                  </h4>\n                  <div className=\"text-sm space-y-2\">\n                    <p><span className=\"font-medium\">Current Vessel:</span> {selectedCrewMember.currentVessel?.name || 'Not assigned'}</p>\n                    <p><span className=\"font-medium\">Status:</span> {selectedCrewMember.status}</p>\n                  </div>\n                </div>\n\n                {/* Emergency Contact / Next of Kin */}\n                {selectedCrewMember.emergencyContact && (\n                  <div className=\"p-4 bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-800 rounded-lg\">\n                    <h4 className=\"font-medium text-orange-900 dark:text-orange-100 flex items-center mb-3\">\n                      <div className=\"w-2 h-2 bg-orange-600 rounded-full mr-3\"></div>\n                      Next of Kin (NOK)\n                    </h4>\n                    <div className=\"text-sm space-y-2\">\n                      <p><span className=\"font-medium\">Name:</span> {(selectedCrewMember.emergencyContact as any).name}</p>\n                      <p><span className=\"font-medium\">Relationship:</span> {(selectedCrewMember.emergencyContact as any).relationship}</p>\n                      <p><span className=\"font-medium\">Phone:</span>{' '}\n                        {(selectedCrewMember.emergencyContact as any).phone ? (\n                          <a \n                            href={`tel:${(selectedCrewMember.emergencyContact as any).phone}`}\n                            className=\"text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline\"\n                          >\n                            {(selectedCrewMember.emergencyContact as any).phone}\n                          </a>\n                        ) : (\n                          'Not provided'\n                        )}\n                      </p>\n                      <p>\n                        <span className=\"font-medium\">Email:</span>{' '}\n                        {(selectedCrewMember.emergencyContact as any).email ? (\n                          <a \n                            href={`mailto:${(selectedCrewMember.emergencyContact as any).email}`}\n                            className=\"text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline\"\n                          >\n                            {(selectedCrewMember.emergencyContact as any).email}\n                          </a>\n                        ) : (\n                          'Not provided'\n                        )}\n                      </p>\n                      {(selectedCrewMember.emergencyContact as any).postalAddress && (\n                        <p><span className=\"font-medium\">Postal Address:</span> {(selectedCrewMember.emergencyContact as any).postalAddress}</p>\n                      )}\n                    </div>\n                  </div>\n                )}\n\n                {/* Passport Details */}\n                {(() => {\n                  const passport = selectedCrewMember.documents?.find(d => d.type === 'passport');\n                  return passport ? (\n                    <div className=\"p-4 bg-indigo-50 dark:bg-indigo-950/20 border border-indigo-200 dark:border-indigo-800 rounded-lg\">\n                      <h4 className=\"font-medium text-indigo-900 dark:text-indigo-100 flex items-center mb-3\">\n                        <div className=\"w-2 h-2 bg-indigo-600 rounded-full mr-3\"></div>\n                        Passport Details\n                      </h4>\n                      <div className=\"text-sm space-y-2\">\n                        <p><span className=\"font-medium\">Passport Number:</span> {passport.documentNumber}</p>\n                        <p><span className=\"font-medium\">Place of Issue:</span> {passport.issuingAuthority}</p>\n                        <p><span className=\"font-medium\">Issue Date:</span> {formatDate(passport.issueDate)}</p>\n                        <p><span className=\"font-medium\">Expiry Date:</span> {formatDate(passport.expiryDate)}</p>\n                      </div>\n                    </div>\n                  ) : null;\n                })()}\n\n                {/* CDC Details */}\n                {(() => {\n                  const cdc = selectedCrewMember.documents?.find(d => d.type === 'cdc');\n                  return cdc ? (\n                    <div className=\"p-4 bg-teal-50 dark:bg-teal-950/20 border border-teal-200 dark:border-teal-800 rounded-lg\">\n                      <h4 className=\"font-medium text-teal-900 dark:text-teal-100 flex items-center mb-3\">\n                        <div className=\"w-2 h-2 bg-teal-600 rounded-full mr-3\"></div>\n                        CDC Details\n                      </h4>\n                      <div className=\"text-sm space-y-2\">\n                        <p><span className=\"font-medium\">CDC Number:</span> {cdc.documentNumber}</p>\n                        <p><span className=\"font-medium\">Place of Issue:</span> {cdc.issuingAuthority}</p>\n                        <p><span className=\"font-medium\">Issue Date:</span> {formatDate(cdc.issueDate)}</p>\n                        <p><span className=\"font-medium\">Expiry Date:</span> {formatDate(cdc.expiryDate)}</p>\n                      </div>\n                    </div>\n                  ) : null;\n                })()}\n\n                {/* COC Details */}\n                {(() => {\n                  const coc = selectedCrewMember.documents?.find(d => d.type === 'stcw');\n                  return coc ? (\n                    <div className=\"p-4 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg\">\n                      <h4 className=\"font-medium text-amber-900 dark:text-amber-100 flex items-center mb-3\">\n                        <div className=\"w-2 h-2 bg-amber-600 rounded-full mr-3\"></div>\n                        COC Details\n                      </h4>\n                      <div className=\"text-sm space-y-2\">\n                        <p><span className=\"font-medium\">COC Grade/Number:</span> {coc.documentNumber}</p>\n                        <p><span className=\"font-medium\">Place of Issue:</span> {coc.issuingAuthority}</p>\n                        <p><span className=\"font-medium\">Issue Date:</span> {formatDate(coc.issueDate)}</p>\n                        <p><span className=\"font-medium\">Expiry Date:</span> {formatDate(coc.expiryDate)}</p>\n                      </div>\n                    </div>\n                  ) : null;\n                })()}\n\n                {/* Medical Details */}\n                {(() => {\n                  const medical = selectedCrewMember.documents?.find(d => d.type === 'medical');\n                  return medical ? (\n                    <div className=\"p-4 bg-rose-50 dark:bg-rose-950/20 border border-rose-200 dark:border-rose-800 rounded-lg\">\n                      <h4 className=\"font-medium text-rose-900 dark:text-rose-100 flex items-center mb-3\">\n                        <div className=\"w-2 h-2 bg-rose-600 rounded-full mr-3\"></div>\n                        Medical Certificate Details\n                      </h4>\n                      <div className=\"text-sm space-y-2\">\n                        <p><span className=\"font-medium\">Issuing Authority:</span> {medical.issuingAuthority}</p>\n                        <p><span className=\"font-medium\">Approval Number:</span> {medical.documentNumber}</p>\n                        <p><span className=\"font-medium\">Issue Date:</span> {formatDate(medical.issueDate)}</p>\n                        <p><span className=\"font-medium\">Expiry Date:</span> {formatDate(medical.expiryDate)}</p>\n                      </div>\n                    </div>\n                  ) : null;\n                })()}\n\n                {/* Contract Information */}\n                {selectedCrewMember.activeContract && (\n                  <div className=\"p-4 bg-purple-50 dark:bg-purple-950/20 border border-purple-200 dark:border-purple-800 rounded-lg\">\n                    <h4 className=\"font-medium text-purple-900 dark:text-purple-100 flex items-center mb-3\">\n                      <div className=\"w-2 h-2 bg-purple-600 rounded-full mr-3\"></div>\n                      Contract Information\n                    </h4>\n                    <div className=\"text-sm space-y-2\">\n                      <p><span className=\"font-medium\">Start Date:</span> {formatDate(selectedCrewMember.activeContract.startDate)}</p>\n                      <p><span className=\"font-medium\">End Date:</span> {formatDate(selectedCrewMember.activeContract.endDate)}</p>\n                    </div>\n                  </div>\n                )}\n              </div>\n              \n              <div className=\"flex justify-end gap-2 pt-4\">\n                <Button variant=\"outline\" onClick={() => setShowViewDialog(false)}>\n                  Close\n                </Button>\n                <Button \n                  onClick={() => {\n                    setShowViewDialog(false);\n                    setShowEditDialog(true);\n                  }}\n                  className=\"bg-primary hover:bg-primary/90\"\n                >\n                  Edit\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Vessel History Dialog */}\n      <Dialog open={showVesselHistoryDialog} onOpenChange={setShowVesselHistoryDialog}>\n        <DialogContent className=\"sm:max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center space-x-2\">\n              <Ship className=\"h-5 w-5 text-ocean-blue\" />\n              <span>Previous Vessels Joined</span>\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedCrewForHistory && (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center space-x-3 p-4 bg-muted/50 rounded-lg\">\n                <Avatar className=\"h-12 w-12 bg-maritime-navy\">\n                  <AvatarFallback className=\"text-white text-sm font-medium\">\n                    {selectedCrewForHistory.firstName.charAt(0)}{selectedCrewForHistory.lastName.charAt(0)}\n                  </AvatarFallback>\n                </Avatar>\n                <div>\n                  <h3 className=\"font-medium text-foreground\">\n                    {selectedCrewForHistory.firstName} {selectedCrewForHistory.lastName}\n                  </h3>\n                  <p className=\"text-sm text-muted-foreground\">{selectedCrewForHistory.rank}</p>\n                </div>\n              </div>\n\n              {(() => {\n                const vesselHistory = getVesselHistory(selectedCrewForHistory.id);\n                \n                return vesselHistory.length === 0 ? (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <Ship className=\"h-12 w-12 mx-auto mb-3 opacity-20\" />\n                    <p>No previous vessel history found</p>\n                    <p className=\"text-sm mt-1\">This crew member has no completed rotations</p>\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    <p className=\"text-sm font-medium text-muted-foreground\">\n                      {vesselHistory.length} {vesselHistory.length === 1 ? 'vessel' : 'vessels'} served\n                    </p>\n                    {vesselHistory.map((history: any, index: number) => (\n                      <div \n                        key={index} \n                        className=\"p-4 border border-border rounded-lg hover:bg-muted/30 transition-colors\"\n                        data-testid={`vessel-history-${index}`}\n                      >\n                        <div className=\"flex items-start justify-between gap-3\">\n                          <div className=\"space-y-2 flex-1\">\n                            <h4 className=\"font-medium text-foreground flex items-center\">\n                              <Ship className=\"h-4 w-4 mr-2 text-ocean-blue\" />\n                              {history.vessel.name}\n                            </h4>\n                            <div className=\"text-sm space-y-1 text-muted-foreground\">\n                              <p>\n                                <span className=\"font-medium\">Type:</span> {history.vessel.type}\n                              </p>\n                              <p>\n                                <span className=\"font-medium\">Sign On:</span>{' '}\n                                {history.joinDate \n                                  ? formatDate(history.joinDate)\n                                  : 'N/A'\n                                }\n                              </p>\n                              <p>\n                                <span className=\"font-medium\">Sign Off:</span>{' '}\n                                {history.leaveDate \n                                  ? formatDate(history.leaveDate)\n                                  : 'N/A'\n                                }\n                              </p>\n                            </div>\n                          </div>\n                          <div className=\"flex flex-col gap-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              className=\"bg-ocean-blue text-white hover:bg-ocean-blue/90 hover:text-white\"\n                              onClick={() => handleAssignToVessel(selectedCrewForHistory!, history.vessel, history)}\n                              data-testid={`assign-vessel-${index}`}\n                            >\n                              Assign\n                            </Button>\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              className=\"bg-red-600 text-white hover:bg-red-700 hover:text-white\"\n                              onClick={() => handleDeleteHistory(history, selectedCrewForHistory!)}\n                              data-testid={`delete-vessel-history-${index}`}\n                            >\n                              Delete\n                            </Button>\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                );\n              })()}\n              \n              <div className=\"flex justify-end pt-4\">\n                <Button \n                  variant=\"outline\" \n                  onClick={() => {\n                    setShowVesselHistoryDialog(false);\n                    setSelectedCrewForHistory(null);\n                  }}\n                >\n                  Close\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Vessel History Confirmation Dialog */}\n      <Dialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>\n        <DialogContent className=\"sm:max-w-[500px]\">\n          <DialogHeader>\n            <DialogTitle className=\"text-red-600\">Delete Vessel History Record</DialogTitle>\n            <DialogDescription>\n              You are about to delete the vessel history record for{' '}\n              <span className=\"font-medium\">\n                {selectedHistoryForDeletion?.crewMember?.firstName}{' '}\n                {selectedHistoryForDeletion?.crewMember?.lastName}\n              </span>{' '}\n              on vessel{' '}\n              <span className=\"font-medium\">{selectedHistoryForDeletion?.vessel?.name}</span>.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"p-3 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg\">\n              <p className=\"text-sm text-amber-900 dark:text-amber-100\">\n                <span className=\"font-medium\">Performed by:</span> {user?.username || 'Unknown User'}\n              </p>\n              <p className=\"text-xs text-amber-700 dark:text-amber-300 mt-1\">\n                This action will be logged for accountability and tracking purposes.\n              </p>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"deletion-reason\" className=\"text-red-600\">\n                Reason for Deletion <span className=\"text-red-600\">*</span>\n              </Label>\n              <Input\n                id=\"deletion-reason\"\n                placeholder=\"Enter the reason for deleting this record...\"\n                value={deletionReason}\n                onChange={(e) => setDeletionReason(e.target.value)}\n                className=\"border-red-200 focus:border-red-400\"\n                data-testid=\"input-deletion-reason\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Please provide a clear reason for deleting this vessel history record.\n              </p>\n            </div>\n          </div>\n          \n          <div className=\"flex justify-end space-x-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setDeleteDialogOpen(false);\n                setSelectedHistoryForDeletion(null);\n                setDeletionReason('');\n              }}\n              data-testid=\"button-cancel-deletion\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleConfirmDeletion}\n              disabled={deleteRotationMutation.isPending || !deletionReason.trim()}\n              className=\"bg-red-600 hover:bg-red-700\"\n              data-testid=\"button-confirm-deletion\"\n            >\n              {deleteRotationMutation.isPending ? 'Deleting...' : 'Delete Record'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Contract Information Dialog */}\n      <Dialog open={contractDialogOpen} onOpenChange={setContractDialogOpen}>\n        <DialogContent className=\"sm:max-w-[500px]\">\n          <DialogHeader>\n            <DialogTitle className=\"text-maritime-navy\">Contract Information</DialogTitle>\n            <DialogDescription>\n              Enter contract details for {selectedCrewForContract?.firstName} {selectedCrewForContract?.lastName} to join {selectedVesselForAssignment?.name}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"contract-start-date\">Contract Start Date</Label>\n                <Input\n                  id=\"contract-start-date\"\n                  type=\"date\"\n                  value={contractStartDate}\n                  onChange={(e) => handleContractStartDateChange(e.target.value)}\n                  data-testid=\"input-contract-start-date\"\n                />\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"contract-duration\">Duration (Days)</Label>\n                <Input\n                  id=\"contract-duration\"\n                  type=\"number\"\n                  value={contractDuration}\n                  onChange={(e) => handleContractDurationChange(e.target.value)}\n                  min=\"1\"\n                  data-testid=\"input-contract-duration\"\n                />\n              </div>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"contract-end-date\">Contract End Date (Auto-calculated)</Label>\n              <Input\n                id=\"contract-end-date\"\n                type=\"date\"\n                value={contractEndDate}\n                readOnly\n                disabled\n                className=\"bg-muted\"\n                data-testid=\"input-contract-end-date\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"flex justify-end space-x-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setContractDialogOpen(false);\n                setSelectedCrewForContract(null);\n                setSelectedVesselForAssignment(null);\n                setContractStartDate('');\n                setContractDuration('90');\n                setContractEndDate('');\n              }}\n              data-testid=\"button-cancel-contract\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleConfirmContract}\n              disabled={assignCrewMutation.isPending || createContractMutation.isPending}\n              data-testid=\"button-confirm-contract\"\n              className=\"bg-ocean-blue hover:bg-ocean-blue/90\"\n            >\n              {assignCrewMutation.isPending || createContractMutation.isPending ? 'Processing...' : 'Confirm & Assign'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Sign Off Reason Dialog */}\n      <Dialog open={signOffDialogOpen} onOpenChange={setSignOffDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle>Sign Off Crew Member</DialogTitle>\n            <DialogDescription>\n              {selectedCrewForSignOff && (\n                <>\n                  You are signing off {selectedCrewForSignOff.firstName} {selectedCrewForSignOff.lastName} from {selectedCrewForSignOff.currentVessel?.name || 'their current vessel'}.\n                  Please provide a reason for this status change.\n                </>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signoff-reason\">Reason for Status Change <span className=\"text-red-500\">*</span></Label>\n              <textarea\n                id=\"signoff-reason\"\n                className=\"w-full min-h-[100px] p-3 border rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-ocean-blue\"\n                placeholder=\"Enter the reason for signing off this crew member (required)\"\n                value={signOffReason}\n                onChange={(e) => setSignOffReason(e.target.value)}\n                data-testid=\"input-signoff-reason\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"flex justify-end space-x-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setSignOffDialogOpen(false);\n                setSelectedCrewForSignOff(null);\n                setSignOffReason('');\n              }}\n              data-testid=\"button-cancel-signoff\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSignOffConfirm}\n              disabled={signOffCrewMutation.isPending || !signOffReason.trim()}\n              data-testid=\"button-confirm-signoff\"\n              className=\"bg-orange-600 hover:bg-orange-700\"\n            >\n              {signOffCrewMutation.isPending ? 'Signing Off...' : 'Confirm Sign Off'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Sign On Reason Dialog */}\n      <Dialog open={signOnDialogOpen} onOpenChange={setSignOnDialogOpen}>\n        <DialogContent className=\"sm:max-w-lg\">\n          <DialogHeader>\n            <DialogTitle>Sign On Crew Member</DialogTitle>\n            <DialogDescription>\n              {selectedCrewForSignOn && (\n                <>\n                  You are signing on {selectedCrewForSignOn.firstName} {selectedCrewForSignOn.lastName}.\n                  Please select a vessel and provide contract details.\n                </>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signon-vessel\">Assign to Vessel <span className=\"text-red-500\">*</span></Label>\n              <Select value={signOnVesselId} onValueChange={setSignOnVesselId}>\n                <SelectTrigger data-testid=\"select-signon-vessel\">\n                  <SelectValue placeholder=\"Select a vessel\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {vessels?.map((vessel: any) => (\n                    <SelectItem key={vessel.id} value={vessel.id}>\n                      {vessel.name} ({vessel.type})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"signon-start-date\">Contract Start Date <span className=\"text-red-500\">*</span></Label>\n                <Input\n                  id=\"signon-start-date\"\n                  type=\"date\"\n                  value={signOnContractStartDate}\n                  onChange={(e) => {\n                    setSignOnContractStartDate(e.target.value);\n                    setSignOnContractEndDate(calculateSignOnEndDate(e.target.value, signOnContractDuration));\n                  }}\n                  data-testid=\"input-signon-start-date\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"signon-duration\">Contract Duration</Label>\n                <Select \n                  value={signOnContractDuration} \n                  onValueChange={(value) => {\n                    setSignOnContractDuration(value);\n                    setSignOnContractEndDate(calculateSignOnEndDate(signOnContractStartDate, value));\n                  }}\n                >\n                  <SelectTrigger data-testid=\"select-signon-duration\">\n                    <SelectValue placeholder=\"Select duration\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"30\">30 Days</SelectItem>\n                    <SelectItem value=\"60\">60 Days</SelectItem>\n                    <SelectItem value=\"90\">90 Days</SelectItem>\n                    <SelectItem value=\"120\">120 Days</SelectItem>\n                    <SelectItem value=\"180\">180 Days</SelectItem>\n                    <SelectItem value=\"270\">270 Days</SelectItem>\n                    <SelectItem value=\"365\">365 Days</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signon-end-date\">Contract End Date</Label>\n              <Input\n                id=\"signon-end-date\"\n                type=\"date\"\n                value={signOnContractEndDate}\n                readOnly\n                className=\"bg-gray-50\"\n                data-testid=\"input-signon-end-date\"\n              />\n              <p className=\"text-xs text-gray-500\">Auto-calculated based on start date and duration</p>\n            </div>\n            \n            <div className=\"space-y-2\">\n              <Label htmlFor=\"signon-reason\">Reason for Status Change <span className=\"text-red-500\">*</span></Label>\n              <textarea\n                id=\"signon-reason\"\n                className=\"w-full min-h-[80px] p-3 border rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-green-600\"\n                placeholder=\"Enter the reason for signing on this crew member (required)\"\n                value={signOnReason}\n                onChange={(e) => setSignOnReason(e.target.value)}\n                data-testid=\"input-signon-reason\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"flex justify-end space-x-2\">\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setSignOnDialogOpen(false);\n                setSelectedCrewForSignOn(null);\n                setSignOnReason('');\n                setSignOnVesselId('');\n                setSignOnContractStartDate('');\n                setSignOnContractDuration('90');\n                setSignOnContractEndDate('');\n              }}\n              data-testid=\"button-cancel-signon\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSignOnConfirm}\n              disabled={signOnCrewMutation.isPending || !signOnReason.trim() || !signOnVesselId || !signOnContractStartDate}\n              data-testid=\"button-confirm-signon\"\n              className=\"bg-green-600 hover:bg-green-700\"\n            >\n              {signOnCrewMutation.isPending ? 'Signing On...' : 'Confirm Sign On'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Crew Member Confirmation Dialog */}\n      <AlertDialog open={deleteCrewDialogOpen} onOpenChange={setDeleteCrewDialogOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Crew Member</AlertDialogTitle>\n            <AlertDialogDescription>\n              {selectedCrewForDeletion && (\n                <>\n                  Are you sure you want to delete {selectedCrewForDeletion.firstName} {selectedCrewForDeletion.lastName}? \n                  This action cannot be undone and will permanently remove all associated data including contracts and documents.\n                </>\n              )}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel\n              onClick={() => {\n                setDeleteCrewDialogOpen(false);\n                setSelectedCrewForDeletion(null);\n              }}\n              data-testid=\"button-cancel-delete-crew\"\n            >\n              Cancel\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={handleDeleteConfirm}\n              disabled={deleteCrewMutation.isPending}\n              data-testid=\"button-confirm-delete-crew\"\n              className=\"bg-red-600 hover:bg-red-700\"\n            >\n              {deleteCrewMutation.isPending ? 'Deleting...' : 'Delete'}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Edit Crew Member Dialog */}\n      <Dialog open={showEditDialog} onOpenChange={setShowEditDialog}>\n        <DialogContent className=\"sm:max-w-2xl max-h-[90vh] overflow-y-auto p-0\">\n          <div className=\"p-6 overflow-y-auto max-h-[85vh]\">\n            <DialogHeader className=\"mb-6\">\n              <DialogTitle className=\"text-foreground mb-3\">\n                Edit Crew Member\n              </DialogTitle>\n            </DialogHeader>\n            {selectedCrewMember && (\n              <EditCrewForm \n                crewMember={selectedCrewMember}\n                onSuccess={() => {\n                  console.log('Edit form success - closing dialog and refreshing data');\n                  setShowEditDialog(false);\n                  setSelectedCrewMember(null);\n                  // Force additional refresh to ensure UI updates\n                  refetch();\n                }}\n              />\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Send Crew Details Email Dialog */}\n      <Dialog open={emailDialogOpen} onOpenChange={setEmailDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Mail className=\"h-5 w-5\" />\n              Send Crew Details\n            </DialogTitle>\n            <DialogDescription>\n              {selectedCrewForEmail && (\n                <>Send complete details for {selectedCrewForEmail.firstName} {selectedCrewForEmail.lastName} via email.</>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"flex items-center space-x-2\">\n              <Checkbox \n                id=\"send-additional-crew\"\n                checked={sendToAdditional}\n                onCheckedChange={(checked) => setSendToAdditional(checked === true)}\n                data-testid=\"checkbox-additional-email-crew\"\n              />\n              <Label htmlFor=\"send-additional-crew\" className=\"text-sm font-medium cursor-pointer\">\n                Also send to an additional email address\n              </Label>\n            </div>\n            \n            {sendToAdditional && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"additional-email-crew\">Additional Email Address</Label>\n                <Input\n                  id=\"additional-email-crew\"\n                  type=\"email\"\n                  placeholder=\"Enter email address\"\n                  value={additionalEmail}\n                  onChange={(e) => setAdditionalEmail(e.target.value)}\n                  data-testid=\"input-additional-email-crew\"\n                />\n              </div>\n            )}\n          </div>\n          \n          <DialogFooter className=\"gap-2\">\n            <Button \n              variant=\"outline\" \n              onClick={() => {\n                setEmailDialogOpen(false);\n                setSelectedCrewForEmail(null);\n                setAdditionalEmail('');\n                setSendToAdditional(false);\n              }}\n              data-testid=\"button-cancel-email-crew\"\n            >\n              Cancel\n            </Button>\n            <Button \n              onClick={handleSendEmailConfirm}\n              disabled={sendCrewEmailMutation.isPending || (sendToAdditional && !additionalEmail)}\n              data-testid=\"button-send-email-crew\"\n            >\n              {sendCrewEmailMutation.isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Sending...\n                </>\n              ) : (\n                <>\n                  <Mail className=\"h-4 w-4 mr-2\" />\n                  Send Email\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":93963,"size_tokens":null},"deployment/start.js":{"content":"const express = require('express');\nconst path = require('path');\n\n// Import your server\nrequire('./server/index.js');\n\nconsole.log('CrewTrack Pro started successfully!');\nconsole.log('Environment:', process.env.NODE_ENV);\nconsole.log('Port:', process.env.PORT || 3000);\n","path":null,"size_bytes":271,"size_tokens":null},"replit.md":{"content":"# Crew Management System\n\n## Overview\nThis project is a comprehensive maritime crew management application designed to streamline crew scheduling, document management, contract tracking, and compliance monitoring for maritime vessels. It features a React frontend and an Express backend, supporting two user roles (admin, office_staff) with role-based access controls. Key capabilities include real-time alerts for document expiration and contract renewals, robust activity logging, and OCR-based document processing. The system aims to provide a centralized, efficient, and cost-effective solution for maritime crew management.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend Architecture\n- **Framework**: React with TypeScript, utilizing functional components and hooks.\n- **Styling**: Tailwind CSS with `shadcn/ui` for a consistent design system.\n- **State Management**: TanStack Query (React Query) for server state management and caching.\n- **Routing**: Wouter for lightweight client-side routing.\n- **Forms**: React Hook Form with Zod validation for type-safe form handling.\n- **UI Components**: Radix UI primitives with custom styling for accessibility.\n\n### Backend Architecture\n- **Framework**: Express.js for a RESTful API server.\n- **Language**: TypeScript for full type safety.\n- **Storage**: In-memory mock storage, designed for future database integration.\n- **Authentication**: Simplified JWT-based authentication with role-based access control.\n- **Structure**: Clean separation of server logic, routes, and storage layers.\n\n### Data Layer\n- **ORM**: Drizzle ORM configured for PostgreSQL with comprehensive schema definitions.\n- **Schema Design**: Covers users, vessels, crew members, contracts, documents, crew rotations, and email settings.\n- **Validation**: Zod schemas for runtime validation and TypeScript type inference.\n- **Migrations**: Drizzle Kit for database migrations.\n\n### Authentication & Authorization\n- **Role System**: Two roles: `admin` (full access, user/vessel management, reports) and `office_staff` (data entry, crew/vessel updates, limited reporting).\n- **Authentication**: Mock authentication with demo credentials for development.\n- **UI Adaptation**: Dynamic navigation and feature access based on user roles.\n- **State Management**: React Context for global authentication state.\n\n### Key Features\n- **Crew Management & Contracts**: Profile image handling, contract creation, and enhanced crew workflow.\n- **Document Management**: File upload, local OCR using Tesseract.js for data extraction, automated expiry tracking, and severity-based alerts.\n- **Scheduling System**: Management of crew join/leave dates, vessel assignments, and calendar integration for overview.\n- **Activity Logging**: Comprehensive system activity logging for all user operations, with real-time reporting accessible to both admins and office staff.\n- **Responsiveness**: Mobile-first design with dual-layout system (table for desktop, cards for mobile) and enhanced tablet responsiveness.\n- **Form Enhancements**: Automatic contract end date calculation, consistent relationship options, and comprehensive vessel editing.\n\n## External Dependencies\n\n### Core Framework Dependencies\n- `@neondatabase/serverless`: PostgreSQL driver.\n- `drizzle-orm`: Type-safe ORM.\n- `@tanstack/react-query`: Server state management.\n- `react-hook-form`: Form handling.\n- `@hookform/resolvers`: Zod validation integration for forms.\n\n### UI & Styling\n- `@radix-ui/*`: Accessible UI primitives.\n- `tailwindcss`: Utility-first CSS framework.\n- `class-variance-authority`: Component variants utility.\n- `lucide-react`: Icon library.\n\n### Development Tools\n- `vite`: Fast build tool and dev server.\n- `typescript`: Static type checking.\n- `tsx`: TypeScript execution for Node.js.\n- `date-fns`: Date manipulation utilities.\n\n### Production Services (Ready for Integration)\n- **Database**: PostgreSQL (e.g., Neon).\n- **File Storage**: AWS S3 or similar.\n- **Email Service**: SMTP or email API.\n- **Authentication**: Extendable JWT implementation.","path":null,"size_bytes":4110,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, timestamp, integer, boolean, jsonb } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Users table for authentication\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  role: text(\"role\").notNull(), // 'admin', 'office_staff'\n  email: text(\"email\").notNull(),\n  name: text(\"name\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Vessels table\nexport const vessels = pgTable(\"vessels\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(),\n  imoNumber: text(\"imo_number\").unique(),\n  flag: text(\"flag\").notNull(),\n  status: text(\"status\").notNull().default('harbour-mining'), // 'harbour-mining', 'coastal-mining', 'world-wide', 'oil-field', 'line-up-mining'\n  sortOrder: integer(\"sort_order\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Crew members table\nexport const crewMembers = pgTable(\"crew_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  firstName: text(\"first_name\").notNull(),\n  lastName: text(\"last_name\").notNull(),\n  nationality: text(\"nationality\").notNull(),\n  dateOfBirth: timestamp(\"date_of_birth\").notNull(),\n  rank: text(\"rank\").notNull(),\n  phoneNumber: text(\"phone_number\"),\n  email: text(\"email\"),\n  emergencyContact: jsonb(\"emergency_contact\"), // {name, relationship, phone, email}\n  currentVesselId: varchar(\"current_vessel_id\").references(() => vessels.id),\n  lastVesselId: varchar(\"last_vessel_id\").references(() => vessels.id), // Track previous vessel for ex-hand records\n  status: text(\"status\").notNull().default('onBoard'), // 'onBoard', 'onShore'\n  signOffDate: timestamp(\"sign_off_date\"), // Auto-stamped when crew member is signed off\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Contracts table\nexport const contracts = pgTable(\"contracts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  crewMemberId: varchar(\"crew_member_id\").notNull().references(() => crewMembers.id),\n  vesselId: varchar(\"vessel_id\").notNull().references(() => vessels.id),\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  durationDays: integer(\"duration_days\"), // Number of days for the contract\n  salary: integer(\"salary\"),\n  currency: text(\"currency\").default('USD'),\n  status: text(\"status\").notNull().default('active'), // 'active', 'completed', 'terminated'\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Documents table\nexport const documents = pgTable(\"documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  crewMemberId: varchar(\"crew_member_id\").notNull().references(() => crewMembers.id),\n  type: text(\"type\").notNull(), // 'passport', 'cdc', 'stcw', 'medical', 'visa', 'coc'\n  documentNumber: text(\"document_number\").notNull(),\n  issueDate: timestamp(\"issue_date\").notNull(),\n  expiryDate: timestamp(\"expiry_date\").notNull(),\n  issuingAuthority: text(\"issuing_authority\").notNull(),\n  status: text(\"status\").notNull().default('valid'), // 'valid', 'expiring', 'expired'\n  filePath: text(\"file_path\"), // For file storage reference\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Crew rotations/scheduling\nexport const crewRotations = pgTable(\"crew_rotations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  crewMemberId: varchar(\"crew_member_id\").notNull().references(() => crewMembers.id),\n  vesselId: varchar(\"vessel_id\").notNull().references(() => vessels.id),\n  joinDate: timestamp(\"join_date\").notNull(),\n  leaveDate: timestamp(\"leave_date\"),\n  rotationType: text(\"rotation_type\").notNull(), // 'join', 'leave', 'rotation'\n  status: text(\"status\").notNull().default('scheduled'), // 'scheduled', 'completed', 'cancelled'\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Email notification settings\nexport const emailSettings = pgTable(\"email_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  reminderDays: jsonb(\"reminder_days\").default([30, 15, 7]), // Days before expiry to send reminders\n  enabled: boolean(\"enabled\").default(true),\n  recipients: jsonb(\"recipients\").default(['office_staff', 'admin']), // Who receives notifications\n  recipientEmail: text(\"recipient_email\").default('admin@offing.biz'), // Primary recipient email address\n  emailTemplate: text(\"email_template\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// WhatsApp notification settings\nexport const whatsappSettings = pgTable(\"whatsapp_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  enabled: boolean(\"enabled\").default(false),\n  provider: text(\"provider\").notNull().default('twilio'), // 'twilio', 'wassenger', 'whapi'\n  apiKey: text(\"api_key\"), // Encrypted API key\n  groupId: text(\"group_id\"), // WhatsApp group ID or phone number\n  webhookUrl: text(\"webhook_url\"), // Third-party service webhook URL\n  notificationTypes: jsonb(\"notification_types\").default(['contract_expiry', 'document_expiry', 'crew_rotation']),\n  reminderDays: jsonb(\"reminder_days\").default([7, 3, 1]), // Days before events to send notifications\n  messageTemplate: text(\"message_template\").default('üìã *Crew Management Alert*\\n\\n{{title}}\\n{{description}}\\n\\nDate: {{date}}\\nSeverity: {{severity}}'),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Vessel documents table\nexport const vesselDocuments = pgTable(\"vessel_documents\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  vesselId: varchar(\"vessel_id\").notNull().references(() => vessels.id),\n  name: text(\"name\").notNull(), // Document name/title\n  type: text(\"type\").notNull(), // 'certificate', 'insurance', 'inspection', 'safety', 'customs', 'other'\n  description: text(\"description\"), // Optional description\n  fileName: text(\"file_name\").notNull(), // Original file name\n  filePath: text(\"file_path\").notNull(), // Object storage path\n  fileSize: integer(\"file_size\"), // File size in bytes\n  mimeType: text(\"mime_type\"), // File MIME type\n  uploadedBy: varchar(\"uploaded_by\").notNull().references(() => users.id),\n  uploadedAt: timestamp(\"uploaded_at\").defaultNow(),\n  expiryDate: timestamp(\"expiry_date\"), // Optional expiry date for certificates\n  isPublic: boolean(\"is_public\").default(false), // Whether document is publicly accessible\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Activity log table for tracking all system activities\nexport const activityLogs = pgTable(\"activity_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  type: text(\"type\").notNull(), // 'User Registration', 'Crew Management', 'Contract Management', etc.\n  action: text(\"action\").notNull(), // 'create', 'update', 'delete'\n  entityType: text(\"entity_type\").notNull(), // 'user', 'crew', 'vessel', 'contract', etc.\n  entityId: text(\"entity_id\"), // ID of the affected entity\n  userId: varchar(\"user_id\").references(() => users.id),\n  username: text(\"username\").notNull(),\n  userRole: text(\"user_role\").notNull(),\n  description: text(\"description\").notNull(),\n  severity: text(\"severity\").notNull().default('info'), // 'info', 'success', 'warning', 'error'\n  metadata: jsonb(\"metadata\"), // Additional context data\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Notification history table for tracking sent notifications to prevent duplicates\nexport const notificationHistory = pgTable(\"notification_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  eventId: text(\"event_id\").notNull(), // Unique identifier for the event\n  eventType: text(\"event_type\").notNull(), // 'contract_expiry', 'document_expiry', 'crew_join', etc.\n  eventDate: timestamp(\"event_date\").notNull(), // When the event is scheduled to occur\n  notificationDate: timestamp(\"notification_date\").notNull(), // When the notification was sent\n  daysBeforeEvent: integer(\"days_before_event\").notNull(), // How many days before the event this notification was sent\n  provider: text(\"provider\").notNull(), // 'whatsapp', 'email', etc.\n  success: boolean(\"success\").notNull().default(true), // Whether the notification was sent successfully\n  errorMessage: text(\"error_message\"), // Error message if sending failed\n  retryCount: integer(\"retry_count\").default(0), // Number of retry attempts\n  metadata: jsonb(\"metadata\"), // Additional context data like crew member name, vessel name, etc.\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Crew status change history table for tracking status changes with mandatory reasons\nexport const statusChangeHistory = pgTable(\"status_change_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  crewMemberId: varchar(\"crew_member_id\").notNull().references(() => crewMembers.id),\n  previousStatus: text(\"previous_status\").notNull(), // 'onBoard', 'onShore'\n  newStatus: text(\"new_status\").notNull(), // 'onBoard', 'onShore'\n  reason: text(\"reason\").notNull(), // Mandatory reason for the status change\n  changedBy: varchar(\"changed_by\").references(() => users.id), // User who made the change\n  changedByUsername: text(\"changed_by_username\").notNull(), // Username for audit trail\n  vesselId: varchar(\"vessel_id\").references(() => vessels.id), // Vessel at time of change (if applicable)\n  contractId: varchar(\"contract_id\").references(() => contracts.id), // Related contract (if applicable)\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Create insert schemas with proper validation\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  role: z.enum([\"admin\", \"office_staff\"]),\n});\n\nexport const insertVesselSchema = createInsertSchema(vessels).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertCrewMemberSchema = createInsertSchema(crewMembers).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  dateOfBirth: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n  signOffDate: z.union([z.date(), z.string().transform((str) => new Date(str)), z.null()]).optional(),\n  status: z.enum(['onBoard', 'onShore']).optional(),\n});\n\nexport const insertContractSchema = createInsertSchema(contracts).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  startDate: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n  endDate: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n});\n\nexport const insertDocumentSchema = createInsertSchema(documents).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  issueDate: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n  expiryDate: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n});\n\nexport const insertCrewRotationSchema = createInsertSchema(crewRotations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertEmailSettingsSchema = createInsertSchema(emailSettings).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport const insertWhatsappSettingsSchema = createInsertSchema(whatsappSettings).omit({\n  id: true,\n  updatedAt: true,\n}).extend({\n  provider: z.enum(['twilio', 'wassenger', 'whapi', 'custom']),\n});\n\nexport const insertVesselDocumentSchema = createInsertSchema(vesselDocuments).omit({\n  id: true,\n  createdAt: true,\n  uploadedAt: true,\n}).extend({\n  expiryDate: z.union([z.date(), z.string().transform((str) => new Date(str)), z.null()]).optional(),\n});\n\nexport const insertActivityLogSchema = createInsertSchema(activityLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertNotificationHistorySchema = createInsertSchema(notificationHistory).omit({\n  id: true,\n  createdAt: true,\n}).extend({\n  eventDate: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n  notificationDate: z.union([z.date(), z.string().transform((str) => new Date(str))]),\n});\n\nexport const insertStatusChangeHistorySchema = createInsertSchema(statusChangeHistory).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Type exports\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type Vessel = typeof vessels.$inferSelect;\nexport type InsertVessel = z.infer<typeof insertVesselSchema>;\nexport type CrewMember = typeof crewMembers.$inferSelect;\nexport type InsertCrewMember = z.infer<typeof insertCrewMemberSchema>;\nexport type Contract = typeof contracts.$inferSelect;\nexport type InsertContract = z.infer<typeof insertContractSchema>;\nexport type Document = typeof documents.$inferSelect;\nexport type InsertDocument = z.infer<typeof insertDocumentSchema>;\nexport type CrewRotation = typeof crewRotations.$inferSelect;\nexport type InsertCrewRotation = z.infer<typeof insertCrewRotationSchema>;\nexport type EmailSettings = typeof emailSettings.$inferSelect;\nexport type InsertEmailSettings = z.infer<typeof insertEmailSettingsSchema>;\nexport type VesselDocument = typeof vesselDocuments.$inferSelect;\nexport type InsertVesselDocument = z.infer<typeof insertVesselDocumentSchema>;\nexport type ActivityLog = typeof activityLogs.$inferSelect;\nexport type InsertActivityLog = z.infer<typeof insertActivityLogSchema>;\nexport type NotificationHistory = typeof notificationHistory.$inferSelect;\nexport type InsertNotificationHistory = z.infer<typeof insertNotificationHistorySchema>;\nexport type StatusChangeHistory = typeof statusChangeHistory.$inferSelect;\nexport type InsertStatusChangeHistory = z.infer<typeof insertStatusChangeHistorySchema>;\n\nexport type StatusChangeHistoryWithDetails = StatusChangeHistory & {\n  crewMember?: CrewMember;\n  vessel?: Vessel;\n};\n\n// Additional types for API responses\nexport type CrewMemberWithDetails = CrewMember & {\n  user?: User;\n  currentVessel?: Vessel;\n  lastVessel?: Vessel;\n  documents?: Document[];\n  activeContract?: Contract;\n};\n\nexport type VesselWithCrew = Vessel & {\n  crewMembers?: CrewMemberWithDetails[];\n  documents?: VesselDocument[];\n};\n\nexport type DocumentAlert = {\n  document: Document;\n  crewMember: CrewMember;\n  daysUntilExpiry: number;\n  severity: 'critical' | 'warning' | 'info';\n};\n\nexport type ContractAlert = {\n  contract: Contract;\n  crewMember: CrewMember;\n  vessel: Vessel;\n  daysUntilExpiry: number;\n  severity: 'critical' | 'warning' | 'info' | 'expired';\n};\n","path":null,"size_bytes":14525,"size_tokens":null},"deployment/server/localOcrService.ts":{"content":"import { createWorker } from 'tesseract.js';\nimport sharp from 'sharp';\n\nexport interface ExtractedCrewData {\n  name?: string;\n  position?: string;\n  nationality?: string;\n  dateOfBirth?: string;\n  passportNumber?: string;\n  seamansBookNumber?: string;\n  cdcNumber?: string;\n  phoneNumber?: string;\n  email?: string;\n  emergencyContact?: string;\n  emergencyPhone?: string;\n  contractStartDate?: string;\n  contractEndDate?: string;\n  joinDate?: string;\n  leaveDate?: string;\n  vessel?: string;\n  salary?: string;\n}\n\nexport class LocalOCRService {\n  private worker: any = null;\n\n  async initializeWorker() {\n    if (!this.worker) {\n      this.worker = await createWorker('eng', undefined, {\n        logger: m => console.log('Tesseract:', m)\n      });\n      await this.worker.setParameters({\n        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 +-/:@.',\n        preserve_interword_spaces: '1'\n      });\n    }\n    return this.worker;\n  }\n\n  async extractCrewDataFromDocument(base64Data: string, filename?: string): Promise<ExtractedCrewData> {\n    try {\n      console.log('Starting OCR extraction for file:', filename);\n      console.log('Base64 data length:', base64Data?.length || 0);\n      \n      let extractedText = '';\n\n      // Validate input\n      if (!base64Data || base64Data.length === 0) {\n        throw new Error('No image data provided');\n      }\n\n      // Detect file type from base64 data\n      const isPDF = base64Data.startsWith('JVBERi') || filename?.toLowerCase().endsWith('.pdf');\n      \n      if (isPDF) {\n        throw new Error('PDF files are not supported yet. Please convert your PDF to an image (JPG/PNG) first, or take a photo of the document.');\n      } else {\n        // Handle image\n        console.log('Processing image with Tesseract...');\n        extractedText = await this.extractTextFromImage(base64Data);\n      }\n\n      console.log('Extracted raw text:', extractedText);\n\n      // Parse the extracted text to find crew information\n      const crewData = this.parseCrewInformation(extractedText);\n      console.log('Parsed crew data:', crewData);\n      \n      return crewData;\n    } catch (error) {\n      console.error('Local OCR extraction error:', error);\n      if (error instanceof Error) {\n        throw new Error(`OCR processing failed: ${error.message}`);\n      }\n      throw new Error('Failed to extract data from document. Please try again or enter the information manually.');\n    }\n  }\n\n  // PDF extraction removed for now to avoid dependency issues\n\n  private async extractTextFromImage(base64Data: string): Promise<string> {\n    try {\n      console.log('Initializing Tesseract worker...');\n      // Initialize Tesseract worker\n      const worker = await this.initializeWorker();\n      \n      console.log('Converting base64 to buffer...');\n      // Convert base64 to buffer and optimize image for OCR\n      const buffer = Buffer.from(base64Data, 'base64');\n      console.log('Buffer size:', buffer.length);\n      \n      console.log('Optimizing image for OCR...');\n      const optimizedBuffer = await sharp(buffer)\n        .resize({ width: 1200, height: 1600, fit: 'inside' })\n        .grayscale()\n        .normalize()\n        .sharpen()\n        .threshold(128)\n        .png()\n        .toBuffer();\n      console.log('Optimized buffer size:', optimizedBuffer.length);\n\n      console.log('Starting OCR recognition...');\n      // Perform OCR\n      const { data: { text } } = await worker.recognize(optimizedBuffer);\n      console.log('OCR completed, text length:', text?.length || 0);\n      return text || '';\n    } catch (error) {\n      console.error('Image OCR error:', error);\n      throw new Error(`Failed to extract text from image: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  private parseCrewInformation(text: string): ExtractedCrewData {\n    const result: ExtractedCrewData = {};\n    \n    // If text is empty or very short, return empty result\n    if (!text || text.trim().length < 10) {\n      console.log('Text too short or empty, no meaningful content extracted');\n      return {};\n    }\n    \n    const lines = text.split('\\n').map(line => line.trim()).filter(line => line.length > 0);\n    console.log('Parsing text with', lines.length, 'lines');\n    console.log('All lines for debugging:');\n    lines.forEach((line, index) => {\n      console.log(`${index}: \"${line}\"`);\n    });\n    \n    // Parse the specific structure of this maritime contract\n    // Look for EMPLOYEE section and extract name\n    const employeeIndex = lines.findIndex(line => line.toUpperCase().trim() === 'EMPLOYEE');\n    if (employeeIndex >= 0 && employeeIndex < lines.length - 1) {\n      console.log('Found EMPLOYEE section at index:', employeeIndex);\n      // Look for name in the lines immediately after EMPLOYEE\n      for (let i = employeeIndex + 1; i < Math.min(employeeIndex + 8, lines.length); i++) {\n        const line = lines[i].trim();\n        console.log(`Checking line ${i} for name: \"${line}\"`);\n        \n        // Look for a line that could be a name - typical format is all caps or title case\n        if (line.length > 5 && line.length < 60 && \n            !line.toUpperCase().includes('PASSPORT') && \n            !line.toUpperCase().includes('VESSEL') &&\n            !line.toUpperCase().includes('OFFICE') &&\n            !line.toUpperCase().includes('NO.') &&\n            !line.includes('IMO') &&\n            !line.includes('CH ') &&\n            !line.includes('The said') &&\n            // Check if it looks like a name (letters and spaces only, possibly with dots)\n            /^[A-Z][A-Za-z\\s.]+$/.test(line)) {\n          result.name = line;\n          console.log('Extracted name from employee section:', line);\n          break;\n        }\n      }\n    }\n\n    // Alternative method: Look for names in common patterns\n    if (!result.name) {\n      console.log('Trying alternative name extraction methods...');\n      \n      // Check if the name appears immediately in the text between EMPLOYEE and PASSPORT NO\n      const employeeToPassportMatch = text.match(/EMPLOYEE\\s*[\\r\\n]+(.*?)[\\r\\n]*PASSPORT\\s+NO/i);\n      if (employeeToPassportMatch && employeeToPassportMatch[1]) {\n        const potentialName = employeeToPassportMatch[1].trim();\n        console.log('Found potential name between EMPLOYEE and PASSPORT:', potentialName);\n        \n        // Clean and validate the name\n        if (potentialName.length > 5 && potentialName.length < 80 && \n            !potentialName.toUpperCase().includes('OFFICE') &&\n            !potentialName.toUpperCase().includes('LIMITED') &&\n            !potentialName.toUpperCase().includes('FLOOR') &&\n            /^[A-Z][A-Za-z\\s.]+$/.test(potentialName)) {\n          result.name = potentialName;\n          console.log('Extracted name using EMPLOYEE-PASSPORT pattern:', potentialName);\n        }\n      }\n      \n      // If still no name, try looking for standalone name lines\n      if (!result.name) {\n        for (let i = 0; i < lines.length; i++) {\n          const line = lines[i];\n          // Look for lines that could be names - 2-4 words, all caps or title case\n          if (line.length > 8 && line.length < 50 &&\n              /^[A-Z][A-Z\\s]+$/.test(line) &&\n              !line.includes('LIMITED') &&\n              !line.includes('PRIVATE') &&\n              !line.includes('OFFICE') &&\n              !line.includes('PASSPORT') &&\n              !line.includes('VESSEL') &&\n              !line.includes('CONTRACT') &&\n              !line.includes('EMPLOYMENT') &&\n              !line.includes('MARINE') &&\n              !line.includes('OFFSHORE') &&\n              !line.includes('BELAPUR') &&\n              !line.includes('MUMBAI') &&\n              !line.includes('OWNER') &&\n              !line.includes('EMPLOVER') &&\n              // Should be 2-4 words (typical name structure)\n              line.split(/\\s+/).length >= 2 && line.split(/\\s+/).length <= 4) {\n            result.name = line;\n            console.log('Found potential name as standalone line:', line);\n            break;\n          }\n        }\n      }\n    }\n\n    // Extract passport number - look for line with \"PASSPORT NO\" and number\n    const passportLine = lines.find(line => \n      line.toUpperCase().includes('PASSPORT') && line.toUpperCase().includes('NO')\n    );\n    if (passportLine) {\n      // Extract numbers from passport line\n      const passportMatch = passportLine.match(/(\\d{6,10})/);\n      if (passportMatch) {\n        result.passportNumber = passportMatch[1];\n        console.log('Found passport number:', passportMatch[1]);\n      }\n    }\n\n    // Extract vessel name - look for line with \"VESSEL\" and name\n    const vesselLine = lines.find(line => \n      line.toUpperCase().includes('VESSEL') && !line.toUpperCase().includes('SUCH VESSEL')\n    );\n    if (vesselLine) {\n      // Extract vessel name between VESSEL and IMO\n      const vesselMatch = vesselLine.match(/VESSEL\\s+([A-Z0-9\\s]+?)(?:\\s+IMO|$)/i);\n      if (vesselMatch) {\n        result.vessel = vesselMatch[1].trim();\n        console.log('Found vessel name:', vesselMatch[1].trim());\n      }\n    }\n\n    // Extract position/rank - look for \"rank of\" pattern\n    const rankText = text.toLowerCase();\n    const rankMatch = rankText.match(/employed.*?rank\\s+of\\s+([a-z\\s]+?)(?:\\s+on\\s+board|\\s|$)/i);\n    if (rankMatch) {\n      result.position = rankMatch[1].trim().toUpperCase();\n      console.log('Found position/rank:', rankMatch[1].trim().toUpperCase());\n    }\n\n    // Extract salary - look for \"BASIC PER MONTH\" or similar\n    const salaryLine = lines.find(line => \n      line.toUpperCase().includes('BASIC') && line.toUpperCase().includes('MONTH')\n    );\n    if (salaryLine) {\n      const salaryMatch = salaryLine.match(/(\\d+[,.]?\\d*)/);\n      if (salaryMatch) {\n        result.salary = salaryMatch[1];\n        console.log('Found salary:', salaryMatch[1]);\n      }\n    }\n\n    // Extract nationality - if available in document\n    const nationalityMatch = text.match(/nationality[:\\s]*([a-z]+)/i);\n    if (nationalityMatch) {\n      result.nationality = nationalityMatch[1];\n      console.log('Found nationality:', nationalityMatch[1]);\n    }\n\n    // Extract date of birth - look for DOB patterns\n    const dobPatterns = [\n      /date\\s+of\\s+birth[:\\s]*(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/i,\n      /dob[:\\s]*(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/i,\n      /born[:\\s]*(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/i,\n      /birth[:\\s]*(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/i\n    ];\n\n    for (const pattern of dobPatterns) {\n      const dobMatch = text.match(pattern);\n      if (dobMatch) {\n        const date = dobMatch[1];\n        const parts = date.split(/[\\/\\-]/);\n        const year = parseInt(parts[2]);\n        \n        // Validate reasonable birth year (1950-2005 for working age)\n        if (year >= 1950 && year <= 2005) {\n          result.dateOfBirth = date;\n          console.log('Found date of birth:', date);\n          break;\n        }\n      }\n    }\n\n    // Extract dates - look for realistic date patterns\n    const allDates = text.match(/(\\d{1,2}[\\/\\-]\\d{1,2}[\\/\\-]\\d{4})/g) || [];\n    const validDates = allDates.filter(date => {\n      const parts = date.split(/[\\/\\-]/);\n      const year = parseInt(parts[2]);\n      const month = parseInt(parts[1]);\n      const day = parseInt(parts[0]);\n      \n      // Basic date validation\n      return year >= 2020 && year <= 2030 && \n             month >= 1 && month <= 12 && \n             day >= 1 && day <= 31;\n    });\n\n    if (validDates.length >= 1) {\n      result.contractStartDate = validDates[0];\n      console.log('Found contract start date:', validDates[0]);\n      \n      if (validDates.length >= 2) {\n        result.contractEndDate = validDates[1];\n        console.log('Found contract end date:', validDates[1]);\n      }\n    }\n\n    // Extract CDC number if mentioned\n    const cdcMatch = text.match(/cdc[:\\s]*([a-z0-9]+)/i);\n    if (cdcMatch) {\n      result.seamansBookNumber = cdcMatch[1];\n      console.log('Found CDC number:', cdcMatch[1]);\n    }\n\n    // Clean up all extracted values\n    Object.keys(result).forEach(key => {\n      const value = result[key as keyof ExtractedCrewData];\n      if (value && typeof value === 'string') {\n        result[key as keyof ExtractedCrewData] = value\n          .replace(/\\s+/g, ' ')\n          .trim();\n      }\n    });\n\n    // If no name was found, it might be missing from OCR - note this in logs\n    if (!result.name) {\n      // Note: Employee names are often not detected due to font/format limitations in maritime documents\n      // This is expected behavior and users can manually enter names when needed\n      console.log('Employee name not detected - this is normal for maritime contract documents');\n    }\n\n    console.log('Final parsed crew data:', result);\n    return result;\n  }\n\n  async cleanup() {\n    if (this.worker) {\n      await this.worker.terminate();\n      this.worker = null;\n    }\n  }\n}\n\nexport const localOcrService = new LocalOCRService();","path":null,"size_bytes":12943,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport { QueryClientProvider } from '@tanstack/react-query';\nimport { ThemeProvider } from './contexts/theme-context';\nimport { queryClient } from './lib/queryClient';\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(\n  <QueryClientProvider client={queryClient}>\n    <ThemeProvider>\n      <App />\n    </ThemeProvider>\n  </QueryClientProvider>\n);\n","path":null,"size_bytes":444,"size_tokens":null},"client/src/components/layout/sidebar-new.tsx":{"content":"import { useAuth } from '@/contexts/auth-context';\nimport { useLocation } from 'wouter';\nimport { Link } from 'wouter';\nimport { cn } from '@/lib/utils';\nimport { \n  LayoutDashboard, \n  Users, \n  Ship, \n  Calendar, \n  FileText,\n  Settings,\n  Bell,\n  History\n} from 'lucide-react';\n\ninterface SidebarProps {\n  isOpen: boolean;\n  onClose: () => void;\n  isMobile: boolean;\n}\n\nconst navItems = [\n  {\n    label: 'Dashboard',\n    href: '/',\n    icon: LayoutDashboard,\n    roles: ['admin', 'office_staff']\n  },\n  {\n    label: 'Scheduling',\n    href: '/scheduling',\n    icon: Calendar,\n    roles: ['admin', 'office_staff']\n  },\n  {\n    label: 'Documents',\n    href: '/documents',\n    icon: FileText,\n    roles: ['admin', 'office_staff']\n  },\n  {\n    label: 'Status History',\n    href: '/status-history',\n    icon: History,\n    roles: ['admin', 'office_staff']\n  },\n  {\n    label: 'Settings',\n    href: '/settings',\n    icon: Settings,\n    roles: ['admin']\n  },\n  {\n    label: 'Notifications',\n    href: '/notifications',\n    icon: Bell,\n    roles: ['admin']\n  }\n];\n\nexport default function Sidebar({ isOpen, onClose, isMobile }: SidebarProps) {\n  const { user } = useAuth();\n  const [location] = useLocation();\n\n  const filteredNavItems = navItems.filter(item => \n    item.roles.includes(user?.role || '')\n  );\n\n  const sidebarClasses = cn(\n    'bg-card border-r border-border shadow-sm fixed left-0 top-20 bottom-0 overflow-y-auto transition-transform duration-200 z-40',\n    isMobile ? 'w-64' : 'w-64',\n    isOpen || !isMobile ? 'translate-x-0' : '-translate-x-full'\n  );\n\n  return (\n    <aside className={sidebarClasses}>\n      <nav className=\"p-6\">\n        <div className=\"space-y-2\">\n          <ul className=\"space-y-1\">\n            {filteredNavItems.map((item) => {\n              const isActive = location === item.href || (item.href === '/' && location === '/dashboard');\n              return (\n                <li key={item.href}>\n                  <Link href={item.href}>\n                    <span\n                      className={cn(\n                        'flex items-center space-x-3 px-3 py-2 rounded-lg transition-colors cursor-pointer',\n                        isActive \n                          ? 'bg-primary text-primary-foreground' \n                          : 'text-foreground hover:bg-accent hover:text-accent-foreground'\n                      )}\n                      onClick={isMobile ? onClose : undefined}\n                      data-testid={`nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n                    >\n                      <item.icon className=\"h-4 w-4\" />\n                      <span>{item.label}</span>\n                    </span>\n                  </Link>\n                </li>\n              );\n            })}\n          </ul>\n        </div>\n      </nav>\n    </aside>\n  );\n}","path":null,"size_bytes":2813,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/modals/email-settings-modal.tsx":{"content":"import { useState } from 'react';\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { useMutation } from '@tanstack/react-query';\nimport { queryClient } from '@/lib/queryClient';\nimport { apiRequest } from '@/lib/queryClient';\nimport { useToast } from '@/hooks/use-toast';\nimport { insertEmailSettingsSchema, EmailSettings } from '@shared/schema';\nimport { DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';\nimport { Button } from '@/components/ui/button';\nimport { Switch } from '@/components/ui/switch';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Badge } from '@/components/ui/badge';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Mail, Send, Settings } from 'lucide-react';\nimport { z } from 'zod';\n\nconst emailSettingsFormSchema = insertEmailSettingsSchema.extend({\n  reminder30: z.boolean(),\n  reminder15: z.boolean(),\n  reminder7: z.boolean(),\n  recipientCrew: z.boolean(),\n  recipientCaptain: z.boolean(),\n  recipientAdmin: z.boolean(),\n});\n\ntype EmailSettingsFormData = z.infer<typeof emailSettingsFormSchema>;\n\ninterface EmailSettingsModalProps {\n  settings?: EmailSettings;\n  onClose: () => void;\n}\n\nexport default function EmailSettingsModal({ settings, onClose }: EmailSettingsModalProps) {\n  const { toast } = useToast();\n  const [testEmailSent, setTestEmailSent] = useState(false);\n\n  const form = useForm<EmailSettingsFormData>({\n    resolver: zodResolver(emailSettingsFormSchema),\n    defaultValues: {\n      enabled: settings?.enabled ?? true,\n      reminder30: settings?.reminderDays?.includes(30) ?? true,\n      reminder15: settings?.reminderDays?.includes(15) ?? true,\n      reminder7: settings?.reminderDays?.includes(7) ?? true,\n      recipientCrew: settings?.recipients?.includes('crew') ?? true,\n      recipientCaptain: settings?.recipients?.includes('captain') ?? true,\n      recipientAdmin: settings?.recipients?.includes('admin') ?? true,\n      emailTemplate: settings?.emailTemplate ?? '',\n    },\n  });\n\n  const updateSettingsMutation = useMutation({\n    mutationFn: async (data: EmailSettingsFormData) => {\n      const { reminder30, reminder15, reminder7, recipientCrew, recipientCaptain, recipientAdmin, ...settingsData } = data;\n      \n      const reminderDays = [];\n      if (reminder30) reminderDays.push(30);\n      if (reminder15) reminderDays.push(15);\n      if (reminder7) reminderDays.push(7);\n\n      const recipients = [];\n      if (recipientCrew) recipients.push('crew');\n      if (recipientCaptain) recipients.push('captain');\n      if (recipientAdmin) recipients.push('admin');\n\n      const payload = {\n        ...settingsData,\n        reminderDays,\n        recipients,\n      };\n\n      return apiRequest('PUT', '/api/email-settings', payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/email-settings'] });\n      toast({\n        title: 'Success',\n        description: 'Email settings updated successfully',\n      });\n    },\n    onError: () => {\n      toast({\n        title: 'Error',\n        description: 'Failed to update email settings',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const testEmailMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest('POST', '/api/email/send-test', {});\n    },\n    onSuccess: () => {\n      setTestEmailSent(true);\n      toast({\n        title: 'Success',\n        description: 'Test email sent successfully',\n      });\n    },\n    onError: () => {\n      toast({\n        title: 'Error',\n        description: 'Failed to send test email',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const onSubmit = (data: EmailSettingsFormData) => {\n    updateSettingsMutation.mutate(data);\n  };\n\n  const handleTestEmail = () => {\n    testEmailMutation.mutate();\n  };\n\n  const defaultTemplate = `Dear [Crew Member],\n\nYour [Document Type] with document number [Document Number] is scheduled to expire on [Expiry Date]. \n\nPlease contact your Fleet Administrator to discuss renewal arrangements or provide updated documentation.\n\nFor immediate assistance, please contact:\n- Email: admin@crewtrack.com  \n- Phone: +1-555-0123\n\nBest regards,\nCrewTrack Pro Team`;\n\n  return (\n    <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n      <DialogHeader>\n        <DialogTitle className=\"flex items-center space-x-2\">\n          <Mail className=\"h-5 w-5 maritime-navy\" />\n          <span>Email Notification Settings</span>\n        </DialogTitle>\n      </DialogHeader>\n\n      <Form {...form}>\n        <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n          {/* Global Enable/Disable */}\n          <div className=\"space-y-3\">\n            <FormField\n              control={form.control}\n              name=\"enabled\"\n              render={({ field }) => (\n                <FormItem className=\"flex items-center justify-between space-y-0\">\n                  <div>\n                    <FormLabel className=\"text-base font-medium\">Email Notifications</FormLabel>\n                    <p className=\"text-sm text-gray-500\">Enable automated email alerts for document expiry</p>\n                  </div>\n                  <FormControl>\n                    <Switch\n                      checked={field.value}\n                      onCheckedChange={field.onChange}\n                      data-testid=\"email-notifications-toggle\"\n                    />\n                  </FormControl>\n                </FormItem>\n              )}\n            />\n          </div>\n\n          {form.watch('enabled') && (\n            <>\n              {/* Reminder Schedule */}\n              <div className=\"space-y-4\">\n                <div>\n                  <h4 className=\"text-base font-medium text-gray-900 mb-3\">Contract Expiry Reminders</h4>\n                  <p className=\"text-sm text-gray-500 mb-4\">Select when to send reminder emails before document expiry</p>\n                </div>\n\n                <div className=\"grid grid-cols-3 gap-6\">\n                  <FormField\n                    control={form.control}\n                    name=\"reminder30\"\n                    render={({ field }) => (\n                      <FormItem className=\"space-y-2\">\n                        <div className=\"flex items-center space-x-2\">\n                          <FormControl>\n                            <Checkbox\n                              checked={field.value}\n                              onCheckedChange={field.onChange}\n                              data-testid=\"reminder-30-days\"\n                            />\n                          </FormControl>\n                          <FormLabel className=\"text-sm font-medium\">30 Days</FormLabel>\n                        </div>\n                        <p className=\"text-xs text-gray-500\">Early warning reminder</p>\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"reminder15\"\n                    render={({ field }) => (\n                      <FormItem className=\"space-y-2\">\n                        <div className=\"flex items-center space-x-2\">\n                          <FormControl>\n                            <Checkbox\n                              checked={field.value}\n                              onCheckedChange={field.onChange}\n                              data-testid=\"reminder-15-days\"\n                            />\n                          </FormControl>\n                          <FormLabel className=\"text-sm font-medium\">15 Days</FormLabel>\n                        </div>\n                        <p className=\"text-xs text-gray-500\">Standard reminder</p>\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"reminder7\"\n                    render={({ field }) => (\n                      <FormItem className=\"space-y-2\">\n                        <div className=\"flex items-center space-x-2\">\n                          <FormControl>\n                            <Checkbox\n                              checked={field.value}\n                              onCheckedChange={field.onChange}\n                              data-testid=\"reminder-7-days\"\n                            />\n                          </FormControl>\n                          <FormLabel className=\"text-sm font-medium\">7 Days</FormLabel>\n                        </div>\n                        <p className=\"text-xs text-gray-500\">Urgent reminder</p>\n                      </FormItem>\n                    )}\n                  />\n                </div>\n              </div>\n\n              {/* Notification Recipients */}\n              <div className=\"space-y-4\">\n                <div>\n                  <h4 className=\"text-base font-medium text-gray-900 mb-3\">Notification Recipients</h4>\n                  <p className=\"text-sm text-gray-500 mb-4\">Select who should receive email notifications</p>\n                </div>\n\n                <div className=\"space-y-3\">\n                  <FormField\n                    control={form.control}\n                    name=\"recipientCrew\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex items-center space-x-3 space-y-0\">\n                        <FormControl>\n                          <Checkbox\n                            checked={field.value}\n                            onCheckedChange={field.onChange}\n                            data-testid=\"recipient-crew\"\n                          />\n                        </FormControl>\n                        <div className=\"grid gap-1.5 leading-none\">\n                          <FormLabel className=\"text-sm font-medium\">Crew Member</FormLabel>\n                          <p className=\"text-xs text-gray-500\">\n                            Send notifications to the crew member whose document is expiring\n                          </p>\n                        </div>\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"recipientCaptain\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex items-center space-x-3 space-y-0\">\n                        <FormControl>\n                          <Checkbox\n                            checked={field.value}\n                            onCheckedChange={field.onChange}\n                            data-testid=\"recipient-captain\"\n                          />\n                        </FormControl>\n                        <div className=\"grid gap-1.5 leading-none\">\n                          <FormLabel className=\"text-sm font-medium\">Vessel Master</FormLabel>\n                          <p className=\"text-xs text-gray-500\">\n                            Notify the captain of the vessel where the crew member is assigned\n                          </p>\n                        </div>\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"recipientAdmin\"\n                    render={({ field }) => (\n                      <FormItem className=\"flex items-center space-x-3 space-y-0\">\n                        <FormControl>\n                          <Checkbox\n                            checked={field.value}\n                            onCheckedChange={field.onChange}\n                            data-testid=\"recipient-admin\"\n                          />\n                        </FormControl>\n                        <div className=\"grid gap-1.5 leading-none\">\n                          <FormLabel className=\"text-sm font-medium\">Fleet Administrator</FormLabel>\n                          <p className=\"text-xs text-gray-500\">\n                            Send alerts to the head office administration team\n                          </p>\n                        </div>\n                      </FormItem>\n                    )}\n                  />\n                </div>\n              </div>\n\n              {/* Email Template */}\n              <div className=\"space-y-4\">\n                <div>\n                  <h4 className=\"text-base font-medium text-gray-900 mb-3\">Email Template</h4>\n                  <p className=\"text-sm text-gray-500 mb-4\">\n                    Customize the email message template. Use placeholders like [Crew Member], [Document Type], [Expiry Date], etc.\n                  </p>\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"emailTemplate\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormControl>\n                        <Textarea\n                          {...field}\n                          placeholder={defaultTemplate}\n                          className=\"min-h-32\"\n                          data-testid=\"email-template-textarea\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {/* Template Preview */}\n                <div className=\"bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm\">\n                  <h5 className=\"font-medium text-gray-900 mb-2\">Preview</h5>\n                  <div className=\"text-gray-700 whitespace-pre-wrap\">\n                    {form.watch('emailTemplate') || defaultTemplate}\n                  </div>\n                </div>\n              </div>\n            </>\n          )}\n\n          {/* Test Email Section */}\n          {testEmailSent && (\n            <Alert className=\"border-compliance-green bg-green-50\">\n              <Mail className=\"h-4 w-4 compliance-green\" />\n              <AlertDescription className=\"text-green-700\">\n                Test email sent successfully! Check your inbox to verify the email format.\n              </AlertDescription>\n            </Alert>\n          )}\n\n          {/* Form Actions */}\n          <div className=\"flex items-center justify-between pt-6 border-t\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={handleTestEmail}\n              disabled={testEmailMutation.isPending || !form.watch('enabled')}\n              data-testid=\"send-test-email-button\"\n            >\n              <Send className=\"h-4 w-4 mr-2\" />\n              Send Test Email\n            </Button>\n\n            <div className=\"flex space-x-3\">\n              <Button \n                type=\"button\" \n                variant=\"outline\" \n                onClick={onClose}\n                data-testid=\"cancel-settings-button\"\n              >\n                Cancel\n              </Button>\n              <Button \n                type=\"submit\"\n                className=\"bg-maritime-navy hover:bg-blue-800\"\n                disabled={updateSettingsMutation.isPending}\n                data-testid=\"save-settings-button\"\n              >\n                <Settings className=\"h-4 w-4 mr-2\" />\n                Save Settings\n              </Button>\n            </div>\n          </div>\n        </form>\n      </Form>\n    </DialogContent>\n  );\n}\n","path":null,"size_bytes":15482,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/pages/crew-management.tsx":{"content":"import { useState } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport CrewTable from '@/components/crew/crew-table';\nimport AddContractForm from '@/components/crew/add-contract-form';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Users, Download, FileText } from 'lucide-react';\nimport { format } from 'date-fns';\n\nexport default function CrewManagement() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [showAddContractForm, setShowAddContractForm] = useState(false);\n\n  const { data: crewStats } = useQuery({\n    queryKey: ['/api/dashboard/stats'],\n    queryFn: async () => {\n      const response = await fetch('/api/dashboard/stats', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch stats');\n      return response.json();\n    },\n  });\n\n  const { data: crewMembers } = useQuery({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n  });\n\n  const { data: vessels } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  const exportCrewList = () => {\n    try {\n      if (!crewMembers || crewMembers.length === 0) {\n        toast({\n          title: 'No Data',\n          description: 'No crew members found to export',\n          variant: 'destructive',\n        });\n        return;\n      }\n\n      const headers = [\n        'Full Name',\n        'Rank/Position', \n        'Nationality',\n        'Date of Birth',\n        'Employment Status',\n        'Phone Number',\n        'Current Vessel Assignment',\n        'Join Date'\n      ];\n\n      const rows = crewMembers.map((member: any) => {\n        const currentVessel = vessels?.find((v: any) => v.id === member.currentVesselId);\n        \n        // Handle phone number with multiple possible field names and clean formatting\n        let phoneNumber = 'N/A';\n        if (member.phoneNumber) {\n          phoneNumber = String(member.phoneNumber).replace(/^=/, '').trim();\n        } else if (member.phone) {\n          phoneNumber = String(member.phone).replace(/^=/, '').trim();\n        } else if (member.emergencyContact?.phone) {\n          phoneNumber = `Emergency: ${String(member.emergencyContact.phone).replace(/^=/, '').trim()}`;\n        }\n        \n        // Ensure phone numbers don't start with = or + that could be misinterpreted by Excel\n        if (phoneNumber.startsWith('=')) {\n          phoneNumber = phoneNumber.substring(1);\n        }\n        if (phoneNumber.startsWith('+')) {\n          phoneNumber = `'${phoneNumber}`; // Prefix with apostrophe to force text format in Excel\n        }\n        \n        return [\n          `${member.firstName} ${member.lastName}`,\n          member.rank || 'N/A',\n          member.nationality || 'N/A',\n          member.dateOfBirth ? format(new Date(member.dateOfBirth), 'yyyy-MM-dd') : 'N/A',\n          member.status || 'N/A',\n          phoneNumber,\n          currentVessel?.name || 'Unassigned',\n          member.createdAt ? format(new Date(member.createdAt), 'yyyy-MM-dd') : 'N/A'\n        ];\n      });\n\n      // Create CSV with proper formatting\n      const csvRows = [];\n      \n      // Add title row\n      csvRows.push('\"CREW MANAGEMENT EXPORT REPORT\"');\n      csvRows.push(`\"Generated on: ${format(new Date(), 'MMMM dd, yyyy at HH:mm')}\"`);\n      csvRows.push(`\"Total Crew Members: ${crewMembers.length}\"`);\n      csvRows.push(''); // Empty row for spacing\n      \n      // Add headers\n      csvRows.push(headers.map(header => `\"${header}\"`).join(','));\n      \n      // Add data rows with proper formatting\n      rows.forEach(row => {\n        const formattedRow = row.map((cell: any) => {\n          let cellValue = String(cell || '');\n          // Clean any equals signs that might cause Excel formula issues\n          cellValue = cellValue.replace(/^=+/, '');\n          \n          // Add padding for better readability in certain columns\n          if (cellValue === 'N/A') {\n            cellValue = '---';\n          }\n          \n          return `\"${cellValue}\"`;\n        });\n        csvRows.push(formattedRow.join(','));\n      });\n      \n      // Add summary footer\n      csvRows.push(''); // Empty row\n      csvRows.push('\"SUMMARY STATISTICS\"');\n      csvRows.push(`\"Active Crew Members: ${rows.filter(row => row[4] === 'active').length}\"`);\n      csvRows.push(`\"Crew on Leave: ${rows.filter(row => row[4] === 'onLeave').length}\"`);\n      csvRows.push(`\"Assigned to Vessels: ${rows.filter(row => row[6] !== 'Unassigned').length}\"`);\n      \n      const csvContent = csvRows.join('\\n');\n\n      // Add BOM for proper Excel UTF-8 handling\n      const BOM = '\\uFEFF';\n      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      if (link.download !== undefined) {\n        const url = URL.createObjectURL(blob);\n        link.setAttribute('href', url);\n        link.setAttribute('download', `CrewTrack-Pro-Export-${format(new Date(), 'yyyy-MM-dd-HHmm')}.csv`);\n        link.style.visibility = 'hidden';\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n      }\n\n      toast({\n        title: 'Export Successful',\n        description: `Crew list exported with ${crewMembers.length} members`,\n      });\n    } catch (error) {\n      toast({\n        title: 'Export Failed',\n        description: 'Unable to export crew list. Please try again.',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  if (user?.role === 'crew') {\n    // Redirect crew members to their profile view in dashboard\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"text-center py-12\">\n          <Users className=\"h-16 w-16 mx-auto text-gray-300 mb-4\" />\n          <h2 className=\"text-2xl font-semibold text-foreground mb-2\">Access Restricted</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            Crew members can view their profile information on the dashboard.\n          </p>\n          <Button\n            onClick={() => window.location.href = '/dashboard'}\n            className=\"bg-maritime-navy hover:bg-blue-800\"\n          >\n            Go to Dashboard\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4 sm:space-y-6\">\n      {/* Header */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0\">\n        <div>\n          <h2 className=\"text-2xl sm:text-3xl font-bold text-foreground mb-2\" data-testid=\"crew-management-title\">\n            Crew Management\n          </h2>\n          <p className=\"text-sm sm:text-base text-muted-foreground\">\n            Manage crew members, assignments, and profiles\n          </p>\n        </div>\n        \n        <div className=\"flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3\">\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            onClick={exportCrewList}\n            disabled={!crewMembers || crewMembers.length === 0}\n            data-testid=\"export-crew-list\"\n            className=\"w-full sm:w-auto flex items-center justify-center\"\n          >\n            <Download className=\"h-4 w-4 mr-2\" />\n            <span className=\"hidden sm:inline\">Export List</span>\n            <span className=\"sm:hidden\">Export</span>\n          </Button>\n          \n          <Button \n            variant=\"outline\"\n            className=\"bg-purple-50 hover:bg-purple-100 text-purple-700 border-purple-300 dark:bg-purple-950 dark:hover:bg-purple-900 dark:text-purple-300 dark:border-purple-700 w-full sm:w-auto flex items-center justify-center\" \n            onClick={() => setShowAddContractForm(true)}\n            data-testid=\"add-contract\"\n          >\n            <FileText className=\"h-4 w-4 mr-2\" />\n            <span className=\"hidden sm:inline\">Add Contract</span>\n            <span className=\"sm:hidden\">Contract</span>\n          </Button>\n        </div>\n      </div>\n\n      {/* Quick Stats */}\n      {crewStats && (\n        <div className=\"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4\">\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Crew on Shore</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex items-center space-x-2\">\n                <Users className=\"h-5 w-5 text-green-500\" />\n                <span className=\"text-2xl font-bold text-foreground\" data-testid=\"crew-on-shore-count\">\n                  {crewStats.crewOnShore}\n                </span>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Crew on Board</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex items-center space-x-2\">\n                <Users className=\"h-5 w-5 text-blue-500\" />\n                <span className=\"text-2xl font-bold text-foreground\" data-testid=\"crew-on-board-count\">\n                  {crewStats.activeCrew}\n                </span>\n              </div>\n            </CardContent>\n          </Card>\n          \n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm font-medium text-muted-foreground\">Pending Actions</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex items-center space-x-2\">\n                <div className=\"w-2 h-2 bg-orange-500 rounded-full\"></div>\n                <span className=\"text-2xl font-bold text-foreground\" data-testid=\"pending-actions-count\">\n                  {crewStats.pendingActions}\n                </span>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Crew Table */}\n      <Card className=\"flex-1\">\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-foreground\">Crew Members</CardTitle>\n        </CardHeader>\n        <CardContent className=\"p-0\">\n          <CrewTable />\n        </CardContent>\n      </Card>\n\n      {/* Add Contract Form Dialog */}\n      <AddContractForm \n        open={showAddContractForm} \n        onOpenChange={setShowAddContractForm} \n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":10927,"size_tokens":null},"client/src/types/index.ts":{"content":"export interface DashboardStats {\n  activeCrew: number;\n  activeVessels: number;\n  pendingActions: number;\n  crewOnShore: number;\n  complianceRate: number;\n  totalContracts: number;\n  totalDocuments: number;\n}\n\nexport interface UpcomingEvent {\n  id: string;\n  type: 'contract_renewal' | 'crew_change' | 'training' | 'document_expiry';\n  title: string;\n  description: string;\n  date: Date;\n  severity: 'low' | 'medium' | 'high';\n  crewMemberId?: string;\n  vesselId?: string;\n}\n\nexport interface CalendarEvent {\n  id: string;\n  title: string;\n  date: Date;\n  type: 'join' | 'leave' | 'training' | 'other';\n  crewMemberId: string;\n  vesselId: string;\n  description?: string;\n}\n\nexport interface FileUploadResult {\n  success: boolean;\n  filePath?: string;\n  error?: string;\n}\n","path":null,"size_bytes":772,"size_tokens":null},"server/services/smtp-email-service.ts":{"content":"import nodemailer from 'nodemailer';\n\n// Gmail SMTP Email Service using App Password\nexport class SMTPEmailService {\n  private transporter: nodemailer.Transporter;\n  private isConfigured: boolean = false;\n\n  constructor() {\n    const gmailUser = process.env.GMAIL_USER;\n    const gmailAppPassword = process.env.GMAIL_APP_PASSWORD;\n\n    if (gmailUser && gmailAppPassword) {\n      // Use Gmail SMTP with App Password\n      this.transporter = nodemailer.createTransport({\n        service: 'gmail',\n        auth: {\n          user: gmailUser,\n          pass: gmailAppPassword,\n        },\n      });\n      this.isConfigured = true;\n      console.log('‚úÖ Gmail SMTP configured successfully with:', gmailUser);\n    } else {\n      // Fallback to ethereal for testing if Gmail not configured\n      console.log('‚ö†Ô∏è Gmail credentials not found, using test transport');\n      this.transporter = nodemailer.createTransport({\n        host: 'smtp.ethereal.email',\n        port: 587,\n        secure: false,\n        auth: {\n          user: 'ethereal.user@ethereal.email',\n          pass: 'ethereal.pass',\n        },\n      });\n    }\n  }\n\n  isReady(): boolean {\n    return this.isConfigured;\n  }\n\n  async sendEmail(emailData: {\n    to: string;\n    subject: string;\n    html: string;\n    text?: string;\n  }): Promise<{ success: boolean; error?: string }> {\n    try {\n      console.log(`üìß Sending email to: ${emailData.to}`);\n      console.log(`üìß Subject: ${emailData.subject}`);\n      console.log(`üìß Gmail configured: ${this.isConfigured}`);\n      \n      const fromEmail = process.env.GMAIL_USER || 'admin@offing.biz';\n      const info = await this.transporter.sendMail({\n        from: `\"Crew Management System\" <${fromEmail}>`,\n        to: emailData.to,\n        subject: emailData.subject,\n        html: emailData.html,\n        text: emailData.text || emailData.html.replace(/<[^>]*>/g, '') // Strip HTML for text version\n      });\n      \n      console.log('‚úÖ Email sent successfully:', info.messageId);\n      if (nodemailer.getTestMessageUrl(info)) {\n        console.log('üîó View email online:', nodemailer.getTestMessageUrl(info));\n      }\n      console.log('üìß Email Details:');\n      console.log('Subject:', emailData.subject);\n      console.log('To:', emailData.to);\n      console.log('‚úâÔ∏è REAL EMAIL SENT - Check your email or the online link above!');\n      \n      return { success: true };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      console.error('‚ùå Failed to send email:', errorMessage);\n      console.error('Full error:', error);\n      return { success: false, error: errorMessage };\n    }\n  }\n\n  async sendEmailWithAttachment(emailData: {\n    to: string;\n    subject: string;\n    html: string;\n    text?: string;\n    attachments?: Array<{\n      filename: string;\n      content: Buffer;\n      contentType?: string;\n    }>;\n  }): Promise<{ success: boolean; error?: string }> {\n    try {\n      console.log(`üìß Sending email with attachment to: ${emailData.to}`);\n      console.log(`üìß Subject: ${emailData.subject}`);\n      console.log(`üìß Attachments: ${emailData.attachments?.length || 0}`);\n      console.log(`üìß Gmail configured: ${this.isConfigured}`);\n      \n      const fromEmail = process.env.GMAIL_USER || 'admin@offing.biz';\n      const info = await this.transporter.sendMail({\n        from: `\"Crew Management System\" <${fromEmail}>`,\n        to: emailData.to,\n        subject: emailData.subject,\n        html: emailData.html,\n        text: emailData.text || emailData.html.replace(/<[^>]*>/g, ''),\n        attachments: emailData.attachments?.map(att => ({\n          filename: att.filename,\n          content: att.content,\n          contentType: att.contentType || 'application/pdf',\n        })),\n      });\n      \n      console.log('‚úÖ Email with attachment sent successfully:', info.messageId);\n      if (nodemailer.getTestMessageUrl(info)) {\n        console.log('üîó View email online:', nodemailer.getTestMessageUrl(info));\n      }\n      console.log('üìß Email Details:');\n      console.log('Subject:', emailData.subject);\n      console.log('To:', emailData.to);\n      console.log('Attachments:', emailData.attachments?.map(a => a.filename).join(', '));\n      console.log('‚úâÔ∏è REAL EMAIL WITH ATTACHMENT SENT!');\n      \n      return { success: true };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      console.error('‚ùå Failed to send email with attachment:', errorMessage);\n      console.error('Full error:', error);\n      return { success: false, error: errorMessage };\n    }\n  }\n\n  async sendTestEmail(recipientEmail: string): Promise<{ success: boolean; error?: string }> {\n    const testEmailHtml = `\n      <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n        <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n          <div style=\"text-align: center; margin-bottom: 30px;\">\n            <h1 style=\"color: #28a745; margin: 0; font-size: 24px;\">‚úÖ Email System Working!</h1>\n            <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Crew Management System</p>\n          </div>\n          \n          <div style=\"background: #e8f5e8; border-left: 4px solid #28a745; padding: 20px; margin: 20px 0;\">\n            <h3 style=\"margin: 0 0 15px 0; color: #155724;\">üìß Email Notifications Ready</h3>\n            <p style=\"margin: 0; color: #155724;\">\n              Your crew management system is now successfully sending emails for:\n            </p>\n            <ul style=\"margin: 10px 0 0 20px; color: #155724;\">\n              <li>Contract renewals and expirations</li>\n              <li>Document expiry reminders</li>\n              <li>Crew rotation schedules</li>\n              <li>System alerts and notifications</li>\n            </ul>\n          </div>\n          \n          <div style=\"background: #f8f9fa; padding: 20px; border-radius: 6px; margin: 20px 0;\">\n            <h3 style=\"margin: 0 0 10px 0; color: #495057;\">üìã System Status</h3>\n            <p style=\"margin: 0; color: #6c757d; font-size: 14px;\">\n              ‚úÖ Email service: <strong>Active</strong><br>\n              ‚úÖ Recipient: <strong>${recipientEmail}</strong><br>\n              ‚úÖ Templates: <strong>Professional HTML + Text</strong><br>\n              ‚úÖ Scheduler: <strong>Running every hour</strong>\n            </p>\n          </div>\n          \n          <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;\">\n            <p style=\"color: #6c757d; font-size: 14px; margin: 0;\">\n              Test sent at: ${new Date().toLocaleString()}\n            </p>\n            <p style=\"color: #6c757d; font-size: 12px; margin: 5px 0 0 0;\">\n              Crew Management Pro - Email Notification System\n            </p>\n          </div>\n        </div>\n      </div>\n    `;\n\n    return await this.sendEmail({\n      to: recipientEmail,\n      subject: '‚úÖ Email Test Successful - Crew Management System',\n      html: testEmailHtml\n    });\n  }\n\n  async sendUpcomingEventsEmail(recipientEmail: string, events: any[]): Promise<{ success: boolean; error?: string }> {\n    const severityColors: Record<string, string> = {\n      critical: '#dc2626',\n      high: '#ea580c', \n      medium: '#d97706',\n      low: '#059669'\n    };\n\n    const severityBg: Record<string, string> = {\n      critical: '#fef2f2',\n      high: '#fff7ed',\n      medium: '#fffbeb', \n      low: '#f0fdf4'\n    };\n\n    const upcomingEventsHtml = `\n      <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n        <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n          <div style=\"text-align: center; margin-bottom: 30px;\">\n            <h1 style=\"color: #1f2937; margin: 0; font-size: 24px;\">üìã Upcoming Events Report</h1>\n            <p style=\"color: #6b7280; margin: 10px 0 0 0;\">Crew Management System - Next 30 Days</p>\n          </div>\n          \n          <div style=\"margin-bottom: 20px;\">\n            <h2 style=\"color: #1f2937; font-size: 18px; margin-bottom: 15px;\">Summary</h2>\n            <p style=\"color: #374151; line-height: 1.5;\">\n              This report contains ${events.length} upcoming events requiring attention:\n            </p>\n            <ul style=\"color: #374151; margin: 10px 0;\">\n              <li>${events.filter(e => e.type === 'contract_expiry').length} Contract Expiries</li>\n              <li>${events.filter(e => e.type === 'document_expiry').length} Document Expiries</li>\n              <li>${events.filter(e => e.type === 'crew_rotation').length} Crew Rotations</li>\n            </ul>\n          </div>\n\n          ${events.map((event, index) => {\n            let title, description, icon;\n            if (event.type === 'contract_expiry') {\n              title = `Contract Expiry - ${event.crewMemberName}`;\n              description = `Contract on vessel ${event.vesselName} expires on ${event.date.toDateString()}`;\n              icon = 'üìã';\n            } else if (event.type === 'document_expiry') {\n              title = `Document Expiry - ${event.crewMemberName}`;\n              description = `${event.documentType} expires on ${event.date.toDateString()}`;\n              icon = 'üìÑ';\n            } else if (event.type === 'crew_rotation') {\n              title = `Crew Rotation - ${event.crewMemberName}`;\n              description = `Scheduled to ${event.rotationType} vessel ${event.vesselName} on ${event.date.toDateString()}`;\n              icon = 'üîÑ';\n            }\n\n            return `\n              <div style=\"background: ${severityBg[event.severity]}; padding: 20px; margin: 15px 0; border-radius: 6px; border-left: 4px solid ${severityColors[event.severity]};\">\n                <div style=\"display: flex; align-items: center; margin-bottom: 10px;\">\n                  <span style=\"font-size: 20px; margin-right: 10px;\">${icon}</span>\n                  <h3 style=\"color: #1f2937; margin: 0; font-size: 16px;\">${title}</h3>\n                  <span style=\"margin-left: auto; background: ${severityColors[event.severity]}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; text-transform: uppercase; font-weight: bold;\">${event.severity}</span>\n                </div>\n                <p style=\"color: #374151; margin: 0; line-height: 1.5;\">${description}</p>\n                <div style=\"margin-top: 10px; font-size: 14px; color: #6b7280;\">\n                  <strong>Days remaining:</strong> ${Math.ceil((event.date.getTime() - Date.now()) / (1000 * 60 * 60 * 24))} days\n                </div>\n              </div>\n            `;\n          }).join('')}\n\n          <div style=\"margin-top: 30px; padding: 20px; background: #f3f4f6; border-radius: 6px;\">\n            <h3 style=\"color: #1f2937; margin: 0 0 10px 0; font-size: 16px;\">üìß Notification Settings</h3>\n            <p style=\"color: #6b7280; margin: 0; font-size: 14px;\">\n              This email was sent to: <strong>${recipientEmail}</strong><br>\n              Generated on: ${new Date().toLocaleString()}<br>\n              System: Crew Management Pro\n            </p>\n          </div>\n          \n          <div style=\"text-align: center; margin-top: 30px; padding: 20px 0; border-top: 1px solid #e5e7eb;\">\n            <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n              This is an automated notification from the Crew Management System<br>\n              Please contact your system administrator if you have any questions\n            </p>\n          </div>\n        </div>\n      </div>\n    `;\n\n    return await this.sendEmail({\n      to: recipientEmail,\n      subject: 'üìã Upcoming Events Report - Crew Management System',\n      html: upcomingEventsHtml\n    });\n  }\n\n  async sendNotificationEmail(\n    recipientEmail: string, \n    title: string, \n    description: string, \n    type: string\n  ): Promise<{ success: boolean; error?: string }> {\n    const typeIcons: Record<string, string> = {\n      contract_expiry: 'üìã',\n      document_expiry: 'üìÑ',\n      crew_rotation: 'üîÑ'\n    };\n\n    const notificationHtml = `\n      <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n        <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n          <div style=\"text-align: center; margin-bottom: 30px;\">\n            <h1 style=\"color: #dc2626; margin: 0; font-size: 24px;\">${typeIcons[type] || 'üîî'} ${title}</h1>\n            <p style=\"color: #6b7280; margin: 10px 0 0 0;\">Crew Management System Alert</p>\n          </div>\n          \n          <div style=\"background: #fef2f2; border-left: 4px solid #dc2626; padding: 20px; margin: 20px 0;\">\n            <p style=\"color: #374151; margin: 0; line-height: 1.5; font-size: 16px;\">\n              ${description}\n            </p>\n          </div>\n          \n          <div style=\"background: #f3f4f6; padding: 20px; border-radius: 6px; margin: 20px 0;\">\n            <h3 style=\"margin: 0 0 10px 0; color: #1f2937;\">üìß Alert Details</h3>\n            <p style=\"margin: 0; color: #6b7280; font-size: 14px;\">\n              Alert Type: <strong>${type.replace('_', ' ')}</strong><br>\n              Sent to: <strong>${recipientEmail}</strong><br>\n              Time: <strong>${new Date().toLocaleString()}</strong>\n            </p>\n          </div>\n          \n          <div style=\"text-align: center; margin-top: 30px; padding: 20px 0; border-top: 1px solid #e5e7eb;\">\n            <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n              This is an automated alert from the Crew Management System<br>\n              Please take appropriate action as required\n            </p>\n          </div>\n        </div>\n      </div>\n    `;\n\n    return await this.sendEmail({\n      to: recipientEmail,\n      subject: `üö® ${title} - Crew Management Alert`,\n      html: notificationHtml\n    });\n  }\n}\n\nexport const smtpEmailService = new SMTPEmailService();\n\n// Export functions for backward compatibility\nexport const sendEmail = (emailData: any) => smtpEmailService.sendEmail(emailData);\nexport const sendTestEmail = (recipientEmail: string) => smtpEmailService.sendTestEmail(recipientEmail);\nexport const sendNotificationEmail = (recipientEmail: string, title: string, description: string, type: string) => \n  smtpEmailService.sendNotificationEmail(recipientEmail, title, description, type);\n\n// CDC Document Expiry Alert Email Template\nexport interface CDCExpiryAlertData {\n  crewMemberName: string;\n  crewMemberRank?: string;\n  crewMemberNationality?: string;\n  vesselName?: string;\n  cdcNumber: string;\n  issuingAuthority: string;\n  expiryDate: Date;\n  daysUntilExpiry: number;\n}\n\nexport function generateCDCExpiryEmail(data: CDCExpiryAlertData): { subject: string; html: string; text: string } {\n  const urgencyLevel = data.daysUntilExpiry <= 10 ? 'critical' : \n                       data.daysUntilExpiry <= 30 ? 'high' :\n                       data.daysUntilExpiry <= 45 ? 'medium' : 'low';\n  \n  const urgencyColors = {\n    critical: { bg: '#fef2f2', border: '#dc2626', text: '#991b1b', badge: '#dc2626' },\n    high: { bg: '#fff7ed', border: '#ea580c', text: '#9a3412', badge: '#ea580c' },\n    medium: { bg: '#fffbeb', border: '#d97706', text: '#92400e', badge: '#d97706' },\n    low: { bg: '#f0fdf4', border: '#22c55e', text: '#166534', badge: '#22c55e' }\n  };\n  \n  const colors = urgencyColors[urgencyLevel];\n  const urgencyText = urgencyLevel === 'critical' ? 'URGENT' : \n                      urgencyLevel === 'high' ? 'HIGH PRIORITY' :\n                      urgencyLevel === 'medium' ? 'ATTENTION NEEDED' : 'REMINDER';\n\n  const formattedExpiryDate = data.expiryDate.toLocaleDateString('en-US', {\n    weekday: 'long',\n    year: 'numeric',\n    month: 'long',\n    day: 'numeric'\n  });\n\n  const subject = urgencyLevel === 'critical' \n    ? `üö® URGENT: CDC Expiring in ${data.daysUntilExpiry} days - ${data.crewMemberName}`\n    : `üìã CDC Expiry Alert (${data.daysUntilExpiry} days) - ${data.crewMemberName}`;\n\n  const html = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    </head>\n    <body style=\"margin: 0; padding: 0; background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <!-- Header -->\n        <div style=\"background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%); padding: 30px; border-radius: 12px 12px 0 0; text-align: center;\">\n          <h1 style=\"color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;\">\n            üö¢ Crew Management System\n          </h1>\n          <p style=\"color: #93c5fd; margin: 10px 0 0 0; font-size: 14px;\">\n            Document Expiry Notification\n          </p>\n        </div>\n        \n        <!-- Main Content -->\n        <div style=\"background: #ffffff; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n          \n          <!-- Urgency Banner -->\n          <div style=\"background: ${colors.bg}; border: 2px solid ${colors.border}; border-radius: 8px; padding: 20px; margin-bottom: 25px; text-align: center;\">\n            <span style=\"background: ${colors.badge}; color: #ffffff; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; letter-spacing: 1px;\">\n              ${urgencyText}\n            </span>\n            <h2 style=\"color: ${colors.text}; margin: 15px 0 5px 0; font-size: 28px; font-weight: bold;\">\n              ${data.daysUntilExpiry} Days Until Expiry\n            </h2>\n            <p style=\"color: ${colors.text}; margin: 0; font-size: 14px;\">\n              Continuous Discharge Certificate (CDC)\n            </p>\n          </div>\n\n          <!-- Crew Member Info Card -->\n          <div style=\"background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 25px;\">\n            <h3 style=\"color: #1e293b; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;\">\n              <span style=\"margin-right: 8px;\">üë§</span> Crew Member Details\n            </h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr>\n                <td style=\"padding: 8px 0; color: #64748b; font-size: 14px; width: 40%;\">Name:</td>\n                <td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberName}</td>\n              </tr>\n              ${data.crewMemberRank ? `\n              <tr>\n                <td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Rank:</td>\n                <td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberRank}</td>\n              </tr>\n              ` : ''}\n              ${data.crewMemberNationality ? `\n              <tr>\n                <td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Nationality:</td>\n                <td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberNationality}</td>\n              </tr>\n              ` : ''}\n              ${data.vesselName ? `\n              <tr>\n                <td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Current Vessel:</td>\n                <td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.vesselName}</td>\n              </tr>\n              ` : ''}\n            </table>\n          </div>\n\n          <!-- CDC Document Info Card -->\n          <div style=\"background: #fef3c7; border-radius: 8px; padding: 20px; margin-bottom: 25px; border-left: 4px solid #f59e0b;\">\n            <h3 style=\"color: #92400e; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;\">\n              <span style=\"margin-right: 8px;\">üìÑ</span> CDC Document Information\n            </h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr>\n                <td style=\"padding: 8px 0; color: #78350f; font-size: 14px; width: 40%;\">CDC Number:</td>\n                <td style=\"padding: 8px 0; color: #78350f; font-size: 14px; font-weight: 600;\">${data.cdcNumber}</td>\n              </tr>\n              <tr>\n                <td style=\"padding: 8px 0; color: #78350f; font-size: 14px;\">Issuing Authority:</td>\n                <td style=\"padding: 8px 0; color: #78350f; font-size: 14px; font-weight: 600;\">${data.issuingAuthority}</td>\n              </tr>\n              <tr>\n                <td style=\"padding: 8px 0; color: #78350f; font-size: 14px;\">Expiry Date:</td>\n                <td style=\"padding: 8px 0; color: #dc2626; font-size: 14px; font-weight: bold;\">${formattedExpiryDate}</td>\n              </tr>\n            </table>\n          </div>\n\n          <!-- Action Required Section -->\n          <div style=\"background: #eff6ff; border-radius: 8px; padding: 20px; margin-bottom: 25px;\">\n            <h3 style=\"color: #1e40af; margin: 0 0 15px 0; font-size: 16px;\">\n              ‚ö° Recommended Actions\n            </h3>\n            <ul style=\"margin: 0; padding-left: 20px; color: #1e40af;\">\n              <li style=\"margin-bottom: 10px;\">Contact the crew member to initiate CDC renewal process</li>\n              <li style=\"margin-bottom: 10px;\">Verify current vessel assignment and schedule</li>\n              <li style=\"margin-bottom: 10px;\">Prepare required documentation for renewal application</li>\n              <li style=\"margin-bottom: 0;\">Update crew records once renewal is completed</li>\n            </ul>\n          </div>\n\n          <!-- Alert Schedule Info -->\n          <div style=\"background: #f1f5f9; border-radius: 8px; padding: 15px; text-align: center;\">\n            <p style=\"margin: 0; color: #64748b; font-size: 12px;\">\n              üìÖ <strong>Alert Schedule:</strong> Notifications are sent at 60, 45, 30, and 10 days before expiry\n            </p>\n          </div>\n        </div>\n        \n        <!-- Footer -->\n        <div style=\"text-align: center; padding: 20px;\">\n          <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n            This is an automated notification from the Crew Management System<br>\n            Sent to: admin@offing.biz | ${new Date().toLocaleDateString()}\n          </p>\n        </div>\n      </div>\n    </body>\n    </html>\n  `;\n\n  const text = `\nCDC DOCUMENT EXPIRY ALERT - ${urgencyText}\n\n${data.daysUntilExpiry} Days Until Expiry\n\nCREW MEMBER DETAILS:\n- Name: ${data.crewMemberName}\n${data.crewMemberRank ? `- Rank: ${data.crewMemberRank}` : ''}\n${data.crewMemberNationality ? `- Nationality: ${data.crewMemberNationality}` : ''}\n${data.vesselName ? `- Current Vessel: ${data.vesselName}` : ''}\n\nCDC DOCUMENT INFORMATION:\n- CDC Number: ${data.cdcNumber}\n- Issuing Authority: ${data.issuingAuthority}\n- Expiry Date: ${formattedExpiryDate}\n\nRECOMMENDED ACTIONS:\n1. Contact the crew member to initiate CDC renewal process\n2. Verify current vessel assignment and schedule\n3. Prepare required documentation for renewal application\n4. Update crew records once renewal is completed\n\nAlert Schedule: Notifications are sent at 60, 45, 30, and 10 days before expiry\n\n---\nThis is an automated notification from the Crew Management System\n  `;\n\n  return { subject, html, text };\n}\n\nexport async function sendCDCExpiryAlert(recipientEmail: string, data: CDCExpiryAlertData): Promise<{ success: boolean; error?: string }> {\n  const emailContent = generateCDCExpiryEmail(data);\n  return smtpEmailService.sendEmail({\n    to: recipientEmail,\n    subject: emailContent.subject,\n    html: emailContent.html,\n    text: emailContent.text\n  });\n}\n\n// Passport Document Expiry Alert Email Template\nexport interface PassportExpiryAlertData {\n  crewMemberName: string;\n  crewMemberRank?: string;\n  crewMemberNationality?: string;\n  vesselName?: string;\n  passportNumber: string;\n  issuingAuthority: string;\n  expiryDate: Date;\n  daysUntilExpiry: number;\n}\n\nexport function generatePassportExpiryEmail(data: PassportExpiryAlertData): { subject: string; html: string; text: string } {\n  const urgencyLevel = data.daysUntilExpiry <= 10 ? 'critical' : \n                       data.daysUntilExpiry <= 30 ? 'high' :\n                       data.daysUntilExpiry <= 45 ? 'medium' : 'low';\n  \n  const urgencyColors = {\n    critical: { bg: '#fef2f2', border: '#dc2626', text: '#991b1b', badge: '#dc2626' },\n    high: { bg: '#fff7ed', border: '#ea580c', text: '#9a3412', badge: '#ea580c' },\n    medium: { bg: '#fffbeb', border: '#d97706', text: '#92400e', badge: '#d97706' },\n    low: { bg: '#f0fdf4', border: '#22c55e', text: '#166534', badge: '#22c55e' }\n  };\n  \n  const colors = urgencyColors[urgencyLevel];\n  const urgencyText = urgencyLevel === 'critical' ? 'URGENT' : \n                      urgencyLevel === 'high' ? 'HIGH PRIORITY' :\n                      urgencyLevel === 'medium' ? 'ATTENTION NEEDED' : 'REMINDER';\n\n  const formattedExpiryDate = data.expiryDate.toLocaleDateString('en-US', {\n    weekday: 'long',\n    year: 'numeric',\n    month: 'long',\n    day: 'numeric'\n  });\n\n  const subject = urgencyLevel === 'critical' \n    ? `üö® URGENT: Passport Expiring in ${data.daysUntilExpiry} days - ${data.crewMemberName}`\n    : `üõÇ Passport Expiry Alert (${data.daysUntilExpiry} days) - ${data.crewMemberName}`;\n\n  const html = `\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <meta charset=\"utf-8\">\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    </head>\n    <body style=\"margin: 0; padding: 0; background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <!-- Header -->\n        <div style=\"background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%); padding: 30px; border-radius: 12px 12px 0 0; text-align: center;\">\n          <h1 style=\"color: #ffffff; margin: 0; font-size: 24px; font-weight: 600;\">\n            üö¢ Crew Management System\n          </h1>\n          <p style=\"color: #93c5fd; margin: 10px 0 0 0; font-size: 14px;\">\n            Passport Expiry Notification\n          </p>\n        </div>\n        \n        <!-- Main Content -->\n        <div style=\"background: #ffffff; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n          \n          <!-- Urgency Banner -->\n          <div style=\"background: ${colors.bg}; border: 2px solid ${colors.border}; border-radius: 8px; padding: 20px; margin-bottom: 25px; text-align: center;\">\n            <span style=\"background: ${colors.badge}; color: #ffffff; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; letter-spacing: 1px;\">\n              ${urgencyText}\n            </span>\n            <h2 style=\"color: ${colors.text}; margin: 15px 0 5px 0; font-size: 28px; font-weight: bold;\">\n              ${data.daysUntilExpiry} Days Until Expiry\n            </h2>\n            <p style=\"color: ${colors.text}; margin: 0; font-size: 14px;\">\n              Passport Document\n            </p>\n          </div>\n\n          <!-- Crew Member Info Card -->\n          <div style=\"background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 25px;\">\n            <h3 style=\"color: #1e293b; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;\">\n              <span style=\"margin-right: 8px;\">üë§</span> Crew Member Details\n            </h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr>\n                <td style=\"padding: 8px 0; color: #64748b; font-size: 14px; width: 40%;\">Name:</td>\n                <td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberName}</td>\n              </tr>\n              ${data.crewMemberRank ? `\n              <tr>\n                <td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Rank:</td>\n                <td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberRank}</td>\n              </tr>\n              ` : ''}\n              ${data.crewMemberNationality ? `\n              <tr>\n                <td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Nationality:</td>\n                <td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberNationality}</td>\n              </tr>\n              ` : ''}\n              ${data.vesselName ? `\n              <tr>\n                <td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Current Vessel:</td>\n                <td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.vesselName}</td>\n              </tr>\n              ` : ''}\n            </table>\n          </div>\n\n          <!-- Passport Document Info Card -->\n          <div style=\"background: #dbeafe; border-radius: 8px; padding: 20px; margin-bottom: 25px; border-left: 4px solid #2563eb;\">\n            <h3 style=\"color: #1e40af; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;\">\n              <span style=\"margin-right: 8px;\">üõÇ</span> Passport Information\n            </h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr>\n                <td style=\"padding: 8px 0; color: #1e40af; font-size: 14px; width: 40%;\">Passport Number:</td>\n                <td style=\"padding: 8px 0; color: #1e40af; font-size: 14px; font-weight: 600;\">${data.passportNumber}</td>\n              </tr>\n              <tr>\n                <td style=\"padding: 8px 0; color: #1e40af; font-size: 14px;\">Issuing Country:</td>\n                <td style=\"padding: 8px 0; color: #1e40af; font-size: 14px; font-weight: 600;\">${data.issuingAuthority}</td>\n              </tr>\n              <tr>\n                <td style=\"padding: 8px 0; color: #1e40af; font-size: 14px;\">Expiry Date:</td>\n                <td style=\"padding: 8px 0; color: #dc2626; font-size: 14px; font-weight: bold;\">${formattedExpiryDate}</td>\n              </tr>\n            </table>\n          </div>\n\n          <!-- Action Required Section -->\n          <div style=\"background: #fef3c7; border-radius: 8px; padding: 20px; margin-bottom: 25px;\">\n            <h3 style=\"color: #92400e; margin: 0 0 15px 0; font-size: 16px;\">\n              ‚ö° Recommended Actions\n            </h3>\n            <ul style=\"margin: 0; padding-left: 20px; color: #92400e;\">\n              <li style=\"margin-bottom: 10px;\">Contact the crew member to initiate passport renewal process</li>\n              <li style=\"margin-bottom: 10px;\">Verify current vessel assignment and travel schedule</li>\n              <li style=\"margin-bottom: 10px;\">Ensure visa requirements are reviewed for new passport</li>\n              <li style=\"margin-bottom: 0;\">Update crew records once renewal is completed</li>\n            </ul>\n          </div>\n\n          <!-- Alert Schedule Info -->\n          <div style=\"background: #f1f5f9; border-radius: 8px; padding: 15px; text-align: center;\">\n            <p style=\"margin: 0; color: #64748b; font-size: 12px;\">\n              üìÖ <strong>Alert Schedule:</strong> Notifications are sent at 60, 45, 30, and 10 days before expiry\n            </p>\n          </div>\n        </div>\n        \n        <!-- Footer -->\n        <div style=\"text-align: center; padding: 20px;\">\n          <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n            This is an automated notification from the Crew Management System<br>\n            Sent to: admin@offing.biz | ${new Date().toLocaleDateString()}\n          </p>\n        </div>\n      </div>\n    </body>\n    </html>\n  `;\n\n  const text = `\nPASSPORT EXPIRY ALERT - ${urgencyText}\n\n${data.daysUntilExpiry} Days Until Expiry\n\nCREW MEMBER DETAILS:\n- Name: ${data.crewMemberName}\n${data.crewMemberRank ? `- Rank: ${data.crewMemberRank}` : ''}\n${data.crewMemberNationality ? `- Nationality: ${data.crewMemberNationality}` : ''}\n${data.vesselName ? `- Current Vessel: ${data.vesselName}` : ''}\n\nPASSPORT INFORMATION:\n- Passport Number: ${data.passportNumber}\n- Issuing Country: ${data.issuingAuthority}\n- Expiry Date: ${formattedExpiryDate}\n\nRECOMMENDED ACTIONS:\n1. Contact the crew member to initiate passport renewal process\n2. Verify current vessel assignment and travel schedule\n3. Ensure visa requirements are reviewed for new passport\n4. Update crew records once renewal is completed\n\nAlert Schedule: Notifications are sent at 60, 45, 30, and 10 days before expiry\n\n---\nThis is an automated notification from the Crew Management System\n  `;\n\n  return { subject, html, text };\n}\n\nexport async function sendPassportExpiryAlert(recipientEmail: string, data: PassportExpiryAlertData): Promise<{ success: boolean; error?: string }> {\n  const emailContent = generatePassportExpiryEmail(data);\n  return smtpEmailService.sendEmail({\n    to: recipientEmail,\n    subject: emailContent.subject,\n    html: emailContent.html,\n    text: emailContent.text\n  });\n}\n\n// COC (Certificate of Competency) Document Expiry Alert Email Template\nexport interface COCExpiryAlertData {\n  crewMemberName: string;\n  crewMemberRank?: string;\n  crewMemberNationality?: string;\n  vesselName?: string;\n  cocNumber: string;\n  issuingAuthority: string;\n  expiryDate: Date;\n  daysUntilExpiry: number;\n}\n\nexport function generateCOCExpiryEmail(data: COCExpiryAlertData): { subject: string; html: string; text: string } {\n  const urgencyLevel = data.daysUntilExpiry <= 10 ? 'critical' : \n                       data.daysUntilExpiry <= 30 ? 'high' :\n                       data.daysUntilExpiry <= 45 ? 'medium' : 'low';\n  \n  const urgencyColors = {\n    critical: { bg: '#fef2f2', border: '#dc2626', text: '#991b1b', badge: '#dc2626' },\n    high: { bg: '#fff7ed', border: '#ea580c', text: '#9a3412', badge: '#ea580c' },\n    medium: { bg: '#fffbeb', border: '#d97706', text: '#92400e', badge: '#d97706' },\n    low: { bg: '#f0fdf4', border: '#22c55e', text: '#166534', badge: '#22c55e' }\n  };\n  \n  const colors = urgencyColors[urgencyLevel];\n  const urgencyText = urgencyLevel === 'critical' ? 'URGENT' : \n                      urgencyLevel === 'high' ? 'HIGH PRIORITY' :\n                      urgencyLevel === 'medium' ? 'ATTENTION NEEDED' : 'REMINDER';\n\n  const formattedExpiryDate = data.expiryDate.toLocaleDateString('en-US', {\n    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'\n  });\n\n  const subject = urgencyLevel === 'critical' \n    ? `üö® URGENT: COC Expiring in ${data.daysUntilExpiry} days - ${data.crewMemberName}`\n    : `üìú COC Expiry Alert (${data.daysUntilExpiry} days) - ${data.crewMemberName}`;\n\n  const html = `\n    <!DOCTYPE html>\n    <html>\n    <head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"></head>\n    <body style=\"margin: 0; padding: 0; background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <div style=\"background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%); padding: 30px; border-radius: 12px 12px 0 0; text-align: center;\">\n          <h1 style=\"color: #ffffff; margin: 0; font-size: 24px;\">üö¢ Crew Management System</h1>\n          <p style=\"color: #93c5fd; margin: 10px 0 0 0; font-size: 14px;\">Certificate of Competency Expiry Notification</p>\n        </div>\n        <div style=\"background: #ffffff; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n          <div style=\"background: ${colors.bg}; border: 2px solid ${colors.border}; border-radius: 8px; padding: 20px; margin-bottom: 25px; text-align: center;\">\n            <span style=\"background: ${colors.badge}; color: #ffffff; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: bold;\">${urgencyText}</span>\n            <h2 style=\"color: ${colors.text}; margin: 15px 0 5px 0; font-size: 28px; font-weight: bold;\">${data.daysUntilExpiry} Days Until Expiry</h2>\n            <p style=\"color: ${colors.text}; margin: 0; font-size: 14px;\">Certificate of Competency (COC)</p>\n          </div>\n          <div style=\"background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 25px;\">\n            <h3 style=\"color: #1e293b; margin: 0 0 15px 0; font-size: 16px;\">üë§ Crew Member Details</h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px; width: 40%;\">Name:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberName}</td></tr>\n              ${data.crewMemberRank ? `<tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Rank:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberRank}</td></tr>` : ''}\n              ${data.crewMemberNationality ? `<tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Nationality:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberNationality}</td></tr>` : ''}\n              ${data.vesselName ? `<tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Current Vessel:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.vesselName}</td></tr>` : ''}\n            </table>\n          </div>\n          <div style=\"background: #e0e7ff; border-radius: 8px; padding: 20px; margin-bottom: 25px; border-left: 4px solid #4f46e5;\">\n            <h3 style=\"color: #3730a3; margin: 0 0 15px 0; font-size: 16px;\">üìú COC Information</h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr><td style=\"padding: 8px 0; color: #3730a3; font-size: 14px; width: 40%;\">COC Number:</td><td style=\"padding: 8px 0; color: #3730a3; font-size: 14px; font-weight: 600;\">${data.cocNumber}</td></tr>\n              <tr><td style=\"padding: 8px 0; color: #3730a3; font-size: 14px;\">Issuing Authority:</td><td style=\"padding: 8px 0; color: #3730a3; font-size: 14px; font-weight: 600;\">${data.issuingAuthority}</td></tr>\n              <tr><td style=\"padding: 8px 0; color: #3730a3; font-size: 14px;\">Expiry Date:</td><td style=\"padding: 8px 0; color: #dc2626; font-size: 14px; font-weight: bold;\">${formattedExpiryDate}</td></tr>\n            </table>\n          </div>\n          <div style=\"background: #fef3c7; border-radius: 8px; padding: 20px; margin-bottom: 25px;\">\n            <h3 style=\"color: #92400e; margin: 0 0 15px 0; font-size: 16px;\">‚ö° Recommended Actions</h3>\n            <ul style=\"margin: 0; padding-left: 20px; color: #92400e;\">\n              <li style=\"margin-bottom: 10px;\">Contact the crew member to initiate COC renewal process</li>\n              <li style=\"margin-bottom: 10px;\">Verify current vessel assignment and duties</li>\n              <li style=\"margin-bottom: 10px;\">Ensure all required sea service documentation is available</li>\n              <li style=\"margin-bottom: 0;\">Update crew records once renewal is completed</li>\n            </ul>\n          </div>\n          <div style=\"background: #f1f5f9; border-radius: 8px; padding: 15px; text-align: center;\">\n            <p style=\"margin: 0; color: #64748b; font-size: 12px;\">üìÖ <strong>Alert Schedule:</strong> Notifications are sent at 60, 45, 30, and 10 days before expiry</p>\n          </div>\n        </div>\n        <div style=\"text-align: center; padding: 20px;\">\n          <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">This is an automated notification from the Crew Management System<br>Sent to: admin@offing.biz | ${new Date().toLocaleDateString()}</p>\n        </div>\n      </div>\n    </body>\n    </html>\n  `;\n\n  const text = `COC EXPIRY ALERT - ${urgencyText}\\n\\n${data.daysUntilExpiry} Days Until Expiry\\n\\nCREW MEMBER: ${data.crewMemberName}${data.crewMemberRank ? `, ${data.crewMemberRank}` : ''}${data.vesselName ? ` on ${data.vesselName}` : ''}\\n\\nCOC INFORMATION:\\n- COC Number: ${data.cocNumber}\\n- Issuing Authority: ${data.issuingAuthority}\\n- Expiry Date: ${formattedExpiryDate}\\n\\nAlert Schedule: 60, 45, 30, and 10 days before expiry`;\n\n  return { subject, html, text };\n}\n\nexport async function sendCOCExpiryAlert(recipientEmail: string, data: COCExpiryAlertData): Promise<{ success: boolean; error?: string }> {\n  const emailContent = generateCOCExpiryEmail(data);\n  return smtpEmailService.sendEmail({\n    to: recipientEmail,\n    subject: emailContent.subject,\n    html: emailContent.html,\n    text: emailContent.text\n  });\n}\n\n// Medical Certificate Document Expiry Alert Email Template\nexport interface MedicalExpiryAlertData {\n  crewMemberName: string;\n  crewMemberRank?: string;\n  crewMemberNationality?: string;\n  vesselName?: string;\n  medicalNumber: string;\n  issuingAuthority: string;\n  expiryDate: Date;\n  daysUntilExpiry: number;\n}\n\nexport function generateMedicalExpiryEmail(data: MedicalExpiryAlertData): { subject: string; html: string; text: string } {\n  const urgencyLevel = data.daysUntilExpiry <= 10 ? 'critical' : \n                       data.daysUntilExpiry <= 30 ? 'high' :\n                       data.daysUntilExpiry <= 45 ? 'medium' : 'low';\n  \n  const urgencyColors = {\n    critical: { bg: '#fef2f2', border: '#dc2626', text: '#991b1b', badge: '#dc2626' },\n    high: { bg: '#fff7ed', border: '#ea580c', text: '#9a3412', badge: '#ea580c' },\n    medium: { bg: '#fffbeb', border: '#d97706', text: '#92400e', badge: '#d97706' },\n    low: { bg: '#f0fdf4', border: '#22c55e', text: '#166534', badge: '#22c55e' }\n  };\n  \n  const colors = urgencyColors[urgencyLevel];\n  const urgencyText = urgencyLevel === 'critical' ? 'URGENT' : \n                      urgencyLevel === 'high' ? 'HIGH PRIORITY' :\n                      urgencyLevel === 'medium' ? 'ATTENTION NEEDED' : 'REMINDER';\n\n  const formattedExpiryDate = data.expiryDate.toLocaleDateString('en-US', {\n    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'\n  });\n\n  const subject = urgencyLevel === 'critical' \n    ? `üö® URGENT: Medical Certificate Expiring in ${data.daysUntilExpiry} days - ${data.crewMemberName}`\n    : `üè• Medical Certificate Expiry Alert (${data.daysUntilExpiry} days) - ${data.crewMemberName}`;\n\n  const html = `\n    <!DOCTYPE html>\n    <html>\n    <head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"></head>\n    <body style=\"margin: 0; padding: 0; background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <div style=\"background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%); padding: 30px; border-radius: 12px 12px 0 0; text-align: center;\">\n          <h1 style=\"color: #ffffff; margin: 0; font-size: 24px;\">üö¢ Crew Management System</h1>\n          <p style=\"color: #93c5fd; margin: 10px 0 0 0; font-size: 14px;\">Medical Certificate Expiry Notification</p>\n        </div>\n        <div style=\"background: #ffffff; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n          <div style=\"background: ${colors.bg}; border: 2px solid ${colors.border}; border-radius: 8px; padding: 20px; margin-bottom: 25px; text-align: center;\">\n            <span style=\"background: ${colors.badge}; color: #ffffff; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: bold;\">${urgencyText}</span>\n            <h2 style=\"color: ${colors.text}; margin: 15px 0 5px 0; font-size: 28px; font-weight: bold;\">${data.daysUntilExpiry} Days Until Expiry</h2>\n            <p style=\"color: ${colors.text}; margin: 0; font-size: 14px;\">Medical Certificate</p>\n          </div>\n          <div style=\"background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 25px;\">\n            <h3 style=\"color: #1e293b; margin: 0 0 15px 0; font-size: 16px;\">üë§ Crew Member Details</h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px; width: 40%;\">Name:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberName}</td></tr>\n              ${data.crewMemberRank ? `<tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Rank:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberRank}</td></tr>` : ''}\n              ${data.crewMemberNationality ? `<tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Nationality:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberNationality}</td></tr>` : ''}\n              ${data.vesselName ? `<tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Current Vessel:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.vesselName}</td></tr>` : ''}\n            </table>\n          </div>\n          <div style=\"background: #dcfce7; border-radius: 8px; padding: 20px; margin-bottom: 25px; border-left: 4px solid #16a34a;\">\n            <h3 style=\"color: #166534; margin: 0 0 15px 0; font-size: 16px;\">üè• Medical Certificate Information</h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr><td style=\"padding: 8px 0; color: #166534; font-size: 14px; width: 40%;\">Certificate Number:</td><td style=\"padding: 8px 0; color: #166534; font-size: 14px; font-weight: 600;\">${data.medicalNumber}</td></tr>\n              <tr><td style=\"padding: 8px 0; color: #166534; font-size: 14px;\">Issuing Authority:</td><td style=\"padding: 8px 0; color: #166534; font-size: 14px; font-weight: 600;\">${data.issuingAuthority}</td></tr>\n              <tr><td style=\"padding: 8px 0; color: #166534; font-size: 14px;\">Expiry Date:</td><td style=\"padding: 8px 0; color: #dc2626; font-size: 14px; font-weight: bold;\">${formattedExpiryDate}</td></tr>\n            </table>\n          </div>\n          <div style=\"background: #fef3c7; border-radius: 8px; padding: 20px; margin-bottom: 25px;\">\n            <h3 style=\"color: #92400e; margin: 0 0 15px 0; font-size: 16px;\">‚ö° Recommended Actions</h3>\n            <ul style=\"margin: 0; padding-left: 20px; color: #92400e;\">\n              <li style=\"margin-bottom: 10px;\">Schedule a medical examination for the crew member</li>\n              <li style=\"margin-bottom: 10px;\">Verify current health requirements and fitness standards</li>\n              <li style=\"margin-bottom: 10px;\">Ensure all required medical tests are completed before renewal</li>\n              <li style=\"margin-bottom: 0;\">Update crew records once new certificate is issued</li>\n            </ul>\n          </div>\n          <div style=\"background: #f1f5f9; border-radius: 8px; padding: 15px; text-align: center;\">\n            <p style=\"margin: 0; color: #64748b; font-size: 12px;\">üìÖ <strong>Alert Schedule:</strong> Notifications are sent at 60, 45, 30, and 10 days before expiry</p>\n          </div>\n        </div>\n        <div style=\"text-align: center; padding: 20px;\">\n          <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">This is an automated notification from the Crew Management System<br>Sent to: admin@offing.biz | ${new Date().toLocaleDateString()}</p>\n        </div>\n      </div>\n    </body>\n    </html>\n  `;\n\n  const text = `MEDICAL CERTIFICATE EXPIRY ALERT - ${urgencyText}\\n\\n${data.daysUntilExpiry} Days Until Expiry\\n\\nCREW MEMBER: ${data.crewMemberName}${data.crewMemberRank ? `, ${data.crewMemberRank}` : ''}${data.vesselName ? ` on ${data.vesselName}` : ''}\\n\\nMEDICAL CERTIFICATE INFORMATION:\\n- Certificate Number: ${data.medicalNumber}\\n- Issuing Authority: ${data.issuingAuthority}\\n- Expiry Date: ${formattedExpiryDate}\\n\\nAlert Schedule: 60, 45, 30, and 10 days before expiry`;\n\n  return { subject, html, text };\n}\n\nexport async function sendMedicalExpiryAlert(recipientEmail: string, data: MedicalExpiryAlertData): Promise<{ success: boolean; error?: string }> {\n  const emailContent = generateMedicalExpiryEmail(data);\n  return smtpEmailService.sendEmail({\n    to: recipientEmail,\n    subject: emailContent.subject,\n    html: emailContent.html,\n    text: emailContent.text\n  });\n}\n\n// Consolidated Document Expiry Alert - All documents in one email\nexport interface ConsolidatedDocumentData {\n  crewMemberName: string;\n  crewMemberRank?: string;\n  crewMemberNationality?: string;\n  vesselName?: string;\n  documents: {\n    type: 'CDC' | 'Passport' | 'COC' | 'Medical';\n    documentNumber: string;\n    issuingAuthority: string;\n    expiryDate: Date;\n    daysUntilExpiry: number;\n  }[];\n}\n\nexport function generateConsolidatedExpiryEmail(data: ConsolidatedDocumentData): { subject: string; html: string; text: string } {\n  const minDays = Math.min(...data.documents.map(d => d.daysUntilExpiry));\n  const urgencyLevel = minDays <= 10 ? 'critical' : minDays <= 30 ? 'high' : minDays <= 45 ? 'medium' : 'low';\n  \n  const urgencyColors = {\n    critical: { bg: '#fef2f2', border: '#dc2626', text: '#991b1b', badge: '#dc2626' },\n    high: { bg: '#fff7ed', border: '#ea580c', text: '#9a3412', badge: '#ea580c' },\n    medium: { bg: '#fffbeb', border: '#d97706', text: '#92400e', badge: '#d97706' },\n    low: { bg: '#f0fdf4', border: '#22c55e', text: '#166534', badge: '#22c55e' }\n  };\n  \n  const colors = urgencyColors[urgencyLevel];\n  const urgencyText = urgencyLevel === 'critical' ? 'URGENT' : urgencyLevel === 'high' ? 'HIGH PRIORITY' : urgencyLevel === 'medium' ? 'ATTENTION NEEDED' : 'REMINDER';\n\n  const docTypeConfig: Record<string, { icon: string; color: string; bgColor: string }> = {\n    'CDC': { icon: 'üìã', color: '#1e40af', bgColor: '#dbeafe' },\n    'Passport': { icon: 'üõÇ', color: '#1e40af', bgColor: '#dbeafe' },\n    'COC': { icon: 'üìú', color: '#3730a3', bgColor: '#e0e7ff' },\n    'Medical': { icon: 'üè•', color: '#166534', bgColor: '#dcfce7' }\n  };\n\n  const documentCards = data.documents.map(doc => {\n    const config = docTypeConfig[doc.type] || docTypeConfig['CDC'];\n    const formattedDate = doc.expiryDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });\n    const daysColor = doc.daysUntilExpiry <= 10 ? '#dc2626' : doc.daysUntilExpiry <= 30 ? '#ea580c' : '#d97706';\n    return `\n      <div style=\"background: ${config.bgColor}; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid ${config.color};\">\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;\">\n          <h4 style=\"color: ${config.color}; margin: 0; font-size: 16px;\">${config.icon} ${doc.type}</h4>\n          <span style=\"background: ${daysColor}; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;\">${doc.daysUntilExpiry} days</span>\n        </div>\n        <table style=\"width: 100%; border-collapse: collapse;\">\n          <tr><td style=\"padding: 4px 0; color: ${config.color}; font-size: 13px; width: 40%;\">Number:</td><td style=\"padding: 4px 0; color: ${config.color}; font-size: 13px; font-weight: 600;\">${doc.documentNumber}</td></tr>\n          <tr><td style=\"padding: 4px 0; color: ${config.color}; font-size: 13px;\">Authority:</td><td style=\"padding: 4px 0; color: ${config.color}; font-size: 13px; font-weight: 600;\">${doc.issuingAuthority}</td></tr>\n          <tr><td style=\"padding: 4px 0; color: ${config.color}; font-size: 13px;\">Expires:</td><td style=\"padding: 4px 0; color: #dc2626; font-size: 13px; font-weight: bold;\">${formattedDate}</td></tr>\n        </table>\n      </div>\n    `;\n  }).join('');\n\n  const subject = urgencyLevel === 'critical' \n    ? `üö® URGENT: Multiple Documents Expiring - ${data.crewMemberName}`\n    : `üìã Document Expiry Summary (${data.documents.length} documents) - ${data.crewMemberName}`;\n\n  const html = `\n    <!DOCTYPE html>\n    <html>\n    <head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"></head>\n    <body style=\"margin: 0; padding: 0; background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n      <div style=\"max-width: 600px; margin: 0 auto; padding: 20px;\">\n        <div style=\"background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%); padding: 30px; border-radius: 12px 12px 0 0; text-align: center;\">\n          <h1 style=\"color: #ffffff; margin: 0; font-size: 24px;\">üö¢ Crew Management System</h1>\n          <p style=\"color: #93c5fd; margin: 10px 0 0 0; font-size: 14px;\">Consolidated Document Expiry Report</p>\n        </div>\n        <div style=\"background: #ffffff; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\">\n          <div style=\"background: ${colors.bg}; border: 2px solid ${colors.border}; border-radius: 8px; padding: 20px; margin-bottom: 25px; text-align: center;\">\n            <span style=\"background: ${colors.badge}; color: #ffffff; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: bold;\">${urgencyText}</span>\n            <h2 style=\"color: ${colors.text}; margin: 15px 0 5px 0; font-size: 24px; font-weight: bold;\">${data.documents.length} Documents Require Attention</h2>\n            <p style=\"color: ${colors.text}; margin: 0; font-size: 14px;\">Earliest expiry: ${minDays} days</p>\n          </div>\n          <div style=\"background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 25px;\">\n            <h3 style=\"color: #1e293b; margin: 0 0 15px 0; font-size: 16px;\">üë§ Crew Member Details</h3>\n            <table style=\"width: 100%; border-collapse: collapse;\">\n              <tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px; width: 40%;\">Name:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberName}</td></tr>\n              ${data.crewMemberRank ? `<tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Rank:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberRank}</td></tr>` : ''}\n              ${data.crewMemberNationality ? `<tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Nationality:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.crewMemberNationality}</td></tr>` : ''}\n              ${data.vesselName ? `<tr><td style=\"padding: 8px 0; color: #64748b; font-size: 14px;\">Current Vessel:</td><td style=\"padding: 8px 0; color: #1e293b; font-size: 14px; font-weight: 600;\">${data.vesselName}</td></tr>` : ''}\n            </table>\n          </div>\n          <h3 style=\"color: #1e293b; margin: 0 0 15px 0; font-size: 16px;\">üìÑ Expiring Documents</h3>\n          ${documentCards}\n          <div style=\"background: #fef3c7; border-radius: 8px; padding: 20px; margin-top: 25px;\">\n            <h3 style=\"color: #92400e; margin: 0 0 15px 0; font-size: 16px;\">‚ö° Recommended Actions</h3>\n            <ul style=\"margin: 0; padding-left: 20px; color: #92400e;\">\n              <li style=\"margin-bottom: 10px;\">Review all expiring documents and prioritize renewals</li>\n              <li style=\"margin-bottom: 10px;\">Contact the crew member to initiate renewal processes</li>\n              <li style=\"margin-bottom: 10px;\">Ensure all required documentation is available</li>\n              <li style=\"margin-bottom: 0;\">Update crew records once renewals are completed</li>\n            </ul>\n          </div>\n          <div style=\"background: #f1f5f9; border-radius: 8px; padding: 15px; text-align: center; margin-top: 20px;\">\n            <p style=\"margin: 0; color: #64748b; font-size: 12px;\">üìÖ <strong>Alert Schedule:</strong> Notifications are sent at 60, 45, 30, and 10 days before expiry</p>\n          </div>\n        </div>\n        <div style=\"text-align: center; padding: 20px;\">\n          <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">This is an automated notification from the Crew Management System<br>Sent to: admin@offing.biz | ${new Date().toLocaleDateString()}</p>\n        </div>\n      </div>\n    </body>\n    </html>\n  `;\n\n  const docList = data.documents.map(d => `- ${d.type}: ${d.documentNumber} (expires ${d.expiryDate.toLocaleDateString()}, ${d.daysUntilExpiry} days)`).join('\\n');\n  const text = `CONSOLIDATED DOCUMENT EXPIRY ALERT - ${urgencyText}\\n\\nCREW MEMBER: ${data.crewMemberName}${data.crewMemberRank ? `, ${data.crewMemberRank}` : ''}${data.vesselName ? ` on ${data.vesselName}` : ''}\\n\\nEXPIRING DOCUMENTS:\\n${docList}\\n\\nAlert Schedule: 60, 45, 30, and 10 days before expiry`;\n\n  return { subject, html, text };\n}\n\nexport async function sendConsolidatedExpiryAlert(recipientEmail: string, data: ConsolidatedDocumentData): Promise<{ success: boolean; error?: string }> {\n  const emailContent = generateConsolidatedExpiryEmail(data);\n  return smtpEmailService.sendEmail({\n    to: recipientEmail,\n    subject: emailContent.subject,\n    html: emailContent.html,\n    text: emailContent.text\n  });\n}","path":null,"size_bytes":57020,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { z } from \"zod\";\nimport { \n  insertCrewMemberSchema,\n  insertVesselSchema,\n  insertDocumentSchema,\n  insertVesselDocumentSchema,\n  insertContractSchema,\n  insertCrewRotationSchema,\n  insertEmailSettingsSchema,\n  insertWhatsappSettingsSchema,\n  activityLogs,\n  statusChangeHistory,\n  crewMembers,\n  vessels,\n  documents,\n  contracts,\n  crewRotations\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { sql } from \"drizzle-orm\";\nimport { localOcrService } from \"./localOcrService\";\nimport { groqOcrService } from \"./groqOcrService\";\nimport { randomUUID } from \"crypto\";\nimport { VesselDocumentStorageService } from \"./objectStorage\";\nimport { notificationService } from \"./services/notification-service\";\nimport express from \"express\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport multer from 'multer';\n\n// Extend Express Request type to include user\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: { id: string; role: string; username?: string };\n    }\n  }\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  \n  // Static file serving for uploaded documents\n  const uploadsDir = path.join(process.cwd(), 'uploads');\n  if (!fs.existsSync(uploadsDir)) {\n    fs.mkdirSync(uploadsDir, { recursive: true });\n  }\n  app.use('/uploads', express.static(uploadsDir));\n  \n  // Authentication middleware (simplified for demo)\n  const authenticate = (req: any, res: any, next: any) => {\n    // In a real app, you'd verify JWT tokens here\n    // For demo, we'll just check for a basic auth header\n    const authHeader = req.headers.authorization;\n    if (!authHeader) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n    \n    // Mock authentication - read from headers that OIDC test system provides\n    // For security: NO fallback to admin - require explicit role or default to least privileged\n    const userId = req.headers['x-user-id'] || req.headers['x-oidc-sub'] || 'demo-user';\n    const userRole = req.headers['x-user-role'] || req.headers['x-oidc-role'] || 'office_staff'; // Default to least privileged\n    const username = req.headers['x-username'] || req.headers['x-oidc-preferred-username'] || 'demo-user';\n    \n    // Reject requests with no role specified and no auth context (for security)\n    if (!req.headers['x-user-role'] && !req.headers['x-oidc-role'] && authHeader === 'Bearer mock-token') {\n      // Default demo case - allow with office_staff permissions for backward compatibility\n      console.log('Auth middleware - Using default demo user with office_staff role');\n    }\n    req.user = { id: userId, role: userRole, username: username };\n    next();\n  };\n\n  // Auth routes\n  app.post(\"/api/auth/login\", async (req, res) => {\n    try {\n      const { username, password } = req.body;\n      const user = await storage.getUserByUsername(username);\n      \n      if (!user || user.password !== password) {\n        return res.status(401).json({ message: \"Invalid credentials\" });\n      }\n\n      // In a real app, generate JWT token here\n      const token = `mock-token-${user.id}`;\n      \n      // Log login activity\n      try {\n        await db.insert(activityLogs).values({\n          type: 'System',\n          action: 'login',\n          entityType: 'user',\n          entityId: user.id,\n          userId: null,\n          username: user.username,\n          userRole: user.role,\n          description: `${user.role === 'admin' ? 'Admin' : 'Office Staff'} user ${user.username} logged into system`,\n          severity: 'info',\n          metadata: {\n            userRole: user.role,\n            userName: user.name\n          }\n        });\n        console.log('Login activity logged successfully');\n      } catch (logError) {\n        console.error('Failed to log login activity:', logError);\n      }\n      \n      res.json({ \n        user: { id: user.id, username: user.username, role: user.role, name: user.name, email: user.email },\n        token \n      });\n    } catch (error) {\n      res.status(500).json({ message: \"Login failed\" });\n    }\n  });\n\n  // Vessel routes\n  app.get(\"/api/vessels\", authenticate, async (req, res) => {\n    try {\n      // Add cache control headers to prevent stale data\n      res.set({\n        'Cache-Control': 'no-store, no-cache, must-revalidate',\n        'Pragma': 'no-cache',\n        'Vary': 'Authorization'\n      });\n      \n      const vessels = await storage.getVessels();\n      const crewMembers = await storage.getCrewMembers();\n      const contracts = await storage.getContracts();\n      \n      // Enhance vessel data with crew count and next crew change\n      const enhancedVessels = vessels.map(vessel => {\n        const assignedCrew = crewMembers.filter(member => member.currentVesselId === vessel.id);\n        const crewCount = assignedCrew.length;\n        \n        // Find next crew change from active contracts ending soon\n        const activeContracts = contracts.filter(contract => \n          assignedCrew.some(crew => crew.id === contract.crewMemberId) && \n          contract.status === 'active'\n        );\n        \n        // Get the earliest contract end date as next crew change\n        const nextCrewChange = activeContracts.length > 0 ? \n          Math.min(...activeContracts.map(c => c.endDate.getTime())) : null;\n        \n        return {\n          ...vessel,\n          crewCount,\n          nextCrewChange: nextCrewChange ? new Date(nextCrewChange).toISOString() : undefined\n        };\n      });\n      \n      res.json(enhancedVessels);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch vessels\" });\n    }\n  });\n\n  app.post(\"/api/vessels\", authenticate, async (req, res) => {\n    try {\n      const vesselData = insertVesselSchema.parse(req.body);\n      const vessel = await storage.createVessel(vesselData);\n      \n      // Log vessel creation activity\n      try {\n        await db.insert(activityLogs).values({\n          type: 'Fleet Management',\n          action: 'create',\n          entityType: 'vessel',\n          entityId: vessel.id,\n          userId: null,\n          username: req.user?.username || 'System',\n          userRole: req.user?.role || 'admin',\n          description: `Vessel ${vessel.name} (${vessel.type}) added to fleet - IMO: ${vessel.imoNumber} - Flag: ${vessel.flag}`,\n          severity: 'success',\n          metadata: JSON.stringify({\n            vesselName: vessel.name,\n            vesselType: vessel.type,\n            imoNumber: vessel.imoNumber,\n            flag: vessel.flag\n          })\n        });\n        console.log('Vessel creation activity logged successfully');\n      } catch (logError) {\n        console.error('Failed to log vessel creation activity:', logError);\n      }\n      \n      res.json(vessel);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid vessel data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create vessel\" });\n      }\n    }\n  });\n\n  // Update vessel order - placed BEFORE general vessel routes to avoid route conflicts\n  app.put(\"/api/vessels/order\", authenticate, async (req, res) => {\n    try {\n      // Check if user is admin\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Only admins can reorder vessels\" });\n      }\n\n      const { vesselIds } = req.body;\n      \n      if (!Array.isArray(vesselIds)) {\n        return res.status(400).json({ message: \"vesselIds must be an array\" });\n      }\n\n      if (vesselIds.length === 0) {\n        return res.status(400).json({ message: \"vesselIds array cannot be empty\" });\n      }\n\n      const success = await storage.updateVesselOrder(vesselIds);\n      \n      if (success) {\n        try {\n          // Log the reordering activity using direct DB insert\n          await db.insert(activityLogs).values({\n            type: 'Fleet Management',\n            action: 'reorder',\n            entityType: 'vessel',\n            entityId: 'multiple',\n            userId: null,\n            username: req.user?.username || 'unknown',\n            userRole: req.user?.role || 'unknown',\n            description: `Vessel order updated by ${req.user?.username}`,\n            severity: 'info',\n            metadata: JSON.stringify({\n              vesselIds: vesselIds,\n              newOrder: vesselIds.map((id, index) => ({ id, position: index + 1 }))\n            })\n          });\n        } catch (logError) {\n          console.error('Failed to log vessel reordering activity:', logError);\n        }\n        \n        res.json({ message: \"Vessel order updated successfully\" });\n      } else {\n        res.status(500).json({ message: \"Failed to update vessel order\" });\n      }\n    } catch (error) {\n      console.error('Error updating vessel order:', error);\n      res.status(500).json({ message: \"Failed to update vessel order\", error: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  app.put(\"/api/vessels/:id\", authenticate, async (req, res) => {\n    try {\n      const vesselData = insertVesselSchema.partial().parse(req.body);\n      \n      // Get original vessel for comparison\n      const originalVessel = await storage.getVessel(req.params.id);\n      if (!originalVessel) {\n        return res.status(404).json({ message: \"Vessel not found\" });\n      }\n      \n      const updatedVessel = await storage.updateVessel(req.params.id, vesselData);\n      \n      if (updatedVessel) {\n        try {\n          // Log the update activity\n          await db.insert(activityLogs).values({\n            type: 'Fleet Management',\n            action: 'update',\n            entityType: 'vessel',\n            entityId: req.params.id,\n            userId: null,\n            username: req.user?.username || 'unknown',\n            userRole: req.user?.role || 'unknown',\n            description: `Vessel ${updatedVessel.name} (${updatedVessel.type}) updated - IMO: ${updatedVessel.imoNumber} - Flag: ${updatedVessel.flag}`,\n            severity: 'info',\n            metadata: JSON.stringify({\n              vesselName: updatedVessel.name,\n              vesselType: updatedVessel.type,\n              imoNumber: updatedVessel.imoNumber,\n              flag: updatedVessel.flag,\n              originalName: originalVessel.name,\n              changes: Object.keys(vesselData).filter(key => {\n                const originalValue = originalVessel[key as keyof typeof originalVessel];\n                const newValue = vesselData[key as keyof typeof vesselData];\n                return originalValue !== newValue;\n              })\n            })\n          });\n        } catch (logError) {\n          console.error('Failed to log vessel update activity:', logError);\n        }\n        \n        res.json(updatedVessel);\n      } else {\n        res.status(404).json({ message: \"Vessel not found\" });\n      }\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid vessel data\", errors: error.errors });\n      } else {\n        console.error('Error updating vessel:', error);\n        res.status(500).json({ message: \"Failed to update vessel\" });\n      }\n    }\n  });\n\n  app.delete(\"/api/vessels/:id\", authenticate, async (req, res) => {\n    try {\n      console.log('Attempting to delete vessel:', req.params.id);\n      \n      // Get vessel details before deletion for logging\n      const vessel = await storage.getVessel(req.params.id);\n      console.log('Found vessel:', vessel);\n      \n      if (!vessel) {\n        return res.status(404).json({ message: \"Vessel not found\" });\n      }\n      \n      const success = await storage.deleteVessel(req.params.id);\n      console.log('Deletion success:', success);\n      \n      if (success) {\n        try {\n          // Log the deletion activity directly to database\n          await db.insert(activityLogs).values({\n            type: 'Fleet Management',\n            action: 'delete',\n            entityType: 'vessel',\n            entityId: req.params.id,\n            userId: null, // Set to null due to foreign key constraint\n            username: req.user?.username || 'unknown',\n            userRole: req.user?.role || 'unknown',\n            description: `Vessel ${vessel.name} (${vessel.type}) deleted - IMO: ${vessel.imoNumber} - Flag: ${vessel.flag}`,\n            severity: 'warning',\n            metadata: JSON.stringify({\n              vesselName: vessel.name,\n              vesselType: vessel.type,\n              imoNumber: vessel.imoNumber,\n              flag: vessel.flag\n            })\n          });\n          console.log('Activity logged successfully');\n        } catch (logError) {\n          console.error('Failed to log activity:', logError);\n          // Don't fail the whole operation if logging fails\n        }\n        \n        res.json({ message: \"Vessel deleted successfully\" });\n      } else {\n        res.status(404).json({ message: \"Vessel not found\" });\n      }\n    } catch (error) {\n      console.error('Error deleting vessel:', error);\n      res.status(500).json({ message: \"Failed to delete vessel\", error: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  app.get(\"/api/vessels/:id/contract-stats\", authenticate, async (req, res) => {\n    try {\n      const vesselId = req.params.id;\n      const stats = await storage.getVesselContractStats(vesselId);\n      res.json(stats);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch contract statistics\" });\n    }\n  });\n\n  app.get(\"/api/vessels/:id/contracts\", authenticate, async (req, res) => {\n    try {\n      const vesselId = req.params.id;\n      const { status } = req.query;\n      const contracts = await storage.getVesselContracts(vesselId, status as string);\n      res.json(contracts);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch vessel contracts\" });\n    }\n  });\n\n\n\n  // Crew member routes\n  app.get(\"/api/crew\", authenticate, async (req, res) => {\n    try {\n      const { vesselId } = req.query;\n      let crewMembers;\n      \n      if (vesselId) {\n        crewMembers = await storage.getCrewMembersByVessel(vesselId as string);\n      } else {\n        crewMembers = await storage.getCrewMembers();\n      }\n      \n      res.json(crewMembers);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch crew members\" });\n    }\n  });\n\n  app.get(\"/api/crew/:id\", authenticate, async (req, res) => {\n    try {\n      const crewMember = await storage.getCrewMember(req.params.id);\n      if (!crewMember) {\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n      res.json(crewMember);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch crew member\" });\n    }\n  });\n\n  app.post(\"/api/crew\", authenticate, async (req, res) => {\n    try {\n      // Convert dateOfBirth string to Date object before validation\n      const requestBody = {\n        ...req.body,\n        dateOfBirth: new Date(req.body.dateOfBirth)\n      };\n      \n      const crewData = insertCrewMemberSchema.parse(requestBody);\n      \n      // Check for duplicate crew member (same first name, last name, and date of birth)\n      const duplicate = await storage.findDuplicateCrewMember(\n        crewData.firstName,\n        crewData.lastName,\n        crewData.dateOfBirth\n      );\n      \n      // Only reject if duplicate exists AND is being added to the same vessel (or no vessel specified)\n      if (duplicate) {\n        const newVesselId = crewData.currentVesselId || null;\n        const existingVesselId = duplicate.currentVesselId || null;\n        \n        // If same vessel (including both being null/unassigned), reject the duplicate\n        if (newVesselId === existingVesselId) {\n          return res.status(400).json({ \n            message: `A crew member with the name \"${crewData.firstName} ${crewData.lastName}\" and the same date of birth already exists${existingVesselId ? ' on the same vessel' : ''}.`,\n            error: \"DUPLICATE_CREW_MEMBER\"\n          });\n        }\n        // Different vessel - allow the entry (fall through to create)\n      }\n      \n      const crewMember = await storage.createCrewMember(crewData);\n      \n      // Log crew creation activity\n      try {\n        await db.insert(activityLogs).values({\n          type: 'Crew Management',\n          action: 'create',\n          entityType: 'crew',\n          entityId: crewMember.id,\n          userId: null,\n          username: req.user?.username || 'System',\n          userRole: req.user?.role || 'admin',\n          description: `Crew member ${crewMember.firstName} ${crewMember.lastName} (${crewMember.rank}) added to system`,\n          severity: 'success',\n          metadata: {\n            crewName: `${crewMember.firstName} ${crewMember.lastName}`,\n            position: crewMember.rank,\n            nationality: crewMember.nationality\n          }\n        });\n        console.log('Crew creation activity logged successfully');\n      } catch (logError) {\n        console.error('Failed to log crew creation activity:', logError);\n      }\n      \n      res.json(crewMember);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid crew data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create crew member\" });\n      }\n    }\n  });\n\n  app.put(\"/api/crew/:id\", authenticate, async (req, res) => {\n    try {\n      console.log('Updating crew member:', req.params.id, 'with data:', req.body);\n      \n      // Get existing crew member for logging\n      const existingCrewMember = await storage.getCrewMember(req.params.id);\n      if (!existingCrewMember) {\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n      \n      // Check if status is being changed - require mandatory reason\n      const statusChangeReason = req.body.statusChangeReason;\n      if (req.body.status && req.body.status !== existingCrewMember.status) {\n        if (!statusChangeReason || statusChangeReason.trim() === '') {\n          return res.status(400).json({ \n            message: \"Status change requires a reason\", \n            error: \"REASON_REQUIRED\",\n            details: \"You must provide a reason when changing crew member status\"\n          });\n        }\n      }\n      \n      // Remove statusChangeReason from the body before parsing with schema\n      const { statusChangeReason: _, ...updateBody } = req.body;\n      \n      const updates = insertCrewMemberSchema.partial().parse(updateBody);\n      console.log('Parsed updates:', updates);\n      \n      // Handle vessel assignment changes - create rotation records for history tracking\n      if (updates.currentVesselId !== undefined && updates.currentVesselId !== existingCrewMember.currentVesselId) {\n        const now = new Date();\n        \n        // If crew member had a previous vessel, complete that rotation\n        if (existingCrewMember.currentVesselId) {\n          console.log(`Completing previous vessel rotation for ${existingCrewMember.firstName} ${existingCrewMember.lastName}`);\n          \n          // Find any active rotations for the previous vessel\n          const existingRotations = await storage.getCrewRotationsByVessel(existingCrewMember.currentVesselId);\n          const activeRotation = existingRotations.find(\n            r => r.crewMemberId === req.params.id && (!r.leaveDate || r.status !== 'completed')\n          );\n          \n          if (activeRotation) {\n            // Update the existing rotation with leave date\n            await storage.updateCrewRotation(activeRotation.id, {\n              leaveDate: now,\n              status: 'completed'\n            });\n          } else {\n            // Create a completed rotation record for the previous vessel\n            // Use a reasonable join date if not found in existing rotations\n            const estimatedJoinDate = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000)); // Estimate 90 days ago\n            \n            await storage.createCrewRotation({\n              crewMemberId: req.params.id,\n              vesselId: existingCrewMember.currentVesselId,\n              joinDate: estimatedJoinDate,\n              leaveDate: now,\n              rotationType: 'leave',\n              status: 'completed'\n            });\n          }\n          \n          // Update lastVesselId\n          updates.lastVesselId = existingCrewMember.currentVesselId;\n        }\n        \n        // If assigning to a new vessel (not signing off), create new rotation\n        if (updates.currentVesselId) {\n          console.log(`Creating new vessel rotation for ${existingCrewMember.firstName} ${existingCrewMember.lastName}`);\n          \n          await storage.createCrewRotation({\n            crewMemberId: req.params.id,\n            vesselId: updates.currentVesselId,\n            joinDate: now,\n            leaveDate: null,\n            rotationType: 'join',\n            status: 'scheduled'\n          });\n        }\n      }\n      \n      // Special handling for sign-off operations\n      if (updates.status === 'onShore' && updates.currentVesselId === null) {\n        console.log(`Processing sign-off for crew member: ${existingCrewMember.firstName} ${existingCrewMember.lastName}`);\n        \n        // Add signOffDate if not provided\n        if (!updates.signOffDate) {\n          updates.signOffDate = new Date();\n        }\n      }\n      \n      const crewMember = await storage.updateCrewMember(req.params.id, updates);\n      console.log('Updated crew member result:', crewMember);\n      \n      if (!crewMember) {\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n      \n      // Record status change in history if status was changed\n      if (updates.status && updates.status !== existingCrewMember.status && statusChangeReason) {\n        try {\n          // Check if user ID is a valid UUID (demo users like \"demo-admin\" are not valid UUIDs)\n          const isValidUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(req.user?.id || '');\n          \n          await db.insert(statusChangeHistory).values({\n            crewMemberId: req.params.id,\n            previousStatus: existingCrewMember.status,\n            newStatus: updates.status,\n            reason: statusChangeReason.trim(),\n            changedBy: isValidUUID ? req.user?.id : null,\n            changedByUsername: req.user?.username || 'System',\n            vesselId: updates.currentVesselId || existingCrewMember.currentVesselId || null,\n            contractId: null\n          });\n          console.log('Status change history recorded successfully');\n        } catch (historyError) {\n          console.error('Failed to record status change history:', historyError);\n        }\n      }\n      \n      // Log the update activity\n      try {\n        await db.insert(activityLogs).values({\n          type: 'Crew Management',\n          action: 'update',\n          entityType: 'crew',\n          entityId: req.params.id,\n          userId: null,\n          username: req.user?.username || 'System',\n          userRole: req.user?.role || 'admin',\n          description: `Crew member ${crewMember.firstName} ${crewMember.lastName} (${crewMember.rank}) updated`,\n          severity: 'info',\n          metadata: {\n            crewName: `${crewMember.firstName} ${crewMember.lastName}`,\n            position: crewMember.rank,\n            nationality: crewMember.nationality,\n            changes: Object.keys(updates)\n          }\n        });\n        console.log('Crew update activity logged successfully');\n      } catch (logError) {\n        console.error('Failed to log crew update activity:', logError);\n      }\n      \n      res.json(crewMember);\n    } catch (error) {\n      console.error('Error updating crew member:', error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ \n          message: \"Invalid update data\", \n          errors: error.errors,\n          details: `Validation failed for crew member ${req.params.id}`\n        });\n      } else {\n        res.status(500).json({ \n          message: \"Failed to update crew member\", \n          error: error instanceof Error ? error.message : 'Unknown error',\n          crewId: req.params.id,\n          requestBody: req.body\n        });\n      }\n    }\n  });\n\n  app.delete(\"/api/crew/:id\", authenticate, async (req, res) => {\n    try {\n      console.log(`DELETE /api/crew/${req.params.id} - Attempting to delete crew member`);\n      \n      // Get crew member details before deletion for logging\n      const crewMember = await storage.getCrewMember(req.params.id);\n      console.log(`Crew member lookup result for ${req.params.id}:`, crewMember ? `Found: ${crewMember.firstName} ${crewMember.lastName}` : 'NOT FOUND');\n      \n      const deleted = await storage.deleteCrewMember(req.params.id);\n      console.log(`Delete result for ${req.params.id}:`, deleted);\n      \n      if (!deleted) {\n        console.log(`Crew member ${req.params.id} not found in database - returning 404`);\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n      \n      // Log crew deletion activity\n      if (crewMember) {\n        try {\n          await db.insert(activityLogs).values({\n            type: 'Crew Management',\n            action: 'delete',\n            entityType: 'crew',\n            entityId: req.params.id,\n            userId: null,\n            username: req.user?.username || 'System',\n            userRole: req.user?.role || 'admin',\n            description: `Crew member ${crewMember.firstName} ${crewMember.lastName} (${crewMember.rank}) removed from system`,\n            severity: 'warning',\n            metadata: {\n              crewName: `${crewMember.firstName} ${crewMember.lastName}`,\n              position: crewMember.rank,\n              nationality: crewMember.nationality\n            }\n          });\n          console.log('Crew deletion activity logged successfully');\n        } catch (logError) {\n          console.error('Failed to log crew deletion activity:', logError);\n        }\n      }\n      \n      res.json({ message: \"Crew member deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete crew member\" });\n    }\n  });\n\n  // Document routes\n  app.get(\"/api/documents\", authenticate, async (req, res) => {\n    try {\n      const { crewMemberId } = req.query;\n      let documents;\n      \n      if (crewMemberId) {\n        documents = await storage.getDocumentsByCrewMember(crewMemberId as string);\n      } else {\n        documents = await storage.getDocuments();\n      }\n      \n      res.json(documents);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch documents\" });\n    }\n  });\n\n  app.post(\"/api/documents\", authenticate, async (req, res) => {\n    try {\n      const documentData = insertDocumentSchema.parse(req.body);\n      const document = await storage.createDocument(documentData);\n      \n      // Trigger immediate alert if document expires within 30 days\n      if (document.expiryDate) {\n        try {\n          const crewMember = await storage.getCrewMember(document.crewMemberId);\n          if (crewMember) {\n            // Get vessel name from crew member's current vessel\n            let vesselName: string | undefined;\n            if (crewMember.currentVesselId) {\n              const vessel = await storage.getVessel(crewMember.currentVesselId);\n              vesselName = vessel?.name;\n            }\n            \n            await notificationService.sendImmediateDocumentAlert(\n              {\n                id: document.id,\n                type: document.type,\n                expiryDate: document.expiryDate,\n                documentNumber: document.documentNumber,\n                issuingAuthority: document.issuingAuthority,\n              },\n              {\n                id: crewMember.id,\n                name: `${crewMember.firstName} ${crewMember.lastName}`,\n                rank: crewMember.rank,\n                nationality: crewMember.nationality,\n              },\n              vesselName\n            );\n          }\n        } catch (alertError) {\n          console.error('Failed to send immediate document alert:', alertError);\n        }\n      }\n      \n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid document data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create document\", error: error instanceof Error ? error.message : 'Unknown error' });\n      }\n    }\n  });\n\n  app.put(\"/api/documents/:id\", authenticate, async (req, res) => {\n    try {\n      const updates = insertDocumentSchema.partial().parse(req.body);\n      const document = await storage.updateDocument(req.params.id, updates);\n      \n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      // Trigger immediate alert if document expires within 30 days (check on expiry date update)\n      if (document.expiryDate && updates.expiryDate) {\n        try {\n          const crewMember = await storage.getCrewMember(document.crewMemberId);\n          if (crewMember) {\n            // Get vessel name from crew member's current vessel\n            let vesselName: string | undefined;\n            if (crewMember.currentVesselId) {\n              const vessel = await storage.getVessel(crewMember.currentVesselId);\n              vesselName = vessel?.name;\n            }\n            \n            await notificationService.sendImmediateDocumentAlert(\n              {\n                id: document.id,\n                type: document.type,\n                expiryDate: document.expiryDate,\n                documentNumber: document.documentNumber,\n                issuingAuthority: document.issuingAuthority,\n              },\n              {\n                id: crewMember.id,\n                name: `${crewMember.firstName} ${crewMember.lastName}`,\n                rank: crewMember.rank,\n                nationality: crewMember.nationality,\n              },\n              vesselName\n            );\n          }\n        } catch (alertError) {\n          console.error('Failed to send immediate document alert:', alertError);\n        }\n      }\n      \n      res.json(document);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid update data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to update document\" });\n      }\n    }\n  });\n\n  app.delete(\"/api/documents/:id\", authenticate, async (req, res) => {\n    try {\n      const success = await storage.deleteDocument(req.params.id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      res.json({ message: \"Document deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to delete document\" });\n    }\n  });\n\n  // Download crew document\n  app.get(\"/api/documents/:id/download\", authenticate, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const document = await storage.getDocument(id);\n      \n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n\n      if (!document.filePath) {\n        return res.status(404).json({ message: \"Document file not found\" });\n      }\n\n      // For documents stored in the uploads directory, serve them directly\n      const fs = await import('fs');\n      const path = await import('path');\n      \n      // Remove leading slash if present to create relative path\n      const relativePath = document.filePath.startsWith('/') ? document.filePath.slice(1) : document.filePath;\n      const fullPath = path.resolve(relativePath);\n      \n      // Check if file exists, if not create it from a template\n      if (!fs.existsSync(fullPath)) {\n        console.log(`File not found at ${fullPath}, creating from template...`);\n        \n        // Find an existing PDF file to use as template\n        const templateFiles = fs.readdirSync(uploadsDir).filter(file => file.endsWith('.pdf'));\n        if (templateFiles.length > 0) {\n          const templatePath = path.join(uploadsDir, templateFiles[0]);\n          try {\n            fs.copyFileSync(templatePath, fullPath);\n            console.log(`Created missing file: ${fullPath}`);\n          } catch (error) {\n            console.error(`Failed to create missing file: ${error}`);\n            return res.status(404).json({ message: \"Document file not found on disk\" });\n          }\n        } else {\n          return res.status(404).json({ message: \"Document file not found on disk\" });\n        }\n      }\n\n      // Set appropriate headers\n      res.set({\n        \"Content-Type\": \"application/pdf\",\n        \"Cache-Control\": \"private, max-age=3600\",\n        \"Content-Disposition\": `inline; filename=\"${document.documentNumber || 'document'}.pdf\"`\n      });\n\n      // Stream the file\n      const fileStream = fs.createReadStream(fullPath);\n      fileStream.pipe(res);\n      \n      fileStream.on('error', (error) => {\n        console.error(\"Error streaming document:\", error);\n        if (!res.headersSent) {\n          res.status(500).json({ message: \"Failed to stream document\" });\n        }\n      });\n\n    } catch (error) {\n      console.error(\"Error downloading crew document:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ message: \"Failed to download document\" });\n      }\n    }\n  });\n\n  // Contract routes\n  app.get(\"/api/contracts\", authenticate, async (req, res) => {\n    try {\n      const { crewMemberId } = req.query;\n      let contracts;\n      \n      if (crewMemberId) {\n        contracts = await storage.getContractsByCrewMember(crewMemberId as string);\n      } else {\n        contracts = await storage.getContracts();\n      }\n      \n      res.json(contracts);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch contracts\" });\n    }\n  });\n\n  app.post(\"/api/contracts\", authenticate, async (req, res) => {\n    try {\n      const contractData = insertContractSchema.parse(req.body);\n      const contract = await storage.createContract(contractData);\n      \n      // Trigger immediate alert if contract expires within 30 days\n      if (contract.endDate) {\n        try {\n          const crewMember = await storage.getCrewMember(contract.crewMemberId);\n          if (crewMember) {\n            // Get vessel name from crew member's current vessel\n            let vesselName: string | undefined;\n            if (crewMember.currentVesselId) {\n              const vessel = await storage.getVessel(crewMember.currentVesselId);\n              vesselName = vessel?.name;\n            }\n            \n            await notificationService.sendImmediateContractAlert(\n              {\n                id: contract.id,\n                endDate: contract.endDate,\n                status: contract.status,\n              },\n              {\n                id: crewMember.id,\n                name: `${crewMember.firstName} ${crewMember.lastName}`,\n                rank: crewMember.rank,\n                nationality: crewMember.nationality,\n              },\n              vesselName\n            );\n          }\n        } catch (alertError) {\n          console.error('Failed to send immediate contract alert:', alertError);\n        }\n      }\n      \n      res.json(contract);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid contract data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create contract\" });\n      }\n    }\n  });\n\n  app.put(\"/api/contracts/:id\", authenticate, async (req, res) => {\n    try {\n      console.log('Updating contract:', req.params.id, 'with data:', req.body);\n      \n      const updates = insertContractSchema.partial().parse(req.body);\n      console.log('Parsed contract updates:', updates);\n      \n      const contract = await storage.updateContract(req.params.id, updates);\n      console.log('Updated contract result:', contract);\n      \n      if (!contract) {\n        return res.status(404).json({ message: \"Contract not found\" });\n      }\n      \n      // Log the contract update activity\n      try {\n        await db.insert(activityLogs).values({\n          type: 'Contract Management',\n          action: 'update',\n          entityType: 'contract',\n          entityId: req.params.id,\n          userId: null,\n          username: req.user?.username || 'System',\n          userRole: req.user?.role || 'admin',\n          description: `Contract updated - Start: ${contract.startDate}, End: ${contract.endDate}, Status: ${contract.status}`,\n          severity: 'info',\n          metadata: {\n            contractId: contract.id,\n            crewMemberId: contract.crewMemberId,\n            startDate: contract.startDate?.toISOString(),\n            endDate: contract.endDate?.toISOString(),\n            status: contract.status,\n            changes: Object.keys(updates)\n          }\n        });\n        console.log('Contract update activity logged successfully');\n      } catch (logError) {\n        console.error('Failed to log contract update activity:', logError);\n      }\n      \n      // Trigger immediate alert if contract expires within 30 days (check on end date update)\n      if (contract.endDate && updates.endDate) {\n        try {\n          const crewMember = await storage.getCrewMember(contract.crewMemberId);\n          if (crewMember) {\n            // Get vessel name from crew member's current vessel\n            let vesselName: string | undefined;\n            if (crewMember.currentVesselId) {\n              const vessel = await storage.getVessel(crewMember.currentVesselId);\n              vesselName = vessel?.name;\n            }\n            \n            await notificationService.sendImmediateContractAlert(\n              {\n                id: contract.id,\n                endDate: contract.endDate,\n                status: contract.status,\n              },\n              {\n                id: crewMember.id,\n                name: `${crewMember.firstName} ${crewMember.lastName}`,\n                rank: crewMember.rank,\n                nationality: crewMember.nationality,\n              },\n              vesselName\n            );\n          }\n        } catch (alertError) {\n          console.error('Failed to send immediate contract alert:', alertError);\n        }\n      }\n      \n      res.json(contract);\n    } catch (error) {\n      console.error('Error updating contract:', error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid contract data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to update contract\" });\n      }\n    }\n  });\n\n  // Crew rotation routes\n  app.get(\"/api/rotations\", authenticate, async (req, res) => {\n    try {\n      // Add cache control headers to prevent stale data\n      res.set({\n        'Cache-Control': 'no-store, no-cache, must-revalidate',\n        'Pragma': 'no-cache',\n        'Vary': 'Authorization'\n      });\n      \n      const { vesselId } = req.query;\n      let rotations;\n      \n      if (vesselId) {\n        rotations = await storage.getCrewRotationsByVessel(vesselId as string);\n      } else {\n        rotations = await storage.getCrewRotations();\n      }\n      \n      res.json(rotations);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch rotations\" });\n    }\n  });\n\n  app.post(\"/api/rotations\", authenticate, async (req, res) => {\n    try {\n      // Transform date strings to Date objects before validation\n      const transformedData = {\n        ...req.body,\n        joinDate: req.body.joinDate ? new Date(req.body.joinDate) : undefined,\n        leaveDate: req.body.leaveDate ? new Date(req.body.leaveDate) : undefined,\n      };\n      \n      const rotationData = insertCrewRotationSchema.parse(transformedData);\n      const rotation = await storage.createCrewRotation(rotationData);\n      res.json(rotation);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid rotation data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create rotation\" });\n      }\n    }\n  });\n\n  app.patch(\"/api/rotations/:id\", authenticate, async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      console.log('Updating rotation:', id, req.body);\n      \n      // Extract only the fields that can be updated, excluding id and createdAt\n      const { id: _, createdAt, ...updateFields } = req.body;\n      \n      // Transform date strings to Date objects before validation\n      const transformedData = {\n        ...updateFields,\n        joinDate: updateFields.joinDate ? new Date(updateFields.joinDate) : undefined,\n        leaveDate: updateFields.leaveDate ? new Date(updateFields.leaveDate) : undefined,\n      };\n\n      console.log('Transformed data:', transformedData);\n\n      const rotation = await storage.updateCrewRotation(id, transformedData);\n      if (!rotation) {\n        return res.status(404).json({ message: \"Rotation not found\" });\n      }\n      res.json(rotation);\n    } catch (error) {\n      console.error('Error updating rotation:', error);\n      res.status(500).json({ message: \"Failed to update rotation\", error: String(error) });\n    }\n  });\n\n  app.delete(\"/api/rotations/:id\", authenticate, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { reason, deletedBy } = req.body;\n      \n      // Delete the rotation\n      const success = await storage.deleteCrewRotation(id);\n      if (!success) {\n        return res.status(404).json({ message: \"Rotation not found\" });\n      }\n      \n      // Log the deletion activity\n      if (req.user) {\n        await storage.createActivityLog({\n          userId: req.user.id,\n          action: 'delete',\n          entity: 'rotation',\n          entityId: id,\n          details: `Deleted vessel history record. Reason: ${reason || 'Not provided'}. Deleted by: ${deletedBy || req.user.username}`,\n        });\n      }\n      \n      res.json({ message: \"Rotation deleted successfully\" });\n    } catch (error) {\n      console.error('Error deleting rotation:', error);\n      res.status(500).json({ message: \"Failed to delete rotation\" });\n    }\n  });\n\n  // WhatsApp Settings routes\n  app.get(\"/api/whatsapp-settings\", authenticate, async (req, res) => {\n    try {\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n      \n      const settings = await storage.getWhatsappSettings();\n      \n      // Redact sensitive information\n      const sanitizedSettings = settings ? {\n        ...settings,\n        apiKey: settings.apiKey ? '***REDACTED***' : null,\n        webhookUrl: settings.webhookUrl ? '***REDACTED***' : null,\n      } : null;\n      \n      res.json(sanitizedSettings);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch WhatsApp settings\" });\n    }\n  });\n\n  app.put(\"/api/whatsapp-settings\", authenticate, async (req, res) => {\n    try {\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Admin access required\" });\n      }\n      \n      const settingsData = insertWhatsappSettingsSchema.parse(req.body);\n      const settings = await storage.updateWhatsappSettings(settingsData);\n      res.json(settings);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid settings data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to update WhatsApp settings\" });\n      }\n    }\n  });\n\n  // Alerts routes\n  app.get(\"/api/alerts/expiring-documents\", authenticate, async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 30;\n      const alerts = await storage.getExpiringDocuments(days);\n      res.json(alerts);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch expiring documents\" });\n    }\n  });\n\n  app.get(\"/api/alerts/expiring-vessel-documents\", authenticate, async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 30;\n      const alerts = await storage.getExpiringVesselDocuments(days);\n      res.json(alerts);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch expiring vessel documents\" });\n    }\n  });\n\n  app.get(\"/api/alerts/expiring-contracts\", authenticate, async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 90;\n      const alerts = await storage.getExpiringContracts(days);\n      res.json(alerts);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch expiring contracts\" });\n    }\n  });\n\n  // Dashboard stats\n  app.get(\"/api/dashboard/stats\", authenticate, async (req, res) => {\n    try {\n      const crewMembers = await storage.getCrewMembers();\n      const vessels = await storage.getVessels();\n      const expiringAlerts = await storage.getExpiringDocuments(30);\n      const contracts = await storage.getContracts();\n      \n      const activeCrew = crewMembers.filter(member => member.status === 'onBoard').length;\n      const activeVessels = vessels.filter(vessel => \n        ['harbour-mining', 'coastal-mining', 'world-wide', 'oil-field', 'line-up-mining'].includes(vessel.status)\n      ).length;\n      const pendingActions = expiringAlerts.length;\n      \n      // Calculate crew on shore count\n      const crewOnShore = crewMembers.filter(member => member.status === 'onShore').length;\n      \n      const allDocuments = await storage.getDocuments();\n      \n      // Calculate compliance rate (documents not expiring soon)\n      const validDocuments = allDocuments.filter(doc => doc.status === 'valid').length;\n      const complianceRate = allDocuments.length > 0 ? (validDocuments / allDocuments.length) * 100 : 100;\n      \n      res.json({\n        activeCrew,\n        activeVessels,\n        pendingActions,\n        crewOnShore,\n        complianceRate: Math.round(complianceRate * 10) / 10,\n        totalContracts: contracts.length,\n        totalDocuments: allDocuments.length\n      });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch dashboard stats\" });\n    }\n  });\n\n  // Upcoming events endpoint\n  app.get(\"/api/upcoming-events\", authenticate, async (req, res) => {\n    try {\n      const days = parseInt(req.query.days as string) || 30;\n      const limit = parseInt(req.query.limit as string) || 10;\n      const currentDate = new Date();\n      const futureDate = new Date();\n      futureDate.setDate(currentDate.getDate() + days);\n\n      const events: Array<{\n        id: string;\n        type: string;\n        title: string;\n        description: string;\n        date: Date;\n        severity: 'success' | 'info' | 'warning' | 'high';\n        crewMemberId?: string;\n        vesselId?: string;\n        contractId?: string;\n        documentId?: string;\n        documentType?: string;\n        rotationId?: string;\n      }> = [];\n      \n      const [vessels, crewMembers, contracts, documents, crewRotations] = await Promise.all([\n        storage.getVessels(),\n        storage.getCrewMembers(),\n        storage.getContracts(),\n        storage.getDocuments(),\n        storage.getCrewRotations()\n      ]);\n\n      // Contract renewals/expirations\n      contracts.forEach(contract => {\n        if (contract.status === 'active' && contract.endDate >= currentDate && contract.endDate <= futureDate) {\n          const crewMember = crewMembers.find(c => c.id === contract.crewMemberId);\n          const vessel = vessels.find(v => v.id === contract.vesselId);\n          \n          const daysUntil = Math.ceil((contract.endDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n          \n          events.push({\n            id: `contract-${contract.id}`,\n            type: 'contract_expiry',\n            title: 'Contract Expiring',\n            description: `${crewMember?.firstName} ${crewMember?.lastName} - ${vessel?.name} (${daysUntil} days)`,\n            date: contract.endDate,\n            severity: daysUntil <= 7 ? 'high' : daysUntil <= 15 ? 'warning' : 'info',\n            crewMemberId: contract.crewMemberId,\n            vesselId: contract.vesselId,\n            contractId: contract.id\n          });\n        }\n      });\n\n      // Document expirations\n      documents.forEach(document => {\n        if ((document.status === 'valid' || document.status === 'expiring') && document.expiryDate >= currentDate && document.expiryDate <= futureDate) {\n          const crewMember = crewMembers.find(c => c.id === document.crewMemberId);\n          \n          const daysUntil = Math.ceil((document.expiryDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n          \n          events.push({\n            id: `document-${document.id}`,\n            type: 'document_expiry',\n            title: 'Document Expiring',\n            description: `${crewMember?.firstName} ${crewMember?.lastName} - ${document.type.toUpperCase()} (${daysUntil} days)`,\n            date: document.expiryDate,\n            severity: daysUntil <= 7 ? 'high' : daysUntil <= 15 ? 'warning' : 'info',\n            crewMemberId: document.crewMemberId,\n            documentId: document.id,\n            documentType: document.type\n          });\n        }\n      });\n\n      // Crew rotations (joins and leaves)\n      crewRotations.forEach(rotation => {\n        if (rotation.status === 'scheduled') {\n          const crewMember = crewMembers.find(c => c.id === rotation.crewMemberId);\n          const vessel = vessels.find(v => v.id === rotation.vesselId);\n          \n          // Join events\n          if (rotation.joinDate >= currentDate && rotation.joinDate <= futureDate) {\n            const daysUntil = Math.ceil((rotation.joinDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n            \n            events.push({\n              id: `join-${rotation.id}`,\n              type: 'crew_join',\n              title: 'Crew Joining',\n              description: `${crewMember?.firstName} ${crewMember?.lastName} joins ${vessel?.name} (${daysUntil} days)`,\n              date: rotation.joinDate,\n              severity: daysUntil <= 3 ? 'warning' : 'info',\n              crewMemberId: rotation.crewMemberId,\n              vesselId: rotation.vesselId,\n              rotationId: rotation.id\n            });\n          }\n          \n          // Leave events\n          if (rotation.leaveDate && rotation.leaveDate >= currentDate && rotation.leaveDate <= futureDate) {\n            const daysUntil = Math.ceil((rotation.leaveDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n            \n            events.push({\n              id: `leave-${rotation.id}`,\n              type: 'crew_leave',\n              title: 'Crew Leaving',\n              description: `${crewMember?.firstName} ${crewMember?.lastName} leaves ${vessel?.name} (${daysUntil} days)`,\n              date: rotation.leaveDate,\n              severity: daysUntil <= 3 ? 'warning' : 'info',\n              crewMemberId: rotation.crewMemberId,\n              vesselId: rotation.vesselId,\n              rotationId: rotation.id\n            });\n          }\n        }\n      });\n\n      // Maintenance schedules (vessel status changes)\n      vessels.forEach(vessel => {\n        if (vessel.status === 'maintenance') {\n          // For demonstration, add maintenance completion events\n          const maintenanceCompletion = new Date();\n          maintenanceCompletion.setDate(currentDate.getDate() + Math.floor(Math.random() * 14) + 1);\n          \n          if (maintenanceCompletion <= futureDate) {\n            const daysUntil = Math.ceil((maintenanceCompletion.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));\n            \n            events.push({\n              id: `maintenance-${vessel.id}`,\n              type: 'maintenance_completion',\n              title: 'Maintenance Completion',\n              description: `${vessel.name} maintenance scheduled to complete (${daysUntil} days)`,\n              date: maintenanceCompletion,\n              severity: 'info',\n              vesselId: vessel.id\n            });\n          }\n        }\n      });\n\n      // Sort events by date and limit results\n      const sortedEvents = events\n        .sort((a, b) => a.date.getTime() - b.date.getTime())\n        .slice(0, limit);\n\n      // Note: WhatsApp notifications are handled by a separate background service\n      // to prevent spam and ensure reliable delivery with deduplication\n\n      res.json(sortedEvents);\n    } catch (error) {\n      console.error('Failed to fetch upcoming events:', error);\n      res.status(500).json({ message: \"Failed to fetch upcoming events\" });\n    }\n  });\n\n  // Email settings routes\n  app.get(\"/api/email-settings\", authenticate, async (req, res) => {\n    try {\n      const settings = await storage.getEmailSettings();\n      res.json(settings);\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to fetch email settings\" });\n    }\n  });\n\n  app.put(\"/api/email-settings\", authenticate, async (req, res) => {\n    try {\n      const settingsData = insertEmailSettingsSchema.parse(req.body);\n      const settings = await storage.updateEmailSettings(settingsData);\n      res.json(settings);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid settings data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to update email settings\" });\n      }\n    }\n  });\n\n  // Test email sending endpoint\n  app.post(\"/api/email/send-test\", authenticate, async (req, res) => {\n    try {\n      // Get recipient email from settings instead of requiring it in request\n      const settings = await storage.getEmailSettings();\n      const recipientEmail = settings?.recipientEmail;\n      \n      if (!recipientEmail) {\n        return res.status(400).json({ message: \"No recipient email configured in settings. Please configure a recipient email in notification settings.\" });\n      }\n\n      console.log(\"Sending test email to:\", recipientEmail);\n      \n      // Import SendGrid email service for real email delivery\n      const { sendGridEmailService } = await import('./services/sendgrid-email-service');\n      \n      // Use SendGrid's built-in test email method\n      const result = await sendGridEmailService.sendTestEmail(recipientEmail);\n      \n      if (result.success) {\n        res.json({ message: \"Test email sent successfully! Check your inbox.\" });\n      } else {\n        res.status(500).json({ message: `Failed to send test email: ${result.error || 'Please check your SendGrid configuration.'}` });\n      }\n    } catch (error) {\n      console.error('Test email error:', error);\n      res.status(500).json({ \n        message: \"Failed to send test email\", \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  });\n\n  // Test Medical Certificate expiry alert endpoint\n  app.post(\"/api/email/test-medical-alert\", authenticate, async (req, res) => {\n    try {\n      const settings = await storage.getEmailSettings();\n      const recipientEmail = settings?.recipientEmail || 'admin@offing.biz';\n      \n      const { sendMedicalExpiryAlert } = await import('./services/smtp-email-service');\n      \n      const testData = {\n        crewMemberName: 'Test Crew Member',\n        crewMemberRank: 'Captain',\n        crewMemberNationality: 'Philippines',\n        vesselName: 'MV Test Vessel',\n        medicalNumber: 'MED-2024-001',\n        issuingAuthority: 'Maritime Medical Center',\n        expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),\n        daysUntilExpiry: 30,\n      };\n      \n      console.log(\"Sending test Medical Certificate alert to:\", recipientEmail);\n      const result = await sendMedicalExpiryAlert(recipientEmail, testData);\n      \n      if (result.success) {\n        res.json({ message: \"Medical Certificate expiry alert sent successfully!\" });\n      } else {\n        res.status(500).json({ message: `Failed to send Medical Certificate alert: ${result.error || 'Unknown error'}` });\n      }\n    } catch (error) {\n      console.error('Test medical alert error:', error);\n      res.status(500).json({ message: \"Failed to send alert\", error: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  // Test upcoming events email endpoint\n  app.post(\"/api/email/send-upcoming-events\", authenticate, async (req, res) => {\n    try {\n      // Only allow admin users to send emails\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Access denied. Admin role required.\" });\n      }\n      \n      const settings = await storage.getEmailSettings();\n      if (!settings?.recipientEmail) {\n        return res.status(400).json({ message: \"No recipient email configured\" });\n      }\n\n      console.log(\"Sending upcoming events email to:\", settings.recipientEmail);\n      \n      // Fetch real upcoming events from database (next 60 days)\n      const [expiringDocuments, expiringContracts, crewRotations, vessels, crewMembers] = await Promise.all([\n        storage.getExpiringDocuments(60),\n        storage.getExpiringContracts(60),\n        storage.getCrewRotations(),\n        storage.getVessels(),\n        storage.getCrewMembers()\n      ]);\n\n      type UpcomingEvent = {\n        type: string;\n        crewMemberName: string;\n        vesselName?: string;\n        documentType?: string;\n        date: Date;\n        severity: string;\n        rotationType?: string;\n      };\n\n      const upcomingEvents: UpcomingEvent[] = [];\n      const now = new Date();\n      const futureDate = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000);\n\n      // Add document expiries\n      for (const alert of expiringDocuments) {\n        const daysUntil = alert.daysUntilExpiry;\n        let severity = 'low';\n        if (daysUntil <= 3) severity = 'critical';\n        else if (daysUntil <= 7) severity = 'high';\n        else if (daysUntil <= 15) severity = 'medium';\n\n        upcomingEvents.push({\n          type: 'document_expiry',\n          crewMemberName: `${alert.crewMember.firstName} ${alert.crewMember.lastName}`,\n          documentType: alert.document.type,\n          date: alert.document.expiryDate!,\n          severity\n        });\n      }\n\n      // Add contract expiries\n      for (const alert of expiringContracts) {\n        const daysUntil = alert.daysUntilExpiry;\n        let severity = 'low';\n        if (daysUntil <= 3) severity = 'critical';\n        else if (daysUntil <= 7) severity = 'high';\n        else if (daysUntil <= 15) severity = 'medium';\n\n        upcomingEvents.push({\n          type: 'contract_expiry',\n          crewMemberName: `${alert.crewMember.firstName} ${alert.crewMember.lastName}`,\n          vesselName: alert.vessel.name,\n          date: alert.contract.endDate,\n          severity\n        });\n      }\n\n      // Add crew rotations (join/leave dates within next 30 days)\n      for (const rotation of crewRotations) {\n        const crewMember = crewMembers.find(c => c.id === rotation.crewMemberId);\n        const vessel = vessels.find(v => v.id === rotation.vesselId);\n        if (!crewMember || !vessel) continue;\n\n        // Check join date\n        if (rotation.joinDate && rotation.joinDate >= now && rotation.joinDate <= futureDate) {\n          const daysUntil = Math.ceil((rotation.joinDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n          let severity = 'low';\n          if (daysUntil <= 3) severity = 'high';\n          else if (daysUntil <= 7) severity = 'medium';\n\n          upcomingEvents.push({\n            type: 'crew_rotation',\n            crewMemberName: `${crewMember.firstName} ${crewMember.lastName}`,\n            vesselName: vessel.name,\n            date: rotation.joinDate,\n            rotationType: 'join',\n            severity\n          });\n        }\n\n        // Check leave date\n        if (rotation.leaveDate && rotation.leaveDate >= now && rotation.leaveDate <= futureDate) {\n          const daysUntil = Math.ceil((rotation.leaveDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n          let severity = 'low';\n          if (daysUntil <= 3) severity = 'high';\n          else if (daysUntil <= 7) severity = 'medium';\n\n          upcomingEvents.push({\n            type: 'crew_rotation',\n            crewMemberName: `${crewMember.firstName} ${crewMember.lastName}`,\n            vesselName: vessel.name,\n            date: rotation.leaveDate,\n            rotationType: 'leave',\n            severity\n          });\n        }\n      }\n\n      // Sort by date (soonest first)\n      upcomingEvents.sort((a, b) => a.date.getTime() - b.date.getTime());\n\n      if (upcomingEvents.length === 0) {\n        return res.json({ \n          message: \"No upcoming events found in the next 60 days. Email not sent.\" \n        });\n      }\n      \n      // Import SMTP email service (using Gmail)\n      const { smtpEmailService } = await import('./services/smtp-email-service');\n      \n      // Create comprehensive upcoming events email\n      const upcomingEventsHtml = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n          <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n            <div style=\"text-align: center; margin-bottom: 30px;\">\n              <h1 style=\"color: #1f2937; margin: 0; font-size: 24px;\">üìã Upcoming Events Report</h1>\n              <p style=\"color: #6b7280; margin: 10px 0 0 0;\">Crew Management System - Next 60 Days</p>\n            </div>\n            \n            <div style=\"margin-bottom: 20px;\">\n              <h2 style=\"color: #1f2937; font-size: 18px; margin-bottom: 15px;\">Summary</h2>\n              <p style=\"color: #374151; line-height: 1.5;\">\n                This report contains ${upcomingEvents.length} upcoming events requiring attention:\n              </p>\n              <ul style=\"color: #374151; margin: 10px 0;\">\n                <li>${upcomingEvents.filter(e => e.type === 'contract_expiry').length} Contract Expiries</li>\n                <li>${upcomingEvents.filter(e => e.type === 'document_expiry').length} Document Expiries</li>\n                <li>${upcomingEvents.filter(e => e.type === 'crew_rotation').length} Crew Rotations</li>\n              </ul>\n            </div>\n\n            ${upcomingEvents.map((event, index) => {\n              const severityColors = {\n                critical: '#dc2626',\n                high: '#ea580c', \n                medium: '#d97706',\n                low: '#059669'\n              };\n              const severityBg = {\n                critical: '#fef2f2',\n                high: '#fff7ed',\n                medium: '#fffbeb', \n                low: '#f0fdf4'\n              };\n\n              let title, description, icon;\n              if (event.type === 'contract_expiry') {\n                title = `Contract Expiry - ${event.crewMemberName}`;\n                description = `Contract on vessel ${event.vesselName} expires on ${event.date.toDateString()}`;\n                icon = 'üìã';\n              } else if (event.type === 'document_expiry') {\n                title = `Document Expiry - ${event.crewMemberName}`;\n                description = `${event.documentType} expires on ${event.date.toDateString()}`;\n                icon = 'üìÑ';\n              } else if (event.type === 'crew_rotation') {\n                title = `Crew Rotation - ${event.crewMemberName}`;\n                description = `Scheduled to ${event.rotationType} vessel ${event.vesselName} on ${event.date.toDateString()}`;\n                icon = 'üîÑ';\n              }\n\n              return `\n                <div style=\"background: ${severityBg[event.severity]}; padding: 20px; margin: 15px 0; border-radius: 6px; border-left: 4px solid ${severityColors[event.severity]};\">\n                  <div style=\"display: flex; align-items: center; margin-bottom: 10px;\">\n                    <span style=\"font-size: 20px; margin-right: 10px;\">${icon}</span>\n                    <h3 style=\"color: #1f2937; margin: 0; font-size: 16px;\">${title}</h3>\n                    <span style=\"margin-left: auto; background: ${severityColors[event.severity]}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; text-transform: uppercase; font-weight: bold;\">${event.severity}</span>\n                  </div>\n                  <p style=\"color: #374151; margin: 0; line-height: 1.5;\">${description}</p>\n                  <div style=\"margin-top: 10px; font-size: 14px; color: #6b7280;\">\n                    <strong>Days remaining:</strong> ${Math.ceil((event.date.getTime() - Date.now()) / (1000 * 60 * 60 * 24))} days\n                  </div>\n                </div>\n              `;\n            }).join('')}\n\n            <div style=\"margin-top: 30px; padding: 20px; background: #f3f4f6; border-radius: 6px;\">\n              <h3 style=\"color: #1f2937; margin: 0 0 10px 0; font-size: 16px;\">üìß Notification Settings</h3>\n              <p style=\"color: #6b7280; margin: 0; font-size: 14px;\">\n                This email was sent to: <strong>${settings.recipientEmail}</strong><br>\n                Generated on: ${new Date().toLocaleString()}<br>\n                System: Crew Management Pro\n              </p>\n            </div>\n            \n            <div style=\"text-align: center; margin-top: 30px; padding: 20px 0; border-top: 1px solid #e5e7eb;\">\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n                This is an automated notification from the Crew Management System<br>\n                Please contact your system administrator if you have any questions\n              </p>\n            </div>\n          </div>\n        </div>\n      `;\n\n      const emailContent = {\n        to: settings.recipientEmail,\n        subject: 'üìã Upcoming Events Report - Crew Management System',\n        html: upcomingEventsHtml,\n        text: `Upcoming Events Report - Crew Management System\\n\\n` +\n              `${upcomingEvents.map((event, index) => {\n                let title, description;\n                if (event.type === 'contract_expiry') {\n                  title = `Contract Expiry - ${event.crewMemberName}`;\n                  description = `Contract on vessel ${event.vesselName} expires on ${event.date.toDateString()}`;\n                } else if (event.type === 'document_expiry') {\n                  title = `Document Expiry - ${event.crewMemberName}`;\n                  description = `${event.documentType} expires on ${event.date.toDateString()}`;\n                } else if (event.type === 'crew_rotation') {\n                  title = `Crew Rotation - ${event.crewMemberName}`;\n                  description = `Scheduled to ${event.rotationType} vessel ${event.vesselName} on ${event.date.toDateString()}`;\n                }\n                return `${index + 1}. ${title}\\n   ${description}\\n   Severity: ${event.severity.toUpperCase()}\\n`;\n              }).join('\\n')}`\n      };\n      \n      const result = await smtpEmailService.sendEmail(emailContent);\n      \n      if (result.success) {\n        res.json({ \n          message: `Successfully sent upcoming events report with ${upcomingEvents.length} events to ${settings.recipientEmail}` \n        });\n      } else {\n        res.status(500).json({ \n          message: `Failed to send upcoming events email: ${result.error || 'Unknown error'}` \n        });\n      }\n    } catch (error) {\n      console.error(\"‚ùå Failed to send upcoming events email:\", error);\n      res.status(500).json({ \n        message: \"Failed to send upcoming events email. Please check your Gmail SMTP configuration.\" \n      });\n    }\n  });\n\n  // Send crew member details email endpoint (for testing)\n  app.post(\"/api/email/send-crew-details\", authenticate, async (req, res) => {\n    try {\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Access denied. Admin role required.\" });\n      }\n\n      const { crewMemberId, additionalEmail } = req.body;\n      if (!crewMemberId) {\n        return res.status(400).json({ message: \"Crew member ID required\" });\n      }\n\n      const settings = await storage.getEmailSettings();\n      if (!settings?.recipientEmail) {\n        return res.status(400).json({ message: \"No recipient email configured\" });\n      }\n\n      // Build recipients list\n      const recipients = [settings.recipientEmail];\n      if (additionalEmail) {\n        recipients.push(additionalEmail);\n      }\n\n      // Get crew member details\n      const crewMember = await storage.getCrewMember(crewMemberId);\n      if (!crewMember) {\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n\n      // Get contract details\n      const contracts = await storage.getContracts();\n      const activeContract = contracts.find(c => c.crewMemberId === crewMemberId && c.status === 'active');\n\n      // Get vessel details\n      const vessels = await storage.getVessels();\n      const vessel = vessels.find(v => v.id === crewMember.currentVesselId);\n\n      // Get documents\n      const documents = await storage.getDocuments();\n      const crewDocuments = documents.filter(d => d.crewMemberId === crewMemberId);\n\n      // Use Gmail SMTP service instead of SendGrid\n      const { smtpEmailService } = await import('./services/smtp-email-service');\n\n      const emergencyContact = crewMember.emergencyContact as any;\n\n      const html = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n          <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n            <div style=\"text-align: center; margin-bottom: 30px; border-bottom: 2px solid #0066cc; padding-bottom: 20px;\">\n              <h1 style=\"color: #0066cc; margin: 0; font-size: 24px;\">üë§ Crew Member Details</h1>\n              <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Crew Management System - ${new Date().toLocaleDateString()}</p>\n            </div>\n            \n            <div style=\"background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n              <h2 style=\"color: #0d47a1; margin: 0 0 15px 0; font-size: 18px;\">üìã Personal Information</h2>\n              <table style=\"width: 100%; border-collapse: collapse;\">\n                <tr><td style=\"padding: 8px 0; color: #666;\">Name:</td><td style=\"padding: 8px 0; font-weight: bold;\">${crewMember.firstName} ${crewMember.lastName}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Rank:</td><td style=\"padding: 8px 0; font-weight: bold;\">${crewMember.rank}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Nationality:</td><td style=\"padding: 8px 0;\">${crewMember.nationality}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Date of Birth:</td><td style=\"padding: 8px 0;\">${new Date(crewMember.dateOfBirth).toLocaleDateString()}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Phone:</td><td style=\"padding: 8px 0;\">${crewMember.phoneNumber || 'N/A'}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Email:</td><td style=\"padding: 8px 0;\">${crewMember.email || 'N/A'}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Status:</td><td style=\"padding: 8px 0;\"><span style=\"background: ${crewMember.status === 'onBoard' ? '#28a745' : '#ffc107'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;\">${crewMember.status === 'onBoard' ? 'On Board' : 'On Shore'}</span></td></tr>\n              </table>\n            </div>\n\n            ${vessel ? `\n            <div style=\"background: #fff3e0; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n              <h2 style=\"color: #e65100; margin: 0 0 15px 0; font-size: 18px;\">üö¢ Current Vessel</h2>\n              <table style=\"width: 100%; border-collapse: collapse;\">\n                <tr><td style=\"padding: 8px 0; color: #666;\">Vessel Name:</td><td style=\"padding: 8px 0; font-weight: bold;\">${vessel.name}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Type:</td><td style=\"padding: 8px 0;\">${vessel.type}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Flag:</td><td style=\"padding: 8px 0;\">${vessel.flag}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">IMO Number:</td><td style=\"padding: 8px 0;\">${vessel.imoNumber || 'N/A'}</td></tr>\n              </table>\n            </div>\n            ` : ''}\n\n            ${activeContract ? `\n            <div style=\"background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n              <h2 style=\"color: #2e7d32; margin: 0 0 15px 0; font-size: 18px;\">üìù Active Contract</h2>\n              <table style=\"width: 100%; border-collapse: collapse;\">\n                <tr><td style=\"padding: 8px 0; color: #666;\">Start Date:</td><td style=\"padding: 8px 0;\">${new Date(activeContract.startDate).toLocaleDateString()}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">End Date:</td><td style=\"padding: 8px 0;\">${new Date(activeContract.endDate).toLocaleDateString()}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Duration:</td><td style=\"padding: 8px 0;\">${activeContract.durationDays || Math.ceil((new Date(activeContract.endDate).getTime() - new Date(activeContract.startDate).getTime()) / (1000 * 60 * 60 * 24))} days</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Status:</td><td style=\"padding: 8px 0;\"><span style=\"background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;\">Active</span></td></tr>\n              </table>\n            </div>\n            ` : '<div style=\"background: #ffebee; padding: 20px; border-radius: 8px; margin-bottom: 20px;\"><p style=\"color: #c62828; margin: 0;\">‚ö†Ô∏è No active contract found</p></div>'}\n\n            ${crewDocuments.length > 0 ? `\n            <div style=\"background: #f3e5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n              <h2 style=\"color: #7b1fa2; margin: 0 0 15px 0; font-size: 18px;\">üìÑ Documents</h2>\n              <table style=\"width: 100%; border-collapse: collapse; font-size: 14px;\">\n                <thead>\n                  <tr style=\"background: #e1bee7;\">\n                    <th style=\"padding: 10px; text-align: left;\">Type</th>\n                    <th style=\"padding: 10px; text-align: left;\">Number</th>\n                    <th style=\"padding: 10px; text-align: left;\">Expiry Date</th>\n                    <th style=\"padding: 10px; text-align: left;\">Status</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${crewDocuments.map(doc => {\n                    const isExpired = new Date(doc.expiryDate) < new Date();\n                    const isExpiring = new Date(doc.expiryDate) < new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);\n                    return `\n                    <tr>\n                      <td style=\"padding: 10px; border-bottom: 1px solid #e1bee7; text-transform: uppercase;\">${doc.type}</td>\n                      <td style=\"padding: 10px; border-bottom: 1px solid #e1bee7;\">${doc.documentNumber}</td>\n                      <td style=\"padding: 10px; border-bottom: 1px solid #e1bee7;\">${new Date(doc.expiryDate).toLocaleDateString()}</td>\n                      <td style=\"padding: 10px; border-bottom: 1px solid #e1bee7;\">\n                        <span style=\"background: ${isExpired ? '#dc3545' : isExpiring ? '#ffc107' : '#28a745'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;\">\n                          ${isExpired ? 'Expired' : isExpiring ? 'Expiring Soon' : 'Valid'}\n                        </span>\n                      </td>\n                    </tr>`;\n                  }).join('')}\n                </tbody>\n              </table>\n            </div>\n            ` : ''}\n\n            ${emergencyContact ? `\n            <div style=\"background: #fce4ec; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n              <h2 style=\"color: #c2185b; margin: 0 0 15px 0; font-size: 18px;\">üÜò Emergency Contact</h2>\n              <table style=\"width: 100%; border-collapse: collapse;\">\n                <tr><td style=\"padding: 8px 0; color: #666;\">Name:</td><td style=\"padding: 8px 0; font-weight: bold;\">${emergencyContact.name || 'N/A'}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Relationship:</td><td style=\"padding: 8px 0;\">${emergencyContact.relationship || 'N/A'}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Phone:</td><td style=\"padding: 8px 0;\">${emergencyContact.phone || 'N/A'}</td></tr>\n                <tr><td style=\"padding: 8px 0; color: #666;\">Email:</td><td style=\"padding: 8px 0;\">${emergencyContact.email || 'N/A'}</td></tr>\n              </table>\n            </div>\n            ` : ''}\n\n            <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;\">\n              <p style=\"color: #6c757d; font-size: 14px; margin: 0;\">\n                This email was sent from your Crew Management System\n              </p>\n              <p style=\"color: #6c757d; font-size: 12px; margin: 5px 0 0 0;\">\n                Generated: ${new Date().toLocaleString()}\n              </p>\n            </div>\n          </div>\n        </div>\n      `;\n\n      const result = await smtpEmailService.sendEmail({\n        to: recipients.join(', '),\n        subject: `üë§ Crew Details: ${crewMember.firstName} ${crewMember.lastName} - ${crewMember.rank}`,\n        html,\n        text: `Crew Member Details\\n\\nName: ${crewMember.firstName} ${crewMember.lastName}\\nRank: ${crewMember.rank}\\nNationality: ${crewMember.nationality}\\nStatus: ${crewMember.status}\\n${vessel ? `\\nCurrent Vessel: ${vessel.name}` : ''}\\n${activeContract ? `\\nContract: ${new Date(activeContract.startDate).toLocaleDateString()} - ${new Date(activeContract.endDate).toLocaleDateString()}` : ''}`\n      });\n\n      if (result.success) {\n        res.json({ \n          message: `Successfully sent crew details for ${crewMember.firstName} ${crewMember.lastName} to ${recipients.join(', ')}` \n        });\n      } else {\n        res.status(500).json({ message: `Failed to send email: ${result.error || 'Unknown error'}` });\n      }\n    } catch (error) {\n      console.error(\"‚ùå Failed to send crew details email:\", error);\n      res.status(500).json({ message: \"Failed to send crew details email\" });\n    }\n  });\n\n  // Contact crew member endpoint\n  app.post(\"/api/crew/contact\", authenticate, async (req, res) => {\n    try {\n      const { crewMemberId, subject, message } = req.body;\n      \n      if (!crewMemberId || !subject || !message) {\n        return res.status(400).json({ message: \"Missing required fields\" });\n      }\n      \n      // Get crew member details\n      const crewMember = await storage.getCrewMember(crewMemberId);\n      if (!crewMember) {\n        return res.status(404).json({ message: \"Crew member not found\" });\n      }\n      \n      // In a real app, this would send an actual email\n      console.log(`Sending message to crew member ${crewMember.firstName} ${crewMember.lastName}:`);\n      console.log(`Subject: ${subject}`);\n      console.log(`Message: ${message}`);\n      \n      // Simulate email sending delay\n      await new Promise(resolve => setTimeout(resolve, 800));\n      \n      res.json({ \n        message: \"Message sent successfully\",\n        recipient: `${crewMember.firstName} ${crewMember.lastName}`,\n        subject,\n        sentAt: new Date().toISOString()\n      });\n    } catch (error) {\n      console.error('Error sending crew contact message:', error);\n      res.status(500).json({ message: \"Failed to send message\" });\n    }\n  });\n\n  // System activity report endpoint\n  app.get('/api/system/activity-report', authenticate, async (req, res) => {\n    try {\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: 'Admin access required' });\n      }\n\n      // Get activity logs directly from database\n      const activities = await db\n        .select()\n        .from(activityLogs)\n        .orderBy(sql`${activityLogs.createdAt} DESC`);\n\n      res.json(activities);\n    } catch (error) {\n      console.error('Error generating activity report:', error);\n      res.status(500).json({ message: 'Failed to generate activity report', error: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  // Status change history endpoint\n  app.get('/api/status-change-history', authenticate, async (req, res) => {\n    try {\n      // Get all status change history with crew and vessel details\n      const history = await db\n        .select({\n          id: statusChangeHistory.id,\n          crewMemberId: statusChangeHistory.crewMemberId,\n          previousStatus: statusChangeHistory.previousStatus,\n          newStatus: statusChangeHistory.newStatus,\n          reason: statusChangeHistory.reason,\n          changedBy: statusChangeHistory.changedBy,\n          changedByUsername: statusChangeHistory.changedByUsername,\n          vesselId: statusChangeHistory.vesselId,\n          contractId: statusChangeHistory.contractId,\n          createdAt: statusChangeHistory.createdAt,\n          crewMember: {\n            id: crewMembers.id,\n            firstName: crewMembers.firstName,\n            lastName: crewMembers.lastName,\n            rank: crewMembers.rank,\n            nationality: crewMembers.nationality,\n            status: crewMembers.status,\n          },\n          vessel: {\n            id: vessels.id,\n            name: vessels.name,\n            type: vessels.type,\n          },\n        })\n        .from(statusChangeHistory)\n        .leftJoin(crewMembers, sql`${statusChangeHistory.crewMemberId} = ${crewMembers.id}`)\n        .leftJoin(vessels, sql`${statusChangeHistory.vesselId} = ${vessels.id}`)\n        .orderBy(sql`${statusChangeHistory.createdAt} DESC`);\n\n      res.json(history);\n    } catch (error) {\n      console.error('Error fetching status change history:', error);\n      res.status(500).json({ message: 'Failed to fetch status change history', error: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  // OCR route for extracting crew data from documents\n  app.post(\"/api/ocr/extract-crew-data\", authenticate, async (req, res) => {\n    try {\n      console.log('OCR request received from user:', req.user?.username);\n      const { image, filename } = req.body;\n      \n      if (!image) {\n        console.log('No image data provided in request');\n        return res.status(400).json({ message: \"Image data is required\" });\n      }\n\n      console.log('Processing OCR request for file:', filename);\n      \n      let extractedData;\n      \n      // Use Groq Vision AI if available for better accuracy\n      if (groqOcrService.isAvailable()) {\n        console.log('Using Groq Vision AI for OCR extraction');\n        try {\n          extractedData = await groqOcrService.extractCrewDataWithRecord(image, filename);\n        } catch (groqError) {\n          console.error('Groq Vision failed, falling back to local OCR:', groqError);\n          extractedData = await localOcrService.extractCrewDataWithRecord(image, filename);\n        }\n      } else {\n        console.log('Using local Tesseract OCR');\n        extractedData = await localOcrService.extractCrewDataWithRecord(image, filename);\n      }\n      \n      // Log the OCR activity\n      try {\n        await db.insert(activityLogs).values({\n          type: \"Document Processing\",\n          action: \"ocr_document_scan\",\n          entityType: \"document\",\n          description: `Scanned crew document: ${filename || 'Unknown file'}`,\n          severity: \"info\",\n          username: req.user?.username || \"unknown\",  \n          userRole: req.user?.role || \"unknown\",\n          metadata: JSON.stringify({ filename, extractedFields: Object.keys(extractedData).length })\n        });\n      } catch (logError) {\n        console.error(\"Failed to log OCR activity:\", logError);\n      }\n\n      res.json(extractedData);\n    } catch (error) {\n      console.error(\"OCR extraction error:\", error);\n      res.status(500).json({ \n        message: error instanceof Error ? error.message : \"Failed to extract data from document\" \n      });\n    }\n  });\n\n  // File upload handler with multipart form data\n  \n  // Configure multer for file uploads\n  const multerStorage = multer.diskStorage({\n    destination: (req: any, file: any, cb: any) => {\n      const uploadsDir = path.join(process.cwd(), 'uploads');\n      if (!fs.existsSync(uploadsDir)) {\n        fs.mkdirSync(uploadsDir, { recursive: true });\n      }\n      cb(null, uploadsDir);\n    },\n    filename: (req: any, file: any, cb: any) => {\n      // Create a unique filename with timestamp\n      const timestamp = Date.now();\n      const sanitizedOriginalName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');\n      cb(null, `${timestamp}-${sanitizedOriginalName}`);\n    }\n  });\n  \n  const upload = multer({ \n    storage: multerStorage,\n    limits: {\n      fileSize: 10 * 1024 * 1024 // 10MB limit\n    },\n    fileFilter: (req: any, file: any, cb: any) => {\n      // Allow PDF files and common image formats\n      if (file.mimetype === 'application/pdf' || \n          file.mimetype.startsWith('image/')) {\n        cb(null, true);\n      } else {\n        cb(new Error('Only PDF and image files are allowed'), false);\n      }\n    }\n  });\n\n  // Handle both multipart file uploads and JSON requests\n  app.post(\"/api/upload\", authenticate, (req: any, res, next) => {\n    // Check if request is multipart (has actual file)\n    const isMultipart = req.headers['content-type']?.includes('multipart/form-data');\n    \n    if (isMultipart) {\n      // Use multer for actual file uploads\n      upload.single('file')(req, res, next);\n    } else {\n      // Handle JSON requests (legacy format)\n      next();\n    }\n  }, async (req: any, res) => {\n    try {\n      if (req.file) {\n        // Real file uploaded via multipart\n        const filePath = `/uploads/${req.file.filename}`;\n        res.json({ \n          message: \"File uploaded successfully\",\n          filePath: filePath \n        });\n      } else if (req.body.filename && req.body.fileType) {\n        // JSON request with file metadata (legacy format)\n        // Create a mock file path for now - this maintains compatibility\n        const timestamp = Date.now();\n        const sanitizedFilename = req.body.filename.replace(/[^a-zA-Z0-9.-]/g, '_');\n        const mockFilePath = `/uploads/${timestamp}-${sanitizedFilename}`;\n        \n        res.json({ \n          message: \"File uploaded successfully\",\n          filePath: mockFilePath \n        });\n      } else {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n    } catch (error) {\n      console.error(\"File upload error:\", error);\n      res.status(500).json({ message: \"File upload failed\" });\n    }\n  });\n\n  // Vessel document routes\n  app.get(\"/api/vessels/:vesselId/documents\", authenticate, async (req, res) => {\n    try {\n      const { vesselId } = req.params;\n      const documents = await storage.getVesselDocuments(vesselId);\n      res.json(documents);\n    } catch (error) {\n      console.error(\"Error fetching vessel documents:\", error);\n      res.status(500).json({ message: \"Failed to fetch vessel documents\" });\n    }\n  });\n\n  // Get upload URL for vessel document\n  app.post(\"/api/vessels/:vesselId/documents/upload-url\", authenticate, async (req, res) => {\n    try {\n      const { vesselId } = req.params;\n      const { fileName } = req.body;\n      \n      if (!fileName) {\n        return res.status(400).json({ message: \"fileName is required\" });\n      }\n\n      const documentStorageService = new VesselDocumentStorageService();\n      const uploadURL = await documentStorageService.getVesselDocumentUploadURL(vesselId, fileName);\n      \n      res.json({ uploadURL });\n    } catch (error) {\n      console.error(\"Error generating upload URL:\", error);\n      res.status(500).json({ message: \"Failed to generate upload URL\" });\n    }\n  });\n\n  app.post(\"/api/vessels/:vesselId/documents\", authenticate, async (req, res) => {\n    try {\n      const { vesselId } = req.params;\n      const documentStorageService = new VesselDocumentStorageService();\n      \n      // Normalize the file path from upload URL\n      const normalizedFilePath = req.body.filePath ? \n        documentStorageService.normalizeVesselDocumentPath(req.body.filePath) : \n        req.body.filePath;\n      \n      const documentData = insertVesselDocumentSchema.parse({\n        ...req.body,\n        filePath: normalizedFilePath,\n        vesselId,\n        uploadedBy: req.user?.id,\n      });\n      \n      const document = await storage.createVesselDocument(documentData);\n      \n      // Log the activity\n      await storage.logActivity({\n        type: \"Document Management\",\n        action: \"create\",\n        entityType: \"vessel_document\",\n        entityId: document.id,\n        userId: req.user?.id || null,\n        username: req.user?.username || \"unknown\",\n        userRole: req.user?.role || \"unknown\",\n        description: `Uploaded vessel document: ${document.name}`,\n        severity: \"info\",\n        metadata: {\n          vesselId,\n          documentType: document.type,\n          fileName: document.fileName\n        }\n      });\n      \n      res.json(document);\n    } catch (error) {\n      console.error(\"Error creating vessel document:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid document data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to create vessel document\" });\n      }\n    }\n  });\n\n  app.get(\"/api/vessel-documents/:id\", authenticate, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const document = await storage.getVesselDocument(id);\n      \n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      res.json(document);\n    } catch (error) {\n      console.error(\"Error fetching vessel document:\", error);\n      res.status(500).json({ message: \"Failed to fetch vessel document\" });\n    }\n  });\n\n  // Download vessel document\n  app.get(\"/api/vessel-documents/:id/download\", authenticate, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const document = await storage.getVesselDocument(id);\n      \n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n\n      const documentStorageService = new VesselDocumentStorageService();\n      await documentStorageService.downloadVesselDocument(document.filePath, res);\n    } catch (error) {\n      console.error(\"Error downloading vessel document:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ message: \"Failed to download document\" });\n      }\n    }\n  });\n\n  app.put(\"/api/vessel-documents/:id\", authenticate, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const updates = insertVesselDocumentSchema.partial().parse(req.body);\n      const document = await storage.updateVesselDocument(id, updates);\n      \n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n\n      // Log the activity\n      await storage.logActivity({\n        type: \"Document Management\",\n        action: \"update\",\n        entityType: \"vessel_document\",\n        entityId: document.id,\n        userId: req.user?.id || null,\n        username: req.user?.username || \"unknown\",\n        userRole: req.user?.role || \"unknown\",\n        description: `Updated vessel document: ${document.name}`,\n        severity: \"info\"\n      });\n      \n      res.json(document);\n    } catch (error) {\n      console.error(\"Error updating vessel document:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ message: \"Invalid update data\", errors: error.errors });\n      } else {\n        res.status(500).json({ message: \"Failed to update vessel document\" });\n      }\n    }\n  });\n\n  app.delete(\"/api/vessel-documents/:id\", authenticate, async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      // First get the document for logging\n      const document = await storage.getVesselDocument(id);\n      if (!document) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n      \n      const success = await storage.deleteVesselDocument(id);\n      \n      if (!success) {\n        return res.status(404).json({ message: \"Document not found\" });\n      }\n\n      // Log the activity\n      await storage.logActivity({\n        type: \"Document Management\",\n        action: \"delete\",\n        entityType: \"vessel_document\",\n        entityId: id,\n        userId: req.user?.id || null,\n        username: req.user?.username || \"unknown\",\n        userRole: req.user?.role || \"unknown\",\n        description: `Deleted vessel document: ${document.name}`,\n        severity: \"info\"\n      });\n      \n      res.json({ message: \"Document deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting vessel document:\", error);\n      res.status(500).json({ message: \"Failed to delete vessel document\" });\n    }\n  });\n\n  // Bulk download route for vessel documents\n  app.get(\"/api/vessels/:vesselId/documents/download-all\", authenticate, async (req, res) => {\n    try {\n      const { vesselId } = req.params;\n      const documents = await storage.getVesselDocuments(vesselId);\n      \n      if (documents.length === 0) {\n        return res.status(404).json({ message: \"No documents found for this vessel\" });\n      }\n      \n      // In a real app, this would create a ZIP file containing all documents\n      // For now, we'll return the document metadata for bulk operations\n      res.json({\n        message: \"Bulk download prepared\",\n        count: documents.length,\n        documents: documents.map(doc => ({\n          id: doc.id,\n          name: doc.name,\n          fileName: doc.fileName,\n          filePath: doc.filePath\n        }))\n      });\n    } catch (error) {\n      console.error(\"Error preparing bulk download:\", error);\n      res.status(500).json({ message: \"Failed to prepare bulk download\" });\n    }\n  });\n\n  // Project download routes\n  app.get(\"/download/project\", (req, res) => {\n    const filePath = path.join(process.cwd(), 'crew-system-code-only.tar.gz');\n    if (fs.existsSync(filePath)) {\n      res.download(filePath, 'crew-management-system.tar.gz');\n    } else {\n      res.status(404).json({ message: \"Download file not found\" });\n    }\n  });\n\n  app.get(\"/download/project-full\", (req, res) => {\n    const filePath = path.join(process.cwd(), 'crew-management-system.tar.gz');\n    if (fs.existsSync(filePath)) {\n      res.download(filePath, 'crew-management-system-full.tar.gz');\n    } else {\n      res.status(404).json({ message: \"Download file not found\" });\n    }\n  });\n\n  // Admin endpoint to clear all crew data\n  app.delete(\"/api/admin/clear-crew-data\", authenticate, async (req, res) => {\n    try {\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Access denied. Admin role required.\" });\n      }\n\n      console.log(`Admin ${req.user.username} is clearing all crew data...`);\n\n      // Use raw SQL for more reliable deletion with proper order\n      // Delete in order due to foreign key constraints\n      \n      try {\n        // 1. Delete status change history\n        await db.execute(sql`DELETE FROM status_change_history`);\n        console.log(\"Deleted status change history\");\n      } catch (e) {\n        console.log(\"Status change history already empty or error:\", e);\n      }\n\n      try {\n        // 2. Delete documents (references crew_members)\n        await db.execute(sql`DELETE FROM documents`);\n        console.log(\"Deleted documents\");\n      } catch (e) {\n        console.log(\"Documents already empty or error:\", e);\n      }\n\n      try {\n        // 3. Delete contracts (references crew_members)\n        await db.execute(sql`DELETE FROM contracts`);\n        console.log(\"Deleted contracts\");\n      } catch (e) {\n        console.log(\"Contracts already empty or error:\", e);\n      }\n\n      try {\n        // 4. Delete crew rotations\n        await db.execute(sql`DELETE FROM crew_rotations`);\n        console.log(\"Deleted crew rotations\");\n      } catch (e) {\n        console.log(\"Crew rotations already empty or error:\", e);\n      }\n\n      try {\n        // 5. Delete crew members\n        await db.execute(sql`DELETE FROM crew_members`);\n        console.log(\"Deleted crew members\");\n      } catch (e) {\n        console.log(\"Error deleting crew members:\", e);\n        throw e; // Re-throw this one as it's the main goal\n      }\n\n      // Log the activity\n      try {\n        await storage.logActivity({\n          userId: req.user.id,\n          username: req.user.username || 'admin',\n          userRole: req.user.role,\n          type: 'delete',\n          action: 'delete',\n          entityType: 'crew_data',\n          description: 'Cleared all crew data (crew members, contracts, documents, status history, rotations)',\n          severity: 'high'\n        });\n      } catch (e) {\n        console.log(\"Activity logging error (non-critical):\", e);\n      }\n\n      res.json({ \n        message: \"All crew data has been cleared successfully. Vessels have been preserved.\" \n      });\n    } catch (error) {\n      console.error(\"Error clearing crew data:\", error);\n      res.status(500).json({ message: \"Failed to clear crew data: \" + (error instanceof Error ? error.message : 'Unknown error') });\n    }\n  });\n\n  // Send calendar summary email endpoint\n  app.post(\"/api/email/send-calendar-summary\", authenticate, async (req, res) => {\n    try {\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Access denied. Admin role required.\" });\n      }\n\n      const { month, events, additionalEmail } = req.body;\n      if (!month || !events) {\n        return res.status(400).json({ message: \"Month and events data required\" });\n      }\n\n      const settings = await storage.getEmailSettings();\n      if (!settings?.recipientEmail) {\n        return res.status(400).json({ message: \"No recipient email configured. Please configure email settings first.\" });\n      }\n\n      // Build recipient list\n      const recipients = [settings.recipientEmail];\n      if (additionalEmail && additionalEmail.trim()) {\n        const additionalEmails = additionalEmail.split(',').map((e: string) => e.trim()).filter((e: string) => e);\n        recipients.push(...additionalEmails);\n      }\n\n      console.log(`Sending calendar summary for ${month} to:`, recipients.join(', '));\n\n      // Use Gmail SMTP service instead of SendGrid\n      const { SMTPEmailService } = await import('./services/smtp-email-service');\n      const smtpService = new SMTPEmailService();\n\n      // Group events by type\n      const dueEvents = events.filter((e: any) => e.type === 'contract_due');\n      const expiredEvents = events.filter((e: any) => e.type === 'contract_expired');\n\n      const formatEventRow = (event: any, type: string) => {\n        const eventDate = new Date(event.date);\n        const dateStr = eventDate.toLocaleDateString('en-US', { \n          weekday: 'short', \n          month: 'short', \n          day: 'numeric',\n          year: 'numeric'\n        });\n        const bgColor = type === 'expired' ? '#fee2e2' : '#fef3c7';\n        const textColor = type === 'expired' ? '#dc2626' : '#d97706';\n        \n        return `\n          <tr style=\"border-bottom: 1px solid #e5e7eb;\">\n            <td style=\"padding: 12px; font-weight: 500;\">${event.crewMemberName}</td>\n            <td style=\"padding: 12px;\">${event.vesselName}</td>\n            <td style=\"padding: 12px;\">${dateStr}</td>\n            <td style=\"padding: 12px;\">\n              <span style=\"background: ${bgColor}; color: ${textColor}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;\">\n                ${event.daysUntilExpiry} days\n              </span>\n            </td>\n          </tr>\n        `;\n      };\n\n      const html = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n          <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n            <div style=\"text-align: center; margin-bottom: 30px; border-bottom: 2px solid #0066cc; padding-bottom: 20px;\">\n              <h1 style=\"color: #0066cc; margin: 0; font-size: 24px;\">üìÖ Contract Calendar Summary</h1>\n              <p style=\"color: #6c757d; margin: 10px 0 0 0;\">${month}</p>\n            </div>\n\n            <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;\">\n              <div style=\"background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;\">\n                <div style=\"font-size: 28px; font-weight: bold; color: #d97706;\">${dueEvents.length}</div>\n                <div style=\"font-size: 12px; color: #92400e;\">Contracts Due</div>\n              </div>\n              <div style=\"background: #fee2e2; padding: 15px; border-radius: 8px; text-align: center;\">\n                <div style=\"font-size: 28px; font-weight: bold; color: #dc2626;\">${expiredEvents.length}</div>\n                <div style=\"font-size: 12px; color: #991b1b;\">Contracts Expired</div>\n              </div>\n              <div style=\"background: #dbeafe; padding: 15px; border-radius: 8px; text-align: center;\">\n                <div style=\"font-size: 28px; font-weight: bold; color: #2563eb;\">${events.length}</div>\n                <div style=\"font-size: 12px; color: #1e40af;\">Total Events</div>\n              </div>\n            </div>\n\n            ${dueEvents.length > 0 ? `\n            <div style=\"margin-bottom: 25px;\">\n              <h2 style=\"color: #d97706; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;\">\n                ‚è∞ Contracts Due Soon (${dueEvents.length})\n              </h2>\n              <table style=\"width: 100%; border-collapse: collapse; background: white; border: 1px solid #e5e7eb; border-radius: 8px;\">\n                <thead>\n                  <tr style=\"background: #f9fafb; border-bottom: 2px solid #e5e7eb;\">\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Crew Member</th>\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Vessel</th>\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Due Date</th>\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Days Left</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${dueEvents.map((e: any) => formatEventRow(e, 'due')).join('')}\n                </tbody>\n              </table>\n            </div>\n            ` : ''}\n\n            ${expiredEvents.length > 0 ? `\n            <div style=\"margin-bottom: 25px;\">\n              <h2 style=\"color: #dc2626; margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center;\">\n                ‚ö†Ô∏è Contracts Expired (${expiredEvents.length})\n              </h2>\n              <table style=\"width: 100%; border-collapse: collapse; background: white; border: 1px solid #e5e7eb; border-radius: 8px;\">\n                <thead>\n                  <tr style=\"background: #f9fafb; border-bottom: 2px solid #e5e7eb;\">\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Crew Member</th>\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Vessel</th>\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Expiry Date</th>\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Days Overdue</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${expiredEvents.map((e: any) => formatEventRow(e, 'expired')).join('')}\n                </tbody>\n              </table>\n            </div>\n            ` : ''}\n\n            ${events.length === 0 ? `\n            <div style=\"text-align: center; padding: 40px; background: #f0fdf4; border-radius: 8px;\">\n              <div style=\"font-size: 48px; margin-bottom: 10px;\">‚úÖ</div>\n              <p style=\"color: #16a34a; font-weight: 500; margin: 0;\">No contract events for ${month}</p>\n            </div>\n            ` : ''}\n\n            <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center;\">\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n                This report was generated on ${new Date().toLocaleDateString('en-US', { \n                  weekday: 'long', \n                  year: 'numeric', \n                  month: 'long', \n                  day: 'numeric',\n                  hour: '2-digit',\n                  minute: '2-digit'\n                })}\n              </p>\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 5px 0 0 0;\">\n                Crew Management System\n              </p>\n            </div>\n          </div>\n        </div>\n      `;\n\n      const textContent = `Contract Calendar Summary for ${month}\\n\\nContracts Due: ${dueEvents.length}\\nContracts Expired: ${expiredEvents.length}\\nTotal Events: ${events.length}\\n\\n` +\n          (dueEvents.length > 0 ? `Due Soon:\\n${dueEvents.map((e: any) => `- ${e.crewMemberName} (${e.vesselName}) - ${new Date(e.date).toLocaleDateString()}`).join('\\n')}\\n\\n` : '') +\n          (expiredEvents.length > 0 ? `Expired:\\n${expiredEvents.map((e: any) => `- ${e.crewMemberName} (${e.vesselName}) - ${new Date(e.date).toLocaleDateString()}`).join('\\n')}` : '');\n\n      // Generate PDF attachment\n      const { pdfGeneratorService } = await import('./services/pdf-generator');\n      let pdfBuffer: Buffer | null = null;\n      try {\n        const pdfEvents = events.map((e: any) => ({\n          ...e,\n          date: new Date(e.date),\n          contractEndDate: new Date(e.contractEndDate),\n        }));\n        pdfBuffer = await pdfGeneratorService.generateCalendarPDF(month, pdfEvents);\n        console.log(`üìÑ PDF generated for manual email (${pdfBuffer.length} bytes)`);\n      } catch (pdfError) {\n        console.error('‚ö†Ô∏è Failed to generate PDF for manual email:', pdfError);\n      }\n\n      // Send to all recipients with PDF attachment\n      const sendResults = await Promise.all(\n        recipients.map(async (recipient) => {\n          if (pdfBuffer) {\n            return smtpService.sendEmailWithAttachment({\n              to: recipient,\n              subject: `Contract Calendar Summary - ${month}`,\n              html,\n              text: textContent,\n              attachments: [{\n                filename: `Contract-Calendar-${month.replace(/\\s+/g, '-')}.pdf`,\n                content: pdfBuffer,\n                contentType: 'application/pdf',\n              }],\n            });\n          } else {\n            return smtpService.sendEmail({\n              to: recipient,\n              subject: `Contract Calendar Summary - ${month}`,\n              html,\n              text: textContent\n            });\n          }\n        })\n      );\n\n      const allSuccess = sendResults.every(result => result.success);\n      if (!allSuccess) {\n        const failedResults = sendResults.filter(r => !r.success);\n        const errorMsg = failedResults.map(r => r.error).filter(Boolean).join(', ');\n        return res.status(500).json({ message: `Failed to send email to some recipients: ${errorMsg || 'Unknown error'}` });\n      }\n\n      res.json({ \n        message: `Calendar summary for ${month} sent to ${recipients.join(', ')}` \n      });\n    } catch (error) {\n      console.error(\"Failed to send calendar summary email:\", error);\n      res.status(500).json({ \n        message: \"Failed to send calendar summary email. Please check your email configuration.\" \n      });\n    }\n  });\n\n  // Send status history email endpoint\n  app.post(\"/api/email/send-status-history\", authenticate, async (req, res) => {\n    try {\n      if (req.user?.role !== 'admin') {\n        return res.status(403).json({ message: \"Access denied. Admin role required.\" });\n      }\n\n      const { statusHistory, additionalEmail } = req.body;\n      if (!statusHistory || !Array.isArray(statusHistory)) {\n        return res.status(400).json({ message: \"Status history data required\" });\n      }\n\n      const settings = await storage.getEmailSettings();\n      if (!settings?.recipientEmail) {\n        return res.status(400).json({ message: \"No recipient email configured. Please configure email settings first.\" });\n      }\n\n      // Build recipient list\n      const recipients = [settings.recipientEmail];\n      if (additionalEmail && additionalEmail.trim()) {\n        const additionalEmails = additionalEmail.split(',').map((e: string) => e.trim()).filter((e: string) => e);\n        recipients.push(...additionalEmails);\n      }\n\n      console.log(`Sending status history email to:`, recipients.join(', '));\n\n      // Use Gmail SMTP service\n      const { SMTPEmailService } = await import('./services/smtp-email-service');\n      const smtpService = new SMTPEmailService();\n\n      // Helper to extract crew member name from nested object\n      const getCrewName = (record: any) => {\n        if (record.crewMember) {\n          const first = record.crewMember.firstName || '';\n          const last = record.crewMember.lastName || '';\n          return `${first} ${last}`.trim() || 'Unknown';\n        }\n        return record.crewMemberName || 'Unknown';\n      };\n\n      // Helper to extract vessel name from nested object\n      const getVesselName = (record: any) => {\n        if (record.vessel?.name) return record.vessel.name;\n        return record.vesselName || 'N/A';\n      };\n\n      // Group by status (handles both onBoard/onShore and signed_on/signed_off formats)\n      const signedOn = statusHistory.filter((r: any) => r.newStatus === 'onBoard' || r.newStatus === 'signed_on');\n      const signedOff = statusHistory.filter((r: any) => r.newStatus === 'onShore' || r.newStatus === 'signed_off');\n      const onLeave = statusHistory.filter((r: any) => r.newStatus === 'on_leave');\n      const available = statusHistory.filter((r: any) => r.newStatus === 'available');\n\n      const formatStatusRow = (record: any) => {\n        // Use createdAt if changedAt is not available\n        const changeDate = new Date(record.createdAt || record.changedAt);\n        const dateStr = isNaN(changeDate.getTime()) ? 'Unknown Date' : changeDate.toLocaleDateString('en-US', { \n          weekday: 'short', \n          month: 'short', \n          day: 'numeric',\n          year: 'numeric'\n        });\n        \n        const statusColors: Record<string, { bg: string; text: string }> = {\n          'onBoard': { bg: '#dcfce7', text: '#16a34a' },\n          'signed_on': { bg: '#dcfce7', text: '#16a34a' },\n          'onShore': { bg: '#fee2e2', text: '#dc2626' },\n          'signed_off': { bg: '#fee2e2', text: '#dc2626' },\n          'on_leave': { bg: '#fef3c7', text: '#d97706' },\n          'available': { bg: '#dbeafe', text: '#2563eb' }\n        };\n        \n        const statusLabels: Record<string, string> = {\n          'onBoard': 'On Board',\n          'signed_on': 'Signed On',\n          'onShore': 'On Shore',\n          'signed_off': 'Signed Off',\n          'on_leave': 'On Leave',\n          'available': 'Available'\n        };\n        \n        const colors = statusColors[record.newStatus] || { bg: '#f3f4f6', text: '#6b7280' };\n        const statusLabel = statusLabels[record.newStatus] || record.newStatus || 'Unknown';\n        \n        return `\n          <tr style=\"border-bottom: 1px solid #e5e7eb;\">\n            <td style=\"padding: 12px; font-weight: 500;\">${getCrewName(record)}</td>\n            <td style=\"padding: 12px;\">${getVesselName(record)}</td>\n            <td style=\"padding: 12px;\">${dateStr}</td>\n            <td style=\"padding: 12px;\">\n              <span style=\"background: ${colors.bg}; color: ${colors.text}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;\">\n                ${statusLabel}\n              </span>\n            </td>\n          </tr>\n        `;\n      };\n\n      const html = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n          <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n            <div style=\"text-align: center; margin-bottom: 30px; border-bottom: 2px solid #0066cc; padding-bottom: 20px;\">\n              <h1 style=\"color: #0066cc; margin: 0; font-size: 24px;\">Crew Status History Report</h1>\n              <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Status change summary</p>\n            </div>\n\n            <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;\">\n              <div style=\"background: #dcfce7; padding: 15px; border-radius: 8px; text-align: center;\">\n                <div style=\"font-size: 28px; font-weight: bold; color: #16a34a;\">${signedOn.length}</div>\n                <div style=\"font-size: 12px; color: #166534;\">On Board</div>\n              </div>\n              <div style=\"background: #fee2e2; padding: 15px; border-radius: 8px; text-align: center;\">\n                <div style=\"font-size: 28px; font-weight: bold; color: #dc2626;\">${signedOff.length}</div>\n                <div style=\"font-size: 12px; color: #991b1b;\">On Shore</div>\n              </div>\n              <div style=\"background: #fef3c7; padding: 15px; border-radius: 8px; text-align: center;\">\n                <div style=\"font-size: 28px; font-weight: bold; color: #d97706;\">${onLeave.length}</div>\n                <div style=\"font-size: 12px; color: #92400e;\">On Leave</div>\n              </div>\n              <div style=\"background: #dbeafe; padding: 15px; border-radius: 8px; text-align: center;\">\n                <div style=\"font-size: 28px; font-weight: bold; color: #2563eb;\">${available.length}</div>\n                <div style=\"font-size: 12px; color: #1e40af;\">Available</div>\n              </div>\n            </div>\n\n            ${statusHistory.length > 0 ? `\n            <div style=\"margin-bottom: 25px;\">\n              <h2 style=\"color: #374151; margin: 0 0 15px 0; font-size: 16px;\">\n                All Status Changes (${statusHistory.length})\n              </h2>\n              <table style=\"width: 100%; border-collapse: collapse; background: white; border: 1px solid #e5e7eb; border-radius: 8px;\">\n                <thead>\n                  <tr style=\"background: #f9fafb; border-bottom: 2px solid #e5e7eb;\">\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Crew Member</th>\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Vessel</th>\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Date</th>\n                    <th style=\"padding: 12px; text-align: left; font-size: 12px; color: #6b7280;\">Status</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  ${statusHistory.map((r: any) => formatStatusRow(r)).join('')}\n                </tbody>\n              </table>\n            </div>\n            ` : `\n            <div style=\"text-align: center; padding: 40px; background: #f0fdf4; border-radius: 8px;\">\n              <div style=\"font-size: 48px; margin-bottom: 10px;\">No status changes to report</div>\n            </div>\n            `}\n\n            <div style=\"margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center;\">\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 0;\">\n                This report was generated on ${new Date().toLocaleDateString('en-US', { \n                  weekday: 'long', \n                  year: 'numeric', \n                  month: 'long', \n                  day: 'numeric',\n                  hour: '2-digit',\n                  minute: '2-digit'\n                })}\n              </p>\n              <p style=\"color: #9ca3af; font-size: 12px; margin: 5px 0 0 0;\">\n                Crew Management System\n              </p>\n            </div>\n          </div>\n        </div>\n      `;\n\n      const textContent = `Crew Status History Report\\n\\nOn Board: ${signedOn.length}\\nOn Shore: ${signedOff.length}\\nOn Leave: ${onLeave.length}\\nAvailable: ${available.length}\\nTotal: ${statusHistory.length}\\n\\n` +\n          statusHistory.map((r: any) => {\n            const crewName = getCrewName(r);\n            const vesselName = getVesselName(r);\n            const status = r.newStatus === 'onBoard' ? 'On Board' : r.newStatus === 'onShore' ? 'On Shore' : r.newStatus;\n            const date = new Date(r.createdAt || r.changedAt);\n            const dateStr = isNaN(date.getTime()) ? 'Unknown Date' : date.toLocaleDateString();\n            return `- ${crewName} (${vesselName}) - ${status} on ${dateStr}`;\n          }).join('\\n');\n\n      // Send to all recipients\n      const sendResults = await Promise.all(\n        recipients.map(async (recipient) => {\n          const emailContent = {\n            to: recipient,\n            subject: `Crew Status History Report - ${new Date().toLocaleDateString()}`,\n            html,\n            text: textContent\n          };\n          return smtpService.sendEmail(emailContent);\n        })\n      );\n\n      const allSuccess = sendResults.every(result => result.success);\n      if (!allSuccess) {\n        const failedResults = sendResults.filter(r => !r.success);\n        const errorMsg = failedResults.map(r => r.error).filter(Boolean).join(', ');\n        return res.status(500).json({ message: `Failed to send email to some recipients: ${errorMsg || 'Unknown error'}` });\n      }\n\n      res.json({ \n        message: `Status history report sent to ${recipients.join(', ')}` \n      });\n    } catch (error) {\n      console.error(\"Failed to send status history email:\", error);\n      res.status(500).json({ \n        message: \"Failed to send status history email. Please check your email configuration.\" \n      });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","path":null,"size_bytes":118607,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1858,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/crew/contract-progress.tsx":{"content":"import { Progress } from '@/components/ui/progress';\n\ninterface ContractProgressProps {\n  startDate: string | Date;\n  endDate: string | Date;\n  status: string;\n  memberId: string;\n  compact?: boolean;\n}\n\ninterface ContractState {\n  percent: number;\n  remainingDays: number;\n  elapsedDays: number;\n  totalDays: number;\n  state: 'upcoming' | 'active' | 'expired' | 'no-contract';\n}\n\nexport function ContractProgress({ startDate, endDate, status, memberId, compact = false }: ContractProgressProps) {\n  \n  const calculateContractState = (): ContractState => {\n    if (!startDate || !endDate || status !== 'active') {\n      return {\n        percent: 0,\n        remainingDays: 0,\n        elapsedDays: 0,\n        totalDays: 0,\n        state: 'no-contract'\n      };\n    }\n\n    const start = new Date(startDate);\n    const end = new Date(endDate);\n    const now = new Date();\n\n    // Validate dates\n    if (isNaN(start.getTime()) || isNaN(end.getTime()) || end <= start) {\n      return {\n        percent: 0,\n        remainingDays: 0,\n        elapsedDays: 0,\n        totalDays: 0,\n        state: 'no-contract'\n      };\n    }\n\n    const msPerDay = 86_400_000;\n    const totalDays = Math.max(1, Math.ceil((end.getTime() - start.getTime()) / msPerDay));\n    \n    // Calculate elapsed time with proper clamping\n    const elapsedMs = Math.max(0, Math.min(end.getTime() - start.getTime(), now.getTime() - start.getTime()));\n    const elapsedDays = Math.floor(elapsedMs / msPerDay);\n    const percent = Math.round((elapsedDays / totalDays) * 100);\n    const remainingDays = Math.max(0, Math.ceil((end.getTime() - now.getTime()) / msPerDay));\n\n    let state: ContractState['state'];\n    if (now < start) {\n      state = 'upcoming';\n    } else if (now > end) {\n      state = 'expired';\n    } else {\n      state = 'active';\n    }\n\n    return {\n      percent: Math.min(100, Math.max(0, percent)),\n      remainingDays,\n      elapsedDays,\n      totalDays,\n      state\n    };\n  };\n\n  const contractState = calculateContractState();\n\n  const getProgressColor = () => {\n    switch (contractState.state) {\n      case 'upcoming':\n        return 'bg-blue-500 dark:bg-blue-400';\n      case 'expired':\n        return 'bg-red-500 dark:bg-red-400';\n      case 'active':\n        if (contractState.remainingDays > 30) return 'bg-green-500 dark:bg-green-400';\n        if (contractState.remainingDays >= 7) return 'bg-amber-500 dark:bg-amber-400';\n        return 'bg-red-500 dark:bg-red-400';\n      default:\n        return 'bg-gray-400 dark:bg-gray-500';\n    }\n  };\n\n  const getTextColor = () => {\n    switch (contractState.state) {\n      case 'upcoming':\n        return 'text-blue-700 dark:text-blue-300';\n      case 'expired':\n        return 'text-red-700 dark:text-red-300';\n      case 'active':\n        if (contractState.remainingDays > 30) return 'text-green-700 dark:text-green-300';\n        if (contractState.remainingDays >= 7) return 'text-amber-700 dark:text-amber-300';\n        return 'text-red-700 dark:text-red-300';\n      default:\n        return 'text-gray-600 dark:text-gray-400';\n    }\n  };\n\n  const getRemainingText = () => {\n    switch (contractState.state) {\n      case 'upcoming':\n        return `Starts in ${Math.abs(contractState.remainingDays)}d`;\n      case 'expired':\n        return 'Expired';\n      case 'active':\n        return `${contractState.remainingDays}d left`;\n      default:\n        return 'No contract';\n    }\n  };\n\n  const getRemainingNumber = () => {\n    switch (contractState.state) {\n      case 'upcoming':\n        return Math.abs(contractState.remainingDays);\n      case 'expired':\n        return 0;\n      case 'active':\n        return contractState.remainingDays;\n      default:\n        return 0;\n    }\n  };\n\n  const formatDate = (date: string | Date) => {\n    try {\n      const dateObj = typeof date === 'string' ? new Date(date) : date;\n      return dateObj.toLocaleDateString('en-US', { \n        day: '2-digit', \n        month: 'short' \n      });\n    } catch {\n      return '';\n    }\n  };\n\n  if (contractState.state === 'no-contract') {\n    return (\n      <div className={`flex items-center ${compact ? 'justify-center' : 'space-x-2'}`}>\n        <div className={`w-2 h-2 bg-gray-400 dark:bg-gray-500 rounded-full ${compact ? '' : 'shrink-0'}`} />\n        <span className={`text-xs text-gray-600 dark:text-gray-400 ${compact ? 'ml-1' : ''}`}>\n          No active contract\n        </span>\n      </div>\n    );\n  }\n\n  if (compact) {\n    return (\n      <div className=\"w-full min-w-0\">\n        <div className=\"flex justify-between text-xs mb-1\">\n          <span className=\"text-muted-foreground truncate\">\n            {formatDate(startDate)}\n          </span>\n          <span className={`font-medium ${getTextColor()}`}>\n            {contractState.state === 'active' ? `${contractState.remainingDays} days` : ''}\n          </span>\n          <span className=\"text-muted-foreground truncate\">\n            {formatDate(endDate)}\n          </span>\n        </div>\n        <div className=\"relative h-2 bg-muted rounded-full overflow-hidden print:hidden\">\n          <div \n            className=\"absolute inset-y-0 left-0 bg-gradient-to-r from-primary to-primary/70 rounded-full transition-all duration-1000 ease-out animate-pulse\"\n            style={{ width: `${contractState.percent}%` }}\n            data-testid={`progress-contract-${memberId}`}\n            role=\"progressbar\"\n            aria-valuenow={contractState.percent}\n            aria-valuemin={0}\n            aria-valuemax={100}\n            aria-label={`Contract progress: ${contractState.percent}% complete, ${getRemainingText()}`}\n          />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-full min-w-0\">\n      <div className=\"flex justify-between text-xs mb-1\">\n        <span className=\"text-muted-foreground truncate\">\n          {formatDate(startDate)}\n        </span>\n        <span className={`font-medium ${getTextColor()}`} data-testid={`label-remaining-${memberId}`}>\n          {contractState.state === 'active' ? `${contractState.remainingDays} days` : ''}\n        </span>\n        <span className=\"text-muted-foreground truncate\">\n          {formatDate(endDate)}\n        </span>\n      </div>\n      <div className=\"relative h-2 bg-muted rounded-full overflow-hidden print:hidden\">\n        <div \n          className=\"absolute inset-y-0 left-0 bg-gradient-to-r from-primary to-primary/70 rounded-full transition-all duration-1000 ease-out animate-pulse\"\n          style={{ width: `${contractState.percent}%` }}\n          data-testid={`progress-contract-${memberId}`}\n          role=\"progressbar\"\n          aria-valuenow={contractState.percent}\n          aria-valuemin={0}\n          aria-valuemax={100}\n          aria-label={`Contract progress: ${contractState.percent}% complete, ${getRemainingText()}`}\n        />\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":6836,"size_tokens":null},"client/src/components/layout/sidebar.tsx":{"content":"import { Link, useLocation } from 'wouter';\nimport { useAuth } from '@/contexts/auth-context';\nimport { cn } from '@/lib/utils';\nimport {\n  LayoutDashboard,\n  Users,\n  Ship,\n  Calendar,\n  FileText,\n  Settings,\n  Mail,\n} from 'lucide-react';\n\ninterface SidebarProps {\n  isOpen: boolean;\n  onClose: () => void;\n  isMobile: boolean;\n}\n\ninterface NavItem {\n  href: string;\n  label: string;\n  icon: React.ComponentType<{ className?: string }>;\n  roles: string[];\n}\n\nconst navItems: NavItem[] = [\n  { href: '/', label: 'Dashboard', icon: LayoutDashboard, roles: ['admin', 'office_staff'] },\n  { href: '/scheduling', label: 'Scheduling', icon: Calendar, roles: ['admin', 'office_staff'] },\n  { href: '/documents', label: 'Document Center', icon: FileText, roles: ['admin', 'office_staff'] },\n  { href: '/settings', label: 'Settings', icon: Settings, roles: ['admin'] },\n  { href: '/notifications', label: 'Email Notifications', icon: Mail, roles: ['admin'] },\n];\n\nexport default function Sidebar({ isOpen, onClose, isMobile }: SidebarProps) {\n  const { user } = useAuth();\n  const [location] = useLocation();\n\n  const filteredNavItems = navItems.filter(item => \n    item.roles.includes(user?.role || '')\n  );\n\n  const sidebarClasses = cn(\n    'bg-card border-r border-border shadow-sm fixed left-0 top-20 bottom-0 overflow-y-auto transition-transform duration-200 z-40',\n    isMobile ? 'w-64' : 'w-64',\n    isOpen || !isMobile ? 'translate-x-0' : '-translate-x-full'\n  );\n\n  return (\n    <aside className={sidebarClasses}>\n      <nav className=\"p-6\">\n        <div className=\"space-y-2\">\n          {/* Fleet Management Section */}\n          {(user?.role === 'admin' || user?.role === 'office_staff') && (\n            <div className=\"mb-6\">\n              <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wide mb-3\">\n                Fleet Management\n              </h3>\n              <ul className=\"space-y-1\">\n                {filteredNavItems.filter(item => \n                  ['/', '/scheduling'].includes(item.href)\n                ).map((item) => {\n                  const isActive = location === item.href || (item.href === '/' && location === '/dashboard');\n                  return (\n                    <li key={item.href}>\n                      <Link href={item.href}>\n                        <span\n                          className={cn(\n                            'flex items-center space-x-3 px-3 py-2 rounded-lg transition-colors cursor-pointer',\n                            isActive \n                              ? 'bg-maritime-navy text-white' \n                              : 'text-gray-700 hover:bg-gray-100'\n                          )}\n                          onClick={isMobile ? onClose : undefined}\n                          data-testid={`nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n                        >\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.label}</span>\n                        </span>\n                      </Link>\n                    </li>\n                  );\n                })}\n              </ul>\n            </div>\n          )}\n\n          {/* Compliance Section */}\n          {(user?.role === 'admin' || user?.role === 'office_staff') && (\n            <div className=\"mb-6\">\n              <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wide mb-3\">\n                Compliance\n              </h3>\n              <ul className=\"space-y-1\">\n                {filteredNavItems.filter(item => \n                  ['/documents'].includes(item.href)\n                ).map((item) => {\n                  const isActive = location === item.href;\n                  return (\n                    <li key={item.href}>\n                      <Link href={item.href}>\n                        <span\n                          className={cn(\n                            'flex items-center space-x-3 px-3 py-2 rounded-lg transition-colors cursor-pointer',\n                            isActive \n                              ? 'bg-maritime-navy text-white' \n                              : 'text-gray-700 hover:bg-gray-100'\n                          )}\n                          onClick={isMobile ? onClose : undefined}\n                          data-testid={`nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n                        >\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.label}</span>\n                        </span>\n                      </Link>\n                    </li>\n                  );\n                })}\n              </ul>\n            </div>\n          )}\n\n          {/* System Section (Admin Only) */}\n          {user?.role === 'admin' && (\n            <div>\n              <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wide mb-3\">\n                System\n              </h3>\n              <ul className=\"space-y-1\">\n                {filteredNavItems.filter(item => \n                  ['/settings', '/notifications'].includes(item.href)\n                ).map((item) => {\n                  const isActive = location === item.href;\n                  return (\n                    <li key={item.href}>\n                      <Link href={item.href}>\n                        <span\n                          className={cn(\n                            'flex items-center space-x-3 px-3 py-2 rounded-lg transition-colors cursor-pointer',\n                            isActive \n                              ? 'bg-maritime-navy text-white' \n                              : 'text-gray-700 hover:bg-gray-100'\n                          )}\n                          onClick={isMobile ? onClose : undefined}\n                          data-testid={`nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n                        >\n                          <item.icon className=\"h-4 w-4\" />\n                          <span>{item.label}</span>\n                        </span>\n                      </Link>\n                    </li>\n                  );\n                })}\n              </ul>\n            </div>\n          )}\n        </div>\n      </nav>\n    </aside>\n  );\n}\n","path":null,"size_bytes":6197,"size_tokens":null},"client/src/pages/documents.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { queryClient } from '@/lib/queryClient';\nimport DocumentUpload from '@/components/documents/document-upload';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from '@/components/ui/alert-dialog';\nimport { Input } from '@/components/ui/input';\nimport { Badge } from '@/components/ui/badge';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { FileText, Plus, Search, Download, Eye, Edit, Trash2 } from 'lucide-react';\nimport { Document, CrewMemberWithDetails } from '@shared/schema';\nimport { format } from 'date-fns';\nimport { formatDate } from '@/lib/utils';\n\nexport default function Documents() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [typeFilter, setTypeFilter] = useState('all');\n  const [statusFilter, setStatusFilter] = useState('all');\n  const [selectedDocument, setSelectedDocument] = useState<Document | null>(null);\n  const [isViewModalOpen, setIsViewModalOpen] = useState(false);\n  const [isEditModalOpen, setIsEditModalOpen] = useState(false);\n  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);\n\n  const { data: documents, isLoading } = useQuery<Document[]>({\n    queryKey: ['/api/documents'],\n    queryFn: async () => {\n      const response = await fetch('/api/documents', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch documents');\n      return response.json();\n    },\n  });\n\n  const { data: crewMembers } = useQuery<CrewMemberWithDetails[]>({\n    queryKey: ['/api/crew'],\n    queryFn: async () => {\n      const response = await fetch('/api/crew', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch crew');\n      return response.json();\n    },\n  });\n\n  // For crew members, filter to their documents only\n  const filteredDocuments = documents?.filter(doc => {\n    if (user?.role === 'crew') {\n      const currentMember = crewMembers?.find(member => member.user?.id === user.id);\n      return doc.crewMemberId === currentMember?.id;\n    }\n\n    // Get crew member name for search matching\n    const crewMember = crewMembers?.find(member => member.id === doc.crewMemberId);\n    const crewMemberName = crewMember ? `${crewMember.firstName} ${crewMember.lastName}`.toLowerCase() : '';\n\n    const matchesSearch = doc.type.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         doc.documentNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         doc.issuingAuthority.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         crewMemberName.includes(searchTerm.toLowerCase());\n    \n    const matchesType = typeFilter === 'all' || doc.type === typeFilter;\n    const matchesStatus = statusFilter === 'all' || doc.status === statusFilter;\n    \n    return matchesSearch && matchesType && matchesStatus;\n  }) || [];\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'valid': return 'bg-compliance-green text-white';\n      case 'expiring': return 'bg-warning-amber text-white';\n      case 'expired': return 'bg-alert-red text-white';\n      default: return 'bg-gray-500 text-white';\n    }\n  };\n\n  const getCrewMemberName = (crewMemberId: string) => {\n    const member = crewMembers?.find(m => m.id === crewMemberId);\n    return member ? `${member.firstName} ${member.lastName}` : 'Unknown';\n  };\n\n  const getCrewMemberInitials = (crewMemberId: string) => {\n    const member = crewMembers?.find(m => m.id === crewMemberId);\n    return member ? `${member.firstName.charAt(0)}${member.lastName.charAt(0)}`.toUpperCase() : 'UK';\n  };\n\n  // Delete document mutation\n  const deleteDocumentMutation = useMutation({\n    mutationFn: async (documentId: string) => {\n      const response = await fetch(`/api/documents/${documentId}`, {\n        method: 'DELETE',\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to delete document');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n      toast({\n        title: 'Success',\n        description: 'Document deleted successfully',\n      });\n      setIsDeleteModalOpen(false);\n      setSelectedDocument(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to delete document',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleViewDocument = (document: Document) => {\n    setSelectedDocument(document);\n    setIsViewModalOpen(true);\n  };\n\n  const handleEditDocument = (document: Document) => {\n    setSelectedDocument(document);\n    setIsEditModalOpen(true);\n  };\n\n  const handleDeleteDocument = (document: Document) => {\n    setSelectedDocument(document);\n    setIsDeleteModalOpen(true);\n  };\n\n  const confirmDelete = () => {\n    if (selectedDocument) {\n      deleteDocumentMutation.mutate(selectedDocument.id);\n    }\n  };\n\n  const documentTypeOptions = [\n    { value: 'all', label: 'All Types' },\n    { value: 'passport', label: 'Passport' },\n    { value: 'cdc', label: 'CDC' },\n    { value: 'stcw', label: 'STCW' },\n    { value: 'medical', label: 'Medical Certificate' },\n    { value: 'visa', label: 'Visa' },\n  ];\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/3 mb-2\"></div>\n          <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n        </div>\n        <div className=\"h-64 bg-gray-200 rounded animate-pulse\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold maritime-navy mb-2\" data-testid=\"documents-title\">\n            Document Center\n          </h2>\n          <p className=\"text-gray-600\">\n            {user?.role === 'crew' \n              ? 'Manage your personal documents and certificates'\n              : 'Manage crew documents, certificates, and compliance tracking'\n            }\n          </p>\n        </div>\n        \n        <div className=\"flex items-center space-x-4\">\n          <Dialog open={isUploadModalOpen} onOpenChange={setIsUploadModalOpen}>\n            <DialogTrigger asChild>\n              <Button className=\"bg-maritime-navy hover:bg-blue-800\" data-testid=\"upload-document-button\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Upload Document\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Upload Document</DialogTitle>\n              </DialogHeader>\n              <DocumentUpload onSuccess={() => setIsUploadModalOpen(false)} />\n            </DialogContent>\n          </Dialog>\n        </div>\n      </div>\n\n      {/* Document Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500\">Total Documents</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <FileText className=\"h-5 w-5 ocean-blue\" />\n              <span className=\"text-2xl font-bold maritime-navy\" data-testid=\"total-documents-count\">\n                {documents?.length || 0}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500\">Valid</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-2 h-2 bg-compliance-green rounded-full\"></div>\n              <span className=\"text-2xl font-bold maritime-navy\" data-testid=\"valid-documents-count\">\n                {documents?.filter(doc => doc.status === 'valid').length || 0}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500\">Expiring Soon</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-2 h-2 bg-warning-amber rounded-full\"></div>\n              <span className=\"text-2xl font-bold maritime-navy\" data-testid=\"expiring-documents-count\">\n                {documents?.filter(doc => doc.status === 'expiring').length || 0}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"pb-3\">\n            <CardTitle className=\"text-sm font-medium text-gray-500\">Expired</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-2\">\n              <div className=\"w-2 h-2 bg-alert-red rounded-full\"></div>\n              <span className=\"text-2xl font-bold maritime-navy\" data-testid=\"expired-documents-count\">\n                {documents?.filter(doc => doc.status === 'expired').length || 0}\n              </span>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Document Views */}\n      {(\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle className=\"maritime-navy\">Documents</CardTitle>\n              <Button variant=\"outline\" size=\"sm\" data-testid=\"export-documents-button\">\n                <Download className=\"h-4 w-4 mr-2\" />\n                Export\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent>\n          {/* Search and Filters */}\n          <div className=\"flex items-center space-x-4 mb-6\">\n            <div className=\"flex-1 relative\">\n              <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n              <Input\n                placeholder=\"Search documents...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n                data-testid=\"documents-search-input\"\n              />\n            </div>\n            \n            <Select value={typeFilter} onValueChange={setTypeFilter}>\n              <SelectTrigger className=\"w-48\" data-testid=\"document-type-filter\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {documentTypeOptions.map((option) => (\n                  <SelectItem key={option.value} value={option.value}>\n                    {option.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            \n            <Select value={statusFilter} onValueChange={setStatusFilter}>\n              <SelectTrigger className=\"w-32\" data-testid=\"document-status-filter\">\n                <SelectValue placeholder=\"Status\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Status</SelectItem>\n                <SelectItem value=\"valid\">Valid</SelectItem>\n                <SelectItem value=\"expiring\">Expiring</SelectItem>\n                <SelectItem value=\"expired\">Expired</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Documents Table */}\n          <div className=\"rounded-lg border\">\n            <Table>\n              <TableHeader>\n                <TableRow className=\"bg-gray-50\">\n                  {user?.role !== 'crew' && <TableHead>Crew Member</TableHead>}\n                  <TableHead>Document Type</TableHead>\n                  <TableHead>Document Number</TableHead>\n                  <TableHead>Expiry Date</TableHead>\n                  <TableHead>Status</TableHead>\n                  <TableHead>Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {filteredDocuments.length === 0 ? (\n                  <TableRow>\n                    <TableCell \n                      colSpan={user?.role !== 'crew' ? 6 : 5} \n                      className=\"text-center py-8 text-gray-500\"\n                    >\n                      No documents found\n                    </TableCell>\n                  </TableRow>\n                ) : (\n                  filteredDocuments.map((document) => (\n                    <TableRow key={document.id} className=\"hover:bg-gray-50\" data-testid={`document-row-${document.id}`}>\n                      {user?.role !== 'crew' && (\n                        <TableCell>\n                          <div className=\"flex items-center space-x-3\">\n                            <Avatar className=\"bg-maritime-navy\">\n                              <AvatarFallback className=\"text-white font-medium\">\n                                {getCrewMemberInitials(document.crewMemberId)}\n                              </AvatarFallback>\n                            </Avatar>\n                            <span className=\"font-medium\" data-testid=\"document-crew-name\">\n                              {getCrewMemberName(document.crewMemberId)}\n                            </span>\n                          </div>\n                        </TableCell>\n                      )}\n                      <TableCell className=\"font-medium\" data-testid=\"document-type\">\n                        {document.type.toUpperCase()}\n                      </TableCell>\n                      <TableCell data-testid=\"document-number\">{document.documentNumber}</TableCell>\n                      <TableCell data-testid=\"document-expiry\">\n                        {formatDate(document.expiryDate)}\n                      </TableCell>\n                      <TableCell>\n                        <Badge className={getStatusColor(document.status)} data-testid=\"document-status\">\n                          {document.status === 'valid' ? 'Valid' : \n                           document.status === 'expiring' ? 'Expiring' : 'Expired'}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex space-x-2\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            className=\"maritime-navy hover:bg-blue-50\"\n                            onClick={() => handleViewDocument(document)}\n                            data-testid={`view-document-${document.id}`}\n                          >\n                            <Eye className=\"h-4 w-4\" />\n                          </Button>\n                          {document.filePath && (\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              className=\"text-green-600 hover:bg-green-50\"\n                              onClick={() => {\n                                window.open(`/api/documents/${document.id}/download`, '_blank');\n                              }}\n                              data-testid={`download-document-${document.id}`}\n                            >\n                              <Download className=\"h-4 w-4\" />\n                            </Button>\n                          )}\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            className=\"text-gray-600 hover:bg-gray-50\"\n                            onClick={() => handleEditDocument(document)}\n                            data-testid={`edit-document-${document.id}`}\n                          >\n                            <Edit className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            className=\"text-red-600 hover:bg-red-50\"\n                            onClick={() => handleDeleteDocument(document)}\n                            data-testid={`delete-document-${document.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))\n                )}\n              </TableBody>\n            </Table>\n          </div>\n        </CardContent>\n        </Card>\n      )}\n\n      {/* View Document Modal */}\n      <Dialog open={isViewModalOpen} onOpenChange={setIsViewModalOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center space-x-2\">\n              <Eye className=\"h-5 w-5 text-primary\" />\n              <span>Document Details</span>\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedDocument && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-sm font-medium text-gray-500\">Document Type</label>\n                  <p className=\"text-sm font-semibold\">{selectedDocument.type.toUpperCase()}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium text-gray-500\">Status</label>\n                  <div className=\"mt-1\">\n                    <Badge className={getStatusColor(selectedDocument.status)}>\n                      {selectedDocument.status === 'valid' ? 'Valid' : \n                       selectedDocument.status === 'expiring' ? 'Expiring' : 'Expired'}\n                    </Badge>\n                  </div>\n                </div>\n              </div>\n              \n              <div>\n                <label className=\"text-sm font-medium text-gray-500\">Document Number</label>\n                <p className=\"text-sm font-semibold\">{selectedDocument.documentNumber}</p>\n              </div>\n              \n              <div>\n                <label className=\"text-sm font-medium text-gray-500\">Issuing Authority</label>\n                <p className=\"text-sm\">{selectedDocument.issuingAuthority}</p>\n              </div>\n              \n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-sm font-medium text-gray-500\">Issue Date</label>\n                  <p className=\"text-sm\">{formatDate(selectedDocument.issueDate)}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium text-gray-500\">Expiry Date</label>\n                  <p className=\"text-sm\">{formatDate(selectedDocument.expiryDate)}</p>\n                </div>\n              </div>\n              \n              {user?.role !== 'crew' && (\n                <div>\n                  <label className=\"text-sm font-medium text-gray-500\">Crew Member</label>\n                  <p className=\"text-sm\">{getCrewMemberName(selectedDocument.crewMemberId)}</p>\n                </div>\n              )}\n\n              {/* Document Preview and Download */}\n              {selectedDocument.filePath && (\n                <div className=\"border-t pt-4 mt-4\">\n                  <label className=\"text-sm font-medium text-gray-500 mb-2 block\">Attached Document</label>\n                  <div className=\"bg-gray-50 rounded-lg p-4 border\">\n                    <div className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center space-x-3\">\n                        <FileText className=\"h-8 w-8 text-maritime-navy\" />\n                        <div>\n                          <p className=\"text-sm font-medium\">{selectedDocument.documentNumber || 'Document'}</p>\n                          <p className=\"text-xs text-gray-500\">Click to download or view</p>\n                        </div>\n                      </div>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"bg-green-50 text-green-700 border-green-200 hover:bg-green-100\"\n                        onClick={() => {\n                          window.open(`/api/documents/${selectedDocument.id}/download`, '_blank');\n                        }}\n                        data-testid=\"download-document-modal\"\n                      >\n                        <Download className=\"h-4 w-4 mr-2\" />\n                        Download\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Document Modal */}\n      <Dialog open={isEditModalOpen} onOpenChange={setIsEditModalOpen}>\n        <DialogContent className=\"max-w-md max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center space-x-2\">\n              <Edit className=\"h-5 w-5 text-primary\" />\n              <span>Edit Document</span>\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedDocument && (\n            <DocumentUpload \n              crewMemberId={selectedDocument.crewMemberId}\n              document={selectedDocument}\n              onSuccess={() => {\n                setIsEditModalOpen(false);\n                setSelectedDocument(null);\n              }}\n            />\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Modal */}\n      <AlertDialog open={isDeleteModalOpen} onOpenChange={setIsDeleteModalOpen}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Document</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete this document? This action cannot be undone.\n              {selectedDocument && (\n                <div className=\"mt-2 p-2 bg-gray-50 rounded\">\n                  <strong>{selectedDocument.type.toUpperCase()}</strong> - {selectedDocument.documentNumber}\n                </div>\n              )}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-red-600 hover:bg-red-700\"\n              disabled={deleteDocumentMutation.isPending}\n            >\n              {deleteDocumentMutation.isPending ? 'Deleting...' : 'Delete'}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":23773,"size_tokens":null},"client/src/pages/notifications.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { format } from 'date-fns';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Switch } from '@/components/ui/switch';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Separator } from '@/components/ui/separator';\nimport { Badge } from '@/components/ui/badge';\nimport { \n  Mail, \n  Bell, \n  Send,\n  TestTube,\n  Clock,\n  User,\n  AlertTriangle\n} from 'lucide-react';\nimport { queryClient, apiRequest } from '@/lib/queryClient';\n\nexport default function Notifications() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [testEmailSent, setTestEmailSent] = useState(false);\n\n  // Email Settings Query\n  const { data: emailSettings, isLoading: emailLoading } = useQuery({\n    queryKey: ['/api/email-settings'],\n    queryFn: async () => {\n      const response = await fetch('/api/email-settings', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch email settings');\n      return response.json();\n    },\n  });\n\n  // Email Settings Mutation\n  const updateEmailSettings = useMutation({\n    mutationFn: async (settings: any) => {\n      return apiRequest('PUT', '/api/email-settings', settings);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/email-settings'] });\n      toast({\n        title: 'Success',\n        description: 'Email settings updated successfully',\n      });\n    },\n    onError: () => {\n      toast({\n        title: 'Error',\n        description: 'Failed to update email settings',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  // Test Email Mutation\n  const sendTestEmail = useMutation({\n    mutationFn: async () => {\n      return apiRequest('POST', '/api/email/send-test', {});\n    },\n    onSuccess: () => {\n      setTestEmailSent(true);\n      toast({\n        title: 'Success',\n        description: 'Test email sent successfully',\n      });\n    },\n    onError: () => {\n      toast({\n        title: 'Error',\n        description: 'Failed to send test email',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleEmailSettingsUpdate = (field: string, value: any) => {\n    const updatedSettings = {\n      ...emailSettings,\n      [field]: value,\n    };\n    updateEmailSettings.mutate(updatedSettings);\n  };\n\n  if (user?.role === 'crew') {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"text-center py-12\">\n          <Bell className=\"h-16 w-16 mx-auto text-gray-300 mb-4\" />\n          <h2 className=\"text-2xl font-semibold text-foreground mb-2\">Access Restricted</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            Email notifications are only accessible to admin and office staff members.\n          </p>\n          <Button\n            onClick={() => window.location.href = '/dashboard'}\n            className=\"bg-maritime-navy hover:bg-blue-800\"\n          >\n            Go to Dashboard\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold text-foreground mb-2\" data-testid=\"notifications-title\">\n            Email Notifications\n          </h2>\n          <p className=\"text-muted-foreground\">\n            Configure email notification settings and preferences\n          </p>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        {/* Email Configuration */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center\">\n              <Mail className=\"h-5 w-5 mr-2\" />\n              Email Configuration\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            {emailLoading ? (\n              <div className=\"text-center py-8\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto\"></div>\n                <p className=\"text-sm text-muted-foreground mt-2\">Loading settings...</p>\n              </div>\n            ) : (\n              <>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <Label className=\"text-base font-medium\">Email Notifications</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Enable email notifications for alerts\n                    </p>\n                  </div>\n                  <Switch \n                    checked={emailSettings?.enabled ?? true}\n                    onCheckedChange={(checked) => handleEmailSettingsUpdate('enabled', checked)}\n                  />\n                </div>\n\n                <Separator />\n\n                <div>\n                  <Label className=\"text-base font-medium mb-3 block\">Notification Recipients</Label>\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <Label className=\"text-sm\">Crew Members</Label>\n                      <Switch \n                        checked={emailSettings?.recipients?.includes('crew') ?? true}\n                        onCheckedChange={(checked) => {\n                          const recipients = emailSettings?.recipients || [];\n                          const newRecipients = checked \n                            ? [...recipients.filter((r: string) => r !== 'crew'), 'crew']\n                            : recipients.filter((r: string) => r !== 'crew');\n                          handleEmailSettingsUpdate('recipients', newRecipients);\n                        }}\n                      />\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <Label className=\"text-sm\">Ship Captains</Label>\n                      <Switch \n                        checked={emailSettings?.recipients?.includes('captain') ?? true}\n                        onCheckedChange={(checked) => {\n                          const recipients = emailSettings?.recipients || [];\n                          const newRecipients = checked \n                            ? [...recipients.filter((r: string) => r !== 'captain'), 'captain']\n                            : recipients.filter((r: string) => r !== 'captain');\n                          handleEmailSettingsUpdate('recipients', newRecipients);\n                        }}\n                      />\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <Label className=\"text-sm\">Admin Staff</Label>\n                      <Switch \n                        checked={emailSettings?.recipients?.includes('admin') ?? true}\n                        onCheckedChange={(checked) => {\n                          const recipients = emailSettings?.recipients || [];\n                          const newRecipients = checked \n                            ? [...recipients.filter((r: string) => r !== 'admin'), 'admin']\n                            : recipients.filter((r: string) => r !== 'admin');\n                          handleEmailSettingsUpdate('recipients', newRecipients);\n                        }}\n                      />\n                    </div>\n                  </div>\n                </div>\n              </>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Reminder Settings */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center\">\n              <Clock className=\"h-5 w-5 mr-2\" />\n              Reminder Schedule\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            {emailLoading ? (\n              <div className=\"text-center py-8\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto\"></div>\n              </div>\n            ) : (\n              <>\n                <div>\n                  <Label className=\"text-base font-medium mb-3 block\">Document Expiry Reminders</Label>\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <Label className=\"text-sm font-medium\">30 days before expiry</Label>\n                        <p className=\"text-xs text-muted-foreground\">Early warning for renewals</p>\n                      </div>\n                      <Switch \n                        checked={emailSettings?.reminderDays?.includes(30) ?? true}\n                        onCheckedChange={(checked) => {\n                          const days = emailSettings?.reminderDays || [];\n                          const newDays = checked \n                            ? [...days.filter((d: number) => d !== 30), 30]\n                            : days.filter((d: number) => d !== 30);\n                          handleEmailSettingsUpdate('reminderDays', newDays);\n                        }}\n                      />\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <Label className=\"text-sm font-medium\">15 days before expiry</Label>\n                        <p className=\"text-xs text-muted-foreground\">Standard reminder</p>\n                      </div>\n                      <Switch \n                        checked={emailSettings?.reminderDays?.includes(15) ?? true}\n                        onCheckedChange={(checked) => {\n                          const days = emailSettings?.reminderDays || [];\n                          const newDays = checked \n                            ? [...days.filter((d: number) => d !== 15), 15]\n                            : days.filter((d: number) => d !== 15);\n                          handleEmailSettingsUpdate('reminderDays', newDays);\n                        }}\n                      />\n                    </div>\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <Label className=\"text-sm font-medium\">7 days before expiry</Label>\n                        <p className=\"text-xs text-muted-foreground\">Urgent reminder</p>\n                      </div>\n                      <Switch \n                        checked={emailSettings?.reminderDays?.includes(7) ?? true}\n                        onCheckedChange={(checked) => {\n                          const days = emailSettings?.reminderDays || [];\n                          const newDays = checked \n                            ? [...days.filter((d: number) => d !== 7), 7]\n                            : days.filter((d: number) => d !== 7);\n                          handleEmailSettingsUpdate('reminderDays', newDays);\n                        }}\n                      />\n                    </div>\n                  </div>\n                </div>\n\n                <Separator />\n\n                <div className=\"flex space-x-3\">\n                  <Button\n                    onClick={() => sendTestEmail.mutate()}\n                    disabled={sendTestEmail.isPending}\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"flex-1\"\n                  >\n                    <TestTube className=\"h-4 w-4 mr-2\" />\n                    {sendTestEmail.isPending ? 'Sending...' : 'Send Test Email'}\n                  </Button>\n                </div>\n\n                {testEmailSent && (\n                  <div className=\"flex items-center p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-md\">\n                    <Bell className=\"h-4 w-4 text-green-600 mr-2\" />\n                    <span className=\"text-sm text-green-800 dark:text-green-200\">\n                      Test email sent successfully\n                    </span>\n                  </div>\n                )}\n              </>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Email Template */}\n        <Card className=\"lg:col-span-2\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center\">\n              <Send className=\"h-5 w-5 mr-2\" />\n              Email Template\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            {emailLoading ? (\n              <div className=\"text-center py-8\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto\"></div>\n              </div>\n            ) : (\n              <>\n                <div>\n                  <Label htmlFor=\"email-template\" className=\"text-base font-medium\">\n                    Notification Email Template\n                  </Label>\n                  <p className=\"text-sm text-muted-foreground mb-3\">\n                    Customize the email notification template. Use variables like {'{crewName}'}, {'{documentType}'}, and {'{expiryDate}'}.\n                  </p>\n                  <Textarea\n                    id=\"email-template\"\n                    rows={8}\n                    placeholder={`Subject: Document Expiring Soon - {documentType}\n\nDear {crewName},\n\nThis is a reminder that your {documentType} is expiring on {expiryDate}.\n\nPlease ensure you renew this document before the expiry date to maintain compliance.\n\nIf you have any questions, please contact the office.\n\nBest regards,\nCrewTrack Pro Team`}\n                    value={emailSettings?.emailTemplate || ''}\n                    onChange={(e) => handleEmailSettingsUpdate('emailTemplate', e.target.value)}\n                    className=\"font-mono text-sm\"\n                  />\n                </div>\n\n                <div className=\"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md p-4\">\n                  <div className=\"flex items-start\">\n                    <AlertTriangle className=\"h-5 w-5 text-blue-600 mr-3 mt-0.5\" />\n                    <div>\n                      <h4 className=\"text-sm font-medium text-blue-900 dark:text-blue-100 mb-1\">\n                        Template Variables\n                      </h4>\n                      <p className=\"text-sm text-blue-800 dark:text-blue-200 mb-2\">\n                        Use these variables in your template:\n                      </p>\n                      <ul className=\"text-xs text-blue-700 dark:text-blue-300 space-y-1\">\n                        <li>‚Ä¢ <code>{'{crewName}'}</code> - Crew member's full name</li>\n                        <li>‚Ä¢ <code>{'{documentType}'}</code> - Type of document (Passport, CDC, etc.)</li>\n                        <li>‚Ä¢ <code>{'{expiryDate}'}</code> - Document expiry date</li>\n                        <li>‚Ä¢ <code>{'{daysRemaining}'}</code> - Number of days until expiry</li>\n                        <li>‚Ä¢ <code>{'{vesselName}'}</code> - Current vessel assignment</li>\n                      </ul>\n                    </div>\n                  </div>\n                </div>\n              </>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":15439,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"DEPLOYMENT_GUIDE.md":{"content":"# CrewTrack Pro - Hostinger Deployment Guide\n\n## Overview\nThis guide will help you deploy your maritime crew management system to Hostinger web hosting.\n\n## Prerequisites\n- Hostinger hosting account with Node.js support\n- Database hosting (Hostinger provides MySQL/PostgreSQL)\n- File manager or FTP access to your hosting account\n\n## Step 1: Prepare Your Files\n\n### Files to Upload:\n```\n/\n‚îú‚îÄ‚îÄ dist/                 # Frontend build files\n‚îú‚îÄ‚îÄ server/              # Backend Node.js files\n‚îú‚îÄ‚îÄ shared/              # Shared schema files\n‚îú‚îÄ‚îÄ package.json         # Dependencies\n‚îú‚îÄ‚îÄ package-lock.json    # Lock file\n‚îú‚îÄ‚îÄ drizzle.config.ts    # Database config\n‚îú‚îÄ‚îÄ tsconfig.json        # TypeScript config\n‚îú‚îÄ‚îÄ .env.example         # Environment template\n‚îî‚îÄ‚îÄ eng.traineddata      # OCR language data\n```\n\n## Step 2: Database Setup\n\n### Option A: PostgreSQL (Recommended)\n1. Create a PostgreSQL database in Hostinger control panel\n2. Note down:\n   - Database name\n   - Username\n   - Password\n   - Host\n   - Port\n\n### Option B: MySQL (Alternative)\n1. Create MySQL database in Hostinger control panel\n2. You'll need to modify the database configuration\n\n## Step 3: Environment Configuration\n\nCreate `.env` file with your database credentials:\n\n```env\n# Database Configuration\nDATABASE_URL=\"postgresql://username:password@host:port/database_name\"\nPGHOST=your_host\nPGPORT=5432\nPGUSER=your_username\nPGPASSWORD=your_password\nPGDATABASE=your_database_name\n\n# Node Environment\nNODE_ENV=production\nPORT=3000\n\n# Optional: OpenAI API Key (for enhanced OCR features)\nOPENAI_API_KEY=your_openai_key_if_needed\n```\n\n## Step 4: Hostinger Setup Steps\n\n### 1. Upload Files\n- Use Hostinger File Manager or FTP client\n- Upload all files to your domain's public_html folder\n- Ensure proper file permissions (755 for directories, 644 for files)\n\n### 2. Install Dependencies\n- Access SSH terminal in Hostinger control panel\n- Navigate to your domain folder\n- Run: `npm install --production`\n\n### 3. Database Migration\n- Run: `npm run db:push`\n- This creates all necessary tables\n\n### 4. Start Application\n- Run: `npm start` or use Hostinger's Node.js application manager\n- Set startup file to: `server/index.js`\n\n## Step 5: Domain Configuration\n\n### DNS Settings:\n- Point your domain to Hostinger's servers\n- Configure subdomain if needed (e.g., crewtrack.yourdomain.com)\n\n### SSL Certificate:\n- Enable free SSL certificate in Hostinger control panel\n- Ensure HTTPS is working\n\n## Step 6: Testing\n\n1. Visit your domain\n2. Test login with demo credentials:\n   - Admin: admin / admin123\n   - Office Staff: office / demo123\n3. Test core features:\n   - Add crew member\n   - Upload document with OCR\n   - View dashboard statistics\n\n## File Structure on Server\n\n```\npublic_html/\n‚îú‚îÄ‚îÄ dist/                    # React frontend (static files)\n‚îÇ   ‚îú‚îÄ‚îÄ index.html\n‚îÇ   ‚îú‚îÄ‚îÄ assets/\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ server/                  # Node.js backend\n‚îÇ   ‚îú‚îÄ‚îÄ index.js\n‚îÇ   ‚îú‚îÄ‚îÄ routes.js\n‚îÇ   ‚îú‚îÄ‚îÄ storage.js\n‚îÇ   ‚îú‚îÄ‚îÄ db.js\n‚îÇ   ‚îú‚îÄ‚îÄ localOcrService.js\n‚îÇ   ‚îî‚îÄ‚îÄ ...\n‚îú‚îÄ‚îÄ shared/\n‚îÇ   ‚îî‚îÄ‚îÄ schema.js\n‚îú‚îÄ‚îÄ package.json\n‚îú‚îÄ‚îÄ .env\n‚îî‚îÄ‚îÄ eng.traineddata\n```\n\n## Troubleshooting\n\n### Common Issues:\n\n**Database Connection Error:**\n- Verify DATABASE_URL format\n- Check database credentials\n- Ensure database server is accessible\n\n**Port Conflicts:**\n- Hostinger may assign different ports\n- Check Hostinger's Node.js app settings\n- Update PORT in .env file\n\n**File Permissions:**\n- Set directories to 755: `chmod -R 755 public_html`\n- Set files to 644: `chmod -R 644 public_html/*`\n\n**Node.js Version:**\n- Ensure Hostinger supports Node.js 18+\n- Check in hosting control panel\n\n### Performance Optimization:\n\n1. **Enable Gzip Compression**\n2. **Set up CDN** (if available in your plan)\n3. **Configure Caching Headers**\n4. **Monitor Resource Usage**\n\n## Security Considerations\n\n1. **Environment Variables:**\n   - Never commit .env to version control\n   - Use strong database passwords\n\n2. **HTTPS:**\n   - Always use SSL certificate\n   - Force HTTPS redirects\n\n3. **Database Security:**\n   - Use restricted database users\n   - Regular backups\n\n## Backup Strategy\n\n1. **Database Backups:**\n   - Set up automatic database backups in Hostinger\n   - Export data regularly\n\n2. **File Backups:**\n   - Keep local copies of your code\n   - Use Hostinger's backup features\n\n## Support\n\nIf you encounter issues:\n1. Check Hostinger's Node.js documentation\n2. Review error logs in hosting control panel\n3. Test locally first before deploying changes\n\n## Production Checklist\n\n- [ ] Database created and configured\n- [ ] Environment variables set\n- [ ] Files uploaded with correct permissions\n- [ ] Dependencies installed\n- [ ] Database migrated\n- [ ] Application started\n- [ ] Domain configured\n- [ ] SSL certificate enabled\n- [ ] Basic functionality tested\n- [ ] Backups configured\n\n---\n\n**Note:** This system includes advanced features like OCR document processing and real-time notifications. Ensure your Hostinger plan supports the required Node.js features and database connections.","path":null,"size_bytes":5166,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":1901,"size_tokens":null},"client/src/components/vessels/contract-status-badges.tsx":{"content":"import { useQuery } from '@tanstack/react-query';\nimport { AlertTriangle } from 'lucide-react';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog';\nimport { useState } from 'react';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { formatDate } from '@/lib/utils';\n\ninterface ContractStats {\n  active: number;\n  expiringSoon: number;\n  expired: number;\n}\n\ninterface ContractStatusBadgesProps {\n  vesselId: string;\n}\n\ninterface ContractWithCrew {\n  id: string;\n  crewMemberId: string;\n  startDate: string;\n  endDate: string;\n  status: string;\n  crewMember: {\n    firstName: string;\n    lastName: string;\n    rank: string;\n  };\n}\n\nexport function ContractStatusBadges({ vesselId }: ContractStatusBadgesProps) {\n  const [selectedStatus, setSelectedStatus] = useState<string | null>(null);\n  \n  const { data: stats } = useQuery({\n    queryKey: ['/api/vessels', vesselId, 'contract-stats'],\n    queryFn: async () => {\n      const response = await fetch(`/api/vessels/${vesselId}/contract-stats`, {\n        headers: getAuthHeaders(),\n      });\n      return response.json() as Promise<ContractStats>;\n    },\n  });\n\n  const { data: contracts } = useQuery({\n    queryKey: ['/api/vessels', vesselId, 'contracts', selectedStatus],\n    queryFn: async () => {\n      const statusParam = selectedStatus ? `?status=${selectedStatus}` : '';\n      const response = await fetch(`/api/vessels/${vesselId}/contracts${statusParam}`, {\n        headers: getAuthHeaders(),\n      });\n      return response.json() as Promise<ContractWithCrew[]>;\n    },\n    enabled: !!selectedStatus,\n  });\n\n  if (!stats) return null;\n\n  const handleStatusClick = (status: string) => {\n    setSelectedStatus(status);\n  };\n\n  const closeDialog = () => {\n    setSelectedStatus(null);\n  };\n\n  const getRemainingDays = (endDate: string) => {\n    const end = new Date(endDate);\n    const now = new Date();\n    const diffTime = end.getTime() - now.getTime();\n    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n  };\n\n  const getStatusTitle = (status: string) => {\n    switch (status) {\n      case 'active':\n        return 'Active Contracts';\n      case 'expiring':\n        return 'Expiring Soon';\n      case 'expired':\n        return 'Expired Contracts';\n      default:\n        return 'Contracts';\n    }\n  };\n\n  return (\n    <>\n      <div className=\"flex items-center space-x-1 text-xs flex-wrap gap-1\">\n        {/* Active Contracts */}\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"h-auto p-1 text-xs\"\n          onClick={() => handleStatusClick('active')}\n          data-testid={`active-contracts-${vesselId}`}\n        >\n          <Badge \n            variant=\"secondary\" \n            className=\"bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border-green-200 dark:border-green-700 hover:bg-green-200 dark:hover:bg-green-800 transition-colors mobile-status-badge\"\n          >\n            <span className=\"mobile-status-text\">Active: {stats.active}</span>\n          </Badge>\n        </Button>\n\n        {/* Expiring Soon */}\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"h-auto p-1 text-xs\"\n          onClick={() => handleStatusClick('expiring')}\n          data-testid={`expiring-contracts-${vesselId}`}\n        >\n          <Badge \n            variant=\"secondary\" \n            className=\"bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200 border-orange-200 dark:border-orange-700 hover:bg-orange-200 dark:hover:bg-orange-800 transition-colors mobile-status-badge\"\n          >\n            <span className=\"mobile-status-text\">Expiring: {stats.expiringSoon}</span>\n            {stats.expiringSoon > 0 && <AlertTriangle className=\"h-3 w-3 ml-1\" />}\n          </Badge>\n        </Button>\n\n        {/* Expired */}\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"h-auto p-1 text-xs\"\n          onClick={() => handleStatusClick('expired')}\n          data-testid={`expired-contracts-${vesselId}`}\n        >\n          <Badge \n            variant=\"secondary\" \n            className=\"bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 border-red-200 dark:border-red-700 hover:bg-red-200 dark:hover:bg-red-800 transition-colors mobile-status-badge\"\n          >\n            <span className=\"mobile-status-text\">Expired: {stats.expired}</span>\n          </Badge>\n        </Button>\n      </div>\n\n      {/* Contract Details Dialog */}\n      <Dialog open={!!selectedStatus} onOpenChange={closeDialog}>\n        <DialogContent className=\"sm:max-w-[600px]\" aria-describedby=\"contract-details-description\">\n          <DialogHeader>\n            <DialogTitle>{getStatusTitle(selectedStatus || '')}</DialogTitle>\n            <DialogDescription id=\"contract-details-description\">\n              Contract details for this vessel\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"max-h-[400px] overflow-y-auto\">\n            {contracts && contracts.length > 0 ? (\n              <div className=\"space-y-3\">\n                {contracts.map((contract) => {\n                  const remainingDays = getRemainingDays(contract.endDate);\n                  const isExpiring = remainingDays <= 45 && remainingDays > 0;\n                  const isExpired = remainingDays < 0;\n                  \n                  return (\n                    <div \n                      key={contract.id} \n                      className=\"p-4 border border-border rounded-lg bg-card\"\n                      data-testid={`contract-item-${contract.id}`}\n                    >\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <div>\n                          <h4 className=\"font-medium text-foreground\">\n                            {contract.crewMember.firstName} {contract.crewMember.lastName}\n                          </h4>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {contract.crewMember.rank}\n                          </p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"text-sm font-medium text-foreground\">\n                            {isExpired \n                              ? `Expired ${Math.abs(remainingDays)} days ago`\n                              : isExpiring \n                                ? `${remainingDays} days remaining`\n                                : `${remainingDays} days remaining`\n                            }\n                          </p>\n                          {isExpiring && (\n                            <div className=\"flex items-center text-orange-600 dark:text-orange-400 text-xs mt-1\">\n                              <AlertTriangle className=\"h-3 w-3 mr-1\" />\n                              Expiring Soon\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex items-center justify-between text-sm text-muted-foreground\">\n                        <span>Start: {formatDate(contract.startDate)}</span>\n                        <span>End: {formatDate(contract.endDate)}</span>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            ) : (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                <p>No {selectedStatus} contracts found for this vessel.</p>\n              </div>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}","path":null,"size_bytes":7758,"size_tokens":null},"client/src/components/crew/add-contract-form.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\nimport { useQuery } from '@tanstack/react-query';\nimport { OCRDocumentScanner } from './OCRDocumentScanner';\nimport { FileText, Loader2 } from 'lucide-react';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\n\ninterface AddContractFormProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport default function AddContractForm({ open, onOpenChange }: AddContractFormProps) {\n  const { toast } = useToast();\n  \n  const [seafarerName, setSeafarerName] = useState('');\n  const [seafarerRank, setSeafarerRank] = useState('');\n  const [seafarerNationality, setSeafarerNationality] = useState('');\n  const [seafarerDatePlaceOfBirth, setSeafarerDatePlaceOfBirth] = useState('');\n  const [seafarerIndosNumber, setSeafarerIndosNumber] = useState('');\n  const [seafarerPostalAddress, setSeafarerPostalAddress] = useState('');\n  const [seafarerEmail, setSeafarerEmail] = useState('');\n  const [seafarerMobile, setSeafarerMobile] = useState('');\n\n  const [cdcNumber, setCdcNumber] = useState('');\n  const [cdcPlaceOfIssue, setCdcPlaceOfIssue] = useState('');\n  const [cdcIssueDate, setCdcIssueDate] = useState('');\n  const [cdcExpiryDate, setCdcExpiryDate] = useState('');\n\n  const [passportNumber, setPassportNumber] = useState('');\n  const [passportPlaceOfIssue, setPassportPlaceOfIssue] = useState('');\n  const [passportIssueDate, setPassportIssueDate] = useState('');\n  const [passportExpiryDate, setPassportExpiryDate] = useState('');\n\n  const [nokName, setNokName] = useState('');\n  const [nokRelationship, setNokRelationship] = useState('');\n  const [nokEmail, setNokEmail] = useState('');\n  const [nokTelephone, setNokTelephone] = useState('');\n  const [nokPostalAddress, setNokPostalAddress] = useState('');\n\n  const [cocGradeNo, setCocGradeNo] = useState('');\n  const [cocPlaceOfIssue, setCocPlaceOfIssue] = useState('');\n  const [cocIssueDate, setCocIssueDate] = useState('');\n  const [cocExpiryDate, setCocExpiryDate] = useState('');\n\n  const [medicalIssuingAuthority, setMedicalIssuingAuthority] = useState('');\n  const [medicalApprovalNo, setMedicalApprovalNo] = useState('');\n  const [medicalIssueDate, setMedicalIssueDate] = useState('');\n  const [medicalExpiryDate, setMedicalExpiryDate] = useState('');\n\n  const [selectedVesselId, setSelectedVesselId] = useState('');\n  const [scannedShipName, setScannedShipName] = useState('');\n\n  const [contractStartDate, setContractStartDate] = useState('');\n  const [contractDays, setContractDays] = useState<number | ''>('');\n  const [contractEndDate, setContractEndDate] = useState('');\n  const [isSaving, setIsSaving] = useState(false);\n  const [appliedRecordId, setAppliedRecordId] = useState<string | null>(null);\n  const [appliedRecordName, setAppliedRecordName] = useState<string | null>(null);\n\n  // Fetch vessels for dropdown\n  const { data: vessels } = useQuery({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  // Auto-match scanned ship name with vessel\n  useEffect(() => {\n    if (scannedShipName && vessels && vessels.length > 0) {\n      const matchedVessel = vessels.find((v: any) => \n        v.name.toUpperCase().trim() === scannedShipName.toUpperCase().trim()\n      );\n      if (matchedVessel) {\n        setSelectedVesselId(matchedVessel.id);\n      }\n    }\n  }, [scannedShipName, vessels]);\n\n  // Auto-calculate contract end date\n  useEffect(() => {\n    if (contractStartDate && contractDays && contractDays > 0) {\n      const start = new Date(contractStartDate);\n      const end = new Date(start);\n      end.setDate(start.getDate() + contractDays);\n      setContractEndDate(end.toISOString().split('T')[0]);\n    } else {\n      setContractEndDate('');\n    }\n  }, [contractStartDate, contractDays]);\n\n  const resetForm = () => {\n    setSeafarerName('');\n    setSeafarerRank('');\n    setSeafarerNationality('');\n    setSeafarerDatePlaceOfBirth('');\n    setSeafarerIndosNumber('');\n    setSeafarerPostalAddress('');\n    setSeafarerEmail('');\n    setSeafarerMobile('');\n    setCdcNumber('');\n    setCdcPlaceOfIssue('');\n    setCdcIssueDate('');\n    setCdcExpiryDate('');\n    setPassportNumber('');\n    setPassportPlaceOfIssue('');\n    setPassportIssueDate('');\n    setPassportExpiryDate('');\n    setNokName('');\n    setNokRelationship('');\n    setNokEmail('');\n    setNokTelephone('');\n    setNokPostalAddress('');\n    setCocGradeNo('');\n    setCocPlaceOfIssue('');\n    setCocIssueDate('');\n    setCocExpiryDate('');\n    setMedicalIssuingAuthority('');\n    setMedicalApprovalNo('');\n    setMedicalIssueDate('');\n    setMedicalExpiryDate('');\n    setSelectedVesselId('');\n    setScannedShipName('');\n    setContractStartDate('');\n    setContractDays('');\n    setContractEndDate('');\n    setIsSaving(false);\n    setAppliedRecordId(null);\n    setAppliedRecordName(null);\n  };\n\n  const handleOCRDataExtracted = (extractedData: any) => {\n    if (extractedData.seafarerName) {\n      setSeafarerName(extractedData.seafarerName);\n    }\n    if (extractedData.seafarerRank || extractedData.capacityRankEmployed) {\n      setSeafarerRank(extractedData.seafarerRank || extractedData.capacityRankEmployed);\n    }\n    if (extractedData.seafarerNationality) {\n      setSeafarerNationality(extractedData.seafarerNationality);\n    }\n    if (extractedData.seafarerDatePlaceOfBirth) {\n      setSeafarerDatePlaceOfBirth(extractedData.seafarerDatePlaceOfBirth);\n    }\n    if (extractedData.seafarerIndosNumber) {\n      setSeafarerIndosNumber(extractedData.seafarerIndosNumber);\n    }\n    if (extractedData.seafarerPostalAddress) {\n      setSeafarerPostalAddress(extractedData.seafarerPostalAddress);\n    }\n    if (extractedData.seafarerEmail) {\n      setSeafarerEmail(extractedData.seafarerEmail);\n    }\n    if (extractedData.seafarerMobile) {\n      setSeafarerMobile(extractedData.seafarerMobile);\n    }\n    if (extractedData.cdcNumber) {\n      setCdcNumber(extractedData.cdcNumber);\n    }\n    if (extractedData.cdcPlaceOfIssue) {\n      setCdcPlaceOfIssue(extractedData.cdcPlaceOfIssue);\n    }\n    if (extractedData.cdcIssueDate) {\n      setCdcIssueDate(extractedData.cdcIssueDate);\n    }\n    if (extractedData.cdcExpiryDate) {\n      setCdcExpiryDate(extractedData.cdcExpiryDate);\n    }\n    if (extractedData.passportNumber) {\n      setPassportNumber(extractedData.passportNumber);\n    }\n    if (extractedData.passportPlaceOfIssue) {\n      setPassportPlaceOfIssue(extractedData.passportPlaceOfIssue);\n    }\n    if (extractedData.passportIssueDate) {\n      setPassportIssueDate(extractedData.passportIssueDate);\n    }\n    if (extractedData.passportExpiryDate) {\n      setPassportExpiryDate(extractedData.passportExpiryDate);\n    }\n    if (extractedData.nokName) {\n      setNokName(extractedData.nokName);\n    }\n    if (extractedData.nokRelationship) {\n      setNokRelationship(extractedData.nokRelationship);\n    }\n    if (extractedData.nokEmail) {\n      setNokEmail(extractedData.nokEmail);\n    }\n    if (extractedData.nokTelephone) {\n      setNokTelephone(extractedData.nokTelephone);\n    }\n    if (extractedData.nokPostalAddress) {\n      setNokPostalAddress(extractedData.nokPostalAddress);\n    }\n    if (extractedData.cocGradeNo) {\n      setCocGradeNo(extractedData.cocGradeNo);\n    }\n    if (extractedData.cocPlaceOfIssue) {\n      setCocPlaceOfIssue(extractedData.cocPlaceOfIssue);\n    }\n    if (extractedData.cocIssueDate) {\n      setCocIssueDate(extractedData.cocIssueDate);\n    }\n    if (extractedData.cocExpiryDate) {\n      setCocExpiryDate(extractedData.cocExpiryDate);\n    }\n    if (extractedData.medicalIssuingAuthority) {\n      setMedicalIssuingAuthority(extractedData.medicalIssuingAuthority);\n    }\n    if (extractedData.medicalApprovalNo) {\n      setMedicalApprovalNo(extractedData.medicalApprovalNo);\n    }\n    if (extractedData.medicalIssueDate) {\n      setMedicalIssueDate(extractedData.medicalIssueDate);\n    }\n    if (extractedData.medicalExpiryDate) {\n      setMedicalExpiryDate(extractedData.medicalExpiryDate);\n    }\n    if (extractedData.shipName) {\n      setScannedShipName(extractedData.shipName);\n    }\n    if (extractedData.engagementPeriodMonths) {\n      // Convert months to days (30 days per month)\n      const days = extractedData.engagementPeriodMonths * 30;\n      setContractDays(days);\n    }\n\n    if (extractedData.recordId) {\n      setAppliedRecordId(extractedData.recordId);\n      setAppliedRecordName(extractedData.displayName || extractedData.seafarerName || 'Unknown');\n    }\n\n    toast({\n      title: \"Document Scanned Successfully\",\n      description: extractedData.displayName \n        ? `Applied data from record: ${extractedData.displayName}`\n        : \"Seafarer details extracted from the document.\",\n    });\n  };\n\n  const handleSave = async () => {\n    // Validation\n    if (!seafarerName.trim()) {\n      toast({\n        title: 'Missing Information',\n        description: 'Please enter the seafarer name.',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    if (!selectedVesselId) {\n      toast({\n        title: 'Missing Information',\n        description: 'Please select a vessel.',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    if (!contractStartDate || !contractEndDate) {\n      toast({\n        title: 'Missing Information',\n        description: 'Please enter contract start date and duration.',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    setIsSaving(true);\n\n    try {\n      // Parse name into first and last name\n      const nameParts = seafarerName.trim().split(' ');\n      const firstName = nameParts[0] || '';\n      const lastName = nameParts.slice(1).join(' ') || nameParts[0] || '';\n\n      // Parse date of birth from seafarerDatePlaceOfBirth (format: \"09-MAR-1982 & ROHTAS-BIHAR\")\n      let dateOfBirth = new Date(1990, 0, 1); // Default date if parsing fails\n      if (seafarerDatePlaceOfBirth) {\n        const dobMatch = seafarerDatePlaceOfBirth.match(/(\\d{1,2})[-/](\\w{3})[-/](\\d{4})/);\n        if (dobMatch) {\n          const day = parseInt(dobMatch[1], 10);\n          const monthStr = dobMatch[2].toUpperCase();\n          const year = parseInt(dobMatch[3], 10);\n          \n          const monthMap: Record<string, number> = {\n            'JAN': 0, 'FEB': 1, 'MAR': 2, 'APR': 3, 'MAY': 4, 'JUN': 5,\n            'JUL': 6, 'AUG': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DEC': 11\n          };\n          \n          const month = monthMap[monthStr];\n          if (month !== undefined && !isNaN(day) && !isNaN(year)) {\n            dateOfBirth = new Date(year, month, day);\n          }\n        }\n      }\n\n      // Build emergency contact only if any NOK data is provided\n      const hasEmergencyContact = nokName || nokRelationship || nokTelephone || nokEmail || nokPostalAddress;\n      const emergencyContact = hasEmergencyContact ? {\n        name: nokName || '',\n        relationship: nokRelationship || '',\n        phone: nokTelephone || '',\n        email: nokEmail || '',\n        postalAddress: nokPostalAddress || '',\n      } : null;\n\n      // Create crew member first\n      const crewMemberData: Record<string, unknown> = {\n        firstName,\n        lastName,\n        nationality: seafarerNationality || 'Unknown',\n        dateOfBirth: dateOfBirth.toISOString(),\n        rank: seafarerRank || cocGradeNo || 'Crew',\n        currentVesselId: selectedVesselId,\n        status: 'onBoard',\n      };\n\n      // Only add optional fields if they have values\n      if (seafarerMobile) crewMemberData.phoneNumber = seafarerMobile;\n      if (seafarerEmail) crewMemberData.email = seafarerEmail;\n      if (emergencyContact) crewMemberData.emergencyContact = emergencyContact;\n\n      let crewMember;\n      try {\n        const crewResponse = await apiRequest('POST', '/api/crew', crewMemberData);\n        crewMember = await crewResponse.json();\n      } catch (crewError) {\n        throw new Error(`Failed to create crew member: ${crewError instanceof Error ? crewError.message : 'Unknown error'}`);\n      }\n\n      // Create contract for the crew member\n      const contractData = {\n        crewMemberId: crewMember.id,\n        vesselId: selectedVesselId,\n        startDate: new Date(contractStartDate).toISOString(),\n        endDate: new Date(contractEndDate).toISOString(),\n        durationDays: typeof contractDays === 'number' ? contractDays : null,\n        status: 'active',\n      };\n\n      try {\n        await apiRequest('POST', '/api/contracts', contractData);\n      } catch (contractError) {\n        throw new Error(`Crew member created, but failed to create contract: ${contractError instanceof Error ? contractError.message : 'Unknown error'}`);\n      }\n\n      // Create documents (passport, CDC, COC, medical) if data is available\n      const createDocument = async (type: string, docNumber: string, placeOfIssue: string, issueDate: string, expiryDate: string) => {\n        if (docNumber && issueDate && expiryDate) {\n          try {\n            await apiRequest('POST', '/api/documents', {\n              crewMemberId: crewMember.id,\n              type,\n              documentNumber: docNumber,\n              issuingAuthority: placeOfIssue || '',\n              issueDate: new Date(issueDate).toISOString(),\n              expiryDate: new Date(expiryDate).toISOString(),\n            });\n          } catch (docError) {\n            console.error(`Failed to create ${type} document:`, docError);\n          }\n        }\n      };\n\n      // Create all documents\n      await createDocument('passport', passportNumber, passportPlaceOfIssue, passportIssueDate, passportExpiryDate);\n      await createDocument('cdc', cdcNumber, cdcPlaceOfIssue, cdcIssueDate, cdcExpiryDate);\n      await createDocument('stcw', cocGradeNo, cocPlaceOfIssue, cocIssueDate, cocExpiryDate);\n      await createDocument('medical', medicalApprovalNo, medicalIssuingAuthority, medicalIssueDate, medicalExpiryDate);\n\n      // Invalidate cache\n      queryClient.invalidateQueries({ queryKey: ['/api/crew'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/contracts'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/documents'] });\n\n      toast({\n        title: 'Contract Created',\n        description: `Contract for ${seafarerName} has been created successfully.`,\n      });\n\n      resetForm();\n      onOpenChange(false);\n    } catch (error) {\n      console.error('Error saving contract:', error);\n      toast({\n        title: 'Error',\n        description: error instanceof Error ? error.message : 'Failed to save contract. Please try again.',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"w-[95vw] max-w-md max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center\">\n            <FileText className=\"w-5 h-5 mr-2 text-purple-600\" />\n            Add Contract\n          </DialogTitle>\n          <DialogDescription>\n            Scan a document to extract seafarer details.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"flex justify-center\">\n            <OCRDocumentScanner \n              onDataExtracted={handleOCRDataExtracted}\n              className=\"w-full\"\n              mode=\"seafarer\"\n            />\n          </div>\n\n          {appliedRecordId && appliedRecordName && (\n            <div className=\"p-2 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg\">\n              <p className=\"text-sm text-green-800 dark:text-green-200 flex items-center\">\n                <span className=\"w-2 h-2 bg-green-600 rounded-full mr-2\"></span>\n                Data applied from: <span className=\"font-medium ml-1\">{appliedRecordName}</span>\n                <span className=\"text-xs text-green-600 dark:text-green-400 ml-2\">(ID: {appliedRecordId.slice(-8)})</span>\n              </p>\n            </div>\n          )}\n\n          <div className=\"space-y-3 p-3 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg\">\n            <h4 className=\"font-medium text-blue-900 dark:text-blue-100 flex items-center\">\n              <div className=\"w-2 h-2 bg-blue-600 rounded-full mr-2\"></div>\n              Seafarer Details\n            </h4>\n            <div className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"seafarer-name\">Name</Label>\n                <Input \n                  id=\"seafarer-name\"\n                  placeholder=\"Seafarer name\"\n                  value={seafarerName}\n                  onChange={(e) => setSeafarerName(e.target.value)}\n                  data-testid=\"seafarer-name-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"seafarer-rank\">Rank / Capacity Employed</Label>\n                <Input \n                  id=\"seafarer-rank\"\n                  placeholder=\"e.g., Master (NCV)\"\n                  value={seafarerRank}\n                  onChange={(e) => setSeafarerRank(e.target.value)}\n                  data-testid=\"seafarer-rank-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"seafarer-nationality\">Nationality</Label>\n                <Input \n                  id=\"seafarer-nationality\"\n                  placeholder=\"Nationality\"\n                  value={seafarerNationality}\n                  onChange={(e) => setSeafarerNationality(e.target.value)}\n                  data-testid=\"seafarer-nationality-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"seafarer-dob-place\">Date and Place of Birth</Label>\n                <Input \n                  id=\"seafarer-dob-place\"\n                  placeholder=\"e.g., 09-MAR-1982 & ROHTAS-BIHAR\"\n                  value={seafarerDatePlaceOfBirth}\n                  onChange={(e) => setSeafarerDatePlaceOfBirth(e.target.value)}\n                  data-testid=\"seafarer-dob-place-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"seafarer-indos\">INDOS No.</Label>\n                <Input \n                  id=\"seafarer-indos\"\n                  placeholder=\"INDOS number\"\n                  value={seafarerIndosNumber}\n                  onChange={(e) => setSeafarerIndosNumber(e.target.value)}\n                  data-testid=\"seafarer-indos-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"seafarer-address\">Postal Address</Label>\n                <Input \n                  id=\"seafarer-address\"\n                  placeholder=\"Full postal address\"\n                  value={seafarerPostalAddress}\n                  onChange={(e) => setSeafarerPostalAddress(e.target.value)}\n                  data-testid=\"seafarer-address-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"seafarer-email\">Email</Label>\n                <Input \n                  id=\"seafarer-email\"\n                  placeholder=\"Email address\"\n                  type=\"email\"\n                  value={seafarerEmail}\n                  onChange={(e) => setSeafarerEmail(e.target.value)}\n                  data-testid=\"seafarer-email-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"seafarer-mobile\">Mobile</Label>\n                <Input \n                  id=\"seafarer-mobile\"\n                  placeholder=\"Mobile number\"\n                  value={seafarerMobile}\n                  onChange={(e) => setSeafarerMobile(e.target.value)}\n                  data-testid=\"seafarer-mobile-input\"\n                />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-3 p-3 bg-purple-50 dark:bg-purple-950/20 border border-purple-200 dark:border-purple-800 rounded-lg\">\n            <h4 className=\"font-medium text-purple-900 dark:text-purple-100 flex items-center\">\n              <div className=\"w-2 h-2 bg-purple-600 rounded-full mr-2\"></div>\n              CDC No.\n            </h4>\n            <div className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"cdc-number\">CDC No.</Label>\n                <Input \n                  id=\"cdc-number\"\n                  placeholder=\"e.g., MUM 132798\"\n                  value={cdcNumber}\n                  onChange={(e) => setCdcNumber(e.target.value)}\n                  data-testid=\"cdc-number-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"cdc-place-of-issue\">Place of Issue</Label>\n                <Input \n                  id=\"cdc-place-of-issue\"\n                  placeholder=\"e.g., MUMBAI\"\n                  value={cdcPlaceOfIssue}\n                  onChange={(e) => setCdcPlaceOfIssue(e.target.value)}\n                  data-testid=\"cdc-place-of-issue-input\"\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"cdc-issue-date\">Issue Date</Label>\n                  <Input \n                    id=\"cdc-issue-date\"\n                    placeholder=\"e.g., 28-MAR-2025\"\n                    value={cdcIssueDate}\n                    onChange={(e) => setCdcIssueDate(e.target.value)}\n                    data-testid=\"cdc-issue-date-input\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"cdc-expiry-date\">Expiry Date</Label>\n                  <Input \n                    id=\"cdc-expiry-date\"\n                    placeholder=\"e.g., 27-MAR-2035\"\n                    value={cdcExpiryDate}\n                    onChange={(e) => setCdcExpiryDate(e.target.value)}\n                    data-testid=\"cdc-expiry-date-input\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-3 p-3 bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-800 rounded-lg\">\n            <h4 className=\"font-medium text-green-900 dark:text-green-100 flex items-center\">\n              <div className=\"w-2 h-2 bg-green-600 rounded-full mr-2\"></div>\n              Passport Details\n            </h4>\n            <div className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"passport-number\">Passport No.</Label>\n                <Input \n                  id=\"passport-number\"\n                  placeholder=\"e.g., R2826385\"\n                  value={passportNumber}\n                  onChange={(e) => setPassportNumber(e.target.value)}\n                  data-testid=\"passport-number-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"passport-place-of-issue\">Place of Issue</Label>\n                <Input \n                  id=\"passport-place-of-issue\"\n                  placeholder=\"e.g., PATNA\"\n                  value={passportPlaceOfIssue}\n                  onChange={(e) => setPassportPlaceOfIssue(e.target.value)}\n                  data-testid=\"passport-place-of-issue-input\"\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"passport-issue-date\">Issue Date</Label>\n                  <Input \n                    id=\"passport-issue-date\"\n                    placeholder=\"e.g., 04-JUL-2017\"\n                    value={passportIssueDate}\n                    onChange={(e) => setPassportIssueDate(e.target.value)}\n                    data-testid=\"passport-issue-date-input\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"passport-expiry-date\">Expiry Date</Label>\n                  <Input \n                    id=\"passport-expiry-date\"\n                    placeholder=\"e.g., 03-JUL-2027\"\n                    value={passportExpiryDate}\n                    onChange={(e) => setPassportExpiryDate(e.target.value)}\n                    data-testid=\"passport-expiry-date-input\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-3 p-3 bg-amber-50 dark:bg-amber-950/20 border border-amber-200 dark:border-amber-800 rounded-lg\">\n            <h4 className=\"font-medium text-amber-900 dark:text-amber-100 flex items-center\">\n              <div className=\"w-2 h-2 bg-amber-600 rounded-full mr-2\"></div>\n              Next of Kin (NOK)\n            </h4>\n            <div className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"nok-name\">Name</Label>\n                <Input \n                  id=\"nok-name\"\n                  placeholder=\"e.g., MRS. BINITA KUMARI\"\n                  value={nokName}\n                  onChange={(e) => setNokName(e.target.value)}\n                  data-testid=\"nok-name-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"nok-relationship\">Relationship</Label>\n                <Input \n                  id=\"nok-relationship\"\n                  placeholder=\"e.g., WIFE\"\n                  value={nokRelationship}\n                  onChange={(e) => setNokRelationship(e.target.value)}\n                  data-testid=\"nok-relationship-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"nok-email\">Email</Label>\n                <Input \n                  id=\"nok-email\"\n                  placeholder=\"e.g., nok@email.com\"\n                  value={nokEmail}\n                  onChange={(e) => setNokEmail(e.target.value)}\n                  data-testid=\"nok-email-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"nok-telephone\">Telephone No.</Label>\n                <Input \n                  id=\"nok-telephone\"\n                  placeholder=\"e.g., 8538955893\"\n                  value={nokTelephone}\n                  onChange={(e) => setNokTelephone(e.target.value)}\n                  data-testid=\"nok-telephone-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"nok-postal-address\">8a. NOK's Postal Address</Label>\n                <Input \n                  id=\"nok-postal-address\"\n                  placeholder=\"e.g., 102, MOURA ENCLAVE, VIJAY VIHAR COLONY\"\n                  value={nokPostalAddress}\n                  onChange={(e) => setNokPostalAddress(e.target.value)}\n                  data-testid=\"nok-postal-address-input\"\n                />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-3 p-3 bg-indigo-50 dark:bg-indigo-950/20 border border-indigo-200 dark:border-indigo-800 rounded-lg\">\n            <h4 className=\"font-medium text-indigo-900 dark:text-indigo-100 flex items-center\">\n              <div className=\"w-2 h-2 bg-indigo-600 rounded-full mr-2\"></div>\n              Details of Competency Certificates\n            </h4>\n            <div className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"coc-grade-no\">COC Grade / No</Label>\n                <Input \n                  id=\"coc-grade-no\"\n                  placeholder=\"e.g., MASTER (F.G.) / 23-MUM-2024\"\n                  value={cocGradeNo}\n                  onChange={(e) => setCocGradeNo(e.target.value)}\n                  data-testid=\"coc-grade-no-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"coc-place-of-issue\">Place of Issue</Label>\n                <Input \n                  id=\"coc-place-of-issue\"\n                  placeholder=\"e.g., MUMBAI\"\n                  value={cocPlaceOfIssue}\n                  onChange={(e) => setCocPlaceOfIssue(e.target.value)}\n                  data-testid=\"coc-place-of-issue-input\"\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"coc-issue-date\">Date of Issue</Label>\n                  <Input \n                    id=\"coc-issue-date\"\n                    placeholder=\"e.g., 15-JAN-2024\"\n                    value={cocIssueDate}\n                    onChange={(e) => setCocIssueDate(e.target.value)}\n                    data-testid=\"coc-issue-date-input\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"coc-expiry-date\">Date of Expiry</Label>\n                  <Input \n                    id=\"coc-expiry-date\"\n                    placeholder=\"e.g., 14-JAN-2029\"\n                    value={cocExpiryDate}\n                    onChange={(e) => setCocExpiryDate(e.target.value)}\n                    data-testid=\"coc-expiry-date-input\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-3 p-3 bg-rose-50 dark:bg-rose-950/20 border border-rose-200 dark:border-rose-800 rounded-lg\">\n            <h4 className=\"font-medium text-rose-900 dark:text-rose-100 flex items-center\">\n              <div className=\"w-2 h-2 bg-rose-600 rounded-full mr-2\"></div>\n              Details of Medical Certificate\n            </h4>\n            <div className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"medical-issuing-authority\">Issuing Authority</Label>\n                <Input \n                  id=\"medical-issuing-authority\"\n                  placeholder=\"e.g., DR. DIWAKAR TIWARI (GLOBUS MEDICARE)\"\n                  value={medicalIssuingAuthority}\n                  onChange={(e) => setMedicalIssuingAuthority(e.target.value)}\n                  data-testid=\"medical-issuing-authority-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"medical-approval-no\">Approval No</Label>\n                <Input \n                  id=\"medical-approval-no\"\n                  placeholder=\"e.g., MAH/NM/22/2015\"\n                  value={medicalApprovalNo}\n                  onChange={(e) => setMedicalApprovalNo(e.target.value)}\n                  data-testid=\"medical-approval-no-input\"\n                />\n              </div>\n              <div className=\"grid grid-cols-2 gap-3\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"medical-issue-date\">Issue Date</Label>\n                  <Input \n                    id=\"medical-issue-date\"\n                    placeholder=\"e.g., 15-JAN-2025\"\n                    value={medicalIssueDate}\n                    onChange={(e) => setMedicalIssueDate(e.target.value)}\n                    data-testid=\"medical-issue-date-input\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"medical-expiry-date\">Expiry Date</Label>\n                  <Input \n                    id=\"medical-expiry-date\"\n                    placeholder=\"e.g., 14-JAN-2027\"\n                    value={medicalExpiryDate}\n                    onChange={(e) => setMedicalExpiryDate(e.target.value)}\n                    data-testid=\"medical-expiry-date-input\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-3 p-3 bg-cyan-50 dark:bg-cyan-950/20 border border-cyan-200 dark:border-cyan-800 rounded-lg\">\n            <h4 className=\"font-medium text-cyan-900 dark:text-cyan-100 flex items-center\">\n              <div className=\"w-2 h-2 bg-cyan-600 rounded-full mr-2\"></div>\n              Details of Ship\n            </h4>\n            <div className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"ship-name\">Name</Label>\n                <Select value={selectedVesselId} onValueChange={setSelectedVesselId}>\n                  <SelectTrigger id=\"ship-name\" data-testid=\"ship-name-select\">\n                    <SelectValue placeholder=\"Select a vessel\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {vessels && vessels.map((vessel: any) => (\n                      <SelectItem key={vessel.id} value={vessel.id}>\n                        {vessel.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                {scannedShipName && !selectedVesselId && (\n                  <p className=\"text-xs text-amber-600 dark:text-amber-400\">\n                    Scanned: \"{scannedShipName}\" - No matching vessel found\n                  </p>\n                )}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"space-y-3 p-3 bg-teal-50 dark:bg-teal-950/20 border border-teal-200 dark:border-teal-800 rounded-lg\">\n            <h4 className=\"font-medium text-teal-900 dark:text-teal-100 flex items-center\">\n              <div className=\"w-2 h-2 bg-teal-600 rounded-full mr-2\"></div>\n              Contract Information\n            </h4>\n            <div className=\"space-y-3\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"contract-start-date\">Contract Start Date</Label>\n                <Input \n                  id=\"contract-start-date\"\n                  type=\"date\"\n                  value={contractStartDate}\n                  onChange={(e) => setContractStartDate(e.target.value)}\n                  data-testid=\"contract-start-date-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"contract-days\">Number of Contract Days</Label>\n                <Input \n                  id=\"contract-days\"\n                  type=\"number\"\n                  min=\"1\"\n                  placeholder=\"e.g., 180\"\n                  value={contractDays}\n                  onChange={(e) => setContractDays(e.target.value ? parseInt(e.target.value) : '')}\n                  data-testid=\"contract-days-input\"\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"contract-end-date\">Contract End Date</Label>\n                <Input \n                  id=\"contract-end-date\"\n                  type=\"date\"\n                  value={contractEndDate}\n                  readOnly\n                  className=\"bg-gray-100 dark:bg-gray-800\"\n                  data-testid=\"contract-end-date-input\"\n                />\n                <p className=\"text-xs text-teal-600 dark:text-teal-400\">\n                  Auto-calculated based on start date and number of days\n                </p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"flex justify-end space-x-2 pt-4 border-t\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => {\n                resetForm();\n                onOpenChange(false);\n              }}\n              data-testid=\"cancel-contract-btn\"\n            >\n              Cancel\n            </Button>\n            <Button\n              type=\"button\"\n              onClick={handleSave}\n              disabled={isSaving}\n              data-testid=\"save-contract-btn\"\n            >\n              {isSaving ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Saving...\n                </>\n              ) : (\n                'Save'\n              )}\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":36554,"size_tokens":null},"server/groqOcrService.ts":{"content":"import Groq from 'groq-sdk';\n\nexport interface ExtractedCrewData {\n  name?: string;\n  position?: string;\n  nationality?: string;\n  dateOfBirth?: string;\n  passportNumber?: string;\n  seamansBookNumber?: string;\n  cdcNumber?: string;\n  phoneNumber?: string;\n  email?: string;\n  emergencyContact?: string;\n  emergencyPhone?: string;\n  contractStartDate?: string;\n  contractEndDate?: string;\n  joinDate?: string;\n  leaveDate?: string;\n  vessel?: string;\n  salary?: string;\n  shipOwnerName?: string;\n  shipOwnerContactPerson?: string;\n  shipOwnerPostalAddress?: string;\n  seafarerName?: string;\n  capacityRankEmployed?: string;\n  seafarerNationality?: string;\n  seafarerDatePlaceOfBirth?: string;\n  seafarerIndosNumber?: string;\n  seafarerPostalAddress?: string;\n  seafarerEmail?: string;\n  seafarerMobile?: string;\n  cdcPlaceOfIssue?: string;\n  cdcIssueDate?: string;\n  cdcExpiryDate?: string;\n  passportPlaceOfIssue?: string;\n  passportIssueDate?: string;\n  passportExpiryDate?: string;\n  nokName?: string;\n  nokRelationship?: string;\n  nokEmail?: string;\n  nokTelephone?: string;\n  nokPostalAddress?: string;\n  cocGradeNo?: string;\n  cocPlaceOfIssue?: string;\n  cocIssueDate?: string;\n  cocExpiryDate?: string;\n  medicalIssuingAuthority?: string;\n  medicalApprovalNo?: string;\n  medicalIssueDate?: string;\n  medicalExpiryDate?: string;\n  shipName?: string;\n  engagementPeriodMonths?: number;\n}\n\nexport interface ExtractedCrewRecord extends ExtractedCrewData {\n  recordId: string;\n  displayName: string;\n}\n\nexport class GroqOCRService {\n  private client: Groq | null = null;\n\n  private getClient(): Groq {\n    if (!this.client) {\n      const apiKey = process.env.GROQ_API_KEY;\n      if (!apiKey) {\n        throw new Error('GROQ_API_KEY is not set');\n      }\n      this.client = new Groq({ apiKey });\n    }\n    return this.client;\n  }\n\n  isAvailable(): boolean {\n    return !!process.env.GROQ_API_KEY;\n  }\n\n  async extractCrewDataFromDocument(base64Data: string, filename?: string): Promise<ExtractedCrewData> {\n    try {\n      console.log('Starting Groq Vision OCR extraction for file:', filename);\n      \n      const client = this.getClient();\n      \n      const prompt = `You are an expert at extracting structured data from maritime contract documents.\n\nAnalyze this document image and extract the following seafarer details. Look specifically for \"V. Details of Seafarers\" or similar section:\n\n1. Seafarer Name (field labeled \"1. Name:\")\n2. Capacity / Rank Employed (field labeled \"1. Capacity / Rank Employed:\" - this is the seafarer's rank like \"Master (NCV)\", \"Chief Officer\", \"2nd Engineer\", etc.)\n3. Seafarer Nationality (field labeled \"2. Nationality:\")\n3. Date and Place of Birth (field labeled \"3. Date and Place of Birth:\" or \"3. Date & Place of Birth:\")\n4. INDOS Number (field labeled \"4. INDoS No.:\" or \"4. INDOS No.:\")\n5. Postal Address (from \"5. Communication Details:\" section)\n6. Email address\n7. Mobile number\n\nAlso extract CDC (Continuous Discharge Certificate) details from the \"6. CDC No.\" section:\n- CDC No. (e.g., \"MUM 132798\")\n- CDC Place of Issue (e.g., \"MUMBAI\") - from CDC section only\n- CDC Issue Date - from CDC section only\n- CDC Expiry Date - from CDC section only\n\nCRITICAL: Extract Passport details from \"7. Passport No.\" section - look for FOUR separate sub-fields:\n- Passport No. (alphanumeric like \"R2826385\" or \"Z1234567\")\n- Place of Issue (city name like \"PATNA\", \"MUMBAI\", \"VISAKHAPATNAM\")\n- Date of Issue (a DATE IN THE PAST, e.g., \"04-JUL-2017\" or \"03-DEC-2020\")\n- Date of Expiry (a DATE IN THE FUTURE, typically 10 years after issue, e.g., \"03-JUL-2027\" or \"02-DEC-2030\")\nVALIDATION: Passport Expiry Date MUST be AFTER Issue Date (usually 10 years later). If both dates appear the same, you have made an error - look again carefully.\n\nCRITICAL: Extract Next of Kin (NOK) details - these are SEPARATE fields:\n- NOK Name: ONLY the person's name (e.g., \"MRS. ALKA BHARTI\" or \"MRS. BINITA KUMARI\") - do NOT include relationship or address\n- Relationship: ONLY the relationship word (e.g., \"WIFE\", \"HUSBAND\", \"PARENT\", \"SON\", \"DAUGHTER\")\n- Email: email address if available\n- Telephone No.: phone number only (e.g., \"8538955893\")\n- NOK's Postal Address from \"8a. NOK's Postal Address:\" - ONLY the street address, city, PIN code - do NOT include name or relationship\n\nAlso extract Competency Certificate (COC) details from the \"9. Details of Competency Certificates\" section:\n- COC Grade / No (e.g., \"MASTER (F.G.) / 23-MUM-2024\")\n- Place of Issue (e.g., \"MUMBAI\")\n- Date of Issue (e.g., \"15-JAN-2024\")\n- Date of Expiry (e.g., \"14-JAN-2029\")\n\nAlso extract Medical Certificate details from the \"11. Details of Medical Certificate\" section:\n- Issuing Authority (e.g., \"DR. DIWAKAR TIWARI (GLOBUS MEDICARE)\")\n- Approval No (e.g., \"MAH/NM/22/2015\")\n- Issue Date (e.g., \"15-JAN-2025\")\n- Expiry Date (e.g., \"14-JAN-2027\")\n\nAlso extract Ship Details from the \"IV. Details of Ship\" section:\n- Ship Name (e.g., \"AQUA TOW\")\n\nAlso extract any Ship Owner details if visible:\n- Ship Owner Name\n- Contact Person\n- Postal Address\n\nReturn ONLY a valid JSON object with these exact keys (use null for any field not found):\n{\n  \"seafarerName\": \"extracted name or null\",\n  \"capacityRankEmployed\": \"extracted capacity/rank employed (e.g., Master (NCV), Chief Officer) or null\",\n  \"seafarerNationality\": \"extracted nationality or null\",\n  \"seafarerDatePlaceOfBirth\": \"extracted date and place or null\",\n  \"seafarerIndosNumber\": \"extracted INDOS number or null\",\n  \"seafarerPostalAddress\": \"extracted address or null\",\n  \"seafarerEmail\": \"extracted email or null\",\n  \"seafarerMobile\": \"extracted mobile or null\",\n  \"cdcNumber\": \"extracted CDC number or null\",\n  \"cdcPlaceOfIssue\": \"extracted place of issue or null\",\n  \"cdcIssueDate\": \"extracted issue date or null\",\n  \"cdcExpiryDate\": \"extracted expiry date or null\",\n  \"passportNumber\": \"extracted passport number or null\",\n  \"passportPlaceOfIssue\": \"extracted passport place of issue or null\",\n  \"passportIssueDate\": \"extracted passport issue date or null\",\n  \"passportExpiryDate\": \"extracted passport expiry date or null\",\n  \"nokName\": \"extracted NOK name or null\",\n  \"nokRelationship\": \"extracted relationship or null\",\n  \"nokEmail\": \"extracted NOK email or null\",\n  \"nokTelephone\": \"extracted NOK telephone or null\",\n  \"nokPostalAddress\": \"extracted NOK address or null\",\n  \"cocGradeNo\": \"extracted COC grade and number or null\",\n  \"cocPlaceOfIssue\": \"extracted COC place of issue or null\",\n  \"cocIssueDate\": \"extracted COC issue date or null\",\n  \"cocExpiryDate\": \"extracted COC expiry date or null\",\n  \"medicalIssuingAuthority\": \"extracted medical issuing authority or null\",\n  \"medicalApprovalNo\": \"extracted medical approval number or null\",\n  \"medicalIssueDate\": \"extracted medical issue date or null\",\n  \"medicalExpiryDate\": \"extracted medical expiry date or null\",\n  \"shipName\": \"extracted ship name or null\",\n  \"shipOwnerName\": \"extracted company name or null\",\n  \"shipOwnerContactPerson\": \"extracted contact person or null\",\n  \"shipOwnerPostalAddress\": \"extracted address or null\"\n}\n\nImportant: Return ONLY the JSON object, no additional text or explanation.`;\n\n      const response = await client.chat.completions.create({\n        model: 'meta-llama/llama-4-scout-17b-16e-instruct',\n        messages: [\n          {\n            role: 'user',\n            content: [\n              {\n                type: 'text',\n                text: prompt\n              },\n              {\n                type: 'image_url',\n                image_url: {\n                  url: `data:image/jpeg;base64,${base64Data}`\n                }\n              }\n            ]\n          }\n        ],\n        max_tokens: 1024,\n        temperature: 0.1\n      });\n\n      const content = response.choices[0]?.message?.content || '{}';\n      console.log('Groq Vision response:', content);\n\n      // Parse the JSON response\n      let extractedData: ExtractedCrewData = {};\n      \n      // Try to extract JSON from the response (handle potential markdown code blocks)\n      let jsonStr = content;\n      const jsonMatch = content.match(/```(?:json)?\\s*([\\s\\S]*?)```/);\n      if (jsonMatch) {\n        jsonStr = jsonMatch[1].trim();\n      }\n      \n      try {\n        const parsed = JSON.parse(jsonStr);\n        \n        // Map the parsed data, converting null to undefined\n        extractedData = {\n          seafarerName: parsed.seafarerName || undefined,\n          capacityRankEmployed: parsed.capacityRankEmployed || undefined,\n          seafarerNationality: parsed.seafarerNationality || undefined,\n          seafarerDatePlaceOfBirth: parsed.seafarerDatePlaceOfBirth || undefined,\n          seafarerIndosNumber: parsed.seafarerIndosNumber || undefined,\n          seafarerPostalAddress: parsed.seafarerPostalAddress || undefined,\n          seafarerEmail: parsed.seafarerEmail || undefined,\n          seafarerMobile: parsed.seafarerMobile || undefined,\n          cdcNumber: parsed.cdcNumber || undefined,\n          cdcPlaceOfIssue: parsed.cdcPlaceOfIssue || undefined,\n          cdcIssueDate: parsed.cdcIssueDate || undefined,\n          cdcExpiryDate: parsed.cdcExpiryDate || undefined,\n          passportNumber: parsed.passportNumber || undefined,\n          passportPlaceOfIssue: parsed.passportPlaceOfIssue || undefined,\n          passportIssueDate: parsed.passportIssueDate || undefined,\n          passportExpiryDate: parsed.passportExpiryDate || undefined,\n          nokName: parsed.nokName || undefined,\n          nokRelationship: parsed.nokRelationship || undefined,\n          nokEmail: parsed.nokEmail || undefined,\n          nokTelephone: parsed.nokTelephone || undefined,\n          nokPostalAddress: parsed.nokPostalAddress || undefined,\n          cocGradeNo: parsed.cocGradeNo || undefined,\n          cocPlaceOfIssue: parsed.cocPlaceOfIssue || undefined,\n          cocIssueDate: parsed.cocIssueDate || undefined,\n          cocExpiryDate: parsed.cocExpiryDate || undefined,\n          medicalIssuingAuthority: parsed.medicalIssuingAuthority || undefined,\n          medicalApprovalNo: parsed.medicalApprovalNo || undefined,\n          medicalIssueDate: parsed.medicalIssueDate || undefined,\n          medicalExpiryDate: parsed.medicalExpiryDate || undefined,\n          shipName: parsed.shipName || undefined,\n          shipOwnerName: parsed.shipOwnerName || undefined,\n          shipOwnerContactPerson: parsed.shipOwnerContactPerson || undefined,\n          shipOwnerPostalAddress: parsed.shipOwnerPostalAddress || undefined\n        };\n        \n        // Validate that at least one field was extracted\n        const hasData = Object.values(extractedData).some(v => v !== undefined);\n        if (!hasData) {\n          throw new Error('No data extracted from document');\n        }\n      } catch (parseError) {\n        console.error('Failed to parse Groq response as JSON:', parseError);\n        console.log('Raw content:', content);\n        throw new Error('Failed to parse AI response - falling back to local OCR');\n      }\n\n      console.log('Extracted data from Groq Vision:', extractedData);\n      return extractedData;\n\n    } catch (error) {\n      console.error('Groq Vision OCR error:', error);\n      throw new Error(`Groq Vision processing failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  async extractCrewDataWithRecord(base64Data: string, filename?: string): Promise<ExtractedCrewRecord> {\n    const data = await this.extractCrewDataFromDocument(base64Data, filename);\n    \n    // Generate a unique record ID\n    const recordId = `crew-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    \n    // Create a display name from the extracted data\n    const displayName = data.seafarerName || data.name || 'Unknown Crew Member';\n    \n    return {\n      ...data,\n      recordId,\n      displayName,\n    };\n  }\n}\n\nexport const groqOcrService = new GroqOCRService();\n","path":null,"size_bytes":11856,"size_tokens":null},"client/src/contexts/extracted-records-context.tsx":{"content":"import { createContext, useContext, useState, useCallback } from 'react';\n\nexport interface ExtractedCrewRecord {\n  recordId: string;\n  displayName: string;\n  extractedAt: Date;\n  data: {\n    name?: string;\n    position?: string;\n    nationality?: string;\n    dateOfBirth?: string;\n    passportNumber?: string;\n    seamansBookNumber?: string;\n    cdcNumber?: string;\n    phoneNumber?: string;\n    email?: string;\n    emergencyContact?: string;\n    emergencyPhone?: string;\n    contractStartDate?: string;\n    contractEndDate?: string;\n    joinDate?: string;\n    leaveDate?: string;\n    vessel?: string;\n    salary?: string;\n    shipOwnerName?: string;\n    shipOwnerContactPerson?: string;\n    shipOwnerPostalAddress?: string;\n    seafarerName?: string;\n    seafarerNationality?: string;\n    seafarerDatePlaceOfBirth?: string;\n    seafarerIndosNumber?: string;\n    seafarerPostalAddress?: string;\n    seafarerEmail?: string;\n    seafarerMobile?: string;\n    cdcPlaceOfIssue?: string;\n    cdcIssueDate?: string;\n    cdcExpiryDate?: string;\n    passportPlaceOfIssue?: string;\n    passportIssueDate?: string;\n    passportExpiryDate?: string;\n    nokName?: string;\n    nokRelationship?: string;\n    nokEmail?: string;\n    nokTelephone?: string;\n    nokPostalAddress?: string;\n    cocGradeNo?: string;\n    cocPlaceOfIssue?: string;\n    cocIssueDate?: string;\n    cocExpiryDate?: string;\n    medicalIssuingAuthority?: string;\n    medicalApprovalNo?: string;\n    medicalIssueDate?: string;\n    medicalExpiryDate?: string;\n    shipName?: string;\n    engagementPeriodMonths?: number;\n  };\n}\n\ninterface ExtractedRecordsContextType {\n  records: ExtractedCrewRecord[];\n  addRecord: (data: any) => ExtractedCrewRecord;\n  getRecord: (recordId: string) => ExtractedCrewRecord | undefined;\n  removeRecord: (recordId: string) => void;\n  clearRecords: () => void;\n  usedRecordIds: Set<string>;\n  markRecordAsUsed: (recordId: string) => void;\n  isRecordUsed: (recordId: string) => boolean;\n}\n\nconst ExtractedRecordsContext = createContext<ExtractedRecordsContextType | null>(null);\n\nexport function ExtractedRecordsProvider({ children }: { children: React.ReactNode }) {\n  const [records, setRecords] = useState<ExtractedCrewRecord[]>([]);\n  const [usedRecordIds, setUsedRecordIds] = useState<Set<string>>(new Set());\n\n  const addRecord = useCallback((data: any): ExtractedCrewRecord => {\n    const recordId = data.recordId || `crew-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const displayName = data.displayName || data.seafarerName || data.name || 'Unknown Crew Member';\n    \n    const newRecord: ExtractedCrewRecord = {\n      recordId,\n      displayName,\n      extractedAt: new Date(),\n      data: { ...data }\n    };\n\n    setRecords(prev => {\n      const existing = prev.find(r => r.recordId === recordId);\n      if (existing) {\n        return prev.map(r => r.recordId === recordId ? newRecord : r);\n      }\n      return [...prev, newRecord];\n    });\n\n    return newRecord;\n  }, []);\n\n  const getRecord = useCallback((recordId: string): ExtractedCrewRecord | undefined => {\n    return records.find(r => r.recordId === recordId);\n  }, [records]);\n\n  const removeRecord = useCallback((recordId: string) => {\n    setRecords(prev => prev.filter(r => r.recordId !== recordId));\n    setUsedRecordIds(prev => {\n      const next = new Set(prev);\n      next.delete(recordId);\n      return next;\n    });\n  }, []);\n\n  const clearRecords = useCallback(() => {\n    setRecords([]);\n    setUsedRecordIds(new Set());\n  }, []);\n\n  const markRecordAsUsed = useCallback((recordId: string) => {\n    setUsedRecordIds(prev => new Set(prev).add(recordId));\n  }, []);\n\n  const isRecordUsed = useCallback((recordId: string): boolean => {\n    return usedRecordIds.has(recordId);\n  }, [usedRecordIds]);\n\n  return (\n    <ExtractedRecordsContext.Provider value={{\n      records,\n      addRecord,\n      getRecord,\n      removeRecord,\n      clearRecords,\n      usedRecordIds,\n      markRecordAsUsed,\n      isRecordUsed\n    }}>\n      {children}\n    </ExtractedRecordsContext.Provider>\n  );\n}\n\nexport function useExtractedRecords() {\n  const context = useContext(ExtractedRecordsContext);\n  if (!context) {\n    throw new Error('useExtractedRecords must be used within an ExtractedRecordsProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":4293,"size_tokens":null},"test_gmail_email.ts":{"content":"import nodemailer from 'nodemailer';\n\nasync function main() {\n  const gmailUser = process.env.GMAIL_USER;\n  const gmailAppPassword = process.env.GMAIL_APP_PASSWORD;\n  \n  if (!gmailUser || !gmailAppPassword) {\n    console.log('‚ùå Gmail credentials not found');\n    console.log('GMAIL_USER:', gmailUser ? 'Set' : 'Missing');\n    console.log('GMAIL_APP_PASSWORD:', gmailAppPassword ? 'Set' : 'Missing');\n    process.exit(1);\n  }\n  \n  console.log('üìß Configuring Gmail SMTP with:', gmailUser);\n  \n  const transporter = nodemailer.createTransport({\n    service: 'gmail',\n    auth: {\n      user: gmailUser,\n      pass: gmailAppPassword,\n    },\n  });\n  \n  const html = `\n    <div style=\"font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; background: #f8f9fa; padding: 20px;\">\n      <div style=\"background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n        <div style=\"text-align: center; margin-bottom: 30px; border-bottom: 2px solid #0066cc; padding-bottom: 20px;\">\n          <h1 style=\"color: #0066cc; margin: 0; font-size: 24px;\">üë§ Crew Member Details</h1>\n          <p style=\"color: #6c757d; margin: 10px 0 0 0;\">Crew Management System</p>\n        </div>\n        \n        <div style=\"background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n          <h2 style=\"color: #0d47a1; margin: 0 0 15px 0; font-size: 18px;\">üìã Personal Information</h2>\n          <table style=\"width: 100%; border-collapse: collapse;\">\n            <tr><td style=\"padding: 8px 0; color: #666; width: 40%;\">Name:</td><td style=\"padding: 8px 0; font-weight: bold;\">Sagar Rana</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Rank:</td><td style=\"padding: 8px 0; font-weight: bold;\">Captain</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Nationality:</td><td style=\"padding: 8px 0;\">INDIAN</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Date of Birth:</td><td style=\"padding: 8px 0;\">May 11, 1996</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Phone:</td><td style=\"padding: 8px 0;\">7738956467</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Email:</td><td style=\"padding: 8px 0;\">sagar11596@gmail.com</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Status:</td><td style=\"padding: 8px 0;\"><span style=\"background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;\">On Board</span></td></tr>\n          </table>\n        </div>\n\n        <div style=\"background: #fff3e0; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n          <h2 style=\"color: #e65100; margin: 0 0 15px 0; font-size: 18px;\">üö¢ Current Vessel</h2>\n          <table style=\"width: 100%; border-collapse: collapse;\">\n            <tr><td style=\"padding: 8px 0; color: #666; width: 40%;\">Vessel Name:</td><td style=\"padding: 8px 0; font-weight: bold;\">AMNS HERCULES</td></tr>\n          </table>\n        </div>\n\n        <div style=\"background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n          <h2 style=\"color: #2e7d32; margin: 0 0 15px 0; font-size: 18px;\">üìù Active Contract</h2>\n          <table style=\"width: 100%; border-collapse: collapse;\">\n            <tr><td style=\"padding: 8px 0; color: #666; width: 40%;\">Start Date:</td><td style=\"padding: 8px 0;\">December 20, 2025</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">End Date:</td><td style=\"padding: 8px 0;\">March 20, 2026</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Duration:</td><td style=\"padding: 8px 0;\">90 days</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Status:</td><td style=\"padding: 8px 0;\"><span style=\"background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;\">Active</span></td></tr>\n          </table>\n        </div>\n\n        <div style=\"background: #fce4ec; padding: 20px; border-radius: 8px; margin-bottom: 20px;\">\n          <h2 style=\"color: #c2185b; margin: 0 0 15px 0; font-size: 18px;\">üÜò Emergency Contact</h2>\n          <table style=\"width: 100%; border-collapse: collapse;\">\n            <tr><td style=\"padding: 8px 0; color: #666; width: 40%;\">Name:</td><td style=\"padding: 8px 0; font-weight: bold;\">Chetan Rana</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Relationship:</td><td style=\"padding: 8px 0;\">Parent</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Phone:</td><td style=\"padding: 8px 0;\">9867065694</td></tr>\n            <tr><td style=\"padding: 8px 0; color: #666;\">Email:</td><td style=\"padding: 8px 0;\">admin@offing.biz</td></tr>\n          </table>\n        </div>\n\n        <div style=\"text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;\">\n          <p style=\"color: #6c757d; font-size: 14px; margin: 0;\">This is a test email from your Crew Management System</p>\n          <p style=\"color: #6c757d; font-size: 12px; margin: 5px 0 0 0;\">Sent: ${new Date().toLocaleString()}</p>\n        </div>\n      </div>\n    </div>\n  `;\n\n  try {\n    console.log('üìß Sending test email to admin@offing.biz...');\n    const info = await transporter.sendMail({\n      from: \\`\"Crew Management System\" <\\${gmailUser}>\\`,\n      to: 'admin@offing.biz',\n      subject: 'üë§ Crew Details: Sagar Rana - Captain (Test Email)',\n      html,\n      text: 'Crew Member Details - Sagar Rana, Captain, INDIAN, On Board AMNS HERCULES, Contract: Dec 20, 2025 - Mar 20, 2026'\n    });\n    console.log('‚úÖ Email sent successfully!');\n    console.log('üìß Message ID:', info.messageId);\n  } catch (error: any) {\n    console.log('‚ùå Failed to send email:', error.message);\n    if (error.code) console.log('Error code:', error.code);\n  }\n}\n\nmain();\n","path":null,"size_bytes":5783,"size_tokens":null},"client/src/pages/status-history.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { getAuthHeaders } from '@/lib/auth';\nimport { useAuth } from '@/contexts/auth-context';\nimport { useToast } from '@/hooks/use-toast';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Label } from '@/components/ui/label';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { History, Search, Ship, Anchor, ArrowRightLeft, Users, Mail, Loader2 } from 'lucide-react';\nimport { StatusChangeHistoryWithDetails, Vessel } from '@shared/schema';\nimport { format } from 'date-fns';\nimport { apiRequest } from '@/lib/queryClient';\n\nexport default function StatusHistory() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const [searchTerm, setSearchTerm] = useState('');\n  const [vesselFilter, setVesselFilter] = useState('all');\n  const [activeTab, setActiveTab] = useState('all');\n  const [emailDialogOpen, setEmailDialogOpen] = useState(false);\n  const [sendToAdditional, setSendToAdditional] = useState(false);\n  const [additionalEmail, setAdditionalEmail] = useState('');\n\n  const sendStatusHistoryEmailMutation = useMutation({\n    mutationFn: async (data: { statusHistory: StatusChangeHistoryWithDetails[]; additionalEmail?: string }) => {\n      const response = await apiRequest('POST', '/api/email/send-status-history', data);\n      return response.json();\n    },\n    onSuccess: (data) => {\n      setEmailDialogOpen(false);\n      setAdditionalEmail('');\n      setSendToAdditional(false);\n      toast({\n        title: \"Email Sent\",\n        description: data.message || \"Status history summary sent successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Email Failed\",\n        description: error.message || \"Failed to send status history email.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSendEmail = () => {\n    sendStatusHistoryEmailMutation.mutate({\n      statusHistory: filteredHistory,\n      additionalEmail: sendToAdditional ? additionalEmail : undefined,\n    });\n  };\n\n  const { data: statusHistory, isLoading } = useQuery<StatusChangeHistoryWithDetails[]>({\n    queryKey: ['/api/status-change-history'],\n    queryFn: async () => {\n      const response = await fetch('/api/status-change-history', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch status history');\n      return response.json();\n    },\n  });\n\n  const { data: vessels } = useQuery<Vessel[]>({\n    queryKey: ['/api/vessels'],\n    queryFn: async () => {\n      const response = await fetch('/api/vessels', {\n        headers: getAuthHeaders(),\n      });\n      if (!response.ok) throw new Error('Failed to fetch vessels');\n      return response.json();\n    },\n  });\n\n  const getCrewMemberName = (history: StatusChangeHistoryWithDetails) => {\n    if (!history.crewMember) return 'Unknown';\n    const firstName = history.crewMember.firstName || '';\n    const lastName = history.crewMember.lastName || '';\n    return firstName || lastName ? `${firstName} ${lastName}`.trim() : 'Unknown';\n  };\n\n  const getCrewMemberInitials = (history: StatusChangeHistoryWithDetails) => {\n    if (!history.crewMember) return 'UK';\n    const firstName = history.crewMember.firstName || '';\n    const lastName = history.crewMember.lastName || '';\n    const firstInitial = firstName.charAt(0) || '';\n    const lastInitial = lastName.charAt(0) || '';\n    return (firstInitial + lastInitial).toUpperCase() || 'UK';\n  };\n\n  const getVesselName = (history: StatusChangeHistoryWithDetails) => {\n    return history.vessel?.name || 'N/A';\n  };\n\n  const getCrewRank = (history: StatusChangeHistoryWithDetails) => {\n    return history.crewMember?.rank || 'N/A';\n  };\n\n  const getStatusBadge = (status: string) => {\n    if (status === 'onBoard') {\n      return (\n        <Badge className=\"bg-compliance-green text-white\">\n          <Ship className=\"h-3 w-3 mr-1\" />\n          On Board\n        </Badge>\n      );\n    }\n    return (\n      <Badge className=\"bg-maritime-navy text-white\">\n        <Anchor className=\"h-3 w-3 mr-1\" />\n        On Shore\n      </Badge>\n    );\n  };\n\n  const getReason = (history: StatusChangeHistoryWithDetails) => {\n    return history.reason || 'No reason provided';\n  };\n\n  const getChangedBy = (history: StatusChangeHistoryWithDetails) => {\n    return history.changedByUsername || 'System';\n  };\n\n  const filteredHistory = statusHistory?.filter(history => {\n    const crewName = getCrewMemberName(history).toLowerCase();\n    const vesselName = getVesselName(history).toLowerCase();\n    const reason = getReason(history).toLowerCase();\n    const changedBy = getChangedBy(history).toLowerCase();\n\n    const matchesSearch = crewName.includes(searchTerm.toLowerCase()) ||\n                         vesselName.includes(searchTerm.toLowerCase()) ||\n                         reason.includes(searchTerm.toLowerCase()) ||\n                         changedBy.includes(searchTerm.toLowerCase());\n\n    const matchesVessel = vesselFilter === 'all' || history.vesselId === vesselFilter;\n\n    const matchesTab = activeTab === 'all' ||\n                      (activeTab === 'signed-off' && history.newStatus === 'onShore') ||\n                      (activeTab === 'on-shore' && history.newStatus === 'onShore') ||\n                      (activeTab === 'signed-on' && history.newStatus === 'onBoard');\n\n    return matchesSearch && matchesVessel && matchesTab;\n  }) || [];\n\n  const signedOffCount = statusHistory?.filter(h => h.newStatus === 'onShore').length || 0;\n  const signedOnCount = statusHistory?.filter(h => h.newStatus === 'onBoard').length || 0;\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/3 mb-2\"></div>\n          <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n        </div>\n        <div className=\"h-64 bg-gray-200 rounded animate-pulse\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold maritime-navy mb-2\" data-testid=\"status-history-title\">\n            Status History\n          </h2>\n          <p className=\"text-gray-600\">\n            Track all crew status changes including sign-on and sign-off records with reasons\n          </p>\n        </div>\n        <Button\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => setEmailDialogOpen(true)}\n          className=\"h-8\"\n          data-testid=\"mail-status-history-button\"\n        >\n          <Mail className=\"h-4 w-4 mr-2\" />\n          Send Mail\n        </Button>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-gray-500\">Total Records</p>\n                <p className=\"text-2xl font-bold\" data-testid=\"total-records-count\">\n                  {statusHistory?.length || 0}\n                </p>\n              </div>\n              <div className=\"p-3 bg-gray-100 rounded-full\">\n                <History className=\"h-6 w-6 text-gray-600\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-gray-500\">Signed Off (On Shore)</p>\n                <p className=\"text-2xl font-bold text-maritime-navy\" data-testid=\"signed-off-count\">\n                  {signedOffCount}\n                </p>\n              </div>\n              <div className=\"p-3 bg-blue-100 rounded-full\">\n                <Anchor className=\"h-6 w-6 text-maritime-navy\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm text-gray-500\">Signed On (On Board)</p>\n                <p className=\"text-2xl font-bold text-compliance-green\" data-testid=\"signed-on-count\">\n                  {signedOnCount}\n                </p>\n              </div>\n              <div className=\"p-3 bg-green-100 rounded-full\">\n                <Ship className=\"h-6 w-6 text-compliance-green\" />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full grid-cols-3 lg:w-auto lg:inline-flex\">\n          <TabsTrigger value=\"all\" data-testid=\"tab-all\">\n            <ArrowRightLeft className=\"h-4 w-4 mr-2\" />\n            All Changes\n          </TabsTrigger>\n          <TabsTrigger value=\"signed-off\" data-testid=\"tab-signed-off\">\n            <Anchor className=\"h-4 w-4 mr-2\" />\n            Signed Off\n          </TabsTrigger>\n          <TabsTrigger value=\"signed-on\" data-testid=\"tab-signed-on\">\n            <Ship className=\"h-4 w-4 mr-2\" />\n            Signed On\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value={activeTab} className=\"mt-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Users className=\"h-5 w-5\" />\n                {activeTab === 'all' && 'All Status Changes'}\n                {activeTab === 'signed-off' && 'Signed-Off Crew (On Shore)'}\n                {activeTab === 'signed-on' && 'Signed-On Crew (On Board)'}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-col md:flex-row gap-4 mb-6\">\n                <div className=\"relative flex-1\">\n                  <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n                  <Input\n                    placeholder=\"Search by crew name, vessel, reason, or changed by...\"\n                    value={searchTerm}\n                    onChange={(e) => setSearchTerm(e.target.value)}\n                    className=\"pl-9\"\n                    data-testid=\"search-input\"\n                  />\n                </div>\n                <Select value={vesselFilter} onValueChange={setVesselFilter}>\n                  <SelectTrigger className=\"w-full md:w-[200px]\" data-testid=\"vessel-filter\">\n                    <SelectValue placeholder=\"Filter by vessel\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">All Vessels</SelectItem>\n                    {vessels?.map((vessel) => (\n                      <SelectItem key={vessel.id} value={vessel.id}>\n                        {vessel.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"hidden md:block\">\n                <Table>\n                  <TableHeader>\n                    <TableRow className=\"bg-gray-50\">\n                      <TableHead>Crew Member</TableHead>\n                      <TableHead>Status Change</TableHead>\n                      <TableHead>Reason</TableHead>\n                      <TableHead>Vessel</TableHead>\n                      <TableHead>Changed By</TableHead>\n                      <TableHead>Date</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {filteredHistory.length === 0 ? (\n                      <TableRow>\n                        <TableCell colSpan={6} className=\"text-center py-8 text-gray-500\">\n                          No status change records found\n                        </TableCell>\n                      </TableRow>\n                    ) : (\n                      filteredHistory.map((history) => (\n                        <TableRow key={history.id} className=\"hover:bg-gray-50\" data-testid={`status-row-${history.id}`}>\n                          <TableCell>\n                            <div className=\"flex items-center space-x-3\">\n                              <Avatar className=\"bg-maritime-navy\">\n                                <AvatarFallback className=\"text-white font-medium\">\n                                  {getCrewMemberInitials(history)}\n                                </AvatarFallback>\n                              </Avatar>\n                              <div>\n                                <p className=\"font-medium\" data-testid=\"crew-name\">\n                                  {getCrewMemberName(history)}\n                                </p>\n                                <p className=\"text-sm text-gray-500\">\n                                  {getCrewRank(history)}\n                                </p>\n                              </div>\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              {getStatusBadge(history.previousStatus)}\n                              <ArrowRightLeft className=\"h-4 w-4 text-gray-400\" />\n                              {getStatusBadge(history.newStatus)}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <p className=\"max-w-[200px] truncate\" title={getReason(history)} data-testid=\"status-reason\">\n                              {getReason(history)}\n                            </p>\n                          </TableCell>\n                          <TableCell data-testid=\"vessel-name\">\n                            {getVesselName(history)}\n                          </TableCell>\n                          <TableCell data-testid=\"changed-by\">\n                            {getChangedBy(history)}\n                          </TableCell>\n                          <TableCell data-testid=\"change-date\">\n                            {history.createdAt ? format(new Date(history.createdAt), 'MMM dd, yyyy HH:mm') : 'N/A'}\n                          </TableCell>\n                        </TableRow>\n                      ))\n                    )}\n                  </TableBody>\n                </Table>\n              </div>\n\n              <div className=\"md:hidden space-y-4\">\n                {filteredHistory.length === 0 ? (\n                  <div className=\"text-center py-8 text-gray-500\">\n                    No status change records found\n                  </div>\n                ) : (\n                  filteredHistory.map((history) => (\n                    <Card key={history.id} className=\"border\" data-testid={`status-card-${history.id}`}>\n                      <CardContent className=\"pt-4\">\n                        <div className=\"flex items-start justify-between mb-3\">\n                          <div className=\"flex items-center space-x-3\">\n                            <Avatar className=\"bg-maritime-navy\">\n                              <AvatarFallback className=\"text-white font-medium text-sm\">\n                                {getCrewMemberInitials(history)}\n                              </AvatarFallback>\n                            </Avatar>\n                            <div>\n                              <p className=\"font-medium\">{getCrewMemberName(history)}</p>\n                              <p className=\"text-sm text-gray-500\">{getCrewRank(history)}</p>\n                            </div>\n                          </div>\n                        </div>\n\n                        <div className=\"space-y-2 text-sm\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"text-gray-500\">Status:</span>\n                            {getStatusBadge(history.previousStatus)}\n                            <ArrowRightLeft className=\"h-3 w-3 text-gray-400\" />\n                            {getStatusBadge(history.newStatus)}\n                          </div>\n                          <div>\n                            <span className=\"text-gray-500\">Reason:</span>\n                            <p className=\"mt-1 text-gray-700\">{getReason(history)}</p>\n                          </div>\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-gray-500\">Vessel:</span>\n                            <span>{getVesselName(history)}</span>\n                          </div>\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-gray-500\">Changed By:</span>\n                            <span>{getChangedBy(history)}</span>\n                          </div>\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-gray-500\">Date:</span>\n                            <span>{history.createdAt ? format(new Date(history.createdAt), 'MMM dd, yyyy HH:mm') : 'N/A'}</span>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n\n      {/* Email Send Dialog */}\n      <Dialog open={emailDialogOpen} onOpenChange={setEmailDialogOpen}>\n        <DialogContent className=\"sm:max-w-md\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Mail className=\"h-5 w-5\" />\n              Send Status History Summary\n            </DialogTitle>\n            <DialogDescription>\n              Send the status change history summary via email. {filteredHistory.length} record(s) will be included.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"flex items-center space-x-2\">\n              <Checkbox \n                id=\"send-additional\"\n                checked={sendToAdditional}\n                onCheckedChange={(checked) => setSendToAdditional(checked === true)}\n                data-testid=\"checkbox-additional-email\"\n              />\n              <Label htmlFor=\"send-additional\" className=\"text-sm font-medium cursor-pointer\">\n                Also send to an additional email address\n              </Label>\n            </div>\n            \n            {sendToAdditional && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"additional-email\">Additional Email Address</Label>\n                <Input\n                  id=\"additional-email\"\n                  type=\"email\"\n                  placeholder=\"Enter email address\"\n                  value={additionalEmail}\n                  onChange={(e) => setAdditionalEmail(e.target.value)}\n                  data-testid=\"input-additional-email\"\n                />\n              </div>\n            )}\n          </div>\n          \n          <DialogFooter className=\"gap-2\">\n            <Button \n              variant=\"outline\" \n              onClick={() => {\n                setEmailDialogOpen(false);\n                setAdditionalEmail('');\n                setSendToAdditional(false);\n              }}\n              data-testid=\"button-cancel-email\"\n            >\n              Cancel\n            </Button>\n            <Button \n              onClick={handleSendEmail}\n              disabled={sendStatusHistoryEmailMutation.isPending || (sendToAdditional && !additionalEmail)}\n              data-testid=\"button-send-email\"\n            >\n              {sendStatusHistoryEmailMutation.isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Sending...\n                </>\n              ) : (\n                <>\n                  <Mail className=\"h-4 w-4 mr-2\" />\n                  Send Email\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":20735,"size_tokens":null},"server/services/pdf-generator.ts":{"content":"import PDFDocument from 'pdfkit';\n\ninterface ContractEvent {\n  id: string;\n  type: 'contract_due' | 'contract_expired';\n  date: Date;\n  crewMemberId: string;\n  crewMemberName: string;\n  vesselId: string;\n  vesselName: string;\n  contractId: string;\n  contractEndDate: Date;\n  daysUntilExpiry: number;\n}\n\nexport class PDFGeneratorService {\n  async generateCalendarPDF(month: string, events: ContractEvent[]): Promise<Buffer> {\n    console.log(`üìÑ Generating PDF for ${month} with ${events.length} events...`);\n\n    const dueEvents = events.filter(e => e.type === 'contract_due');\n    const expiredEvents = events.filter(e => e.type === 'contract_expired');\n\n    return new Promise((resolve, reject) => {\n      try {\n        const doc = new PDFDocument({ margin: 50, size: 'A4' });\n        const chunks: Buffer[] = [];\n\n        doc.on('data', (chunk) => chunks.push(chunk));\n        doc.on('end', () => {\n          const pdfBuffer = Buffer.concat(chunks);\n          console.log(`‚úÖ PDF generated successfully (${pdfBuffer.length} bytes)`);\n          resolve(pdfBuffer);\n        });\n        doc.on('error', reject);\n\n        // Header\n        doc.fontSize(24).fillColor('#0066cc').text('Monthly Contract Calendar', { align: 'center' });\n        doc.moveDown(0.5);\n        doc.fontSize(14).fillColor('#6c757d').text(month, { align: 'center' });\n        doc.moveDown(0.3);\n        doc.fontSize(10).fillColor('#28a745').text(`Generated on ${new Date().toLocaleDateString('en-US', { \n          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' \n        })}`, { align: 'center' });\n        \n        doc.moveDown(1.5);\n\n        // Stats boxes\n        const statsY = doc.y;\n        const boxWidth = 150;\n        const boxHeight = 60;\n        const startX = (doc.page.width - (boxWidth * 3 + 40)) / 2;\n\n        // Contracts Due box\n        doc.rect(startX, statsY, boxWidth, boxHeight).fillAndStroke('#fef3c7', '#d97706');\n        doc.fillColor('#d97706').fontSize(28).text(String(dueEvents.length), startX, statsY + 10, { width: boxWidth, align: 'center' });\n        doc.fontSize(10).fillColor('#92400e').text('Contracts Due', startX, statsY + 40, { width: boxWidth, align: 'center' });\n\n        // Contracts Expiring box\n        doc.rect(startX + boxWidth + 20, statsY, boxWidth, boxHeight).fillAndStroke('#fee2e2', '#dc2626');\n        doc.fillColor('#dc2626').fontSize(28).text(String(expiredEvents.length), startX + boxWidth + 20, statsY + 10, { width: boxWidth, align: 'center' });\n        doc.fontSize(10).fillColor('#991b1b').text('Contracts Expiring', startX + boxWidth + 20, statsY + 40, { width: boxWidth, align: 'center' });\n\n        // Total Events box\n        doc.rect(startX + (boxWidth + 20) * 2, statsY, boxWidth, boxHeight).fillAndStroke('#dbeafe', '#2563eb');\n        doc.fillColor('#2563eb').fontSize(28).text(String(events.length), startX + (boxWidth + 20) * 2, statsY + 10, { width: boxWidth, align: 'center' });\n        doc.fontSize(10).fillColor('#1e40af').text('Total Events', startX + (boxWidth + 20) * 2, statsY + 40, { width: boxWidth, align: 'center' });\n\n        doc.y = statsY + boxHeight + 30;\n\n        // No events message\n        if (events.length === 0) {\n          doc.moveDown(2);\n          doc.fontSize(16).fillColor('#166534').text('No Contract Events This Month', { align: 'center' });\n          doc.moveDown(0.5);\n          doc.fontSize(12).fillColor('#15803d').text(`There are no contracts due or expiring during ${month}.`, { align: 'center' });\n          doc.text('The crew schedule is clear for this month.', { align: 'center' });\n        }\n\n        // Contracts Due Table\n        if (dueEvents.length > 0) {\n          doc.moveDown(1);\n          doc.fontSize(14).fillColor('#d97706').text(`Contracts Due Soon (${dueEvents.length})`, 50);\n          doc.moveDown(0.5);\n          \n          this.drawTable(doc, dueEvents, '#fef3c7');\n        }\n\n        // Contracts Expiring Table\n        if (expiredEvents.length > 0) {\n          doc.moveDown(1.5);\n          doc.fontSize(14).fillColor('#dc2626').text(`Contracts Expiring (${expiredEvents.length})`, 50);\n          doc.moveDown(0.5);\n          \n          this.drawTable(doc, expiredEvents, '#fee2e2');\n        }\n\n        // Footer\n        doc.moveDown(2);\n        doc.fontSize(10).fillColor('#6c757d').text(\n          'This is an automated monthly report sent on the 1st of each month to help the crew department plan their schedule.',\n          50,\n          doc.page.height - 80,\n          { align: 'center', width: doc.page.width - 100 }\n        );\n\n        doc.end();\n      } catch (error) {\n        console.error('‚ùå Failed to generate PDF:', error);\n        reject(error);\n      }\n    });\n  }\n\n  private drawTable(doc: PDFKit.PDFDocument, events: ContractEvent[], headerColor: string) {\n    const tableLeft = 50;\n    const colWidths = [150, 120, 120, 80];\n    const headers = ['Crew Member', 'Vessel', 'Date', 'Days Left'];\n    \n    let y = doc.y;\n    \n    // Header row\n    doc.rect(tableLeft, y, colWidths.reduce((a, b) => a + b, 0), 25).fill(headerColor);\n    doc.fillColor('#333333').fontSize(10);\n    \n    let x = tableLeft;\n    headers.forEach((header, i) => {\n      doc.text(header, x + 5, y + 8, { width: colWidths[i] - 10 });\n      x += colWidths[i];\n    });\n    \n    y += 25;\n\n    // Data rows\n    events.forEach((event, index) => {\n      if (y > doc.page.height - 100) {\n        doc.addPage();\n        y = 50;\n      }\n\n      const rowColor = index % 2 === 0 ? '#ffffff' : '#f9fafb';\n      doc.rect(tableLeft, y, colWidths.reduce((a, b) => a + b, 0), 22).fill(rowColor);\n      \n      doc.fillColor('#333333').fontSize(9);\n      x = tableLeft;\n      \n      const dateStr = event.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });\n      const rowData = [event.crewMemberName, event.vesselName, dateStr, `${event.daysUntilExpiry} days`];\n      \n      rowData.forEach((cell, i) => {\n        doc.text(cell, x + 5, y + 6, { width: colWidths[i] - 10 });\n        x += colWidths[i];\n      });\n      \n      y += 22;\n    });\n\n    doc.y = y;\n  }\n}\n\nexport const pdfGeneratorService = new PDFGeneratorService();\n","path":null,"size_bytes":6149,"size_tokens":null}},"version":2}